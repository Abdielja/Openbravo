
(function(){var pathname,newpath;var origUrl=window.location.href;pathname=window.location.pathname;newpath=window.location.pathname.replace(new RegExp('[/]+','g'),'/');if(pathname!==newpath){console.warn("Malformed URL fixed: "+origUrl);window.location.href=origUrl.replace(pathname,newpath);}}());var OB={};window.OB=OB;OB.UTIL={};OB.UTIL.Debug={};(function(){var root=this;var debug;if(typeof exports!=='undefined'){OB.UTIL.Debug=exports;}else{OB.UTIL.Debug=root.OB.UTIL.Debug={};}
OB.UTIL.Debug.VERSION="0.3";OB.UTIL.Debug.isDebug=function(){return(typeof isDebug!=='undefined');};OB.UTIL.Debug.getDebugCauses=function(){if(OB.UTIL.Debug.isDebug()){if(typeof debugCauses!=='undefined'){return debugCauses;}}
return null;};if(OB.UTIL.Debug.isDebug()){console.warn("OB.UTIL.Debug is active (v"+OB.UTIL.Debug.VERSION+")");}
OB.UTIL.Debug.execute=function(callback,callerThis){if(OB.UTIL.Debug.isDebug()){if(!callback){console.error("You are calling OB.UTIL.Debug.execute without a callback");return;}
callback.call(callerThis);}};OB.UTIL.Debug.isDefined=function(object,message){if(OB.UTIL.Debug.isDebug()){if(typeof object==='undefined'){if(message){throw message;}else{throw"'"+object.constructor.name+"' is undefined";}}
return true;}};OB.UTIL.Debug.simulateOffline=function(){if(OB.UTIL.Debug.isDebug()){window.localStorage.setItem('SimulateOffline',true);}};OB.UTIL.Debug.isSimulateOffline=function(){if(OB.UTIL.Debug.isDebug()){return false;}
var isFlag=window.localStorage.getItem('SimulateOffline');if(isFlag){if(isFlag==='true'){return true;}}
return false;};}());OB.UTIL=OB.UTIL||{};(function(){var root=this;if(typeof exports!=='undefined'){OB.UTIL.VersionManagement=exports;}else{OB.UTIL.VersionManagement=root.OB.UTIL.VersionManagement={};}
OB.UTIL.VersionManagement.VERSION="0.2";var registeredDeprecations=[];OB.UTIL.VersionManagement.buildVersionString=function(version){if(version.minor!==0){return"RR"+version.year+"Q"+version.major+"."+version.minor;}else{return"RR"+version.year+"Q"+version.major;}};OB.UTIL.VersionManagement.current=[];OB.UTIL.VersionManagement.registerDeprecation=function(deprecationId,introducedInVersion,inDevelopmentMessage){OB.UTIL.Debug.isDefined(deprecationId,"Missing required argument 'deprecationId' in OB.UTIL.VersionManagement.registerDeprecation");OB.UTIL.Debug.isDefined(introducedInVersion,"Missing required argument 'introducedInVersion' in OB.UTIL.VersionManagement.registerDeprecation");OB.UTIL.Debug.isDefined(inDevelopmentMessage,"Missing required argument 'inDevelopmentMessage' in OB.UTIL.VersionManagement.registerDeprecation");OB.UTIL.Debug.execute(function(){var isAlreadyRegistered=registeredDeprecations.some(function(element){if(element.deprecationId===deprecationId){return true;}});if(isAlreadyRegistered){console.error("The deprecation id: "+deprecationId+" ('"+inDevelopmentMessage+"'') have already been registered");}});registeredDeprecations.push({deprecationId:deprecationId,introducedInVersion:introducedInVersion,inDevelopmentMessage:inDevelopmentMessage});};OB.UTIL.VersionManagement.deprecated=function(deprecationId,backwardCompatibleCallback,inDevelopmentCallback,callerThis){OB.UTIL.Debug.isDefined(deprecationId,"Missing required argument 'deprecationId' in OB.UTIL.VersionManagement.deprecated");OB.UTIL.Debug.isDefined(backwardCompatibleCallback,"Missing required argument 'backwardCompatibleCallback' in OB.UTIL.VersionManagement.deprecated");var registeredDeprecation;registeredDeprecations.some(function(element){if(element.deprecationId===deprecationId){registeredDeprecation=element;return;}});OB.UTIL.Debug.isDefined(registeredDeprecation,"The deprecation with id: "+deprecationId+" has not been registered with OB.UTIL.registerDeprecation");backwardCompatibleCallback.call(callerThis);OB.UTIL.Debug.execute(function(){if(!inDevelopmentCallback){inDevelopmentCallback=function(deprecationMessage){console.warn(deprecationMessage);};}
var deprecationMessage="Deprecated (since "+OB.UTIL.VersionManagement.buildVersionString(registeredDeprecation.introducedInVersion)+"): "+registeredDeprecation.inDevelopmentMessage;inDevelopmentCallback.call(callerThis,deprecationMessage);});};OB.UTIL.VersionManagement.getDeprecations=function(){registeredDeprecations.forEach(function(element){console.log(element.deprecationId+" (since "+OB.UTIL.VersionManagement.buildVersionString(element.introducedInVersion)+"): "+element.inDevelopmentMessage);});};OB.UTIL.VersionManagement.isDeprecationRegistered=function(deprecationId){OB.UTIL.Debug.execute(function(){if(typeof(deprecationId)!=='number'){console.error("The deprecationId ('"+deprecationId+"') must be an integer");}});var isDeprecationRegistered=false;registeredDeprecations.some(function(element){if(element.deprecationId===deprecationId){isDeprecationRegistered=true;return;}});return isDeprecationRegistered;};}());(function(){window.onerror=function(message,url,line,column,errorObj){if(!errorObj){if(typeof(message)!=='string'){return;}}
var errorMessage;if(errorObj){errorMessage=errorObj.stack;console.log(line,column);}else{errorMessage=message+"; line: "+url+":"+line;}
if(OB.error){if(OB.UTIL&&OB.UTIL.showError){OB.UTIL.showError(errorMessage);}else{OB.error(errorMessage);}}else{console.error(errorMessage);}};OB.UTIL.VersionManagement.current.mobileCore={year:16,major:2,minor:0};OB.UTIL.VersionManagement.current.mobileCore.WebSQLDatabase={name:'OBMOBCDB',size:4*1024*1024,displayName:'Mobile DB',dbVersion:OB.UTIL.VersionManagement.current.mobileCore.year+"."+OB.UTIL.VersionManagement.current.mobileCore.major+OB.UTIL.VersionManagement.current.mobileCore.minor};OB.UTIL.SupportedBrowsers=[{name:'chrome',label:'Chrome',allowed:30,required:48,preferred:49},{name:'androidChrome',label:'Chrome for Android',allowed:30,required:48,preferred:49},{name:'safari',label:'Safari',allowed:7,required:8,preferred:9},{name:'ios',label:'Apple iOS',allowed:7,required:8,preferred:9}];OB.UTIL.VersionManagement.registerDeprecation(27332,{year:14,major:4,minor:0},"'OB.UTILS' namespace has been removed");OB.UTIL.VersionManagement.registerDeprecation(27349,{year:14,major:4,minor:0},"'OB.MobileApp.model.hookManager' is a child of the model of the terminal. Please use 'OB.UTIL.HookManager' instead. More info: http://wiki.openbravo.com/wiki/How_to_Add_Hooks");OB.UTIL.VersionManagement.registerDeprecation(30610,{year:15,major:4,minor:0},"The 'init' method to call windows, has been deprecated. Use the new methods provided in 'OB.UI.WindowView' and 'OB.Model.WindowModel'");OB.UTIL.VersionManagement.registerDeprecation(30768,{year:15,major:4,minor:0},"The 'OB.Dal.get_uuid' method has been deprecated. Use the OB.UTILS.get_UUIID method");OB.UTIL.VersionManagement.registerDeprecation(31753,{year:16,major:1,minor:0},"The old discounts flow has been deprecated. Please activate the new discounts flow");OB.UTILS=OB.UTILS||{};}());OB.UTIL=OB.UTIL||{};(function(){var root=this;if(typeof exports!=="undefined"){OB.UTIL.SynchronizationHelper=exports;}else{OB.UTIL.SynchronizationHelper=root.OB.UTIL.SynchronizationHelper={};}
OB.UTIL.SynchronizationHelper.VERSION="0.8";var verbose=false;var delaySynchronizedEvent=150;var timeoutThreshold=60000;var isTimeoutThresholdActivated=false;OB.UTIL.Debug.execute(function(){timeoutThreshold=30000;isTimeoutThresholdActivated=true;});var eventId=null;var timeoutEventId=null;var clearCount=0;var busyCount=-1;var watchedModelName=[];var isSynchronizingSent=false;var isTimeout=false;var busyProcessIdCounter=0;var busyProcessArray=[];var STATUS={SYNCHRONIZED:0,SYNCHRONIZING:1,NOTSYNCHRONIZED:2,UNKNOWN:-1};var currentStatus=STATUS.UNKNOWN;var lastAccess=new Date().getTime();var modelsSynchronized=STATUS.UNKNOWN;if(verbose){console.log("SynchronizationHelper %s is available and verbosing",OB.UTIL.SynchronizationHelper.VERSION);}
OB.UTIL.SynchronizationHelper.getBusyQueueStringified=function(){var stringifiedBusyQueue=JSON.stringify(busyProcessArray);return stringifiedBusyQueue;};OB.UTIL.SynchronizationHelper.eachModelSynchronized=function(model){OB.MobileApp.model.trigger('eachModelsSynchronized',model);};OB.UTIL.SynchronizationHelper.modelsSynchronized=function(){modelsSynchronized=STATUS.SYNCHRONIZED;OB.MobileApp.model.trigger('modelsSynchronized');OB.UTIL.showI18NSuccess('OBMOBC_SynchronizationWasSuccessfulMessage','OBMOBC_SynchronizingDataMessage');};OB.UTIL.SynchronizationHelper.modelsSynchronizing=function(){modelsSynchronized=STATUS.SYNCHRONIZING;OB.MobileApp.model.trigger('modelsSynchronizing');OB.UTIL.showI18NWarning('OBMOBC_SynchronizingDataMessage','OBMOBC_SynchronizationWasSuccessfulMessage');};OB.UTIL.SynchronizationHelper.modelsNotSynchronized=function(){modelsSynchronized=STATUS.NOTSYNCHRONIZED;OB.MobileApp.model.trigger('modelsNotSynchronized');};OB.UTIL.SynchronizationHelper.isModelsSynchronized=function(){return modelsSynchronized===STATUS.SYNCHRONIZED;};OB.UTIL.SynchronizationHelper.isModelsSynchronizing=function(){return modelsSynchronized===STATUS.SYNCHRONIZING;};OB.UTIL.SynchronizationHelper.isModelsNotSynchronized=function(){return modelsSynchronized===STATUS.NOTSYNCHRONIZED;};OB.UTIL.SynchronizationHelper.isSynchronized=function(){return currentStatus===STATUS.SYNCHRONIZED;};var callbacksWaitingToBeExecuted=[];OB.UTIL.SynchronizationHelper.executeWhenSynchronized=function(args,callback){OB.UTIL.Debug.execute(function(){if(!args||typeof(args)!=='object'){throw"invalid argument 'args' (value = '"+args+"')";}
if(!callback||typeof(callback)!=='function'){throw"invalid argument 'callback' (typeof = '"+typeof(callback)+"')";}});var callbackToExecute=null;if(args.makeSynchronous){callbackToExecute=function(){var synchIdOnReady=OB.UTIL.SynchronizationHelper.busyUntilFinishes('executeWhenSynchronized');callback({},function(){OB.UTIL.SynchronizationHelper.finished(synchIdOnReady,'executeWhenSynchronized');});};}else{callbackToExecute=callback;}
if(OB.UTIL.SynchronizationHelper.isSynchronized()){callbackToExecute();return;}
callbacksWaitingToBeExecuted.push(callbackToExecute);};var elapsedTime=function(){return(new Date().getTime()-lastAccess);};var sendSynchronizing;sendSynchronizing=function(){setTimeout(function(){if(isTimeout){isSynchronizingSent=false;return;}
if(document.readyState==="complete"){busyCount+=1;if(OB.MobileApp.view){OB.MobileApp.view.waterfall('synchronizing');}
if(OB.MobileApp.model){OB.MobileApp.model.trigger('synchronizing');}
if(verbose){console.error("[dev] SH: ("+busyCount+") synchronizing sent");}}else{if(verbose){console.error("[dev] SH: ("+(busyCount+1)+") synchronizing delayed");}
sendSynchronizing();}},10);};var sendSynchronized=function(){isSynchronizingSent=false;clearCount=0;currentStatus=STATUS.SYNCHRONIZED;while(callbacksWaitingToBeExecuted.length>0){var waitingCallback=callbacksWaitingToBeExecuted[0];waitingCallback();callbacksWaitingToBeExecuted.shift();if(OB.UTIL.SynchronizationHelper.isSynchronized()===false){return;}}
setTimeout(function(){if(OB.UTIL.SynchronizationHelper.isSynchronized()){if(OB.MobileApp.model){OB.MobileApp.model.trigger('synchronized');}
if(OB.MobileApp.view){OB.MobileApp.view.waterfall('synchronized');}
if(verbose){console.error("[dev] SH: ("+busyCount+") synchronized sent");}}},1);};var timeout=function(){isTimeout=true;var s="";busyProcessArray.forEach(function(element){s+="("+element.busyProcessId+") "+element.msg+"\n";});if(!isTimeoutThresholdActivated){console.warn("SynchronizationHelper timeout reached but the watchers poll is not cleared because the timout actions are deactivated. This is happening because an asynchronous call is lasting more than "+timeoutThreshold+" milliseconds (set a longer timeout) or because there is an unbalanced process registered in the SynchronizationHelper watchers poll (fix the process). To activate the timeout actions (i.e. clear the poll and fire the 'synchronized' event), set 'isTimeoutThresholdActivated' to 'true'. This process(s) didn't finish: "+s);return;}
console.error("SynchronizationHelper timeout reached: This process(s) didn't finish: "+s);busyProcessArray=[];sendSynchronized();};var busy=function(){if(OB.UTIL.SynchronizationHelper.isSynchronized()){OB.UTIL.Debug.execute(function(){console.debug("SynchronizationHelper: Elapsed time since the last synchronized state ("+elapsedTime()+")");});}
lastAccess=new Date().getTime();currentStatus=STATUS.SYNCHRONIZING;if(isSynchronizingSent===false){isTimeout=false;isSynchronizingSent=true;sendSynchronizing();}
if(eventId!==null){clearTimeout(eventId);eventId=null;clearCount+=1;}
if(timeoutEventId!==null){clearTimeout(timeoutEventId);timeoutEventId=null;}
timeoutEventId=setTimeout(function(){timeout();},timeoutThreshold);if(busyProcessArray.length>0){return;}
clearTimeout(timeoutEventId);timeoutEventId=null;isTimeout=false;eventId=setTimeout(function(){if(isSynchronizingSent===false){console.error("SynchronizationHelper: A 'synchronized' event should always be preceeded by a 'synchronizing' event");}
sendSynchronized();},delaySynchronizedEvent);};OB.UTIL.SynchronizationHelper.watchModel=function(model,msg,forceWatch){var modelName=model.modelName||"NA";if(modelName==="LogClient"){return;}
if(!forceWatch){busy(modelName+", "+msg);return;}
if(watchedModelName.indexOf(modelName)<0){watchedModelName.push(modelName);model.on('all',function(eventName){busy(modelName+", fired: "+eventName+", "+msg);});}};OB.UTIL.SynchronizationHelper.busy=function(msg){if(verbose){console.error("[dev] SH.busy (+%sms): '%s'",new Date().getTime()-lastAccess,msg);}
busy(msg);};OB.UTIL.SynchronizationHelper.busyUntilFinishes=function(msg){OB.UTIL.Debug.execute(function(){if(!msg){console.error("A message must be specified. The message should be meaningful and unique so it would be easier to find the cause of an unbalanced call; preferably, the same passed to the paired finished method.");}});var busyProcessId=busyProcessIdCounter;if(verbose){console.error("[dev] SH.busyUntilFinishes ("+busyProcessId+") "+msg);}
busyProcessIdCounter+=1;busyProcessArray.push({busyProcessId:busyProcessId,msg:msg});busy(msg);return busyProcessId;};OB.UTIL.SynchronizationHelper.finished=function(busyProcessId,msg){OB.UTIL.Debug.execute(function(){if(!msg){console.error("A message must be specified. The message should be meaningful and unique so it would be easier to find the cause of an unbalanced call; preferably, the same passed to the busyUntilFinishes method.");}});if(verbose){console.error("[dev] SH.finished ("+busyProcessId+") "+msg);}
var index=-1;var i;for(i=0;i<busyProcessArray.length;i++){var element=busyProcessArray[i];if(element.busyProcessId===busyProcessId){index=i;break;}}
if(index<0){console.error("OB.UTIL.SynchronizationHelper: Unbalanced finished. The process '("+busyProcessId+") "+msg+"' cannot be found");return;}
busyProcessArray.splice(index,1);busy(msg);};OB.UTIL.SynchronizationHelper.log=function(msg){OB.UTIL.Debug.execute(function(){console.error("[dev] SH.log (+%sms): '%s'",elapsedTime(),msg);});};if(verbose){new(Backbone.Model.extend({initialize:function(){console.log('SH: backbone loaded');}}))();enyo.load('',function(){console.log('SH: enyo loaded');});}}());(function(){OB.Cache=window.OB.Cache||{};function buildIdentifier(obj){var identifier='',p='';delete obj.sql;for(p in obj){if(obj.hasOwnProperty(p)&&obj[p]){identifier+=obj[p]+';';}}
return identifier;}
function saveObj(cacheName,paramObj,value){OB.Cache.dataStructure[cacheName][buildIdentifier(paramObj)]=value;}
OB.Cache.dataStructure={};OB.Cache.initCache=function(cacheName){if(!OB.Cache.dataStructure[cacheName]){OB.Cache.dataStructure[cacheName]={};}};OB.Cache.putItem=function(cacheName,paramObj,value){OB.Cache.initCache(cacheName);saveObj(cacheName,paramObj,value);};OB.Cache.getItem=function(cacheName,paramObj){OB.Cache.initCache(cacheName);return OB.Cache.dataStructure[cacheName][buildIdentifier(paramObj)];};OB.Cache.hasItem=function(cacheName,paramObj){OB.Cache.initCache(cacheName);return!OB.UTIL.isNullOrUndefined(OB.Cache.getItem(cacheName,paramObj));};}());(function(){OB.DS=window.OB.DS||{};OB.DS.MAXSIZE=100;function serviceSuccess(inSender,inResponse,callback){if(inResponse._entityname){callback([inResponse]);}else{var response=inResponse.response;if(!response){response={};response.error={};response.error.message="Unknown error";response.status=501;}
if(response.contextInfo&&OB.MobileApp.model.get('context')){OB.UTIL.checkContextChange(OB.MobileApp.model.get('context'),response.contextInfo,function(){if(response&&response.sourceVersion&&inSender.url.indexOf(document.location.host)!==-1){OB.UTIL.checkSourceVersion(response.sourceVersion,false);}});}
var status=response.status;if(status===0){callback(response.data,response.message,response.lastUpdated);return;}
OB.error("serviceSuccess error: status: "+response.status+((response.error&&response.error.message)?(", error.message: "+response.error.message):""));var exception={message:'Unknown error',status:response};if(response.errors){if(OB.MobileApp.model.get('isLoggingIn')){OB.MobileApp.model.set("datasourceLoadFailed",true);}
exception.message=response.errors.id;}
if(response.error&&response.error.message){if(OB.MobileApp.model.get('isLoggingIn')&&!response.error.invalidPermission){OB.MobileApp.model.set("datasourceLoadFailed",true);}
exception.invalidPermission=response.error.invalidPermission;exception.message=response.error.message;}
OB.UTIL.Debug.execute(function(){if(!exception){console.error("The exception message is missing");}});callback({exception:exception});}}
function serviceError(inResponse,callback,callbackError){if(OB.MobileApp.model.get('isLoggingIn')){OB.MobileApp.model.set("datasourceLoadFailed",true);}
if(callbackError){callbackError({exception:{message:OB.I18N.getLabel('OBMOBC_MsgApplicationServerNotAvailable'),status:inResponse}});}else{callback({exception:{message:OB.I18N.getLabel('OBMOBC_MsgApplicationServerNotAvailable'),status:inResponse}});}}
OB.DS.servicePOSTRequests=[];function servicePOST(source,dataparams,callback,callbackError,async,timeout){OB.DS.servicePOSTRequests.push(source);var rr;if(async!==false){async=true;}
var ajaxRequest=new enyo.Ajax({url:'../../org.openbravo.mobile.core.service.jsonrest/'+source,cacheBust:false,sync:!async,timeout:timeout,method:'POST',handleAs:'json',contentType:'application/json;charset=utf-8',ignoreForConnectionStatus:dataparams.parameters&&dataparams.parameters.ignoreForConnectionStatus?dataparams.parameters.ignoreForConnectionStatus:false,data:JSON.stringify(dataparams),success:function(inSender,inResponse){OB.DS.servicePOSTRequests.pop(source);if(this.processHasFailed){return;}
serviceSuccess(inSender,inResponse,callback);},fail:function(inSender,inResponse){OB.DS.servicePOSTRequests.pop(source);OB.UTIL.Debug.execute(function(){console.error("servicePOST error: "+inSender+", source: "+source);});this.processHasFailed=true;inResponse=inResponse||{};if(inSender&&inSender==="timeout"){inResponse.timeout=true;}
serviceError(inResponse,callback,callbackError);}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(source);}
OB.DS.serviceGETRequests=[];function serviceGET(source,dataparams,callback,callbackError,async,timeout){OB.DS.serviceGETRequests.push(source);var rr;var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('serviceGET '+source);if(async!==false){async=true;}
var ajaxRequest=new enyo.Ajax({url:'../../org.openbravo.mobile.core.service.jsonrest/'+source+'/'+encodeURI(JSON.stringify(dataparams)),cacheBust:false,sync:!async,method:'GET',handleAs:'json',timeout:timeout,ignoreForConnectionStatus:dataparams.parameters&&dataparams.parameters.ignoreForConnectionStatus?dataparams.parameters.ignoreForConnectionStatus:false,contentType:'application/json;charset=utf-8',success:function(inSender,inResponse){OB.DS.serviceGETRequests.pop(source);OB.UTIL.SynchronizationHelper.finished(synchId,'serviceGET');serviceSuccess(inSender,inResponse,callback);},fail:function(inSender,inResponse){OB.DS.serviceGETRequests.pop(source);OB.UTIL.SynchronizationHelper.finished(synchId,'serviceGET');OB.UTIL.Debug.execute(function(){if(inSender&&inSender===401){console.warn("serviceGET error: "+inSender+", source: "+source);}else{console.error("serviceGET error: "+inSender+", source: "+source);}});serviceError(inResponse,callback,callbackError);}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(source);}
OB.DS.Process=function(source){this.source=source;};OB.DS.Process.prototype.exec=function(params,callback,callbackError,async,timeout){var data={},i,attr;for(attr in params){if(params.hasOwnProperty(attr)){data[attr]=params[attr];}}
if(OB.DS.commonParams){for(i in OB.DS.commonParams){if(OB.DS.commonParams.hasOwnProperty(i)){data[i]=OB.DS.commonParams[i];}}}
data.appName=OB.MobileApp.model.get('appName')||'OBMOBC';servicePOST(this.source,data,callback,callbackError,async,timeout);};OB.DS.Request=function(source,lastUpdated){this.model=source&&source.prototype&&source.prototype.modelName&&source;this.source=(this.model&&this.model.prototype.source)||source;OB.UTIL.Debug.execute(function(){if(!this.source){console.error("A Request must have a source");}},this);this.lastUpdated=lastUpdated;};OB.DS.Request.prototype.exec=function(params,callback,callbackError,async,timeout){var p,i;var data={};if(params){if(params._limit){data._limit=params._limit;delete params._limit;}
if(params._offset||params._offset===0){data._offset=params._offset;delete params._offset;}
p={};for(i in params){if(params.hasOwnProperty(i)){if(typeof params[i]==='string'){p[i]={value:params[i],type:'string'};}else if(typeof params[i]==='number'){if(params[i]===Math.round(params[i])){p[i]={value:params[i],type:'long'};}else{p[i]={value:params[i],type:'bigdecimal'};}}else if(typeof params[i]==='boolean'){p[i]={value:params[i],type:'boolean'};}else{p[i]=params[i];}}}
data.parameters=p;}
if(OB.DS.commonParams){for(i in OB.DS.commonParams){if(OB.DS.commonParams.hasOwnProperty(i)){data[i]=OB.DS.commonParams[i];}}}
if(this.lastUpdated){data.lastUpdated=this.lastUpdated;}
data.appName=OB.MobileApp.model.get('appName')||'OBMOBC';serviceGET(this.source,data,callback,callbackError,async,timeout);};function check(elem,filter){var p;for(p in filter){if(filter.hasOwnProperty(p)){if(typeof(filter[p])==='object'){return check(elem[p],filter[p]);}else{if(filter[p].substring(0,2)==='%i'){if(!new RegExp(filter[p].substring(2),'i').test(elem[p])){return false;}}else if(filter[p].substring(0,2)==='%'){if(!new RegExp(filter[p].substring(2)).test(elem[p])){return false;}}else if(filter[p]!==elem[p]){return false;}}}}
return true;}
function findInData(data,filter){var i,max;if($.isEmptyObject(filter)){return{exception:'filter not defined'};}else{for(i=0,max=data.length;i<max;i++){if(check(data[i],filter)){return data[i];}}
return null;}}
function execInData(data,filter,filterfunction){var newdata,info,i,max,f,item;if($.isEmptyObject(filter)&&!filterfunction){return{data:data.slice(0,OB.DS.MAXSIZE),info:(data.length>OB.DS.MAXSIZE?'OBMOBC_DataMaxReached':null)};}else{f=filterfunction||function(item){return item;};newdata=[];info=null;for(i=0,max=data.length;i<max;i++){if(check(data[i],filter)){item=f(data[i]);if(item){if(newdata.length>=OB.DS.MAXSIZE){info='OBMOBC_DataMaxReached';break;}
newdata.push(data[i]);}}}
return{data:newdata,info:info};}}
OB.DS.DataSource=function(request){this.request=request;this.cache=null;};_.extend(OB.DS.DataSource.prototype,Backbone.Events);OB.DS.DataSource.prototype.load=function(params,incremental){var me=this,handleError,handleIncrementalRequest,dataLoaded=0;handleError=function(){if(arguments[1]&&arguments[1].message&&me.request.model.prototype.modelName){OB.error("Table '"+me.request.model.prototype.modelName+"' load error: "+(arguments[1]?("("+arguments[1].code+") "+arguments[1].message):arguments));}else{OB.error("OB.DS.DataSource.prototype.load:",arguments,me.request.model.prototype);}};handleIncrementalRequest=function(limit,offset,params,incremental){params=params||{};params._limit=limit;params._offset=offset;if(offset===0){window.localStorage.setItem('requestTimestamp'+me.request.model.prototype.modelName,(new Date()).getTime());OB.UTIL.showLoadingMessage(OB.I18N.getLabel('OBMOBC_LoadingMessageModel',[me.request.model.prototype.modelName]));}else{OB.UTIL.showLoadingMessage(OB.I18N.getLabel('OBMOBC_LoadingMessageModelPage',[me.request.model.prototype.modelName,offset/limit+1]));}
me.request.exec(params,function(data,message,lastUpdated){function success(){dataLoaded+=data.length;if(data.length>=limit){window.localStorage.removeItem('lastUpdatedTimestamp'+me.request.model.prototype.modelName);handleIncrementalRequest(limit,offset+limit,params,incremental);}else{OB.UTIL.completeLoadingStep();if(lastUpdated&&data.length>0){if(window.localStorage.getItem('requestTimestamp'+me.request.model.prototype.modelName)&&window.localStorage.getItem('requestTimestamp'+me.request.model.prototype.modelName)!=='null'){window.localStorage.setItem('lastUpdatedTimestamp'+me.request.model.prototype.modelName,window.localStorage.getItem('requestTimestamp'+me.request.model.prototype.modelName));}else{OB.error('[lastUpdatedTimestamp] '+'local storage (lastUpdatedTimestamp'+me.request.model.prototype.modelName+') attempted to be set as null. Ignored. Current Value: '+window.localStorage.getItem('lastUpdatedTimestamp'+me.request.model.prototype.modelName));}
window.localStorage.removeItem('requestTimestamp'+me.request.model.prototype.modelName);}
me.trigger('ready');}}
if(data.exception){OB.error('Error in datasource: '+data.exception);me.trigger('ready','failed');return;}
if(me.request.model&&me.request.model.prototype.online){me.cache=(me.cache?me.cache.concat(data):data);}
if(me.request.model&&!me.request.model.prototype.online){if(offset===0){OB.Dal.initCache(me.request.model,data,success,handleError,incremental);}else{OB.Dal.insertData(me.request.model,data,success,handleError,incremental,dataLoaded);}}else{success();}},function(data){OB.UTIL.Debug.execute(function(){if(data&&data.exception&&data.exception.message){console.error("OB.DS.DataSource.prototype.load : "+data.exception.message);return;}});me.trigger('ready','failed');});};this.cache=null;handleIncrementalRequest(35000,0,params,incremental);};OB.DS.DataSource.prototype.find=function(filter,callback){if(this.cache){callback(findInData(this.cache,filter));}else{this.on('ready',function(){callback(findInData(this.cache,filter));},this);}};OB.DS.DataSource.prototype.exec=function(filter,callback){if(this.cache){var result1=execInData(this.cache,filter);callback(result1.data,result1.info);}else{this.on('ready',function(){var result2=execInData(this.cache,filter);callback(result2.data,result2.info);},this);}};}());(function(){OB.RR=window.OB.RR||{};OB.RR.HandleResponseCallbacks=[];OB.RR.HandleResponseCallbacks.push({name:'ON',handleAction:function(callback,ajaxRequest){callback();}},{name:'OFF',handleAction:function(callback,ajaxRequest){callback();}},{name:'TON',handleAction:function(callback,ajaxRequest){OB.UTIL.showLoading(true);}},{name:'TOFF',handleAction:function(callback,ajaxRequest){OB.UTIL.showLoading(true);}});OB.RR.handleResponse=function(keyName,callback,ajaxRequest){var cbk=_.filter(OB.RR.HandleResponseCallbacks,function(callbackFunc){return callbackFunc.name===keyName;});if(cbk&&cbk.length>0){cbk[0].handleAction(callback,ajaxRequest);}else{callback();}};OB.RR.ServTypeFailover={name:'Failover',callServer:function(online,index,service,ajaxRequest){var servers=OB.RR.RequestRouter.servers,server=servers.at(index),me=this;if(index===servers.length){if(!online||(servers.length===1&&ajaxRequest.origFail)){if(ajaxRequest.origFail){ajaxRequest.origFail();}}else{this.callServer(false,0,service,ajaxRequest);}
return true;}
if(online===Boolean(server.get('online'))&&(server.get('allServices')||_.filter(server.get('services'),function(srvc){return srvc===service.get('name');}).length>0)){if(!ajaxRequest.origUrl){ajaxRequest.origUrl=ajaxRequest.url;}
if(server.get('address')){ajaxRequest.url=ajaxRequest.origUrl.replace('../../',server.get('address'));}
if(!ajaxRequest.origFail){ajaxRequest.origFail=ajaxRequest.fail;}
ajaxRequest.fail=function(inSender,inResponse){if(inSender===401){server.set('online',true);me.handle401(server);}else{server.changeOnlineStatus(false,ajaxRequest.ignoreForConnectionStatus);me.callServer(online,index+1,service,ajaxRequest);}};if(!ajaxRequest.origSuccess){ajaxRequest.origSuccess=ajaxRequest.success;}
ajaxRequest.success=function(inSender,inResponse){var callback=function(){if(inResponse.authenticationClient&&inResponse.authenticationToken){localStorage.authenticationClient=encodeURIComponent(inResponse.authenticationClient);localStorage.authenticationToken=encodeURIComponent(inResponse.authenticationToken);}
if(!ajaxRequest.done){ajaxRequest.done=true;ajaxRequest.origSuccess(inSender,inResponse);}
server.changeOnlineStatus(true,ajaxRequest.ignoreForConnectionStatus);};if(inResponse&&inResponse.response&&inResponse.response.serverStatusSignal){OB.RR.handleResponse(inResponse.response.serverStatusSignal,callback,ajaxRequest);}else{callback();}};if(localStorage.authenticationClient&&localStorage.authenticationToken){if(ajaxRequest.url.indexOf('?')===-1){ajaxRequest.url=ajaxRequest.url+'?';}else{ajaxRequest.url=ajaxRequest.url+'&';}
ajaxRequest.url=ajaxRequest.url+'authenticationClient='+localStorage.authenticationClient+'&authenticationToken='+localStorage.authenticationToken;}
ajaxRequest.xhrFields={'withCredentials':true};new enyo.Ajax(ajaxRequest).go(ajaxRequest.data).response('success').error('fail');}else{me.callServer(online,index+1,service,ajaxRequest);}},handle401:function(server){if(_.find(OB.RR.RequestRouter.servers.models,function(server){return server.get('online')&&(server.get('allServices')||_.find(server.get('services'),function(service){return service==="org.openbravo.retail.posterminal.POSLoginHandler";}));})){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Online'),OB.I18N.getLabel('OBMOBC_OnlineConnectionHasReturned'),[{label:OB.I18N.getLabel('OBMOBC_LblLoginAgain'),action:function(){OB.MobileApp.model.lock();OB.UTIL.showLoading(true);}}],{autoDismiss:false,onHideFunction:function(){OB.MobileApp.model.lock();OB.UTIL.showLoading(true);}});}},implementation:function(service,ajaxRequest){this.callServer(true,0,service,ajaxRequest);}};OB.RR.ServTypeBroadcast={name:'Broadcast',callServer:function(server,ajaxRequest){if(!ajaxRequest.origUrl){ajaxRequest.origUrl=ajaxRequest.url;}
if(server.get('address')){ajaxRequest.url=ajaxRequest.origUrl.replace('../../',server.get('address'));}
if(localStorage.authenticationClient&&localStorage.authenticationToken){if(ajaxRequest.url.indexOf('?')===-1){ajaxRequest.url=ajaxRequest.url+'?';}else{ajaxRequest.url=ajaxRequest.url+'&';}
ajaxRequest.url=ajaxRequest.url+'authenticationClient='+localStorage.authenticationClient+'&authenticationToken='+localStorage.authenticationToken;}
ajaxRequest.xhrFields={'withCredentials':true};new enyo.Ajax(ajaxRequest).go(ajaxRequest.data).response('success').error('fail');ajaxRequest.fail=function(inSender,inResponse){};ajaxRequest.success=function(inSender,inResponse){};},implementation:function(service,ajaxRequest){var me=this;var servers=_.filter(OB.RR.RequestRouter.servers.models,function(server){return server.get('allServices')||_.filter(server.get('services'),function(srvc){return srvc===service.get('name');}).length>0;});_.each(servers,function(server){me.callServer(server,ajaxRequest);});}};OB.RR.ServTypeTransaction={name:'Transaction',createRequest:function(server,message,pendingMessages){var me=this;return{url:message.get('url'),cacheBust:false,sync:false,timeout:610000,method:'POST',handleAs:'json',contentType:'application/json;charset=utf-8',ignoreForConnectionStatus:false,data:message.get('messageObj'),success:function(inSender,inResponse){var callback=function(){if(inResponse.authenticationClient&&inResponse.authenticationToken){localStorage.authenticationClient=encodeURIComponent(JSON.stringify(inResponse.authenticationClient));localStorage.authenticationToken=encodeURIComponent(JSON.stringify(inResponse.authenticationToken));}
server.changeOnlineStatus(true,this.ignoreForConnectionStatus);OB.Dal.remove(message,function(){if(Boolean(server.get('mainServer'))){OB.UTIL.SynchronizationHelper.eachModelSynchronized();}
if(inResponse.response&&inResponse.response.contextInfo&&OB.MobileApp.model.get('context')){OB.UTIL.checkContextChange(OB.MobileApp.model.get('context'),inResponse.response.contextInfo,function(){});}
me.processMessages(server,pendingMessages);},function(error){OB.error(arguments);});};if(inResponse&&inResponse.response&&inResponse.response.serverStatusSignal){OB.RR.handleResponse(inResponse.response.serverStatusSignal,callback,this);}else{callback();}},fail:function(inSender,inResponse){message.set('status','failure');OB.Dal.save(message,function(){me.updateSyncIcon();if(inSender===401){server.set('online',true);me.handle401(server);}else{server.changeOnlineStatus(false,this.ignoreForConnectionStatus);}
server.sendingMessages=false;},function(){OB.error(arguments);});}};},handle401:function(server){if(_.find(OB.RR.RequestRouter.servers.models,function(server){return server.get('online')&&(server.get('allServices')||_.find(server.get('services'),function(service){return service==="org.openbravo.retail.posterminal.POSLoginHandler";}));})){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Online'),OB.I18N.getLabel('OBMOBC_OnlineConnectionHasReturned'),[{label:OB.I18N.getLabel('OBMOBC_LblLoginAgain'),action:function(){OB.MobileApp.model.lock();OB.UTIL.showLoading(true);}}],{autoDismiss:false,onHideFunction:function(){OB.MobileApp.model.lock();OB.UTIL.showLoading(true);}});}},updateSyncIcon:function(){OB.Dal.find(OB.Model.Message,{'mainServer':'true'},function(msgs){if(_.reduce(msgs.models,function(val,msg){return val||(Boolean(msg.get('mainServer'))&&msg.get('status')==='failure');},false)){OB.UTIL.SynchronizationHelper.modelsNotSynchronized();}else if(msgs.length>0&&!OB.UTIL.SynchronizationHelper.isModelsSynchronizing()){OB.UTIL.SynchronizationHelper.modelsSynchronizing();}else if(msgs.length===0&&!OB.UTIL.SynchronizationHelper.isModelsSynchronized()){OB.UTIL.SynchronizationHelper.modelsSynchronized();}},function(){OB.error(arguments);});},processMessages:function(server,pendingMessages){var me=this,message,ajaxRequest,request;if(pendingMessages.length===0){server.sendingMessages=false;this.sendMessages(server);return;}
message=pendingMessages.shift();request=this.createRequest(server,message,pendingMessages);ajaxRequest=new enyo.Ajax(request);if(server.get('address')){ajaxRequest.url=ajaxRequest.url.replace('../../',server.get('address'));}
if(localStorage.authenticationClient&&localStorage.authenticationToken){if(ajaxRequest.url.indexOf('?')===-1){ajaxRequest.url=ajaxRequest.url+'?';}else{ajaxRequest.url=ajaxRequest.url+'&';}
ajaxRequest.url=ajaxRequest.url+'authenticationClient='+localStorage.authenticationClient+'&authenticationToken='+localStorage.authenticationToken;}
ajaxRequest.xhrFields={'withCredentials':true};ajaxRequest.go(ajaxRequest.data).response('success').error('fail');},sendMessages:function(server){var me=this;if(!OB.Model.Message||!OB.Model.Message.areTablesCreated){return;}
me.updateSyncIcon();if(server.sendingMessages){return;}
server.sendingMessages=true;OB.Dal.find(OB.Model.Message,{'server':server.get('name'),'_orderByClause':'time asc'},function(messages){if(messages.length===0){server.sendingMessages=false;}else{me.processMessages(server,messages);}},function(){OB.error(arguments);});},implementation:function(service,ajaxRequest){var successExecuted=false;var servers=_.filter(OB.RR.RequestRouter.servers.models,function(server){return server.get('allServices')||_.filter(server.get('services'),function(srvc){return srvc===service.get('name');}).length>0;}),me=this;_.each(servers,function(server){var successCallback=function(){if(!successExecuted&&Boolean(server.get('mainServer'))){new enyo.Ajax(ajaxRequest).success(null,{response:{contextInfo:null,result:'0',status:0}});successExecuted=true;}
me.sendMessages(server);};if(!ajaxRequest.data||!JSON.parse(ajaxRequest.data).data){var errorMessage=OB.I18N.getLabel('OBMOBC_WrongMobileService',[ajaxRequest.url]);OB.error(errorMessage);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_LblWarning'),OB.I18N.getLabel('OBMOBC_WrongMobileService',[ajaxRequest.url]),[{isConfirmButton:true,label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){OB.MobileApp.model.lock();return true;}}],{onHideFunction:function(){OB.MobileApp.model.lock();return true;}});return;}
var parsedData=JSON.parse(ajaxRequest.data);if(parsedData.data.length>0){var message=new OB.Model.Message();message.set('server',server.get('name'));message.set('mainServer',server.get('mainServer'));message.set('url',ajaxRequest.url);message.set('time',new Date().getTime());message.set('messageObj',ajaxRequest.data);if(!Boolean(server.get('online'))){message.set('status','failure');}
OB.Dal.save(message,successCallback,function(){OB.error(arguments);});}else{successCallback();}});}};OB.RR.ServTypePing={name:'Ping',implementation:function(service,ajaxRequest){var servers=OB.RR.RequestRouter.servers,me=this,offlineServers=_.filter(servers.models,function(server){return!server.get('online');});_.each(offlineServers,function(server){if(!ajaxRequest.origUrl){ajaxRequest.origUrl=ajaxRequest.url;}
if(server.get('address')){ajaxRequest.url=ajaxRequest.origUrl.replace('../../',server.get('address'));}
if(!ajaxRequest.origFail){ajaxRequest.origFail=ajaxRequest.fail;}
ajaxRequest.fail=function(inSender,inResponse){server.changeOnlineStatus(false,ajaxRequest.ignoreForConnectionStatus);if(Boolean(server.get('mainServer'))){ajaxRequest.origFail(inSender,inResponse);}};if(!ajaxRequest.origSuccess){ajaxRequest.origSuccess=ajaxRequest.success;}
ajaxRequest.success=function(inSender,inResponse){if(inResponse.authenticationClient&&inResponse.authenticationToken){localStorage.authenticationClient=encodeURIComponent(JSON.stringify(inResponse.authenticationClient));localStorage.authenticationToken=encodeURIComponent(JSON.stringify(inResponse.authenticationToken));}
if(Boolean(server.get('mainServer'))&&!ajaxRequest.done){ajaxRequest.done=true;ajaxRequest.origSuccess(inSender,inResponse);}
server.changeOnlineStatus(true,ajaxRequest.ignoreForConnectionStatus);};if(localStorage.authenticationClient&&localStorage.authenticationToken){if(ajaxRequest.url.indexOf('?')===-1){ajaxRequest.url=ajaxRequest.url+'?';}else{ajaxRequest.url=ajaxRequest.url+'&';}
ajaxRequest.url=ajaxRequest.url+'authenticationClient='+localStorage.authenticationClient+'&authenticationToken='+localStorage.authenticationToken;}
ajaxRequest.xhrFields={'withCredentials':true};ajaxRequest.go(ajaxRequest.data).response('success').error('fail');});}};OB.RR.Service=Backbone.Model.extend({defaults:{name:null,type:null},initialize:function(attributes){if(attributes&&attributes.name){this.set('name',attributes.name);switch(attributes.type){case'Failover':this.set('type',OB.RR.ServTypeFailover);break;case'Transaction':this.set('type',OB.RR.ServTypeTransaction);break;case'Broadcast':this.set('type',OB.RR.ServTypeBroadcast);break;case'Ping':this.set('type',OB.RR.ServTypePing);break;default:this.set('type',OB.RR.ServTypeFailover);break;}}}});OB.RR.Server=Backbone.Model.extend({defaults:{name:null,address:null,online:true,mainServer:false,allServices:false,services:[]},changeOnlineStatus:function(newStatus,ignoreForConnectionStatus){var oldStatus=Boolean(this.get('online'));this.set('online',newStatus);if(newStatus){if(!oldStatus){this.sendPendingMessages();if(Boolean(this.get('mainServer'))&&!ignoreForConnectionStatus){OB.MobileApp.model.triggerOnLine();}}}else if(oldStatus&&Boolean(this.get('mainServer'))&&!ignoreForConnectionStatus){OB.MobileApp.model.triggerOffLine();}},sendPendingMessages:function(){OB.RR.ServTypeTransaction.sendMessages(this);},initialize:function(attributes){if(attributes&&attributes.name){this.set('name',attributes.name);if(attributes.address){this.set('address',document.location.protocol+'//'+attributes.address);if(attributes.address.charAt(attributes.address.length-1)!=='/'){this.set('address',document.location.protocol+'//'+attributes.address+'/');}}else{this.set('address',attributes.address);}
this.set('online',attributes.online);this.set('mainServer',attributes.mainServer);this.set('allServices',attributes.allServices);if(attributes.services){this.set('services',attributes.services);}else{this.set('services',[]);}}}});OB.RR.Request=Backbone.Model.extend({defaults:{ajaxRequest:null},initialize:function(attributes){if(attributes&&attributes.ajaxRequest){this.set('ajaxRequest',attributes.ajaxRequest);}},exec:function(serviceName){var service,services;OB.RR.RequestRouter.initializeProcesses();if(OB.RR.RequestRouter.servers.length===0){OB.RR.RequestRouter.pendingRequests.push({request:this,serviceName:serviceName});return true;}
if(this.get('ajaxRequest')){services=_.filter(OB.RR.RequestRouter.availableServices.models,function(srvc){return serviceName.indexOf(srvc.get('name'))!==-1;});if(services.length===0){if(OB.RR.RequestRouter.availableServices.models.length>0){OB.error("The service does not exist. Add it to the Mobile Services window in the backend (service requested: '"+serviceName+"'')");}
service=new OB.RR.Service({name:'Generic',type:OB.RR.ServTypeFailover});}else if(services.length>1){_.each(services,function(iterSrvc){if(!service||service.get('name').length<iterSrvc.get('name').length){service=iterSrvc;}});}else{service=services[0];}
service.get('type').implementation(service,this.get('ajaxRequest'));}}});OB.RR.RequestRouter={servers:new Backbone.Collection(),availableServices:new Backbone.Collection(),pendingRequests:[],initialize:function(){var me=this;this.servers=new Backbone.Collection();this.availableServices=new Backbone.Collection();if(localStorage.servers){_.each(JSON.parse(localStorage.servers),function(server){me.servers.add(new OB.RR.Server(server));});}
if(localStorage.services){_.each(JSON.parse(localStorage.services),function(service){me.availableServices.add(new OB.RR.Service(service));});}
if(!localStorage.servers||!_.find(JSON.parse(localStorage.servers),function(server){return server.address.split('/')[0]===document.location.host;})){me.servers.add(new OB.RR.Server({name:'Default',address:null,online:true,mainServer:true,allServices:true,services:[]}));}
_.each(OB.RR.RequestRouter.pendingRequests,function(obj){obj.request.exec(obj.serviceName);});},sendAllMessages:function(){var me=this;_.each(this.servers.models,function(server){server.sendPendingMessages();});},initializeProcesses:function(){var me=this;if(!OB.MobileApp.model||!OB.MobileApp.model.get('permissions')){return;}
if(this.processesInitialized){return;}
this.processesInitialized=true;function getPreference(preference,minValue,defaultValue){try{var val=OB.MobileApp.model.get('permissions')[preference];if(!val||!_.isNumber(parseInt(val,10))||parseInt(val,10)<minValue){return defaultValue;}
return parseInt(val,10);}catch(e){return defaultValue;}}
localStorage.offlinePingInterval=getPreference('OBMOBC_RequestRouterPingTime',60000,localStorage.offlinePingInterval||60000);localStorage.tokenRefreshInterval=getPreference('OBMOBC_RequestRouterTokenRefreshInterval',10*60000,localStorage.tokenRefreshInterval||30*60000);if(this.offlinePing){clearInterval(this.offlinePing);}
this.offlinePing=setInterval(function(){if(_.filter(me.servers.models,function(server){return!server.get('online');}).length>0){OB.UTIL.checkConnectivityStatus();}},localStorage.offlinePingInterval);if(this.refreshTokenProcess){clearInterval(this.refreshTokenInterval);}
this.refreshTokenInterval=setInterval(function(){me.refreshToken();},localStorage.tokenRefreshInterval);},refreshToken:function(){new OB.DS.Request('org.openbravo.mobile.core.authenticate.GetToken').exec({ignoreForConnectionStatus:true},function(data){if(data.authenticationClient&&data.authenticationToken){localStorage.authenticationClient=encodeURIComponent(data.authenticationClient);localStorage.authenticationToken=encodeURIComponent(data.authenticationToken);}},function(){},true,20000);}};OB.RR.RequestRouter.initialize();}());(function(){OB.UTIL=window.OB.UTIL||{};OB.UTIL.getParameterByName=function(name){var n=name.replace(/[\[]/,'\\[').replace(/[\]]/,'\\]');var regexS='[\\?&]'+n+'=([^&#]*)';var regex=new RegExp(regexS);var results=regex.exec(window.location.search);return(results)?decodeURIComponent(results[1].replace(/\+/g,' ')):'';};OB.UTIL.escapeRegExp=function(text){return text.replace(/[\-\[\]{}()+?.,\\\^$|#\s]/g,'\\$&');};function S4(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1).toUpperCase();}
OB.UTIL.get_UUID=function(){var array;var uuid="",i,digit="";if(window.crypto&&window.crypto.getRandomValues){array=new Uint8Array(16);window.crypto.getRandomValues(array);for(i=0;i<array.length;i++){digit=array[i].toString(16).toUpperCase();if(digit.length===1){digit="0"+digit;}
uuid+=digit;}
return uuid;}
return(S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4());};OB.UTIL.padNumber=function(n,p){var s=n.toString();while(s.length<p){s='0'+s;}
return s;};OB.UTIL.encodeXMLComponent=function(s){if(s&&s.replace){return s.replace(/\&/g,'&amp;').replace(/</g,'&lt;').replace(/\>/g,'&gt;').replace(/\'/g,'&apos;').replace(/\"/g,'&quot;');}else{return'';}};OB.UTIL.decodeXMLComponent=function(s){if(s&&s.replace){return s.replace(/\&amp\;/g,'&').replace(/\&lt\;/g,'<').replace(/\&gt\;/g,'>').replace(/\&apos\;/g,'\'').replace(/\&quot\;/g,'\"');}else{return'';}};OB.UTIL.encodeXMLMultiLineComponent=function(str,width){if(str&&str.split){var startBlock='<line><text>',endBlock='</text></line>\n',lines=str.split('\n'),l,line,result='';for(l=0;l<lines.length;l++){line=lines[l].trim();if(width&&line.length>width){result+=OB.UTIL.encodeXMLMultiLineComponent(OB.UTIL.wordwrap(line,width));}else{result+=startBlock+OB.UTIL.encodeXMLComponent(line)+endBlock;}}
return result;}else{return'';}};OB.UTIL.wordwrap=function(str,width){if(!str||!width){return str;}
return str.match(RegExp('.{1,'+width+'}(\\s|$)|\\S+?(\\s|$)','g')).join('\n');};OB.UTIL.loadResource=function(res,callback,context){var ajaxRequest=new enyo.Ajax({url:res,cacheBust:false,method:'GET',handleAs:'text',contentType:'application/x-www-form-urlencoded; charset=UTF-8',success:function(inSender,inResponse){callback.call(context||this,inResponse);},fail:function(){callback.call(context||this);}});ajaxRequest.go().response('success').error('fail');};OB.UTIL.queueStatus=function(queue){if(!_.isObject(queue)){throw'Object expected';}
return _.reduce(queue,function(memo,val){return memo&&val;},true);};OB.UTIL.checkContextChange=function(oldContext,newContext,successCallback){if(newContext.userId!==oldContext.user.id||newContext.orgId!==oldContext.organization.id||newContext.clientId!==oldContext.client.id||newContext.roleId!==oldContext.role.id){OB.warn("The context has changed");OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_ContextChanged'),OB.I18N.getLabel('OBMOBC_ContextChangedMessage'),[{isConfirmButton:true,label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){OB.MobileApp.model.lock();return true;}}]);}else{if(successCallback){successCallback();}}};OB.UTIL.checkConnectivityStatus=function(connectedCallback,notConnectedCallback){var currentlyConnected=OB.MobileApp.model.get('connectedToERP');var oldContext=OB.MobileApp.model.get('context');if(currentlyConnected&&oldContext){new OB.DS.Request('org.openbravo.mobile.core.login.ContextInformation').exec({terminal:OB.MobileApp.model.get('terminalName'),ignoreForConnectionStatus:true},function(data){var newContext;if(data&&data.exception){OB.MobileApp.model.lock();}
if(data[0]){newContext=data[0];OB.UTIL.checkContextChange(oldContext,newContext,connectedCallback);}},function(){if(OB.MobileApp.model&&OB.MobileApp.model.get('connectedToERP')){OB.MobileApp.model.triggerOffLine();}
if(notConnectedCallback){notConnectedCallback();}},true,20000);return;}else if(navigator.onLine){var rr,ajaxRequest=new enyo.Ajax({url:'../../org.openbravo.mobile.core/MobileSessionActive?id=0',cacheBust:true,timeout:20000,method:'GET',handleAs:'json',contentType:'application/x-www-form-urlencoded; charset=UTF-8',success:function(){if(connectedCallback){connectedCallback();}},fail:function(){if(notConnectedCallback){notConnectedCallback();}}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);}else{if(currentlyConnected){if(OB.MobileApp.model){OB.MobileApp.model.triggerOffLine();}}}};OB.UTIL.updateDocumentSequenceInDB=function(documentNo){var criteria={'posSearchKey':OB.MobileApp.model.get('terminal').searchKey};OB.Dal.find(OB.Model.DocumentSequence,criteria,function(documentSequenceList){var posDocumentNoPrefix=OB.MobileApp.model.get('terminal').docNoPrefix,orderDocumentSequence=parseInt(documentNo.substr(posDocumentNoPrefix.length+1),10)+1,docSeqModel;if(documentSequenceList&&documentSequenceList.length!==0){docSeqModel=documentSequenceList.at(0);if(orderDocumentSequence>docSeqModel.get('documentSequence')){docSeqModel.set('documentSequence',orderDocumentSequence);}}else{docSeqModel=new OB.Model.DocumentSequence();docSeqModel.set('posSearchKey',OB.MobileApp.model.get('terminal').searchKey);docSeqModel.set('documentSequence',orderDocumentSequence);}
OB.Dal.save(docSeqModel,null,null);});};OB.UTIL.isWritableOrganization=function(orgId){if(OB.MobileApp.model.get('writableOrganizations')){var result=false;result=_.find(OB.MobileApp.model.get('writableOrganizations'),function(curOrg){if(orgId===curOrg){return true;}});if(result){return true;}else{return false;}}else{return false;}};OB.UTIL.getCharacteristicValues=function(characteristicDescripcion){var ch_desc='';_.each(characteristicDescripcion.split(','),function(character,index,collection){ch_desc=ch_desc+character.substring(character.indexOf(':')+2);if(index!==collection.length-1){ch_desc=ch_desc+', ';}},this);return ch_desc;};OB.UTIL.isNullOrUndefined=function(value){if(_.isNull(value)||_.isUndefined(value)){return true;}
return false;};OB.UTIL.getFirstValidValue=function(valuesToCheck){var valueToReturn=_.find(valuesToCheck,function(value){if(!OB.UTIL.isNullOrUndefined(value)){return true;}});return valueToReturn;};function processConsoleLevel(logLevel,args){try{var saveInServer=OB.UTIL.checkPermissionLog(logLevel,"save");if(saveInServer){var isSaveOnlyTraceOfCaller=true;if(logLevel==='Error'||logLevel==="Critical"){isSaveOnlyTraceOfCaller=false;}
var serverMessage=OB.UTIL.argumentsToStringifyed(args)+"; stackTrace: "+OB.UTIL.getStackTrace('OB.'+logLevel.toLowerCase(),isSaveOnlyTraceOfCaller);serverMessage=(serverMessage.length<1000)?serverMessage:serverMessage.substring(0,1000);OB.UTIL.saveLogClient(serverMessage,logLevel);}
var showInConsole=OB.UTIL.checkPermissionLog(logLevel,"console");if(OB.UTIL.Debug.isDebug()||showInConsole){saveInServer=saveInServer&&(OB.MobileApp.model.get('logClientStatus')==='OK');var tags=(showInConsole||saveInServer)?("("+(showInConsole?"*":"")+((showInConsole&&saveInServer)?",":"")+(saveInServer?"+":"")+")"):"";var consoleMessage=OB.UTIL.argumentsToStringifyed(args)+"; line: "+OB.UTIL.getStackTrace('OB.'+logLevel.toLowerCase(),true)+" "+tags;if(logLevel==="Debug"||logLevel==="Trace"){console.debug(consoleMessage);}else if(logLevel==="Info"){console.info(consoleMessage);}else if(logLevel==="Warn"){console.warn(consoleMessage);}else if(logLevel==="Error"||logLevel==="Critical"){console.error(consoleMessage);}else{OB.UTIL.Debug.execute(function(){console.error("The '"+logLevel+"' log level is not implemented");});}}}catch(e){console.error(e.message+"; arguments:",args);}}
OB.trace=function(){processConsoleLevel('Trace',arguments);};OB.debug=function(){processConsoleLevel('Debug',arguments);};OB.info=function(){processConsoleLevel('Info',arguments);};OB.warn=function(){processConsoleLevel('Warn',arguments);};OB.error=function(){processConsoleLevel('Error',arguments);};OB.critical=function(){processConsoleLevel('Critical',arguments);};OB.log=function(){var level,argsWithoutFirst,i,msg;try{level=arguments[0];argsWithoutFirst=[];for(i=1;i<arguments.length;i++){argsWithoutFirst[i-1]=arguments[i];}
msg=OB.UTIL.composeMessage(argsWithoutFirst);if(OB.UTIL.checkPermissionLog(level,"save")){OB.UTIL.saveLogClient(msg,level);}
if(OB.UTIL.checkPermissionLog(level,"console")){if(level==="Info"){console.info.apply(console,OB.UTIL.argumentsWithLink(argsWithoutFirst));}else if(level==="Warn"){console.warn.apply(console,OB.UTIL.argumentsWithLink(argsWithoutFirst));}else if(level==="Error"||level==="Critical"){console.error.apply(console,OB.UTIL.argumentsWithLink(argsWithoutFirst));}else{console.log.apply(console,OB.UTIL.argumentsWithLink(argsWithoutFirst));}}}catch(e){console.error.apply(console,arguments);}};OB.UTIL.saveLogClient=function(msg,level){try{if(OB.MobileApp&&OB.MobileApp.model&&OB.MobileApp.model.supportLogClient()){if(!OB.Data.localDB){OB.MobileApp.model.set('logClientStatus','NA');return;}
var logClientModel=new OB.Model.LogClient();if(!logClientModel.modelName){console.warn("the local database must be ready for the LogClient to save log");OB.MobileApp.model.set('logClientStatus','NA');return;}
var date=new Date();logClientModel.set('created',date.getTime());logClientModel.set('createdby',OB.MobileApp.model.get('orgUserId'));logClientModel.set('loglevel',level);logClientModel.set('msg',msg);logClientModel.set('deviceId',OB.MobileApp.model.get('logConfiguration').deviceIdentifier);logClientModel.set('cacheSessionId',null);if(window.localStorage.getItem('cacheSessionId')!==null){logClientModel.set('cacheSessionId',window.localStorage.getItem('cacheSessionId'));}
logClientModel.set('link',OB.UTIL.getStackLink());_.each(OB.MobileApp.model.get('logConfiguration').logPropertiesExtension,function(f){logClientModel.set(f());});logClientModel.set('json',JSON.stringify(logClientModel.toJSON()));OB.Dal.save(logClientModel,function(){if(OB.MobileApp.model.get('logClientStatus')!=='OK'){console.debug("LogClient is available");}
OB.MobileApp.model.set('logClientStatus','OK');},function(){if(OB.MobileApp.model.get('logClientStatus')!=='NA'){console.debug("LogClient is not available");}
OB.MobileApp.model.set('logClientStatus','NA');});}}catch(e){console.error("saveLogClient "+e);}};OB.UTIL.checkPermissionLog=function(level,type){try{if((OB.MobileApp&&OB.MobileApp.model&&OB.MobileApp.model.get('permissions')!==null)===false){if(level==='Warn'||level==='Error'||level==='Critical'){return true;}
return false;}
if(type==="save"){if(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.saveLog']===false){return false;}
if(level==="Trace"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Trace');}
if(level==="Debug"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Debug');}
if(level==="Info"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Info');}
if(level==="Warn"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Info'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Warn');}
if(level==="Error"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Info'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Warn'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Error');}
if(level==="Critical"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Info'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Warn'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Error'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.levelLog']==='Critical');}}else{if(level==="Trace"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Trace');}
if(level==="Debug"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Debug');}
if(level==="Info"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Info');}
if(level==="Warn"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Info'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Warn');}
if(level==="Error"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Info'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Warn'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Error');}
if(level==="Critical"){return(OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Trace'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Debug'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Info'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Warn'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Error'||OB.MobileApp.model.get('permissions')['OBMOBC_logClient.consoleLevelLog']==='Critical');}}
return true;}catch(e){return true;}};OB.UTIL.getStackLink=function(deepness){deepness=deepness||4;try{var errorobj=new Error();var link=errorobj.stack.split('\n')[deepness].split('at ')[1];if(link.indexOf('(')>=0){link=link.split('(')[1];link=link.substring(0,link.length-1);}
if(link){return link;}}catch(e){console.error("OB.UTIL.getStackLink: "+e);}
return'';};OB.UTIL.getStackTrace=function(callerName,isReturnOnlyCallerParent){OB.UTIL.Debug.isDefined(isReturnOnlyCallerParent,"Missing 'isReturnOnlyCallerParent' argument in 'getStackTrace");function replacements(element){if(typeof(element)==='string'){return element.replace("null.<anonymous>","<async response>");}
return element;}
var stackTrace='';try{var errorobj=new Error();var links=errorobj.stack.split('\n');var i;var isTraceStartingPointReached=false;for(i=0;i<links.length;i++){var linkCandidate=links[i];if(!isTraceStartingPointReached&&linkCandidate.indexOf(callerName)>=0){isTraceStartingPointReached=true;}else if(isTraceStartingPointReached){linkCandidate=linkCandidate.split('at ')[1];stackTrace+=(stackTrace.length>0?";\n":"")+replacements(linkCandidate);if(isReturnOnlyCallerParent){return stackTrace;}}}}catch(e){console.error("OB.UTIL.getStackTrace: "+e);}
return stackTrace;};OB.UTIL.argumentsWithLink=function(args){var arrayArgs,i;try{arrayArgs=[];for(i=0;i<args.length;i++){arrayArgs.push(args[i]);}
arrayArgs.push(OB.UTIL.getStackLink());return arrayArgs;}catch(e){console.error("OB.UTIL.argumentsWithLink: "+e);return'';}};OB.UTIL.argumentsToStringifyed=function(){function replacer(key,value){if(typeof value==='function'){return value.toString().replace(/\s{2,}/g,' ');}
return value;}
function flattenArray(array){var stringifyed='';_.each(array,function(element){if(element){if(stringifyed!==''){stringifyed+='; ';}
if(typeof(element)==='string'){stringifyed+=element;}else if(element.length){if(element.length>0){stringifyed+=flattenArray(element);}else{stringifyed+=flattenArray(element[0]);}}else if(element.DATABASE_ERR!==undefined&&element.code!==undefined&&element.message!==undefined){stringifyed+="SQLError: code: "+element.code+", message: "+element.message;}else{stringifyed+=JSON.stringify(element,replacer,0);}}});return stringifyed;}
try{return flattenArray(arguments);}catch(e){console.error("OB.UTIL.argumentsToStringifyed: "+e);}
return'';};OB.UTIL.composeMessage=function(args){var msg='';_.each(args,function(arg){if(msg!==''){msg+='   ';}
if((!(_.isNull(arg)||_.isUndefined(arg)))&&_.isObject(arg)){var stringifyed=JSON.stringify(arg);if(stringifyed){msg+=(stringifyed.length<1000)?stringifyed:stringifyed.substring(0,1000);}}});return msg;};OB.UTIL.isIOS=function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i);};function initializeCloneTarget(object,target){if(target){return target;}else if(object.constructor){return new object.constructor();}
return{};}
function eventDetecterDaemon(event,object){var errorMessage="OB.UTIL.clone: Events are not allowed to be fired while cloning an object. Detected event fired: '"+event+"'. Emitter model: '"+object.modelName+"' (cid: "+object.cid+")";if(event==='add'||event==='selected'){console.error(errorMessage);return;}
throw errorMessage;}
var objectsWithEventDetecterDaemonAttached=null;function cloneRecursively(args,source,target){var clonedObject;if(typeof(source)==='object'){clonedObject=initializeCloneTarget(source,target);var isSilent=!args.isTriggerEventsIfTargetOfSourceWhenCloning;if(source.on){if(isSilent){objectsWithEventDetecterDaemonAttached.push(clonedObject);clonedObject.on("all",eventDetecterDaemon);}}else{throw OB.UTIL.argumentsToStringifyed("OB.UTIL.clone do not implement non-backbone objects. Related source:",source);}
_.each(_.keys(source.attributes),function(key){if(!_.isUndefined(source.get(key))){if(source.get(key)===null){clonedObject.set(key,null,{silent:isSilent});}else if(source.get(key).at){clonedObject.get(key).reset();source.get(key).forEach(function(elem){clonedObject.get(key).add(cloneRecursively(args,elem),{silent:isSilent});});}else if(source.get(key).get){clonedObject.set(key,cloneRecursively(args,source.get(key)),{silent:isSilent});}else if(_.isArray(source)){clonedObject.set(key,[],{silent:isSilent});source.get(key).forEach(function(elem){clonedObject.get(key).push(cloneRecursively(args,elem));});}else{clonedObject.set(key,source.get(key),{silent:isSilent});}}});_.each(_.keys(clonedObject.attributes),function(key){if(_.isUndefined(source.get(key))){clonedObject.unset(key,{silent:isSilent});}});}else{OB.UTIL.Debug.execute(function(){throw"cloneRecursively: Cannot clone the source because is not of type 'object'";});}
return clonedObject;}
var cloneCount=0;OB.UTIL.clone=function(source,target){cloneCount+=1;objectsWithEventDetecterDaemonAttached=[];var clonedObject=initializeCloneTarget(source,target);var isTriggerEventsIfTargetOfSourceWhenCloning=target&&target.triggerEventsIfTargetOfSourceWhenCloning&&target.triggerEventsIfTargetOfSourceWhenCloning();var args={isTriggerEventsIfTargetOfSourceWhenCloning:isTriggerEventsIfTargetOfSourceWhenCloning};OB.debug("("+cloneCount+") Cloning"+(isTriggerEventsIfTargetOfSourceWhenCloning?" firing events":"")+": '"+source.modelName+"' (cid: "+source.cid+" -> "+clonedObject.cid+")");var finalClonedObject=cloneRecursively(args,source,clonedObject);objectsWithEventDetecterDaemonAttached.forEach(function(element){element.off('all',eventDetecterDaemon);});OB.debug("Cloning finished: '"+source.modelName+"' (cid: "+source.cid+" -> "+clonedObject.cid+")");return finalClonedObject;};OB.UTIL.checkSourceVersion=function(sourceVersion,forceReload){if(!window.localStorage.getItem("SourceVersion_"+OB.MobileApp.model.get('appName'))){window.localStorage.setItem("SourceVersion_"+OB.MobileApp.model.get('appName'),sourceVersion);}else{if(window.localStorage.getItem("SourceVersion_"+OB.MobileApp.model.get('appName'))!==sourceVersion){if(forceReload){window.localStorage.setItem("SourceVersion_"+OB.MobileApp.model.get('appName'),sourceVersion);window.location.reload();return;}
OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_SourceVersionChanged'),OB.I18N.getLabel('OBMOBC_SourceVersionChangedMessage'),[{isConfirmButton:true,label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){window.localStorage.setItem("SourceVersion_"+OB.MobileApp.model.get('appName'),sourceVersion);window.location.reload();return true;}}]);}}};OB.UTIL.executeCallbackQueue=function(queue){while(queue.length>0){var f=queue.shift();if(f){f();}}};OB.UTIL.unAccent=function(str){var i;var defaultDiacriticsRemovalMap=[{'base':'A','letters':/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{'base':'AA','letters':/[\uA732]/g},{'base':'AE','letters':/[\u00C6\u01FC\u01E2]/g},{'base':'AO','letters':/[\uA734]/g},{'base':'AU','letters':/[\uA736]/g},{'base':'AV','letters':/[\uA738\uA73A]/g},{'base':'AY','letters':/[\uA73C]/g},{'base':'B','letters':/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{'base':'C','letters':/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{'base':'D','letters':/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{'base':'DZ','letters':/[\u01F1\u01C4]/g},{'base':'Dz','letters':/[\u01F2\u01C5]/g},{'base':'E','letters':/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{'base':'F','letters':/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{'base':'G','letters':/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{'base':'H','letters':/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{'base':'I','letters':/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{'base':'J','letters':/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{'base':'K','letters':/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{'base':'L','letters':/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{'base':'LJ','letters':/[\u01C7]/g},{'base':'Lj','letters':/[\u01C8]/g},{'base':'M','letters':/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{'base':'N','letters':/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{'base':'NJ','letters':/[\u01CA]/g},{'base':'Nj','letters':/[\u01CB]/g},{'base':'O','letters':/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{'base':'OI','letters':/[\u01A2]/g},{'base':'OO','letters':/[\uA74E]/g},{'base':'OU','letters':/[\u0222]/g},{'base':'P','letters':/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{'base':'Q','letters':/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{'base':'R','letters':/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{'base':'S','letters':/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{'base':'T','letters':/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{'base':'TZ','letters':/[\uA728]/g},{'base':'U','letters':/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{'base':'V','letters':/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{'base':'VY','letters':/[\uA760]/g},{'base':'W','letters':/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{'base':'X','letters':/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{'base':'Y','letters':/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{'base':'Z','letters':/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{'base':'a','letters':/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{'base':'aa','letters':/[\uA733]/g},{'base':'ae','letters':/[\u00E6\u01FD\u01E3]/g},{'base':'ao','letters':/[\uA735]/g},{'base':'au','letters':/[\uA737]/g},{'base':'av','letters':/[\uA739\uA73B]/g},{'base':'ay','letters':/[\uA73D]/g},{'base':'b','letters':/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{'base':'c','letters':/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{'base':'d','letters':/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{'base':'dz','letters':/[\u01F3\u01C6]/g},{'base':'e','letters':/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{'base':'f','letters':/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{'base':'g','letters':/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{'base':'h','letters':/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{'base':'hv','letters':/[\u0195]/g},{'base':'i','letters':/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{'base':'j','letters':/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{'base':'k','letters':/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{'base':'l','letters':/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{'base':'lj','letters':/[\u01C9]/g},{'base':'m','letters':/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{'base':'n','letters':/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{'base':'nj','letters':/[\u01CC]/g},{'base':'o','letters':/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{'base':'oi','letters':/[\u01A3]/g},{'base':'ou','letters':/[\u0223]/g},{'base':'oo','letters':/[\uA74F]/g},{'base':'p','letters':/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{'base':'q','letters':/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{'base':'r','letters':/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{'base':'s','letters':/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{'base':'t','letters':/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{'base':'tz','letters':/[\uA729]/g},{'base':'u','letters':/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{'base':'v','letters':/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{'base':'vy','letters':/[\uA761]/g},{'base':'w','letters':/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{'base':'x','letters':/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{'base':'y','letters':/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{'base':'z','letters':/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];for(i=0;i<defaultDiacriticsRemovalMap.length;i++){str=str.replace(defaultDiacriticsRemovalMap[i].letters,defaultDiacriticsRemovalMap[i].base);}
return str;};OB.UTIL.diffJson=function(obj1,obj2){OB.UTIL.Debug.execute(function(){try{obj1=JSON.parse(JSON.stringify(obj1));obj2=JSON.parse(JSON.stringify(obj2));}catch(e){OB.error("Illegal argument exception. Both arguments must be valid JSON objects (Error: "+e+")");}});var key,key2,result={};for(key in obj1){if(obj1.hasOwnProperty(key)){if(obj1[key]===undefined||obj1[key]===null||obj2[key]===undefined||obj2[key]===null){if(obj1[key]!==obj2[key]){result[key]=[obj2[key],obj1[key]];}}else if($.isArray(obj1[key])){if(!$.isArray(obj2[key])||obj1[key].length!==obj2[key].length){result[key]=[obj2[key],obj1[key]];}else{var preResult=OB.UTIL.diffJson(obj1[key],obj2[key]);if(JSON.stringify(preResult)!=='{}'){result[key]=preResult;}}}else if($.isPlainObject(obj1[key])){if(!$.isPlainObject(obj2[key])){result[key]=[obj2[key],obj1[key]];}else{var preResult2=OB.UTIL.diffJson(obj1[key],obj2[key]);if(JSON.stringify(preResult2)!=='{}'){result[key]=preResult2;}}}else if(obj2[key]!==obj1[key]){result[key]=[obj2[key],obj1[key]];}}}
for(key2 in obj2){if(obj2.hasOwnProperty(key2)){if(!obj1.hasOwnProperty(key2)){result[key2]=[obj2[key2],obj1[key2]];}}}
return result;};OB.UTIL.isObjectInArray=function(obj,arr){var exists=false,i=0;while(!exists&&i<arr.length){exists=_.isEqual(obj,arr[i]);i++;}
return exists;};OB.UTIL.mergeArrays=function(arr1,arr2){var i,res=[].concat(arr1);for(i=0;i<arr2.length;i++){if(!OB.UTIL.isObjectInArray(arr2[i],res)){res.push(arr2[i]);}}
return res;};OB.UTIL.isHTTPSAvailable=function(){return window.location.protocol==='https:'||window.location.hostname.indexOf('localhost')!==-1||window.location.host.indexOf('127.0.0.1')!==-1;};}());OB.Dal=OB.Dal||{};(function(){OB.Dal.DATALIMIT=300;OB.Dal.EQ='=';OB.Dal.NEQ='!=';OB.Dal.CONTAINS='contains';OB.Dal.USESCONTAINS='_usesContains';OB.Dal.STARTSWITH='startsWith';OB.Dal.ENDSWITH='endsWith';OB.Dal.FILTER='filter';OB.Dal.stackSize=0;function executeSqlErrorHandler(logLevel,header,objectInvolved,txError,e,caller){OB.UTIL.Debug.execute(function(){if(!logLevel){throw"executeSqlErrorHandler: missing logLevel";}
if(!header){throw"executeSqlErrorHandler: missing header";}
if(!objectInvolved){throw"executeSqlErrorHandler: missing objectInvolved";}
if(!e){throw"executeSqlErrorHandler: missing e";}});var link=OB.UTIL.getStackLink(3);if(objectInvolved==='obmobc_logclient'){return;}
var header2=header+" '"+objectInvolved+"'";if(logLevel==='warn'){console.warn(OB.UTIL.argumentsToStringifyed(header2,e,link));return;}
if(caller){console.error(OB.UTIL.argumentsToStringifyed(header2,e,caller));}else{console.error(OB.UTIL.argumentsToStringifyed(header2,e,link));}}
function getCallerInfo(){var message="";var stackTrace=OB.UTIL.getStackTrace('getCallerInfo',false);message+="\n"+stackTrace;return message;}
function silentFunction(f){return function(){if(_.isFunction(f)){try{f(arguments);}catch(e){OB.error('OB.Dal: a success callback threw an exception',f,"\n"+e.stack);}}};}
OB.Dal.openWebSQL=function(){if(!window.openDatabase){return;}
if(OB.Data.localDB&&OB.Data.localDB.version){return OB.Data.localDB;}
var dbInfo=OB.MobileApp.model.get('localDB');if(!dbInfo){OB.UTIL.Debug.execute(function(){throw"The database version information must be available before 'OB.Dal.openWebSQL' is called";});return;}
console.info("OB.Dal.openWebSQL: initializing WebSQL");if(OB.I18N.labels){OB.UTIL.showLoadingMessage(OB.I18N.getLabel('OBMOBC_InitializingDatabase'));}
var undef;var wsql=window.openDatabase!==undef;var db;if(wsql===false){console.error("WebSQL error: Unable find the database engine");}
try{db=(wsql&&window.openDatabase(dbInfo.name,'',dbInfo.displayName,dbInfo.size));}catch(e){console.error("Web SQL error: "+e);OB.UTIL.Debug.execute(function(e){throw"Web SQL error: "+e;});return;}
if(!db){console.error("Web SQL error");OB.UTIL.Debug.execute(function(){throw"Web SQL error";});return;}
OB.Data.localDB=db;return db;};OB.Dal.missingLocalStorageLogic=function(){OB.UTIL.Debug.execute(function(){throw"Not Implemented";});};OB.Dal.get_uuid=function(){OB.UTIL.VersionManagement.deprecated(30768,function(){});return OB.UTIL.get_UUID();};OB.Dal.transform=function(model,obj){var tmp={},modelProto=model.prototype,val,properties;properties=model.getProperties?model.getProperties():modelProto.properties;_.each(properties,function(property){var prop;if(_.isString(property)){prop=property;val=!_.isUndefined(obj[modelProto.propertyMap[property]])?obj[modelProto.propertyMap[property]]:obj[property];}else{prop=property.name;val=!_.isUndefined(obj[property.column])?obj[property.column]:obj[property.name];}
if(val==='false'){tmp[prop]=false;}else if(val==='true'){tmp[prop]=true;}else{tmp[prop]=val;}});return new model(tmp);};OB.Dal.getWhereClause=function(criteria,propertyMap){var appendWhere=true,firstParam=true,sql='',params=[],res={},orAnd=' AND ';if(criteria&&!_.isEmpty(criteria)){if(criteria.obdalcriteriaType){orAnd=' '+criteria.obdalcriteriaType+' ';delete criteria.obdalcriteriaType;}
_.each(_.keys(criteria),function(k){var undef,colName,val=criteria[k],operator=(val!==undef&&val!==null&&val.operator!==undef)?val.operator:'=',value=(val!==undef&&val!==null&&val.value!==undef)?val.value:val;if(k!=='_orderByClause'&&k!=='_orderBy'&&k!=='_limit'){if(appendWhere){sql=sql+' WHERE ';params=[];appendWhere=false;}
if(_.isArray(propertyMap)){if(k==='_filter'){colName='_filter';}else{colName=_.find(propertyMap,function(p){return k===p.name;}).column;}}else{colName=propertyMap[k];}
sql=sql+(firstParam?'':orAnd)+' '+colName+' ';if(value===null){sql=sql+' IS null ';}else{if(operator===OB.Dal.EQ){sql=sql+' = ? ';}else if(operator===OB.Dal.NEQ){sql=sql+' != ? ';}else{sql=sql+' like ? ';}
if(operator===OB.Dal.CONTAINS){value='%'+value+'%';}else if(operator===OB.Dal.STARTSWITH){value=value+'%';}else if(operator===OB.Dal.ENDSWITH){value=value+'%';}
params.push(value);}
if(firstParam){firstParam=false;}}});}
res.sql=sql;res.params=params;return res;};OB.Dal.getTableName=function(model){if(model){if(model.getTableName){return model.getTableName();}
if(model.prototype&&model.prototype.tableName){return model.prototype.tableName;}}
OB.UTIL.Debug.execute(function(){throw"OB.Dal.getTableName: the model has not been initialized";});return null;};OB.Dal.getPropertyMap=function(model){if(model){if(model.getProperties){return model.getProperties();}
if(model.prototype&&model.prototype.propertyMap){return model.prototype.propertyMap;}}
OB.UTIL.Debug.execute(function(){throw"OB.Dal.getPropertyMap: the model has not been initialized";});return null;};OB.Dal.transaction=function(callback,errorCallback,successCallback){OB.Data.localDB.transaction(callback,errorCallback,successCallback);};OB.Dal.findUsingCache=function(cacheName,model,whereClause,success,error,args){if(OB.Cache.hasItem(cacheName,whereClause)){OB.Dal.stackSize++;if(OB.Dal.stackSize%1000===0){setTimeout(function(){success(OB.Cache.getItem(cacheName,whereClause));},0);}else{success(OB.Cache.getItem(cacheName,whereClause));}}else{OB.Dal.find(model,whereClause,function(models){OB.Cache.putItem(cacheName,whereClause,models);success(models);},error,args);}};OB.Dal.findInTransaction=function(tx,model,whereClause,success,error,args){OB.Dal.find(model,whereClause,success,error,args,tx);};OB.Dal.find=function(model,whereClause,success,error,args,currentTransaction){var callerInfo=getCallerInfo();var params=null,undef,colType,xhr,rr,i,criteria,j,params_where,orderBy,limit;if(model.prototype.online){colType=OB&&OB.Collection&&OB.Collection[model.prototype.modelName+'List'];if(undef===colType){console.warn("OB.Dal.find: there is no collection defined at: OB.Data.Collection."+model.prototype.modelName+"List");OB.UTIL.Debug.execute(function(){throw"OB.Dal.find: there is no collection defined at: OB.Data.Collection."+model.prototype.modelName+"List";});}
params=enyo.clone(whereClause);if(whereClause&&_.isNumber(whereClause._limit)){limit=whereClause._limit;}else{limit=100;OB.trace('OB.Dal.find used without specific limit. Automatically set to 100.',model,whereClause);}
params._noCount=true;params._operationType='fetch';params._startRow=(whereClause&&whereClause._offset?whereClause._offset:0);params._endRow=params._startRow+limit;params._sortBy=(whereClause&&whereClause._sortBy?whereClause._sortBy:'');params.isc_dataFormat='json';params.isc_metaDataPrefix='_';if(whereClause&&whereClause._constructor){for(i in whereClause){if(whereClause.hasOwnProperty(i)){if(i==='criteria'){params.criteria=[];criteria=whereClause[i];for(j=0;j<criteria.length;j++){params.criteria.push(JSON.stringify(criteria[j]));}}else{params[i]=whereClause[i];}}}}else{params_where=(whereClause&&whereClause._where?whereClause._where:'');}
xhr=new enyo.Ajax({url:model.prototype.source,method:'POST',data:params,success:function(inSender,inResponse){success(new colType(inResponse.response.data));}});rr=new OB.RR.Request({ajaxRequest:xhr});rr.exec(xhr.url);}else if((whereClause!==null&&!_.isUndefined(whereClause.forceRemote)&&whereClause.forceRemote)||(model.prototype.remote&&OB.MobileApp.model.hasPermission(model.prototype.remote,true))){var process=new OB.DS.Process(model.prototype.source);var result=new Backbone.Collection();var currentDate=new Date();if(_.isNull(params)){params={};}
params.terminalTime=currentDate;params.terminalTimeOffset=currentDate.getTimezoneOffset();var p,l;var data={};if(params){p={};for(l in params){if(params.hasOwnProperty(l)){if(typeof params[l]==='string'){p[l]={value:params[l],type:'string'};}else if(typeof params[l]==='number'){if(params[l]===Math.round(params[l])){p[l]={value:params[l],type:'long'};}else{p[l]={value:params[l],type:'bigdecimal'};}}else if(typeof params[l]==='boolean'){p[l]={value:params[l],type:'boolean'};}else{p[l]=params[l];}}}
data.parameters=p;}
if(whereClause&&whereClause.remoteFilters){var filter=_.find(whereClause.remoteFilters,function(filter){return filter.columns[0]==='_filter';});if(filter){filter.columns=model.getFilterablePropertyNames();}
if(OB.MobileApp.model.hasPermission(model.prototype.remote+OB.Dal.USESCONTAINS,true)){var startsWithFilter=_.filter(whereClause.remoteFilters,function(filter){return filter.operator===OB.Dal.STARTSWITH;});if(startsWithFilter.length>0){_.each(startsWithFilter,function(fil){fil.operator=OB.Dal.CONTAINS;});}}}
data.remoteFilters=whereClause?whereClause.remoteFilters:null;if(whereClause&&whereClause.remoteParams){data.remoteParams=whereClause?whereClause.remoteParams:null;}
if(whereClause&&_.isNumber(whereClause._limit)){model.prototype.tempDataLimit=whereClause._limit;data._limit=whereClause._limit+1;}else if(model.prototype.dataLimit){data._limit=model.prototype.dataLimit+1;}
process.exec(data,function(data){if(data&&data.exception){if(error){error(null,data.exception);}}else{if(success){for(i=0;i<data.length;i++){result.add(OB.Dal.transform(model,data[i]));}
success(result);}}},function(){if(error){error();}});}else if(OB.Data.localDB){var tableName=OB.Dal.getTableName(model),propertyMap=OB.Dal.getPropertyMap(model),sql='SELECT * FROM '+tableName,synchId,processResult,processError;processResult=function(tr,result){if(synchId){OB.UTIL.SynchronizationHelper.finished(synchId,'find');}
var i,collectionType=OB.Collection[model.prototype.modelName+'List']||Backbone.Collection,collection=new collectionType(),len=result.rows.length;if(len===0){success(collection,args);}else{for(i=0;i<len;i++){collection.add(OB.Dal.transform(model,result.rows.item(i)));}
success(collection,args);}};processError=function(txError,e){if(synchId){OB.UTIL.SynchronizationHelper.finished(synchId,'find');}
if(!args||!args.doNotShowErrors){executeSqlErrorHandler('error',"OB.Dal.find: table",tableName,txError,e,callerInfo);}
if(error){error();}};if(tableName===null){console.warn("OB.Dal.find: tableName not found");OB.UTIL.Debug.execute(function(){throw"OB.Dal.find: tableName not found";});}
if(propertyMap===null){console.warn("OB.Dal.find: propertyMap not found");OB.UTIL.Debug.execute(function(){throw"OB.Dal.find: propertyMap not found";});}
if(whereClause&&whereClause._orderByClause){orderBy=whereClause._orderByClause;}
if(whereClause&&whereClause._orderBy){_.forEach(whereClause._orderBy,function(elem){if(_.isUndefined(orderBy)){orderBy='';}else{orderBy+=', ';}
orderBy+=elem.column;if(!_.isUndefined(elem.asc)){if(elem.asc){orderBy+=' asc';}else{orderBy+=' desc';}}});}
if(whereClause&&whereClause._limit){model.prototype.tempDataLimit=whereClause._limit;limit=whereClause._limit+1;}else{limit=model.prototype.dataLimit;}
if(whereClause&&whereClause._whereClause){whereClause.sql=' '+whereClause._whereClause;}else{whereClause=OB.Dal.getWhereClause(whereClause,propertyMap);}
sql=sql+whereClause.sql;params=_.isEmpty(whereClause.params)?[]:whereClause.params;if(orderBy){sql=sql+' ORDER BY '+orderBy+' ';}else if(model.propertyList||model.prototype.propertyMap._idx){sql=sql+' ORDER BY _idx ';}
if(limit){sql=sql+' LIMIT '+limit;}
if(currentTransaction){currentTransaction.executeSql(sql,params,processResult,processError);}else{OB.Data.localDB.readTransaction(function(tx){if(model.prototype.modelName!=='LogClient'){synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('find '+model.prototype.modelName);}
tx.executeSql(sql,params,processResult,processError);});}}else{this.missingLocalStorageLogic();}};OB.Dal.queryUsingCache=function(model,sql,params,success,error,args){if(OB.Cache.hasItem(sql,params)){OB.Dal.stackSize++;if(OB.Dal.stackSize%50===0){setTimeout(function(){success(OB.Cache.getItem(sql,''),args);},0);}else{success(OB.Cache.getItem(sql,''),args);}}else{OB.Dal.query(model,sql,params,function(models){OB.Cache.putItem(sql,params,models);success(models,args);},error,args);}};OB.Dal.queryInTransaction=function(tx,model,sql,params,success,error,args){OB.Dal.query(model,sql,params,success,error,args,tx);};OB.Dal.query=function(model,sql,params,success,error,args,currentTransaction,limit){var processResult,processError;processResult=function(tr,result){var i,collectionType=OB.Collection[model.prototype.modelName+'List']||Backbone.Collection,collection=new collectionType(),len=result.rows.length;if(len===0){success(collection,args);}else{for(i=0;i<len;i++){collection.add(OB.Dal.transform(model,result.rows.item(i)));}
success(collection,args);}};processError=function(txError,e){executeSqlErrorHandler('error',"OB.Dal.query: table",model.prototype.modelName,txError,e);if(_.isFunction(error)){error();}};if(OB.Data.localDB){if(_.isNumber(limit)){model.prototype.tempDataLimit=limit;sql=sql+' LIMIT '+limit+1;}else if(model.prototype.dataLimit){sql=sql+' LIMIT '+model.prototype.dataLimit;}
if(currentTransaction){currentTransaction.executeSql(sql,_.isEmpty(params)?[]:params,processResult,processError);}else{OB.Data.localDB.transaction(function(tx){tx.executeSql(sql,_.isEmpty(params)?[]:params,processResult,processError);});}}else{this.missingLocalStorageLogic();}};OB.Dal.saveInTransaction=function(tx,model,success,error,forceInsert){OB.Dal.save(model,success,error,forceInsert,tx);};OB.Dal.save=function(model,success,error,forceInsert,currentTransaction){var caller=OB.UTIL.getStackTrace('save',true);var callerInfo=getCallerInfo();var modelProto=model.constructor.prototype,xhr,rr,data={};forceInsert=forceInsert||false;if(modelProto&&modelProto.online){if(!model){console.warn("OB.Dal.save: you need to pass a Model instance to save");OB.UTIL.Debug.execute(function(){throw"OB.Dal.save: you need to pass a Model instance to save";});}
data.operationType='update';data.data=model.toJSON();xhr=new enyo.Ajax({url:modelProto.source,method:'PUT',data:JSON.stringify(data),success:function(inSender,inResponse){success(inResponse);}});rr=new OB.RR.Request({ajaxRequest:xhr});rr.exec(xhr.url);}else if(OB.Data.localDB){var modelDefinition=OB.Model[modelProto.modelName],tableName=OB.Dal.getTableName(modelDefinition),primaryKey,primaryKeyProperty='id',primaryKeyColumn,sql='',params=null,firstParam=true,uuid,propertyName,filterVal,processError;var updateToBeChecked=false;processError=function(txError,e){executeSqlErrorHandler('error',"OB.Dal.save: table",tableName,txError,e,callerInfo);if(_.isFunction(error)){error();}};if(!tableName){console.warn("OB.Dal.save: tableName not found");OB.UTIL.Debug.execute(function(){throw"OB.Dal.save: tableName not found";});}
if(modelDefinition.getPrimaryKey){primaryKey=modelDefinition.getPrimaryKey();primaryKeyProperty=primaryKey.name;primaryKeyColumn=primaryKey.column;}else{primaryKeyColumn=modelProto.propertyMap[primaryKeyProperty];}
if(model.get(primaryKeyProperty)&&forceInsert===false){if(modelDefinition.getUpdateStatement){sql=modelDefinition.getUpdateStatement();params=[];_.each(modelDefinition.getPropertiesForUpdate(),function(property){if(property.name){params.push(model.get(property.name));}});if(modelDefinition.hasFilter()){filterVal='';_.each(modelDefinition.getFilterProperties(),function(filterProperty){filterVal=OB.UTIL.unAccent(filterVal)+(model.get(filterProperty)?(model.get(filterProperty)+'###'):'');});params.push(filterVal);}
params.push(model.get(primaryKeyProperty));}else{if(tableName==='c_order'){updateToBeChecked=true;}
sql='UPDATE '+tableName+' SET ';_.each(_.keys(modelProto.properties),function(attr){propertyName=modelProto.properties[attr];if(attr==='id'){return;}
if(firstParam){firstParam=false;params=[];}else{sql=sql+', ';}
sql=sql+modelProto.propertyMap[propertyName]+' = ? ';params.push(model.get(propertyName));});if(modelProto.propertiesFilter){filterVal='';_.each(modelProto.propertiesFilter,function(prop){filterVal=filterVal+(model.get(prop)?(model.get(prop)+'###'):'');});sql=sql+', _filter = ? ';params.push(filterVal);}
sql=sql+' WHERE '+tableName+'_id = ?';params.push(model.get('id'));}}else{params=[];sql=modelDefinition.getInsertStatement?modelDefinition.getInsertStatement():modelProto.insertStatement;if(forceInsert===false){uuid=OB.UTIL.get_UUID();params.push(uuid);if(model.getPrimaryKey){primaryKey=model.getPrimaryKey();model.set(primaryKey.name,uuid);}else{model.set('id',uuid);}}
if(modelDefinition.getProperties){_.each(modelDefinition.getProperties(),function(property){if(forceInsert===false){if(property.primaryKey){return;}}
if(property.name==='_filter'){return;}
if(property.name){params.push(model.get(property.name)===undefined?null:model.get(property.name));}});}else{_.each(modelProto.properties,function(property){if(forceInsert===false){if('id'===property){return;}}
if(model.get(property)==='_filter'){return;}
params.push(model.get(property)===undefined?null:model.get(property));});}
if(modelDefinition.hasFilter){if(modelDefinition.hasFilter()){filterVal='';_.each(modelDefinition.getFilterProperties(),function(filterProp){filterVal=OB.UTIL.unAccent(filterVal)+(model.get(filterProp)?(model.get(filterProp)+'###'):'');});params.splice(params.length-1,0,filterVal);}}else{if(modelProto.propertiesFilter){filterVal='';_.each(modelProto.propertiesFilter,function(prop){filterVal=filterVal+(model.get(prop)?(model.get(prop)+'###'):'');});params.splice(params.length-1,0,filterVal);}}}
if(currentTransaction){if(updateToBeChecked){OB.Dal.getInTransaction(currentTransaction,modelDefinition,model.get('id'),function(result){if(result){if(result.get('hasbeenpaid')==='Y'){OB.error('[checkBlocked][transaction][hasbeenpaid_is_yes] Wrong write in c_order avoided ['+result.get('id')+']['+result.get('documentNo')+'] - Caller: '+caller+' - callerInfo: '+callerInfo);if(success){success();}}else{try{currentTransaction.executeSql(sql,params,silentFunction(success),processError);}catch(e){executeSqlErrorHandler('error',"OB.Dal.save: table",tableName,null,e,callerInfo);}}}else{OB.warn('[checkBlocked][transaction] No result after getInTransaction for ['+model.get('id')+']['+model.get('documentNo')+']. This update doesnt make sense - Caller: '+caller+' - callerInfo: '+callerInfo);if(success){success();}}},function(){OB.error('[checkBlocked][transaction] Error for ['+model.get('id')+']['+model.get('documentNo')+'] - Caller: '+caller+' - callerInfo: '+callerInfo);if(error){error();}},function(){OB.warn('[checkBlocked][transaction] No result after getInTransaction for ['+model.get('id')+']['+model.get('documentNo')+']. This update doesnt make sense - Caller: '+caller+' - callerInfo: '+callerInfo);if(success){success();}});}else{try{currentTransaction.executeSql(sql,params,silentFunction(success),processError);}catch(e){executeSqlErrorHandler('error',"OB.Dal.save: table",tableName,null,e,callerInfo);}}}else{if(updateToBeChecked){OB.Data.localDB.transaction(function(tx){OB.Dal.getInTransaction(tx,modelDefinition,model.get('id'),function(result){if(result){if(result.get('hasbeenpaid')==='Y'){OB.error('[checkBlocked][no-transaction][hasbeenpaid_is_yes] Wrong write in c_order avoided ['+result.get('id')+']['+result.get('documentNo')+'] - Caller: '+caller+' - callerInfo: '+callerInfo);if(success){success();}}else{try{tx.executeSql(sql,params,silentFunction(success),processError);}catch(e){executeSqlErrorHandler('error',"OB.Dal.save: table",tableName,null,e,callerInfo);}}}else{OB.warn('[checkBlocked][no-transaction] No result after getInTransaction for ['+model.get('id')+']['+model.get('documentNo')+']. This update doesnt make sense - Caller: '+caller+' - callerInfo: '+callerInfo);if(success){success();}}},function(){OB.error('[checkBlocked][no-transaction] Error for ['+model.get('id')+']['+model.get('documentNo')+']');if(error){error();}},function(){OB.warn('[checkBlocked][no-transaction] No result after getInTransaction for ['+model.get('id')+']['+model.get('documentNo')+']. This update doesnt make sense - Caller: '+caller+' - callerInfo: '+callerInfo);if(success){success();}});});}else{OB.Data.localDB.transaction(function(tx){try{tx.executeSql(sql,params,silentFunction(success),processError);}catch(e){executeSqlErrorHandler('error',"OB.Dal.save: table",tableName,null,e,callerInfo);}});}}}else{this.missingLocalStorageLogic();}};OB.Dal.removeInTransaction=function(tx,model,success,error){OB.Dal.remove(model,success,error,tx);};OB.Dal.saveTemporally=function(model,success,error,forceInsert){var idArrayName='',temp;switch(model.constructor.prototype.modelName){case'Product':idArrayName='remoteProducts';break;case'BusinessPartner':idArrayName='remoteCustomers';break;case'BPLocation':idArrayName='remoteCustomerLocations';break;case'SalesRepresentative':idArrayName='remoteSalesReps';break;case'DiscountFilterBusinessPartner':idArrayName='remoteDiscountFilterBP';break;default:idArrayName='remoteProducts';break;}
if(!localStorage[idArrayName]){localStorage[idArrayName]=JSON.stringify([]);}
temp=JSON.parse(localStorage[idArrayName]);if(!_.find(temp,function(id){return id===model.id;})){OB.Dal.save(model,success,error,forceInsert);}else if(success){success();}
temp.push(model.id);localStorage[idArrayName]=JSON.stringify(temp);};OB.Dal.removeTemporally=function(model,success,error){var idArrayName='',temp;switch(model.constructor.prototype.modelName){case'Product':idArrayName='remoteProducts';break;case'BusinessPartner':idArrayName='remoteCustomers';break;case'BPLocation':idArrayName='remoteCustomerLocations';break;case'SalesRepresentative':idArrayName='remoteSalesReps';break;case'DiscountFilterBusinessPartner':idArrayName='remoteDiscountFilterBP';break;default:idArrayName='remoteProducts';break;}
if(!localStorage[idArrayName]){return true;}
temp=JSON.parse(localStorage[idArrayName]);temp.splice(_.indexOf(temp,model.id),1);localStorage[idArrayName]=JSON.stringify(temp);if(_.indexOf(temp,model.id)===-1){OB.Dal.remove(model,success,error);}else if(success){success();}};OB.Dal.updateRecordColumn=function(record,columnName,newValue,successCallback,errorCallback){if(OB.Data.localDB){var modelProto=record.constructor.prototype;var modelDefinition=OB.Model[modelProto.modelName];var tableName=OB.Dal.getTableName(modelDefinition);var sql="UPDATE "+tableName+" SET "+columnName+" = ? WHERE "+tableName+"_id = ?";var params=[newValue,record.get('id')];OB.Data.localDB.transaction(function(tx){try{tx.executeSql(sql,params,function(){OB.info("'isbeingprocessed' has been set to 'Y' in the '"+tableName+"' table, record id: "+record.get('id'));successCallback();},function(txError,e){OB.error("'isbeingprocessed' has NOT been set to 'Y' in the '"+tableName+"' table, record id: "+record.get('id')+". Error message: "+e.message);errorCallback(txError,e);});}catch(e){OB.error("cannot create a transaction for the '"+tableName+"' table, record id: "+record.get('id')+". Error message: "+e);errorCallback(null,e);}});}};OB.Dal.remove=function(model,success,error,currentTransaction){if(OB.Data.localDB){var modelDefinition=OB.Model[model.constructor.prototype.modelName],modelProto=model.constructor.prototype,tableName=OB.Dal.getTableName(modelDefinition),pk,pkProperty='id',pkColumn,sql='',params=[],processError;processError=function(txError,e){executeSqlErrorHandler('error',"OB.Dal.remove: table",tableName,txError,e);if(_.isFunction(error)){error();}};if(!tableName){console.warn("OB.Dal.remove: tableName not found");OB.UTIL.Debug.execute(function(){throw"OB.Dal.remove: tableName not found";});}
if(modelDefinition.getPrimaryKey){pk=modelDefinition.getPrimaryKey()?modelDefinition.getPrimaryKey():null;if(pk){pkProperty=pk.name;pkColumn=pk.column;}else{pkColumn=modelDefinition.propertyMap[pkProperty];}}
if(model.get(pkProperty)){if(modelDefinition.getDeleteByIdStatement){sql=modelDefinition.getDeleteByIdStatement();}else{sql='DELETE FROM '+tableName+' WHERE '+modelProto.propertyMap[pkProperty]+' = ? ';}
params.push(model.get(pkProperty));}else{console.warn("OB.Dal.remove: an object without primary key cannot be deleted");OB.UTIL.Debug.execute(function(){throw"OB.Dal.remove: an object without primary key cannot be deleted";});}
if(currentTransaction){currentTransaction.executeSql(sql,params,silentFunction(success),processError);}else{OB.Data.localDB.transaction(function(tx){tx.executeSql(sql,params,silentFunction(success),processError);});}}else{this.missingLocalStorageLogic();}};OB.Dal.removeAllTemporally=function(model,criteria,success,error){var idArrayName='',temp,modelName=model.constructor.prototype.modelName?model.constructor.prototype.modelName:model.prototype.modelName;switch(modelName){case'Product':idArrayName='remoteProducts';break;case'BusinessPartner':idArrayName='remoteCustomers';break;case'BPLocation':idArrayName='remoteCustomerLocations';break;case'SalesRepresentative':idArrayName='remoteSalesReps';break;case'DiscountFilterBusinessPartner':idArrayName='remoteDiscountFilterBP';break;default:idArrayName='remoteProducts';break;}
if(!localStorage[idArrayName]){success();}else{localStorage[idArrayName]=JSON.stringify([]);OB.Dal.removeAll(model,criteria,success,error);}};OB.Dal.removeAllInTransaction=function(tx,model,criteria,success,error){OB.Dal.removeAll(model,criteria,success,error,tx);};OB.Dal.removeAll=function(model,criteria,success,error,currentTransaction){if(OB.Data.localDB){var tableName=OB.Dal.getTableName(model),propertyMap=OB.Dal.getPropertyMap(model),sql,params,whereClause,processError;processError=function(txError,e){executeSqlErrorHandler('error',"OB.Dal.removeAll: table",tableName,txError,e);if(_.isFunction(error)){error();}};if(!tableName){console.warn("OB.Dal.removeAll: tableName not found");OB.UTIL.Debug.execute(function(){throw"OB.Dal.removeAll: tableName not found";});}
sql='DELETE FROM '+tableName;whereClause=OB.Dal.getWhereClause(criteria,propertyMap);sql=sql+whereClause.sql;params=_.isEmpty(whereClause.params)?[]:whereClause.params;if(currentTransaction){currentTransaction.executeSql(sql,params,silentFunction(success),processError);}else{OB.Data.localDB.transaction(function(tx){tx.executeSql(sql,params,silentFunction(success),processError);});}}else{this.missingLocalStorageLogic();}};OB.Dal.getInTransaction=function(tx,model,id,success,error,empty){OB.Dal.get(model,id,success,error,empty,tx);};OB.Dal.get=function(model,id,success,error,empty,currentTransaction){OB.UTIL.Debug.execute(function(){var caller=OB.UTIL.getStackTrace('get',true);var callerInfo=getCallerInfo();if(!id){OB.warn("[dberror] OB.Dal.get: id not found. - Caller: "+caller+" - Caller info: "+callerInfo);}});if(model.prototype.remote&&OB.MobileApp.model.hasPermission(model.prototype.remote,true)){var process=new OB.DS.Process(model.prototype.source);var currentDate=new Date();var params={};params.terminalTime=currentDate;params.terminalTimeOffset=currentDate.getTimezoneOffset();var p,i;var data={};if(params){p={};for(i in params){if(params.hasOwnProperty(i)){if(typeof params[i]==='string'){p[i]={value:params[i],type:'string'};}else if(typeof params[i]==='number'){if(params[i]===Math.round(params[i])){p[i]={value:params[i],type:'long'};}else{p[i]={value:params[i],type:'bigdecimal'};}}else if(typeof params[i]==='boolean'){p[i]={value:params[i],type:'boolean'};}else{p[i]=params[i];}}}
data.parameters=p;}
var objectId={columns:['id'],operator:'equals',value:id,isId:true};var remoteCriteria=[objectId];data.remoteFilters=remoteCriteria;process.exec(data,function(data){if(data&&data.exception){if(error){error(null,data.exception);}}else{if(success){if(data.length===0){if(empty){empty(null);}}else{success(OB.Dal.transform(model,data[0]));}}}},function(){if(error){error();}});}else if(OB.Data.localDB){var tableName=OB.Dal.getTableName(model),sql='SELECT * FROM '+tableName+' WHERE '+tableName+'_id = ?',processResult,processError;processResult=function(tr,result){if(result.rows.length===0){if(empty){empty();}else{return null;}}else{success(OB.Dal.transform(model,result.rows.item(0)));}};processError=function(txError,e){executeSqlErrorHandler('error',"OB.Dal.get: table",tableName,txError,e);if(_.isFunction(error)){error();}};if(currentTransaction){currentTransaction.executeSql(sql,[id],processResult,processError);}else{OB.Data.localDB.readTransaction(function(tx){tx.executeSql(sql,[id],processResult,processError);});}}else{this.missingLocalStorageLogic();}};OB.Dal.dropTable=function(model,successCallback,errorCallback){if(OB.Data.localDB){var sql=model.getDropStatement?model.getDropStatement():model.prototype.dropStatement;OB.Data.localDB.transaction(function(tx){tx.executeSql(sql,[],function(){OB.debug('succesfully dropped table: '+sql);successCallback();},errorCallback);});}else{this.missingLocalStorageLogic();}};OB.Dal.initCache=function(model,initialData,success,error,incremental){if(OB.Data.localDB){error=error||function(){};if(!model.propertyList&&(!model.prototype.createStatement||!model.prototype.dropStatement)){console.warn("OB.Dal.initCache: model requires a create and drop statement");OB.UTIL.Debug.execute(function(){throw"OB.Dal.initCache: model requires a create and drop statement";});}
if(!initialData){console.warn("OB.Dal.initCache: initialData must be passed as parameter");OB.UTIL.Debug.execute(function(){throw"OB.Dal.initCache: initialData must be passed as parameter";});}
if(!model.prototype.local&&!incremental){OB.Data.localDB.transaction(function(tx){var st=model.getDropStatement?model.getDropStatement():model.prototype.dropStatement;tx.executeSql(st,[],null,function(txError,e){executeSqlErrorHandler('error',"OB.Dal.initCache: table",model.prototype.modelName,txError,e);if(_.isFunction(error)){error();}});},error);}
OB.Data.localDB.transaction(function(tx){var createStatement=model.getCreateStatement?model.getCreateStatement():model.prototype.createStatement;if(createStatement.indexOf("PRIMARY KEY NOT NULL")===-1){createStatement=createStatement.replace("PRIMARY KEY","PRIMARY KEY NOT NULL");}
OB.UTIL.Debug.execute(function(){if(createStatement.indexOf("PRIMARY KEY NOT NULL")===-1){throw"The create statement must contain a 'PRIMARY KEY NOT NULL' (createStatement: '"+createStatement+"'";}});var createIndexStatement;tx.executeSql(createStatement,[],function(){if(model.hasIndex&&model.hasIndex()){_.each(model.getIndexes(),function(indexDefinition){createIndexStatement=model.getCreateIndexStatement(indexDefinition);tx.executeSql(createIndexStatement,[],null,function(txError,e){executeSqlErrorHandler('error',"OB.Dal.initCache: index for table",model.prototype.modelName,txError,e);});});}
model.areTablesCreated=true;},function(txError,e){executeSqlErrorHandler('error',"OB.Dal.initCache: table",model.prototype.modelName,txError,e);});},error);if(_.isArray(initialData)){OB.Dal.insertData(model,initialData,success,error,incremental,0);}else{console.warn("OB.Dal.initCache: initialData must be an Array");OB.UTIL.Debug.execute(function(){throw"OB.Dal.initCache: initialData must be an Array";});}}else{this.missingLocalStorageLogic();}};OB.Dal.insertData=function(model,data,success,error,incremental,offset){OB.Data.localDB.transaction(function(tx){var props=model.getProperties?model.getProperties():model.prototype.properties,filterVal,values,_idx=offset,updateRecord,handleError,insertStatement,filterProps;handleError=function(txError,e){executeSqlErrorHandler('error',"OB.Dal.insertData: model insert",model.prototype.modelName,txError,e);if(_.isFunction(error)){error();}};updateRecord=function(tx,model,values,active){var deleteStatement;deleteStatement=model.getDeleteByIdStatement?model.getDeleteByIdStatement():"DELETE FROM "+model.prototype.tableName+" WHERE "+model.prototype.propertyMap.id+"=?";tx.executeSql(deleteStatement,[values[0]],function(){if(_.isUndefined(active)||active){var insertSatement;insertSatement=model.getInsertStatement?model.getInsertStatement():model.prototype.insertStatement;tx.executeSql(insertSatement,values,null,handleError);}},handleError);};insertStatement=model.getInsertStatement?model.getInsertStatement():model.prototype.insertStatement;filterProps=model.getFilterProperties?model.getFilterProperties():model.prototype.propertiesFilter;_.each(data,function(item){values=[];_.each(props,function(prop){var propName=typeof prop==='string'?prop:prop.name;if(!propName||'_idx'===propName||'_filter'===propName){return;}
values.push(item[propName]);});if((model.hasFilter&&model.hasFilter())||model.prototype.propertiesFilter){filterVal='';_.each(filterProps,function(prop){filterVal=OB.UTIL.unAccent(filterVal)+(item[prop]?(item[prop]+'###'):'');});values.push(filterVal);}
values.push(_idx);if(incremental){updateRecord(tx,model,values,item.active);}else if(OB.UTIL.isNullOrUndefined(item.active)||(item.active&&item.active===true)){tx.executeSql(insertStatement,values,null,handleError);}
_idx++;});},error,function(){if(_.isFunction(success)){success();}});};OB.Dal.loadModels=function(online,models,data,incremental){var somethigToLoad=false,timestamp=0;function triggerReady(models){if(incremental&&models._LoadQueue&&OB.UTIL.queueStatus(models._LoadQueue)){window.localStorage.setItem('POSLastIncRefresh',new Date().getTime());}
if(models._LoadOnline&&OB.UTIL.queueStatus(models._LoadQueue||{})){if(!OB.MobileApp.model.get('datasourceLoadFailed')){if(models._LoadQueue&&!incremental){window.localStorage.setItem('POSLastTotalRefresh',new Date().getTime());}
models.trigger('ready');}else{var hasPagedRequestError=_.find(models._failedModels,function(modelName){return window.localStorage.getItem('lastUpdatedTimestamp'+modelName)===null;});if(window.localStorage.getItem('POSLastTotalRefresh')===null||hasPagedRequestError){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_MasterDataErrorHeader'),OB.I18N.getLabel('OBMOBC_MasterDataErrorBody',[models._failedModels.join(', ')])+OB.I18N.getLabel('OBMOBC_LoadingErrorBody'),[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){popup.$.headerCloseButton.hide();},autoDismiss:false});}else{models.trigger('ready');}}}}
function buildLoadQueue(){_.each(models,function(item){if(item&&item.generatedModel){item=OB.Model[item.modelName];}
if(item&&((online&&item.prototype.online)||(!online&&!item.prototype.online))&&!item.prototype.local){models._LoadQueue=models._LoadQueue||{};models._LoadQueue[item.prototype.modelName]=false;}});}
function processModelAtIndex(index){var ds,load,item=models[index];if(index===models.length){return;}
if(item&&item.generatedModel){item=OB.Model[item.modelName];}
load=item&&((online&&item.prototype.online)||(!online&&!item.prototype.online))&&(!item.prototype.remote||(item.prototype.remote&&!OB.MobileApp.model.hasPermission(item.prototype.remote,true)));if(load){if(item.prototype.local){OB.Dal.initCache(item,[],function(){processModelAtIndex(index+1);},function(){OB.error('init error',arguments);processModelAtIndex(index+1);});}else{if(incremental&&window.localStorage.getItem('lastUpdatedTimestamp'+item.prototype.modelName)){timestamp=window.localStorage.getItem('lastUpdatedTimestamp'+item.prototype.modelName);}
ds=new OB.DS.DataSource(new OB.DS.Request(item,timestamp));somethigToLoad=true;models._failedModels=models._failedModels||[];ds.on('ready',function(status){if(status==='failed'){models._failedModels.push(item.prototype.modelName);}else{OB.info('[sdreresh] Loading data for '+item.prototype.modelName);if(data&&online){data[item.prototype.modelName]=new Backbone.Collection(ds.cache);}}
models._LoadQueue[item.prototype.modelName]=true;triggerReady(models);processModelAtIndex(index+1);});if(item.prototype.includeTerminalDate){var currentDate=new Date();item.params=item.params||{};item.params.terminalTime=currentDate;item.params.terminalTimeOffset=currentDate.getTimezoneOffset();}
ds.load(item.params,incremental);}}else if(item&&item.prototype.remote&&OB.MobileApp.model.hasPermission(item.prototype.remote,true)){if(models._LoadQueue){models._LoadQueue[item.prototype.modelName]=true;}
processModelAtIndex(index+1);}else{processModelAtIndex(index+1);}}
models._LoadOnline=online;if(models.length===0){triggerReady(models);return;}
buildLoadQueue();processModelAtIndex(0);if(!somethigToLoad){triggerReady(models);}};}());OB.Data=OB.Data||{};OB.Model=OB.Model||{};OB.Collection=OB.Collection||{};OB.Data.Registry=OB.Data.Registry||{};OB.Data.BaseModel=Backbone.Model.extend();OB.Data.Registry={};OB.Data.Registry.registerModel=function(modelParam){var modelName,model;if(typeof modelParam==='string'){modelName=modelParam;model=OB.Data.BaseModel.extend({modelName:modelName,source:'../../org.openbravo.service.datasource/'+modelName,online:true});}else if(modelParam.prototype.generatedStructure){var url='../../org.openbravo.mobile.core/OBMOBC_Main/ClientModel';url+='?entity='+modelParam.prototype.entityName;url+='&modelName='+modelParam.prototype.modelName;url+='&source='+modelParam.prototype.source;if(modelParam.prototype.remote){url+='&remote='+modelParam.prototype.remote;}
var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('registerModel');var ajaxRequest=new enyo.Ajax({url:url,method:'GET',handleAs:'text',cacheBust:false,success:function(inSender,inResponse){OB.UTIL.SynchronizationHelper.finished(synchId,'registerModel');eval(inResponse);modelParam.prototype.structureLoaded=true;},fail:function(){OB.UTIL.SynchronizationHelper.finished(synchId,'registerModel');}});ajaxRequest.go().response('success').error('fail');return;}else{modelName=modelParam.prototype.modelName;model=modelParam;}
if(!modelName){window.error('Error registering model: no modelName provided',modelParam);}
OB.Model[modelName]=model;OB.Collection[modelName+'List']=Backbone.Collection.extend({model:OB.Model[modelName]});};OB.Data.getModelStructureChecksum=function(model){var structure="";_.each(model.propertyList||model.prototype.propertyMap,function(p){structure+=JSON.stringify(p);});_.each(model.indexList,function(p){structure+=JSON.stringify(p);});if(structure===""){return"";}
return OB.MobileApp.model.generate_sha1(structure);};OB.Data.ExtensibleModel=Backbone.Model.extend({},{propertyList:[],indexList:[],addProperties:function(properties){this.propertyList=this.propertyList.concat(properties);},addIndex:function(index){this.indexList=this.indexList.concat(index);},getProperties:function(options){var props=_.clone(this.propertyList);if(this.hasFilter()){props.push({name:'_filter',column:'_filter',type:'TEXT'});}
if(options&&options.skipIdx){return props;}
props.push({name:'_idx',column:'_idx',type:'NUMERIC'});return props;},getPropertiesForUpdate:function(options){var props=[];_.each(this.propertyList,function(property){if(!property.primaryKey){props.push(property);}});if(this.hasFilter()){props.push({column:'_filter',type:'TEXT'});}
return props;},getTableName:function(){return this.prototype.tableName;},isOnlineModel:function(){return this.prototype.online;},isTerminalDateIncluded:function(){return this.prototype.includeTerminalDate;},getDropStatement:function(){return'DROP TABLE IF EXISTS '+this.getTableName();},getCreateStatement:function(){return'CREATE TABLE IF NOT EXISTS '+this.getTableName()+'\n'+this.getSQLColumns(true);},getCreateIndexStatement:function(indexToCreate){if(indexToCreate&&indexToCreate.columns){var indexedColumn=[];_.each(indexToCreate.columns,function(col){var sort='asc';if(col.sort){sort=col.sort;}
indexedColumn.push(col.name+' '+sort);});return'CREATE INDEX IF NOT EXISTS '+indexToCreate.name+' ON '+this.getTableName()+' ('+indexedColumn.join(',')+')';}else{OB.warn('A correct object is needed to create indexes');return'';}},getInsertStatement:function(){var i,statement='INSERT INTO '+this.getTableName()+'\n'+this.getSQLColumns()+'\nVALUES\n(';for(i=0;i<this.getProperties().length;i++){statement+=(i===0?'':', ')+'?';}
return statement+')';},getUpdateStatement:function(){var i,j=0,statement='UPDATE '+this.getTableName()+'\nSET\n ';for(i=0;i<this.getPropertiesForUpdate().length;i++){if(!this.getPropertiesForUpdate()[i].primaryKey){statement+=(j===0?'':', ');statement+=this.getPropertiesForUpdate()[i].column+' = ?';j+=1;}}
statement+='\n WHERE '+this.getPrimaryKey().column+' = ?';return statement;},getDeleteByIdStatement:function(){var id;if(this.deleteByIdStatement){return this.deleteByIdStatement;}
id=this.getPrimaryKey();this.deleteByIdStatement="DELETE FROM "+this.getTableName()+" WHERE "+id.column+" = ?";return this.deleteByIdStatement;},getPrimaryKey:function(){var pk=null;pk=_.find(this.getProperties(),function(p){return p.primaryKey;});return pk;},getFilterProperties:function(){var filterProps=[];_.each(_.filter(this.propertyList,function(p){return p.filter;}),function(p){filterProps.push(p.name);});return filterProps;},getIndexes:function(){var indexedProps=[];if(this.indexList&&this.indexList.length>0){_.each(this.indexList,function(p){indexedProps.push(p);});return indexedProps;}else{return[];}},hasFilter:function(){return this.getFilterProperties().length>0;},hasIndex:function(){return this.getIndexes().length>0;},getSQLColumns:function(includeType){var columns='';_.each(this.getProperties(),function(p){if(columns!==''){columns+=',\n';}
columns+=p.column;if(includeType){columns+=' '+p.type+(p.primaryKey?' PRIMARY KEY':'');}});return'('+columns+')';},getFilterablePropertyNames:function(){return _.map(_.filter(this.propertyList,function(property){if(!property.skipremote){return property.filter;}}),function(filterProperty){return filterProperty.name;});}});OB.Model.WindowModel=Backbone.Model.extend({data:{},initModels_initUI_loadModels_renderUI:function(initUI,renderUI){if(!this.initModels){OB.UTIL.VersionManagement.deprecated(30610,function(){this.load();},null,this);return;}
var me=this;if(!this.models){this.models=[];}
_.extend(this.models,Backbone.Events);function loadTheWindow(){OB.MobileApp.view.currentWindowState='unknown';me.initModels(function(){OB.MobileApp.view.currentWindowState='initModels';initUI(function(){OB.MobileApp.view.currentWindowState='initUI';me.loadModels(function(){OB.MobileApp.view.currentWindowState='loadModels';renderUI(function(){OB.MobileApp.view.currentWindowState='renderUI';});});});});}
this.models.on('ready',function(){loadTheWindow();OB.MobileApp.model.set('isLoggingIn',false);},this);if(!OB.MobileApp.model.get('loggedOffline')){OB.Dal.loadModels(true,me.models,me.data);}else{loadTheWindow();}},load:function(){OB.MobileApp.view.currentWindowState='unknown';var me=this,initIfInit=function(){if(me.init){me.init();}};if(!this.models){this.models=[];}
_.extend(this.models,Backbone.Events);this.models.on('ready',function(){initIfInit();OB.MobileApp.model.set('isLoggingIn',false);this.trigger('windowReady');OB.MobileApp.view.currentWindowState='renderUI';},this);if(!OB.MobileApp.model.get('loggedOffline')){OB.Dal.loadModels(true,me.models,me.data);}else{initIfInit();this.trigger('windowReady');OB.MobileApp.view.currentWindowState='renderUI';}},setAllOff:function(model){var p;if(model.off){model.off();}
if(model.attributes){for(p in model.attributes){if(model.attributes.hasOwnProperty(p)&&model.attributes[p]){this.setAllOff(model);}}}},setOff:function(){if(!this.data){return;}
if(this.data){_.forEach(this.data,function(model){this.setAllOff(model);},this);}
this.data=null;if(this.models){_.forEach(this.models,function(model){if(model.off){model.off();}},this);if(this.models.off){this.models.off();}}
this.models=null;},getData:function(dsName){return this.data[dsName];}});enyo.kind({name:'enyo.g11n.Fmts',getMonthFields:function(){return OB.I18N.getMonthsShortList();},getDateFieldOrder:function(){return OB.I18N.getLabel('OBMOBC_Date_enyo_date_order');},getTimeFieldOrder:function(){return OB.I18N.getLabel('OBMOBC_Date_enyo_time_order');}});enyo.kind({name:'OB.UI.Terminal',events:{onDestroyMenu:''},published:{scanning:false},classes:'pos-container',style:'height:700px',components:[{style:'height: 10px;'},{components:[{name:'containerLoading',components:[{classes:'POSLoadingCenteredBox',components:[{name:'containerLoading_label',classes:'POSLoadingPromptLabel'},{classes:'POSLoadingProgressBarImg',components:[{tag:'span',style:'width: 0%',name:'containerLoading_fillingBar',classes:'POSLoadingBarFilling'}]},{classes:'POSLoadingProgressBar',components:[{name:'containerLoading_loadedModels',showing:false,classes:'POSLoadingBarMessage'}]}]}]},{name:'containerLoggingOut',showing:false,components:[{classes:'POSLoadingCenteredBox',components:[{name:'containerLoggingOut_label',classes:'POSLoadingPromptLabel'},{classes:'POSLoadingProgressBarImg',components:[{tag:'span',name:'containerLoggingOut_fillingBar',classes:'POSLoadingBarFilling'}]}]}]},{name:'containerWindow',handlers:{onShowPopup:'showPopupHandler',onHidePopup:'hidePopupHandler'},getRoot:function(){return this.getComponents()[0];},showPopupHandler:function(inSender,inEvent){if(inEvent.popup){this.showPopup(inEvent.popup,inEvent.args);}},showPopup:function(popupName,args){var componentsArray,i;if(OB.MobileApp.view.$[popupName]){OB.MobileApp.view.$[popupName].show(args);return true;}
componentsArray=this.getComponents();for(i=0;i<componentsArray.length;i++){if(componentsArray[i].$[popupName]){componentsArray[i].$[popupName].show(args);break;}}
return true;},hidePopupHandler:function(inSender,inEvent){if(inEvent.popup){this.hidePopup(inEvent.popup,inEvent.args);}},hidePopup:function(popupName,args){var componentsArray,i;if(OB.MobileApp.view.$[popupName]){OB.MobileApp.view.$[popupName].hide(args);return true;}
componentsArray=this.getComponents();for(i=0;i<componentsArray.length;i++){if(componentsArray[i].$[popupName]){componentsArray[i].$[popupName].hide(args);break;}}
return true;}}]},{name:'dialogsContainer'},{name:'alertContainer',components:[{kind:'OB.UTIL.showAlert',name:'alertQueue'}]},{name:'confirmationContainer',getCurrentPopup:function(){var comp=this.getComponents();if(_.isArray(comp)&&comp.length>0){if(comp.length>1){OB.warn('More than 1 component in confirmation container. Returning the first one');}
return comp[0];}else{return null;}}},{kind:'OB.UI.Profile.SessionInfo',name:'profileSessionInfo'},{kind:'OB.UI.Profile.UserInfo',name:'profileUserInfo'},{kind:enyo.Signals,onkeyup:"keypressHandler",onkeydown:"keyDownHandler"},{kind:'OB.Modals.ModalModelsToSynch',name:'modalModelsToSynch'},{kind:'OB.Modals.ModalItemsToSynch',name:'modalItemsToSynch'}],keeperBlur:function(inSender,inEvent){OB.debug('keeperBlur');OB.MobileApp.view.scanningFocus(this.scanMode);},keeperKey:function(k){OB.debug('keeperKey - keyCode: '+k.keyCode+" - keyIdentifier: "+k.keyIdentifier+" - charCode: "+k.charCode+" - which: "+k.which);OB.MobileApp.view.waterfall('onGlobalKeypress',{keyboardEvent:k});},enterEvent:function(k){OB.debug('ENTER event for iOS');OB.MobileApp.view.waterfall('onGlobalKeypress',{keyboardEvent:k,enterEvent:true});},scanningFocus:function(scanMode){var keeper;if(!OB.MobileApp.model.get('useBarcode')){return;}
OB.debug('scanningfocus');if(scanMode!==undefined){this.scanMode=scanMode;}
if(this.scanMode&&navigator.userAgent.match(/iPhone|iPad|iPod/i)){OB.debug('scanningfocus. iOS. Focused');keeper=document.getElementById('_focusKeeper');keeper.disabled=false;keeper.focus();}
if(!this.scanMode){return;}
setTimeout(function(){if(this.scanMode||(document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='SELECT'&&document.activeElement.tagName!=='TEXTAREA')){keeper=document.getElementById('_focusKeeper');keeper.focus();}},500);},keypressHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===17){OB.MobileApp.model.ctrlPressed=false;}
if(keyCode===16){OB.MobileApp.model.shiftPressed=false;}
OB.debug('keypressHandler - keyCode: '+inEvent.keyCode+" - keyIdentifier: "+inEvent.keyIdentifier+" - charCode: "+inEvent.charCode+" - which: "+inEvent.which);if(OB.MobileApp.model.get('useBarcode')&&this.scanMode){return;}
if(inEvent.originator&&(inEvent.originator.hasClass('modal-dialog')||inEvent.originator.hasClass('modal-popup'))){return;}
if(OB.MobileApp.model.get('useBarcode')&&OB.MobileApp.keyPressProcessed){delete OB.MobileApp.keyPressProcessed;}
this.waterfall('onGlobalKeypress',{keyboardEvent:inEvent});},keyDownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;OB.MobileApp.model.ctrlPressed=keyCode===17;OB.MobileApp.model.shiftPressed=keyCode===16;},resizeWindow:function(){var winHeight=window.innerHeight,winWidth=window.innerWidth,percentage,appHeight=700;if(!this.sizeProperties||(this.sizeProperties.x!==winWidth&&this.sizeProperties.y!==winHeight)){this.waterfall('onDestroyMenu');this.sizeProperties={x:window.innerWidth,y:window.innerHeight};percentage=window.innerHeight*100/appHeight;percentage=Math.floor(percentage)/100;document.body.style.zoom=percentage;this.render();}},rendered:function(){var keeper;this.inherited(arguments);window.oncontextmenu=function(){if(!OB.UTIL.Debug.isDebug()){return false;}};keeper=document.getElementById('_focusKeeper');if(!keeper){keeper=document.createElement('input');keeper.setAttribute('id','_focusKeeper');keeper.setAttribute('style','position: fixed; top: -100px; left: -100px;');keeper.setAttribute('onblur','OB.MobileApp.view.keeperBlur()');document.body.onkeydown=function(k){if((k.keyCode===37&&k.altKey)||(k.keyCode===39&&k.altKey)||(k.keyCode===8&&((k.srcElement.tagName!=='INPUT'&&k.srcElement.tagName!=='TEXTAREA')||k.srcElement.id==='_focusKeeper'))||(k.keyCode===8&&k.shiftKey)){return false;}};if(OB.UTIL.isIOS()){keeper.addEventListener('keypress',function(k){OB.debug('init timeout');if(OB.testtimeoutid){OB.debug('timeout cleared');clearTimeout(OB.testtimeoutid);}
OB.testtimeoutid=setTimeout(function(){OB.debug('timeout happened');OB.MobileApp.view.enterEvent(k);},400);});}
keeper.addEventListener('keyup',function(k){OB.debug('keyup happened: which:'+k.which);if(OB.UTIL.isIOS()&&(k.keyCode===13||k.which===13)){return;}
OB.MobileApp.view.keeperKey(k);});document.body.appendChild(keeper);}
this.scanningFocus();},initComponents:function(){window.OB.MobileApp=OB.MobileApp||{};window.OB.MobileApp.view=this;window.OB.MobileApp.view.currentWindow='initializing';window.OB.MobileApp.view.currentWindowState='unknown';var args=arguments,initialized=false;this.terminal.on('initializedCommonComponents',function(){var me=this;if(!initialized){this.inherited(args);initialized=true;this.terminal.on('change:context',function(){var ctx=this.terminal.get('context');if(!ctx){return;}
if(this.$.dialogsContainer.$.profileDialog){this.$.dialogsContainer.$.profileDialog.destroy();}
if(OB.UI.ModalProfile){this.$.dialogsContainer.createComponent({kind:'OB.UI.ModalProfile',name:'profileDialog'});}},this);this.terminal.on('change:connectedToERP',function(model){if(model.get('loggedOffline')!==undefined){if(model.get('connectedToERP')){var rr,ajaxRequest2=new enyo.Ajax({url:'../../org.openbravo.mobile.core.context',cacheBust:false,method:'GET',handleAs:'json',timeout:20000,data:{ignoreForConnectionStatus:true},contentType:'application/json;charset=utf-8',success:function(inSender,inResponse){if(inResponse&&!inResponse.exception){OB.info('Connection came back. Session still valid, so no action required');OB.MobileApp.model.returnToOnline();}else{if(model.get('supportsOffline')){if(!model.get('reloginMessageShown')){OB.warn('Connection came back. Session no longer valid, so relogin required');model.set('reloginMessageShown',true);}
OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Online'),OB.I18N.getLabel('OBMOBC_OnlineConnectionHasReturned'),[{label:OB.I18N.getLabel('OBMOBC_LblLoginAgain'),action:function(){OB.MobileApp.model.lock();OB.UTIL.showLoading(true);}}],{autoDismiss:false,onHideFunction:function(){OB.MobileApp.model.lock();OB.UTIL.showLoading(true);}});}else{OB.MobileApp.model.triggerLogout();}}},fail:function(inSender,inResponse){}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest2});rr.exec(ajaxRequest2.url);}else{if(model.get('supportsOffline')){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_OfflineModeWarning'));}}}},this);this.terminal.on('change:terminal change:bplocation change:location change:pricelist change:pricelistversion',function(){var name='';var clientname='';var orgname='';var pricelistname='';var currencyname='';var locationname='';if(this.terminal.get('terminal')){name=this.terminal.get('terminal')._identifier;clientname=this.terminal.get('terminal')['client'+OB.Constants.FIELDSEPARATOR+'_identifier'];orgname=this.terminal.get('terminal')['organization'+OB.Constants.FIELDSEPARATOR+'_identifier'];}
if(this.terminal.get('pricelist')){pricelistname=this.terminal.get('pricelist')._identifier;currencyname=this.terminal.get('pricelist')['currency'+OB.Constants.FIELDSEPARATOR+'_identifier'];}
if(this.terminal.get('location')){locationname=this.terminal.get('location')._identifier;}},this);}
this.$.dialogsContainer.destroyComponents();if(OB.UI.ModalLogout){this.$.dialogsContainer.createComponent({kind:'OB.UI.ModalLogout',name:'logoutDialog'});}
this.render();this.resizeWindow();window.OB.MobileApp.view.currentWindowState='renderUI';window.onresize=function(){me.resizeWindow();};},this);}});OB.Model=window.OB.Model||{};(function(){OB.Model.RouterHelper=Backbone.Router.extend({terminal:null,initialize:function(associatedTerminal){if(!associatedTerminal){OB.UTIL.Debug.execute(function(){throw"The router needs to be associated to a terminal";});return;}
this.terminal=associatedTerminal;},routes:{'':'root','login':'login','*route':'any'},any:function(route){if(route){OB.MobileApp.model.set('defaultWindow',route);}
this.terminal.navigate('');},root:function(){if(!OB.MobileApp.view){OB.UTIL.Debug.execute(function(){throw"OB.MobileApp.view must be defined before navigating";});return;}
this.terminal.initializeCommonComponents();},login:function(){this.terminal.renderLogin();},renderGenericWindow:function(windowName,params){this.terminal.renderGenericWindow(windowName,params);}});}());OB.Model=window.OB.Model||{};OB.MobileApp=OB.MobileApp||{};OB.Data=OB.Data||{};OB.MobileApp.windowRegistry=new(Backbone.Model.extend({registeredWindows:[],registerWindow:function(window){this.registeredWindows.push(window);}}))();OB.Model.Collection=Backbone.Collection.extend({constructor:function(data){this.ds=data.ds;Backbone.Collection.prototype.constructor.call(this);},inithandler:function(init){if(init){init.call(this);}},exec:function(filter){var me=this;if(this.ds){this.ds.exec(filter,function(data,info){var i;me.reset();me.trigger('info',info);if(data.exception){OB.UTIL.showError(data.exception.message);}else{for(i in data){if(data.hasOwnProperty(i)){me.add(data[i]);}}}});}}});OB.Model.Terminal=Backbone.Model.extend({defaults:{terminal:null,context:null,permissions:null,businesspartner:null,location:null,pricelist:null,pricelistversion:null,currency:null,connectedToERP:null,loginUtilsUrl:'../../org.openbravo.mobile.core.loginutils',loginUtilsParams:{},supportsOffline:false,loginHandlerUrl:'../../org.openbravo.mobile.core/LoginHandler',applicationFormatUrl:'../../org.openbravo.mobile.core/OBCLKER_Kernel/Application',logConfiguration:{deviceIdentifier:'',logPropertiesExtension:[]},windows:null,appName:'OBMOBC',appDisplayName:'Openbravo Mobile',useBarcode:false,profileOptions:{showOrganization:true,showWarehouse:true,defaultProperties:{role:null,organization:null,warehouse:null,languagage:null}},localDB:{size:OB.UTIL.VersionManagement.current.mobileCore.WebSQLDatabase.size,name:OB.UTIL.VersionManagement.current.mobileCore.WebSQLDatabase.name,displayName:OB.UTIL.VersionManagement.current.mobileCore.WebSQLDatabase.displayName,version:OB.UTIL.VersionManagement.current.mobileCore.WebSQLDatabase.dbversion},propertiesLoaders:[],dataSyncModels:[],emptyModels:0},initialize:function(){var me=this;window.OB.MobileApp=OB.MobileApp||{};window.OB.MobileApp.model=this;OB.Dal.openWebSQL();OB.UTIL.HookManager.executeHooks('OBMOBC_InitActions',{},function(args){if(args&&args.cancelOperation&&args.cancelOperation===true){return;}else{me.initActions(function(){});}});this.router=new OB.Model.RouterHelper(this);this.windowRegistry=OB.MobileApp.windowRegistry;OB.UTIL.VersionManagement.deprecated(27349,function(){this.hookManager=OB.UTIL.HookManager;},function(deprecationMessage){this.hookManager={registerHook:function(qualifier,func){OB.warn(deprecationMessage+". Hook: '"+qualifier+"'");OB.UTIL.HookManager.registerHook(qualifier,func);},executeHooks:function(qualifier,args,callback){OB.warn(deprecationMessage+". Hook: '"+qualifier+"'");OB.UTIL.HookManager.executeHooks(qualifier,args,callback);},callbackExecutor:function(args,callback){OB.warn(deprecationMessage);OB.UTIL.HookManager.callbackExecutor(args,callback);}};},this);this.on('window:ready',this.renderContainerWindow);this.on('terminalInfoLoaded',function(){OB.debug("next process: processPropertyLoaders");window.localStorage.setItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'),true);this.processPropertyLoaders();});this.on('propertiesLoadersReady',function(){OB.debug("next process: loadRegisteredWindows, renderMain, postLoginActions");OB.UTIL.completeLoadingStep();this.loadRegisteredWindows();this.renderMain();this.postLoginActions();},this);var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('rootWindow');window.addEventListener('load',function(e){setTimeout(function(){Backbone.history.start({root:'',pushState:false});OB.UTIL.SynchronizationHelper.finished(synchId,'rootWindow');},0);},false);},loadingErrorsActions:function(caller){OB.UTIL.Debug.execute(function(){if(!caller){throw"missing parameter: caller";}});OB.MobileApp.model.loadingErrorsActions.executed=true;var link='NA';try{var errorobj=new Error();link=OB.UTIL.getStackLink(3);}catch(ex){console.error("executeSqlErrorHandler.getStackLink: "+ex);}
console.error("loadingErrorsActions: '"+caller+"' failed while loading the application. line: "+link);},cleanTerminalData:function(){_.each(this.get('propertiesLoaders'),function(curPropertiesToLoadProcess){_.each(curPropertiesToLoadProcess.properties,function(curProperty){this.set(curProperty,null);},this);},this);},returnToOnline:function(){OB.info('The system has come back to online');},addPropertiesLoader:function(obj){this.get('propertiesLoaders').push(obj);this.syncAllPropertiesLoaded=_.after(this.get('propertiesLoaders').length,this.allPropertiesLoaded);},handlePropertiesLoader:function(properties,source,params,successCallback){function handleError(){var msg=OB.I18N.getLabel('OBMOBC_TerminalPropertiesErrorBody',[properties.join(', ')])+OB.I18N.getLabel('OBMOBC_LoadingErrorBody'),isErrorPopupShown=OB.MobileApp.view.$.confirmationContainer.getCurrentPopup()&&OB.MobileApp.view.$.confirmationContainer.getCurrentPopup().getShowing();if(OB.MobileApp.model.get('isLoggingIn')===true&&!isErrorPopupShown){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_TerminalPropertiesErrorHeader'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();OB.MobileApp.view.$.containerWindow.destroyComponents();},autoDismiss:false});}}
new OB.DS.Request(source).exec(params,function(data){if(data.exception){handleError();}else{if(typeof successCallback==='function'){successCallback(data);}}},function(data){handleError();});},propertiesReady:function(properties){OB.info("[sdrefresh] '"+properties+"' property loaded");this.syncAllPropertiesLoaded();},processPropertyLoaders:function(){OB.debug("next process: allPropertiesLoaded");var termInfo,msg,key;if(this.get('loggedOffline')){if(this.usermodel.get('terminalinfo')){termInfo=JSON.parse(this.usermodel.get('terminalinfo'));for(key in termInfo){if(termInfo.hasOwnProperty(key)){this.set(key,termInfo[key]);}}
this.set('loggedOffline',true);this.set('connectedToERP',false);OB.MobileApp.model.saveDocumentSequence();this.set('logConfiguration',{deviceIdentifier:window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"),logPropertiesExtension:[function(){return{isOnline:OB.MobileApp.model.get('connectedToERP')};}]});_.each(this.get('dataSyncModels'),function(item){item.model=eval(item.modelFunc);});this.set('connectedToERP',false);this.set('loggedOffline',true);this.allPropertiesLoaded();}else{OB.MobileApp.model.loadingErrorsActions('processPropertyLoaders: not enough data in cache');msg=OB.I18N.getLabel('OBMOBC_NotEnoughDataInCache')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_TerminalPropertiesErrorHeader'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();},autoDismiss:false});}
return;}
this.set('loggedOffline',false);OB.info("[terminal] Starting to load properties based on properties loaders, count: "+this.get('propertiesLoaders').length);OB.UTIL.completeLoadingStep();OB.UTIL.showLoadingMessage(OB.I18N.getLabel('OBMOBC_LoadingTerminalProps'));if(this.get('propertiesLoaders')&&this.get('propertiesLoaders').length>0){_.each(this.get('propertiesLoaders'),function(curProperty){curProperty.loadFunction(this);},this);}else{this.allPropertiesLoaded();}},allPropertiesLoaded:function(){OB.debug("next process: propertiesLoadersReady");this.loggingIn=false;if(!OB.MobileApp.model.get('datasourceLoadFailed')){OB.info('[terminal] Properties have been successfully loaded');if(!this.get('loggedOffline')){this.usermodel.set('terminalinfo',JSON.stringify(this));OB.Dal.save(this.usermodel,function(){},function(){OB.error("allPropertiesLoaded",arguments);});}
this.trigger('propertiesLoadersReady');}},navigate:function(route){OB.debug("Navigating to '"+route+"'");this.router.navigate(route,{trigger:true,replace:true});},renderTerminalMain:function(){OB.debug("next process: databaseInitialization");OB.UTIL.Debug.execute(function(){if(!this.renderMain){throw"There is no renderMain method in Terminal Model";}},this);this.databaseInitialization();},checkAllPermissions:function(permissions){var i;for(i in permissions){if(permissions.hasOwnProperty(i)){if(this.get('permissions')){if(permissions[i]!==this.get('permissions')[i]){return true;}}}}
return false;},databaseInitialization:function(){OB.debug("next process: loadTerminalInfo");if(window.openDatabase){this.initLocalDB();}else{this.loadTerminalInfo();}},loadTerminalInfo:function(){OB.debug("next process: terminalInfoLoaded");OB.UTIL.completeLoadingStep();OB.UTIL.showLoadingMessage(OB.I18N.getLabel('OBMOBC_LoadingTerminalInfo'));var me=this,loadTerminalInfoQueue={};function triggerLoadTerminalInfoReady(){OB.debug("triggerLoadTerminalInfoReady: "+(OB.UTIL.queueStatus(loadTerminalInfoQueue)===true));if(OB.UTIL.queueStatus(loadTerminalInfoQueue)){me.setUserModelOnline(function(){me.trigger('terminalInfoLoaded');});}}
if(OB.MobileApp.model.get('loggedOffline')){OB.Format=JSON.parse(window.localStorage.getItem('AppFormat'));OB.I18N.labels=JSON.parse(window.localStorage.getItem('I18NLabels_'+window.localStorage.getItem('languageForUser_'+me.usermodel.get('id'))));triggerLoadTerminalInfoReady();return;}
loadTerminalInfoQueue.preferences=false;new OB.DS.Request('org.openbravo.mobile.core.login.RolePermissions').exec({appModuleId:this.get('appModuleId')},function(data){var i,max,separator,permissions={};if(data){for(i=0,max=data.length;i<max;i++){permissions[data[i].key]=data[i].value;separator=data[i].key.indexOf('_');if(separator>=0){permissions[data[i].key.substring(separator+1)]=data[i].value;}}
me.set('permissions',permissions);loadTerminalInfoQueue.preferences=true;triggerLoadTerminalInfoReady();}},function(data){var msg=OB.I18N.getLabel('OBMOBC_PermissionsErrorBody')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');if(OB.MobileApp.model.get('isLoggingIn')===true){OB.UTIL.showConfirmation.display('Error loading terminal properties',msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();},autoDismiss:false});}});loadTerminalInfoQueue.application=false;var rr,ajaxRequest=new enyo.Ajax({url:this.get('applicationFormatUrl'),method:'GET',handleAs:'text',success:function(inSender,inResponse){var realOB=OB;eval(inResponse);window.OB.Application=OB.Application;window.OB.Format=OB.Format;window.localStorage.setItem('AppFormat',JSON.stringify(OB.Format));window.OB.Constants=OB.Constants;loadTerminalInfoQueue.application=true;triggerLoadTerminalInfoReady();}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);},isSafeToResetDatabase:function(callbackIsSafe,callbackIsNotSafe){callbackIsSafe();},databaseCannotBeResetAction:function(){},initLocalDB:function(){OB.Dal.openWebSQL();function dropTable(modelObj){return new Promise(function(resolve,reject){function dropTableFunction(modelObj){OB.Dal.dropTable(modelObj,function(){var modelName=modelObj.prototype.modelName;var modelChecksum=OB.Data.getModelStructureChecksum(modelObj);if(window.localStorage.getItem('lastUpdatedTimestamp'+modelName)){window.localStorage.removeItem('lastUpdatedTimestamp'+modelName);window.localStorage.removeItem('POSLastTotalRefresh');window.localStorage.removeItem('POSLastIncRefresh');}
OB.Dal.initCache(modelObj,[],function(){OB.debug('Set model '+modelName+" checksum to "+modelChecksum);window.localStorage.setItem('structureChecksum-'+modelName,modelChecksum);resolve();},function(){OB.error("Couldn't initialize table for model: "+modelName);resolve();});},function(){OB.error(OB.UTIL.argumentsToStringifyed("dropTable",arguments));reject();});}
var syncModel=OB.MobileApp.model.getSyncModel(modelObj);if(syncModel){OB.MobileApp.model.syncModelHasData(syncModel,function(){OB.MobileApp.model.syncAllModels(function(){dropTableFunction(modelObj);},OB.MobileApp.model.databaseCannotBeResetAction);},function(){dropTableFunction(modelObj);});}else{dropTableFunction(modelObj);}});}
if(window.localStorage.getItem('loggedTerminalName')&&(window.localStorage.getItem('loggedTerminalName')!==OB.MobileApp.model.get('terminalName'))){console.warn(OB.UTIL.argumentsToStringifyed("terminal changed ("+window.localStorage.getItem('loggedTerminalName')+" -> "+OB.MobileApp.model.get('terminalName')+")"));OB.info('Terminal has been changed. Resetting database and local storage information.');window.localStorage.clear();window.localStorage.setItem('terminalName',OB.MobileApp.model.get('terminalName'));OB.MobileApp.model.logout();return;}
var tablesToDrop=[];OB.info('Checking database models...');_.each(OB.Model,function(model){if(!model.prototype||!model.prototype.modelName){return;}
var modelName=model.prototype.modelName;var modelChecksum=OB.Data.getModelStructureChecksum(model);if(modelChecksum===''){return;}
if(window.localStorage.getItem('structureChecksum-'+modelName)!==modelChecksum){if(!window.localStorage.getItem('structureChecksum-'+modelName)){OB.debug("Model '"+modelName+"' should not exists because there isn't a paired entry in the localStorage. Performning preemptive table dropping...");}else{OB.info("Model '"+modelName+"' changed. Rebuilding...");}
tablesToDrop.push(dropTable(model));}});if(tablesToDrop.length===0){OB.info('No models changed.');OB.MobileApp.model.loadTerminalInfo();return;}
var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('dropTables');Promise.all(tablesToDrop).then(function(){OB.UTIL.SynchronizationHelper.finished(synchId,'dropTables');OB.MobileApp.model.loadTerminalInfo();},function(){OB.UTIL.SynchronizationHelper.finished(synchId,'dropTables');OB.MobileApp.model.loadingErrorsActions('initLocalDB.dropTalbles');});},initActions:function(callback){var params={},me=this;var cacheSessionId=null;if(window.localStorage.getItem('cacheSessionId')&&window.localStorage.getItem('cacheSessionId').length===32){cacheSessionId=window.localStorage.getItem('cacheSessionId');}
params.cacheSessionId=cacheSessionId;params.command='initActions';new OB.OBPOSLogin.UI.LoginRequest({url:'../../org.openbravo.mobile.core.loginutils'}).response(this,function(inSender,inResponse){if(!(window.localStorage.getItem('cacheSessionId')&&window.localStorage.getItem('cacheSessionId').length===32)){window.localStorage.setItem('cacheSessionId',inResponse.cacheSessionId);}
if(inResponse.servers){localStorage.servers=JSON.stringify(inResponse.servers);}
if(inResponse.services){localStorage.services=JSON.stringify(inResponse.services);}
OB.RR.RequestRouter.initialize();if(callback){callback();}}).error(function(){if(callback){callback();}}).go(params);},preLoadContext:function(callback){callback();},getSyncModel:function(dataModel){var theSyncModel=null;_.each(this.get('dataSyncModels'),function(syncModel){if(syncModel.model===dataModel){theSyncModel=syncModel;}});return theSyncModel;},syncModelHasData:function(modelObj,hasDataCallback,doesntHaveDataCallback){var criteria=modelObj.changesPendingCriteria?modelObj.changesPendingCriteria:(modelObj.criteria?modelObj.criteria:null);var modelObject=modelObj;if(modelObj.model){modelObject=modelObj.model;}
if(criteria){criteria._limit=-1;}
OB.Dal.find(modelObject,criteria,function(dataToSync){if(dataToSync.length===0){if(doesntHaveDataCallback){doesntHaveDataCallback(modelObject);}}else{if(hasDataCallback){hasDataCallback(modelObject,dataToSync);}}},function(){if(doesntHaveDataCallback){doesntHaveDataCallback(modelObject);}},{doNotShowErrors:true});},getSyncModelsWithHasData:function(){return new Promise(function(resolve,reject){var syncModelsWithHasData=[];var promisesOfModelsToVerify=[];_.each(OB.Model,function(model){if(!model.prototype||!model.prototype.modelName){return;}
var modelName=model.prototype.modelName;var modelChecksum=OB.Data.getModelStructureChecksum(model);if(modelChecksum===''){return;}
var promiseOfModelToVerify=new Promise(function(resolve,reject){var syncModel=OB.MobileApp.model.getSyncModel(model);if(syncModel){var callbackHasData=function(){syncModelsWithHasData.push({model:model,hasData:true});resolve();};var callbackNoData=function(){syncModelsWithHasData.push({model:model,hasData:false});resolve();};OB.MobileApp.model.syncModelHasData(syncModel,callbackHasData,callbackNoData);}else{resolve();}});promisesOfModelsToVerify.push(promiseOfModelToVerify);});Promise.all(promisesOfModelsToVerify).then(function(){resolve(syncModelsWithHasData);},function(){OB.error("Could not gather information about the models");reject();});});},syncModelQueue:null,syncModel:function(){var me=this;if(me.syncModelQueue.length===0){if(OB.MobileApp.model.get('dataSyncModels').length===me.get('emptyModels')){me.syncModelExecuteSuccessCallbacks();}
me.set('emptyModels',0);return;}
var modelObj=me.syncModelQueue.shift();var model=modelObj.model;var criteria;if(modelObj.criteria){criteria=modelObj.criteria;}else{criteria={hasBeenProcessed:'Y'};}
criteria._limit=-1;OB.Dal.find(model,criteria,function(dataToSync){me.skipSyncModel=dataToSync.length===0;if(modelObj.preSendModel){modelObj.preSendModel(me,dataToSync);}
if(me.skipSyncModel){me.skipSyncModel=false;me.set('emptyModels',me.get('emptyModels')+1);me.syncModel();return;}
var className=modelObj.className;if(model===OB.Model.ChangedBusinessPartners&&OB.UTIL.processCustomerClass){className=OB.UTIL.processCustomerClass;}else if(model===OB.Model.Order&&OB.UTIL.processOrderClass){className=OB.UTIL.processOrderClass;}
var modelIndex=0;var modelNotFullySynced=false;var newDataToSync=new Backbone.Collection();while(modelIndex<dataToSync.length){newDataToSync.add(dataToSync.at(modelIndex));modelIndex++;if(modelIndex>=100&&modelIndex<dataToSync.length){modelNotFullySynced=true;me.syncModelQueue.unshift(modelObj);break;}}
var dataToSend=[];newDataToSync.each(function(record){if(record.get('json')){dataToSend.push(JSON.parse(record.get('json')));}else if(!_.isUndefined(record.get('objToSend'))){if(!_.isNull(record.get('objToSend'))){dataToSend.push(JSON.parse(record.get('objToSend')));}}else{dataToSend.push(record);}});var proc=new OB.DS.Process(className);var timeout=modelObj.timeout||20000;var timePerRecord=modelObj.timePerRecord||1000;proc.exec({messageId:OB.UTIL.get_UUID(),data:dataToSend},function(data,message){if(data&&data.exception){OB.warn("The model '"+OB.Dal.getTableName(model)+"'' has not been synchronized with the server");if(data.exception.invalidPermission&&!me.get('displayedInvalidPermission')){me.set('displayedInvalidPermission',true);OB.UTIL.showConfirmation.display('Info',OB.I18N.getLabel('OBMOBC_NoPermissionToSyncModel',[OB.Dal.getTableName(model),OB.Dal.getTableName(model)]),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){}}]);}
me.syncModelExecuteErrorCallbacks();return;}
var removeSyncedElemsCallback=function(){OB.info("Purging the '"+OB.Dal.getTableName(model)+"' table");var promises=[];newDataToSync.each(function(record){promises.push(new Promise(function(resolve,reject){if(modelObj.isPersistent){OB.Dal.updateRecordColumn(record,"isbeingprocessed","Y",function(){resolve();},function(tx,err){reject();});}else{OB.Dal.remove(record,function(){resolve();},function(tx,err){OB.UTIL.showError(err);reject();});}}));});Promise.all(promises).then(function(){if(modelNotFullySynced){OB.info(newDataToSync.length+" records of the table '"+OB.Dal.getTableName(model)+"' have been successfully synchronized with the server. "+(dataToSync.length-newDataToSync.length)+" records remaining to be synchronized.");me.syncModel();return;}
OB.info("The table '"+OB.Dal.getTableName(model)+"' has been fully synchronized with the server");if(OB.MobileApp.model.syncModelQueue.length===0){OB.MobileApp.model.syncModelExecuteSuccessCallbacks();}}).catch(function(err){OB.error("Could not purge the '"+OB.Dal.getTableName(model)+"' table. Error message: "+err);});me.syncModel();};if(modelObj.postProcessingFunction){modelObj.postProcessingFunction(newDataToSync,removeSyncedElemsCallback);}else{removeSyncedElemsCallback();}},function(){OB.warn("Error while synchronizing model '"+OB.Dal.getTableName(model)+"'");me.syncModelExecuteErrorCallbacks();},null,timeout+timePerRecord*newDataToSync.length);},function(){me.syncModel();},{doNotShowErrors:true});},syncModelSuccessCallbacks:[],syncModelErrorCallbacks:[],syncModelExecuteSuccessCallbacks:function(){OB.UTIL.Debug.execute(function(){if(OB.MobileApp.model.syncModelQueue&&OB.MobileApp.model.syncModelQueue.length>0){throw"The 'syncModelQueue' should be empty at this point";}});OB.MobileApp.model.syncModelQueue=[];OB.MobileApp.model.syncModelErrorCallbacks=[];OB.UTIL.executeCallbackQueue(OB.MobileApp.model.syncModelSuccessCallbacks);},syncModelExecuteErrorCallbacks:function(){OB.MobileApp.model.syncModelQueue=[];OB.MobileApp.model.syncModelSuccessCallbacks=[];OB.UTIL.executeCallbackQueue(OB.MobileApp.model.syncModelErrorCallbacks);},syncAllModels:function(successCallback,errorCallback){var me=this;if(!OB.MobileApp.model.isUserAuthenticated()){OB.UTIL.Debug.execute(function(){console.warn("'OB.MobileApp.model.syncAllModels' cannot be executed because it requires an autheticated user");});if(errorCallback){errorCallback();}
return;}
if(!me.get('dataSyncModels')||me.get('dataSyncModels').length===0){if(successCallback){successCallback();}
return;}
me.syncModelSuccessCallbacks.push(successCallback);me.syncModelErrorCallbacks.push(errorCallback);var isCurrentlySynchronizing=me.syncModelQueue&&me.syncModelQueue.length>0;me.syncModelQueue=[];var i;for(i=0;i<this.get('dataSyncModels').length;i++){var modelObj=this.get('dataSyncModels')[i];me.syncModelQueue.push(modelObj);}
if(!isCurrentlySynchronizing){me.syncModel(this.syncModelExecuteSuccessCallbacks,this.syncModelExecuteErrorCallbacks);}},isUserAuthenticated:function(){return!!OB.MobileApp.model.get('context');},isUserCacheAvailable:function(){return false;},initializeCommonComponents:function(){OB.debug("next process: navigate 'login' or renderTerminalMain or loginUsingCache");var me=this,params={};window.localStorage.setItem('LOGINTIMER',new Date().getTime());params=this.get('loginUtilsParams')||{};params.command='preRenderActions';var rr,ajaxRequest=new enyo.Ajax({url:this.get('loginUtilsUrl'),cacheBust:false,timeout:5000,method:'GET',handleAs:'json',contentType:'application/json;charset=utf-8',data:params,success:function(inSender,inResponse){OB.appCaption=inResponse.appCaption;if(_.isEmpty(inResponse.labels)||_.isNull(inResponse.labels)||_.isUndefined(inResponse.labels)){OB.I18N.labels=JSON.parse(window.localStorage.getItem('I18NLabels'));}else{OB.I18N.labels=inResponse.labels;if(inResponse.activeSession){window.localStorage.setItem('languageForUser_'+inResponse.labels.userId,inResponse.labels.languageId);window.localStorage.setItem('I18NLabels',JSON.stringify(OB.I18N.labels));window.localStorage.setItem('I18NLabels_'+inResponse.labels.languageId,JSON.stringify(OB.I18N.labels));}}
if(_.isEmpty(inResponse.dateFormats)||_.isNull(inResponse.dateFormats)||_.isUndefined(inResponse.dateFormats)){OB.Format=JSON.parse(window.localStorage.getItem('AppFormat'));}else{OB.Format=inResponse.dateFormats;}
me.trigger('initializedCommonComponents');me.preLoadContext(function(){var rr2,ajaxRequest2=new enyo.Ajax({url:'../../org.openbravo.mobile.core.context',cacheBust:false,method:'GET',handleAs:'json',timeout:20000,data:{ignoreForConnectionStatus:true},contentType:'application/json;charset=utf-8',success:function(inSender,inResponse){OB.MobileApp.model.triggerOnLine();if(inResponse&&inResponse.data){OB.MobileApp.model.set('isLoggingIn',true);OB.MobileApp.model.set('orgUserId',inResponse.data[0].user.id);me.set('context',inResponse.data[0]);OB.UTIL.startLoadingSteps();me.renderTerminalMain();}else if(inResponse&&inResponse.exception){OB.MobileApp.model.navigate('login');}else{var msg=OB.I18N.getLabel('OBMOBC_ContextErrorBody')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();OB.MobileApp.view.$.containerWindow.destroyComponents();},autoDismiss:false});}},fail:function(inSender,inResponse){var msg=OB.I18N.getLabel('OBMOBC_ContextErrorBody')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();OB.MobileApp.view.$.containerWindow.destroyComponents();},autoDismiss:false});}});rr2=new OB.RR.Request({ajaxRequest:ajaxRequest2});rr2.exec(ajaxRequest2.url);});},fail:function(inSender,inResponse){if(this.alreadyProcessed){return;}
this.alreadyProcessed=true;OB.I18N.labels=JSON.parse(window.localStorage.getItem('I18NLabels'));OB.Format=JSON.parse(window.localStorage.getItem('AppFormat'));me.trigger('initializedCommonComponents');if(!OB.I18N.labels||!OB.Format){OB.UTIL.showLoading(false);var errorMsg="The server is not available and the cache has not enough data. Connect to the server and try again.";OB.error("initializeCommonComponents",errorMsg);OB.UTIL.showConfirmation.display('Error',errorMsg,[{label:'Retry',isConfirmButton:true,action:function(){me.initializeCommonComponents();}}],{onHideFunction:function(){me.initializeCommonComponents();}});return;}
OB.MobileApp.model.navigate('login');}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);},renderLogin:function(){if(!OB.MobileApp.view){OB.UTIL.Debug.execute(function(){throw"OB.MobileApp.view must be defined";});OB.MobileApp.model.navigate('');return;}
if(!OB.MobileApp.view.$.containerWindow){OB.MobileApp.model.navigate('');return;}
if(OB.Data.localDB){OB.Dal.initCache(OB.Model.LogClient,[],null,null);}
OB.MobileApp.view.$.containerWindow.destroyComponents();OB.MobileApp.view.$.containerWindow.createComponent({kind:OB.OBPOSLogin.UI.Login}).render();OB.UTIL.showLoading(false);},loadModels:function(windowv,incremental){var windows,i,windowName,windowClass,datasources,timestamp=0,w,c,path;if(OB.MobileApp.model.get('loggedOffline')){return;}
if(windowv){windows=[windowv];}else{windows=[];_.each(this.windowRegistry.registeredWindows,function(windowp){windows.push(windowp);});}
OB.info('[sdrefresh] Load models '+(incremental?'incrementally':'full')+'.');for(i=0;i<windows.length;i++){windowClass=windows[i].windowClass;windowName=windows[i].route;if(OB&&OB.DATA&&OB.DATA[windowName]){datasources=OB.DATA[windowName];}else if(windowClass.prototype&&windowClass.prototype.windowmodel&&windowClass.prototype.windowmodel.prototype&&windowClass.prototype.windowmodel.prototype.models){datasources=windowClass.prototype.windowmodel.prototype.models;}else if(typeof windowClass==='string'){w=window;path=windowClass.split('.');for(c=0;c<path.length;c++){w=w[path[c]];}
if(w.prototype&&w.prototype.windowmodel&&w.prototype.windowmodel.prototype&&w.prototype.windowmodel.prototype.models){datasources=w.prototype.windowmodel.prototype.models;}}
_.extend(datasources,Backbone.Events);OB.debug('[sdrefresh] window: '+windowName);OB.Dal.loadModels(false,datasources,null,incremental);this.postLoadModels();}},postLoadModels:function(){},cleanWindows:function(){this.windows=new(Backbone.Collection.extend({comparator:function(window){var position=window.get('menuPosition');return position?position:0;}}))();},registerWindow:function(window){this.windowRegistry.registerWindow(window);},loadRegisteredWindows:function(){OB.debug("next process: renderMain");this.cleanWindows();setInterval(OB.UTIL.processLogClientAll,30000);var countOfLoadedWindows=0;_.each(this.windowRegistry.registeredWindows,function(windowp){var datasources=[],windowClass,windowName=windowp.route,minTotalRefresh,minIncRefresh,lastTotalRefresh,lastIncRefresh,intervalTotal,intervalInc,now,terminalType;this.windows.add(windowp);terminalType=OB.MobileApp.model.get('terminal')&&OB.MobileApp.model.get('terminal').terminalType;if(terminalType){minTotalRefresh=OB.MobileApp.model.get('terminal').terminalType.minutestorefreshdatatotal*60*1000;minIncRefresh=OB.MobileApp.model.get('terminal').terminalType.minutestorefreshdatainc*60*1000;lastTotalRefresh=window.localStorage.getItem('POSLastTotalRefresh');lastIncRefresh=window.localStorage.getItem('POSLastIncRefresh');}
if((!minTotalRefresh&&!minIncRefresh)||(!lastTotalRefresh&&!lastIncRefresh)){this.loadModels(windowp,false);}else{now=new Date().getTime();intervalTotal=lastTotalRefresh?(now-lastTotalRefresh-minTotalRefresh):0;intervalInc=lastIncRefresh?(now-lastIncRefresh-minIncRefresh):0;if(intervalTotal>0){this.set('FullRefreshWasDone',true);this.loadModels(windowp,false);}}
this.router.route(windowName,windowName,function(){this.renderGenericWindow(windowName);});this.router.route(windowName+"/:params",windowName,function(params){this.renderGenericWindow(windowName,params);});countOfLoadedWindows+=1;},this);var countOfRegisteredWindows=this.windowRegistry.registeredWindows.length;console.assert(countOfRegisteredWindows===countOfLoadedWindows,'DEVELOPER: There are '+countOfRegisteredWindows+' registered windows but '+countOfLoadedWindows+' are being loaded');},isWindowOnline:function(route){var i,windows;windows=this.windows.toArray();for(i=0;i<windows.length;i++){if(windows[i].get('route')===route){return windows[i].get('online');}}
return false;},renderGenericWindow:function(windowName,params){if(!OB.MobileApp.view.$.containerWindow){OB.UTIL.Debug.execute(function(){console.error("OB.MobileApp.view.$.containerWindow must be defined");});OB.MobileApp.model.loadingErrorsActions('renderGenericWindow I');return;}
OB.MobileApp.view.currentWindow='unknown';OB.MobileApp.view.currentWindowState='unknown';OB.UTIL.showLoading(true);var windowObject=this.windows.where({route:windowName})[0];var windowClass=windowObject.get('windowClass');OB.MobileApp.view.$.containerWindow.destroyComponents();OB.MobileApp.view.$.containerWindow.createComponent({kind:windowClass,params:params});OB.MobileApp.view.currentWindow=windowName;},renderContainerWindow:function(){OB.MobileApp.view.$.containerWindow.render();OB.UTIL.showLoading(false);OB.MobileApp.view.$.containerWindow.resized();},updateSession:function(user,callback){OB.UTIL.Debug.execute(function(){if(!callback){throw"This method requires a callback";}});OB.Dal.find(OB.Model.Session,{'user':user.get('id')},function(sessions){var session;if(sessions.models.length===0){session=new OB.Model.Session();session.set('user',user.get('id'));session.set('terminal',OB.MobileApp.model.get('terminalName'));}else{session=sessions.models[0];}
session.set('active','Y');OB.Dal.save(session,callback,function(){OB.error("updateSession: failed to save the existing session",arguments);});OB.MobileApp.model.set('session',session.get('id'));});},postCloseSession:function(session){OB.MobileApp.model.triggerLogout();},closeSession:function(){var sessionId=OB.MobileApp.model.get('session'),me=this;if(!this.get('supportsOffline')||!OB.Model.Session||!sessionId){OB.MobileApp.model.triggerLogout();return;}
OB.Dal.get(OB.Model.Session,sessionId,function(session){if(!session){OB.MobileApp.model.triggerLogout();return;}
session.set('active','N');OB.Dal.save(session,function(){me.postCloseSession(session);},function(){OB.error("closeSession",arguments);OB.MobileApp.model.triggerLogout();});},function(){OB.MobileApp.model.triggerLogout();},function(){OB.MobileApp.model.triggerLogout();});},generate_sha1:function(theString){return CryptoJS.enc.Hex.stringify(CryptoJS.SHA1(theString));},attemptToLoginOffline:function(){var me=this;OB.MobileApp.model.set('windowRegistered',undefined);OB.MobileApp.model.set('loggedOffline',true);OB.Dal.find(OB.Model.User,{'name':me.user},function(users){var user;if(users.models.length===0){OB.UTIL.showConfirmation.display('',OB.I18N.getLabel('OBMOBC_OfflinePasswordNotCorrect'),null,{onHideFunction:function(){window.location.reload();}});}else{if(users.models[0].get('password')===me.generate_sha1(me.password+users.models[0].get('created'))){me.usermodel=users.models[0];me.set('orgUserId',users.models[0].id);me.updateSession(me.usermodel,function(){me.renderTerminalMain();});}else{OB.UTIL.showConfirmation.display('',OB.I18N.getLabel('OBMOBC_OfflinePasswordNotCorrect'),null,{onHideFunction:function(){window.location.reload();}});}}},function(){});},postLoginActions:function(){OB.debug("next process: none");},loginUsingCache:function(){OB.debug("next process: renderTerminalMain");var me=this;OB.Dal.find(OB.Model.User,{'id':OB.MobileApp.model.get('orgUserId')},function(users){if(!users.models[0]){OB.MobileApp.model.loadingErrorsActions('loginUsingCache I');return;}
me.usermodel=users.models[0];me.set('orgUserId',users.models[0].id);OB.MobileApp.model.set('windowRegistered',undefined);me.updateSession(me.usermodel,function(){me.renderTerminalMain();});},function(){OB.MobileApp.model.loadingErrorsActions('loginUsingCache II');});},preLoginActions:function(){OB.debug("next process: none. set your application start point here");},login:function(user,password,mode,command){if(this.get('isLoggingIn')===true){OB.UTIL.Debug.execute(function(){throw"There is already a logging process in progress";});return;}
this.set('isLoggingIn',true);var params;OB.UTIL.showLoading(true);var me=this;me.user=user;me.password=password;this.preLoginActions();params=this.get('loginUtilsParams')||{};params.user=user;params.password=password;params.Command=command?command:'DEFAULT';if(params.Command==='FORCE_RESET_PASSWORD'){params.resetPassword=true;}
params.IsAjaxCall=1;params.appName=this.get('appName');var rr,ajaxRequest=new enyo.Ajax({url:this.get('loginHandlerUrl'),cacheBust:false,method:'POST',timeout:5000,contentType:'application/x-www-form-urlencoded; charset=UTF-8',data:params,success:function(inSender,inResponse){var pos,baseUrl;if(this.alreadyProcessed){return;}
this.alreadyProcessed=true;if(inResponse&&inResponse.sourceVersion&&inSender.url.indexOf(document.location.host)!==-1){OB.UTIL.checkSourceVersion(inResponse.sourceVersion,true);}
if(OB.MobileApp.model.get('timeoutWhileLogin')){OB.MobileApp.model.set('timeoutWhileLogin',false);return;}
if(inResponse&&inResponse.showMessage){if(inResponse.command==='FORCE_NAMED_USER'){OB.UTIL.showConfirmation.display(inResponse.messageTitle,inResponse.messageText,[{label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){OB.MobileApp.model.set('isLoggingIn',false);OB.MobileApp.model.login(user,password,mode,'FORCE_NAMED_USER');return;}},{label:OB.I18N.getLabel('OBMOBC_LblCancel'),action:function(){OB.MobileApp.model.set('isLoggingIn',false);return;}}],{autoDismiss:false});return;}else if(inResponse.resetPassword){OB.UTIL.showLoading(false);this.dialog=OB.MobileApp.view.$.confirmationContainer.createComponent({kind:'OB.UI.ExpirationPassword',context:this});this.dialog.show();this.dialog.$.bodyContent.$.newheader.setContent(inResponse.messageTitle);return;}else{me.triggerLoginFail(401,mode,inResponse);return;}}
if(OB.MobileApp.model.get('terminalName')&&!window.localStorage.getItem('loggedTerminalName')){window.localStorage.setItem('loggedTerminalName',OB.MobileApp.model.get('terminalName'));}
if((!OB.UTIL.isNullOrUndefined(OB.MobileApp.model.get('terminalName'))||!OB.UTIL.isNullOrUndefined(window.localStorage.getItem('loggedTerminalName')))&&OB.MobileApp.model.get('terminalName')!==window.localStorage.getItem('loggedTerminalName')){window.localStorage.clear();}
OB.MobileApp.model.set('orgUserId',inResponse.userId);me.set('loggedOffline',false);var setUserModelOnlineCallback=function(){me.initializeCommonComponents();};if(me.get('supportsOffline')){me.setUserModelOnline(setUserModelOnlineCallback);}else{setUserModelOnlineCallback();}},fail:function(inSender,inResponse){var lastTotalRefresh,lastIncRefresh;if(this.alreadyProcessed){return;}
this.alreadyProcessed=true;lastTotalRefresh=window.localStorage.getItem('POSLastTotalRefresh');lastIncRefresh=window.localStorage.getItem('POSLastIncRefresh');if(!lastTotalRefresh&&!lastIncRefresh){var msg=OB.I18N.getLabel('OBMOBC_OfflineModeNoLogin')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();},autoDismiss:false});}else{me.attemptToLoginOffline();}}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(this.get('loginHandlerUrl'));},setUserModelOnline:function(callback){OB.debug("next process:",callback);OB.UTIL.Debug.execute(function(){if(!callback){throw"This method should not be executed asynchronously. Please provide a callback";}});var me=this;OB.Dal.initCache(OB.Model.Message,[],function(){OB.Dal.initCache(OB.Model.LogClient,[],function(){OB.Dal.initCache(OB.Model.Session,[],function(){OB.Dal.initCache(OB.Model.User,[],function(){OB.Dal.find(OB.Model.User,{'id':OB.MobileApp.model.get('orgUserId')},function(users){var user,session,date,savedPass;if(users.models.length===0){date=new Date().toString();user=new OB.Model.User();user.set('name',me.user);user.set('id',OB.MobileApp.model.get('orgUserId'));savedPass=me.generate_sha1(me.password+date);user.set('password',savedPass);user.set('created',date);user.set('formatInfo',JSON.stringify(OB.Format));me.usermodel=user;OB.Dal.save(user,function(){me.updateSession(user,function(){if(callback){callback();}});},function(){OB.MobileApp.model.loadingErrorsActions('setUserModelOnline I');return;},true);}else{user=users.models[0];me.usermodel=user;if(me.password){savedPass=me.generate_sha1(me.password+user.get('created'));user.set('password',savedPass);}
user.set('formatInfo',JSON.stringify(OB.Format));OB.Dal.save(user,function(){me.updateSession(user,function(){if(callback){callback();}});},function(){OB.MobileApp.model.loadingErrorsActions('setUserModelOnline II');return;});}},function(){OB.error("setUserModelOnline",arguments);});},null);},null);},null);},null);},preLogoutActions:function(){},logout:function(){var me=this;this.preLogoutActions();delete localStorage.authenticationClient;delete localStorage.authenticationToken;var rr,ajaxRequest=new enyo.Ajax({url:'../../org.openbravo.mobile.core.logout',cacheBust:false,method:'GET',handleAs:'json',timeout:20000,contentType:'application/json;charset=utf-8',success:function(inSender,inResponse){me.closeSession();},fail:function(inSender,inResponse){me.closeSession();}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);},lock:function(){var me=this;this.preLogoutActions();delete localStorage.authenticationClient;delete localStorage.authenticationToken;var rr,ajaxRequest=new enyo.Ajax({url:'../../org.openbravo.mobile.core.logout',cacheBust:false,method:'GET',handleAs:'json',timeout:20000,contentType:'application/json;charset=utf-8',success:function(inSender,inResponse){me.triggerLogout();},fail:function(inSender,inResponse){me.triggerLogout();}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);},triggerLogout:function(){this.off('loginfail');this.trigger('logout');window.location.reload();},triggerLoginSuccess:function(){this.trigger('loginsuccess');},triggerOnLine:function(){if(!OB.MobileApp.model.loggingIn){this.set('connectedToERP',true);}},triggerOffLine:function(){if(!OB.MobileApp.model.loggingIn){this.set('connectedToERP',false);}},triggerLoginFail:function(e,mode,data){OB.UTIL.showLoading(false);if(mode==='userImgPress'){this.trigger('loginUserImgPressfail',e);}else{this.trigger('loginfail',e,data);}
this.set('isLoggingIn',false);},hasPermission:function(p,checkForAutomaticRoles){var permission=p.approval?p.approval:p;return(!checkForAutomaticRoles&&!(this.get('context')&&this.get('context').role.manual))||(this.get('permissions')&&this.get('permissions')[permission]);},supportLogClient:function(){var supported=true;if((OB.MobileApp&&OB.MobileApp.model&&OB.MobileApp.model.get('supportsOffline'))===false){supported=false;}
return supported;},saveTerminalInfo:function(callback){OB.info('saving terminal info:',this.attributes);this.usermodel.set('terminalinfo',JSON.stringify(this));OB.Dal.save(this.usermodel,function(){if(callback){callback();}},function(){OB.error("saveTerminalInfo",arguments);});}});(function(){var LogClient=OB.Data.ExtensibleModel.extend({modelName:'LogClient',tableName:'obmobc_logclient',entityName:'LogClient',source:'org.openbravo.mobile.core.master.LogClient',local:true,createStatement:'CREATE TABLE IF NOT EXISTS obmobc_logclient (obmobc_logclient_id TEXT PRIMARY KEY, deviceId TEXT, cacheSessionId TEXT, msg TEXT, json CLOB, loglevel TEXT, created TEXT, createdby TEXT)',dropStatement:'DROP TABLE IF EXISTS obmobc_logclient',insertStatement:'INSERT INTO obmobc_logclient (obmobc_logclient_id, deviceId, cacheSessionId, msg, json, loglevel, created, createdby) VALUES (?,?,?,?,?,?,?,?)',serializeToJSON:function(){return JSON.parse(JSON.stringify(this.toJSON()));}});LogClient.addProperties([{name:'id',column:'obmobc_logclient_id',primaryKey:true,type:'TEXT'},{name:'deviceId',column:'deviceId',type:'TEXT'},{name:'cacheSessionId',column:'cacheSessionId',type:'TEXT'},{name:'msg',column:'msg',type:'TEXT'},{name:'json',column:'json',type:'CLOB'},{name:'loglevel',column:'loglevel',type:'TEXT'},{name:'created',column:'created',type:'TEXT'},{name:'createdby',column:'createdby',type:'TEXT'}]);OB.Data.Registry.registerModel(LogClient);}());(function(){var Message=OB.Data.ExtensibleModel.extend({modelName:'Message',tableName:'message',entityName:'Message',source:'',local:true});Message.addProperties([{name:'id',column:'message_id',primaryKey:true,type:'TEXT'},{name:'server',column:'server',type:'TEXT'},{name:'mainServer',column:'mainServer',type:'TEXT'},{name:'url',column:'url',type:'TEXT'},{name:'time',column:'time',type:'NUMERIC'},{name:'status',column:'status',type:'TEXT'},{name:'messageObj',column:'messageObj',type:'TEXT'}]);OB.Data.Registry.registerModel(Message);}());enyo.kind({name:'OB.UI.Button',kind:'enyo.Button',handlers:{onkeydown:'keydownHandler'},keydownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===13||keyCode===32){this.executeTapAction();return true;}
return false;},executeTapAction:function(){if(this&&this.ontap&&this.owner&&this.owner[this.ontap]){this.owner[this.ontap]();}else{this.tap();}},focus:function(){if(this.hasNode()){this.hasNode().focus();}},initComponents:function(){this.inherited(arguments);if(this.i18nContent){this.setContent(OB.I18N.getLabel(this.i18nContent));}else if(this.i18nLabel){this.setContent(OB.I18N.getLabel(this.i18nLabel));}else if(this.label){this.setContent(this.label);}}});enyo.kind({name:'OB.UI.RegularButton',kind:'OB.UI.Button',icon:'',iconright:'',label:'',classes:'btnlink'});enyo.kind({name:'OB.UI.SmallButton',kind:'OB.UI.RegularButton',classes:'btnlink-small'});enyo.kind({name:'OB.UI.MediumButton',kind:'OB.UI.RegularButton',classes:'btnlink-medium'});enyo.kind({name:'OB.UI.ModalDialogButton',kind:'OB.UI.RegularButton',events:{onHideThisPopup:''},classes:'btnlink-gray modal-dialog-button'});enyo.kind({name:'OB.UI.Popup',kind:"onyx.Popup",centered:true,floating:true,closeOnEscKey:true,scrim:true,autoDismiss:true,handlers:{onkeydown:'keydownHandler',onHideThisPopup:'hideFromInside'},keydownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===27&&this.showing&&this.autoDismiss&&this.closeOnEscKey){this.hide();return true;}else if(keyCode===13&&this.defaultActionButton){this.defaultActionButton.executeTapAction();return true;}else{return false;}},_addArgsToComponent:function(args){if(args){this.args=this.args||{};_.each(args,function(arg,key){this.args[key]=arg;},this);}},showingChanged:function(){this.inherited(arguments);if(this.showing){OB.MobileApp.view.openedPopup=this;}else{OB.MobileApp.view.openedPopup=null;}},show:function(args){var resp=true;this.originalScanMode=OB.MobileApp.view.scanMode;OB.MobileApp.view.scanningFocus(false);this.args={};this._addArgsToComponent(args);if(this.executeOnShow){resp=this.executeOnShow();if(_.isUndefined(resp)||_.isNull(resp)){resp=true;}}
if(resp){var me=this;if(me.autoDismiss){me.autoDismiss=false;this.inherited(arguments);setTimeout(function(){me.autoDismiss=true;},100);}else{this.inherited(arguments);}
this.setDefaultActionButton();this.focusInPopup();if(this.executeOnShown){this.executeOnShown();}}},hideFromInside:function(inSender,inEvent){this.hide(inEvent.args);},hide:function(args){var resp=true;this._addArgsToComponent(args);if(this.executeBeforeHide){resp=this.executeBeforeHide();if(_.isUndefined(resp)||_.isNull(resp)){resp=true;}}
if(resp){this.inherited(arguments);if(!this.hasNode()){var element=document.getElementById(this.id);if(element){element.parentNode.removeChild(element);}}
OB.MobileApp.view.scanningFocus(this.originalScanMode);if(this.executeOnHide){this.executeOnHide();}}
delete this.originalScanMode;},focusInPopup:function(){var allChildsArray=OB.UTIL.getAllChildsSorted(this),isFirstFocusableElementObtained=false,tagName,element,i;for(i=0;i<allChildsArray.length;i++){if(allChildsArray[i].hasNode()&&allChildsArray[i].hasNode().tagName){tagName=allChildsArray[i].hasNode().tagName.toUpperCase();}else{tagName='';}
if((tagName==='INPUT'||tagName==='SELECT'||tagName==='TEXTAREA'||tagName==='BUTTON')&&allChildsArray[i].showing&&!isFirstFocusableElementObtained){element=allChildsArray[i];isFirstFocusableElementObtained=true;}else if(allChildsArray[i].isFirstFocus){element=allChildsArray[i];break;}}
if(element){element.focus();}
return true;},setDefaultActionButton:function(element){var allChildsArray,tagName,i;if(element){allChildsArray=[element];}else{allChildsArray=OB.UTIL.getAllChildsSorted(this);}
for(i=0;i<allChildsArray.length;i++){if(allChildsArray[i].hasNode()&&allChildsArray[i].hasNode().tagName){tagName=allChildsArray[i].hasNode().tagName.toUpperCase();}else{tagName='';}
if(tagName==='BUTTON'&&allChildsArray[i].isDefaultAction){element=allChildsArray[i];break;}}
if(element){this.defaultActionButton=element;}
return true;},updatePosition:function(){if(!this.centered||!this.floating){this.inherited(arguments);return true;}
var top,left,t=this.getBounds();if(this.topPosition){top=this.topPosition.toString();}else if(this.centered){top='50%';}else{top='0';}
if(top.indexOf('px')!==-1){top=top.replace('px','');}
if(this.leftPosition){left=this.leftPosition.toString();}else if(this.centered){left='50%';}else{left='0';}
if(left.indexOf('px')!==-1){left=left.replace('px','');}
if(top.indexOf('%')!==-1){this.addStyles('top: '+top);this.addStyles('margin-top: -'+Math.max(t.height/2,0).toString()+'px;');}else{this.addStyles('top: '+top+'px');}
if(left.indexOf('%')!==-1){this.addStyles('left: '+left);this.addStyles('margin-left: -'+Math.max(t.width/2,0).toString()+'px;');}else{this.addStyles('left: '+left+'px');}
return true;}});enyo.kind({name:'OB.UI.Modal',kind:'OB.UI.Popup',classes:'modal modal-popup',published:{header:''},components:[{tag:'div',classes:'modal-header',components:[{name:'closebutton',tag:'div',classes:'modal-header-closebutton',components:[{tag:'span',ontap:'hide',allowHtml:true,content:'&times;'}]},{name:'header',classes:'modal-header-text'}]},{tag:'div',name:'body',classes:'modal-body'}],headerChanged:function(){this.$.header.setContent(this.i18nHeader?OB.I18N.getLabel(this.i18nHeader):this.header);},initComponents:function(){this.inherited(arguments);if(this.modalClass){this.addClass(this.modalClass);}
this.$.header.setContent(this.i18nHeader?OB.I18N.getLabel(this.i18nHeader):this.header);if(this.bodyClass){this.$.body.addClass(this.bodyClass);}
this.$.body.createComponent(this.body);}});enyo.kind({name:'OB.UI.RenderEmpty',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc;',initComponents:function(){this.inherited(arguments);this.setContent(this.label||OB.I18N.getLabel('OBMOBC_SearchNoResults'));}});enyo.kind({name:'OB.UI.SelectButton',kind:'OB.UI.Button',classes:'btnselect',tap:function(){this.model.trigger('selected',this.model);this.model.trigger('click',this.model);}});enyo.kind({kind:'OB.UI.SelectButton',name:'OB.UI.listItemButton',classes:'btnselect',tap:function(){this.model.trigger('selected',this.model);this.model.trigger('click',this.model);},getValueByFieldName:function(fieldName){if(this.$[fieldName]&&this.$[fieldName].getValue){return this.$[fieldName].getValue();}else if(this.$[fieldName]&&this.$[fieldName].content){return this.$[fieldName].content;}else{OB.warn('No way found to return field name. Overwrite this method in the component to do it');}
return null;},getValueByIndex:function(index){if(this.columns){if(this.getValueByFieldName){return this.getValueByFieldName(this.columns[index]);}else{OB.warn(this.name+' must implement getValueByFieldName');}}else{OB.warn('columns array is not present in '+this.name+' And it is needed to execute getValueByIndex');}
return null;},getValue:function(arg){if(_.isNumber(arg)){if(this.getValueByIndex){return this.getValueByIndex(arg);}else{OB.warn('getValueByIndex is not present in '+this.name);return null;}}else if(_.isString(arg)){if(this.getValueByFieldName){return this.getValueByFieldName(arg);}else{OB.warn('getValueByFieldName is not present in '+this.name);return null;}}}});enyo.kind({name:'OB.UI.CancelButton',kind:'OB.UI.SmallButton',classes:'btnlink-white btnlink-fontgray',events:{onShowPopup:''},tap:function(){this.doShowPopup({popup:'modalCancel'});},initComponents:function(){this.inherited(arguments);this.setContent(this.label||OB.I18N.getLabel('OBMOBC_LblCancel'));}});enyo.kind({name:'OB.UI.RadioButton',kind:"onyx.Checkbox",classes:'btn btn-radio',style:'padding: 0px 0px 0px 40px; margin: 10px;',activeRadio:function(){this.addClass('active');this.setChecked(true);},disableRadio:function(){this.setNodeProperty('checked',false);this.setAttribute('checked','');this.removeClass('active');this.active=false;this.checked=false;},tap:function(){this.inherited(arguments);this.activeRadio();},initComponents:function(){this.inherited(arguments);}});enyo.kind({name:'OB.UI.ToolbarButton',kind:'OB.UI.RegularButton',classes:'btnlink-toolbar',initComponents:function(){this.inherited(arguments);if(this.icon){this.addClass(this.icon);}}});enyo.kind({name:'OB.UI.CheckboxButton',kind:'OB.UI.Button',classes:'btn-check',checked:false,tap:function(){if(this.readOnly){return;}
this.checked=!this.checked;this.addRemoveClass('active',this.checked);},toggle:function(){this.checked=!this.checked;this.addRemoveClass('active',this.checked);},check:function(){this.addClass('active');this.checked=true;},unCheck:function(){this.removeClass('active');this.checked=false;}});enyo.kind({kind:'OB.UI.Button',name:'OB.UI.ButtonTab',initComponents:function(){var label;this.inherited(arguments);this.addClass('btnlink btnlink-gray');label=this.i18nLabel?OB.I18N.getLabel(this.i18nLabel):this.label;if(label){this.createComponent({name:'lbl',tag:'span',content:label});}}});enyo.kind({name:'OB.UI.ToolbarButtonTab',kind:'OB.UI.ButtonTab',events:{onTabChange:''},initComponents:function(){this.inherited(arguments);this.addClass('btnlink-toolbar');}});enyo.kind({name:'OB.UI.TabPane',classes:'postab-pane',executeOnShow:function(params){var components=this.getComponents();if(components.length>0){if(this.$[components[0].getName()].executeOnShow){this.$[components[0].getName()].executeOnShow(params);}}}});enyo.kind({name:'OB.UI.ModalAction',kind:'OB.UI.Popup',classes:'modal-dialog',bodyContentClass:'modal-dialog-body-content',bodyButtonsClass:'modal-dialog-body-buttons',components:[{classes:'modal-dialog-header',components:[{name:'headerCloseButton',classes:'modal-dialog-header-closebutton',components:[{tag:'span',ontap:'hide',allowHtml:true,content:'&times'}]},{name:'header',classes:'modal-dialog-header-text'}]},{classes:'modal-dialog-body',name:'bodyParent',components:[{name:'bodyContent'},{name:'bodyButtons'}]}],setHeader:function(headerText){this.$.header.setContent(headerText);},initComponents:function(){this.inherited(arguments);if(this.i18nHeader){this.$.header.setContent(OB.I18N.getLabel(this.i18nHeader));}else{this.$.header.setContent(this.header);}
if(this.maxheight){this.$.bodyParent.setStyle('max-height: '+this.maxheight+';');}
this.$.bodyContent.setClasses(this.bodyContentClass);if(this.bodyContent&&this.bodyContent.i18nContent){this.$.bodyContent.setContent(OB.I18N.getLabel(this.bodyContent.i18nContent));}else{this.$.bodyContent.createComponent(this.bodyContent);}
this.$.bodyButtons.setClasses(this.bodyButtonsClass);this.$.bodyButtons.createComponent(this.bodyButtons);}});enyo.kind({name:'OB.UI.ActionPopup',kind:'OB.UI.Popup',classes:'modal-dialog',bodyContentClass:'modal-dialog-body-content',bodyButtonsClass:'modal-dialog-body-buttons',components:[{classes:'modal-dialog-header',components:[{name:'headerCloseButton',classes:'modal-dialog-header-closebutton',components:[{tag:'span',ontap:'hide',allowHtml:true,content:'&times'}]},{name:'header',classes:'modal-dialog-header-text'}]},{classes:'modal-dialog-body',name:'bodyParent',components:[{name:'bodyContent'},{name:'bodyButtons'}]}],setHeader:function(headerText){this.$.header.setContent(headerText);},initComponents:function(){this.inherited(arguments);if(this.i18nHeader){this.$.header.setContent(OB.I18N.getLabel(this.i18nHeader));}else{this.$.header.setContent(this.header);}
if(this.maxheight){this.$.bodyParent.setStyle('max-height: '+this.maxheight+';');}
this.$.bodyContent.setClasses(this.bodyContentClass);if(this.bodyContent&&this.bodyContent.i18nContent){this.$.bodyContent.setContent(OB.I18N.getLabel(this.bodyContent.i18nContent));}else{this.$.bodyContent.createComponent(this.bodyContent,{owner:this});}
this.$.bodyButtons.setClasses(this.bodyButtonsClass);this.$.bodyButtons.createComponent(this.bodyButtons,{owner:this});}});enyo.kind({name:'OB.UI.SearchInput',kind:'enyo.Input',type:'text',classes:'input',attributes:{'x-webkit-speech':'x-webkit-speech'}});enyo.kind({name:'OB.UI.SearchInputAutoFilter',kind:'enyo.Input',type:'text',classes:'input',attributes:{'x-webkit-speech':'x-webkit-speech'},events:{onFiltered:''},minLengthToSearch:0,handlers:{onblur:'blur'},blur:function(){if(!navigator.userAgent.match(/iPhone|iPad|iPod/i)){OB.MobileApp.view.scanningFocus();}},input:function(){if((this.name==='productFilterText'&&!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true))||(this.name==='customerFilterText'&&!OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true))){var temp=this.getValue(),me=this;if(temp.length>=this.minLengthToSearch||this.minLengthToSearch===0){setTimeout(function(){if(temp===me.getValue()){me.doFiltered();}},1000);}}}});enyo.kind({name:'OB.UI.ModalInfo',kind:'OB.UI.ModalAction',bodyButtons:{components:[{kind:'OB.UI.AcceptDialogButton'}]},events:{onShowPopup:''},closeOnAcceptButton:true,initComponents:function(){this.inherited(arguments);this.$.bodyButtons.$.acceptDialogButton.dialogContainer=this;}});enyo.kind({name:'OB.UI.InfoPopup',kind:'OB.UI.ActionPopup',bodyButtons:{components:[{kind:'OB.UI.AcceptDialogButton'}]},events:{onShowPopup:''},closeOnAcceptButton:true,initComponents:function(){this.inherited(arguments);this.$.acceptDialogButton.dialogContainer=this;}});enyo.kind({name:'OB.UI.AcceptDialogButton',kind:'OB.UI.ModalDialogButton',classes:'btnlink btnlink-gray modal-dialog-button',events:{onHideThisPopup:''},tap:function(){if(this.dialogContainer.acceptCallback){this.dialogContainer.acceptCallback();}
if(this.dialogContainer.closeOnAcceptButton){this.doHideThisPopup();}},initComponents:function(){if(this.label){this.setContent(this.label);}else{this.setContent(OB.I18N.getLabel('OBMOBC_LblOk'));}
this.inherited(arguments);}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.CancelDialogButton',tap:function(){this.doHideThisPopup();},initComponents:function(){this.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));this.inherited(arguments);}});enyo.kind({name:'OB.OBPOSLogin.UI.UserButton',classes:'login-user-button',user:null,userImage:null,userId:null,userConnected:null,showConnectionStatus:true,events:{onUserImgClick:''},components:[{classes:'login-user-button-bottom',components:[{name:'bottomIcon',classes:'login-user-button-bottom-icon',content:['.']},{name:'bottomText',classes:'login-user-button-bottom-text'}]}],tap:function(){this.doUserImgClick();},create:function(){var me=this;this.inherited(arguments);if(this.userImage&&this.userImage!=='none'){this.applyStyle('background-image','url('+this.userImage+')');}
if(!this.showConnectionStatus){this.$.bottomIcon.hide();}
if(this.showConnectionStatus){me.$.bottomIcon.applyStyle('background-image','url(../org.openbravo.mobile.core/assets/img/iconOfflineUser.png)');OB.Dal.initCache(OB.Model.Session,[],null,null);OB.Dal.find(OB.Model.Session,{'user':me.userId},function(sessions){var session;if(sessions.models.length!==0){session=sessions.models[0];if(session.get('active')==='Y'){me.$.bottomIcon.applyStyle('background-image','url(../org.openbravo.mobile.core/assets/img/iconAwayUser.png)');}}},function(){OB.error(arguments);});}
if(this.user){this.$.bottomText.setContent(this.user);}}});enyo.kind({name:'OB.OBPOSLogin.UI.LoginButton',kind:'OB.UI.ModalDialogButton',style:'min-width: 115px;',handlers:{synchronizing:'disableButton',synchronized:'enableButton'},disableButton:function(){this.setDisabled(true);},enableButton:function(){this.setDisabled(false);},initComponents:function(){this.inherited(arguments);this.content=OB.I18N.getLabel('OBMOBC_LoginButton');this.setDisabled(true);}});enyo.kind({kind:'enyo.Ajax',name:'OB.OBPOSLogin.UI.LoginRequest',url:'../../org.openbravo.retail.posterminal.service.loginutils',method:'GET',handleAs:'json',contentType:'application/json;charset=utf-8'});enyo.kind({name:'OB.OBPOSLogin.UI.Login',tag:'section',components:[{kind:'OB.UI.ModalInfo',name:'DatabaseDialog',header:'DB version change',bodyContent:{content:'DB version change'}},{classes:'login-header-row',components:[{name:'loginHeaderCompany',classes:'login-header-company'},{classes:'login-header-caption',name:'appCaption'},{classes:'login-header-ob',name:'appName'},{style:'color:white; position:absolute; bottom:0; right:0',name:'appNameVersion'}]},{style:'height: 600px',components:[{classes:'span6',components:[{kind:'Scroller',thumb:true,horizontal:'hidden',name:'loginUserContainer',classes:'login-user-container',content:['.']}]},{classes:'span6',components:[{classes:'login-inputs-container',name:'loginInputsContainer',components:[{name:'loginInputs',classes:'login-inputs-browser-compatible',components:[{components:[{classes:'login-status-info',style:'float: left;',name:'connectStatus'},{classes:'login-status-info',name:'screenLockedLbl'}]},{components:[{kind:'enyo.Input',type:'text',name:'username',classes:'input-login',onkeydown:'inputKeydownHandler'}]},{components:[{kind:'enyo.Input',type:'password',name:'password',classes:'input-login',onkeydown:'inputKeydownHandler'}]},{classes:'login-inputs-loginbutton',components:[{kind:'OB.OBPOSLogin.UI.LoginButton',onclick:'loginButtonAction'}]},{name:'loginWarning',classes:'login-warning'}]},{name:'loginBrowserNotSupported',style:'display: none;',components:[{components:[{name:'LoginBrowserNotSupported_Title_Lbl',classes:'login-browsernotsupported-title'}]},{style:'padding-bottom: 10px;',components:[{components:[{name:'LoginBrowserNotSupported_P1_Lbl',classes:'login-browsernotsupported-content'},{name:'LoginBrowserNotSupported_P2_Lbl',classes:'login-browsernotsupported-content'},{name:'supportedBrowsers'}]}]}]}]}]}]}],setConnectedStatus:function(){var me=this;if(!this.$.connectStatus){return;}
OB.UTIL.checkConnectivityStatus(function(){if(me&&me.$&&me.$.connectStatus){me.$.connectStatus.setContent(OB.I18N.getLabel('OBMOBC_Online'));}},function(){if(me&&me.$&&me.$.connectStatus){me.$.connectStatus.setContent(OB.I18N.getLabel('OBMOBC_Offline'));}});},initComponents:function(){this.inherited(arguments);OB.MobileApp.view.currentWindow='login';OB.MobileApp.view.currentWindowState='unknown';this.$.screenLockedLbl.setContent(OB.I18N.getLabel('OBMOBC_LoginScreenLocked'));this.$.username.attributes.placeholder=OB.I18N.getLabel('OBMOBC_LoginUserInput');this.$.password.attributes.placeholder=OB.I18N.getLabel('OBMOBC_LoginPasswordInput');this.$.LoginBrowserNotSupported_Title_Lbl.setContent(OB.I18N.getLabel('OBMOBC_LoginBrowserNotSupported'));this.$.LoginBrowserNotSupported_P1_Lbl.setContent(OB.I18N.getLabel('OBMOBC_LoginBrowserNotSupported_P1'));this.$.LoginBrowserNotSupported_P2_Lbl.setContent(OB.I18N.getLabel('OBMOBC_LoginBrowserNotSupported_P2'));this.$.appName.setContent(OB.MobileApp.model.get('appDisplayName'));this.$.appNameVersion.setContent(OB.UTIL.VersionManagement.buildVersionString(OB.UTIL.VersionManagement.current.mobileCore));if(OB.UTIL.Debug.isDebug()){this.$.appNameVersion.setContent(this.$.appNameVersion.getContent()+'-inDev');}
this.$.appCaption.setContent(OB.appCaption||'');this.setConnectedStatus();OB.MobileApp.model.on('change:connectedToERP',function(){if(OB.MobileApp.model.get('supportsOffline')){this.setConnectedStatus();}},this);this.postRenderActions();OB.MobileApp.view.currentWindowState='renderUI';},handlers:{onUserImgClick:'handleUserImgClick'},handleUserImgClick:function(inSender,inEvent){var u=inEvent.originator.user;this.$.username.setValue(u);this.$.password.setValue('');if(navigator.userAgent.match(/iPhone|iPad|iPod/i)){var setFocusTo=this.$.password;setTimeout(function(){setFocusTo.focus();},400);}else{this.$.password.focus();}
return true;},inputKeydownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===13){this.loginButtonAction();return true;}
return false;},loginButtonAction:function(){var u=this.$.username.getValue(),p=this.$.password.getValue();if(!u||!p){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_EmptyUserPassword'));}else{OB.MobileApp.model.login(u,p);}},setCompanyLogo:function(inSender,inResponse){if(!inResponse.logoUrl){return;}
if(this.$.loginHeaderCompany){this.$.loginHeaderCompany.applyStyle('background-image','url('+inResponse.logoUrl+')');}
return true;},setUserImages:function(inSender,inResponse){var name=[],userId=[],userName=[],image=[],connected=[],target=this.$.loginUserContainer,me=this,jsonImgData;if(!target){return;}
if(!inResponse.data){OB.Dal.find(OB.Model.User,{},function(users){var i,user;for(i=0;i<users.models.length;i++){user=users.models[i];name.push(user.get('name'));userId.push(user.get('id'));userName.push(user.get('name'));connected.push(false);}
me.renderUserButtons(name,userId,userName,image,connected,target);},function(){OB.error(arguments);});return true;}
jsonImgData=inResponse.data;enyo.forEach(jsonImgData,function(v){name.push(v.name);userId.push(v.userId);userName.push(v.userName);image.push(v.image);connected.push(v.connected);});this.renderUserButtons(name,userId,userName,image,connected,target);},renderUserButtons:function(name,userId,userName,image,connected,target){var i;if(name.length===0){this.$.loginInputsContainer.hide();this.$.loginHeaderCompany.hide();OB.UTIL.showConfirmation.display('',OB.I18N.getLabel('OBMOBC_NotTerminalOrNotUser',[OB.MobileApp.model.get('terminalName')]));}
for(i=0;i<name.length;i++){target.createComponent({kind:'OB.OBPOSLogin.UI.UserButton',user:userName[i],userId:userId[i],userImage:image[i],userConnected:connected[i]});}
target.render();OB.UTIL.showLoading(false);return true;},postRenderActions:function(){var params,me=this;OB.UTIL.showLoggingOut(false);OB.MobileApp.model.on('loginfail',function(status,data){var msg;if(data&&data.messageTitle){msg=data.messageTitle;}
if(data&&data.messageText){msg+=(msg?'\n':'')+data.messageText;}
msg=msg||OB.I18N.getLabel('OBMOBC_InvalidUserPassword');OB.UTIL.showConfirmation.display('',msg);if(this.$.password){this.$.password.setValue('');}
if(this.$.username){this.$.username.focus();}},this);OB.MobileApp.model.on('loginUserImgPressfail',function(){if(this.$.password){this.$.password.setValue('');this.$.password.focus();}},this);var browserInfo=OB.UTIL.getSupportedBrowserInfo();if(!browserInfo.isAllowed){this.$.loginInputs.setStyle('display: none');this.$.loginBrowserNotSupported.setStyle('display: block');var browsers=[];_.each(OB.UTIL.SupportedBrowsers,function(browser){browsers.push({tag:'li',content:OB.I18N.getLabel('OBMOBC_LoginBrowserNotSupported_Info',[browser.label,browser.required,browser.preferred])});});this.$.supportedBrowsers.createComponent({tag:'ul',classes:'login-browsernotsupported-list',components:browsers}).render();OB.UTIL.showLoading(false);return true;}
if(!OB.UTIL.isHTTPSAvailable()){this.$.loginWarning.setContent(OB.I18N.getLabel('OBMOBC_HTTPSMissing'));}else if(browserInfo.isPreferred){this.$.loginWarning.setContent('');}else if(browserInfo.isSupported){this.$.loginWarning.setContent(OB.I18N.getLabel('OBMOBC_LoginBrowserNotRecommended'));}else{this.$.loginWarning.setContent(OB.I18N.getLabel('OBMOBC_LoginBrowserNotSupportedButAllowed'));}
params=OB.MobileApp.model.get('loginUtilsParams')||{};params.appName=OB.MobileApp.model.get('appName');params.command='companyLogo';var rr,ajaxRequest=new OB.OBPOSLogin.UI.LoginRequest({url:OB.MobileApp.model.get('loginUtilsUrl'),data:params,success:function(inSender,inResponse){me.setCompanyLogo(inSender,inResponse);}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);params.command='userImages';var rr2,ajaxRequest2=new OB.OBPOSLogin.UI.LoginRequest({url:OB.MobileApp.model.get('loginUtilsUrl'),data:params,success:function(inSender,inResponse){me.setUserImages(inSender,inResponse);}});rr2=new OB.RR.Request({ajaxRequest:ajaxRequest2});rr2.exec(ajaxRequest2.url);this.$.username.focus();}});(function(){OB.UTIL=window.OB.UTIL||{};OB.UTIL.processLogClientAll=function(){if(!OB.MobileApp.model.loadingErrorsActions.executed){if(OB.MobileApp.model.get('isLoggingIn')||!OB.UTIL.SynchronizationHelper.isSynchronized()){OB.debug("LogClient flushing delayed");return false;}}
if(OB.MobileApp.model.get('connectedToERP')){var criteria={_limit:200};OB.Dal.find(OB.Model.LogClient,criteria,function(logClientsNotProcessed){if(!logClientsNotProcessed||logClientsNotProcessed.length===0){return;}
OB.UTIL.processLogClients(logClientsNotProcessed,null,null);});}};OB.UTIL.processLogClientClass='org.openbravo.mobile.core.utils.LogClientLoader';OB.UTIL.processLogClients=function(logClients,successCallback,errorCallback){if(!OB.MobileApp.model.isUserAuthenticated()){OB.UTIL.Debug.execute(function(){console.warn("'OB.UTIL.processLogClients' cannot be executed because it requires an autheticated user");});return;}
var logClientsToJson=[];logClients.each(function(logClient){var toJson=logClient.serializeToJSON();if(toJson&&toJson.msg){if(toJson.msg.toLowerCase().indexOf('logclient')<0){logClientsToJson.push({id:toJson.id,json:toJson.json});return;}
console.warn("Log client failed to log:\n"+toJson.msg);OB.Dal.remove(logClient,null,function(tx,err){OB.UTIL.showError(err);});}});if(logClientsToJson.length===0){return;}
this.proc=new OB.DS.Process(OB.UTIL.processLogClientClass);if(OB.MobileApp.model.get('connectedToERP')){this.proc.exec({logclient:logClientsToJson},function(data){if(data&&data.exception){if(errorCallback){errorCallback();}}else{logClients.each(function(logClient){OB.Dal.remove(logClient,null,function(tx,err){OB.UTIL.showError(err);});});if(successCallback){successCallback();}}},null,null,20000);}};}());(function(){var root=this;var TestRegistry;if(typeof exports!=="undefined"){TestRegistry=exports;}else{TestRegistry=root.TestRegistry={};}
TestRegistry.VERSION="1.0.3";console.log("TestRegistry "+TestRegistry.VERSION+" is available");TestRegistry.writingTest=false;TestRegistry.testSteps=[];var replacementsTable=[];var checksTable=["pointOfSale","cashUp","cashManagement"];var minimumSegments=2;var checkForRepeated=false;var enyoNodes=null;var testeableIdTests=null;var untesteableIdTests=null;var totalEnyoObjects=null;var nullCount=null;var enyoObjectsCount=null;var validEnyoObjects=null;var maxSegments=null;var idModifications=null;var needsTheIdToBeRemovedInEnyoComponentCreation=0;var init=function(){enyoNodes=[];testeableIdTests=[];untesteableIdTests=[];totalEnyoObjects=0;nullCount=0;enyoObjectsCount=0;validEnyoObjects=0;maxSegments=-1;idModifications=0;needsTheIdToBeRemovedInEnyoComponentCreation=0;};function EnyoNode(enyoGeneratedIdDOM,preGeneratedIdTest){this.idDOM=enyoGeneratedIdDOM;this.enyoObject=enyo.$[enyoGeneratedIdDOM];var isInNeedOfNewId=preGeneratedIdTest===undefined;var idDOMForAlgorithm=preGeneratedIdTest;var firstUniqueSegment=null;var segments=null;var idTest=null;var resetIdTest=function(){idTest=null;};var initIdTest=function(){idTest={chunkRemoved:null,id:null,isAlgorithmGenerated:null,isUnique:false,isTesteable:null};};var checkIdTest=function(){if(idTest===null){throw{name:"Fatal Error",message:"You must generate the idTest object first. execute getIdTest()"};}};var getSegments=function(){if(segments===null){segments=idDOMForAlgorithm.split(/_/);}
return segments;};var getLastSegmentIndex=function(){return getSegments().length-1;};this.init=function(){if(isInNeedOfNewId){idDOMForAlgorithm=this.idDOM;var idWithReplacements=idDOMForAlgorithm;replacementsTable.forEach(function(element){idWithReplacements=idWithReplacements.split(element[0]).join(element[1]);});idDOMForAlgorithm=idWithReplacements;if(this.idDOM.length!==idDOMForAlgorithm.length){idModifications+=1;}}
var segmentCount=getLastSegmentIndex();firstUniqueSegment=segmentCount;if(segmentCount>maxSegments){maxSegments=segmentCount;}};this.isSegmentsLeft=function(){return firstUniqueSegment<getLastSegmentIndex();};this.setFirstInvertedUniqueSegment=function(invertedIndex){if(isInNeedOfNewId){resetIdTest();var newFirstUniqueSegment=getLastSegmentIndex()-invertedIndex;if(newFirstUniqueSegment+minimumSegments<0){throw{name:"Fatal Error",message:"It is not possible to find a unique first segment because the DOM id is duplicated. Open the browser log and search for '[enyo] Duplicated DOM id' warnings. This error must be fixed before continuing. Tests lose their purpouse if non-unique UI objects are present"};}
firstUniqueSegment=newFirstUniqueSegment;}};this.setIsUnique=function(){if(!checkIdTest){throw{name:"Fatal Error",message:"Your are trying to set it to unique before generating it"};}
idTest.isUnique=true;};this.getIdTest=function(){var i=0;if(idTest===null){initIdTest();if(this.enyoObject.idtest){idTest.chunkRemoved="";idTest.id=this.enyoObject.idtest;return idTest;}
idTest.isAlgorithmGenerated=isInNeedOfNewId;if(isInNeedOfNewId){var removed="";var id="";if(firstUniqueSegment===null){throw{name:"Fatal Error",message:"The firstUniqueSegment variable must be set. Init() set an initial value so you have, most probably, broken the flow"};}
var lastSegmentIndex=getLastSegmentIndex();for(i=0;i<lastSegmentIndex;i++){var segment=getSegments()[i];if(i<firstUniqueSegment){removed+=segment+"_";}else{id+=segment+"_";}}
idTest.chunkRemoved=removed;idTest.id=id+getSegments()[lastSegmentIndex];}else{idTest.chunkRemoved="";idTest.id=idDOMForAlgorithm;}}
return idTest;};this.toString=function(){var idTest=this.getIdTest();if(idTest.isTesteable){return"idDOM:\t\t"+this.idDOM+" =>\n\tidTest:\t'"+idTest.id+"'";}
return"idDOM:\t\t"+this.idDOM+" =>\n\tidTest:\t'"+idTest.chunkRemoved+"' / '"+idTest.id+"'"+(idTest.isTesteable?"":" (*)");};this.isEqual=function(to){return this.getIdTest().id===to.getIdTest().id;};this.isValidForUnitTesting=function(){checkIdTest();var isNumeric=function(s){return!isNaN(s);};var isTesteable=true;var incompatibleString=null;var idTest=this.getIdTest();if(idTest.isUnique){var id=idTest.id;checksTable.forEach(function(element){var index=id.indexOf(element);if(index>=0){var nextChar=id.charAt(index+element.length);if(nextChar==="_"||isNumeric(nextChar)){isTesteable=false;incompatibleString=element;return;}}});}else{isTesteable=false;incompatibleString="not unique";}
idTest.isTesteable=isTesteable;return{isTesteable:idTest.isTesteable,incompatibleString:incompatibleString};};this.init();}
function scan(){init();var addNode=function(id,idTest){totalEnyoObjects+=1;enyoObjectsCount+=1;if(enyo.$[id]===null){nullCount+=1;return;}
if(!document.getElementById(id)){return;}
if(id.indexOf('OB.UI.id')>=0||id.indexOf('org.openbravo')>=0){needsTheIdToBeRemovedInEnyoComponentCreation+=1;return;}
validEnyoObjects+=1;enyoNodes.push(new EnyoNode(id,idTest));};var enyoRoot=enyo.$.terminal;var count=0;var recurseLi;recurseLi=function(enyoParent,tablePrefix,liIndex){count+=1;if(enyoParent.children.length===0){return;}
enyoParent.children.forEach(function(element){addNode(element.id,tablePrefix+"_row"+liIndex+"_"+element.name);recurseLi(element,tablePrefix,liIndex);});};var recurseTable;recurseTable=function(enyoParent,tablePrefix,liIndex){count+=1;if(enyoParent.children.length===0){return;}
enyoParent.children.forEach(function(element){if(element.tag==="li"){liIndex+=1;addNode(element.id,tablePrefix+"_row"+liIndex);recurseLi(element,tablePrefix,liIndex);}else{addNode(element.id,tablePrefix+"_"+element.name);recurseTable(element,tablePrefix,liIndex);}});};var getChildren;getChildren=function(enyoParent){count+=1;if(enyoParent.children.length===0){return;}
enyoParent.children.forEach(function(element){if(element.kind&&(typeof(element.kind)!=="function")&&(element.kind.indexOf("OB.UI.Table")===0||element.kind.indexOf("OB.UI.ScrollableTable")===0)){addNode(element.id,"table_"+element.name);recurseTable(element,element.name,0);}else{addNode(element.id);getChildren(element);}});};getChildren(enyoRoot);var enyoNodesToProcess=[];enyoNodes.forEach(function(element,index){enyoNodesToProcess.push(index);});var segmentIndex=minimumSegments-1;var loops=0;while(enyoNodesToProcess.length>0){var segmentsToProcess=[];var nodeToProcessIndex;for(nodeToProcessIndex in enyoNodesToProcess){if(enyoNodesToProcess.hasOwnProperty(nodeToProcessIndex)){var nodeIndex=enyoNodesToProcess[nodeToProcessIndex];var enyoNode2=enyoNodes[nodeIndex];if(!enyoNode2.isSegmentsLeft){continue;}
enyoNode2.setFirstInvertedUniqueSegment(segmentIndex);var tail=enyoNode2.getIdTest().id;var isFound=false;var segmentToProcessIndex;for(segmentToProcessIndex=0;segmentToProcessIndex<segmentsToProcess.length;segmentToProcessIndex++){var segmentToProcess=segmentsToProcess[segmentToProcessIndex];var segmentNameToCompare=segmentToProcess.tail;if(tail===segmentNameToCompare){segmentToProcess.enyoNodeToProcessNodeIndex=null;segmentToProcess.enyoNode=null;segmentToProcess.count+=1;isFound=true;break;}}
if(!isFound){var segmentToProcess2={tail:tail,count:1,enyoNodeToProcessNodeIndex:nodeIndex,enyoNode:enyoNode2};segmentsToProcess.push(segmentToProcess2);}}}
var j;for(j=0;j<segmentsToProcess.length;j++){var segmentToProcess3=segmentsToProcess[j];if(segmentToProcess3.count===1){segmentToProcess3.enyoNode.setIsUnique();var nodeIndexToRemove=enyoNodesToProcess.indexOf(segmentToProcess3.enyoNodeToProcessNodeIndex++);enyoNodesToProcess.splice(nodeIndexToRemove,1);}}
if(loops>=maxSegments){enyoNodesToProcess=[];}
loops+=1;segmentIndex+=1;}
var o;for(o=0;o<enyoNodes.length;o++){var id=enyoNodes[o].getIdTest().id;if(enyoNodes[o].isValidForUnitTesting().isTesteable){testeableIdTests.push(id);}else{untesteableIdTests.push({enyoNodeIndex:o,incompatibleStringDetected:enyoNodes[o].isValidForUnitTesting().incompatibleString,id:id});}}
if(untesteableIdTests.length>0){OB.info("found "+untesteableIdTests.length+" ids of "+validEnyoObjects+" that are not valid for unit tests. execute printUntesteableIds() to get the list\n");untesteableIdTests.sort(function(a,b){if(a.incompatibleStringDetected!==b.incompatibleStringDetected){a.incompatibleStringDetected.localeCompare(b.incompatibleStringDetected);}
return a.id.localeCompare(b.id);});var enyoNodesToRemove=[];var notValidForUnitTestIndex;for(notValidForUnitTestIndex=0;notValidForUnitTestIndex<untesteableIdTests.length;notValidForUnitTestIndex++){var notValidForUnitTestRow=untesteableIdTests[notValidForUnitTestIndex];enyoNodesToRemove.push(notValidForUnitTestRow.enyoNodeIndex);}
enyoNodesToRemove.sort(function(a,b){return a-b;});enyoNodesToRemove.reverse();var enyoNodeToRemoveIndex;for(enyoNodeToRemoveIndex=0;enyoNodeToRemoveIndex<enyoNodesToRemove.length;enyoNodeToRemoveIndex++){enyoNodes.splice(enyoNodesToRemove[enyoNodeToRemoveIndex],1);}}
if(checkForRepeated){OB.info("");OB.info("Checking uniqueness...");var isRepeated=false;var i;for(i=0;i<enyoNodes.length;i++){var enyoNode6=enyoNodes[i];var idTest=enyoNode6.getIdTest();if(!idTest.isUnique){OB.info("REPEATED:\n\t"+enyoNode6.toString()+"\n");isRepeated=true;}}
if(isRepeated){throw{name:"Error",message:"all ids must be unique"};}else{OB.info("all the ids are unique");}}}
function getList(){if(enyoNodes===null){OB.info("lazy loading...");scan();OB.info("totalObjects: "+totalEnyoObjects+", enyoObjects: "+enyoObjectsCount+", nullCount: "+nullCount+", enyo ids to change: "+needsTheIdToBeRemovedInEnyoComponentCreation+", validObjects: "+validEnyoObjects+", id modifications: "+idModifications+", maxSegments: "+maxSegments+"\n");OB.info("... lazy load complete");}
return enyoNodes;}
function findWhere(idTest){var list=getList();var enyoNode=null;list.some(function(element){if(element.getIdTest().id===idTest){enyoNode=element;return;}});if(enyoNode!==null){var DOMObject=document.getElementById(enyoNode.idDOM);if(DOMObject){return enyoNode;}}
return null;}
TestRegistry.help=function(){OB.info("List of TestRegistry properties:");var publicProperties=Object.getOwnPropertyNames(this);publicProperties.sort();publicProperties.forEach(function(element){OB.info("  - "+element);});};TestRegistry.printTesteableIds=function(){getList();OB.info("final list of ids:");testeableIdTests.sort(function(a,b){if(a===b){a.localeCompare(b);}
return a.localeCompare(b);});var index;for(index=0;index<testeableIdTests.length;index++){OB.info(testeableIdTests[index]);}
OB.info("Total testeable ids: "+testeableIdTests.length+"\n");};TestRegistry.printUntesteableIds=function(){getList();var index;for(index=0;index<untesteableIdTests.length;index++){var notValidForUnitTestRow=untesteableIdTests[index];OB.info("'"+notValidForUnitTestRow.incompatibleStringDetected+"' in '"+notValidForUnitTestRow.id+"'");}
OB.info("Total untesteable ids: "+untesteableIdTests.length+"\n");};TestRegistry.registry=function(idTest,silent){var enyoNode=null;var rescan=true;if(enyoNodes===null){rescan=false;}
enyoNode=findWhere(idTest);if(enyoNode===null&&rescan){scan();enyoNode=findWhere(idTest);}
if(enyoNode!==null){return enyoNode;}
if(!silent){OB.warn("Cannot find any object with idTest = '"+idTest+"'");}
return null;};TestRegistry.registerAction=function(enyoObj){var content;if(TestRegistry.writingTest){if(enyoObj.testActions){enyoObj.testActions.forEach(function(action){switch(action){case'verify':TestRegistry.testSteps.push('verifyUI("'+enyoObj.idtest+'", "'+enyoObj.content+'");');console.log('verifyUI("'+enyoObj.idtest+'", "'+enyoObj.content+'");');break;case'tap':TestRegistry.testSteps.push('tapUI("'+enyoObj.idtest+'");');console.log('tapUI("'+enyoObj.idtest+'");');break;case'tapCatProd':TestRegistry.testSteps.push('tapCatProd("'+content+'");');console.log('tapCatProd("'+content+'");');break;default:console.log('Action: '+action+' is not defined. Review component: '+enyoObj.idtest);}});}else{if(enyoObj.content!==''){TestRegistry.testSteps.push('verifyUI("'+enyoObj.idtest+'", "'+enyoObj.content+'");');console.log('verifyUI("'+enyoObj.idtest+'", "'+enyoObj.content+'");');}
if(enyoObj.name==='renderCategory'){content=enyoObj.$.control2.children[0].getContent();}else if(enyoObj.name==='renderProduct'){content=enyoObj.children[1].children[0].getContent();}
if(enyoObj.$&&enyoObj.$.control2&&enyoObj.$.control2.children[0]&&enyoObj.tap){TestRegistry.testSteps.push('tapCatProd("'+content+'");');console.log('tapCatProd("'+content+'");');return;}
if(enyoObj.tap){TestRegistry.testSteps.push('tapUI("'+enyoObj.idtest+'");');console.log('tapUI("'+enyoObj.idtest+'");');return;}}}};var onmousedownFunc=function(){var enyoObj=TestRegistry.registry(this.getAttribute('idtest')).enyoObject;if(enyoObj.tap||enyoObj.content){TestRegistry.registerAction(enyoObj);}};TestRegistry.appendIdTestToDOM=function(){scan();var attributeAppendErrors=0;OB.info("adding idTests to the DOM");var enyoNodesIndex;for(enyoNodesIndex=0;enyoNodesIndex<enyoNodes.length;enyoNodesIndex++){var enyoNode3=enyoNodes[enyoNodesIndex];var DOMnode=document.getElementById(enyoNode3.idDOM);if(enyoNode3.enyoObject.idtest){DOMnode.setAttribute("idtest",enyoNode3.enyoObject.idtest);DOMnode.onmousedown=onmousedownFunc;continue;}
var idTest2=enyoNode3.getIdTest();if(idTest2.isTesteable&&idTest2.isUnique){if(DOMnode){enyoNode3.enyoObject.idtest=idTest2.id;DOMnode.setAttribute("idtest",idTest2.id);DOMnode.onmousedown=onmousedownFunc;}else{attributeAppendErrors+=1;OB.info(enyoNode3.idDOM,enyoNode3);}}}
if(attributeAppendErrors>0){OB.info("DOM append errors: "+attributeAppendErrors+"\n");}};}());OB.UTIL=window.OB.UTIL||{};enyo.kind({name:'OB.UI.Thumbnail',published:{img:null,imgUrl:null},tag:'div',contentType:'image/png',width:'49px',height:'49px','default':'../org.openbravo.mobile.core/assets/img/box.png',components:[{tag:'div',name:'image',style:'margin: auto; height: 100%; width: 100%; background-size: contain;'}],initComponents:function(){this.inherited(arguments);this.addClass('image-wrap');this.applyStyle('height',this.height);this.applyStyle('width',this.width);this.imgChanged();},drawImage:function(){var url;if(this.img||this.imgUrl){if(this.img==='iconBestSellers'){url='img/iconBestSellers.png';}else if(this.img){url='data:'+this.contentType+';base64,'+this.img;}else if(this.imgUrl){url=this.imgUrl;}}else{url=this['default'];}
this.$.image.applyStyle('background','#ffffff url('+url+') center center no-repeat');this.$.image.applyStyle('background-size','contain');},imgChanged:function(){this.drawImage();},imgUrlChanged:function(){this.drawImage();}});enyo.kind({name:'OB.UTIL.showAlert',classes:'alert alert-fade',style:'right:0; top:0; padding:2px; margin:0; cursor:pointer; border:0;',tap:function(){this.hide();},statics:{display:function(txt,title,type,keepVisible,idMessage,hidesIdMessage){if(!type){type='alert-warning';}
if(!OB.MobileApp.view){console.error("OB.MobileApp.view is not defined yet. Trying to show this alert:"+txt);return;}
var componentsArray=OB.MobileApp.view.$.alertQueue.getComponents(),i;for(i=0;i<componentsArray.length;i++){var element=componentsArray[i];if(element.idMessage===hidesIdMessage){element.destroy();continue;}
if(type==='alert-warning'||type==='alert-error'){if(element.txt===txt){element.destroy();}}}
OB.MobileApp.view.$.alertQueue.show();var alertLine=OB.MobileApp.view.$.alertQueue.createComponent({kind:'OB.UTIL.alertLine',title:title,txt:txt,type:type,keepVisible:keepVisible,idMessage:idMessage}).render();OB.UTIL.showAlert.showOrHideMessagesBubble();return alertLine;},showOrHideMessagesBubble:function(){var componentsArray=OB.MobileApp.view.$.alertQueue.getComponents();if(componentsArray.length===0){OB.MobileApp.view.$.alertQueue.removeClass('alert-fade-in');}else{OB.MobileApp.view.$.alertQueue.addClass('alert-fade-in');}}}});enyo.kind({name:'OB.UTIL.alertLine',classes:'',style:'padding:2px;',components:[{name:'title',style:'display:none; float: left; margin-right:10px;'},{name:'txt'}],initComponents:function(){var me=this,destroyTimeout;this.inherited(arguments);this.$.title.setContent(this.title);this.$.txt.setContent(this.txt);this.addClass(this.type);switch(this.type){case'alert-success':destroyTimeout=OB.MobileApp.model.get('permissions')?OB.MobileApp.model.get('permissions')['OBMOBC_AlertTimeoutForSuccess']:2000;break;case'alert-warning':destroyTimeout=OB.MobileApp.model.get('permissions')?OB.MobileApp.model.get('permissions')['OBMOBC_AlertTimeoutForWarning']:2000;break;case'alert-error':destroyTimeout=OB.MobileApp.model.get('permissions')?OB.MobileApp.model.get('permissions')['OBMOBC_AlertTimeoutForError']:4000;break;default:OB.error("DEVELOPER: The message of type '"+this.type+"' needs more code to be processed");}
if(!this.keepVisible){setTimeout(function(){me.hide();OB.UTIL.showAlert.showOrHideMessagesBubble();},destroyTimeout);}},hide:function(){this.destroy();}});enyo.kind({name:'OB.UTIL.showConfirmation',statics:{display:function(title,text,buttons,options){var container=OB.MobileApp.view.$.confirmationContainer?OB.MobileApp.view.$.confirmationContainer:OB.MobileApp.view,components=container.getComponents?container.getComponents():[],i,dialog;function getDialog(){var bodyContent;if(Array.isArray(text)){var textComponents=[];_.each(text,function(currentText){if(typeof currentText==='string'||currentText instanceof String){textComponents.push({kind:'enyo.Control',content:currentText});}else{textComponents.push(currentText);}});bodyContent={kind:'enyo.Control',components:textComponents};}else{bodyContent={kind:'enyo.Control',content:text};}
var box={kind:'OB.UI.ModalAction',name:'dynamicConfirmationPopup',header:title,bodyContent:bodyContent,autoDismiss:!OB.UTIL.isNullOrUndefined(options)&&!OB.UTIL.isNullOrUndefined(options.autoDismiss)?options.autoDismiss:true,executeOnShow:function(){if(options&&options.onShowFunction){options.onShowFunction(this);}
return true;},executeOnHide:function(){if(options&&!this.args.actionExecuted&&options.onHideFunction){options.onHideFunction(this);}
return true;},bodyButtons:{}};if(options&&options.style){box.style=options.style;}
if(options&&options.confirmFunction){box.confirm=options.confirmFunction;}
if(!buttons){box.bodyButtons={kind:'OB.UI.ModalDialogButton',name:'confirmationPopup_btnOk',isDefaultAction:true,content:OB.I18N.getLabel('OBMOBC_LblOk'),tap:function(){this.doHideThisPopup();}};box.confirm=function(){if(this.$.bodyButtons.$.confirmationPopup_btnOk){this.$.bodyButtons.$.confirmationPopup_btnOk.tap();}};}else{box.bodyButtons.components=[];_.forEach(buttons,function(btn){var componentName;if(btn&&btn.name){componentName=btn.name;}else{componentName='confirmationPopup_btn'+btn.label;}
var button={kind:'OB.UI.ModalDialogButton',name:componentName,content:btn.label,tap:function(){var params={actionExecuted:false};if(btn.action){params.actionExecuted=true;btn.action();}
this.doHideThisPopup({args:params});}};box.bodyButtons.components.push(button);if(btn.isConfirmButton){box.confirm=function(){this.$.bodyButtons.$[button.name].tap();};}},this);}
return box;}
for(i=0;i<components.length;i++){components[i].destroy();}
dialog=container.createComponent(getDialog());dialog.show();OB.UTIL.showLoading(false);}}});OB.UTIL.isSupportedBrowser=function(){return OB.UTIL.getSupportedBrowserInfo().isAllowed;};OB.UTIL.getSupportedBrowserInfo=function(){var pl=enyo.platform;var browserDef,version,i;for(i=0;i<OB.UTIL.SupportedBrowsers.length;i++){browserDef=OB.UTIL.SupportedBrowsers[i];version=pl[browserDef.name];if(version){if(version<browserDef.allowed){return{enyoPlatform:pl,browser:browserDef,isAllowed:false,isSupported:false,isPreferred:false};}else if(version<browserDef.required){return{enyoPlatform:pl,browser:browserDef,isAllowed:true,isSupported:false,isPreferred:false};}else if(version<browserDef.preferred){return{enyoPlatform:pl,browser:browserDef,isAllowed:true,isSupported:true,isPreferred:false};}else{return{enyoPlatform:pl,browser:browserDef,isAllowed:true,isSupported:true,isPreferred:true};}}}
return{enyoPlatform:pl,browser:null,isAllowed:false,isSupported:false,isPreferred:false};};OB.UTIL.showLoadingConditions=new Backbone.Collection();OB.UTIL.showLoading=function(value,condition){if(value){OB.MobileApp.view.$.containerLoading_label.setContent(OB.I18N.getLabel('OBMOBC_LblLoading'));if(condition){OB.UTIL.showLoadingConditions.push(condition);}
if(OB.MobileApp.view.$.containerLoading_fillingBar.hasNode()&&!OB.MobileApp.model.get('isLoggingIn')){OB.MobileApp.view.$.containerLoading_fillingBar.node.style.width='100%';OB.MobileApp.view.$.containerLoading_loadedModels.hide();}
OB.MobileApp.view.$.containerWindow.hide();OB.MobileApp.view.$.containerLoading.show();if(!OB.UTIL.showLoading.synchId){OB.UTIL.showLoading.synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('showLoading');}}else{if(condition){OB.UTIL.showLoadingConditions.pop(condition);}
if(!OB.UTIL.isNullOrUndefined(OB.MobileApp.view)&&OB.UTIL.showLoadingConditions.length===0&&!OB.UTIL.isNullOrUndefined(OB.MobileApp.view.$.containerLoading)){OB.MobileApp.view.$.containerLoading_loadedModels.hide();OB.MobileApp.view.$.containerLoading.hide();OB.MobileApp.view.$.containerWindow.show();}
if(!OB.UTIL.isNullOrUndefined(OB.UTIL.showLoading.synchId)){OB.UTIL.SynchronizationHelper.finished(OB.UTIL.showLoading.synchId,'showLoading');OB.UTIL.showLoading.synchId=null;}}};OB.UTIL.showLoggingOut=function(value){if(value){OB.MobileApp.view.$.containerLoggingOut_label.setContent(OB.I18N.getLabel('OBMOBC_LblLoggingOut'));OB.MobileApp.view.$.containerWindow.hide();OB.MobileApp.view.$.containerLoggingOut.show();}else{OB.MobileApp.view.$.containerLoggingOut.hide();OB.MobileApp.view.$.containerWindow.show();}};OB.UTIL.showSuccess=function(s){return OB.UTIL.showAlert.display(s,OB.I18N.getLabel('OBMOBC_LblSuccess'),'alert-success');};OB.UTIL.showWarning=function(s){return OB.UTIL.showAlert.display(s,OB.I18N.getLabel('OBMOBC_LblWarning'),'alert-warning');};OB.UTIL.showError=function(s){OB.error(s);if(OB.MobileApp.model.hasPermission('OBMOBC_EnableErrorPopup',true)){return OB.UTIL.showConfirmation.display("",s);}else{return OB.UTIL.showAlert.display(s,OB.I18N.getLabel('OBMOBC_LblError'),'alert-error');}};OB.UTIL.showStatus=function(s){return OB.UTIL.showAlert.display(s,'Wait','');};OB.UTIL.showI18NSuccess=function(idLabel,hidesIdLabel){return OB.UTIL.showAlert.display(OB.I18N.getLabel(idLabel),OB.I18N.getLabel('OBMOBC_LblSuccess'),'alert-success',false,idLabel,hidesIdLabel);};OB.UTIL.showI18NWarning=function(idLabel,hidesIdLabel){return OB.UTIL.showAlert.display(OB.I18N.getLabel(idLabel),OB.I18N.getLabel('OBMOBC_LblWarning'),'alert-warning',false,idLabel,hidesIdLabel);};OB.UTIL.showI18NError=function(idLabel,hidesIdLabel){return OB.UTIL.showAlert.display(OB.I18N.getLabel(idLabel),OB.I18N.getLabel('OBMOBC_LblWarning'),'alert-error',false,idLabel,hidesIdLabel);};OB.UTIL.getAllChildsSorted=function(component,result){var i;if(Object.prototype.toString.call(component)!=='[object Array]'){component=[component];}
if(!result){result=[];}
for(i=0;i<component.length;i++){result.push(component[i]);if(typeof component[i].children!=='undefined'&&component[i].children.length!==0){result=OB.UTIL.getAllChildsSorted(component[i].children,result);}}
return result;};OB.UTIL.showLoadingMessage=function(message){if(OB.MobileApp.view&&OB.MobileApp.model.get('isLoggingIn')){OB.MobileApp.view.$.containerLoading_loadedModels.show();OB.MobileApp.view.$.containerLoading_loadedModels.setContent(message);}};OB.UTIL.startLoadingSteps=function(){OB.UTIL.loadingSteps=3;OB.UTIL.loadingSteps+=OB.UTIL.getNonLocalModels().length;OB.UTIL.currentLoadingStep=0;};OB.UTIL.completeLoadingStep=function(){var width;if(OB.MobileApp.view&&OB.MobileApp.model.get('isLoggingIn')){OB.UTIL.currentLoadingStep+=1;width=(OB.UTIL.currentLoadingStep/OB.UTIL.loadingSteps)*100+'%';if(OB.MobileApp.view.$.containerLoading_fillingBar.hasNode()){OB.MobileApp.view.$.containerLoading_fillingBar.node.style.width=width;}}};OB.UTIL.getNonLocalModels=function(){var nonLocalModels=[];_.each(OB.MobileApp.model.windowRegistry.registeredWindows,function(windowp){var windowClass,windowName,datasources,w,c,path;windowClass=windowp.windowClass;windowName=windowp.route;if(OB&&OB.DATA&&OB.DATA[windowName]){datasources=OB.DATA[windowName];}else if(windowClass.prototype&&windowClass.prototype.windowmodel&&windowClass.prototype.windowmodel.prototype&&windowClass.prototype.windowmodel.prototype.models){datasources=windowClass.prototype.windowmodel.prototype.models;}else if(typeof windowClass==='string'){w=window;path=windowClass.split('.');for(c=0;c<path.length;c++){w=w[path[c]];}
if(w.prototype&&w.prototype.windowmodel&&w.prototype.windowmodel.prototype&&w.prototype.windowmodel.prototype.models){datasources=w.prototype.windowmodel.prototype.models;}}
_.each(datasources,function(model){var modelObj;if(model&&model.modelName){modelObj=OB.Model[model.modelName];}else if(model&&model.prototype&&model.prototype.modelName){modelObj=OB.Model[model.prototype.modelName];}
if(modelObj&&modelObj.prototype&&modelObj.prototype.modelName&&modelObj.prototype.source&&!modelObj.prototype.local){nonLocalModels.push(modelObj.prototype);}});});return nonLocalModels;};OB.UTIL.createElipsisEffect=function(enyoObject,options){var maxCharactersPerLine=11;var ellipseText='...';var maxWordCharactersWithEllipsis=maxCharactersPerLine-ellipseText.length;var maxWords=4;var truncated=false;var line1='';var line2='';var line1Try='';var line2Try='';var line1IsFull=false;var line2IsFull=false;var j=0;var k=0;var origContent=enyoObject.getContent();var divContentArray,reversedContentArray;options=options||{};if(options.reUseOriginalContent===true){if(OB.UTIL.isNullOrUndefined(enyoObject.origContent)){enyoObject.origContent=origContent;}else{origContent=enyoObject.origContent;}}
if(enyo.Panels.isScreenNarrow()){if(window.innerWidth>=650){maxCharactersPerLine=13;maxWordCharactersWithEllipsis=maxCharactersPerLine-ellipseText.length;}}else{if(window.innerWidth>=1300){maxCharactersPerLine=13;maxWordCharactersWithEllipsis=maxCharactersPerLine-ellipseText.length;}
if(window.innerWidth<=1000){maxCharactersPerLine=9;maxWordCharactersWithEllipsis=maxCharactersPerLine-ellipseText.length;}}
if(OB.UTIL.isNullOrUndefined(origContent)){return;}else{divContentArray=origContent.split(' ');reversedContentArray=origContent.split(' ');reversedContentArray.reverse();if(divContentArray.length===1){if(divContentArray[0].length<=maxCharactersPerLine){line1=divContentArray[0];}else{line1=divContentArray[0].substr(0,maxWordCharactersWithEllipsis)+ellipseText;}
enyoObject.setContent(line1);return;}else{if(divContentArray.length>maxWords){while(divContentArray.length>maxWords){divContentArray.pop();truncated=true;}}
for(j=0;j<=divContentArray.length-1;j++){if(line1.length<maxCharactersPerLine&&!line1IsFull){line1Try=line1;if(line1Try.length===0){line1Try=line1Try+divContentArray[j];}else{line1Try=line1Try+' '+divContentArray[j];}
if(line1Try.length<=maxCharactersPerLine){if(line1.length===0){line1=line1+reversedContentArray.pop();}else{line1=line1+' '+reversedContentArray.pop();}}else{line1IsFull=true;break;}}else{break;}}
line1IsFull=true;for(k=j;k<=divContentArray.length-1;k++){if(line2.length<maxCharactersPerLine&&!line2IsFull){line2Try=line2;if(line2Try.length===0){line2Try=line2Try+divContentArray[k];}else{line2Try=line2Try+' '+divContentArray[k];}
if(line2Try.length<=maxCharactersPerLine){if(line2.length===0){line2=line2+reversedContentArray.pop();}else{line2=line2+' '+reversedContentArray.pop();}}else{line2IsFull=true;if(line2.length===0){line2=line2+reversedContentArray.pop();}else{line2=line2+' '+reversedContentArray.pop();}
break;}}else{line2IsFull=true;break;}}
if(line2IsFull){line2=line2.substr(0,maxWordCharactersWithEllipsis)+ellipseText;}else{if(truncated){if((line2+ellipseText).length<=maxCharactersPerLine){line2+=ellipseText;}else{line2=line2.substr(0,maxWordCharactersWithEllipsis)+ellipseText;}}}
if(line1.length>0){enyoObject.setContent(line1+' '+line2);}else{enyoObject.setContent(line2);}
return;}}};(function(){OB.DEC=window.OB.DEC||{};var scale=2;var roundingmode=BigDecimal.prototype.ROUND_HALF_UP;var toBigDecimal=function(a){return new BigDecimal(a.toString());};var toNumber=function(big,arg_scale){var localscale=arg_scale||scale;if(big.scale){return parseFloat(big.setScale(localscale,roundingmode).toString(),10);}else{if(_.isNumber(big)){return big;}else{OB.error("toNumber: Argument cannot be converted toNumber",big);}}};OB.DEC.Zero=toNumber(BigDecimal.prototype.ZERO);OB.DEC.One=toNumber(BigDecimal.prototype.ONE);OB.DEC.getScale=function(){return scale;};OB.DEC.getRoundingMode=function(){return roundingmode;};OB.DEC.isNumber=function(a){return typeof(a)==='number'&&!isNaN(a);};OB.DEC.add=function(a,b,arg_scale){return toNumber(toBigDecimal(a).add(toBigDecimal(b)),arg_scale);};OB.DEC.sub=function(a,b,arg_scale){return toNumber(toBigDecimal(a).subtract(toBigDecimal(b)),arg_scale);};OB.DEC.mul=function(a,b,arg_scale){return toNumber(toBigDecimal(a).multiply(toBigDecimal(b)),arg_scale);};OB.DEC.div=function(a,b,arg_scale){return toNumber(toBigDecimal(a).divide(toBigDecimal(b),scale,roundingmode),arg_scale);};OB.DEC.compare=function(a){return toBigDecimal(a).compareTo(BigDecimal.prototype.ZERO);};OB.DEC.number=function(jsnumber){return jsnumber;};OB.DEC.setContext=function(s,r){scale=s;roundingmode=r;};OB.DEC.toBigDecimal=function(a){return toBigDecimal(a);};OB.DEC.toNumber=function(a,arg_scale){return toNumber(a,arg_scale);};OB.DEC.abs=function(a,arg_scale){return toNumber(toBigDecimal(a).abs(),arg_scale);};}());OB.UTIL.HookManager=new(Backbone.Model.extend({registerHook:function(qualifier,func){var qualifierFuncs;if(!enyo.isFunction(func)){window.error('Error trying to register hook for',qualifier,'func',func,'is not a function');return;}
qualifierFuncs=this.get(qualifier)||[];qualifierFuncs.unshift(func);this.set(qualifier,qualifierFuncs);},executeHooks:function(qualifier,args,callback){var hooks;if(callback&&!enyo.isFunction(callback)){window.error('Error while executing hooks for',qualifier,'callback is not a function',callback);return;}
hooks=_.clone(this.get(qualifier))||[];if(callback){hooks.unshift(callback);}
this.callbackExecutor(args,hooks);},callbackExecutor:function(args,callbacks){var func;func=callbacks.pop();if(func){func(args,callbacks);}}}))();enyo.kind({name:'OB.UI.Clock',tag:'div',components:[{tag:'div',classes:'clock-time',name:'clock'},{tag:'div',classes:'clock-date',name:'date'}],initComponents:function(){var me=this;var updateClock=function(){setTimeout(function(){var d=new Date();if(!me.$.clock){return;}
me.$.clock.setContent(OB.I18N.formatHour(d));me.$.date.setContent(OB.I18N.formatDate(d));},0);};this.inherited(arguments);updateClock();setInterval(updateClock,1000);}});enyo.kind({name:'OB.UI.WindowView',windowmodel:null,create:function(){var me=this;this.inherited(arguments);this.model=new this.windowmodel();if(this.model.initModels){var initUI=function(callback){if(me.init){me.init();}
callback();};var renderUI=function(callback){OB.UTIL.HookManager.executeHooks('ModelReady:'+me.name,null,function(){OB.MobileApp.model.trigger('window:ready',this);var loginTimer=new Date().getTime()-window.localStorage.getItem('LOGINTIMER');OB.info("Total time since logged in: "+(loginTimer/1000)+" seconds");callback();});};this.model.initModels_initUI_loadModels_renderUI(initUI,renderUI);}else{OB.UTIL.VersionManagement.deprecated(30610,function(){this.model.on('windowReady',function(){if(this.init){this.init();}
OB.UTIL.HookManager.executeHooks('ModelReady:'+me.name,null,function(){OB.MobileApp.model.trigger('window:ready',this);var loginTimer=new Date().getTime()-window.localStorage.getItem('LOGINTIMER');OB.info("Total time since logged in: "+(loginTimer/1000)+" seconds");});},this);this.model.load();},null,this);}},statics:{initChildren:function(view,model){if(!view||!view.getComponents){return;}
enyo.forEach(view.getComponents(),function(child){OB.UI.WindowView.initChildren(child,model);if(child.init){child.init(model);}});},registerPopup:function(windowClass,dialogToAdd){var kind;kind=enyo.getObject(windowClass);if(!_.isEmpty(kind)){kind.prototype.popups.push({dialog:dialogToAdd,windowClass:windowClass});}else{OB.UTIL.showWarning("An error occurs adding the pop up "+dialogToAdd.kind+". The window class "+windowClass+" cannot be found.");}},destroyModels:function(view){var p;if(!view){return;}
for(p in view){if(view.hasOwnProperty(p)&&view[p]&&view[p].off){view[p].off();delete view[p];}}
if(!view.getComponents){return;}
enyo.forEach(view.getComponents(),function(child){OB.UI.WindowView.destroyModels(child);});}},popups:[],init:function(){enyo.forEach(this.popups,function(dialog){if(dialog.windowClass===this.kindName){this.createComponent(dialog.dialog);}},this);OB.UI.WindowView.initChildren(this,this.model);},destroy:function(){if(this.model){this.model.setOff();}
this.model=null;OB.UI.WindowView.destroyModels(this);try{this.inherited(arguments);}catch(e){OB.error('error destroying components',e);}}});OB.Customizations={};OB.Customizations.pointOfSale={};OB.Customizations.pointOfSale.dialogs={push:function(kind){OB.warn('WARNING! OB.Customizations.pointOfSale.dialogs has been deprecated. Use OB.UI.WindowView.registerPopup() instead.');OB.UI.WindowView.registerPopup('OB.OBPOSPointOfSale.UI.PointOfSale',kind);}};OB.Customizations.pointOfSale.dialogs=OB.Customizations.pointOfSale.dialogs||[];enyo.kind({name:'OB.UI.MultiColumn',isRightSideShown:true,handlers:{onSwitchColumn:'switchColumn',onpostresize:'panelsResized',onShowColumn:'showColumn'},events:{onNarrowChanged:''},published:{leftToolbar:null,leftPanel:null,rightToolbar:null,rightPanel:null},components:[{kind:'Panels',name:'panels',arrangerKind:'CollapsingArranger',style:'height: 690px;',components:[{name:'left',classes:'menu-option',components:[{classes:'row',style:'margin-bottom: 1px;',name:'leftToolbar'},{classes:'span12',name:'leftPanel'}]},{name:'right',classes:'menu-option',components:[{classes:'row',style:'height: 57px; margin-bottom: 5px;',name:'rightToolbar'},{classes:'span12',name:'rightPanel'}]}]}],statics:{isSingleColumn:function(){return enyo.Panels.isScreenNarrow();}},menuChanged:function(){this.$.leftMenu.setMenu(this.menu);},panelsResized:function(){var newNarrow=enyo.Panels.isScreenNarrow(),i,panels,zoom;if(window.innerHeight){zoom=document.body.style.zoom||1;this.$.panels.applyStyle('height',(window.innerHeight-14)/zoom+'px');}
if(this.narrow===newNarrow){return false;}
this.narrow=newNarrow;if(newNarrow){this.$.panels.draggable=this.isRightSideShown;}else{this.$.panels.draggable=false;this.$.panels.setIndex(0);}
panels=this.$.panels.getPanels();for(i=0;i<panels.length;i++){if(newNarrow){panels[i].removeClass('menu-option-transparent');panels[i].addClass('menu-option');}else{panels[i].removeClass('menu-option');panels[i].addClass('menu-option-transparent');}}
this.waterfall('onNarrowChanged');},switchColumn:function(){var idx=this.$.panels.getIndex();if(!this.isRightSideShown){return;}
idx=idx===0?1:0;this.$.panels.setIndex(idx);},showColumn:function(inSender,inEvent){var idx=inEvent.colNum;if(!enyo.Panels.isScreenNarrow()){return;}
if(!idx){this.switchColumn();}else{this.$.panels.setIndex(idx);}},setRightShowing:function(showing){this.isRightSideShown=showing;this.$.rightToolbar.setShowing(showing);this.$.rightPanel.setShowing(showing);this.$.panels.draggable=showing;if(!showing){this.$.panels.setIndex(0);}
if(this.$.leftToolbar.$.leftToolbar){this.$.leftToolbar.$.leftToolbar.$.rightHolder.$.colswitcher.$.button.setDisabled(!showing);}},initComponents:function(){var leftToolbar,rightToolbar,emptyPanel={kind:'Component'},emptyToolbar={kind:'OB.UI.MultiColumn.Toolbar'};this.leftToolbar=this.leftToolbar||emptyToolbar;this.leftPanel=this.leftPanel||emptyPanel;this.rightToolbar=this.rightToolbar||emptyToolbar;if(!this.rightPanel){this.rightPanel=emptyPanel;this.leftToolbar.emptyRightPanel=true;}
leftToolbar=_.clone(this.leftToolbar);rightToolbar=_.clone(this.rightToolbar);this.inherited(arguments);leftToolbar.position='left';rightToolbar.position='right';this.$.leftToolbar.createComponent(leftToolbar);this.$.rightToolbar.createComponent(rightToolbar);this.$.leftPanel.createComponent(this.leftPanel);this.$.rightPanel.createComponent(this.rightPanel);this.setRightShowing(this.isRightSideShown);}});enyo.kind({name:'OB.UI.MultiColumn.Toolbar',handlers:{onNarrowChanged:'toolbarResized'},components:[{classes:'span12',style:'margin-bottom: 5px; height: 57px;',components:[{name:'theToolbar',components:[{name:'leftHolder'},{name:'standardToolbar',components:[{name:'toolbar',tag:'ul',classes:'unstyled nav-pos row-fluid'}]},{name:'rightHolder'}]}]}],initComponents:function(){this.inherited(arguments);if(this.position==='left'){if(!this.emptyRightPanel){this.$.rightHolder.createComponent({kind:'OB.UI.OB.UI.MultiColumn.Toolbar.ColumnSwitcher',name:'colswitcher'});}
if(this.showMenu){this.$.leftHolder.createComponent({kind:'OB.UI.MainMenu',customMenuEntries:this.menuEntries,showWindowsMenu:this.showWindowsMenu});}}
enyo.forEach(this.buttons,function(btn){if(!btn.span){btn.width=100/this.buttons.length;}
this.$.toolbar.createComponent({kind:'OB.UI.OB.UI.MultiColumn.Toolbar.Button',button:btn});},this);if(this.position==='right'){this.$.leftHolder.createComponent({kind:'OB.UI.OB.UI.MultiColumn.Toolbar.ColumnSwitcher',name:'colswitcher'});}},toolbarResized:function(){var isNarrow=enyo.Panels.isScreenNarrow(),hasMenu=this.position==='left'&&this.showMenu;if(isNarrow&&!this.emptyRightPanel){if(hasMenu){this.$.standardToolbar.removeClass('span10');this.$.standardToolbar.addClass('span8');}else{this.$.standardToolbar.removeClass('span12');this.$.standardToolbar.addClass('span10');}
if(this.$.leftHolder.$.colswitcher){this.$.leftHolder.$.colswitcher.$.button.show();}
if(this.$.rightHolder.$.colswitcher){this.$.rightHolder.$.colswitcher.$.button.show();}}else{if(hasMenu){this.$.standardToolbar.removeClass('span8');this.$.standardToolbar.addClass('span10');}else{this.$.standardToolbar.removeClass('span10');this.$.standardToolbar.addClass('span12');}
if(this.$.leftHolder.$.colswitcher){this.$.leftHolder.$.colswitcher.$.button.hide();}
if(this.$.rightHolder.$.colswitcher){this.$.rightHolder.$.colswitcher.$.button.hide();}}
return true;}});enyo.kind({name:'OB.UI.OB.UI.MultiColumn.Toolbar.ColumnSwitcher',events:{onSwitchColumn:''},classes:'span2',components:[{components:[{attributes:{style:'margin: 0px 5px 0px 5px;'},components:[{kind:'OB.UI.ToolbarButton',name:'button',icon:'btn-icon btn-icon-switchColumn',tap:function(){this.bubble('onSwitchColumn');}}]}]}]});enyo.kind({name:'OB.UI.OB.UI.MultiColumn.Toolbar.Button',tag:'li',components:[{name:'theButton',attributes:{style:'margin: 0px 5px 0px 5px;'}}],initComponents:function(){var span=this.button.span||(this.button.kind==='OB.UI.MultiColumn.EmptyToolbar'?'12':'4');this.inherited(arguments);if(this.button.width){this.setStyle('width: '+this.button.width+'% !important;');}else{this.addClass('span'+span);}
this.$.theButton.createComponent(this.button);}});enyo.kind({name:'OB.UI.MultiColumn.EmptyToolbar',kind:'OB.UI.ToolbarButton',classes:'btnlink-gray',style:'font-weight: bold; font-size: 130%;',initComponents:function(){this.inherited(arguments);}});enyo.kind({name:'OB.UI.ScrollableTableHeader',style:'border-bottom: 1px solid #cccccc;',handlers:{onScrollableTableHeaderChanged:'scrollableTableHeaderChanged_handler'}});enyo.kind({name:'OB.UI.ScrollableTable',published:{collection:null,listStyle:null,selectionMode:'single'},events:{onSetMultiSelection:''},autoSelectOnReset:true,getValue:function(arg,lineIndex){if(this.$.tbody.children[lineIndex].children[0].getValue){return this.$.tbody.children[lineIndex].children[0].getValue(arg);}else{OB.warn('getValue is not present in line '+lineIndex+' component of '+this.name);return null;}},getNumberOfLines:function(){return this.$.tbody.children.length;},getLineByIndex:function(lineIndex){if(this.$.tbody.children[lineIndex].children[0]){return this.$.tbody.children[lineIndex].children[0];}else{return undefined;}},getLineByIndexAndClick:function(lineIndex){var selectedLine=this.getLineByIndex(lineIndex);if(!_.isUndefined(selectedLine)){selectedLine.tap();}
return selectedLine;},getLineByValue:function(arg,value){var selectedLine;selectedLine=_.find(this.$.tbody.children,function(line){if(line.children[0].getValue&&line.children[0].getValue(arg)===value){return true;}});if(!_.isUndefined(selectedLine)){return selectedLine.children[0];}else{return undefined;}},getLineByValueAndClick:function(arg,value){var selectedLine=this.getLineByValue(arg,value);if(!_.isUndefined(selectedLine)){selectedLine.tap();}
return selectedLine;},isSelectableLine:function(model){return true;},components:[{name:'theader'},{components:[{kind:'Scroller',name:'scrollArea',thumb:true,horizontal:'hidden',components:[{name:'tbody',tag:'ul',classes:'unstyled',showing:false}]}]},{name:'tlimit',showing:false,style:'border-bottom: 1px solid #cccccc; padding: 15px; text-align:center; font-weight: bold; color: #a1a328'},{name:'tinfo',showing:false,style:'border-bottom: 1px solid #cccccc; padding: 15px; font-weight: bold; color: #cccccc'},{name:'tempty'}],create:function(){var tableName=this.name||'';this.inherited(arguments);if(!this.renderLine){throw enyo.format('Your list %s needs to define a renderLine kind',tableName);}
if(!this.renderEmpty){throw enyo.format('Your list %s needs to define a renderEmpty kind',tableName);}
if(this.collection){this.collectionChanged(null);}
this.$.tlimit.setContent(OB.I18N.getLabel('OBMOBC_DataLimitReached'));},listStyleChanged:function(oldSTyle){if(this.listStyle==='checkboxlist'){this.collection.trigger('unSelectAll');}},collectionChanged:function(oldCollection){this.selected=null;if(this.renderHeader&&this.$.theader.getComponents().length===0){this.$.theader.createComponent({kind:this.renderHeader});}
if(this.renderEmpty&&this.$.tempty.getComponents().length===0){this.$.tempty.createComponent({kind:this.renderEmpty});}
if(this.scrollAreaMaxHeight){this.$.scrollArea.setMaxHeight(this.scrollAreaMaxHeight);}
if(!this.collection){return;}
this.func_selected=function(model){if(this.destroyed){this.collection.off('selected',this.func_selected);return true;}
if(!model&&this.listStyle&&this.listStyle!=='checkboxlist'){if(this.selected){this.selected.addRemoveClass('selected',false);}
this.selected=null;}};this.collection.on('selected',this.func_selected,this);this.func_unSelectAll=function(col){if(this.destroyed){this.collection.off('unSelectAll',this.func_unSelectAll);return true;}
this.collection.each(function(model){model.trigger('unselected');});};this.collection.on('unSelectAll',this.func_unSelectAll,this);this.func_checkAll=function(col){if(this.destroyed){this.collection.off('checkAll',this.func_checkAll);return true;}
this.collection.each(function(model){model.trigger('check');});};this.collection.on('checkAll',this.func_checkAll,this);this.func_unCheckAll=function(col){if(this.destroyed){this.collection.off('unCheckAll',this.func_unCheckAll);return true;}
this.collection.each(function(model){model.trigger('uncheck');});};this.collection.on('unCheckAll',this.func_unCheckAll,this);this.func_add=function(model,prop,options){if(this.destroyed){this.collection.off('add',this.func_add);return true;}
this.$.tempty.hide();this.$.tbody.show();this._addModelToCollection(model,options.index);if(this.listStyle==='list'){if(!this.selected){model.trigger('selected',model);}}else if(this.listStyle==='edit'){model.trigger('selected',model);}
this.setScrollAfterAdd();};this.collection.on('add',this.func_add,this);this.func_remove=function(model,prop,options){var index=options.index,indexToPoint=index-1;if(this.destroyed){this.collection.off('remove',this.func_remove);return true;}
if(this.$.tbody.getComponents()[index]){this.$.tbody.getComponents()[index].destroy();}
if(this.collection){if(index>=this.collection.length){if(this.collection.length===0){this.collection.trigger('selected');}else{this.collection.at(this.collection.length-1).trigger('selected',this.collection.at(this.collection.length-1));}}else{this.collection.at(index).trigger('selected',this.collection.at(index));}
if(this.collection.length===0){this.$.tbody.hide();this.$.tempty.show();}else{if(indexToPoint<0){indexToPoint=0;}
if(this.$.tbody.getComponents()[indexToPoint]){this.getScrollArea().scrollToControl(this.$.tbody.getComponents()[indexToPoint]);}}}};this.collection.on('remove',this.func_remove,this);this.func_reset=function(a,b,c){var modelsel,dataLimit,showTlimit=false;if(this.destroyed){this.collection.off('reset',this.func_reset);return true;}
this.$.tlimit.hide();this.$.tbody.hide();this.$.tempty.show();this.$.tbody.destroyComponents();if(this.collection){if(this.collection.size()===0){this.$.tbody.hide();this.$.tempty.show();if(this.executeAfterClear){this.executeAfterClear();}
this.collection.trigger('selected');}else{dataLimit=this.collection.at(0).tempDataLimit?this.collection.at(0).tempDataLimit:this.collection.at(0).dataLimit;this.$.tempty.hide();this.$.tbody.show();if(dataLimit!==-1&&dataLimit<this.collection.length){this.collection.reset(this.collection.models.slice(0,dataLimit),{silent:true});showTlimit=true;}
this.collection.at(0).tempDataLimit=undefined;this.collection.each(function(model){this._addModelToCollection(model);},this);this.getScrollArea().render();this.$.tlimit.setShowing(showTlimit);if(this.executeAfterRender){this.executeAfterRender();}
if(this.listStyle==='list'){modelsel=this.collection.at(0);modelsel.trigger('selected',modelsel);}else if(this.listStyle==='edit'){modelsel=this.collection.at(this.collection.size()-1);if(this.autoSelectOnReset){modelsel.trigger('selected',modelsel);}}}}};this.collection.on('reset',this.func_reset,this);this.func_info=function(info){if(this.destroyed){this.collection.off('info',this.func_info);return true;}
if(info){this.$.tinfo.setContent(OB.I18N.getLabel(info));this.$.tinfo.show();}else{this.$.tinfo.hide();}};this.collection.on('info',this.func_info,this);this.collection.trigger('reset');},getScrollArea:function(){return this.$.scrollArea;},setScrollAfterAdd:function(){this.getScrollArea().scrollToBottom();},getHeader:function(){var tableName=this.name||'';if(this.$.theader.getComponents()){if(this.$.theader.getComponents().length>0){if(this.$.theader.getComponents().length===1){return this.$.theader.getComponents()[0];}else{throw enyo.format('Each scrolleable table ahould have only one component as header',tableName);}}}
return null;},getHeaderValue:function(){var header=this.getHeader();if(header){if(header.getValue){return header.getValue();}else{return header.getContent();}}
return'';},_addModelToCollection:function(model,index){var i,models=[];var components=this.$.tbody.getComponents();if(!(_.isUndefined(index))&&!(_.isNull(index))&&index<components.length){for(i=0;i<components.length;i++){models[i]={renderlinemodel:components[i].renderline.model,checked:components[i].checked};}
this.$.tbody.destroyComponents();for(i=0;i<models.length;i++){if(i===index){this._createComponentForModel(model);}
this._createComponentForModel(models[i].renderlinemodel,models[i].checked);}}else{this._createComponentForModel(model);}},_createComponentForModel:function(model,checked){var tr=this.$.tbody.createComponent({tag:'li'}).render();tr.renderline=tr.createComponent({kind:this.renderLine,model:model,columns:this.columns}).render();tr.checked=checked;model.on('change',function(){model.trigger('updateView');},this);model.on('updateView',function(){if(tr.destroyed){return;}
tr.destroyComponents();tr.renderline=tr.createComponent({kind:this.renderLine,model:model}).render();},this);model.on('selected',function(){if(this.listStyle&&this.listStyle==='nonselectablelist'){return;}else if(this.listStyle&&this.listStyle!=='checkboxlist'){var selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';if(tr.destroyed){return;}
if(this.scrollableTableGroup){var elems=$('.'+this.scrollableTableGroup+'_activeScrollableTable');if(elems.length===0){$('#'+this.id).addClass(this.scrollableTableGroup+'_activeScrollableTable');}else if(elems&&elems.length===1&&elems[0].id!==this.id){elems.removeClass(this.scrollableTableGroup+'_activeScrollableTable');$('#'+this.id).addClass(this.scrollableTableGroup+'_activeScrollableTable');}}
if(this.selectionMode==='single'&&!(OB.MobileApp.model.ctrlPressed||OB.MobileApp.model.shiftPressed)){var selectedRows=this.getSelectedRows();if(selectedRows.length>1){var i;for(i=0;i<selectedRows.length;i++){selectedRows[i].addRemoveClass(selectedCssClass,false);}}
if(this.selected){this.selected.addRemoveClass(selectedCssClass,false);}
this.selected=tr;this.selected.addRemoveClass(selectedCssClass,true);}else{this.selected=tr;if(OB.MobileApp.model.shiftPressed){var selectIndex=this.getMultiSelectIndex(tr);if(selectIndex.current<=selectIndex.first){this.doMultiSelection(selectIndex.current,selectIndex.last);}else{this.doMultiSelection(selectIndex.first,selectIndex.current);}}else{var selection,addRemove=this.selected.attributes['class']!==selectedCssClass;if(!addRemove){selection=this.getSelectedModels();if(selection.length<=1){addRemove=true;}}
this.selected.addRemoveClass(selectedCssClass,addRemove);if(!addRemove){selection=this.getSelectedModels();if(selection.length===1){selection[0].trigger('selected',selection[0]);}}}}
this.doSetMultiSelection({models:this.getSelectedModels()});}else if(this.listStyle==='checkboxlist'){if(tr.destroyed){return;}
var components=tr.getComponents();if(components.length===1){if(components[0].$.checkBoxColumn.checked){model.trigger('uncheck',model);}else{model.trigger('check',model);}}}},this);model.on('unselected',function(){if(this.selected){this.selected.removeClass('selected',false);}
this.selected=null;},this);model.on('check',function(){var me=this;if(tr&&tr.destroyed){return;}
if(!me.isSelectableLine(model)){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_LineCanNotBeSelected'));return;}
if(this.listStyle==='checkboxlist'){var components=tr.getComponents(),allChecked=null,checkedLines=[];if(components.length===1){components[0].$.checkBoxColumn.check();tr.checked=true;_.each(tr.getParent().getComponents(),function(comp){if(comp.checked){checkedLines.push(comp.getComponents()[0].model);if(allChecked!==false){allChecked=true;}}else{allChecked=false;}});components[0].doLineChecked({action:'check',line:model,checkedLines:checkedLines,allChecked:allChecked});}}},this);model.on('uncheck',function(){if(tr&&tr.destroyed){return;}
if(this.listStyle==='checkboxlist'){var components=tr.getComponents(),checkedLines=[];if(components.length===1){components[0].$.checkBoxColumn.unCheck();tr.checked=false;_.each(tr.getParent().getComponents(),function(comp){if(comp.checked){checkedLines.push(comp.getComponents()[0].model);}});components[0].doLineChecked({action:'uncheck',line:model,checkedLines:checkedLines,allChecked:false});}}},this);return tr;},getSelectedRows:function(){var result=[],tRows=Object.keys(this.$.tbody.$),selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';_.each(tRows,function(tr){if(this.$.tbody.$[tr].attributes['class']===selectedCssClass){result.push(this.$.tbody.$[tr]);}},this);return result;},getSelectedModels:function(){var result=[],tRows=Object.keys(this.$.tbody.$),selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';_.each(tRows,function(tr){if(this.$.tbody.$[tr].attributes['class']===selectedCssClass){if(this.$.tbody.$[tr].renderline&&this.$.tbody.$[tr].renderline.model){result.push(this.$.tbody.$[tr].renderline.model);}}},this);return result;},setSelectedModels:function(models){var i,tRows=Object.keys(this.$.tbody.$),selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';_.each(tRows,function(tr){var item=_.find(models,function(model){return model.id===this.$.tbody.$[tr].renderline.model.id;},this);this.$.tbody.$[tr].addRemoveClass(selectedCssClass,item!==undefined);},this);this.doSetMultiSelection({models:this.getSelectedModels()});},setSelectionMode:function(mode){this.selectionMode=mode;},selectAll:function(){var tRows=Object.keys(this.$.tbody.$),selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';_.each(tRows,function(tr){this.$.tbody.$[tr].addRemoveClass(selectedCssClass,true);},this);this.doSetMultiSelection({models:this.getSelectedModels()});},getMultiSelectIndex:function(selected){var tRows=Object.keys(this.$.tbody.$),first=-1,last=-1,current=-1,selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';_.each(tRows,function(tr,indx){if(tr===selected.name){current=indx;}
if(this.$.tbody.$[tr].attributes['class']===selectedCssClass){last=indx;if(first<0){first=indx;}}},this);return{first:first,last:last,current:current};},doMultiSelection:function(from,to){var tRows=Object.keys(this.$.tbody.$),selectedCssClass=this.selectedCssClass?this.selectedCssClass:'selected';_.each(tRows,function(tr,indx){this.$.tbody.$[tr].addRemoveClass(selectedCssClass,from<=indx&&indx<=to);},this);}});(function(){OB.I18N=window.OB.I18N||{};OB.I18N.qtyScale=function(){return OB.Format.formats.qtyEdition.length-OB.Format.formats.qtyEdition.indexOf('.')-1;};OB.I18N.formatCurrency=function(number){var maskNumeric=OB.Format.formats.priceInform,decSeparator=OB.Format.defaultDecimalSymbol,groupSeparator=OB.Format.defaultGroupingSymbol,groupInterval=OB.Format.defaultGroupingSize;maskNumeric=maskNumeric.replace(',','dummy').replace('.',decSeparator).replace('dummy',groupSeparator);return OB.Utilities.Number.JSToOBMasked(number,maskNumeric,decSeparator,groupSeparator,groupInterval);};OB.I18N.formatCurrencyWithSymbol=function(number,symbol,currencySymbolToTheRight){if(currencySymbolToTheRight){return OB.I18N.formatCurrency(number)+symbol;}else{return symbol+OB.I18N.formatCurrency(number);}};OB.I18N.formatCoins=function(number){var val=OB.I18N.formatCurrency(number);var decSeparator=OB.Format.defaultDecimalSymbol;return val.replace(new RegExp('['+decSeparator+'][0]+$'),'');};OB.I18N.formatRate=function(number){var symbol='%',maskNumeric=OB.Format.formats.taxInform||OB.Format.formats.euroEdition,decSeparator=OB.Format.defaultDecimalSymbol,groupSeparator=OB.Format.defaultGroupingSymbol,groupInterval=OB.Format.defaultGroupingSize;maskNumeric=maskNumeric.replace(',','dummy').replace('.',decSeparator).replace('dummy',groupSeparator);var formattedNumber=OB.Utilities.Number.JSToOBMasked(number,maskNumeric,decSeparator,groupSeparator,groupInterval);formattedNumber=formattedNumber+symbol;return formattedNumber;};OB.I18N.normalizeDate=function(anyDateObject){function defaultValue(){return null;}
if(anyDateObject===null){return defaultValue();}
var anyDateObjectStringifyed=OB.UTIL.argumentsToStringifyed(anyDateObject);if(!anyDateObject){OB.error("The date provided '"+anyDateObjectStringifyed+"' is not a valid date object");return defaultValue();}
var normalizedDate=new Date(anyDateObject);try{if(normalizedDate.toISOString()!==normalizedDate.toJSON()){OB.error("The date object '"+OB.UTIL.argumentsToStringifyed(normalizedDate)+"' generates different strings if 'toISOString' or 'toJSON' are used. It is important that they should generate the same string because there are dates that will be converted to json and will have to be converted back to a valid date");return defaultValue();}}catch(e){OB.error("The date provided '"+anyDateObjectStringifyed+"' is not a valid date object. Error: '"+e+"'");return defaultValue();}
if(normalizedDate===new Date(null)){OB.error("The date provided '"+anyDateObjectStringifyed+"' is not a valid date object");return defaultValue();}
return normalizedDate.toISOString();};OB.I18N.formatDate=function(JSDate){if(!OB.Format){OB.error("OB.I18N.formatDate() requires OB.Format to be initialized");return null;}
if(!OB.Format.date){OB.error("OB.I18N.formatDate() requires OB.Format.date to be initialized");return null;}
var dateFormat=OB.Format.date;if(OB.Utilities&&OB.Utilities.Date){return OB.Utilities.Date.JSToOB(JSDate,dateFormat);}else{return JSDate;}};OB.I18N.formatDateISO=function(d){if(typeof(d)==="string"){var date=new Date(d);if(date.toISOString()===d){d=date;}else{OB.error("The argument must be a date or an iso string");return;}}
var curr_date=d.getDate();var curr_month=d.getMonth();var curr_year=d.getFullYear();var curr_hour=d.getHours();var curr_min=d.getMinutes();var curr_sec=d.getSeconds();var curr_mill=d.getMilliseconds();return OB.UTIL.padNumber(curr_year,4)+'-'+OB.UTIL.padNumber(curr_month+1,2)+'-'+OB.UTIL.padNumber(curr_date,2)+' '+OB.UTIL.padNumber(curr_hour,2)+':'+OB.UTIL.padNumber(curr_min,2)+':'+OB.UTIL.padNumber(curr_sec,2)+'.'+OB.UTIL.padNumber(curr_mill,3);};OB.I18N.formatHour=function(d,includeSeconds){if(typeof(d)==="string"){var date=new Date(d);if(date.toISOString()===d){d=date;}else{OB.error("The argument must be a date or an iso string");return;}}
var curr_hour=d.getHours();var curr_min=d.getMinutes();var curr_sec=d.getSeconds();var formattedHour=OB.UTIL.padNumber(curr_hour,2)+':'+OB.UTIL.padNumber(curr_min,2);if(includeSeconds){formattedHour+=":"+OB.UTIL.padNumber(curr_sec,2);}
return formattedHour;};OB.I18N.parseServerDate=function(d){return moment(d,"YYYY-MM-DD").toDate();};OB.I18N.parseNumber=function(s){if(OB.Format.defaultDecimalSymbol!=='.'){s=s.toString();while(s.indexOf(OB.Format.defaultDecimalSymbol)!==-1){s=s.replace(OB.Format.defaultDecimalSymbol,'.');}}
return parseFloat(s,10);};OB.I18N.getLabel=function(key,params,object,property){if(key===''){return'';}
if(key.indexOf('OBUIAPP_GroupBy')===0){return'';}
if(!OB.I18N.labels){OB.UTIL.Debug.execute(function(){OB.error('labels not loaded. key asked: '+key);});return'UNDEFINED '+key;}
if(!OB.I18N.labels[key]){OB.UTIL.Debug.execute(function(){OB.warn('not found label: '+key);});return'UNDEFINED '+key;}
var label=OB.I18N.labels[key],i;if(params&&params.length&&params.length>0){for(i=0;i<params.length;i++){label=label.replace("%"+i,params[i]);}}
if(object&&property){if(Object.prototype.toString.call(object[property])==='[object Function]'){object[property](label);}else{object[property]=label;}}
return label;};OB.I18N.hasLabel=function(key,params,object,property){return OB.I18N.labels[key]?true:false;};OB.I18N.getDateFormatLabel=function(){var year,month,day,label='',i,char,format;year=OB.I18N.getLabel('OBMOBC_YearCharLbl');month=OB.I18N.getLabel('OBMOBC_MonthCharLbl');day=OB.I18N.getLabel('OBMOBC_DayCharLbl');format=OB.Format.date.toLowerCase();for(i=0;i<format.length;i++){char=format[i];switch(char){case'y':label+=year;break;case'm':label+=month;break;case'd':label+=day;break;default:label+=char;}}
return label;};OB.I18N.lists={};OB.I18N.getLocalizedList=function(listname){if(!OB.I18N.lists[listname]){OB.I18N.lists[listname]=OB.I18N.getLabel(listname).split('_');}
return OB.I18N.lists[listname];};OB.I18N.getLocalizedListElement=function(listname,i){return OB.I18N.getLocalizedList(listname)[i];};OB.I18N.getMonthsList=function(){return OB.I18N.getLocalizedList('OBMOBC_Date_Months');};OB.I18N.getMonth=function(i){return OB.I18N.getLocalizedListElement('OBMOBC_Date_Months',i);};OB.I18N.getMonthsShortList=function(){return OB.I18N.getLocalizedList('OBMOBC_Date_Months_Short');};OB.I18N.getMonthShort=function(i){return OB.I18N.getLocalizedListElement('OBMOBC_Date_Months_Short',i);};OB.I18N.getWeekdaysList=function(){return OB.I18N.getLocalizedList('OBMOBC_Date_Weekdays');};OB.I18N.getWeekday=function(i){return OB.I18N.getLocalizedListElement('OBMOBC_Date_Weekdays',i);};OB.I18N.getWeekdaysShortList=function(){return OB.I18N.getLocalizedList('OBMOBC_Date_Weekdays_Short');};OB.I18N.getWeekdayShort=function(i){return OB.I18N.getLocalizedListElement('OBMOBC_Date_Weekdays_Short',i);};OB.I18N.getWeekdaysMinList=function(){return OB.I18N.getLocalizedList('OBMOBC_Date_Weekdays_Min');};OB.I18N.getWeekdayMin=function(i){return OB.I18N.getLocalizedListElement('OBMOBC_Date_Weekdays_Min',i);};}());OB=window.OB||{};OB.Utilities=window.OB.Utilities||{};OB.Utilities.Number={};OB.Utilities.Number.roundJSNumber=function(num,dec){var strNum;if(isNaN(num)){return NaN;}
strNum=((typeof num==='string')?num:String(num));return parseFloat(new BigDecimal(strNum).setScale(dec,BigDecimal.prototype.ROUND_HALF_UP));};OB.Utilities.Number.OBMaskedToOBPlain=function(number,decSeparator,groupSeparator){number=number.toString();var plainNumber=number,decimalNotation=(number.indexOf('E')===-1&&number.indexOf('e')===-1);if(groupSeparator){var groupRegExp=new RegExp('\\'+groupSeparator,'g');plainNumber=plainNumber.replace(groupRegExp,'');}
if(!decimalNotation){plainNumber=OB.Utilities.Number.ScientificToDecimal(number,decSeparator);}
var numberSign='';if(plainNumber.substring(0,1)==='+'){numberSign='';plainNumber=plainNumber.substring(1,plainNumber.length);}else if(plainNumber.substring(0,1)==='-'){numberSign='-';plainNumber=plainNumber.substring(1,plainNumber.length);}
if(plainNumber.indexOf(decSeparator)!==-1){while(plainNumber.substring(plainNumber.length-1,plainNumber.length)==='0'){plainNumber=plainNumber.substring(0,plainNumber.length-1);}}
while(plainNumber.substring(0,1)==='0'&&plainNumber.substring(1,2)!==decSeparator&&plainNumber.length>1){plainNumber=plainNumber.substring(1,plainNumber.length);}
if(plainNumber.substring(plainNumber.length-1,plainNumber.length)===decSeparator){plainNumber=plainNumber.substring(0,plainNumber.length-1);}
if(plainNumber!=='0'){plainNumber=numberSign+plainNumber;}
return plainNumber;};OB.Utilities.Number.OBPlainToOBMasked=function(number,maskNumeric,decSeparator,groupSeparator,groupInterval){if(number===''||number===null||number===undefined){return number;}
if(groupInterval===null||groupInterval===undefined){groupInterval=OB.Format.defaultGroupingSize;}
if(maskNumeric.indexOf('+')===0||maskNumeric.indexOf('-')===0){maskNumeric=maskNumeric.substring(1,maskNumeric.length);}
if(groupSeparator&&maskNumeric.indexOf(groupSeparator)!==-1&&maskNumeric.indexOf(decSeparator)!==-1&&maskNumeric.indexOf(groupSeparator)>maskNumeric.indexOf(decSeparator)){var fixRegExp=new RegExp('\\'+groupSeparator,'g');maskNumeric=maskNumeric.replace(fixRegExp,'');}
var maskLength=maskNumeric.length;var decMaskPosition=maskNumeric.indexOf(decSeparator);if(decMaskPosition===-1){decMaskPosition=maskLength;}
var intMask=maskNumeric.substring(0,decMaskPosition);var decMask=maskNumeric.substring(decMaskPosition+1,maskLength);if((groupSeparator&&decMask.indexOf(groupSeparator)!==-1)||decMask.indexOf(decSeparator)!==-1){if(groupSeparator){var fixRegExp_1=new RegExp('\\'+groupSeparator,'g');decMask=decMask.replace(fixRegExp_1,'');}
var fixRegExp_2=new RegExp('\\'+decSeparator,'g');decMask=decMask.replace(fixRegExp_2,'');}
number=number.toString();number=OB.Utilities.Number.OBMaskedToOBPlain(number,decSeparator,groupSeparator);var numberSign='';if(number.substring(0,1)==='+'){numberSign='';number=number.substring(1,number.length);}else if(number.substring(0,1)==='-'){numberSign='-';number=number.substring(1,number.length);}
var formattedNumber='';var numberLength=number.length;var decPosition=number.indexOf(decSeparator);if(decPosition===-1){decPosition=numberLength;}
var intNumber=number.substring(0,decPosition);var decNumber=number.substring(decPosition+1,numberLength);if(decNumber.length>decMask.length){decNumber='0.'+decNumber;decNumber=OB.Utilities.Number.roundJSNumber(decNumber,decMask.length);decNumber=decNumber.toString();if(decNumber.indexOf('e')!==-1||decNumber.indexOf('E')!==-1){decNumber=OB.Utilities.Number.ScientificToDecimal(decNumber,decSeparator);}
if(decNumber.substring(0,1)==='1'){intNumber=parseFloat(intNumber);intNumber=intNumber+1;intNumber=intNumber.toString();}
decNumber=decNumber.substring(2,decNumber.length);}
if(decNumber.length<decMask.length){var decNumber_temp='',decMaskLength=decMask.length,i;for(i=0;i<decMaskLength;i++){if(decMask.substring(i,i+1)==='#'){if(decNumber.substring(i,i+1)!==''){decNumber_temp=decNumber_temp+decNumber.substring(i,i+1);}}else if(decMask.substring(i,i+1)==='0'){if(decNumber.substring(i,i+1)!==''){decNumber_temp=decNumber_temp+decNumber.substring(i,i+1);}else{decNumber_temp=decNumber_temp+'0';}}}
decNumber=decNumber_temp;}
var isGroup=false;if(groupSeparator){if(intMask.indexOf(groupSeparator)!==-1){isGroup=true;}
var groupRegExp=new RegExp('\\'+groupSeparator,'g');intMask=intMask.replace(groupRegExp,'');}
var intNumber_temp;if(intNumber.length<intMask.length){intNumber_temp='';var diff=intMask.length-intNumber.length,j;for(j=intMask.length;j>0;j--){if(intMask.substring(j-1,j)==='#'){if(intNumber.substring(j-1-diff,j-diff)!==''){intNumber_temp=intNumber.substring(j-1-diff,j-diff)+intNumber_temp;}}else if(intMask.substring(j-1,j)==='0'){if(intNumber.substring(j-1-diff,j-diff)!==''){intNumber_temp=intNumber.substring(j-1-diff,j-diff)+intNumber_temp;}else{intNumber_temp='0'+intNumber_temp;}}}
intNumber=intNumber_temp;}
if(isGroup===true){intNumber_temp='';var groupCounter=0,k;for(k=intNumber.length;k>0;k--){intNumber_temp=intNumber.substring(k-1,k)+intNumber_temp;groupCounter++;if(groupCounter.toString()===groupInterval.toString()&&k!==1){groupCounter=0;intNumber_temp=groupSeparator+intNumber_temp;}}
intNumber=intNumber_temp;}
if(intNumber===''&&decNumber!==''){intNumber='0';}
formattedNumber=numberSign+intNumber;if(decNumber!==''){formattedNumber+=decSeparator+decNumber;}
return formattedNumber;};OB.Utilities.Number.OBMaskedToJS=function(numberStr,decSeparator,groupSeparator){if(!numberStr||numberStr.trim()===''){return null;}
var calcNumber=OB.Utilities.Number.OBMaskedToOBPlain(numberStr,decSeparator,groupSeparator);calcNumber=calcNumber.replace(decSeparator,'.');var numberResult=parseFloat(calcNumber);if(isNaN(numberResult)){return numberStr;}
return numberResult;};OB.Utilities.Number.JSToOBMasked=function(number,maskNumeric,decSeparator,groupSeparator,groupInterval){var isANumber=Object.prototype.toString.call(number)==='[object Number]';if(!isANumber){return number;}
var formattedNumber=number;formattedNumber=formattedNumber.toString();formattedNumber=formattedNumber.replace('.',decSeparator);formattedNumber=OB.Utilities.Number.OBPlainToOBMasked(formattedNumber,maskNumeric,decSeparator,groupSeparator,groupInterval);return formattedNumber;};OB.Utilities.Number.IsValidValueString=function(type,numberStr){var maskNumeric=type.maskNumeric;if(!numberStr){return true;}
var bolNegative=true;if(maskNumeric.indexOf('+')===0){bolNegative=false;maskNumeric=maskNumeric.substring(1,maskNumeric.length);}
var bolDecimal=true;if(maskNumeric.indexOf(type.decSeparator)===-1){bolDecimal=false;}
var checkPattern='';checkPattern+='^';if(bolNegative){checkPattern+='([+]|[-])?';}
checkPattern+='(\\d+)?((\\'+type.groupSeparator+'\\d{'+OB.Format.defaultGroupingSize+'})?)+';if(bolDecimal){checkPattern+='(\\'+type.decSeparator+'\\d+)?';}
checkPattern+='$';var checkRegExp=new RegExp(checkPattern);if(numberStr.match(checkRegExp)&&numberStr.substring(0,1)!==type.groupSeparator){return true;}
return false;};OB.Utilities.Number.Grouping={getGroupingModes:function(){return this.groupingModes;},groupingModes:{byDecimal10:OB.I18N.getLabel('OBUIAPP_GroupByDecimal10'),by1:OB.I18N.getLabel('OBUIAPP_GroupBy1'),by10:OB.I18N.getLabel('OBUIAPP_GroupBy10'),by100:OB.I18N.getLabel('OBUIAPP_GroupBy100'),by1000:OB.I18N.getLabel('OBUIAPP_GroupBy1000'),by10000:OB.I18N.getLabel('OBUIAPP_GroupBy10000'),by100000:OB.I18N.getLabel('OBUIAPP_GroupBy100000')},defaultGroupingMode:'by10',groupingMode:'by10',getGroupingMultiplier:function(groupingMode){switch(groupingMode){case'byDecimal10':return 0.1;case'by1':return 1;case'by10':return 10;case'by100':return 100;case'by1000':return 1000;case'by10000':return 10000;case'by100000':return 100000;}
return 10;},getGroupValue:function(value,record,field,fieldName,grid){var returnValue,groupingMode=(field.groupingMode||OB.Utilities.Number.Grouping.defaultGroupingMode),multiplier=this.getGroupingMultiplier(groupingMode);if(!isc.isA.Number(value)||!groupingMode){return value;}
returnValue=value/multiplier;returnValue=Math.round(returnValue-0.49);returnValue=returnValue*multiplier;return returnValue;},getGroupTitle:function(value,record,field,fieldName,grid){var groupValue=this.getGroupValue(value,record,field,fieldName,grid),groupingMode=(field.groupingMode||OB.Utilities.Number.Grouping.defaultGroupingMode),multiplier=this.getGroupingMultiplier(groupingMode);return groupValue+' - '+(groupValue+multiplier);}};OB.Utilities.Number.ScientificToDecimal=function(number,decSeparator){number=number.toString();number=number.replace(/^0+/,'');var coeficient,exponent,numberOfZeros,zeros='',i,split,index,sign;if(number.indexOf('e')!==-1){index=number.indexOf('e');}else if(number.indexOf('E')!==-1){index=number.indexOf('E');}else{return number;}
coeficient=number.substring(0,index);exponent=number.substring(index+1,number.length);if(coeficient.indexOf(decSeparator)!==-1){split=coeficient.split(decSeparator);coeficient=split[0]+split[1];}
if(exponent.indexOf('-')!==-1){numberOfZeros=exponent.substring(1,exponent.length);for(i=1;i<numberOfZeros;i++){zeros=zeros+'0';}
if(coeficient.substring(0,1)==='-'){sign='-';coeficient=coeficient.substring(1,coeficient.length);number=sign+'0.'+zeros+coeficient;}else{number='0.'+zeros+coeficient;}}else{numberOfZeros=exponent.indexOf('+')!==-1?exponent.substring(1,exponent.length):exponent;if(split){numberOfZeros=numberOfZeros-split[1].length;}
if(numberOfZeros>=0){for(i=0;i<numberOfZeros;i++){zeros=zeros+'0';}
number=coeficient+zeros;}else{number=coeficient.substr(0,coeficient.length+numberOfZeros)+'.'+coeficient.substr(coeficient.length+numberOfZeros);}}
return number;};OB=window.OB||{};OB.Utilities=window.OB.Utilities||{};OB.Utilities.Date={};OB.Utilities.Date.centuryReference=50;OB.Utilities.Date.normalizeDisplayFormat=function(displayFormat){var newFormat='';displayFormat=displayFormat.replace('mm','MM').replace('dd','DD').replace('yyyy','YYYY').replace('yy','YY');displayFormat=displayFormat.replace('%D','%d').replace('%M','%m');if(displayFormat!==null&&displayFormat!==''){newFormat=displayFormat;newFormat=newFormat.replace('YYYY','%Y');newFormat=newFormat.replace('YY','%y');newFormat=newFormat.replace('MM','%m');newFormat=newFormat.replace('DD','%d');newFormat=newFormat.substring(0,8);}
displayFormat=displayFormat.replace('hh','HH').replace('HH24','HH').replace('mi','MI').replace('ss','SS');displayFormat=displayFormat.replace('%H','HH').replace('HH:%m','HH:MI').replace('HH.%m','HH.MI').replace('%S','SS');displayFormat=displayFormat.replace('HH:mm','HH:MI').replace('HH.mm','HH.MI');displayFormat=displayFormat.replace('HH:MM','HH:MI').replace('HH.MM','HH.MI');if(displayFormat.indexOf(' HH:MI:SS')!==-1){newFormat+=' %H:%M:%S';}else if(displayFormat.indexOf(' HH:MI')!==-1){newFormat+=' %H:%M';}else if(displayFormat.indexOf(' HH.MI.SS')!==-1){newFormat+=' %H.%M.%S';}else if(displayFormat.indexOf(' HH.MI')!==-1){newFormat+=' %H.%M';}
if(displayFormat.indexOf(' a')!==-1){newFormat+=' A';}
return newFormat;};OB.Utilities.getTimeFormatDefinition=function(){var timeFormat,is24h=true;if(OB.Format.dateTime.indexOf(' ')===-1){return'to24HourTime';}
timeFormat=OB.Format.dateTime.substring(OB.Format.dateTime.indexOf(' ')+1);if(timeFormat&&timeFormat.toUpperCase().lastIndexOf(' A')!==-1&&timeFormat.toUpperCase().lastIndexOf(' A')===timeFormat.length-2){is24h=false;}
if(timeFormat.toLowerCase().contains('ss')){return{timeFormat:timeFormat,is24h:is24h,timeFormatter:is24h?'to24HourTime':'toTime'};}
return{timeFormat:timeFormat,is24h:is24h,timeFormatter:is24h?'toShort24HourTime':'toShortTime'};};OB.Utilities.Date.OBToJS=function(OBDate,dateFormat){if(!OBDate){return null;}
var isADate=Object.prototype.toString.call(OBDate)==='[object Date]',PMIndicator=' PM',AMIndicator=' AM',is24h=true,isPM=false;if(isADate){return OBDate;}
if(window.isc&&isc.Time&&isc.Time.PMIndicator){PMIndicator=isc.Time.PMIndicator;}
if(window.isc&&isc.Time&&isc.Time.AMIndicator){AMIndicator=isc.Time.AMIndicator;}
dateFormat=OB.Utilities.Date.normalizeDisplayFormat(dateFormat);dateFormat=dateFormat.replace(' A','');var dateSeparator=dateFormat.substring(2,3);var timeSeparator=dateFormat.substring(11,12);var isFullYear=(dateFormat.indexOf('%Y')!==-1);if(OBDate.indexOf(PMIndicator)!==-1||OBDate.indexOf(AMIndicator)!==-1){is24h=false;}
if(!is24h&&OBDate.indexOf(PMIndicator)!==-1){isPM=true;}
OBDate=OBDate.replace(AMIndicator,'').replace(PMIndicator,'');if((isFullYear?OBDate.length-2:OBDate.length)!==dateFormat.length){return null;}
if(isFullYear){dateFormat=dateFormat.replace('%Y','%YYY');}
if(dateFormat.indexOf('-')!==-1&&OBDate.indexOf('-')===-1){return null;}else if(dateFormat.indexOf('/')!==-1&&OBDate.indexOf('/')===-1){return null;}else if(dateFormat.indexOf(':')!==-1&&OBDate.indexOf(':')===-1){return null;}else if(dateFormat.indexOf('.')!==-1&&OBDate.indexOf('.')===-1){return null;}
var year=dateFormat.indexOf('%y')!==-1?OBDate.substring(dateFormat.indexOf('%y'),dateFormat.indexOf('%y')+2):0;var fullYear=dateFormat.indexOf('%Y')!==-1?OBDate.substring(dateFormat.indexOf('%Y'),dateFormat.indexOf('%Y')+4):0;var month=dateFormat.indexOf('%m')!==-1?OBDate.substring(dateFormat.indexOf('%m'),dateFormat.indexOf('%m')+2):0;var day=dateFormat.indexOf('%d')!==-1?OBDate.substring(dateFormat.indexOf('%d'),dateFormat.indexOf('%d')+2):0;var hours=dateFormat.indexOf('%H')!==-1?OBDate.substring(dateFormat.indexOf('%H'),dateFormat.indexOf('%H')+2):0;var minutes=dateFormat.indexOf('%M')!==-1?OBDate.substring(dateFormat.indexOf('%M'),dateFormat.indexOf('%M')+2):0;var seconds=dateFormat.indexOf('%S')!==-1?OBDate.substring(dateFormat.indexOf('%S'),dateFormat.indexOf('%S')+2):0;var digitRegExp=['^\\d+$','gm'];if((year&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(year)))||(fullYear&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(fullYear)))||(month&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(month)))||(day&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(day)))||(hours&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(hours)))||(minutes&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(minutes)))||(seconds&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(seconds)))){return null;}
month=parseInt(month,10);day=parseInt(day,10);hours=parseInt(hours,10);minutes=parseInt(minutes,10);seconds=parseInt(seconds,10);if(!is24h){if(!isPM&&hours===12){hours=0;}
if(isPM&&hours!==12){hours=hours+12;}}
if(day<1||day>31||month<1||month>12||year>99||fullYear>9999){return null;}
if(hours>23||minutes>59||seconds>59){return null;}
var JSDate=new Date();var centuryReference=OB.Utilities.Date.centuryReference;if(!isFullYear){if(parseInt(year,10)<centuryReference){fullYear='20'+year;}else{fullYear='19'+year;}}
fullYear=parseInt(fullYear,10);JSDate.setFullYear(fullYear,month-1,day);if(day!==JSDate.getDate()){return null;}
JSDate.setHours(hours);JSDate.setMinutes(minutes);JSDate.setSeconds(seconds);JSDate.setMilliseconds(0);if(JSDate.toString()==='Invalid Date'||JSDate.toString()==='NaN'){return null;}else{return JSDate;}};OB.Utilities.Date.JSToOB=function(JSDate,dateFormat){dateFormat=OB.Utilities.Date.normalizeDisplayFormat(dateFormat);var isADate=Object.prototype.toString.call(JSDate)==='[object Date]',PMIndicator=' PM',AMIndicator=' AM',is24h=true,isPM=false;if(!isADate){return null;}
if(window.isc&&isc.Time&&isc.Time.PMIndicator){PMIndicator=isc.Time.PMIndicator;}
if(window.isc&&isc.Time&&isc.Time.AMIndicator){AMIndicator=isc.Time.AMIndicator;}
if(dateFormat.toUpperCase().lastIndexOf(' A')!==-1&&dateFormat.toUpperCase().lastIndexOf(' A')===dateFormat.length-2){is24h=false;}
var year=JSDate.getYear().toString();var fullYear=JSDate.getFullYear().toString();var month=(JSDate.getMonth()+1).toString();var day=JSDate.getDate().toString();var hours=JSDate.getHours().toString();var minutes=JSDate.getMinutes().toString();var seconds=JSDate.getSeconds().toString();var centuryReference=OB.Utilities.Date.centuryReference;if(dateFormat.indexOf('%y')!==-1){if(parseInt(fullYear,10)>=1900+centuryReference&&parseInt(fullYear,10)<2100-centuryReference){if(parseInt(year,10)>=100){year=parseInt(year,10)-100;year=year.toString();}}else{return null;}}
if(!is24h){hours=parseInt(hours,10);if(hours>=12){isPM=true;}
if(hours>12){hours=hours-12;}
if(hours===0){hours=12;}
hours=hours.toString();}
while(year.length<2){year='0'+year;}
while(fullYear.length<4){fullYear='0'+fullYear;}
while(month.length<2){month='0'+month;}
while(day.length<2){day='0'+day;}
while(hours.length<2){hours='0'+hours;}
while(minutes.length<2){minutes='0'+minutes;}
while(seconds.length<2){seconds='0'+seconds;}
var OBDate=dateFormat;OBDate=OBDate.replace('%y',year);OBDate=OBDate.replace('%Y',fullYear);OBDate=OBDate.replace('%m',month);OBDate=OBDate.replace('%d',day);OBDate=OBDate.replace('%H',hours);OBDate=OBDate.replace('%M',minutes);OBDate=OBDate.replace('%S',seconds);if(!is24h){if(isPM){OBDate=OBDate.replace(' A',PMIndicator);}else{OBDate=OBDate.replace(' A',AMIndicator);}}
return OBDate;};OB.Utilities.Date.getTimeFields=function(allFields){var i,field,timeFields=[],length=allFields.length;for(i=0;i<length;i++){field=allFields[i];if(field.type==='_id_24'){timeFields.push(field);}}
return timeFields;};OB.Utilities.Date.convertUTCTimeToLocalTime=function(newData,allFields){var textField,fieldToDate,i,j,UTCOffsetInMiliseconds=OB.Utilities.Date.getUTCOffsetInMiliseconds(),timeFields=OB.Utilities.Date.getTimeFields(allFields),timeFieldsLength=timeFields.length,convertedData=isc.clone(newData),convertedDataLength=convertedData.length;for(i=0;i<timeFieldsLength;i++){for(j=0;j<convertedDataLength;j++){textField=convertedData[j][timeFields[i].name];if(!textField){continue;}
if(isc.isA.String(textField)){fieldToDate=isc.Time.parseInput(textField);}else if(isc.isA.Date(textField)){fieldToDate=textField;}
fieldToDate.setTime(fieldToDate.getTime()+UTCOffsetInMiliseconds);convertedData[j][timeFields[i].name]=fieldToDate.getHours()+':'+fieldToDate.getMinutes()+':'+fieldToDate.getSeconds();}}
return convertedData;};OB.Utilities.Date.addTimezoneOffset=function(date){var newDate,originalTimezoneOffset,newTimezoneOffset;if(Object.prototype.toString.call(date)!=='[object Date]'){return date;}
originalTimezoneOffset=date.getTimezoneOffset();newDate=new Date(date.getTime()+(originalTimezoneOffset*60000));newTimezoneOffset=newDate.getTimezoneOffset();if(originalTimezoneOffset!==newTimezoneOffset){newDate=new Date(newDate.getTime()+(newTimezoneOffset-originalTimezoneOffset)*60000);}
return newDate;};OB.Utilities.Date.substractTimezoneOffset=function(date){var newDate;if(Object.prototype.toString.call(date)!=='[object Date]'){return date;}
newDate=new Date(date.getTime()-(date.getTimezoneOffset()*60000));return newDate;};OB.Utilities.Date.getUTCOffsetInMiliseconds=function(){var UTCHourOffset=isc.Time.getUTCHoursDisplayOffset(new Date()),UTCMinuteOffset=isc.Time.getUTCMinutesDisplayOffset(new Date());return(UTCHourOffset*60*60*1000)+(UTCMinuteOffset*60*1000);};OB.Utilities.Date.roundToNextQuarter=function(date){var newDate=new Date(date),minutes=newDate.getMinutes(),timeBreak=15;if(newDate.getMilliseconds()===0&&newDate.getSeconds()===0&&minutes%timeBreak===0){return newDate;}
var roundedMinutes=(parseInt((minutes+timeBreak)/timeBreak,10)*timeBreak)%60;newDate.setMilliseconds(0);newDate.setSeconds(0);newDate.setMinutes(roundedMinutes);if(roundedMinutes===0){newDate.setHours(newDate.getHours()+1);}
return newDate;};OB.Utilities.Date.roundToNextHalfHour=function(date){var newDate=new Date(date),minutes=newDate.getMinutes(),timeBreak=30;if(newDate.getMilliseconds()===0&&newDate.getSeconds()===0&&minutes%timeBreak===0){return newDate;}
var roundedMinutes=(parseInt((minutes+timeBreak)/timeBreak,10)*timeBreak)%60;newDate.setMilliseconds(0);newDate.setSeconds(0);newDate.setMinutes(roundedMinutes);if(roundedMinutes===0){newDate.setHours(newDate.getHours()+1);}
return newDate;};OB.Utilities.Date.getDateSeparator=function(dateFormat){return dateFormat.toUpperCase().replace(/D/g,'').replace(/M/g,'').replace(/Y/g,'').substr(0,1);};enyo.kind({name:'OB.UI.Keyboard',commands:{},buttons:{},maxButtons:6,status:'',sideBarEnabled:false,destroy:function(){this.buttons=null;this.commands=null;this.inherited(arguments);},keyMatcher:/^([0-9]|\.|,| |%|[a-z]|[A-Z])$/,classes:'row-fluid',components:[{kind:'OB.UI.MoreButtons',name:'OB_UI_MoreButtons'},{name:'toolbarcontainer',classes:'span3'},{classes:'span9',components:[{classes:'row-fluid',components:[{classes:'span8',components:[{style:'margin:5px',components:[{style:'text-align: right; width: 100%; height: 40px;',components:[{style:'margin: 0px 0px 9px 0px; background-color: whiteSmoke; border: 1px solid #CCC; word-wrap: break-word; font-size: 35px; height: 33px; padding: 22px 5px 0px 0px;',components:[{name:'editbox',style:'border: 0px; word-wrap: break-word; font-size: 30px; font-family: monospace; height: 54px; text-align: right; width: 99%;',adjustFontSize:function(){var contentLength=this.getContent().length;var newFontSize=30;if(contentLength>=15){newFontSize=15;}else if(contentLength>=11){newFontSize=23;}
var newStyle=enyo.format("border: 0px; word-wrap: break-word; font-size: %spx; font-family: monospace; height: 54px; text-align: right; width: 99%;",newFontSize);this.setStyle(newStyle);}}]}]}]}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_backspace',classButton:'btn-icon btn-icon-backspace',command:'del'}]},{classes:'row-fluid',name:'OBKeyBoard_centerAndRightSideContainer',components:[{classes:'span8',name:'keypadcontainer'},{name:'OBKeyBoard_rightSideToolbar',classes:'span4',components:[{name:'sideenabled',components:[{classes:'row-fluid',components:[{classes:'span6',components:[{kind:'OB.UI.ButtonKey',label:'-',classButton:'btnkeyboard-num btnkeyboard-minus',command:'-',name:'minusBtn',init:function(){this.switchButton();}}]},{classes:'span6',components:[{kind:'OB.UI.ButtonKey',label:'+',classButton:'btnkeyboard-num btnkeyboard-plus',command:'+',name:'plusBtn',init:function(){this.switchButton();}}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{name:'btnQty',kind:'OB.UI.ButtonKey',command:'line:qty',init:function(model){this.switchButton();}}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'btnPrice',permission:'OBPOS_order.changePrice',command:'line:price'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'btnDiscount',permission:'OBPOS_order.discount',command:'line:dto',init:function(model){var receipt=model.get('order'),me=this;if(receipt){if(OB.MobileApp.model.get('permissions')["OBPOS_retail.discountkeyboard"]===false){this.command='line:dto';}else{receipt.get('lines').on('add remove',function(){if(model.get('leftColumnViewManager')&&model.get('leftColumnViewManager').isMultiOrder()){this.waterfall('onDisableButton',{disabled:true});}
if(OB.UTIL.isDisableDiscount){OB.UTIL.isDisableDiscount(receipt,function(disable){if(!OB.MobileApp.model.hasPermission(me.permission,true)||disable){me.waterfall('onDisableButton',{disabled:true});}else{me.waterfall('onDisableButton',{disabled:false});}});}},this);this.command='screen:dto';}}}}]}]}]},{name:'sidedisabled',components:[{classes:'row-fluid',components:[{classes:'span6',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_disabled_A'}]},{classes:'span6',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_disabled_B'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_disabled_C'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_disabled_D'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_disabled_E'}]}]}]},{name:'ticketDiscountsToolbar',components:[{classes:'row-fluid',components:[{classes:'span6',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_discounts_A'}]},{classes:'span6',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_discounts_B'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_discounts_C'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_discounts_D'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_discounts_E',description:'Discount button when discounts sidebar is used',permission:'OBPOS_retail.advDiscounts',command:'ticket:discount'}]}]}]},{name:'sidecashup',components:[{classes:'row-fluid',components:[{classes:'span6',components:[{kind:'OB.UI.ButtonKey',label:'-',classButton:'btnkeyboard-num btnkeyboard-minus',command:'-',name:'OBKEY_right_cashup_A',description:'+ button used for cashup'}]},{classes:'span6',components:[{kind:'OB.UI.ButtonKey',label:'+',classButton:'btnkeyboard-num btnkeyboard-plus',command:'+',name:'OBKEY_right_cashup_B',description:'- button used for cashup'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_cashup_C'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_cashup_D'}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_right_cashup_E'}]}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ButtonKey',classButton:'btn-icon btn-icon-enter',command:'OK',name:'btnEnter'}]}]}]}]}]}]}],events:{onCommandFired:'',onStatusChanged:'',onHoldActiveCmd:''},handlers:{onGlobalKeypress:'globalKeypressHandler',onCommandFired:'commandHandler',onRegisterButton:'registerButton',onKeyboardDisabled:'keyboardDisabled',onClearEditBox:'clearEditBox',onEnableQtyButton:'enableQtyButton',onEnablePlusButton:'enablePlusButton',onEnableMinusButton:'enableMinusButton'},isEnabled:true,disableCommandKey:function(inSender,inEvent){this.waterfall('onDisableButton',inEvent);},keyboardDisabled:function(inSender,inEvent){if(inEvent.status){_.each(this.buttons,function(btn){if(!btn.hasClass('btnkeyboard-inactive')){btn.setDisabled(true);btn.addClass('btnkeyboard-inactive');}});this.isEnabled=false;}else{_.each(this.buttons,function(btn){if(btn.disabled){btn.setDisabled(false);btn.removeClass('btnkeyboard-inactive');}});this.isEnabled=true;}},globalKeypressHandler:function(inSender,inEvent){var which=inEvent.keyboardEvent.which,actualStatus=null,actualChar,keeper;if(inEvent.keyboardEvent.originator&&(inEvent.keyboardEvent.originator.hasClass('modal-dialog')||inEvent.keyboardEvent.originator.hasClass('modal-popup'))){return;}
if(OB&&OB.MobileApp&&OB.MobileApp.model&&OB.MobileApp.model.get('useBarcode')){OB.MobileApp.keyPressProcessed=true;}
if(which>=96&&which<=105){which-=48;}
if(which===46){this.doCommandFired({key:"line:delete"});}
actualChar=String.fromCharCode(which);if(which===107){actualChar='+';}
if(which===111||which===191){actualChar='/';}
if(which===186){actualChar=':';}
if(which===109||which===189){actualChar='-';}
if(which===8){OB.MobileApp.view.scanningFocus();this.writeCharacter('del');return;}else if(which===110){this.writeCharacter(OB.Format.defaultDecimalSymbol);return;}else if(which===190){this.writeCharacter(OB.Format.defaultDecimalSymbol);return;}
if(actualChar&&actualChar.match(this.keyMatcher)){this.writeCharacter(actualChar);}else if((which===13&&!OB.UTIL.isIOS())||(OB.UTIL.isIOS()&&inEvent.enterEvent)){actualStatus=this.getStatus();keeper=document.getElementById('_focusKeeper');if(OB.MobileApp.view.scanMode&&OB.MobileApp.model.get('useBarcode')){if(keeper){if(keeper.value&&keeper.value.length>0){this.$.editbox.setContent(keeper.value);keeper.value='';}else{keeper.value='';this.$.editbox.setContent(this.$.editbox.getContent());}}}else{this.clearInput();return;}
if(this.$.editbox.getContent()==='0'){this.doCommandFired({key:"OK"});}else if(actualStatus){this.execCommand(actualStatus,this.getString());}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_KeypadTargetMissing'));}}else if(which===107||which===109){if(!OB.MobileApp.view.scanMode||!OB.MobileApp.scanning){this.doCommandFired({key:actualChar});}}else if(OB.Format.defaultDecimalSymbol==='.'){if(which===229){var scan=document.getElementById('_focusKeeper').value;for(i=0;i<scan.length;i++){this.writeCharacter(scan.charAt(i));}}else{this.writeCharacter(actualChar);}}},virtualKeypressHandler:function(key,options){if(options&&options.fromPopup){this.waterfall('onCloseAllPopups');}
if(key.match(this.keyMatcher)||(key==='del')){this.writeCharacter(key);}else{this.doCommandFired({key:key});}},writeCharacter:function(character){var content=this.$.editbox.getContent();var contentLength=content.length;if(contentLength>=20&&character!=='del'){OB.UTIL.showError(OB.I18N.getLabel('OBMOBC_ErrorMaxNumber'));return;}
if(character.match(this.keyMatcher)&&this.isEnabled){this.$.editbox.setContent(content+character);}else if(character==='del'){if(contentLength>0){this.$.editbox.setContent(content.substring(0,contentLength-1));}}
this.$.editbox.adjustFontSize();document.getElementById('_focusKeeper').value=this.$.editbox.getContent();},setStatus:function(newstatus){var btn=this.buttons[this.status];if(btn&&(btn.classButtonActive||(btn.owner&&btn.owner.classButtonActive))){btn.removeClass(btn.classButtonActive||btn.owner.classButtonActive);}
this.status=newstatus;this.waterfall('onStatusChanged',{status:newstatus});this.doStatusChanged({payment:OB.MobileApp.model.paymentnames?OB.MobileApp.model.paymentnames[this.status]:null,status:this.status});if(this.namedkeypads[this.status]){this.showKeypad(this.namedkeypads[this.status]);}else{this.showKeypad('basic');}
btn=this.buttons[this.status];if(btn&&(btn.classButtonActive||(btn.owner&&btn.owner.classButtonActive))){btn.addClass(btn.classButtonActive||btn.owner.classButtonActive);}},getStatus:function(){if(this.status){if(this.status===""){return this.defaultcommand;}else{return this.status;}}
return this.defaultcommand;},execCommand:function(cmd,txt){var cmddefinition=this.commands[cmd];cmddefinition.action(this,txt);},execStatelessCommand:function(cmd,txt){this.commands[cmd].action(this,txt);},getNumber:function(){return OB.I18N.parseNumber(this.getString());},getString:function(){var s=this.$.editbox.getContent();this.$.editbox.setContent('');return s;},clearInput:function(){this.$.editbox.setContent('');document.getElementById('_focusKeeper').value='';this.setStatus('');},clearEditBox:function(){this.$.editbox.setContent('');document.getElementById('_focusKeeper').value='';},enableQtyButton:function(inSender,inEvent){if(inEvent.enable){this.$.btnQty.disableButton(this.$.btnQty,{disabled:false});}else{this.$.btnQty.disableButton(this.$.btnQty,{disabled:true});}},enablePlusButton:function(inSender,inEvent){if(inEvent.enable){this.$.plusBtn.disableButton(this.$.plusBtn,{disabled:false});}else{this.$.plusBtn.disableButton(this.$.plusBtn,{disabled:true});}},enableMinusButton:function(inSender,inEvent){if(inEvent.enable){this.$.minusBtn.disableButton(this.$.minusBtn,{disabled:false});}else{this.$.minusBtn.disableButton(this.$.minusBtn,{disabled:true});}},commandHandler:function(inSender,inEvent){var txt;var cmd=inEvent.key;if(cmd==='OK'){txt=this.getString();if(txt==='0'&&this.status===''&&!OB.MobileApp.model.hasPermission('OBPOS_DisableLockShortcut',true)){OB.MobileApp.model.lock();return;}
if(txt&&this.status===''){if(this.defaultcommand){this.execCommand(this.defaultcommand,txt);}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_KeypadTargetMissing'));}}else if(txt&&this.status!==''){this.execCommand(this.status,txt);if(this.commands[this.status]&&!this.commands[this.status].holdActive){this.setStatus('');}}}else if(this.commands[cmd]){txt=this.getString();if(this.commands[cmd].stateless){this.execStatelessCommand(cmd,txt);}else{if(txt&&this.status===''){this.execCommand(cmd,txt);}else if(this.status===cmd&&txt){this.execCommand(cmd,txt);}else if(this.status===cmd){this.setStatus('');}else{this.setStatus(cmd);}}
if(this.commands[cmd].holdActive){this.doHoldActiveCmd({cmd:cmd});}}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_NoActionDefined'));}},registerButton:function(inSender,inEvent){var me=this,button=inEvent.originator;if(button.command){if(button.definition){this.addCommand(button.command,button.definition);}
if(button.command==='---'){button.command=false;}else if(!button.command.match(this.keyMatcher)&&button.command!=='OK'&&button.command!=='del'&&button.command!==String.fromCharCode(13)&&!this.commands[button.command]){button.command=false;}else if(button.permission&&!OB.MobileApp.model.hasPermission(button.permission)){button.command=false;}}
if(button.command){button.$.button.tap=function(){if(button&&button.definition&&button.definition.includedInPopUp){me.virtualKeypressHandler(button.command,{fromPopup:button.definition.includedInPopUp});}else{me.virtualKeypressHandler(button.command);}};this.addButton(button.command,button.$.button);button.$.button.removeClass('btnkeyboard-inactive');}else{button.disableButton(button,{disabled:true});}},initComponents:function(){var undef;this.buttons={};this.activekeypads=[];this.namedkeypads={};this.inherited(arguments);this.$.btnQty.$.button.setContent(OB.I18N.getLabel('OBMOBC_KbQuantity'));this.$.btnPrice.$.button.setContent(OB.I18N.getLabel('OBMOBC_KbPrice'));this.$.btnDiscount.$.button.setContent(OB.I18N.getLabel('OBMOBC_KbDiscount'));this.$.OBKEY_right_discounts_E.$.button.setContent(OB.I18N.getLabel('OBMOBC_KbDiscount'));if(this.buttonsDef){if(this.buttonsDef.sideBar){if(this.buttonsDef.sideBar.plusI18nLbl!==undef){this.$.plusBtn.setLabel(OB.I18N.getLabel(this.buttonsDef.sideBar.plusI18nLbl));}
if(this.buttonsDef.sideBar.minusI18nLbl!==undef){this.$.minusBtn.setLabel(OB.I18N.getLabel(this.buttonsDef.sideBar.minusI18nLbl));}
if(this.buttonsDef.sideBar.qtyI18nLbl!==undef){this.$.btnQty.setLabel(OB.I18N.getLabel(this.buttonsDef.sideBar.qtyI18nLbl));}
if(this.buttonsDef.sideBar.priceI18nLbl!==undef){this.$.btnPrice.setLabel(OB.I18N.getLabel(this.buttonsDef.sideBar.priceI18nLbl));}
if(this.buttonsDef.sideBar.discountI18nLbl!==undef){this.$.btnDiscount.setLabel(OB.I18N.getLabel(this.buttonsDef.sideBar.discountI18nLbl));}}}
this.state=new Backbone.Model();this.$.toolbarcontainer.destroyComponents();this.$.keypadcontainer.destroyComponents();this.showSidepad('sidedisabled');if(this.sideBarEnabled){this.$.sideenabled.show();this.$.sidedisabled.hide();this.$.ticketDiscountsToolbar.hide();this.$.sidecashup.hide();}else{this.$.ticketDiscountsToolbar.hide();this.$.sidecashup.hide();this.$.sideenabled.hide();this.$.sidedisabled.show();}
this.addKeypad('OB.UI.KeypadBasic');this.showKeypad('basic');},addToolbar:function(newToolbar){var toolbar=this.$.toolbarcontainer.createComponent({toolbarName:newToolbar.name,shown:newToolbar.shown,keboard:this});var emptyBtn={kind:'OB.UI.BtnSide',btn:{}},i=0,hasMore=newToolbar.buttons.length>this.maxButtons,displayedButtons=hasMore?this.maxButtons-1:newToolbar.buttons.length,displayedEmptyButtons=hasMore?0:this.maxButtons-newToolbar.buttons.length,btnDef,dialogButtons={};for(i=0;i<newToolbar.buttons.length;i++){btnDef=newToolbar.buttons[i];if(i<displayedButtons){if(btnDef.command){toolbar.createComponent({kind:'OB.UI.BtnSide',btn:btnDef});}else{toolbar.createComponent(emptyBtn);}}else{dialogButtons[btnDef.command]=btnDef;this.addCommand(btnDef.command,btnDef.definition);}
if(btnDef.initialize){btnDef.initialize(this);}}
if(hasMore){toolbar.createComponent({name:'btnMore',keyboard:this,dialogButtons:dialogButtons,kind:'OB.UI.ToolbarMore'});}
for(i=0;i<displayedEmptyButtons;i++){toolbar.createComponent(emptyBtn);}
toolbar.hide();},addToolbarComponent:function(newToolbar){this.$.toolbarcontainer.createComponent({kind:newToolbar,keyboard:this});},showToolbar:function(toolbarName){this.show();enyo.forEach(this.$.toolbarcontainer.getComponents(),function(toolbar){if(toolbar.toolbarName===toolbarName){toolbar.render();toolbar.show();if(toolbar.shown){toolbar.shown();}}else{toolbar.hide();}},this);},addCommand:function(cmd,definition){this.commands[cmd]=definition;},addButton:function(cmd,btn){if(this.buttons[cmd]){if(this.buttons[cmd].add){this.buttons[cmd]=this.buttons[cmd].add(btn);}}else{this.buttons[cmd]=btn;}},addKeypad:function(keypad){if(this.destroyed){return;}
var keypadconstructor=enyo.constructorForKind(keypad);this.activekeypads.push(keypadconstructor.prototype.padName);if(keypadconstructor.prototype.padPayment){this.namedkeypads[keypadconstructor.prototype.padPayment]=keypadconstructor.prototype.padName;}
this.$.keypadcontainer.createComponent({kind:keypad,keyboard:this}).render().hide();},showKeypad:function(keypadName){var firstLabel=null,foundLabel=false,existsLabel=false;enyo.forEach(this.$.keypadcontainer.getComponents(),function(pad){if(!firstLabel){firstLabel=pad.label;}else if(foundLabel){this.state.set('keypadNextLabel',this.state.get('keypadName')!=='basic'?this.$.keypadcontainer.children[0].label:this.searchLabelPad(this.namedkeypads[this.status]));foundLabel=false;}
if(pad.padName===keypadName){this.state.set('keypadName',keypadName);foundLabel=true;existsLabel=true;pad.show();if(pad.padPayment&&this.status!==pad.padPayment){this.setStatus(pad.padPayment);}}else{pad.hide();}},this);if(foundLabel){this.state.set('keypadNextLabel',firstLabel);}
if(!existsLabel){this.showKeypad('basic');}},showNextKeypad:function(){var i,max,current=this.state.get('keypadName');if(current!=='basic'){this.showKeypad('basic');}else{for(i=0,max=this.activekeypads.length;i<max;i++){if(this.activekeypads[i]===current){if(this.namedkeypads[this.status]===this.activekeypads[1]&&this.activekeypads.length>2){this.showKeypad(i<this.activekeypads.length-1?this.activekeypads[i+2]:this.activekeypads[0]);break;}else{this.showKeypad(i<this.activekeypads.length-1?this.activekeypads[i+1]:this.activekeypads[0]);break;}}}}},searchLabelPad:function(status){var i;if(!_.isUndefined(status)){if(this.activekeypads.length>2){for(i=0;i<this.activekeypads.length;i++){if(this.activekeypads[i]===status){return i<this.activekeypads.length-1?this.$.keypadcontainer.children[i+1].label:this.$.keypadcontainer.children[1].label;}}}else{return this.$.keypadcontainer.children[1].label;}}else{return this.$.keypadcontainer.children[1].label;}},showSidepad:function(sidepadname){this.$.sideenabled.hide();this.$.sidedisabled.hide();this.$.ticketDiscountsToolbar.hide();this.$.sidecashup.hide();this.$[sidepadname].show();}});enyo.kind({name:'OB.UI.BtnSide',style:'display:table; width:100%',handlers:{onGlobalKeypress:'changeScanningMode'},changeScanningMode:function(){if(this.btn.command==='code'){OB.MobileApp.scanning=this.children[0].children[0].hasClass(this.btn.classButtonActive);}},initComponents:function(){this.createComponent({kind:'OB.UI.ButtonKey',name:this.btn.command,label:this.btn.i18nLabel?OB.I18N.getLabel(this.btn.i18nLabel):this.btn.label,command:this.btn.command,permission:this.btn.permission,definition:this.btn.definition,classButtonActive:this.btn.classButtonActive||'btnactive-green'});}});enyo.kind({name:'OB.UI.AbstractBarcodeActionHandler',kind:enyo.Object,action:function(keyboard,txt){if(keyboard.receipt&&keyboard.receipt.get('isEditable')===false){keyboard.doShowPopup({popup:'modalNotEditableOrder'});return true;}
var me=this;OB.debug("AbstractBarcodeActionHandler - txt: "+txt);this.findProductByBarcode(txt,function(product){me.addProductToReceipt(keyboard,product);},keyboard);}});enyo.kind({name:'OB.UI.ToolbarMore',style:'display:table; width:100%;',handlers:{onStatusChanged:'statusChanged'},components:[{style:'margin: 5px;',components:[{kind:'OB.UI.Button',classes:'btnkeyboard',name:'btn',label:''}]}],initComponents:function(){this.inherited(arguments);this.$.btn.setContent(OB.I18N.getLabel('OBMOBC_More'));this.activegreen=false;},tap:function(){if(this.activegreen){this.keyboard.setStatus('');}else{this.keyboard.$.OB_UI_MoreButtons.showMoreButtons(this.dialogButtons);}},statusChanged:function(inSender,inEvent){var status=inEvent.status;if(this.keyboard.$.OB_UI_MoreButtons.hasNode()){this.keyboard.$.OB_UI_MoreButtons.hide();}
if(this.activegreen){this.$.btn.setContent(OB.I18N.getLabel('OBMOBC_More'));this.$.btn.removeClass('btnactive-green');this.activegreen=false;}
if(this.dialogButtons[status]){this.$.btn.setContent(this.dialogButtons[status].label);this.$.btn.addClass('btnactive-green');this.activegreen=true;}}});enyo.kind({name:'OB.UI.MoreButtons',kind:'OB.UI.Modal',topPosition:'125px',i18nHeader:'OBMOBC_MoreButtons',sideButtons:[],body:{classes:'row-fluid',components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;',classes:'row-fluid',components:[{name:'morebuttonslist',classes:'span12'}]}]}]},showMoreButtons:function(dialogButtons){this.$.body.$.morebuttonslist.destroyComponents();_.each(dialogButtons,function(btnDef){this.$.body.$.morebuttonslist.createComponent({kind:'OB.UI.BtnSide',btn:btnDef});},this);this.$.body.$.morebuttonslist.render();this.show();}});enyo.kind({name:'OB.UI.ButtonContextMenu',kind:'OB.UI.ToolbarButton',icon:'btn-icon btn-icon-menu',handlers:{onLeftToolbarDisabled:'disabledButton'},disabledButton:function(inSender,inEvent){this.setDisabled(inEvent.status);},components:[{name:'leftIcon'},{tag:'span',style:'display: inline-block;'},{name:'rightIcon'}],ontap:'onButtonTap'});enyo.kind({name:'OB.UI.ToolbarMenu',components:[{kind:'onyx.MenuDecorator',name:'btnContextMenu',components:[{kind:'OB.UI.ButtonContextMenu',name:'toolbarButton'},{kind:'onyx.Menu',classes:'dropdown',name:'menu',maxHeight:600,scrolling:false,floating:true}]}],onButtonTap:function(){if(this.$.toolbarButton.hasClass('btn-over')){this.$.toolbarButton.removeClass('btn-over');}},initComponents:function(){this.inherited(arguments);enyo.forEach(this.menuEntries,function(entry){this.$.menu.createComponent(entry);},this);}});enyo.kind({name:'OB.UI.KeypadBasic',padName:'basic',components:[{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'/',command:'/',name:'toolbarBtn1'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'*',command:'*',name:'toolbarBtn2'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'%',command:'%',name:'toolbarBtn3'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'7',command:'7',name:'keypadBtn7'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'8',command:'8',name:'keypadBtn8'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'9',command:'9',name:'keypadBtn9'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'4',command:'4',name:'keypadBtn4'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'5',command:'5',name:'keypadBtn5'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'6',command:'6',name:'keypadBtn6'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'1',command:'1',name:'keypadBtn1'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'2',command:'2',name:'keypadBtn2'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'3',command:'3',name:'keypadBtn3'}]}]},{classes:'row-fluid',components:[{classes:'span8',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'0',command:'0',name:'keypadBtn0'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',name:'decimalSymbol'}]}]}],initComponents:function(){var decimalButton,i;this.inherited(arguments);this.label=OB.I18N.getLabel('OBMOBC_KeypadBasic');if(this.toolbarButtons){i=0;_.forEach(this.toolbarButtons,function(btn){var btnName;i+=1;btnName='toolbarBtn'+i;this.$[btnName].setLabel(btn.i18nLabel?OB.I18N.getLabel(btn.i18nLabel):btn.label);if(btn.command){this.$[btnName].command=btn.command;}
this.$[btnName].doRegisterButton();},this);}
decimalButton=this.$.decimalSymbol;decimalButton.label=OB.Format.defaultDecimalSymbol;decimalButton.command=OB.Format.defaultDecimalSymbol;this.keyboard.registerButton(null,{originator:decimalButton});decimalButton.$.button.setContent(OB.Format.defaultDecimalSymbol);decimalButton.$.button.setDisabled(false);decimalButton.$.button.removeClass('btnkeyboard-inactive');}});enyo.kind({name:'OB.UI.ButtonKey',events:{onAddCommand:'',onAddButton:'',onKeyCommandPressed:'',onRegisterButton:''},handlers:{onDisableButton:'disableButton',onNarrowChanged:'redraw'},style:'margin: 5px;',classButtonActive:'btnactive',classButton:'',classButtonDisabled:'btnkeyboard-inactive',command:false,permission:null,label:null,switchButton:function(){},components:[{kind:'OB.UI.Button',name:'button',classes:'btnkeyboard'}],redraw:function(){this.render();},rendered:function(){this.inherited(arguments);if(this.definition&&this.definition.includedInPopUp){return}else{OB.UTIL.createElipsisEffect(this.$.button,{reUseOriginalContent:true});}},disableButton:function(inSender,inEvent){if(inSender===this||_.indexOf(inEvent.commands,this.command)!==-1){this.$.button.setDisabled(inEvent.disabled);if(inEvent.disabled){this.$.button.addClass(this.classButtonDisabled);}else{this.$.button.removeClass(this.classButtonDisabled);}}
return true;},setLabel:function(lbl){this.$.button.setContent(lbl);},initComponents:function(){var me=this;this.inherited(arguments);this.doRegisterButton();this.$.button.addClass(this.classButton);this.$.button.setContent(this.label);if(this.isDisabled){this.$.button.setDisabled(true);this.$.button.addClass(this.classButtonDisabled);}}});enyo.kind({name:'OB.UI.iterateArray',published:{collection:null},create:function(){var listName=this.name||'';this.inherited(arguments);if(!this.renderLine){throw enyo.format('Your list %s needs to define a renderLine kind',listName);}
if(!this.renderEmpty){throw enyo.format('Your list %s needs to define a renderEmpty kind',listName);}
if(this.collection){this.collectionChanged(null);}},collectionChanged:function(oldCollection){var int=0;this.destroyComponents();if(!this.collection){return;}
for(int;int<this.collection.length;int++){this._addModelToCollection(this.collection[int]);}
this.render();},_addModelToCollection:function(model,index){var tr=this.createComponent({kind:this.renderLine,model:model,lblProperty:this.lblProperty,qtyProperty:this.qtyProperty});tr.render();}});enyo.kind({name:'OB.UI.List',kind:'enyo.Select',published:{collection:null},focus:function(){if(this.hasNode()){this.hasNode().focus();}},create:function(){var listName=this.name||'';this.inherited(arguments);if(!this.renderLine){throw enyo.format('Your list %s needs to define a renderLine kind',listName);}
if(!this.renderEmpty){throw enyo.format('Your list %s needs to define a renderEmpty kind',listName);}
this.header=this.renderHeader?1:0;if(this.collection){this.collectionChanged(null);}},collectionChanged:function(oldCollection){if(!this.collection){return;}
this.collection.on('change',function(model,prop){var index=this.collection.indexOf(model);},this);this.collection.on('add',function(model,prop,options){this._addModelToCollection(model,options.index);},this);this.collection.on('remove',function(model,prop,options){var index=options.index;this.controlAtIndex(index+this.header).destroy();},this);this.collection.on('reset',function(){this.destroyComponents();if(this.renderHeader){this.createComponent({kind:this.renderHeader}).render();}
this.collection.each(function(model){this._addModelToCollection(model);},this);},this);},_addModelToCollection:function(model,index){var tr=this.createComponent({kind:this.renderLine,model:model});tr.render();}});enyo.kind({name:'OB.UI.Table',published:{collection:null},components:[{name:'theader'},{name:'tbody',tag:'ul',classes:'unstyled',showing:false},{name:'tinfo',showing:false,style:'border-bottom: 1px solid #cccccc; padding: 15px; font-weight: bold; color: #cccccc'},{name:'tempty'}],create:function(){var tableName=this.name||'';this.inherited(arguments);if(!this.renderLine){throw enyo.format('Your list %s needs to define a renderLine kind',tableName);}
if(!this.renderEmpty){throw enyo.format('Your list %s needs to define a renderEmpty kind',tableName);}
if(this.collection){this.collectionChanged(null);}},collectionChanged:function(oldCollection){this.selected=null;if(this.renderHeader&&this.$.theader.getComponents().length===0){this.$.theader.createComponent({kind:this.renderHeader});}
if(this.renderEmpty&&this.$.tempty.getComponents().length===0){this.$.tempty.createComponent({kind:this.renderEmpty});}
if(!this.collection){return;}
this.collection.on('selected',function(model){if(!model&&this.listStyle){if(this.selected){this.selected.addRemoveClass('selected',false);}
this.selected=null;}},this);this.collection.on('add',function(model,prop,options){this.$.tempty.hide();this.$.tbody.show();this._addModelToCollection(model,options.index);if(this.listStyle==='list'){if(!this.selected){model.trigger('selected',model);}}else if(this.listStyle==='edit'){model.trigger('selected',model);}},this);this.collection.on('remove',function(model,prop,options){var index=options.index;this.$.tbody.getComponents()[index].destroy();if(index>=this.collection.length){if(this.collection.length===0){this.collection.trigger('selected');}else{this.collection.at(this.collection.length-1).trigger('selected',this.collection.at(this.collection.length-1));}}else{this.collection.at(index).trigger('selected',this.collection.at(index));}
if(this.collection.length===0){this.$.tbody.hide();this.$.tempty.show();}},this);this.collection.on('reset',function(a,b,c){var modelsel;this.$.tbody.hide();this.$.tempty.show();this.$.tbody.destroyComponents();if(this.collection.size()===0){this.$.tbody.hide();this.$.tempty.show();this.collection.trigger('selected');}else{this.$.tempty.hide();this.$.tbody.show();this.collection.each(function(model){this._addModelToCollection(model);},this);if(this.listStyle==='list'){modelsel=this.collection.at(0);modelsel.trigger('selected',modelsel);}else if(this.listStyle==='edit'){modelsel=this.collection.at(this.collection.size()-1);modelsel.trigger('selected',modelsel);}}},this);this.collection.on('info',function(info){if(info){this.$.tinfo.setContent(OB.I18N.getLabel(info));this.$.tinfo.show();}else{this.$.tinfo.hide();}},this);this.collection.trigger('reset');},_addModelToCollection:function(model,index){var tr=this.$.tbody.createComponent({tag:'li'});tr.createComponent({kind:this.renderLine,model:model});tr.render();model.on('change',function(){tr.destroyComponents();tr.createComponent({kind:this.renderLine,model:model}).render();},this);model.on('selected',function(){if(this.listStyle){if(this.selected){this.selected.addRemoveClass('selected',false);}
this.selected=tr;this.selected.addRemoveClass('selected',true);}},this);}});enyo.kind({name:'OB.UI.ModalProfile',kind:'OB.UI.ModalAction',handlers:{onSelectRole:'roleSelected',onSelectOrganization:'orgSelected'},bodyContent:{style:'background-color: #ffffff;',components:[{components:[{classes:'properties-label',components:[{name:'roleLbl',style:'padding: 5px 8px 0px 0px; font-size: 15px;'}]},{kind:'OB.UI.ModalProfile.Role',classes:'properties-field',name:'roleList'}]},{style:'clear: both'},{name:'orgSelector',components:[{classes:'properties-label',components:[{style:'padding: 5px 8px 0px 0px; font-size: 15px;',name:'orgLbl'}]},{kind:'OB.UI.ModalProfile.Organization',classes:'properties-field',name:'orgList'}]},{style:'clear: both'},{name:'warehouseSelector',components:[{classes:'properties-label',components:[{style:'padding: 5px 8px 0px 0px; font-size: 15px;',name:'warehouseLbl'}]},{components:[{kind:'OB.UI.List',name:'warehouseList',tag:'select',classes:'modal-dialog-profile-combo',renderEmpty:enyo.Control,renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));if(OB.MobileApp.model.get('context')&&OB.MobileApp.model.get('context').user&&OB.MobileApp.model.get('context').user.defaultWarehouse&&this.model.get('id')===OB.MobileApp.model.get('context').user.defaultWarehouse){this.parent.setSelected(this.parent.children.length-1);}}})}]}]},{style:'clear: both'},{components:[{classes:'properties-label',components:[{style:'padding: 5px 8px 0px 0px; font-size: 15px;',name:'langLbl'}]},{name:'lang',components:[{kind:'OB.UI.List',name:'langList',tag:'select',classes:'modal-dialog-profile-combo',renderEmpty:enyo.Control,renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));if(OB.Application&&this.model.get('id')===OB.Application.language){this.parent.setSelected(this.parent.children.length-1);}}})}]}]},{style:'clear: both'},{components:[{classes:'properties-label',components:[{style:'padding: 5px 8px 0px 0px; font-size: 15px;',name:'setAsDefaultLbl'}]},{components:[{classes:'modal-dialog-profile-checkbox',components:[{kind:'OB.UI.CheckboxButton',name:'defaultBox',classes:'modal-dialog-btn-check'}]}]}]},{style:'clear: both'}]},bodyButtons:{components:[{style:'clear: both'},{kind:'OB.UI.ProfileDialogApply'},{kind:'OB.UI.ProfileDialogCancel',name:'profileCancelButton'}]},roleSelected:function(inSender,inEvent){this.selectedRoleOptions=_.filter(this.availableRoles,function(role){return role.id===inEvent.newRoleId;})[0];this.organizations.reset(this.selectedRoleOptions.organizationValueMap);if(this.$.bodyContent){this.$.bodyContent.$.orgList.changeOrganization();}},orgSelected:function(inSender,inEvent){var whMap=_.filter(this.selectedRoleOptions.warehouseOrgMap,function(orgMap){return orgMap.orgId===inEvent.newOrgId;})[0].warehouseMap;this.warehouses.reset(whMap);},initComponents:function(){var proc,languages=new Backbone.Collection(),options,profileHandler=OB.MobileApp.model.get('profileHandlerUrl')||'org.openbravo.mobile.core.login.ProfileUtils';proc=new OB.DS.Process(profileHandler);this.inherited(arguments);this.setStyle('width: 625px;');this.roles=new Backbone.Collection();this.organizations=new Backbone.Collection();this.warehouses=new Backbone.Collection();this.$.bodyContent.$.roleList.setCollection(this.roles);this.$.bodyContent.$.orgList.setCollection(this.organizations);this.$.bodyContent.$.warehouseList.setCollection(this.warehouses);this.$.bodyContent.$.langList.setCollection(languages);proc.exec({},enyo.bind(this,function(response){if(response.exception){return;}
this.availableRoles=response.role.roles;this.roles.reset(response.role.valueMap);if(this.$.bodyContent){this.$.bodyContent.$.roleList.changeRole();}
languages.reset(response.language.valueMap);}));this.ctx=OB.MobileApp.model.get('context');this.$.bodyContent.$.roleLbl.setContent(OB.I18N.getLabel('OBMOBC_Role'));this.$.bodyContent.$.orgLbl.setContent(OB.I18N.getLabel('OBMOBC_Org'));this.$.bodyContent.$.warehouseLbl.setContent(OB.I18N.getLabel('OBMOBC_Warehouse'));this.$.bodyContent.$.langLbl.setContent(OB.I18N.getLabel('OBMOBC_Language'));this.$.bodyContent.$.setAsDefaultLbl.setContent(OB.I18N.getLabel('OBMOBC_SetAsDefault'));options=OB.MobileApp.model.get('profileOptions');if(options){this.$.bodyContent.$.orgSelector.setShowing(options.showOrganization);this.$.bodyContent.$.warehouseSelector.setShowing(options.showWarehouse);}
this.setHeader(OB.I18N.getLabel('OBMOBC_ProfileDialogTitle'));},show:function(){this.inherited(arguments);this.$.bodyButtons.$.profileCancelButton.focus();}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ProfileDialogApply',isActive:true,isDefaultAction:true,tap:function(){var ajaxRequest,rr,widgetForm=this.owner.owner.$.bodyContent.$,options=OB.MobileApp.model.get('profileOptions'),newLanguageId=widgetForm.langList.getValue(),newRoleId=widgetForm.roleList.getValue(),isDefault=widgetForm.defaultBox.checked,actionURL='../../org.openbravo.client.kernel?command=save&_action=org.openbravo.client.application.navigationbarcomponents.UserInfoWidgetActionHandler',postData={language:newLanguageId,role:newRoleId,'default':isDefault};if(!this.isActive){return;}
this.isActive=false;if(options){if(options.showOrganization){postData.organization=widgetForm.orgList.getValue();}
if(options.showWarehouse){postData.warehouse=widgetForm.warehouseList.getValue();}
if(isDefault){postData.defaultProperties=options.defaultProperties;}}
window.localStorage.setItem('POSlanguageId',newLanguageId);ajaxRequest=new enyo.Ajax({url:actionURL,cacheBust:false,method:'POST',handleAs:'json',contentType:'application/json;charset=utf-8',data:JSON.stringify(postData),success:function(inSender,inResponse){if(inResponse.result==='success'){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));window.location.reload();}else{OB.UTIL.showError(inResponse.result);}
this.isActive=true;},fail:function(inSender,inResponse){OB.UTIL.showError(inResponse);this.isActive=true;}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblApply'));}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ProfileDialogCancel',tap:function(){this.doHideThisPopup();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));}});enyo.kind({name:'OB.UI.ModalProfile.Role',kind:'OB.UI.List',classes:'modal-dialog-profile-combo',events:{onSelectRole:''},handlers:{onchange:'changeRole'},renderEmpty:enyo.Control,renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));if(OB.MobileApp.model.get('context')&&OB.MobileApp.model.get('context').role&&this.model.get('id')===OB.MobileApp.model.get('context').role.id){this.parent.setSelected(this.parent.children.length-1);}}}),changeRole:function(inSender,inEvent){var id=this.children[this.getSelected()];if(OB.UTIL.isNullOrUndefined(id)){return;}
this.doSelectRole({newRoleId:id.getValue()});}});enyo.kind({name:'OB.UI.ModalProfile.Organization',kind:'OB.UI.List',classes:'modal-dialog-profile-combo',events:{onSelectOrganization:''},handlers:{onchange:'changeOrganization'},renderEmpty:enyo.Control,renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));if(OB.MobileApp.model.get('context')&&OB.MobileApp.model.get('context').organization&&this.model.get('id')===OB.MobileApp.model.get('context').organization.id){this.parent.setSelected(this.parent.children.length-1);}}}),changeOrganization:function(inSender,inEvent){var id=this.children[this.getSelected()];if(OB.UTIL.isNullOrUndefined(id)){return;}
this.doSelectOrganization({newOrgId:id.getValue()});}});enyo.kind({name:'OB.UI.Profile.SessionInfo',kind:'OB.UI.Popup',classes:'modal',components:[{classes:'widget-profile-title widget-profile-title-connection',name:'connStatus'},{style:'height: 5px;'},{kind:'OB.UI.MenuAction',name:'lockOption',allowHtml:true,tap:function(){this.owner.hide();OB.MobileApp.model.lock();}},{style:'height: 5px;'},{kind:'OB.UI.MenuAction',name:'endSessionButton',i18nLabel:'OBMOBC_EndSession',tap:function(){var me=this;if(OB.UTIL.SynchronizationHelper.isModelsSynchronizing()){me.owner.hide();OB.UTIL.showError(OB.I18N.getLabel('OBMOBC_SynchronizationWasNotDoneYet'));return;}
if(this.owner.args&&((this.owner.args.model.get('order')&&this.owner.args.model.get('order').get('lines').length>0)||(this.owner.args.model.get('orderList')&&this.owner.args.model.get('orderList').length>1))){this.owner.hide();OB.UTIL.Approval.requestApproval(this.owner.args.model,'OBPOS_approval.removereceipts',function(approved,supervisor,approvalType){if(approved){me.owner.hide();me.showLogoutDialog();}});}else{this.owner.hide();me.showLogoutDialog();}},showLogoutDialog:function(){var havePendingOrders=false,orderModels=OB.MobileApp.model.orderList?OB.MobileApp.model.orderList.models:[],i;for(i=0;i<orderModels.length;i++){if(orderModels[i].get('hasbeenpaid')==='N'&&orderModels[i].get('session')===OB.MobileApp.model.get('session')&&orderModels[i].get('lines').length>0){havePendingOrders=true;break;}}
if(havePendingOrders){OB.MobileApp.view.$.dialogsContainer.$.logoutDialog.setBodyContent(OB.I18N.getLabel('OBMOBC_LogoutDialogText_PendingTicket'));}else{OB.MobileApp.view.$.dialogsContainer.$.logoutDialog.setBodyContent(OB.I18N.getLabel('OBMOBC_LogoutDialogText'));}
OB.MobileApp.view.$.dialogsContainer.$.logoutDialog.show();}},{style:'height: 5px;'}],setConnectionStatus:function(){var connected=OB.MobileApp.model.get('connectedToERP');this.$.connStatus.setContent(OB.I18N.getLabel(connected?'OBMOBC_Online':'OBMOBC_Offline'));this.$.connStatus.addRemoveClass('onlineicon',connected);this.$.connStatus.addRemoveClass('offlineicon',!connected);},initComponents:function(){this.inherited(arguments);this.$.lockOption.setShowing(OB.MobileApp.model.get('supportsOffline'));this.$.lockOption.setLabel(OB.I18N.getLabel('OBMOBC_LogoutDialogLock')+'<span style="padding-left:190px">0\u21B5</span>');OB.MobileApp.model.on('change:connectedToERP',function(){this.setConnectionStatus();},this);this.setConnectionStatus();}});enyo.kind({name:'OB.UI.Profile.UserInfo',kind:'OB.UI.Popup',classes:'modal',components:[{name:'userWidget',kind:'OB.UI.Profile.UserWidget'},{style:'height: 5px;'},{kind:'OB.UI.MenuAction',i18nLabel:'OBMOBC_Profile',name:'profileButton',tap:function(){this.owner.hide();OB.MobileApp.view.$.dialogsContainer.$.profileDialog.show();}}],show:function(){this.$.profileButton.setShowing(OB.MobileApp.model.hasPermission('OBMOBC_ChangeProfile'));this.inherited(arguments);},initComponents:function(){this.inherited(arguments);OB.MobileApp.model.on('change:context',function(){var ctx=OB.MobileApp.model.get('context');if(!ctx){return;}
this.$.userWidget.setUserName(ctx.user._identifier);this.$.userWidget.setUserRole(ctx.role._identifier);this.$.userWidget.setUserImg(ctx.img);},this);}});enyo.kind({name:'OB.UI.Profile.UserWidget',style:'width: 100%',published:{userName:'',userRole:'',userImg:''},components:[{classes:'widget-profile-title ',components:[{style:'float: left; width: 55px; margin: -15px 0px 0px 6px;',components:[{kind:'OB.UI.Thumbnail','default':'../org.openbravo.mobile.core/assets/img/anonymous-icon.png',name:'img'}]},{style:'float: left; margin: 6px 0px 0px 0px; line-height: 150%;',components:[{components:[{components:[{tag:'span',style:'font-weight: 800; margin: 0px 0px 0px 5px;',name:'username'}]}]}]},{style:'float: left; margin: 6px 0px 0px 0px; line-height: 150%;',components:[{components:[{components:[{tag:'span',style:'font-weight: 800; margin: 0px 0px 0px 5px;',content:'-'}]}]}]},{style:'float: left; margin: 6px 0px 0px 0px; line-height: 150%;',components:[{components:[{components:[{tag:'span',style:'font-weight: 800; margin: 0px 0px 0px 5px;',name:'role'}]}]}]}]}],userNameChanged:function(){this.$.username.setContent(this.userName);},userRoleChanged:function(){this.$.role.setContent(this.userRole);},userImgChanged:function(){this.$.img.setImg(this.userImg);}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalOnline',bodyContent:{content:''},bodyButtons:{components:[{kind:'OB.UI.ModalDialogButton',content:'',isDefaultAction:true,tap:function(){this.doHideThisPopup();OB.MobileApp.model.lock();}},{kind:'OB.UI.ModalDialogButton',content:'',tap:function(){this.doHideThisPopup();}}]},initComponents:function(){this.header=OB.I18N.getLabel('OBMOBC_Online');this.bodyContent.content=OB.I18N.getLabel('OBMOBC_OnlineConnectionHasReturned');this.bodyButtons.components[0].content=OB.I18N.getLabel('OBMOBC_LblLoginAgain');this.bodyButtons.components[1].content=OB.I18N.getLabel('OBMOBC_LblCancel');this.inherited(arguments);}});enyo.kind({name:'OB.UI.ModalLogout',kind:'OB.UI.ModalAction',bodyContent:{kind:'enyo.Control',name:'label'},bodyButtons:{components:[{kind:'OB.UI.LogoutDialogLogout'},{kind:'OB.UI.LogoutDialogCancel'}]},setBodyContent:function(label){this.$.bodyContent.$.label.setContent(label);},initComponents:function(){this.inherited(arguments);this.setHeader(OB.I18N.getLabel('OBMOBC_LogoutDialogLogout'));this.setBodyContent(OB.I18N.getLabel('OBMOBC_LogoutDialogText'));}});enyo.kind({name:'OB.UI.LogoutDialogCancel',kind:'OB.UI.ModalDialogButton',tap:function(){this.doHideThisPopup();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));}});enyo.kind({name:'OB.UI.LogoutDialogLogout',kind:'OB.UI.ModalDialogButton',isDefaultAction:true,tap:function(){this.doHideThisPopup();OB.UTIL.showLoggingOut(true);OB.MobileApp.model.logout();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LogoutDialogLogout'));}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.LogoutDialogLock',tap:function(){this.doHideThisPopup();OB.MobileApp.model.lock();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LogoutDialogLock'));}});enyo.kind({name:'OB.Modals.ModalModelsToSynch',myId:'ModalModelsToSynch',kind:'OB.UI.Modal',i18nHeader:'OBMOBC_ModelsToSynchronize',body:{kind:'OB.Modals.ModalModelsToSynch.Components.ListModelsToSynch',name:'modelsToSynchList'},executeOnHide:function(){this.$.body.$.modelsToSynchList.setModelsToSynchValues(null);},isFirstTime:true,executeOnShow:function(){var me=this,modelsToSync=new Backbone.Collection(),modelsByType;me.$.body.$.modelsToSynchList.setModelsToSynchValues(modelsToSync);var callback;callback=function(model,dataToSync){var isAdding=false;modelsToSync.reset();_.each(OB.MobileApp.model.get('dataSyncModels'),function(modelObj){modelsByType=_.filter(dataToSync.models,function(obj){return obj.get('url').replace('../../','').split('/')[1]===modelObj.className&&obj.get('mainServer');});if(modelsByType.length>0){var object=new Backbone.Model();object.set('name',modelObj.model.prototype.modelName);_.each(modelsByType,function(mdl){mdl.set('model',modelObj);});object.set('items',new Backbone.Collection(modelsByType));object.set('quantity',modelsByType.length);object.syncModel=modelObj.model;modelsToSync.add(object);isAdding=true;}});};if(this.isFirstTime){this.isFirstTime=false;OB.MobileApp.model.on('eachModelsSynchronized',function(){OB.MobileApp.model.syncModelHasData(OB.Model.Message,callback);});}
OB.MobileApp.model.syncModelHasData(OB.Model.Message,callback);}});enyo.kind({name:'OB.Modals.ModalModelsToSynch.Components.ListModelsToSynch',classes:'row-fluid',published:{modelsToSynchValues:null},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;'},{components:[{name:'scrollListModelsToSynch',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.Modals.ModalModelsToSynch.Components.ModelsToSynchLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}],modelsToSynchValuesChanged:function(value){this.$.scrollListModelsToSynch.setCollection(this.modelsToSynchValues);}});enyo.kind({name:'OB.Modals.ModalModelsToSynch.Components.ModelsToSynchLine',kind:'OB.UI.SelectButton',events:{onHideThisPopup:''},components:[{name:'line',style:'line-height: 33px; width: 100%',components:[{style:'float: left; font-weight: bold; margin-right: 5px',name:'model'},{style:'float: left;',name:'quantity'}]}],create:function(){this.inherited(arguments);this.$.model.setContent(this.model.get('name')+': ');this.$.quantity.setContent(this.model.get('quantity')+' '+OB.I18N.getLabel('OBMOBC_ItemsToSynchronize'));},tap:function(){this.doHideThisPopup();OB.MobileApp.view.$.modalItemsToSynch.show({itemsToSynchObj:this.model});}});enyo.kind({name:'OB.Modals.ModalItemsToSynch',myId:'ModalModelsToSynch',kind:'OB.UI.Modal',body:{kind:'OB.Modals.ModalItemsToSynch.Components.ListItemsToSynch',name:'itemsToSynchList'},executeOnHide:function(){this.$.body.$.itemsToSynchList.setItemsToSynchValues(null);OB.MobileApp.view.$.modalModelsToSynch.show();},executeOnShow:function(){var itemsToSync=new Backbone.Collection();OB.MobileApp.model.on('eachModelsSynchronized',function(){OB.MobileApp.model.syncModelHasData(OB.Model.Message,function(model,dataToSync){var items;if(itemsToSync.length>0){items=_.filter(dataToSync.models,function(obj){return obj.get('url').replace('../../','').split('/')[1]===itemsToSync.models[0].get('model').className&&obj.get('mainServer');});_.each(items,function(itm){itm.set('model',itemsToSync.models[0].get('model'));});itemsToSync.reset(items);}},function(model,dataToSync){itemsToSync.reset();});});itemsToSync=this.args.itemsToSynchObj.get('items');this.$.body.$.itemsToSynchList.setItemsToSynchValues(itemsToSync);this.$.header.setContent(this.args.itemsToSynchObj.get('name')+': '+OB.I18N.getLabel('OBMOBC_PendingToSynchronize'));}});enyo.kind({name:'OB.Modals.ModalItemsToSynch.Components.ListItemsToSynch',classes:'row-fluid',published:{itemsToSynchValues:null},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;'},{components:[{name:'scrollListItemsToSynch',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.Modals.ModalItemsToSynch.Components.ItemsToSynchLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}],itemsToSynchValuesChanged:function(value){this.$.scrollListItemsToSynch.setCollection(this.itemsToSynchValues);}});enyo.kind({name:'OB.Modals.ModalItemsToSynch.Components.ItemsToSynchLine',classes:'btnselect',style:'height: 33px;',components:[{name:'line',style:'line-height: 33px; width: 100%',components:[{style:'float: left; font-weight: bold; margin-right: 5px',name:'model'}]}],create:function(){this.inherited(arguments);if(this.model.get('model').getIdentifier){this.$.model.setContent(this.model.get('model').getIdentifier(JSON.parse(this.model.get('messageObj')).data[0]));}else{this.$.model.setContent(JSON.parse(this.model.get('messageObj')).data[0].id);}}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ExpirationOkButton',isDefaultAction:true,events:{onApplyChanges:''},tap:function(){if(this.doApplyChanges()){this.doHideThisPopup();}},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblApply'));}});enyo.kind({name:'OB.UI.ExpirationPassword',kind:'OB.UI.ModalAction',i18nHeader:'OBMOBC_PasswordChange',closeOnEscKey:false,autoDismiss:false,handlers:{onApplyChanges:'applyChanges'},newAttributes:[{kind:'OB.UI.renderTextProperty',type:'password',name:'password',i18nLabel:'OBMOBC_LoginPasswordInput'},{kind:'OB.UI.renderTextProperty',type:'password',name:'confirmpassword',i18nLabel:'OBMOBC_ConfirmPasswordInput'}],bodyContent:{kind:'Scroller',maxHeight:'225px',style:'background-color: #ffffff;',thumb:true,horizontal:'hidden',components:[{style:'background-color: #6cb33f;',content:'',name:'newheader'},{name:'attributes'}]},bodyButtons:{components:[{kind:'OB.UI.ExpirationOkButton',name:'expirationOkButton'},{kind:'OB.UI.ModalDialogButton',i18nContent:'OBMOBC_LblCancel',isDefaultAction:true,tap:function(){OB.MobileApp.model.set('isLoggingIn',false);this.owner.owner.hide();this.owner.owner.destroy();return;}}]},applyChanges:function(inSender,inEvent){var inputpassword=this.propertycomponents['password'];var inputconfirmpassword=this.propertycomponents['confirmpassword'];var messagenewheader=this.$.bodyContent.$.newheader;if(inputpassword.getValue()===''){messagenewheader.setContent(OB.I18N.getLabel('OBMOBC_EmptyPassword'));OB.MobileApp.model.set('isLoggingIn',false);return;}else if(inputpassword.getValue()!==inputconfirmpassword.getValue()){inputconfirmpassword.setValue('');inputpassword.setValue('');messagenewheader.setContent(OB.I18N.getLabel('OBMOBC_DifferentPassword'));OB.MobileApp.model.set('isLoggingIn',false);return;}
OB.MobileApp.model.set('isLoggingIn',false);OB.MobileApp.model.login(OB.MobileApp.model.get('user'),inputpassword.getValue(),OB.MobileApp.model.get('mode'),'FORCE_RESET_PASSWORD');this.hide();this.destroy();return;},initComponents:function(){this.inherited(arguments);this.propertycomponents={};enyo.forEach(this.newAttributes,function(natt){var editline=this.$.bodyContent.$.attributes.createComponent({kind:'OB.UI.PropertyEditLine',name:'line_'+natt.name,newAttribute:natt});this.propertycomponents[natt.name]=editline.propertycomponent;this.propertycomponents[natt.name].propertiesDialog=this;},this);this.$.headerCloseButton.hide();}});enyo.kind({name:'OB.UI.ToolbarMenuComponent',kind:'onyx.Menu',show:function(args){var me=this;if(me.autoDismiss){me.autoDismiss=false;this.inherited(arguments);setTimeout(function(){me.autoDismiss=true;},100);}else{this.inherited(arguments);}}});enyo.kind({name:'OB.UI.ToolbarMenu',published:{disabled:false},components:[{kind:'onyx.MenuDecorator',name:'btnContextMenu',components:[{kind:'OB.UI.ButtonContextMenu',name:'mainMenuButton'},{handlers:{onDestroyMenu:'destroyMenu'},destroyMenu:function(){this.hide();var element=document.getElementById(this.id);if(element&&element.parentNode){element.parentNode.removeChild(element);}},kind:'OB.UI.ToolbarMenuComponent',classes:'dropdown',name:'menu',maxHeight:600,scrolling:false,floating:true,autoDismiss:true,components:[{name:"menuScroller",kind:"enyo.Scroller",defaultKind:"onyx.MenuItem",vertical:"auto",classes:"enyo-unselectable",maxHeight:"600px",horizontal:'hidden',strategyKind:"TouchScrollStrategy"}]}]}],onButtonTap:function(){this.originalSanMode=OB.MobileApp.view.scanMode;if(this.$.mainMenuButton.hasClass('btn-over')){this.$.mainMenuButton.removeClass('btn-over');}},disabledChanged:function(){this.$.mainMenuButton.setDisabled(this.disabled);},initComponents:function(){this.inherited(arguments);if(this.disabled!==undefined){this.$.mainMenuButton.setDisabled(this.disabled);}
enyo.forEach(this.menuEntries,function(entry){this.$.menuScroller.createComponent(entry);},this);}});enyo.kind({name:'OB.UI.MenuAction',permission:null,published:{label:null,disabled:false},handlers:{onHideButton:'doHideButton'},components:[{name:'lbl',allowHtml:true,style:'padding: 12px 5px 12px 15px;',classes:'dropdown-menuitem'}],tap:function(){if(this.disabled){return true;}
OB.MobileApp.view.scanningFocus(this.parent.parent.parent.parent.parent.parent.originalSanMode);this.parent.parent.parent.parent.hide();if(this.eventName){this.bubble(this.eventName);}},setDisabled:function(value){if(value===undefined){OB.UTIL.Debug.execute(function(){throw"The disabled value must be true or false";});value=false;}
this.disabled=value;if(value){this.addClass('disabled');}else{this.removeClass('disabled');}},labelChanged:function(){this.$.lbl.setContent(this.label);},adjustVisibilityBasedOnPermissions:function(){if(this.permission&&!OB.MobileApp.model.hasPermission(this.permission)){this.hide();}},doHideButton:function(inSender,inEvent){var isException=false;if(this.fixed){return;}
if(inEvent&&inEvent.exceptions){isException=inEvent.exceptions.indexOf(this.name)!==-1;}
if(!isException){this.hide();}},initComponents:function(){this.inherited(arguments);this.$.lbl.setContent(this.i18nLabel?OB.I18N.getLabel(this.i18nLabel):this.label);this.adjustVisibilityBasedOnPermissions();}});enyo.kind({kind:'OB.UI.MenuAction',name:'OB.UI.MenuWindowItem',init:function(model){this.model=model;},tap:function(){var me=this;if(this.disabled){return true;}
this.parent.parent.parent.parent.hide();if(OB.MobileApp.model.isWindowOnline(this.route)===true){if(!OB.MobileApp.model.get('connectedToERP')){OB.UTIL.showError(OB.I18N.getLabel('OBMOBC_OfflineWindowRequiresOnline'));return;}
if(OB.MobileApp.model.get('loggedOffline')===true){OB.UTIL.showError(OB.I18N.getLabel('OBMOBC_OfflineWindowOfflineLogin'));return;}}
if(!OB.MobileApp.model.hasPermission(this.route)){return;}
OB.UTIL.HookManager.executeHooks('OBMOBC_PreWindowOpen',{context:this,windows:OB.MobileApp.windowRegistry.registeredWindows},function(args){if(args&&args.cancellation&&args.cancellation===true){return true;}
if(me.route){OB.MobileApp.model.navigate(me.route);}
if(me.url){window.open(me.url,'_blank');}});}});enyo.kind({name:'OB.UI.ButtonContextMenu',kind:'OB.UI.ToolbarButton',icon:'btn-icon-drop btn-icon-menu',synchronizingIcon:'btn-icon-pending btn-icon-synchronizing',notSynchronizedIcon:'btn-icon-pending btn-icon-notsynchronized',handlers:{onLeftToolbarDisabled:'disabledButton'},disabledButton:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled){this.removeClass('btn-icon-menu');}else{this.addClass('btn-icon-menu');}},components:[{name:'pendingSync'},{name:'leftIcon'},{tag:'span',style:'display: inline-block;'},{name:'rightIcon'}],ontap:'onButtonTap',initComponents:function(){this.inherited(arguments);var me=this;OB.MobileApp.model.on('modelsSynchronized',function(){if(me.$.pendingSync){me.$.pendingSync.removeClass(me.synchronizingIcon);me.$.pendingSync.removeClass(me.notSynchronizedIcon);}});OB.MobileApp.model.on('modelsSynchronizing',function(){if(me.$.pendingSync){me.$.pendingSync.addClass(me.synchronizingIcon);}});OB.MobileApp.model.on('modelsNotSynchronized',function(){if(me.$.pendingSync){me.$.pendingSync.addClass(me.notSynchronizedIcon);me.$.pendingSync.removeClass(me.synchronizingIcon);}});if(this.icon){this.$.leftIcon.addClass(this.icon);}
if(this.iconright){this.$.rightIcon.addClass(this.iconright);}}});enyo.kind({name:'OB.UI.PendingSyncButton',kind:'OB.UI.MenuAction',style:'padding-top: 3px;',i18nLabel:'OBMOBC_PendingSynchronization',classes:'menu-connection ',modelsToSynchObject:new Backbone.Model(),events:{onShowPopup:''},tap:function(){var me=this;this.parent.parent.parent.parent.hide();me.doShowPopup({popup:'modalModelsToSynch'});},initComponents:function(){this.inherited(arguments);var me=this;me.hide();me.$.lbl.setStyle('padding: 12px 5px 12px 15px; margin-left: 20px;');me.addClass('btn-icon-notsynchronized');OB.MobileApp.model.on('modelsSynchronized',function(){me.hide();});OB.MobileApp.model.on('modelsSynchronizing',function(){me.show();});OB.MobileApp.model.on('modelsNotSynchronized',function(){me.show();});}});enyo.kind({name:'OB.UI.MainMenu',classes:'span2',initComponents:function(){this.inherited(arguments);this.createComponent({kind:'OB.UI.MainMenuContents',name:'menuHolder',style:'margin-left:5px; margin-right:5px',customMenuEntries:this.customMenuEntries,showWindowsMenu:this.showWindowsMenu});}});enyo.kind({name:'OB.UI.MenuSeparator',classes:'dropdown-menudivider'});enyo.kind({name:'OB.UI.MainMenuContents',kind:'OB.UI.ToolbarMenu',menuEntries:[],init:function(model){this.model=model;},handlers:{onSessionInfo:'showSession',onUserInfo:'showUser',onDisableMenuEntry:'disableMenuEntry',onHideButtons:'doHideButtons'},events:{onShowPopup:''},showSession:function(){this.doShowPopup({popup:'profileSessionInfo',args:{model:this.model}});},showUser:function(){this.doShowPopup({popup:'profileUserInfo'});},setConnected:function(){var menuEntry,connected;if(!this.$.menu){return;}
menuEntry=this.$.menuScroller.$.connStatusButton;connected=OB.MobileApp.model.get('connectedToERP');menuEntry.$.lbl.setStyle('padding: 12px 5px 12px 15px; margin-left: 20px;');menuEntry.setLabel(OB.I18N.getLabel(connected?'OBMOBC_Online':'OBMOBC_Offline'));menuEntry.addRemoveClass('onlineicon',connected);menuEntry.addRemoveClass('offlineicon',!connected);},disableMenuEntry:function(inSender,inEvent){var entry=this.$.menu.$[inEvent.entryName],disable;if(!entry){return true;}
disable=inEvent.disable!==false;entry.setDisabled(disable);return true;},doHideButtons:function(inSender,inEvent){this.waterfall('onHideButton',inEvent);},getMenuComponent:function(componentName){var objComp;objComp=_.find(this.$.menuScroller.controls,function(item){if(!OB.UTIL.isNullOrUndefined(item.$.lbl)&&!OB.UTIL.isNullOrUndefined(item.$.lbl.content)&&item.$.lbl.content===componentName){return true;}});return objComp;},initComponents:function(){this.menuEntries=[];this.menuEntries.push({kind:'OB.UI.PendingSyncButton'});this.menuEntries.push({kind:'OB.UI.MenuAction',name:'connStatusButton',classes:'menu-connection',eventName:'onSessionInfo'});if(this.customMenuEntries&&this.customMenuEntries.length>0){this.menuEntries.push({kind:'OB.UI.MenuSeparator'});_.forEach(this.customMenuEntries,function(entry){this.menuEntries.push(entry);},this);}
if(this.showWindowsMenu){this.menuEntries.push({kind:'OB.UI.MenuSeparator'});enyo.forEach(OB.MobileApp.model.windows.filter(function(window){return window.get('menuPosition');}),function(window){this.menuEntries.push({name:'OB.UI.MenuWindowItem.'+window.get('menuI18NLabel'),kind:'OB.UI.MenuWindowItem',label:window.get('menuLabel'),i18nLabel:window.get('menuI18NLabel'),route:window.get('route'),permission:window.get('permission')});},this);}
this.menuEntries.push({kind:'OB.UI.MenuSeparator'});this.menuEntries.push({name:'OB.UI.MenuUserInfo',kind:'OB.UI.MenuAction',classes:'dropdown-menuitem',i18nLabel:'OBMOBC_User',eventName:'onUserInfo'});enyo.kind({name:'OBMOBC.UI.MenuRecording',kind:'OB.UI.MenuAction',i18nLabel:'OBMOBC_LblMenuStartRecording',tap:function(){var i;if(this.disabled){return true;}
this.parent.parent.parent.parent.hide();if(TestRegistry.writingTest===true){TestRegistry.writingTest=false;this.$.lbl.setContent(OB.I18N.getLabel('OBMOBC_LblMenuStartRecording'));console.log("======================= RECORDING START =================================");var stringSteps='';for(i=0;i<TestRegistry.testSteps.length;i++){stringSteps=stringSteps+TestRegistry.testSteps[i]+'\n';}
console.log(stringSteps);console.log("=======================  RECORDING END  =================================");TestRegistry.testSteps=[];}else{TestRegistry.appendIdTestToDOM();TestRegistry.writingTest=true;this.$.lbl.setContent(OB.I18N.getLabel('OBMOBC_LblMenuFinishRecording'));}}});if(OB.MobileApp.model.get('permissions').OBMOBC_MenuRecording||OB.UTIL.Debug.isDebug()){this.menuEntries.push({kind:'OBMOBC.UI.MenuRecording'});}
this.inherited(arguments);OB.MobileApp.model.on('change:connectedToERP',function(){this.setConnected();},this);this.setConnected();}});enyo.kind({name:'OB.UI.ModalReceiptProperties',kind:'OB.UI.ModalAction',handlers:{onApplyChanges:'applyChanges'},bodyContent:{kind:'Scroller',maxHeight:'225px',style:'background-color: #ffffff;',thumb:true,horizontal:'hidden',components:[{name:'attributes'}]},bodyButtons:{components:[{kind:'OB.UI.ReceiptPropertiesDialogApply'},{kind:'OB.UI.ReceiptPropertiesDialogCancel'}]},loadValue:function(mProperty){this.waterfall('onLoadValue',{model:this.model,modelProperty:mProperty});},applyChanges:function(inSender,inEvent){this.waterfall('onApplyChange',{});return true;},initComponents:function(){this.inherited(arguments);this.attributeContainer=this.$.bodyContent.$.attributes;enyo.forEach(this.newAttributes,function(natt){this.$.bodyContent.$.attributes.createComponent({kind:'OB.UI.PropertyEditLine',name:'line_'+natt.name,newAttribute:natt});},this);}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ReceiptPropertiesDialogApply',isDefaultAction:true,events:{onApplyChanges:''},tap:function(){if(this.doApplyChanges()){this.doHideThisPopup();}},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblApply'));}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ReceiptPropertiesDialogCancel',tap:function(){this.doHideThisPopup();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));}});enyo.kind({name:'OB.UI.PropertyEditLine',components:[{classes:'properties-label',name:'label',components:[{name:'labelLine',style:'padding: 5px 8px 0px 0px; font-size: 15px;',content:''}]},{style:'border: 1px solid #F0F0F0; float: left; width: 57%;',components:[{name:'newAttribute',classes:'modal-dialog-receipt-properties-text',style:'width: 98%'}]},{style:'clear: both'}],initComponents:function(){this.inherited(arguments);this.propertycomponent=this.$.newAttribute.createComponent(this.newAttribute);if(this.propertycomponent.height){this.$.label.applyStyle('height',this.propertycomponent.height);}
if(this.newAttribute.i18nLabel){this.$.labelLine.content=OB.I18N.getLabel(this.newAttribute.i18nLabel);}else{this.$.labelLine.content=this.newAttribute.label;}}});enyo.kind({name:'OB.UI.renderTextProperty',kind:'enyo.Input',type:'text',classes:'input',style:'width: 100%;margin-bottom:0px',handlers:{onLoadValue:'loadValue',onApplyChange:'applyChange'},events:{onSetProperty:'',onSetLineProperty:''},loadValue:function(inSender,inEvent){if(this.modelProperty===inEvent.modelProperty){if(inEvent.model&&inEvent.model.get(this.modelProperty)){this.setValue(inEvent.model.get(this.modelProperty));}else{this.setValue('');}}},applyChange:function(inSender,inEvent){return this.applyValue(inEvent.orderline);},applyValue:function(orderline){if(orderline){this.doSetLineProperty({line:orderline,property:this.modelProperty,value:this.getValue(),extraProperties:this.extraProperties});}else{this.doSetProperty({property:this.modelProperty,value:this.getValue(),extraProperties:this.extraProperties});}
return true;},initComponents:function(){if(this.readOnly){this.setAttribute('readonly','readonly');}
if(this.maxLength){this.setAttribute('maxLength',this.maxLength);}}});enyo.kind({name:'OB.UI.renderTextMultiLineProperty',kind:'enyo.TextArea',type:'text',height:'90px',classes:'input',style:'width: 100%; height: 80px',handlers:{onLoadValue:'loadValue',onApplyChange:'applyChange',onkeydown:'keydownHandler'},events:{onSetProperty:'',onSetLineProperty:''},loadValue:function(inSender,inEvent){if(this.modelProperty===inEvent.modelProperty){if(inEvent.model&&inEvent.model.get(this.modelProperty)){this.setValue(inEvent.model.get(this.modelProperty));}else{this.setValue('');}}},keydownHandler:function(inSender,inEvent){if(inEvent.keyCode===13){return true;}},applyChange:function(inSender,inEvent){return this.applyValue(inEvent.orderline);},applyValue:function(orderline){if(orderline){this.doSetLineProperty({line:orderline,property:this.modelProperty,value:this.getValue(),extraProperties:this.extraProperties});}else{this.doSetProperty({property:this.modelProperty,value:this.getValue(),extraProperties:this.extraProperties});}
return true;},initComponents:function(){if(this.readOnly){this.setAttribute('readonly','readonly');}}});enyo.kind({name:'OB.UI.renderBooleanProperty',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check',handlers:{onLoadValue:'loadValue',onApplyChange:'applyChange',onLoadContent:'loadContent'},events:{onSetProperty:'',onSetLineProperty:''},loadValue:function(inSender,inEvent){var i,splitResult,contentProperty,contentInModel;if(this.modelProperty===inEvent.modelProperty){if(inEvent.model.get(this.modelProperty)!==undefined){this.checked=inEvent.model.get(this.modelProperty);}
if(this.checked){this.addClass('active');}else{this.removeClass('active');}}
if(this.modelContent!==undefined&&this.modelContent!==""){splitResult=this.modelContent.split(':');if(splitResult.length>0){contentProperty=splitResult[0];if(contentProperty===inEvent.modelProperty){contentInModel=inEvent.model;for(i=0;i<splitResult.length;i++){contentInModel=contentInModel.get(splitResult[i]);}
if(contentInModel!==undefined){this.content=contentInModel;}}}}},applyChange:function(inSender,inEvent){if(this.disabled){return true;}
if(inEvent.orderline){this.doSetLineProperty({line:inEvent.orderline,property:this.modelProperty,value:this.checked,extraProperties:this.extraProperties});}else{this.doSetProperty({property:this.modelProperty,value:this.checked,extraProperties:this.extraProperties});}},initComponents:function(){if(this.readOnly){this.setDisabled(true);this.setAttribute('disabled','disabled');}}});enyo.kind({name:'OB.UI.renderComboProperty',handlers:{onLoadValue:'loadValue',onApplyChange:'applyChange'},events:{onSaveProperty:''},components:[{kind:'OB.UI.List',name:'renderCombo',classes:'combo',style:'width: 100%; margin:0;',renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get(this.parent.parent.retrievedPropertyForValue));this.setContent(this.model.get(this.parent.parent.retrievedPropertyForText));}}),renderEmpty:'enyo.Control'}],loadValue:function(inSender,inEvent){if(this.modelProperty===inEvent.modelProperty){this.$.renderCombo.setCollection(this.collection);this.fetchDataFunction(inEvent);}},dataReadyFunction:function(data,inEvent){var index=0,result=null;if(data){this.collection.reset(data.models);}else{this.collection.reset(null);return;}
result=_.find(this.collection.models,function(option){if(inEvent&&inEvent.model){if(option.get(this.retrievedPropertyForValue)===inEvent.model.get(this.modelProperty)){return true;}}else{if(option.get(this.retrievedPropertyForValue)===this.defaultValue){return true;}}
index+=1;},this);if(result){this.$.renderCombo.setSelected(index);}else{this.$.renderCombo.setSelected(0);}},applyChange:function(inSender,inEvent){var selected=this.collection.at(this.$.renderCombo.getSelected());if(selected){inSender.model.set(this.modelProperty,selected.get(this.retrievedPropertyForValue));}
if(this.modelPropertyText){inSender.model.set(this.modelPropertyText,selected.get(this.retrievedPropertyForText));}},initComponents:function(){this.inherited(arguments);if(this.readOnly){this.setAttribute('readonly','readonly');}}});(function(){var Session=Backbone.Model.extend({modelName:'Session',tableName:'ad_session',entityName:'Session',source:'org.openbravo.retail.posterminal.Session',properties:['id','user','terminal','active','_identifier','_idx'],propertyMap:{'id':'ad_session_id','user':'ad_user_id','terminal':'terminal','active':'active','_identifier':'_identifier','_idx':'_idx'},createStatement:'CREATE TABLE IF NOT EXISTS ad_session (ad_session_id TEXT PRIMARY KEY , ad_user_id TEXT, terminal TEXT, active TEXT, _identifier TEXT , _idx NUMERIC)',dropStatement:'DROP TABLE IF EXISTS ad_session',insertStatement:'INSERT INTO ad_session(ad_session_id, ad_user_id, terminal, active, _identifier, _idx)  VALUES (?, ?, ?, ?, ?, ?)',updateStatement:'',local:true});OB.Data.Registry.registerModel(Session);}());(function(){var User=Backbone.Model.extend({modelName:'User',tableName:'ad_user',entityName:'User',properties:['id','name','password','terminalinfo','formatInfo','created','_identifier','_idx'],propertyMap:{'id':'ad_user_id','name':'name','password':'password','terminalinfo':'terminalinfo','formatInfo':'formatInfo','created':'created','_identifier':'_identifier','_idx':'_idx'},createStatement:'CREATE TABLE IF NOT EXISTS ad_user (ad_user_id TEXT PRIMARY KEY , name TEXT , password TEXT , terminalinfo TEXT, formatInfo TEXT, created TEXT, _identifier TEXT , _idx NUMERIC)',dropStatement:'DROP TABLE IF EXISTS ad_user',insertStatement:'INSERT INTO ad_user(ad_user_id, name, password, terminalinfo, formatInfo, created, _identifier, _idx)  VALUES (?, ?, ?, ?, ?, ?, ?, ?)',updateStatement:'',local:true});OB.Data.Registry.registerModel(User);}());enyo.kind({name:'OB.UTIL.Approval',kind:'OB.UI.ModalAction',statics:{requestApproval:function(model,approvalType,callback){var dialog;var haspermission;if(!model.approvedRequest||!model.checkApproval){callback(true);return;}
if(_.isArray(approvalType)){haspermission=_.every(approvalType,function(a){return OB.MobileApp.model.hasPermission(a,true);});}else{haspermission=OB.MobileApp.model.hasPermission(approvalType,true);}
if(haspermission){model.approvedRequest(true,new Backbone.Model(OB.MobileApp.model.get('context').user),approvalType,callback);}else{dialog=OB.MobileApp.view.$.confirmationContainer.createComponent({kind:'OB.UTIL.Approval',model:model,approvalType:approvalType,callback:callback});dialog.show();}}},handlers:{onCheckCredentials:'checkCredentials',onUserImgClick:'handleUserImgClick'},i18nHeader:'OBMOBC_ApprovalRequiredTitle',bodyContent:{components:[{name:'explainApprovalTxt',style:'text-align: left; padding-left: 0.5em;'},{classes:'login-header-row',style:'color:black; line-height: 20px;',components:[{classes:'span6',components:[{kind:'Scroller',thumb:true,horizontal:'hidden',name:'loginUserContainer',classes:'login-user-container',style:'background-color:#5A5A5A; margin: 5px;',content:['.']}]},{classes:'span6',components:[{classes:'login-inputs-container',components:[{name:'loginInputs',classes:'login-inputs-browser-compatible',components:[{components:[{kind:'OB.UTIL.Approval.Input',name:'username'}]},{components:[{kind:'OB.UTIL.Approval.Input',name:'password',type:'password'}]}]}]}]}]}]},bodyButtons:{components:[{kind:'OB.UTIL.Approval.ApproveButton'},{kind:'OB.UI.ModalDialogButton',i18nLabel:'OBMOBC_LblCancel',tap:function(){this.bubble('onHideThisPopup',{args:{approvalSent:false}});}}]},executeOnHide:function(){if(this.args&&this.args.approvalSent){return;}else{this.model.approvedRequest(false,new Backbone.Model(OB.MobileApp.model.get('context').user),this.approvalType,this.callback);}},handleUserImgClick:function(inSender,inEvent){var u=inEvent.originator.user;this.$.bodyContent.$.username.setValue(u);this.$.bodyContent.$.password.setValue('');this.$.bodyContent.$.password.focus();return true;},initComponents:function(){var i,j;this.inherited(arguments);this.$.bodyContent.$.username.attributes.placeholder=OB.I18N.getLabel('OBMOBC_LoginUserInput');this.$.bodyContent.$.password.attributes.placeholder=OB.I18N.getLabel('OBMOBC_LoginPasswordInput');if(!Array.isArray(this.approvalType)){this.approvalType=[this.approvalType];}
for(i=0;i<this.approvalType.length;i++){if(this.approvalType[i]instanceof Object){if(this.approvalType[i].message instanceof Object){for(j=0;j<this.approvalType[i].message.length;j++){this.addTextComponent(this.approvalType[i].message[j]);}}else{this.addTextComponent({message:OB.I18N.getLabel(this.approvalType[i].message,this.approvalType[i].params)||OB.I18N.getLabel('OBMOBC_ApprovalTextHeader')});}}else{this.addTextComponent({message:OB.I18N.labels[this.approvalType[i]]||OB.I18N.getLabel('OBMOBC_ApprovalTextHeader')});}}
this.postRenderActions();},addTextComponent:function(msg){var style='';if(msg.padding){style+='padding-left: '+msg.padding+';';}
if(msg.fontSize){style+='font-size: '+msg.fontSize+';';}
if(msg.fontWeight){style+='font-weight: '+msg.fontWeight+';';}
if(msg.color){style+='color: '+msg.color+';';}
this.$.bodyContent.$.explainApprovalTxt.createComponent({style:style,content:msg.message,allowHtml:true});},setUserImages:function(inSender,inResponse){var name=[],userId=[],userName=[],image=[],connected=[],me=this,jsonImgData,i;if(!inResponse.data){OB.Dal.find(OB.Model.User,{},function(users){var i,user,session;for(i=0;i<users.models.length;i++){user=users.models[i];name.push(user.get('name'));userId.push(user.get('id'));userName.push(user.get('name'));connected.push(false);}
me.renderUserButtons(name,userId,userName,image,connected);},function(){OB.error(arguments);});return true;}
jsonImgData=inResponse.data;if(jsonImgData.length>0){enyo.forEach(jsonImgData,function(v){name.push(v.name);userId.push(v.userId);userName.push(v.userName);image.push(v.image);});this.renderUserButtons(name,userId,userName,image,connected);}else{this.showing=false;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_ApprovalRequiredTitle'),OB.I18N.getLabel('OBMOBC_NoSupervisorsText'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true}],{autoDismiss:false,onHideFunction:function(popup){me.model.approvedRequest(false,new Backbone.Model(OB.MobileApp.model.get('context').user),me.approvalType,me.callback);}});}},renderUserButtons:function(name,userId,userName,image){var i,target=this.$.bodyContent.$.loginUserContainer;for(i=0;i<name.length;i++){target.createComponent({kind:'OB.OBPOSLogin.UI.UserButton',user:userName[i],userId:userId[i],userImage:image[i],showConnectionStatus:false});}
target.render();return true;},postRenderActions:function(){var approvalList=[],me=this;this.approvalType.forEach(function(approvalType){approvalList.push(typeof(approvalType)==='object'?approvalType.approval:approvalType);});var params=OB.MobileApp.model.get('loginUtilsParams')||{};params.appName=OB.MobileApp.model.get('appName');params.command='userImages';params.approvalType=JSON.stringify(approvalList);var rr,ajaxRequest=new OB.OBPOSLogin.UI.LoginRequest({url:OB.MobileApp.model.get('loginUtilsUrl'),data:params,success:function(inSender,inResponse){me.setUserImages(inSender,inResponse);}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest});rr.exec(ajaxRequest.url);},checkCredentials:function(){var u=this.$.bodyContent.$.username.getValue(),p=this.$.bodyContent.$.password.getValue(),emptyUserPassword=(!u||!p);if(emptyUserPassword){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_EmptyUserPassword'));}else{this.model.checkApproval(this.approvalType,u,p,this.callback);}
this.waterfall('onHideThisPopup',{args:{approvalSent:!emptyUserPassword}});}});enyo.kind({name:'OB.UTIL.Approval.ApproveButton',kind:'OB.UI.ModalDialogButton',i18nLabel:'OBMOBC_Approve',events:{onCheckCredentials:''},tap:function(){this.doCheckCredentials();}});enyo.kind({name:'OB.UTIL.Approval.Input',kind:'enyo.Input',type:'text',classes:'input-login',handlers:{onkeydown:'inputKeydownHandler'},events:{onCheckCredentials:''},inputKeydownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===13){this.doCheckCredentials();return true;}
return false;}});enyo.kind({name:'OB.UI.DatePickerSimple',kind:'onyx.DatePicker',events:{onModified:''},create:function(){this.inherited(arguments);this._datenull=false;},setValue:function(value){var args=arguments;var newvalue=value;if(value){this._datenull=false;this.inherited(args);}else{args[0]=new Date();this._datenull=true;this.inherited(args);}
this.doModified({'value':newvalue});},getValue:function(){if(this._datenull){return null;}else{return this.inherited(arguments);}},rendered:function(){this.inherited(arguments);if(this._datenull){this.$.yearPickerButton.setContent('–');this.$.dayPickerButton.setContent('–');this.$.monthPickerButton.setContent('–');}}});enyo.kind({name:'OB.UI.DatePicker',style:'position: relative;',components:[{kind:'OB.UI.DatePickerSimple',name:'datepick',onModified:'modifiedDate',style:'float: left;'},{name:'resetbutton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'margin: 4px 6px 5px; width: 20px; float: left; cursor: pointer; padding: 8px;',ontap:'resetTap'},{style:'clear: both;'}],modifiedDate:function(inSender,inEvent){this.$.resetbutton.setShowing(inEvent.value);},resetTap:function(inSender,inEvent){this.$.datepick.setValue(null);},setValue:function(value){this.$.datepick.setValue(value);},getValue:function(){return this.$.datepick.getValue();},setLocale:function(locale){this.$.datepick.setLocale(locale);},getLocale:function(){return this.$.datepick.getLocale();}});enyo.kind({name:'OB.UI.RenderProduct',kind:'OB.UI.SelectButton',components:[{style:'float: left; width: 25%',components:[{kind:'OB.UI.Thumbnail',name:'thumbnail'}]},{style:'float: left; width: 55%;',components:[{name:'identifier',style:'padding-left: 5px;'}]},{name:'price',style:'float: left; width: 20%; text-align: right; font-weight:bold;'},{style:'clear:both;'}],initComponents:function(){this.inherited(arguments);this.$.identifier.setContent(this.model.get('_identifier'));this.$.price.setContent(OB.I18N.formatCurrency(this.model.get('standardPrice')));var image;if(OB.MobileApp.model.get('permissions')["OBPOS_retail.productImages"]){image=OB.UTIL.getImageURL(this.model.get('id'));this.$.thumbnail.setImgUrl(image);}else{image=this.model.get('img');this.$.thumbnail.setImg(image);}}});enyo.kind({name:'OB.UI.RenderCategory',kind:'OB.UI.SelectButton',components:[{style:'float: left; width: 25%',components:[{kind:'OB.UI.Thumbnail',name:'thumbnail'}]},{style:'float: left; width: 75%;',components:[{name:'identifier',style:'padding-left: 5px;'},{style:'clear:both;'}]}],initComponents:function(){this.inherited(arguments);this.addClass('btnselect-browse');this.$.identifier.setContent(this.model.get('_identifier'));this.$.thumbnail.setImg(this.model.get('img'));}});enyo.kind({name:'OB.UI.ProductBrowser',useCharacteristics:true,classes:'row-fluid',components:[{classes:'span6',components:[{kind:'OB.UI.BrowseProducts',name:'browseProducts'}]},{classes:'span6',components:[{kind:'OB.UI.BrowseCategories',name:'browseCategories'}]}],init:function(){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){return;}
this.$.browseProducts.$.listProducts.useCharacteristics=this.useCharacteristics;this.$.browseCategories.$.listCategories.categories.on('selected',function(category){this.$.browseProducts.$.listProducts.loadCategory(category);},this);}});enyo.kind({name:'OB.UI.BrowseCategories',style:'overflow:auto; height: 612px; margin: 5px;',components:[{style:'background-color: #ffffff; color: black; padding: 5px',components:[{kind:'OB.UI.ListCategories',name:'listCategories'}]}]});enyo.kind({name:'OB.UI.BrowseProducts',style:'margin: 5px;',components:[{style:'background-color: #ffffff; color: black; padding: 5px',components:[{kind:'OB.UI.ListProducts',name:'listProducts'}]}]});enyo.kind({kind:'OB.UI.ScrollableTableHeader',name:'OB.UI.CategoryListHeader',style:'padding: 10px; border-bottom: 1px solid #cccccc;',components:[{style:'line-height: 27px; font-size: 18px; font-weight: bold;',name:'title',content:''}],initComponents:function(){this.inherited(arguments);this.$.title.setContent(OB.I18N.getLabel('OBMOBC_LblCategories'));}});enyo.kind({name:'OB.UI.ListCategories',components:[{name:'categoryTable',scrollAreaMaxHeight:'574px',listStyle:'list',kind:'OB.UI.ScrollableTable',renderHeader:'OB.UI.CategoryListHeader',renderEmpty:'OB.UI.RenderEmpty',renderLine:'OB.UI.RenderCategory',columns:['thumbnail','identifier']}],init:function(){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){return;}
var me=this;this.categories=new OB.Collection.ProductCategoryList();this.$.categoryTable.setCollection(this.categories);function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBestSellerProducts(products,context){if(context.me.destroyed){return;}
if(products&&products.length>0){var virtualBestSellerCateg=new OB.Model.ProductCategory();virtualBestSellerCateg.createBestSellerCategory();context.categories.add(virtualBestSellerCateg,{at:0});}
context.me.categories.reset(context.categories.models);}
function successCallbackCategories(dataCategories,me){if(me.destroyed){return;}
var bestSellerCriteria,context;if(dataCategories&&dataCategories.length>0){bestSellerCriteria={'bestseller':'true'};if(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true)){bestSellerCriteria._limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true));}
context={me:me,categories:dataCategories};OB.Dal.find(OB.Model.Product,bestSellerCriteria,successCallbackBestSellerProducts,errorCallback,context);}else{me.categories.reset();}}
OB.Dal.find(OB.Model.ProductCategory,null,successCallbackCategories,errorCallback,this);}});enyo.kind({kind:'OB.UI.ScrollableTableHeader',name:'OB.UI.ProductListHeader',style:'padding: 10px; border-bottom: 1px solid #cccccc;',components:[{style:'line-height: 27px; font-size: 18px; font-weight: bold;',name:'title'}],setHeader:function(valueToSet){this.$.title.setContent(valueToSet);},getValue:function(){return this.$.title.getContent();}});enyo.kind({name:'OB.UI.ListProducts',events:{onAddProduct:'',onShowLeftSubWindow:'',onTabChange:''},handlers:{onChangePricelist:'changePricelist'},components:[{kind:'OB.UI.ScrollableTable',name:'productTable',scrollAreaMaxHeight:'574px',renderHeader:'OB.UI.ProductListHeader',renderEmpty:'OB.UI.RenderEmpty',renderLine:'OB.UI.RenderProduct',columns:['thumbnail','identifier','price','generic']}],init:function(){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){return;}
var me=this;this.inherited(arguments);this.products=new OB.Collection.ProductList();this.$.productTable.setCollection(this.products);this.products.on('click',function(model){if(this.useCharacteristics){if(!model.get('isGeneric')){me.doAddProduct({product:model});}else{me.doTabChange({tabPanel:'searchCharacteristic',keyboard:false,edit:false,options:model});}}else{me.doAddProduct({product:model});}},this);},changePricelist:function(inSender,inEvent){this.currentPriceList=inEvent.priceList;this.loadCategory(this.currentCategory);},loadCategory:function(category){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){return;}
var criteria,me=this;function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackProducts(dataProducts){var filteredDataProducts;if(me.destroyed){return;}
if(dataProducts&&dataProducts.length>0){filteredDataProducts=new OB.Collection.ProductList(dataProducts.filter(function(model){return model.get('productType')!=='S'||!model.get('isLinkedToProduct');}));me.products.reset(filteredDataProducts.models);}else{me.products.reset();}
me.$.productTable.getHeader().setHeader(category.get('_identifier'));}
if(category){this.currentCategory=category;var where="where ";if(category.get('id')==='OBPOS_bestsellercategory'){criteria={'bestseller':'true'};where+="p.bestseller = ?";if(this.useCharacteristics){criteria.generic_product_id=null;}}else{criteria={'productCategory':category.get('id')};where+="p.m_product_category_id = ?";if(this.useCharacteristics){criteria.generic_product_id=null;}}
criteria._orderByClause='upper(_identifier) asc';if(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true)){criteria._limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true));}
if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)&&this.currentPriceList&&this.currentPriceList!==OB.MobileApp.model.get('terminal').priceList){var select="select p.*, pp.pricestd as currentStandardPrice "
+"from m_product p inner join m_productprice pp on p.m_product_id = pp.m_product_id and pp.m_pricelist_id = ? "
+where;var limit=null;if(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true)){limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true));}
OB.Dal.query(OB.Model.Product,select,[this.currentPriceList,category.get('id')==='OBPOS_bestsellercategory'?'true':category.get('id')],successCallbackProducts,errorCallback,null,null,limit);}else{OB.Dal.find(OB.Model.Product,criteria,successCallbackProducts,errorCallback);}}else{this.products.reset();this.$.productTable.getHeader().setHeader(OB.I18N.getLabel('OBMOBC_LblNoCategory'));}}});var FilterBuilderOption=Backbone.Model.extend({defaults:{id:'',name:''}});var FilterBuilderOptionList=Backbone.Collection.extend({model:FilterBuilderOption});var FilterBuilderRow=Backbone.Model.extend({defaults:{id:'',selected:true,fieldType:''}});var FilterBuilderRowList=Backbone.Collection.extend({model:FilterBuilderRow});enyo.kind({name:'OB.UI.ModalSearchFilterBuilderTopHeader',kind:'OB.UI.ScrollableTableHeader',events:{onHideThisPopup:'',onSelectFilter:'',onSearchAction:''},components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{name:'title',style:'text-align: center; vertical-align: middle'}]},{style:'display: table-cell;',components:[{name:'doneBrandButton',kind:'OB.UI.SmallButton',ontap:'doneAction'}]},{style:'display: table-cell;',components:[{classes:'btnlink-gray',name:'cancelBrandButton',kind:'OB.UI.SmallButton',ontap:'cancelAction'}]}]}],initComponents:function(){this.inherited(arguments);this.$.doneBrandButton.setContent(OB.I18N.getLabel('OBMOBC_LblDone'));this.$.cancelBrandButton.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));},doneAction:function(){var filter=this.parent.parent.parent.filter,renderInfo=filter.renderInfo(),filters=[],hasError=false;if(renderInfo){filters=renderInfo.getFilterCondition();}else{var conditions=this.parent.parent.parent.$.body.$.standardBuilderConditions.$.tbody.controls;conditions.forEach(function(item){var row=item.$.modalSearchFilterBuilderRow.$;if(row.filterCheckBox.checked){var value=row.filterValue.getValue(),sqlBuilder=filter.sqlBuilder();if(sqlBuilder.fieldType.toUpperCase()==="STRING"&&!value&&!value.trim()){OB.UTIL.showAlert.display(OB.I18N.getLabel('OBMOBC_FilterQueryBuilderErrEmptyValue'),"Error","alert-error",false);hasError=true;}
if(sqlBuilder.fieldType.toUpperCase()==="NUMBER"){var error=true;if(value.match(/^\d*\.{0,1}\d*$/)!==null||value.match(/^\d*\,{0,1}\d*$/)!==null){value=value.replace(',','.');error=false;}
if(error||isNaN(parseFloat(value))){OB.UTIL.showAlert.display(OB.I18N.getLabel('OBMOBC_FilterQueryBuilderErrInvalidNumber'),"Error","alert-error",false);hasError=true;}}
filters.push({condition:row.filterCondition.getValue(),value:sqlBuilder.fieldType.toUpperCase()==="NUMBER"?parseFloat(value):value});}});}
if(!hasError){filter.conditions=filters;this.doSelectFilter({filter:filter});this.doHideThisPopup();}},cancelAction:function(){this.doHideThisPopup();}});enyo.kind({name:'OB.UI.ModalSearchFilterBuilderRow',style:'display: table;  width: 100%;',components:[{name:'filterCheckBox',kind:'OB.UI.CheckboxButton',tag:'div',style:'display: table-cell; width: 50px;'},{style:'display: table-cell; width: 180px; padding-top: 5px;',components:[{kind:'OB.UI.List',name:'filterCondition',classes:'combo',style:'width: 90%',renderEmpty:'enyo.Control',renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('name'));}})}]},{style:'display: table-cell; width: 120px;',kind:'OB.UI.SearchInput',name:'filterValue'}],initComponents:function(){this.inherited(arguments);var cond=this.model.get("condition"),items=new FilterBuilderOptionList();this.$.filterCondition.setCollection(items);items.add(new FilterBuilderOption({id:'MORE_THAN',name:OB.I18N.getLabel('OBMOBC_FilterQueryBuilderMoreThan')}));items.add(new FilterBuilderOption({id:'LESS_THAN',name:OB.I18N.getLabel('OBMOBC_FilterQueryBuilderLessThan')}));items.add(new FilterBuilderOption({id:'EQUALS',name:OB.I18N.getLabel('OBMOBC_FilterQueryBuilderEquals')}));items.add(new FilterBuilderOption({id:'NOT_EQUALS',name:OB.I18N.getLabel('OBMOBC_FilterQueryBuilderNotEquals')}));if(this.model.get("fieldType").toUpperCase()==="STRING"){items.add(new FilterBuilderOption({id:'CONTAINS',name:OB.I18N.getLabel('OBMOBC_FilterQueryBuilderContains')}));items.add(new FilterBuilderOption({id:'NOT_CONTAINS',name:OB.I18N.getLabel('OBMOBC_FilterQueryBuilderNotContains')}));}
this.$.filterCheckBox.check();this.$.filterCondition.setSelected(cond==='MORE_THAN'?0:cond==='LESS_THAN'?1:cond==='EQUALS'?2:cond==='NOT_EQUALS'?3:cond==='CONTAINS'?4:5);this.$.filterValue.setValue(this.model.get("value"));}});enyo.kind({name:'OB.UI.ModalSearchFilterBuilder',topPosition:'170px',kind:'OB.UI.Modal',published:{characteristic:null},executeOnShow:function(args){this.filter=this.args.filter;var me=this,renderInfo=this.filter.renderInfo();this.sqlBuilder=this.filter.sqlBuilder();this.$.header.parent.addStyles('padding: 0px; border-bottom: 1px solid #cccccc');this.$.header.$.modalSearchFilterBuilderTopHeader.$.title.setContent(this.filter.getCaption());if(renderInfo){this.$.body.$.standardBuilder.hide();this.$.body.$.customBuilder.show();this.$.body.$.customBuilder.createComponent(renderInfo);}else{this.filterRows=new FilterBuilderRowList();if(this.filter.conditions&&_.isArray(this.filter.conditions)&&this.filter.conditions.length>0){this.filter.conditions.forEach(function(cond){me.addFilterRow(cond.condition,cond.value);});}else if(this.filter.defaults&&_.isArray(this.filter.defaults)&&this.filter.defaults.length>0){this.filter.defaults.forEach(function(cond){me.addFilterRow(cond.condition,cond.value);});}else{this.addFilterRow('MORE_THAN','');}
this.$.body.$.customBuilder.hide();this.$.body.$.standardBuilder.show();this.$.body.$.standardBuilderConditions.setCollection(this.filterRows);}},addFilterRow:function(condition,value){this.filterRows.add(new FilterBuilderRow({id:OB.UTIL.get_UUID(),selected:true,fieldType:this.sqlBuilder.fieldType,condition:condition,value:value}));},i18nHeader:'',body:{components:[{name:'standardBuilder',components:[{kind:'OB.UI.ScrollableTable',name:'standardBuilderConditions',scrollAreaMaxHeight:'300px',renderEmpty:'OB.UI.RenderEmptyCh',renderLine:'OB.UI.ModalSearchFilterBuilderRow'},{kind:'Image',src:'../org.openbravo.mobile.core/assets/img/iconAdd.png',sizing:"cover",width:42,height:42,tap:function(){this.owner.owner.addFilterRow('MORE_THAN','');}}]},{name:'customBuilder'}]},initComponents:function(){this.inherited(arguments);this.$.closebutton.hide();this.$.header.createComponent({kind:'OB.UI.ModalSearchFilterBuilderTopHeader',style:'border-bottom: 0px'});}});enyo.kind({name:'OB.UI.SearchProductHeader',kind:'OB.UI.ScrollableTableHeader',events:{onSearchAction:'',onClearAction:''},handlers:{onFiltered:'searchAction'},components:[{style:'padding: 10px 10px 5px 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'productname',style:'width: 100%;',minLengthToSearch:2}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]},{style:'margin: 5px 0px 0px 0px;',components:[{kind:'OB.UI.List',name:'productcategory',classes:'combo',style:'width: 100%',renderHeader:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue('__all__');this.setContent(OB.I18N.getLabel('OBMOBC_SearchAllCategories'));}}),renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));}}),renderEmpty:'enyo.Control'}]}]}],setHeaderCollection:function(valueToSet){this.$.productcategory.setCollection(valueToSet);},searchAction:function(){this.doSearchAction({productCat:this.$.productcategory.getValue(),productName:this.$.productname.getValue()});return true;},clearAction:function(){this.$.productname.setValue('');this.$.productcategory.setSelected(0);this.doClearAction();}});enyo.kind({name:'OB.UI.SearchProduct',style:'margin: 5px; background-color: #ffffff; color: black; padding: 5px; height: 612px;',published:{receipt:null},handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},events:{onAddProduct:''},executeOnShow:function(){var me=this;setTimeout(function(){me.$.products.$.theader.$.searchProductHeader.$.productname.focus();},400);},components:[{classes:'row-fluid',components:[{classes:'span12',components:[{classes:'row-fluid',style:'border-bottom: 1px solid #cccccc;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{kind:'OB.UI.ScrollableTable',name:'products',scrollAreaMaxHeight:'482px',renderHeader:'OB.UI.SearchProductHeader',renderEmpty:'OB.UI.RenderEmpty',renderLine:'OB.UI.RenderProduct'}]}]}]}]}]}],init:function(){var me=this;this.inherited(arguments);this.categories=new OB.Collection.ProductCategoryList();this.products=new OB.Collection.ProductList();this.$.products.setCollection(this.products);this.$.products.getHeader().setHeaderCollection(this.categories);function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackCategories(dataCategories,me){if(dataCategories&&dataCategories.length>0){me.categories.reset(dataCategories.models);}else{me.categories.reset();}}
this.products.on('click',function(model){this.doAddProduct({product:model});},this);OB.Dal.find(OB.Model.ProductCategory,null,successCallbackCategories,errorCallback,this);},receiptChanged:function(){this.receipt.on('clear',function(){this.$.products.$.theader.$.searchProductHeader.$.productname.setContent('');this.$.products.$.theader.$.searchProductHeader.$.productcategory.setContent('');},this);},clearAction:function(inSender,inEvent){this.products.reset();},searchAction:function(inSender,inEvent){var criteria={},me=this;function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackProducts(dataProducts){if(me.destroyed){return;}
if(dataProducts&&dataProducts.length>0){me.products.reset(dataProducts.models);me.products.trigger('reset');}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_NoProductsFound'));me.products.reset();}}
if(inEvent.productName){criteria._filter={operator:OB.Dal.CONTAINS,value:inEvent.productName};}
if(inEvent.productCat&&inEvent.productCat!=='__all__'){criteria.productCategory=inEvent.productCat;}
OB.Dal.find(OB.Model.Product,criteria,successCallbackProducts,errorCallback);}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.BrandButton',style:'width: 86%; padding: 0px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;',classes:'btnlink-white-simple',events:{onShowPopup:''},tap:function(){if(!this.disabled){this.doShowPopup({popup:'modalproductbrand'});}},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblBrand'));}});enyo.kind({name:'OB.UI.SearchProductCharacteristicFilterPanel',style:'margin-bottom: 14px;',classes:'filter-panel-enabled',events:{onRemoveCustomFilter:''},handlers:{onRightToolbarDisabled:'toggleStatus'},components:[{name:'removeFilter',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 30px; float: right; cursor: pointer; padding-top: 0.1em;',ontap:'removeCustomFilter'},{name:'infoPanel',style:'padding-left: 6px; padding-bottom: 0.1em; padding-top: 0.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 90%;'}],removeCustomFilter:function(){this.doRemoveCustomFilter({index:this.index});},toggleStatus:function(inSender,inEvent){if(inEvent.status){this.$.removeFilter.hide();this.addRemoveClass('filter-panel-enabled',false);this.addRemoveClass('filter-panel-disabled',true);}else{this.$.removeFilter.show();this.addRemoveClass('filter-panel-enabled',true);this.addRemoveClass('filter-panel-disabled',false);}},initComponents:function(){this.inherited(arguments);if(this.customContent===null){this.$.infoPanel.setContent(this.caption+" "+OB.I18N.getLabel('OBMOBC_Character')[0]+" "+this.text);}else{this.$.infoPanel.createComponent(this.customContent);}}});enyo.kind({name:'OB.UI.SearchProductCharacteristicFilter',published:{type:'PANEL',caption:'',text:null},events:{onAddProduct:''},conditions:[],defaults:[],renderInfo:function(){return null;},hqlCriteria:function(){},sqlFilter:function(){if(this.type==='BUTTON'&&this.conditions&&_.isArray(this.conditions)&&this.conditions.length>0){var where="",filters=[],sqlBuilderInfo=this.sqlBuilder();this.conditions.forEach(function(cond){var condValue=cond.value;if(where!==""){where=where+" and ";}
where=where+sqlBuilderInfo.field;if(cond.condition==='MORE_THAN'){where=where+" > ?";}
if(cond.condition==='LESS_THAN'){where=where+" < ?";}
if(cond.condition==='EQUALS'){where=where+" = ?";}
if(cond.condition==='NOT_EQUALS'){where=where+" <> ?";}
if(cond.condition==='CONTAINS'){where=where+" like ?";condValue="%"+cond.value+"%";}
if(cond.condition==='NOT_CONTAINS'){where=where+" not like ?";condValue="%"+cond.value+"%";}
filters.push(condValue);});return{where:" and ("+where+")",filters:filters};}else{return{where:null,filters:[]};}},sqlBuilder:function(){return{field:'',fieldType:''};},lineAttributes:function(){return null;},postProcess:null,addItemAttributes:function(item,attr){var filterAttr=item.get("filterAttr");if(!filterAttr){item.set("filterAttr",[]);filterAttr=item.get("filterAttr");}
filterAttr.push({value:attr,separator:this.attributesSeparator});},attributesSeparator:', '});enyo.kind({name:'OB.UI.SearchProductCharacteristicHeader',kind:'OB.UI.ScrollableTableHeader',events:{onSearchAction:''},handlers:{onFiltered:'searchAction',onClearAllAction:'clearAllAction',onFinishServiceProposal:'finishServiceProposal'},components:[{style:'padding: 10px 10px 5px 10px;',components:[{style:'margin: 5px 0px 0px 0px; width: 100%',name:'filterpanel'},{style:'display: table;  width: 100%;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'productFilterText',style:'width: 100%;',minLengthToSearch:2}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAllAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]},{style:'margin: 5px 0px 0px 0px;',components:[{kind:'OB.UI.List',name:'productcategory',classes:'combo',style:'width: 100%',renderHeader:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue('__all__');this.setContent(OB.I18N.getLabel('OBMOBC_SearchAllCategories'));}}),renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));}}),renderEmpty:'enyo.Control'}]},{name:'filteringBy',style:'text-align: left; font-weight: bold; font-size: 15px; color: #aaaaaa'}]}],setHeaderCollection:function(valueToSet){this.$.productcategory.setCollection(valueToSet);},searchAction:function(){this.doSearchAction({productCat:this.$.productcategory.getValue(),productName:this.$.productFilterText.getValue(),skipProduct:false,skipProductCharacteristic:false});return true;},clearAllAction:function(){this.$.productFilterText.setValue('');this.$.productcategory.setSelected(0);this.$.filteringBy.setContent('');this.parent.$.brandButton.removeClass('btnlink-yellow-bold');var buttons=this.parent.$.filterButtons.getComponents();buttons.forEach(function(btn){btn.removeClass('btnlink-yellow-bold');});this.parent.filterCustomClearConditions();this.parent.model.set('filter',[]);this.parent.model.set('brandFilter',[]);this.parent.genericParent=null;this.parent.products.reset();this.doSearchAction({productCat:this.$.productcategory.getValue(),productName:this.$.productFilterText.getValue(),skipProduct:true,skipProductCharacteristic:false});},finishServiceProposal:function(inSender,inEvent){var status=inEvent.status;this.$.productFilterText.setValue(status.filterText);this.$.productcategory.setSelected(status.category);this.$.filteringBy.setContent(status.filteringBy);this.parent.model.set('filter',status.filter);this.parent.model.set('brandFilter',status.brandFilter);if(status.brandFilter.length>0){this.parent.$.brandButton.addClass('btnlink-yellow-bold');}else{this.parent.$.brandButton.removeClass('btnlink-yellow-bold');}
OB.UI.SearchProductCharacteristic.prototype.filtersCustomClear();OB.UI.SearchProductCharacteristic.prototype.filterCustomClearConditions();OB.UI.SearchProductCharacteristic.prototype.setFilterCustomConditions(status.customFilters);this.owner.filtersCustomRender();this.parent.genericParent=status.genericParent;var buttons=this.parent.$.filterButtons.getComponents();buttons.forEach(function(btn){if(btn.filter.conditions&&_.isArray(btn.filter.conditions)&&btn.filter.conditions.length>0){btn.addClass('btnlink-yellow-bold');}else{btn.removeClass('btnlink-yellow-bold');}});this.doSearchAction({productCat:this.$.productcategory.getValue(),productName:this.$.productFilterText.getValue(),skipProduct:false,skipProductCharacteristic:false});},init:function(){var me=this;this.inherited(arguments);this.categories=new OB.Collection.ProductCategoryList();this.products=new OB.Collection.ProductList();this.setHeaderCollection(this.categories);function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackCategories(dataCategories,me){if(me.destroyed){return;}
if(dataCategories&&dataCategories.length>0){var bestSeller=new Backbone.Model({_identifier:OB.I18N.getLabel('OBPOS_bestSellerCategory'),name:OB.I18N.getLabel('OBPOS_bestSellerCategory'),value:OB.I18N.getLabel('OBPOS_bestSellerCategory'),id:OB.I18N.getLabel('OBPOS_bestSellerCategory')});dataCategories.models.unshift(bestSeller);me.categories.reset(dataCategories.models);}else{me.categories.reset();}}
this.products.on('click',function(model){this.doAddProduct({product:model});},this);OB.Dal.find(OB.Model.ProductCategory,null,successCallbackCategories,errorCallback,this);}});enyo.kind({name:'OB.UI.SearchProductCharacteristic',classes:'span12',style:'background-color: #ffffff; color: black; height: 612px;',published:{receipt:null,genericParent:null},handlers:{onChangePricelist:'changePricelist',onSearchAction:'searchAction',onClearAction:'clearAction',onUpdateFilter:'filterUpdate',onUpdateBrandFilter:'brandFilterUpdate',onRemoveCustomFilter:'removeCustomFilter',onCustomFilterUpdate:'customFilterUpdate'},events:{onAddProduct:'',onSearchAction:'',onClearAction:'',onTabChange:'',onManageServiceProposal:'',onToggleLineSelection:''},customFilters:[],postProcessCustomFilters:[],productCharacteristicFilterQualifier:'PCH_Filter',setFilterCustomConditions:function(customFilters){var me=this;customFilters.forEach(function(filter){if(filter.type==='PANEL'){OB.UI.SearchProductCharacteristic.prototype.filtersCustomAdd(filter);}else if(filter.type==='BUTTON'){me.customFilters.forEach(function(cust){if(cust.id===filter.id){cust.conditions=filter.conditions;}});}});},nameFilterTypes:[{filterName:'STD',filterImplementor:function(textFilter){return'%'+textFilter+'%';}},{filterName:'Sameorder',filterImplementor:function(textFilter){return'%'+textFilter.replace(/ /gi,'%')+'%';}}],filtersCustomClear:function(){var i=0;while(i<this.customFilters.length){if(this.customFilters[i].type==='PANEL'||this.customFilters[i].type==='HIDDEN'){this.customFilters.splice(i,1);}else if(this.customFilters[i].type==='BUTTON'){this.customFilters[i].conditions=null;this.filtersCustomCopyDefaults(this.customFilters[i]);i++;}}
this.filtersCustomBuildPostProcess();},filterCustomClearConditions:function(){this.customFilters.forEach(function(filter){if(filter.type==='BUTTON'){filter.conditions=[];}});},filtersCustomCopyDefaults:function(filter){if(filter.defaults&&_.isArray(filter.defaults)&&filter.defaults.length>0){filter.conditions=[];filter.defaults.forEach(function(item){filter.conditions.push(item);});}},filtersCustomBuildPostProcess:function(){var me=this;this.postProcessCustomFilters=[];this.customFilters.forEach(function(filter){if(filter.postProcess&&typeof(filter.postProcess)==="function"){me.postProcessCustomFilters.push(filter);}});},filtersCustomAdd:function(filter){this.customFilters.push(filter);if(filter.postProcess&&typeof(filter.postProcess)==="function"){this.postProcessCustomFilters.push(filter);}},filtersCustomRender:function(){var index=0,me=this,filtersPanels=this.$.searchProductCharacteristicHeader.$.filterpanel.getComponents(),filtersButtons=this.$.filterButtons.getComponents();filtersPanels.forEach(function(item){item.destroy();});filtersButtons.forEach(function(item){item.destroy();});this.customFilters.sort(function(a,b){if(a.text<b.text){return-1;}
if(b.text<a.text){return 1;}
return 0;});this.customFilters.forEach(function(filter){filter.index=index;if(filter.type==='PANEL'){me.$.searchProductCharacteristicHeader.$.filterpanel.createComponent({kind:'OB.UI.SearchProductCharacteristicFilterPanel',name:filter.filterName,text:filter.getText(),caption:filter.getCaption(),index:index++,customContent:filter.renderInfo(),style:'width: 99.42%;'});}
if(filter.type==='BUTTON'){me.$.filterButtons.createComponent({kind:'OB.UI.SmallButton',style:'width: 86%; padding: 0px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;',classes:'btnlink-white-simple',content:filter.getText(),index:index++,customContent:filter.renderInfo(),filter:filter,events:{onShowPopup:''},tap:function(){this.bubble('onShowPopup',{popup:'modalsearchfilterbuilder',args:{filter:this.filter}});}});}});this.$.searchProductCharacteristicHeader.$.filterpanel.render();this.$.filterButtons.render();},removeCustomFilter:function(inSender,inEvent){this.customFilters.splice(inEvent.index,1);this.filtersCustomBuildPostProcess();this.filtersCustomRender();this.doSearchAction({productCat:this.$.searchProductCharacteristicHeader.$.productcategory.getValue(),productName:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),filter:this.model.get('filter'),skipProduct:false,skipProductCharacteristic:false});},filterUpdate:function(inSender,inEvent){var i,j,valuesIds,index,chValue=inEvent.value.value;valuesIds=this.model.get('filter').map(function(e){return e.id;});for(j=0;j<chValue.length;j++){index=valuesIds.indexOf(chValue[j].get('id'));if(index===-1){if(chValue[j].get('checked')){this.model.get('filter').push({characteristic_id:chValue[j].get('characteristic_id'),id:chValue[j].get('id'),name:chValue[j].get('name'),checked:chValue[j].get('checked'),selected:chValue[j].get('selected')});}}else{if(!chValue[j].get('checked')){this.model.get('filter').splice(index,1);valuesIds.splice(index,1);}else{this.model.get('filter')[index]={characteristic_id:chValue[j].get('characteristic_id'),id:chValue[j].get('id'),name:chValue[j].get('name'),checked:chValue[j].get('checked'),selected:chValue[j].get('selected')};}}}
this.model.set('filter',_.sortBy(this.model.get('filter'),function(e){return e.characteristic_id;}));this.filteringBy();this.doSearchAction({productCat:this.$.searchProductCharacteristicHeader.$.productcategory.getValue(),productName:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),filter:this.model.get('filter'),skipProduct:false,skipProductCharacteristic:false});return true;},brandFilterUpdate:function(inSender,inEvent){var i,j,valuesIds,index,brandValue=inEvent.value.value;valuesIds=this.model.get('brandFilter').map(function(e){return e.id;});for(j=0;j<brandValue.length;j++){index=valuesIds.indexOf(brandValue[j].get('id'));if(index===-1&&brandValue[j].get('checked')){this.model.get('brandFilter').push({id:brandValue[j].get('id'),name:brandValue[j].get('name')});}else if(index!==-1&&(_.isUndefined(brandValue[j].get('checked'))||!brandValue[j].get('checked'))){this.model.get('brandFilter').splice(index,1);valuesIds.splice(index,1);}}
this.model.set('filter',_.sortBy(this.model.get('filter'),function(e){return e.characteristic_id;}));this.filteringBy();if(this.model.get('brandFilter').length>0){this.$.brandButton.addClass('btnlink-yellow-bold');}else{this.$.brandButton.removeClass('btnlink-yellow-bold');}
this.doSearchAction({productCat:this.$.searchProductCharacteristicHeader.$.productcategory.getValue(),productName:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),filter:this.model.get('filter'),skipProduct:false,skipProductCharacteristic:false});return true;},customFilterUpdate:function(inSender,inEvent){if(inEvent.filter&&inEvent.filter.index!==undefined){var buttons=this.$.filterButtons.getComponents();buttons.forEach(function(btn){if(btn.index===inEvent.filter.index){if(inEvent.filter.conditions&&_.isArray(inEvent.filter.conditions)&&inEvent.filter.conditions.length>0){btn.addClass('btnlink-yellow-bold');}else{btn.removeClass('btnlink-yellow-bold');}}});}
this.doSearchAction({productCat:this.$.searchProductCharacteristicHeader.$.productcategory.getValue(),productName:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),filter:this.model.get('filter'),skipProduct:false,skipProductCharacteristic:false});return true;},filteringBy:function(){var filteringBy=OB.I18N.getLabel('OBMOBC_FilteringBy'),selectedItems,i;selectedItems=_.compact(this.model.get('filter').map(function(e){if(e.selected){return e.name;}}));if((_.isUndefined(this.genericParent)||_.isNull(this.genericParent))&&selectedItems.length===0&&this.model.get('brandFilter').length===0){this.$.searchProductCharacteristicHeader.$.filteringBy.setContent('');return true;}
if(!_.isUndefined(this.genericParent)&&!_.isNull(this.genericParent)){filteringBy=filteringBy+' '+this.genericParent.get('_identifier');if(selectedItems.length+this.model.get('brandFilter').length>0){filteringBy=filteringBy+', ';}}
for(i=0;i<selectedItems.length;i++){filteringBy=filteringBy+' '+selectedItems[i];if(i!==selectedItems.length-1||(i===selectedItems.length-1&&this.model.get('brandFilter').length>0)){filteringBy=filteringBy+', ';}}
for(i=0;i<this.model.get('brandFilter').length;i++){filteringBy=filteringBy+' '+this.model.get('brandFilter')[i].name;if(i!==this.model.get('brandFilter').length-1){filteringBy=filteringBy+', ';}}
this.$.searchProductCharacteristicHeader.$.filteringBy.setContent(filteringBy);},executeOnShow:function(model){this.filtersCustomRender();var me=this,criteria={};this.doClearAction();this.genericParent=model;this.doSearchAction({productCat:this.$.searchProductCharacteristicHeader.$.productcategory.getValue(),productName:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),filter:this.model.get('filter'),skipProduct:!this.genericParent,skipProductCharacteristic:false});this.filteringBy();setTimeout(function(){me.parent.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.productFilterText.focus();},200);},components:[{kind:'OB.UI.SearchProductCharacteristicHeader',classes:'span12',style:'display: table-cell; '},{style:'display: table; width:100%',components:[{name:'characteristicsFilterContainer',style:'width: 150px;',classes:'row-fluid',components:[{components:[{kind:'OB.UI.BrandButton',name:'brandButton'},{name:'filterButtons',classes:'row-fluid'},{kind:'OB.UI.ScrollableTable',name:'productsCh',scrollAreaMaxHeight:'483px',renderEmpty:'OB.UI.RenderEmptyCh',renderLine:'OB.UI.RenderProductCh',executeAfterClear:function(){var searchCharacteristicTabContent=this.parent.parent.parent.parent,leftAreaProductsCh=document.getElementById(searchCharacteristicTabContent.$.productsCh.$.scrollArea.id);if(leftAreaProductsCh){leftAreaProductsCh.style.height='0px';}},executeAfterRender:function(){var searchCharacteristicTabContent=this.parent.parent.parent.parent,totalArea=document.getElementById(searchCharacteristicTabContent.id),topArea=document.getElementById(searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.control.id),leftAreaBrandButton=document.getElementById(searchCharacteristicTabContent.$.brandButton.id),leftAreaFilterButtons=document.getElementById(searchCharacteristicTabContent.$.filterButtons.id),leftAreaProductsCh=document.getElementById(searchCharacteristicTabContent.$.productsCh.$.scrollArea.id),leftAreaLimit=document.getElementById(searchCharacteristicTabContent.$.productsCh.$.tlimit.id);var totalAreaHeight=totalArea?totalArea.clientHeight:0,topAreaHeight=topArea?topArea.clientHeight:0,leftAreaBrandButtonHeight=leftAreaBrandButton?leftAreaBrandButton.clientHeight:0,leftAreaFilterButtonsHeight=leftAreaFilterButtons?leftAreaFilterButtons.clientHeight:0,leftAreaProductsChHeight=leftAreaProductsCh?leftAreaProductsCh.clientHeight:0,leftAreaLimitHeight=leftAreaLimit?leftAreaLimit.clientHeight:0,newHeight;leftAreaFilterButtonsHeight+=24;newHeight=totalAreaHeight-topAreaHeight-leftAreaBrandButtonHeight-leftAreaFilterButtonsHeight-leftAreaLimitHeight-1;if(newHeight<0){newHeight=0;}
if(leftAreaProductsChHeight!==newHeight){leftAreaProductsCh.style.height=newHeight+'px';}}},{name:'renderLoadingCh',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 20px; color: #cccccc',showing:false,initComponents:function(){this.setContent(OB.I18N.getLabel('OBMOBC_LblLoading'));}}]}]},{style:'display: table-cell; width: 100%; padding-right: 5px;',classes:'row-fluid ',components:[{classes:'row-fluid',components:[{kind:'OB.UI.ScrollableTable',name:'products',scrollAreaMaxHeight:'483px',renderEmpty:'OB.UI.RenderEmpty',renderLine:'OB.UI.RenderProduct',executeAfterClear:function(){var searchCharacteristicTabContent=this.parent.parent.parent.parent,rightAreaProducts=document.getElementById(searchCharacteristicTabContent.$.products.$.scrollArea.id);if(rightAreaProducts){rightAreaProducts.style.height='0px';}},executeAfterRender:function(){var searchCharacteristicTabContent=this.parent.parent.parent.parent,totalArea=document.getElementById(searchCharacteristicTabContent.id),topArea=document.getElementById(searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.control.id),rightAreaProducts=document.getElementById(searchCharacteristicTabContent.$.products.$.scrollArea.id),rightAreaLimit=document.getElementById(searchCharacteristicTabContent.$.products.$.tlimit.id);setTimeout(function(){var totalAreaHeight=totalArea?totalArea.clientHeight:0,topAreaHeight=topArea?topArea.clientHeight:0,rightAreaProductsHeight=rightAreaProducts?rightAreaProducts.clientHeight:0,rightAreaLimitHeight=rightAreaLimit?rightAreaLimit.clientHeight:0,newHeight;newHeight=totalAreaHeight-topAreaHeight-rightAreaLimitHeight-1;if(newHeight<0){newHeight=0;}
if(rightAreaProductsHeight!==newHeight){rightAreaProducts.style.height=newHeight+'px';}},100);}},{name:'renderLoading',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',showing:false,initComponents:function(){this.setContent(OB.I18N.getLabel('OBMOBC_LblLoading'));}}]}]}]}],init:function(model){this.model=model;var me=this,params=[],whereClause='';this.inherited(arguments);this.categories=new OB.Collection.ProductCategoryList();this.products=new OB.Collection.ProductList();this.productsCh=new OB.Collection.ProductCharacteristicValueList();this.$.products.setCollection(this.products);this.$.productsCh.setCollection(this.productsCh);if(OB.MobileApp.model.hasPermission('OBPOS_HideProductCharacteristics',true)){this.$.characteristicsFilterContainer.addStyles('display:none;');}
function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackCategories(dataCategories,me){if(me.destroyed){return;}
if(dataCategories&&dataCategories.length>0){me.categories.reset(dataCategories.models);}else{me.categories.reset();}}
function successCallbackProductCh(dataProductCh){if(me.destroyed){return;}
if(dataProductCh&&dataProductCh.length>0){me.productsCh.reset(dataProductCh.models);}else{me.productsCh.reset();}}
this.products.on('click',function(model){if(!model.get('isGeneric')){var attrs={};this.customFilters.forEach(function(filter){var filterAttr=filter.lineAttributes();if(filterAttr){_.each(_.keys(filterAttr),function(key){attrs[key]=filterAttr[key];});}});me.doAddProduct({product:model,attrs:_.keys(attrs).length===0?undefined:attrs,context:this,callback:function(added){if(added){if(model.get('productType')==='S'&&model.get('isLinkedToProduct')){this.products.remove(model);}}}});this.customFilters.forEach(function(filter){filter.doAddProduct({product:model});});}else{me.doTabChange({tabPanel:'searchCharacteristic',keyboard:false,edit:false,options:model});}},this);OB.Dal.find(OB.Model.ProductCategory,null,successCallbackCategories,errorCallback,this);if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){OB.Dal.query(OB.Model.ProductCharacteristicValue,'select distinct(m_characteristic_id), _identifier from m_product_ch_value where obposFilteronwebpos = "true" order by UPPER(_identifier) asc',[],successCallbackProductCh,errorCallback,this);}else{var criteria={};OB.Dal.find(OB.Model.Characteristic,criteria,successCallbackProductCh,errorCallback);}},changePricelist:function(inSender,inEvent){this.currentPriceList=inEvent.priceList;this.doSearchAction({productCat:this.$.searchProductCharacteristicHeader.$.productcategory.getValue(),productName:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),filter:this.model.get('filter'),skipProduct:false,skipProductCharacteristic:false});},receiptChanged:function(){this.receipt.on('clear',function(){this.$.searchProductCharacteristicHeader.$.productFilterText.setContent('');this.$.searchProductCharacteristicHeader.$.productcategory.setContent('');},this);this.receipt.on('showProductList',function(line,proposalType,finalCallback){var previousStatus,customFilters=[];if(proposalType&&proposalType==='mandatory'){this.customFilters.forEach(function(customFilter){if(customFilter.type==='BUTTON'){customFilters.push({type:'BUTTON',id:customFilter.id,conditions:customFilter.conditions});}else if(customFilter.type==='PANEL'){customFilters.push(customFilter);}});previousStatus={tab:OB.MobileApp.model.get('lastPaneShown'),filterText:this.$.searchProductCharacteristicHeader.$.productFilterText.getValue(),category:this.$.searchProductCharacteristicHeader.$.productcategory.getSelected(),filteringBy:this.$.searchProductCharacteristicHeader.$.filteringBy.getContent(),filter:this.model.get('filter'),brandFilter:this.model.get('brandFilter'),customFilters:customFilters,genericParent:this.genericParent};OB.UI.SearchProductCharacteristic.prototype.filtersCustomClear();OB.UI.SearchProductCharacteristic.prototype.filterCustomClearConditions();OB.UI.SearchProductCharacteristic.prototype.filtersCustomAdd(new OB.UI.SearchServicesFilter({text:line.get('product').get("_identifier"),productId:line.get('product').get('id'),orderline:line}));OB.UI.SearchProductCharacteristic.prototype.filtersCustomAdd(new OB.UI.MandatoryServicesFilter());this.doToggleLineSelection({status:true});}else if(proposalType&&proposalType==='final'){previousStatus={callback:finalCallback};OB.UI.SearchProductCharacteristic.prototype.filtersCustomClear();OB.UI.SearchProductCharacteristic.prototype.filterCustomClearConditions();OB.UI.SearchProductCharacteristic.prototype.filtersCustomAdd(new OB.UI.FinalMandatoryServicesFilter());this.doToggleLineSelection({status:true});}
this.bubble('onTabChange',{tabPanel:'searchCharacteristic'});this.doSearchAction({productCat:'__all__',productName:'',skipProduct:false,skipProductCharacteristic:false});if(proposalType){this.doManageServiceProposal({proposalType:proposalType,previousStatus:previousStatus});}},this);},clearAction:function(inSender,inEvent){this.waterfall('onClearAllAction');},addWhereFilter:function(values){if(values.productName){this.whereClause=this.whereClause+' and _filter like ?';var productFilterTxt='';if(this.nameFilterTypes&&_.isArray(this.nameFilterTypes)&&this.nameFilterTypes.length>0){this.nameFilterTypes.forEach(function(filter){if(filter.filterName===OB.MobileApp.model.get('terminal').terminalType.productSrchConf){productFilterTxt=filter.filterImplementor(values.productName);}});this.params.push(productFilterTxt);}}
if(values.productCat&&((values.productCat!=='__all__')&&(values.productCat!==OB.I18N.getLabel('OBPOS_bestSellerCategory')))){this.whereClause=this.whereClause+' and m_product_category_id = ?';this.params.push(values.productCat);}
if(values.productCat===OB.I18N.getLabel('OBPOS_bestSellerCategory')){this.whereClause=this.whereClause+" and bestseller = 'true'";}},showProducts:function(dataProducts){if(dataProducts&&dataProducts.length>0){dataProducts.models.sort(function(a,b){if(a.get('_identifier')<b.get('_identifier')){return-1;}
if(a.get('_identifier')>b.get('_identifier')){return 1;}
return 0;});this.products.reset(dataProducts.models);}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_NoProductsFound'));this.products.reset();}
this.$.renderLoading.hide();this.$.products.show();},searchAction:function(inSender,inEvent){this.$.products.hide();this.$.renderLoading.show();this.params=[];this.whereClause='';var criteria={},me=this,filterWhereClause='',valuesString='',brandString='',i,j;function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function postProccessFilters(index,dataProducts){var filteredDataProducts;if(index<me.postProcessCustomFilters.length){me.postProcessCustomFilters[index].postProcess(dataProducts,function(){postProccessFilters(++index,dataProducts);});}else{if(_.pluck(me.customFilters,'filterName').indexOf('ServicesFilter')===-1){filteredDataProducts=new OB.Collection.ProductList(dataProducts.filter(function(model){return model.get('productType')!=='S'||!model.get('isLinkedToProduct');}));me.showProducts(filteredDataProducts);}else{me.showProducts(dataProducts);}}}
var synchId=null;function successCallbackProductCh(dataProductCh){var filterWhereClause='',characteristicId='';if(dataProductCh&&dataProductCh.length>0){for(i=0;i<dataProductCh.length;i++){for(j=0;j<me.model.get('filter').length;j++){if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){characteristicId=dataProductCh.models[i].get('characteristic');}else{characteristicId=dataProductCh.models[i].get('id');}
if(characteristicId===me.model.get('filter')[j].characteristic_id){dataProductCh.models[i].set('filtering',true);}}}
me.productsCh.reset(dataProductCh.models);me.$.renderLoadingCh.hide();me.$.productsCh.show();}else if(me.model.get('filter').length>0){if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){filterWhereClause=' and prod_ch.m_characteristic_id in ('+"'"+me.model.get('filter')[0].characteristic_id+"'"+')';for(i=1;i<me.model.get('filter').length;i++){filterWhereClause=filterWhereClause+' or prod_ch.m_characteristic_id in ('+"'"+me.model.get('filter')[i].characteristic_id+"'"+')';}
OB.Dal.query(OB.Model.ProductCharacteristicValue,'select distinct(m_characteristic_id), _identifier from m_product_ch_value as prod_ch where obposFilteronwebpos = "true" and 1=1'+filterWhereClause+' order by UPPER(_identifier) asc',[],function(dataProdCh){if(dataProdCh&&dataProdCh.length>0){for(i=0;i<dataProdCh.length;i++){dataProdCh.models[i].set('filtering',true);}
me.productsCh.reset(dataProdCh.models);me.$.renderLoadingCh.hide();me.$.productsCh.show();}},function(error){OB.UTIL.showError("OBDAL error: "+error);});}else{var productFilterText=inSender.$.productFilterText,productcategory=inSender.$.productcategory;var remoteCriteria=[],characteristic=[],characteristicValue=[],brandparams=[];var criteria={},characteristicfilter={},brandfilter={},chFilter={};var productText;if(productFilterText!==undefined&&productcategory!==undefined){if(productFilterText!==""||productcategory!=="__all__"){characteristicfilter.columns=[];characteristicfilter.operator=OB.Dal.FILTER;characteristicfilter.value=me.productCharacteristicFilterQualifier;productText=(OB.MobileApp.model.hasPermission('OBPOS_remote.product'+OB.Dal.USESCONTAINS,true)?'%':'')+productFilterText.getValue()+'%';characteristicfilter.params=[productText,productcategory.getValue()];remoteCriteria.push(characteristicfilter);}}
if(me.model.get('filter').length>0){for(i=0;i<me.model.get('filter').length;i++){if(!characteristic.includes(me.model.get('filter')[i].characteristic_id)){characteristic.push(me.model.get('filter')[i].characteristic_id);}}
for(i=0;i<characteristic.length;i++){for(j=0;j<me.model.get('filter').length;j++){if(characteristic[i]===me.model.get('filter')[j].characteristic_id){characteristicValue.push(me.model.get('filter')[j].id);}}
if(characteristicValue.length>0){characteristicfilter={columns:[],operator:OB.Dal.FILTER,value:'Ch_Filter',filter:characteristic[i],params:[characteristicValue]};remoteCriteria.push(characteristicfilter);characteristicValue=[];}}}
if(me.model.get('brandFilter').length>0){for(i=0;i<me.model.get('brandFilter').length;i++){brandparams.push(me.model.get('brandFilter')[i].id);}
if(brandparams.length>0){brandfilter={columns:[],operator:OB.Dal.FILTER,value:'BChar_Filter',params:[brandparams]};remoteCriteria.push(brandfilter);}}
criteria.hqlCriteria=[];me.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteriaCharacteristics)){var hqlCriteriaFilter=hqlFilter.hqlCriteriaCharacteristics();if(!_.isUndefined(hqlCriteriaFilter)){hqlCriteriaFilter.forEach(function(filter){if(filter){remoteCriteria.push(filter);}});}}});criteria.remoteFilters=remoteCriteria;OB.Dal.find(OB.Model.Characteristic,criteria,function(dataProdCh){if(dataProdCh&&dataProdCh.length>0){for(i=0;i<dataProdCh.length;i++){dataProdCh.models[i].set('filtering',true);}
me.productsCh.reset(dataProdCh.models);me.$.renderLoadingCh.hide();me.$.productsCh.show();}},function(error){OB.UTIL.showError("OBDAL error: "+error);});OB.UTIL.SynchronizationHelper.finished(synchId,'searchAction');}}else{me.productsCh.reset();me.$.renderLoadingCh.hide();me.$.productsCh.show();}}
var forceRemote=false;this.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteria)&&!_.isUndefined(hqlFilter.forceRemote)){var hqlCriteriaFilter=hqlFilter.hqlCriteria();hqlCriteriaFilter.forEach(function(filter){if(filter!==""&&forceRemote===false){forceRemote=hqlFilter.forceRemote;}});}});function filterProductCharacterisctics(){synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('filterProductCharacterisctics');var productFilterText,productcategory;var brandparams=[];if(inSender.$.searchProductCharacteristicHeader!==undefined){productFilterText=inSender.$.searchProductCharacteristicHeader.$.productFilterText;productcategory=inSender.$.searchProductCharacteristicHeader.$.productcategory;}else{productFilterText=inSender.$.productFilterText;productcategory=inSender.$.productcategory;}
if(me.model.get('brandFilter').length>0){for(i=0;i<me.model.get('brandFilter').length;i++){if(me.model.get('brandFilter')[i]){brandparams.push(me.model.get('brandFilter')[i].id);}}}
var remoteCriteria=[],characteristic=[],characteristicValue=[];var criteria={},characteristicfilter={},brandfilter={},chFilter={},productCategory={columns:['productCategory'],operator:'equals',value:inEvent.productCat,isId:true};var productText;if(me.model.get('brandFilter').length>0){for(i=0;i<me.model.get('brandFilter').length;i++){brandparams.push(me.model.get('brandFilter')[i].id);}
if(brandparams.length>0){brandfilter={columns:[],operator:OB.Dal.FILTER,value:'BChar_Filter',params:[brandparams]};remoteCriteria.push(brandfilter);}}
if(productFilterText!==undefined&&productcategory!==undefined){if(!_.isEmpty(productFilterText.getValue())||(productcategory.getValue()&&productcategory.getValue()!=="__all__")){characteristicfilter.columns=[];characteristicfilter.operator=OB.Dal.FILTER;characteristicfilter.value=me.productCharacteristicFilterQualifier;productText=(OB.MobileApp.model.hasPermission('OBPOS_remote.product'+OB.Dal.USESCONTAINS,true)?'%':'')+productFilterText.getValue()+'%';characteristicfilter.params=[productText,productcategory.getValue()];remoteCriteria.push(characteristicfilter);}}
if(me.model.get('filter').length>0){for(i=0;i<me.model.get('filter').length;i++){if(!characteristic.includes(me.model.get('filter')[i].characteristic_id)){characteristic.push(me.model.get('filter')[i].characteristic_id);}}
for(i=0;i<characteristic.length;i++){for(j=0;j<me.model.get('filter').length;j++){if(characteristic[i]===me.model.get('filter')[j].characteristic_id){characteristicValue.push(me.model.get('filter')[j].id);}}
if(characteristicValue.length>0){characteristicfilter={columns:[],operator:OB.Dal.FILTER,value:'Ch_Filter',filter:characteristic[i],params:[characteristicValue]};remoteCriteria.push(characteristicfilter);characteristicValue=[];}}}
criteria.hqlCriteria=[];me.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteriaCharacteristics)){var hqlCriteriaFilter=hqlFilter.hqlCriteriaCharacteristics();if(!_.isUndefined(hqlCriteriaFilter)){hqlCriteriaFilter.forEach(function(filter){if(filter){remoteCriteria.push(filter);}});}}});criteria.remoteFilters=remoteCriteria;criteria.forceRemote=forceRemote;OB.UTIL.SynchronizationHelper.finished(synchId,'filterProductCharacterisctics');OB.Dal.find(OB.Model.Characteristic,criteria,successCallbackProductCh,errorCallback);}
var synchIdSearchAction=null;function successCallbackProducts(dataProducts){postProccessFilters(0,dataProducts);if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)||forceRemote){OB.UTIL.SynchronizationHelper.finished(synchIdSearchAction,'searchAction');filterProductCharacterisctics();}}
if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)&&!forceRemote){this.whereClause=this.whereClause+" where isGeneric = 'false'";this.addWhereFilter(inEvent);if(this.genericParent){this.whereClause=this.whereClause+' and generic_product_id = ?';this.params.push(this.genericParent.get('id'));}
if(this.model.get('filter').length>0){for(i=0;i<this.model.get('filter').length;i++){if(i!==0&&(this.model.get('filter')[i].characteristic_id!==this.model.get('filter')[i-1].characteristic_id)){filterWhereClause=filterWhereClause+' and exists (select * from m_product_ch_value as char where m_ch_value_id in ('+valuesString+') and char.m_product_id = product.m_product_id)';valuesString='';}
if(valuesString!==''){valuesString=valuesString+', '+"'"+this.model.get('filter')[i].id+"'";}else{valuesString="'"+this.model.get('filter')[i].id+"'";}
if(i===this.model.get('filter').length-1){filterWhereClause=filterWhereClause+' and exists (select * from m_product_ch_value as char where m_ch_value_id in ('+valuesString+') and char.m_product_id = product.m_product_id)';valuesString='';}}}
if(this.model.get('brandFilter').length>0){for(i=0;i<this.model.get('brandFilter').length;i++){brandString=brandString+"'"+this.model.get('brandFilter')[i].id+"'";if(i!==this.model.get('brandFilter').length-1){brandString=brandString+', ';}}
filterWhereClause=filterWhereClause+' and product.brand in ('+brandString+')';}
var customParams=[];this.params.forEach(function(param){customParams.push(param);});if(!inEvent.skipProduct){this.customFilters.forEach(function(filter){var sqlFilter=filter.sqlFilter();if(sqlFilter&&sqlFilter.where){filterWhereClause=filterWhereClause+sqlFilter.where;if(sqlFilter.filters&&sqlFilter.filters.length>0){sqlFilter.filters.forEach(function(item){customParams.push(item);});}}});var limit=null;if(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true)){limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true));}
if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)&&this.currentPriceList&&this.currentPriceList!==OB.MobileApp.model.get('terminal').priceList){var select="select product.*, pp.pricestd as currentStandardPrice "
+"from m_product product join m_productprice pp on product.m_product_id = pp.m_product_id and pp.m_pricelist_id = '"+this.currentPriceList+"' "
+this.whereClause+filterWhereClause;OB.Dal.query(OB.Model.Product,select,customParams,successCallbackProducts,errorCallback,this,null,limit);}else{OB.Dal.query(OB.Model.Product,'select * from m_product as product'+this.whereClause+filterWhereClause,customParams,successCallbackProducts,errorCallback,this,null,limit);}}else{this.$.renderLoading.hide();this.$.products.show();}
if(!inEvent.skipProductCharacteristic){this.$.renderLoadingCh.show();this.$.productsCh.hide();if(this.model.get('filter').length>0&&OB.MobileApp.model.get('serviceSearchMode')&&!this.params){OB.Dal.query(OB.Model.ProductCharacteristicValue,'select distinct(m_characteristic_id), _identifier from m_product_ch_value as prod_ch where exists (select * from m_product as product where 1=1 '+filterWhereClause+' and prod_ch.m_product_id = product.m_product_id) and obposFilteronwebpos = "true" order by UPPER(_identifier) asc',[],successCallbackProductCh,errorCallback,this);}else{OB.Dal.query(OB.Model.ProductCharacteristicValue,'select distinct(m_characteristic_id), _identifier from m_product_ch_value as prod_ch where exists (select * from m_product as product'+this.whereClause+filterWhereClause+' and prod_ch.m_product_id = product.m_product_id) and obposFilteronwebpos = "true" order by UPPER(_identifier) asc',customParams,successCallbackProductCh,errorCallback,this);}}}else{var characteristicparams=[],brandparams=[],selectedcharacteristic=[];if(this.model.get('filter').length>0){for(i=0;i<this.model.get('filter').length;i++){if(this.model.get('filter')[i].characteristic_id){selectedcharacteristic.push(this.model.get('filter')[i].characteristic_id);}}}
if(!inEvent.skipProduct){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)||forceRemote){synchIdSearchAction=OB.UTIL.SynchronizationHelper.busyUntilFinishes('searchAction');}
var remoteCriteria=[],characteristic=[],characteristicValue=[];var brandfilter={},characteristicfilter={},productCategory={columns:['productCategory'],operator:'equals',value:inEvent.productCat,isId:true},productName={columns:['_filter'],operator:'startsWith',value:inEvent.productName},ispack={columns:['ispack'],operator:'equals',value:'false',fieldType:'forceString'};if(productCategory.value===OB.I18N.getLabel('OBPOS_bestSellerCategory')){productCategory={columns:['productCategory'],operator:'equals',value:'__all__',isId:true};var bestsellers={columns:['bestseller'],operator:'equals',value:true,boolean:true};remoteCriteria.push(bestsellers);}
if(this.model.get('brandFilter').length>0){for(i=0;i<this.model.get('brandFilter').length;i++){brandparams.push(this.model.get('brandFilter')[i].id);}
if(brandparams.length>0){brandfilter={columns:[],operator:OB.Dal.FILTER,value:'Brand_Filter',params:[brandparams]};remoteCriteria.push(brandfilter);}}
if(this.model.get('filter').length>0){for(i=0;i<this.model.get('filter').length;i++){if(!characteristic.includes(this.model.get('filter')[i].characteristic_id)){characteristic.push(this.model.get('filter')[i].characteristic_id);}}
for(i=0;i<characteristic.length;i++){for(j=0;j<this.model.get('filter').length;j++){if(characteristic[i]===this.model.get('filter')[j].characteristic_id){characteristicValue.push(this.model.get('filter')[j].id);}}
if(characteristicValue.length>0){characteristicfilter={columns:[],operator:OB.Dal.FILTER,value:'Characteristic_Filter',filter:characteristic[i],params:[characteristicValue]};remoteCriteria.push(characteristicfilter);characteristicValue=[];}}}
if(this.model.get('filter').length>0){remoteCriteria.push(ispack);}
if(this.model.get('brandFilter').length>0){remoteCriteria.push(ispack);}
criteria.hqlCriteria=[];this.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteria)){var hqlCriteriaFilter=hqlFilter.hqlCriteria();hqlCriteriaFilter.forEach(function(filter){if(filter){remoteCriteria.push(filter);}});}});remoteCriteria.push(productCategory);remoteCriteria.push(productName);criteria.remoteFilters=remoteCriteria;criteria.forceRemote=forceRemote;if(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true)){criteria._limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_productLimit',true));}
if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)&&this.currentPriceList&&this.currentPriceList!==OB.MobileApp.model.get('terminal').priceList){var currentPriceList={'currentPriceList':this.currentPriceList};criteria.remoteParams=currentPriceList;OB.Dal.find(OB.Model.Product,criteria,successCallbackProducts,errorCallback,this);}else{OB.Dal.find(OB.Model.Product,criteria,successCallbackProducts,errorCallback,this);}}else{this.$.renderLoading.hide();this.$.products.show();}
if(!inEvent.skipProductCharacteristic&&inEvent.skipProduct){filterProductCharacterisctics();}}}});window.OB=window.OB||{};OB.Model=OB.Model||{};OB.Model.Discounts=OB.Model.Discounts||{};OB.Model.Discounts.discountRules=OB.Model.Discounts.discountRules||{};OB.Model.Discounts.discountRules['697A7AB9FD9C4EE0A3E891D3D3CCA0A7']={async:false,implementation:function(discountRule,receipt,line){var linePrice,totalDiscount,qty=OB.DEC.toBigDecimal(line.get('qty')),discount=OB.DEC.toBigDecimal(discountRule.get('discount')),discountedLinePrice,oldDiscountedLinePrice;linePrice=OB.DEC.toBigDecimal(line.get('discountedLinePrice')||line.get('price'));discountedLinePrice=linePrice.multiply(new BigDecimal('100').subtract(OB.DEC.toBigDecimal(discountRule.get('discount'))).divide(new BigDecimal('100'),20,OB.DEC.getRoundingMode()));discountedLinePrice=OB.DEC.toNumber(discountedLinePrice);totalDiscount=OB.DEC.sub(OB.DEC.mul(OB.DEC.toNumber(linePrice),qty),OB.DEC.mul(discountedLinePrice,qty));oldDiscountedLinePrice=!_.isNull(line.get('discountedLinePrice'))?line.get('discountedLinePrice'):line.get('price');if(oldDiscountedLinePrice<OB.DEC.div(totalDiscount,line.getQty())){totalDiscount=OB.DEC.mul(oldDiscountedLinePrice,line.getQty());}
receipt.addPromotion(line,discountRule,{amt:OB.DEC.toNumber(totalDiscount)});line.set('discountedLinePrice',discountedLinePrice);}};OB.Model.Discounts.discountRules['94AEA884F5AD4EABB72322832B9C5172']={async:true,implementation:function(discountRule,receipt,line,listener){var applyingToLines=new Backbone.Collection(),criteria,promotionCandidates=line.get('promotionCandidates')||[];if(promotionCandidates.indexOf(discountRule.id)===-1){promotionCandidates.push(discountRule.id);}
line.set('promotionCandidates',promotionCandidates);receipt.get('lines').forEach(function(l){if(l.get('promotionCandidates')){l.get('promotionCandidates').forEach(function(candidateRule){if(candidateRule===discountRule.id){applyingToLines.add(l);}});}});criteria={priceAdjustment:discountRule.id};OB.Dal.find(OB.Model.DiscountFilterProduct,criteria,function(products){var chunks,distributed,totalAmt,promotionAmt=0,alerts='';if(applyingToLines.length!==products.length){listener.trigger('completed');return;}
products.forEach(function(product){var i,line,applyNtimes,qtyToGetGift,qtyAsGift;if(chunks===0){return;}
for(i=0;i<applyingToLines.length;i++){if(applyingToLines.at(i).get('product').id===product.get('product')){line=applyingToLines.at(i);break;}}
if(!line){chunks=0;return;}
product.set('receiptLine',line);if((_.isUndefined(product.get('obdiscQty'))||_.isNull(product.get('obdiscQty')))||product.get('obdiscIsGift')){qtyToGetGift=0;}else{qtyToGetGift=product.get('obdiscQty');}
if(product.get('obdiscIsGift')){if(_.isUndefined(product.get('obdiscGifqty'))||_.isNull(product.get('obdiscGifqty'))){qtyAsGift=0;}else{qtyAsGift=product.get('obdiscGifqty');}
applyNtimes=Math.floor(line.get('qty')/(qtyToGetGift+qtyAsGift||1));}else{applyNtimes=Math.floor(line.get('qty')/(qtyToGetGift||1));}
if(!chunks||applyNtimes<chunks){chunks=applyNtimes;}});if(chunks===0){applyingToLines.forEach(function(ln){receipt.removePromotion(ln,discountRule);});listener.trigger('completed',{alerts:OB.I18N.getLabel('OBPOS_DiscountAlert',[line.get('product').get('_identifier'),discountRule.get('printName')||discountRule.get('name')])});return;}
discountRule.set('applyNext',false,{silent:true});distributed=discountRule.get('oBDISCDistribute');if(distributed){totalAmt=products.reduce(function(total,product){var l=product.get('receiptLine');return OB.DEC.add(total,OB.DEC.mul(l.get('qty'),l.get('discountedLinePrice')||l.get('price')));},OB.DEC.Zero);products.where({obdiscIsGift:true}).forEach(function(product){var l=product.get('receiptLine'),lineAmt;lineAmt=OB.DEC.mul(OB.DEC.mul((l.get('discountedLinePrice')||l.get('price')),chunks),(product.get('obdiscQty')||1));if(distributed){promotionAmt+=lineAmt;}});}
products.forEach(function(product){var l=product.get('receiptLine'),price=l.get('discountedLinePrice')||l.get('price'),actualAmt,giftQty;if(distributed){actualAmt=l.get('qty')*price*promotionAmt/(totalAmt);if(product.get('obdiscIsGift')){giftQty=product.get('obdiscGifqty');if(giftQty){discountRule.set('qtyOffer',OB.DEC.mul(OB.DEC.toNumber(giftQty),chunks));receipt.addPromotion(l,discountRule,{amt:OB.DEC.mul(OB.DEC.mul(price,chunks),giftQty),actualAmt:actualAmt});}else{window.console.warn(OB.I18N.getLabel('OBPOS_DISCbuyXgiftYNotDefineGiftQty',[discountRule.get('printName')||discountRule.get('name'),l.get('product').get('_identifier')]));alerts+='\n'+OB.I18N.getLabel('OBPOS_DISCbuyXgiftYNotDefineGiftQty',[discountRule.get('printName')||discountRule.get('name'),l.get('product').get('_identifier')]);}}else{discountRule.set('qtyOffer',OB.DEC.mul(OB.DEC.toNumber(product.get('obdiscQty')||1),chunks));receipt.addPromotion(l,discountRule,{actualAmt:actualAmt});}}else{if(product.get('obdiscIsGift')){giftQty=product.get('obdiscGifqty');if(giftQty){discountRule.set('qtyOffer',OB.DEC.mul(OB.DEC.toNumber(giftQty),chunks));receipt.addPromotion(l,discountRule,{amt:OB.DEC.mul(OB.DEC.mul(price,chunks),(product.get('obdiscGifqty')||0))});}else{window.console.warn(OB.I18N.getLabel('OBPOS_DISCbuyXgiftYNotDefineGiftQty',[discountRule.get('printName')||discountRule.get('name'),l.get('product').get('_identifier')]));alerts+='\n'+OB.I18N.getLabel('OBPOS_DISCbuyXgiftYNotDefineGiftQty',[discountRule.get('printName')||discountRule.get('name'),l.get('product').get('_identifier')]);}}else{discountRule.set('qtyOffer',OB.DEC.mul(OB.DEC.toNumber(product.get('obdiscQty')||1),chunks));receipt.addPromotion(l,discountRule,{actualAmt:0,hidden:true});}}});if(alerts){listener.trigger('completed',{alerts:alerts});}else{listener.trigger('completed');}},function(){window.console.error('Error querying for products',discountRule,receipt,line,arguments);listener.trigger('completed');});}};OB.Model.Discounts.discountRules['312D41071ED34BA18B748607CA679F44']={async:false,implementation:function(discountRule,receipt,line,ruleListener,candidates){var qty=BigDecimal.prototype.ZERO,offered=BigDecimal.prototype.ZERO,priority=discountRule.get('priority')||null,priorityLine,x,y,chunks,i,j,ln,price,subtype=discountRule.get('oBDISCSubtype')||'MOSTEXPENSIVE',totalPrice=BigDecimal.prototype.ZERO,distributed,amt,distributionAmt=BigDecimal.prototype.ZERO,distributionQty=0,distribution=[],distributionQtyOffer=[],discountRuleLine,applyingToLinesCollection=Backbone.Collection.extend({comparator:function(line){if(subtype==='CHEAPEST'){return-(line.get('discountedLinePrice')||line.get('price'));}else{return(line.get('discountedLinePrice')||line.get('price'));}}}),rule,rest,lRest,candidate,promotion,topay,togift,group,groupInv,lQty,lQtyOffer,checkedQty,chunksInThisGroup,alerts,unitsToDiscount,unitsToCheck,discountedQty,avgPrice,applyingToLines=new applyingToLinesCollection(),promotionCandidates=line.get('promotionCandidates')||[];if(promotionCandidates.length!==candidates.length){promotionCandidates=[];for(i=0;i<candidates.length;i++){promotionCandidates.push(candidates.at(i).id);}}
line.set('promotionCandidates',promotionCandidates);receipt.get('lines').forEach(function(l){if(l.get('promotions')&&l.get('promotions').length>0){for(i=0;i<l.get('promotions').length;i++){promotion=l.get('promotions')[i];if(promotion.priority&&priority!==null){priorityLine=promotion.priority;if(priority<priorityLine){for(j=0;j<candidates.length;j++){if(promotion.ruleId===candidates.at(j).id){receipt.removePromotion(l,candidates.at(j));}}}else{receipt.removePromotion(l,discountRule);}}else{if((discountRule.get('discountType')===promotion.discountType)&&(discountRule.id===promotion.ruleId)){receipt.removePromotion(l,discountRule);}}}}});receipt.get('lines').forEach(function(l){offered=BigDecimal.prototype.ZERO;rest=BigDecimal.prototype.ZERO;if(l.get('promotions')&&l.get('promotions').length>0){for(i=0;i<l.get('promotions').length;i++){promotion=l.get('promotions')[i];if(promotion.qtyOffer){offered=offered.add(OB.DEC.toBigDecimal(promotion.qtyOffer));}}}
if(l.get('promotionCandidates')){l.get('promotionCandidates').forEach(function(candidateRule){if(candidateRule===discountRule.id){if(OB.DEC.toBigDecimal(l.get('qty')).subtract(OB.DEC.toBigDecimal(offered))>0){applyingToLines.add(l);rest=OB.DEC.toBigDecimal(l.get('qty')).subtract(OB.DEC.toBigDecimal(offered));qty=qty.add(OB.DEC.toBigDecimal(rest));}}});}});x=discountRule.get('oBDISCX');y=discountRule.get('oBDISCY');if(OB.DEC.toNumber(qty)>=x){discountRule.set('applyNext',false,{silent:true});chunks=OB.DEC.toNumber(qty.divideInteger(OB.DEC.toBigDecimal(x)));unitsToCheck=chunks*y;group=new applyingToLinesCollection();for(i=0;i<applyingToLines.length;i++){ln=applyingToLines.at(i);offered=BigDecimal.prototype.ZERO;if(ln.get('promotions')&&ln.get('promotions').length>0){for(j=0;j<ln.get('promotions').length;j++){offered=offered.add(OB.DEC.toBigDecimal(ln.get('promotions')[j].qtyOffer));}}
if(unitsToCheck>0){if((ln.get('qty')-OB.DEC.toNumber(offered))>unitsToCheck){discountedQty=unitsToCheck;}else{discountedQty=ln.get('qty')-OB.DEC.toNumber(offered);}
unitsToCheck-=discountedQty;totalPrice=totalPrice.add(OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price')).multiply(OB.DEC.toBigDecimal(discountedQty)));ln.set('qtyToApplyDisc',discountedQty);group.push(ln);}}
groupInv=new applyingToLinesCollection();applyingToLines.models.reverse();unitsToCheck=chunks*(x-y);for(i=0;i<applyingToLines.length;i++){ln=applyingToLines.at(i);offered=BigDecimal.prototype.ZERO;if(ln.get('promotions')&&ln.get('promotions').length>0){for(j=0;j<ln.get('promotions').length;j++){offered=offered.add(OB.DEC.toBigDecimal(ln.get('promotions')[j].qtyOffer));}}
if(unitsToCheck>0){if((ln.get('qty')-OB.DEC.toNumber(offered))>unitsToCheck){discountedQty=unitsToCheck;}else{discountedQty=ln.get('qty')-OB.DEC.toNumber(offered);}
unitsToCheck-=discountedQty;totalPrice=totalPrice.add(OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price')).multiply(OB.DEC.toBigDecimal(discountedQty)));ln.set('qtyToApplyDisc',discountedQty);groupInv.push(ln);}}
groupInv.models.reverse();distributed=discountRule.get('oBDISCDistribute');if(subtype==='CHEAPEST'||subtype==='MOSTEXPENSIVE'){topay=y*chunks;for(i=0;i<group.length;i++){ln=group.at(i);discountRuleLine=discountRule.clone();price=OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price'));lQty=OB.DEC.toBigDecimal(ln.get('qty'));lQtyOffer=0;if(ln.get('promotions')&&ln.get('promotions').length>0){for(j=0;j<ln.get('promotions').length;j++){lQtyOffer=lQtyOffer+OB.DEC.toNumber(ln.get('promotions')[j].qtyOffer);}}
if(topay>0){lRest=OB.DEC.toNumber(lQty)-lQtyOffer;if(lRest>0){if(lRest>=topay){if(distributed&&(subtype==='CHEAPEST')){distributionQtyOffer.push(topay);}else{discountRuleLine.set('qtyOffer',OB.DEC.toNumber(topay));receipt.addPromotion(ln,discountRuleLine,{actualAmt:0,hidden:true});}
topay=0;}else{topay-=lRest;if(distributed&&(subtype==='CHEAPEST')){distributionQtyOffer.push(lRest);}else{discountRuleLine.set('qtyOffer',OB.DEC.toNumber(lRest));receipt.addPromotion(ln,discountRuleLine,{actualAmt:0,hidden:true});}}}}}
togift=(x-y)*chunks;for(i=0;i<groupInv.length;i++){ln=groupInv.at(i);discountRuleLine=discountRule.clone();price=OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price'));lQty=OB.DEC.toBigDecimal(ln.get('qty'));lQtyOffer=0;if(ln.get('promotions')&&ln.get('promotions').length>0){for(j=0;j<ln.get('promotions').length;j++){lQtyOffer=lQtyOffer+OB.DEC.toNumber(ln.get('promotions')[j].qtyOffer);}}
if(togift>0){lRest=OB.DEC.toNumber(lQty)-lQtyOffer;if(lRest>0){if(lRest>=togift){amt=price.multiply(OB.DEC.toBigDecimal(togift));if(distributed&&(subtype==='CHEAPEST')){distributionAmt=distributionAmt.add(amt);distribution[i]=OB.DEC.toNumber(amt);distributionQtyOffer.push(togift);}else{discountRuleLine.set('qtyOffer',togift);receipt.addPromotion(ln,discountRuleLine,{amt:OB.DEC.toNumber(amt)});}
togift=0;}else{togift-=lRest;amt=price.multiply(OB.DEC.toBigDecimal(lRest));if(distributed&&(subtype==='CHEAPEST')){distributionAmt=distributionAmt.add(amt);distribution[i]=OB.DEC.toNumber(amt);distributionQtyOffer.push(lRest);}else{discountRuleLine.set('qtyOffer',lRest);receipt.addPromotion(ln,discountRuleLine,{amt:OB.DEC.toNumber(amt)});}}}}}}else{var totalDisc=BigDecimal.prototype.ZERO,groupAvg=new applyingToLinesCollection();totalPrice=BigDecimal.prototype.ZERO;unitsToCheck=chunks*x;groupAvg=new applyingToLinesCollection();for(i=0;i<applyingToLines.length;i++){ln=applyingToLines.at(i);offered=BigDecimal.prototype.ZERO;if(ln.get('promotions')&&ln.get('promotions').length>0){for(j=0;j<ln.get('promotions').length;j++){offered=offered.add(OB.DEC.toBigDecimal(ln.get('promotions')[j].qtyOffer));}}
if(unitsToCheck>0){if((ln.get('qty')-OB.DEC.toNumber(offered))>unitsToCheck){discountedQty=unitsToCheck;}else{discountedQty=ln.get('qty')-OB.DEC.toNumber(offered);}
unitsToCheck-=discountedQty;totalPrice=totalPrice.add(OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price')).multiply(OB.DEC.toBigDecimal(discountedQty)));ln.set('qtyToApplyDisc',discountedQty);groupAvg.push(ln);}}
groupAvg.models.reverse();togift=chunks*(x-y);for(i=0;i<groupAvg.length;i++){if(togift>0){ln=groupAvg.at(i);price=OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price'));discountedQty=OB.DEC.toBigDecimal(ln.get('qtyToApplyDisc'));if(OB.DEC.toNumber(discountedQty)>togift){totalDisc=totalDisc.add(price.multiply(OB.DEC.toBigDecimal(togift)));togift=0;}else{totalDisc=totalDisc.add(price.multiply(discountedQty));togift-=discountedQty;}}}
for(i=0;i<groupAvg.length;i++){ln=groupAvg.at(i);discountRuleLine=discountRule.clone();price=OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price'));discountedQty=OB.DEC.toBigDecimal(ln.get('qtyToApplyDisc'));discountRuleLine.set('qtyOffer',discountedQty);receipt.addPromotion(ln,discountRuleLine,{amt:OB.DEC.toNumber((totalDisc.multiply(price).multiply(discountedQty)).divide(totalPrice))});}}
if(distributed&&(subtype==='CHEAPEST')){var totalQty=chunks*y,pendingQty=chunks*y,qtyOffer=0,partialAmt=0;for(i=0;i<group.length;i++){ln=group.at(i);discountRuleLine=discountRule.clone();if(OB.DEC.toNumber(ln.get('qty'))>=totalQty&&totalQty>0){qty=totalQty;totalQty=0;}else if(totalQty>0){qty=OB.DEC.toNumber(ln.get('qty'));totalQty-=OB.DEC.toNumber(ln.get('qty'));}else{qty=0;}
price=OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price'));amt=OB.DEC.toNumber((OB.DEC.toBigDecimal(distributionQtyOffer[i]).multiply(price).multiply(OB.DEC.toBigDecimal(distributionAmt))).divide(totalPrice));partialAmt=OB.DEC.add(partialAmt,amt);discountRuleLine.set('qtyOffer',distributionQtyOffer[i]);receipt.addPromotion(ln,discountRuleLine,{actualAmt:amt,hidden:true,preserve:true});}
totalQty=chunks*(x-y);pendingQty=chunks*(x-y);for(i=0;i<groupInv.length;i++){var position=i+group.length;ln=groupInv.at(i);discountRuleLine=discountRule.clone();if(OB.DEC.toNumber(ln.get('qty'))>=totalQty&&totalQty>0){qty=totalQty;totalQty=0;}else if(totalQty>0){qty=OB.DEC.toNumber(ln.get('qty'));totalQty-=OB.DEC.toNumber(ln.get('qty'));}else{qty=0;}
price=OB.DEC.toBigDecimal(ln.get('discountedLinePrice')||ln.get('price'));amt=OB.DEC.toNumber((OB.DEC.toBigDecimal(distributionQtyOffer[position]).multiply(price).multiply(OB.DEC.toBigDecimal(distributionAmt))).divide(totalPrice));if((i===groupInv.length-1)&&((partialAmt+amt)!==distributionAmt)){amt=OB.DEC.toNumber(distributionAmt.subtract(OB.DEC.toBigDecimal(partialAmt)));}else{partialAmt=OB.DEC.add(partialAmt,amt);}
discountRuleLine.set('qtyOffer',distributionQtyOffer[position]);receipt.addPromotion(ln,discountRuleLine,{actualAmt:amt,amt:distribution[i]});}}}
if(OB.DEC.toNumber(qty)%x!==0){alerts=OB.I18N.getLabel('OBPOS_DiscountAlert',[line.get('product').get('_identifier'),discountRule.get('printName')||discountRule.get('name')]);}
return{alerts:alerts};}};OB.Model.Discounts.discountRules.E08EE3C23EBA49358A881EF06C139D63={async:false,implementation:function(discountRule,receipt,line){var alerts,qty,x,y,mod,chunks,price,finalPrice;x=discountRule.get('oBDISCX');y=discountRule.get('oBDISCY');if(!x||!y||x===0){window.console.warn('Discount incorrectly defined, missing x or y',discountRule);}
qty=line.get('qty');mod=qty%x;if(mod!==0){alerts=OB.I18N.getLabel('OBPOS_DISCAlertXYSameProduct',[x-mod,line.get('product').get('_identifier'),discountRule.get('printName')||discountRule.get('name')]);}
if(qty>=x){chunks=Math.floor(qty/x);price=line.get('discountedLinePrice')||line.get('price');finalPrice=OB.DEC.add(OB.DEC.mul(OB.DEC.mul(chunks,y),price),OB.DEC.mul(mod,price));discountRule.set('qtyOffer',OB.DEC.toNumber(OB.DEC.mul(chunks,x)));receipt.addPromotion(line,discountRule,{amt:OB.DEC.sub(OB.DEC.mul(qty,price),finalPrice)});}
return{alerts:alerts};}};OB.Model.Discounts.discountRules.BE5D42E554644B6AA262CCB097753951={async:true,implementation:function(discountRule,receipt,line,listener,candidates){var applyingToLines=new Backbone.Collection(),criteria,promotionCandidates=line.get('promotionCandidates')||[],finalAmt,lineNum,previousAmt,i;if(promotionCandidates.indexOf(discountRule.id)===-1){promotionCandidates.push(discountRule.id);}
for(i=0;i<candidates.length;i++){if(promotionCandidates.indexOf(candidates.at(i).attributes.id)===-1){promotionCandidates.push(candidates.at(i).attributes.id);}}
line.set('promotionCandidates',promotionCandidates);criteria={priceAdjustment:discountRule.id,_orderByClause:'_identifier'};OB.Dal.find(OB.Model.DiscountFilterProduct,criteria,function(products){var chunks,totalAmt,promotionAmt=0,outOfComboAmt;receipt.get('lines').forEach(function(l){if(l.get('promotionCandidates')){l.get('promotionCandidates').forEach(function(candidateRule){if(candidateRule===discountRule.id){if(!(l.isAffectedByPack()&&l.isAffectedByPack().ruleId!==discountRule.get('id'))||(l.isAffectedByPack()&&l.isAffectedByPack().ruleId!==discountRule.get('id')&&l.isAffectedByPack()._idx>discountRule.get('_idx'))){applyingToLines.add(l);}}});}});if(applyingToLines.length!==products.length){listener.trigger('completed');return;}
products.forEach(function(product){var i,line,applyNtimes;if(chunks===0){return;}
for(i=0;i<applyingToLines.length;i++){if(applyingToLines.at(i).get('product').id===product.get('product')){line=applyingToLines.at(i);break;}}
if(!line){chunks=0;return;}
product.set('receiptLine',line);applyNtimes=Math.floor(line.get('qty')/(product.get('obdiscQty')||1));if(!chunks||applyNtimes<chunks){chunks=applyNtimes;}});if(chunks===0){applyingToLines.forEach(function(ln){receipt.removePromotion(ln,discountRule);});listener.trigger('completed',{alerts:OB.I18N.getLabel('OBPOS_DiscountAlert',[line.get('product').get('_identifier'),discountRule.get('printName')||discountRule.get('name')])});return;}
discountRule.set('applyNext',false,{silent:true});totalAmt=products.reduce(function(total,product){var l=product.get('receiptLine');return OB.DEC.add(total,OB.DEC.mul(l.get('qty'),l.get('discountedLinePrice')||l.get('price')));},OB.DEC.Zero);outOfComboAmt=products.reduce(function(total,product){var l=product.get('receiptLine'),unitsOutOfCombo=l.get('qty')-(chunks*(product.get('obdiscQty')||1));return OB.DEC.add(total,OB.DEC.mul(unitsOutOfCombo,l.get('discountedLinePrice')||l.get('price')));},OB.DEC.Zero);finalAmt=OB.DEC.mul(chunks,discountRule.get('obdiscPrice').toFixed(OB.MobileApp.model.get('currency').obposPosprecision||OB.MobileApp.model.get('currency').pricePrecision))+outOfComboAmt;promotionAmt=totalAmt-finalAmt;lineNum=0;previousAmt=0;products.forEach(function(product){var l=product.get('receiptLine'),price=l.get('discountedLinePrice')||l.get('price'),actualAmt;lineNum+=1;if(lineNum<products.length){actualAmt=OB.DEC.div(OB.DEC.mul(OB.DEC.mul(l.get('qty'),price),promotionAmt),(totalAmt));previousAmt+=OB.DEC.sub(OB.DEC.mul(l.get('qty'),price),actualAmt);}else{actualAmt=OB.DEC.sub(OB.DEC.mul(l.get('qty'),price),OB.DEC.sub(finalAmt,previousAmt));}
discountRule.set('qtyOffer',OB.DEC.toNumber(product.get('obdiscQty')||1)*chunks);receipt.addPromotion(l,discountRule,{amt:actualAmt,pack:true});});listener.trigger('completed');},function(){window.console.error('Error querying for products',discountRule,receipt,line,arguments);listener.trigger('completed');});},addProductToOrder:function(order,productToAdd){var criteria;var count;function errorCallback(error){console.error('OBDAL error: '+error,arguments);}
OB.Dal.get(OB.Model.Discount,productToAdd.get('id'),function(pack){if(pack.get('endingDate')&&pack.get('endingDate').length>0){var objDate=new Date(pack.get('endingDate'));var now=new Date();var nowWithoutTime=new Date(now.toISOString().split('T')[0]);if(nowWithoutTime>objDate){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_PackExpired_header'),OB.I18N.getLabel('OBPOS_PackExpired_body',[pack.get('_identifier'),objDate.toLocaleDateString()]));return;}}
criteria={priceAdjustment:pack.get('id'),_orderByClause:'_identifier'};OB.Dal.find(OB.Model.DiscountFilterProduct,criteria,function(productsOfPromotion){var addProductsAndCalculateDiscounts;addProductsAndCalculateDiscounts=function(products,index,callback,errorCallback){if(index===products.size()){return callback();}
OB.Dal.get(OB.Model.Product,products.at(index).get('product'),function(product){if(product){order.addProduct(product,products.at(index).get('obdiscQty'),{packId:products.at(index).get('priceAdjustment')},undefined,function(){addProductsAndCalculateDiscounts(products,index+1,callback,errorCallback);});}},errorCallback);};order.set('skipApplyPromotions',true);addProductsAndCalculateDiscounts(productsOfPromotion,0,function(){order.set('skipApplyPromotions',false);order.calculateReceipt();},errorCallback);});},function(){});}};(function(){function add(receipt,line,promotion){var definition=promotion.definition,price,pctg,discPrice,unitDiscount,oldDiscountedLinePrice;definition.manual=true;definition._idx=-1;definition.lastApplied=true;if(definition.percentage){price=line.get('price');price=OB.DEC.toBigDecimal(price);pctg=OB.DEC.toBigDecimal(definition.percentage);discPrice=price.multiply(new BigDecimal('100').subtract(pctg).divide(new BigDecimal('100'),20,OB.DEC.getRoundingMode()));discPrice=new BigDecimal((String)(OB.DEC.toNumber(discPrice)));definition.amt=OB.DEC.mul(OB.DEC.abs(line.get('qty')),OB.DEC.toNumber(price.subtract(discPrice)));}else{definition.amt=definition.userAmt;}
oldDiscountedLinePrice=!_.isNull(line.get('discountedLinePrice'))?line.get('discountedLinePrice'):line.get('price');if(oldDiscountedLinePrice<OB.DEC.abs(OB.DEC.div(definition.amt,line.getQty()))){definition.amt=OB.DEC.mul(oldDiscountedLinePrice,OB.DEC.abs(line.getQty()));}
unitDiscount=OB.DEC.div(definition.amt,OB.DEC.abs(line.get('qty')));if(line.getQty()<BigDecimal.prototype.ZERO){definition.amt=OB.DEC.mul(definition.amt,new BigDecimal("-1"));}
line.set('discountedLinePrice',line.get('price')-unitDiscount);receipt.addPromotion(line,promotion.rule,definition);}
function addPercentage(receipt,line,promotion){promotion.definition.percentage=promotion.definition.userAmt;add(receipt,line,promotion);}
OB.Model.Discounts.discountRules.D1D193305A6443B09B299259493B272A={addManual:function(receipt,line,promotion){add(receipt,line,promotion);}};OB.Model.Discounts.discountRules['7B49D8CC4E084A75B7CB4D85A6A3A578']={addManual:function(receipt,line,promotion){add(receipt,line,promotion);}};OB.Model.Discounts.discountRules['20E4EC27397344309A2185097392D964']={addManual:function(receipt,line,promotion){addPercentage(receipt,line,promotion);},getIdentifier:function(rule,discount){return(discount.name||rule.get('printName')||rule.get('name'))+' - '+discount.percentage+' %';}};OB.Model.Discounts.discountRules['8338556C0FBF45249512DB343FEFD280']={addManual:function(receipt,line,promotion){addPercentage(receipt,line,promotion);}};OB.Model.Discounts.onLoadActions=OB.Model.Discounts.onLoadActions||[];OB.Model.Discounts.onLoadActions.push({execute:function(){OB.UTIL.HookManager.registerHook('OBPOS_CheckPaymentApproval',function(args,callbacks){var discretionaryDiscountTypes=OB.Model.Discounts.getManualPromotions(true),discountsToCheck=[],requiresApproval=false,i;if(OB.MobileApp.model.hasPermission('OBPOS_approval.discounts',true)){OB.UTIL.HookManager.callbackExecutor(args,callbacks);return;}
args.context.get('order').get('lines').each(function(l){var p,promotions;promotions=l.get('promotions');if(promotions){for(p=0;p<promotions.length;p++){if(_.contains(discretionaryDiscountTypes,promotions[p].discountType)&&!_.contains(discountsToCheck,promotions[p].ruleId)){discountsToCheck.push(promotions[p].ruleId);}}}},args.context);if(discountsToCheck.length>0){OB.Dal.find(OB.Model.Discount,{obdiscApprovalRequired:true},enyo.bind(args.context,function(discountsWithApproval){for(i=0;i<discountsToCheck.length;i++){if(discountsWithApproval.where({id:discountsToCheck[i]}).length>0){requiresApproval=true;break;}}
if(requiresApproval){args.approvals.push('OBPOS_approval.discounts');}
OB.UTIL.HookManager.callbackExecutor(args,callbacks);}));}else{OB.UTIL.HookManager.callbackExecutor(args,callbacks);return;}});}});}());(function(){window.onerror=function(message,url,line,column,errorObj){if(!errorObj){if(typeof(message)!=='string'){return;}}
var errorMessage;if(errorObj){errorMessage=errorObj.stack;console.log(line,column);}else{errorMessage=message+"; line: "+url+":"+line;}
if(OB.error){if(OB.UTIL&&OB.UTIL.showError){OB.UTIL.showError(errorMessage);}else{OB.error(errorMessage);}}else{console.error(errorMessage);}};OB.UTIL.VersionManagement.current.posterminal={year:16,major:2,minor:0};OB.UTIL.VersionManagement.current.posterminal.WebSQLDatabase={name:'WEBPOS',size:4*1024*1024,displayName:'Openbravo Web POS',dbVersion:OB.UTIL.VersionManagement.current.posterminal.year+"."+OB.UTIL.VersionManagement.current.posterminal.major+OB.UTIL.VersionManagement.current.posterminal.minor};OB.UTIL.VersionManagement.registerDeprecation(27366,{year:14,major:4,minor:0},"The use of 'OB.POS.terminal' is deprecated. Please use 'OB.MobileApp.view' instead.");OB.UTIL.VersionManagement.registerDeprecation(27367,{year:14,major:4,minor:0},"The use of 'OB.POS.terminal.terminal' is deprecated. Please use 'OB.MobileApp.model' instead.");OB.UTIL.VersionManagement.registerDeprecation(27646,{year:14,major:4,minor:0},"The use of 'OB.POS.modelterminal' is deprecated. Please use 'OB.MobileApp.model' instead.");OB.UTIL.VersionManagement.registerDeprecation(27911,{year:14,major:2,minor:5},"The use of OB.MobileApp.model.get('documentsequence'), OB.MobileApp.model.get('quotationDocumentSequence') and the 'seqNoReady' event are deprecated. Please use 'OB.MobileApp.model.getNextDocumentno()' and 'OB.MobileApp.model.getNextQuotationno()' instead.");}());(function(){var ChangedBusinessPartners=Backbone.Model.extend({modelName:'ChangedBusinessPartners',tableName:'changedbusinesspartners',entityName:'',source:'',local:true,properties:['id','json','c_bpartner_id','isbeingprocessed'],propertyMap:{'id':'changedbusinesspartners_id','json':'json','c_bpartner_id':'c_bpartner_id','isbeingprocessed':'isbeingprocessed'},createStatement:'CREATE TABLE IF NOT EXISTS changedbusinesspartners (changedbusinesspartners_id TEXT PRIMARY KEY, json TEXT, c_bpartner_id TEXT, isbeingprocessed TEXT)',dropStatement:'DROP TABLE IF EXISTS changedbusinesspartners',insertStatement:'INSERT INTO changedbusinesspartners(changedbusinesspartners_id, json, c_bpartner_id, isbeingprocessed) VALUES (?,?,?,?)'});OB.Data.Registry.registerModel(ChangedBusinessPartners);}());(function(){var ChangedBPlocation=Backbone.Model.extend({modelName:'ChangedBPlocation',tableName:'changedbplocation',entityName:'',source:'',local:true,properties:['id','json','c_bpartner_location_id','isbeingprocessed'],propertyMap:{'id':'changedbplocation_id','json':'json','c_bpartner_location_id':'c_bpartner_location_id','isbeingprocessed':'isbeingprocessed'},createStatement:'CREATE TABLE IF NOT EXISTS changedbplocation (changedbplocation_id TEXT PRIMARY KEY, json TEXT, c_bpartner_location_id TEXT, isbeingprocessed TEXT)',dropStatement:'DROP TABLE IF EXISTS changedbplocation',insertStatement:'INSERT INTO changedbplocation(changedbplocation_id, json, c_bpartner_location_id, isbeingprocessed) VALUES (?,?,?,?)'});OB.Data.Registry.registerModel(ChangedBPlocation);}());(function(){var OrderLine=Backbone.Model.extend({modelName:'OrderLine',defaults:{product:null,productidentifier:null,uOM:null,qty:OB.DEC.Zero,price:OB.DEC.Zero,priceList:OB.DEC.Zero,gross:OB.DEC.Zero,net:OB.DEC.Zero,description:''},ownProperties:{id:true,lineId:true,product:true,productidentifier:true,name:true,qty:true,quantity:true,uOM:true,price:true,unitPrice:true,baseNetUnitPrice:true,priceList:true,priceIncludesTax:true,gross:true,linegrossamount:true,grossListPrice:true,description:true,promotions:true,shipmentlines:true,relatedLines:true,hasRelatedServices:true,warehouse:true,warehousename:true},initialize:function(attributes){if(attributes&&attributes.product){this.set('product',new OB.Model.Product(attributes.product));this.set('productidentifier',attributes.productidentifier);this.set('uOM',attributes.uOM);this.set('qty',attributes.qty);this.set('price',attributes.price);this.set('priceList',attributes.priceList);this.set('gross',attributes.gross);this.set('net',attributes.net);this.set('promotions',attributes.promotions);this.set('priceIncludesTax',attributes.priceIncludesTax);this.set('description',attributes.description);if(!attributes.grossListPrice&&attributes.product&&_.isNumber(attributes.priceList)){this.set('grossListPrice',attributes.priceList);}
if(attributes.relatedLines&&_.isArray(attributes.relatedLines)){this.set('relatedLines',attributes.relatedLines);}
if(!OB.UTIL.isNullOrUndefined(attributes.hasRelatedServices)){this.set('hasRelatedServices',attributes.hasRelatedServices);}}},getQty:function(){return this.get('qty');},printQty:function(){return this.get('qty').toString();},printPrice:function(){return OB.I18N.formatCurrency(this.get('_price')||this.get('nondiscountedprice')||this.get('price'));},isPrintableService:function(){var product=this.get('product');if(product.get('productType')==='S'&&!product.get('isPrintServices')){return false;}
return true;},getDiscount:function(){return this.getTotalAmountOfPromotions();},printDiscount:function(){return OB.I18N.formatCurrency(this.getDiscount());},discountInTotal:function(){var disc=OB.DEC.mul(OB.DEC.sub(this.get('product').get('standardPrice'),this.get('price')),this.get('qty'));if(OB.DEC.compare(disc)===0){return this.getTotalAmountOfPromotions();}else{return 0;}},calculateGross:function(){if(this.get('priceIncludesTax')){this.set('net',null,{silent:true});this.set('gross',OB.DEC.mul(this.get('qty'),this.get('price')));}else{this.set('gross',null,{silent:true});this.set('net',OB.DEC.mul(this.get('qty'),this.get('price')));}},getGross:function(){return this.get('gross');},getTotalLine:function(){if(!OB.UTIL.isNullOrUndefined(this.get('price'))){return(OB.DEC.mul(this.get('price'),this.get('qty')))-this.getDiscount();}},getNet:function(){return this.get('net');},printGross:function(){return OB.I18N.formatCurrency(this.get('_gross')||this.getGross());},printNet:function(){return OB.I18N.formatCurrency(this.get('nondiscountednet')||this.getNet());},printTotalLine:function(){return OB.I18N.formatCurrency(this.getTotalLine());},getTotalAmountOfPromotions:function(){var memo=0;if(this.get('promotions')&&this.get('promotions').length>0){return _.reduce(this.get('promotions'),function(memo,prom){if(OB.UTIL.isNullOrUndefined(prom.amt)){return memo;}
return memo+prom.amt;},memo,this);}else{return 0;}},isAffectedByPack:function(){return _.find(this.get('promotions'),function(promotion){if(promotion.pack){return true;}},this);},stopApplyingPromotions:function(){var promotions=this.get('promotions'),i;if(promotions){if(OB.MobileApp.model.get('terminal').bestDealCase&&promotions.length>0){return true;}
for(i=0;i<promotions.length;i++){if(!promotions[i].applyNext){return true;}}}
return false;},lastAppliedPromotion:function(){var promotions=this.get('promotions'),i;if(this.get('promotions')){for(i=0;i<promotions.length;i++){if(promotions[i].lastApplied){return promotions[i];}}}
return null;},isReturnable:function(){if(this.get('product').get('returnable')){return true;}else{return false;}}});var OrderLineList=Backbone.Collection.extend({model:OrderLine,isProductPresent:function(product){var result=null;if(this.length>0){result=_.find(this.models,function(line){if(line.get('product').get('id')===product.get('id')){return true;}},this);if(_.isUndefined(result)||_.isNull(result)){return false;}else{return true;}}else{return false;}}});var PaymentLine=Backbone.Model.extend({modelName:'PaymentLine',defaults:{'amount':OB.DEC.Zero,'origAmount':OB.DEC.Zero,'paid':OB.DEC.Zero,'date':null},printAmount:function(){if(this.get('rate')){return OB.I18N.formatCurrency(this.get('origAmount')||OB.DEC.mul(this.get('amount'),this.get('rate')));}else{return OB.I18N.formatCurrency(this.get('amount'));}},printForeignAmount:function(){return'('+OB.I18N.formatCurrency(this.get('amount'))+' '+this.get('isocode')+')';}});var PaymentLineList=Backbone.Collection.extend({model:PaymentLine});var Order=Backbone.Model.extend({modelName:'Order',tableName:'c_order',entityName:'Order',source:'',dataLimit:OB.Dal.DATALIMIT,properties:['id','json','session','hasbeenpaid','isbeingprocessed'],propertyMap:{'id':'c_order_id','json':'json','session':'ad_session_id','hasbeenpaid':'hasbeenpaid','isbeingprocessed':'isbeingprocessed'},defaults:{hasbeenpaid:'N',isbeingprocessed:'N'},createStatement:'CREATE TABLE IF NOT EXISTS c_order (c_order_id TEXT PRIMARY KEY, json CLOB, ad_session_id TEXT, hasbeenpaid TEXT, isbeingprocessed TEXT)',dropStatement:'DROP TABLE IF EXISTS c_order',insertStatement:'INSERT INTO c_order(c_order_id, json, ad_session_id, hasbeenpaid, isbeingprocessed) VALUES (?,?,?,?,?)',local:true,_id:'modelorder',initialize:function(attributes){var orderId;if(attributes&&attributes.id&&attributes.json){orderId=attributes.id;attributes=JSON.parse(attributes.json);attributes.id=orderId;}
var bpModel;if(attributes&&attributes.documentNo){this.set('id',attributes.id);this.set('client',attributes.client);this.set('organization',attributes.organization);this.set('documentType',attributes.documentType);this.set('createdBy',attributes.createdBy);this.set('updatedBy',attributes.updatedBy);this.set('orderType',attributes.orderType);this.set('generateInvoice',attributes.generateInvoice);this.set('isQuotation',attributes.isQuotation);this.set('oldId',attributes.oldId);this.set('priceList',attributes.priceList);this.set('priceIncludesTax',attributes.priceIncludesTax);this.set('currency',attributes.currency);this.set('currency'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,attributes['currency'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER]);this.set('session',attributes.session);this.set('warehouse',attributes.warehouse);this.set('salesRepresentative',attributes.salesRepresentative);this.set('salesRepresentative'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,attributes['salesRepresentative'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER]);this.set('posTerminal',attributes.posTerminal);this.set('posTerminal'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,attributes['posTerminal'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER]);this.set('orderDate',OB.I18N.normalizeDate(attributes.orderDate));this.set('creationDate',OB.I18N.normalizeDate(attributes.creationDate));this.set('documentnoPrefix',attributes.documentnoPrefix);this.set('quotationnoPrefix',attributes.quotationnoPrefix);this.set('documentnoSuffix',attributes.documentnoSuffix);this.set('quotationnoSuffix',attributes.quotationnoSuffix);this.set('documentNo',attributes.documentNo);this.setUndo('InitializeAttr',attributes.undo);bpModel=new Backbone.Model(attributes.bp);bpModel.set('locationModel',new OB.Model.BPLocation(attributes.bp.locationModel));this.set('bp',bpModel);this.set('lines',new OrderLineList().reset(attributes.lines));this.set('payments',new PaymentLineList().reset(attributes.payments));this.set('payment',attributes.payment);this.set('change',attributes.change);this.set('qty',attributes.qty);this.set('gross',attributes.gross);this.set('net',attributes.net);this.set('taxes',attributes.taxes);this.set('hasbeenpaid',attributes.hasbeenpaid);this.set('isbeingprocessed',attributes.isbeingprocessed);this.set('description',attributes.description);this.set('print',attributes.print);this.set('sendEmail',attributes.sendEmail);this.set('isPaid',attributes.isPaid);this.set('isLayaway',attributes.isLayaway);this.set('isEditable',attributes.isEditable);this.set('openDrawer',attributes.openDrawer);this.set('isBeingDiscounted',false);this.set('reApplyDiscounts',false);this.set('calculateReceiptCallbacks',[]);_.each(_.keys(attributes),function(key){if(!this.has(key)){this.set(key,attributes[key]);}},this);}else{this.clearOrderAttributes();}},save:function(callback,collection){var undoCopy=this.get('undo'),me=this,orderList,previousOrder;this.set('json',JSON.stringify(this.serializeToJSON()));if(OB.UTIL.isNullOrUndefined(collection)){orderList=OB.MobileApp.model.orderList.models;}else{orderList=collection;}
if(callback===undefined||!callback instanceof Function){callback=function(){};}
if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){previousOrder=_.max(_.filter(orderList,function(previousOrder){return previousOrder.get('documentnoSuffix')<me.get('documentnoSuffix')&&previousOrder.get('session')===OB.MobileApp.model.get('session')&&previousOrder.get('hasbeenpaid')==='N';}),function(maxDocumentNoOrder){return maxDocumentNoOrder.get('documentnoSuffix');});if(previousOrder){previousOrder.save(null,orderList);}}
if(!OB.MobileApp.model.get('preventOrderSave')){OB.Dal.save(this,function(){if(callback){callback();}},function(){OB.error(arguments);});}else{if(callback){callback();}}
this.setUndo('SaveOrder',undoCopy);},calculateTaxes:function(callback){var me=this;OB.DATA.OrderTaxes(me);me.calculateTaxes(callback);},prepareToSend:function(callback){this.adjustPrices();if(!OB.UTIL.isNullOrUndefined(callback)){callback(this);}},adjustPrices:function(){this.get('lines').each(function(line){var price=line.get('price'),gross=line.get('gross'),totalDiscount=0,grossListPrice=line.get('priceList'),grossUnitPrice,discountPercentage,base;if((line.get('product').get('standardPrice')&&line.get('product').get('standardPrice')!==price)||(_.isNumber(line.get('discountedLinePrice'))&&line.get('discountedLinePrice')!==line.get('product').get('standardPrice'))){grossUnitPrice=new BigDecimal(price.toString());if(OB.DEC.compare(grossListPrice)===0){discountPercentage=OB.DEC.Zero;}else{discountPercentage=OB.DEC.toBigDecimal(grossListPrice).subtract(grossUnitPrice).multiply(new BigDecimal('100')).divide(OB.DEC.toBigDecimal(grossListPrice),2,BigDecimal.prototype.ROUND_HALF_UP);discountPercentage=parseFloat(discountPercentage.setScale(2,BigDecimal.prototype.ROUND_HALF_UP).toString(),10);}}else{discountPercentage=OB.DEC.Zero;}
line.set({discountPercentage:discountPercentage},{silent:true});base=line.get('price');_.forEach(line.get('promotions')||[],function(discount){var discountAmt=discount.actualAmt||discount.amt||0;discount.basePrice=base;discount.unitDiscount=OB.DEC.div(discountAmt,line.get('qtyToApplyDisc')||line.get('qty'));totalDiscount=OB.DEC.add(totalDiscount,discountAmt);base=OB.DEC.sub(base,totalDiscount);},this);gross=OB.DEC.sub(gross,totalDiscount);price=OB.DEC.div(gross,line.get('qty'));if(grossListPrice===undefined){grossListPrice=price;}
if(this.get('priceIncludesTax')){line.set({net:OB.UTIL.getFirstValidValue([OB.DEC.toNumber(line.get('discountedNet')),line.get('net'),OB.DEC.div(gross,line.get('linerate'))]),pricenet:line.get('discountedNet')?OB.DEC.div(line.get('discountedNet'),line.get('qty')):OB.DEC.div(OB.DEC.div(gross,line.get('linerate')),line.get('qty')),listPrice:OB.DEC.div(grossListPrice,line.get('linerate')),standardPrice:OB.DEC.div((grossListPrice||price),line.get('linerate')),grossListPrice:grossListPrice,grossUnitPrice:price,lineGrossAmount:gross},{silent:true});}else{line.set({nondiscountedprice:line.get('price'),nondiscountednet:line.get('net'),standardPrice:line.get('price'),net:line.get('discountedNet'),pricenet:OB.DEC.toNumber(line.get('discountedNetPrice')),listPrice:line.get('priceList'),grossListPrice:0,lineGrossAmount:0},{silent:true});}},this);},getTotal:function(){return this.getGross();},getNet:function(){return this.get('net');},printTotal:function(){return OB.I18N.formatCurrency(this.getTotal());},getLinesByProduct:function(productId){var affectedLines;if(this.get('lines')&&this.get('lines').length>0){affectedLines=_.filter(this.get('lines').models,function(line){return line.get('product').id===productId;});}
return affectedLines?affectedLines:null;},isCalculateGrossLocked:null,isCalculateReceiptLocked:null,setIsCalculateGrossLockState:function(state){this.isCalculateGrossLocked=state;},setIsCalculateReceiptLockState:function(state){this.isCalculateReceiptLocked=state;},calculateGross:function(){var stack=OB.UTIL.getStackTrace('Backbone.Model.extend.calculateGross',false);if(stack.indexOf('Backbone.Model.extend.calculateGross')>-1&&stack.indexOf('Backbone.Model.extend.calculateReceipt')>-1){OB.error("It's forbidden to use calculateGross from outside of calculateReceipt");}
if(this.isCalculateGrossLocked===true){OB.error("calculateGross execution is forbidden right now");return;}else if(this.isCalculateGrossLocked!==false&&!this.get('belongsToMultiOrder')){OB.error("setting the isCalculateGrossLocked state is mandatory before executing it the first time");}
if(this.calculatingGross){this.pendingCalculateGross=true;return;}
var isTheUIReceipt=this===OB.MobileApp.model.receipt||this.get('belongsToMultiOrder');if(!isTheUIReceipt){OB.error("calculateGross should only be called by the UI receipt");}
this.calculatingGross=true;var me=this;me.set({'net':OB.DEC.Zero,'gross':OB.DEC.Zero,'taxes':null,'qty':OB.DEC.Zero},{silent:true});var saveAndTriggerEvents=function(gross){var net=me.get('lines').reduce(function(memo,e){var netLine=e.get('discountedNet');if(netLine){return OB.DEC.add(memo,netLine);}else{return memo;}},OB.DEC.Zero);var qty=me.get('lines').reduce(function(memo,e){var qtyLine=e.getQty();if(qtyLine>0){return OB.DEC.add(memo,qtyLine,OB.I18N.qtyScale());}else{return memo;}},OB.DEC.Zero);me.set({'gross':gross,'qty':qty});me.adjustPayment();me.save(function(){me.calculatingGross=false;me.calculatingReceipt=false;if(me.pendingCalculateGross){me.pendingCalculateGross=false;me.calculateGross();return;}
me.trigger('calculategross');me.trigger('saveCurrent');});};this.get('lines').forEach(function(line){line.calculateGross();});if(this.get('priceIncludesTax')){this.calculateTaxes(function(){var gross=me.get('lines').reduce(function(memo,e){var grossLine=e.getGross();if(e.get('promotions')){grossLine=e.get('promotions').reduce(function(memo,e){return OB.DEC.sub(memo,e.actualAmt||e.amt||0);},grossLine);}
return OB.DEC.add(memo,grossLine);},OB.DEC.Zero);saveAndTriggerEvents(gross);});}else{this.calculateTaxes(function(){var gross=me.get('lines').reduce(function(memo,e){if(_.isUndefined(e.get('discountedGross'))){return memo;}
var grossLine=e.get('discountedGross');if(grossLine){return OB.DEC.add(memo,grossLine);}else{return memo;}},OB.DEC.Zero);saveAndTriggerEvents(gross);});}},addToListOfCallbacks:function(callback){if(OB.UTIL.isNullOrUndefined(this.get('calculateReceiptCallbacks'))){this.set('calculateReceiptCallbacks',[]);}
if(!OB.UTIL.isNullOrUndefined(callback)){var list=this.get('calculateReceiptCallbacks');list.push(callback);}},calculateReceipt:function(callback,line){if(this.get('cloningReceipt')){this.addToListOfCallbacks(callback);return;}
if(this.calculatingReceipt){this.pendingCalculateReceipt=true;this.addToListOfCallbacks(callback);return;}
if(this.isCalculateReceiptLocked===true){OB.error("calculateReceipt execution is forbidden right now");return;}else if(this.isCalculateReceiptLocked!==false&&!this.get('belongsToMultiOrder')){OB.error("setting the isCalculateGrossLocked state is mandatory before executing it the first time");}
var isTheUIReceipt=this===OB.MobileApp.model.receipt||this.get('belongsToMultiOrder');if(!isTheUIReceipt){OB.error("calculateReceipt should only be called by the UI receipt");}
if(this.get('skipCalculateReceipt')){OB.debug('Skipping calculateReceipt function');return;}
OB.MobileApp.view.waterfall('calculatingReceipt');this.calculatingReceipt=true;this.addToListOfCallbacks(callback);var executeCallback;executeCallback=function(listOfCallbacks,callback){if(listOfCallbacks.length===0){callback();listOfCallbacks=null;return;}
var callbackToExe=listOfCallbacks.shift();callbackToExe();executeCallback(listOfCallbacks,callback);};var me=this;this.on('applyPromotionsFinished',function(){me.off('applyPromotionsFinished');me.on('calculategross',function(){me.off('calculategross');if(me.pendingCalculateReceipt){OB.MobileApp.view.waterfall('calculatedReceipt');me.pendingCalculateReceipt=false;me.calculatingReceipt=false;me.calculateReceipt();return;}else{if(me.get('calculateReceiptCallbacks')&&me.get('calculateReceiptCallbacks').length>0){executeCallback(me.get('calculateReceiptCallbacks'),function(){me.calculatingReceipt=false;OB.MobileApp.view.waterfall('calculatedReceipt');});}else{me.calculatingReceipt=false;OB.MobileApp.view.waterfall('calculatedReceipt');}}});me.calculateGross();});if(OB.UTIL.isNullOrUndefined(line)){OB.Model.Discounts.applyPromotions(this);}else{OB.Model.Discounts.applyPromotions(this,line);}},getQty:function(){return this.get('qty');},getGross:function(){return this.get('gross');},printGross:function(){return OB.I18N.formatCurrency(this.getGross());},getPayment:function(){return this.get('payment');},getChange:function(){return this.get('change');},getPending:function(){return OB.DEC.sub(OB.DEC.abs(this.getTotal()),this.getPayment());},printPending:function(){return OB.I18N.formatCurrency(this.getPending());},getPaymentStatus:function(){var total=OB.DEC.abs(this.getTotal()),pay=this.getPayment(),isReturn=true;_.each(this.get('lines').models,function(line){if(line.get('qty')>0){isReturn=false;}},this);return{'done':(this.get('lines').length>0&&OB.DEC.compare(total)>=0&&OB.DEC.compare(OB.DEC.sub(pay,total))>=0),'total':OB.I18N.formatCurrency(total),'pending':OB.DEC.compare(OB.DEC.sub(pay,total))>=0?OB.I18N.formatCurrency(OB.DEC.Zero):OB.I18N.formatCurrency(OB.DEC.sub(total,pay)),'change':OB.DEC.compare(this.getChange())>0?OB.I18N.formatCurrency(this.getChange()):null,'overpayment':OB.DEC.compare(OB.DEC.sub(pay,total))>0?OB.I18N.formatCurrency(OB.DEC.sub(pay,total)):null,'isReturn':isReturn,'isNegative':(this.get('gross')<0||(this.get('gross')>0&&this.get('orderType')===3))?true:false,'changeAmt':this.getChange(),'pendingAmt':OB.DEC.compare(OB.DEC.sub(pay,total))>=0?OB.DEC.Zero:OB.DEC.sub(total,pay),'payments':this.get('payments')};},isLayaway:function(){return this.getOrderType()===2||this.getOrderType()===3||this.get('isLayaway');},clear:function(){this.clearOrderAttributes();this.trigger('change');this.trigger('clear');},clearOrderAttributes:function(){this.set('id',null);this.set('client',null);this.set('organization',null);this.set('createdBy',null);this.set('updatedBy',null);this.set('documentType',null);this.set('orderType',0);this.set('generateInvoice',false);this.set('isQuotation',false);this.set('oldId',null);this.set('priceList',null);this.set('priceIncludesTax',null);this.set('currency',null);this.set('currency'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,null);this.set('session',null);this.set('warehouse',null);this.set('salesRepresentative',null);this.set('salesRepresentative'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,null);this.set('posTerminal',null);this.set('posTerminal'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,null);this.set('orderDate',OB.I18N.normalizeDate(new Date()));this.set('creationDate',null);this.set('documentnoPrefix',-1);this.set('quotationnoPrefix',-1);this.set('documentnoSuffix',-1);this.set('quotationnoSuffix',-1);this.set('documentNo','');this.set('undo',null);this.set('bp',null);this.set('lines',this.get('lines')?this.get('lines').reset():new OrderLineList());this.set('payments',this.get('payments')?this.get('payments').reset():new PaymentLineList());this.set('payment',OB.DEC.Zero);this.set('change',OB.DEC.Zero);this.set('qty',OB.DEC.Zero);this.set('gross',OB.DEC.Zero);this.set('net',OB.DEC.Zero);this.set('taxes',{});this.set('hasbeenpaid','N');this.set('isbeingprocessed','N');this.set('description','');this.set('print',true);this.set('sendEmail',false);this.set('isPaid',false);this.set('paidOnCredit',false);this.set('isLayaway',false);this.set('isEditable',true);this.set('openDrawer',false);this.set('totalamount',null);this.set('approvals',[]);},clearWith:function(_order){OB.UTIL.Debug.execute(function(){var isTheUIReceipt=this.cid===OB.MobileApp.model.receipt.cid;if(!isTheUIReceipt){OB.error("The target of the clearWith should only be the UI receipt. Use OB.UTIL.clone instead");}},this);var idExecution;this.set('isNewReceipt',_order.get('isNewReceipt'));this.set('documentType',_order.get('documentType'));this.set('preventServicesUpdate',true);this.set('isPaid',_order.get('isPaid'));this.set('paidOnCredit',_order.get('paidOnCredit'));this.set('isLayaway',_order.get('isLayaway'));if(!_order.get('isEditable')){this.set('isEditable',_order.get('isEditable'));}
if(_order.get('isLayaway')){if(OB.MobileApp.model.get('terminal').terminalType.generateInvoice&&OB.MobileApp.model.hasPermission('OBPOS_receipt.invoice',true)){if(OB.MobileApp.model.hasPermission('OBPOS_retail.restricttaxidinvoice',true)&&!_order.get('bp').get('taxID')){_order.set('generateInvoice',false);}else{_order.set('generateInvoice',true);}}}
if(OB.UTIL.isNullOrUndefined(this.get('idExecution'))&&OB.UTIL.isNullOrUndefined(_order.get('idExecution'))){idExecution=new Date().getTime();_order.set('idExecution',idExecution);_order.set('cloningReceipt',true);this.set('cloningReceipt',true);this.set('idExecution',idExecution);}
OB.UTIL.clone(_order,this);if(!OB.UTIL.isNullOrUndefined(this.get('idExecution'))&&this.get('idExecution')===idExecution){_order.set('cloningReceipt',false);this.set('cloningReceipt',false);_order.unset('idExecution');this.unset('idExecution');}
this.unset('preventServicesUpdate');this.set('isEditable',_order.get('isEditable'));this.trigger('change');this.trigger('clear');},removeUnit:function(line,qty){if(!OB.DEC.isNumber(qty)){qty=OB.DEC.One;}
this.setUnit(line,OB.DEC.sub(line.get('qty'),qty,OB.I18N.qtyScale()),OB.I18N.getLabel('OBPOS_RemoveUnits',[qty,line.get('product').get('_identifier')]));},addUnit:function(line,qty){if(!OB.DEC.isNumber(qty)){qty=OB.DEC.One;}
this.setUnit(line,OB.DEC.add(line.get('qty'),qty,OB.I18N.qtyScale()),OB.I18N.getLabel('OBPOS_AddUnits',[OB.DEC.toNumber(new BigDecimal((String)(qty.toString()))),line.get('product').get('_identifier')]));},setUnit:function(line,qty,text,doNotSave){var permission,me=this;if(OB.DEC.isNumber(qty)&&qty!==0){var oldqty=line.get('qty');permission='OBPOS_ReturnLine';if(!OB.MobileApp.model.hasPermission(permission,true)&&qty<0&&oldqty>0){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgCannotAddNegative'));return;}
if(qty>0&&oldqty<0&&this.get('orderType')===1){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgCannotAddPostiveToReturn'));return;}
if(line.get('product').get('groupProduct')===false){this.addProduct(line.get('product'));return true;}else{line.set('qty',qty);if(this.get('multipleUndo')){var undoText='',oldqtys=[],lines=[],undo=this.get('undo');if(undo&&undo.oldqtys){undoText=undo.text+', ';oldqtys=undo.oldqtys;lines=undo.lines;}
undoText+=text||OB.I18N.getLabel('OBPOS_SetUnits',[line.get('qty'),line.get('product').get('_identifier')]);oldqtys.push(oldqty);lines.push(line);this.setUndo('EditLine',{text:undoText,oldqtys:oldqtys,lines:lines,undo:function(){var i,thisUndo=me.get('undo');for(i=0;i<thisUndo.lines.length;i++){thisUndo.lines[i].set('qty',thisUndo.oldqtys[i]);}
me.calculateReceipt();me.set('undo',null);}});}else{this.setUndo('EditLine',{text:text||OB.I18N.getLabel('OBPOS_SetUnits',[line.get('qty'),line.get('product').get('_identifier')]),oldqty:oldqty,line:line,undo:function(){line.set('qty',oldqty);me.calculateReceipt();me.set('undo',null);}});}}
this.adjustPayment();if(!doNotSave){this.save();}}else{if(line.get('deleteApproved')){line.unset('deleteApproved');this.set('preventServicesUpdate',true);this.set('deleting',true);this.deleteLine(line);this.unset('preventServicesUpdate');this.unset('deleting');this.get('lines').trigger('updateRelations');}else{OB.UTIL.Approval.requestApproval(OB.MobileApp.view.$.containerWindow.getRoot().model,'OBPOS_approval.deleteLine',function(approved){if(approved){me.set('preventServicesUpdate',true);me.set('deleting',true);me.deleteLine(line);me.unset('preventServicesUpdate');me.unset('deleting');me.get('lines').trigger('updateRelations');}});}}},setPrice:function(line,price,options){if(this.get('isQuotation')&&this.get('hasbeenpaid')==='Y'){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_QuotationClosed'));return;}
OB.UTIL.HookManager.executeHooks('OBPOS_PreSetPrice',{context:this,line:line,price:price,options:options},function(args){var me=args.context;if(args.cancellation&&args.cancellation===true){return;}
options=args.options||{};options.setUndo=(_.isUndefined(options.setUndo)||_.isNull(options.setUndo)||options.setUndo!==false)?true:options.setUndo;if(!OB.UTIL.isNullOrUndefined(args.line.get('originalOrderLineId'))){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_CannotChangePrice'));}else if(OB.DEC.isNumber(args.price)){var oldprice=args.line.get('price');if(OB.DEC.compare(args.price)>=0){args.line.set('price',args.price);if(options.setUndo){if(me.get('multipleUndo')){var text='',oldprices=[],lines=[],undo=me.get('undo');if(undo&&undo.oldprices){text=undo.text+', ';oldprices=undo.oldprices;lines=undo.lines;}
text+=OB.I18N.getLabel('OBPOS_SetPrice',[args.line.printPrice(),args.line.get('product').get('_identifier')]);oldprices.push(oldprice);lines.push(args.line);me.setUndo('EditLine',{text:text,oldprices:oldprices,lines:lines,undo:function(){var i;for(i=0;i<me.get('undo').lines.length;i++){me.get('undo').lines[i].set('price',me.get('undo').oldprices[i]);}
me.calculateReceipt();me.set('undo',null);}});}else{me.setUndo('EditLine',{text:OB.I18N.getLabel('OBPOS_SetPrice',[args.line.printPrice(),args.line.get('product').get('_identifier')]),oldprice:oldprice,line:args.line,undo:function(){args.line.set('price',oldprice);me.calculateReceipt();me.set('undo',null);}});}}}
me.adjustPayment();}
me.save();});},setLineProperty:function(line,property,value){var index=this.get('lines').indexOf(line);this.get('lines').at(index).set(property,value);},setUndo:function(action,data){var me=this;if(data){data.action=action;}
OB.UTIL.HookManager.executeHooks('OBPOS_PreSetUndo_'+action,{data:data},function(args){me.set('undo',args.data);});},deleteLines:function(lines,idx,length,callback){var me=this,line=lines[idx];if(idx===0){this.set('undo',null);}
idx++;if(this.get('lines').get(line)){if(idx<length){this.deleteLine(line,true);this.deleteLines(lines,idx,length,callback);}else{this.deleteLine(line,false,callback);}}else{if(idx===length){if(callback){callback();}}else{this.deleteLines(lines,idx,length,callback);}}},removeDeleteLine:function(line){var deleteIndex=-1;_.each(this.get('deletedLines'),function(d,index){if(d.id===line.id){deleteIndex=index;}});if(deleteIndex!==-1){this.get('deletedLines').splice(deleteIndex,1);if(this.get('deletedLines').length===0){this.unset('deletedLines');}}
line.unset('obposIsDeleted');},deleteLine:function(line,doNotSave,callback){var me=this,pack=line.isAffectedByPack(),productId=line.get('product').id;if(pack){this.get('lines').forEach(function(l){var affected;if(productId===l.get('product').id){return;}
affected=l.isAffectedByPack();if(affected&&affected.ruleId===pack.ruleId){this.mergeLines(l);}},this);}
line.trigger('removed',line);function finishDelete(){var text,lines,indexes,relations,rl,rls,i;me.get('lines').remove(line);text=me.get('undo').text;lines=me.get('undo').lines;relations=me.get('undo').relations;me.setUndo('DeleteLine',{text:text,lines:lines,relations:relations,undo:function(){enyo.$.scrim.show();me.set('preventServicesUpdate',true);me.set('deleting',true);if(OB.MobileApp.model.get('terminal').businessPartner===me.get('bp').get('id')){for(i=0;i<me.get('undo').lines.length;i++){if(!me.get('undo').lines[i].get('product').get('oBPOSAllowAnonymousSale')){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),OB.I18N.getLabel('OBPOS_AnonymousSaleForProductNotAllowed',[me.get('undo').lines[i].get('product').get('_identifier')]));return;}}}
me.get('undo').lines.sort(function(a,b){if(a.get('undoPosition')>b.get('undoPosition')){return 1;}
if(a.get('undoPosition')<b.get('undoPosition')){return-1;}
return 0;});lines.forEach(function(line){me.removeDeleteLine(line);me.get('lines').add(line,{at:line.get('undoPosition')});});relations.forEach(function(rel){var rls=rel[0].get('relatedLines').slice(),lineToAddRelated=_.filter(me.get('lines').models,function(line){return line.id===rel[0].id;});rls.push(rel[1]);lineToAddRelated[0].set('relatedLines',rls);});me.set('undo',null);me.unset('preventServicesUpdate');me.unset('deleting');me.get('lines').trigger('updateRelations');me.calculateReceipt();enyo.$.scrim.hide();}});me.adjustPayment();if(!doNotSave){me.save(callback);}else if(callback){callback();}}
if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){if(!this.get('deletedLines')){this.set('deletedLines',[]);}
if(!line.get('hasTaxError')){line.set('obposIsDeleted',true);this.get('deletedLines').push(new OrderLine(line.attributes));}}
finishDelete();},_addProduct:function(p,qty,options,attrs,callback){var newLine=true,line=null,me=this;if(enyo.Panels.isScreenNarrow()){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_AddLine',[qty?qty:1,p.get('_identifier')]));}
if(p.get('ispack')){OB.Model.Discounts.discountRules[p.get('productCategory')].addProductToOrder(this,p);if(callback){callback(true);}
return;}
if(this.get('orderType')===1){qty=qty?-qty:-1;}else{qty=qty||1;}
if(((options&&options.line)?options.line.get('qty')+qty:qty)<0&&p.get('productType')==='S'&&!p.get('returnable')){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableProduct'),OB.I18N.getLabel('OBPOS_UnreturnableProductMessage',[p.get('_identifier')]));if(callback){callback(false);}
return;}
function addProductToOrder(){if(me.get('isQuotation')&&me.get('hasbeenpaid')==='Y'){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_QuotationClosed'));if(callback){callback(false);}
return false;}
if(p.get('obposScale')){OB.POS.hwserver.getWeight(function(data){if(data.exception){OB.UTIL.showConfirmation.display('',data.exception.message);}else if(data.result===0){OB.UTIL.showConfirmation.display('',OB.I18N.getLabel('OBPOS_WeightZero'));}else{line=me.createLine(p,data.result,options,attrs);}});}else{if(p.get('groupProduct')||(options&&options.packId)){var affectedByPack;if(options&&options.line){line=options.line;}else{line=me.get('lines').find(function(l){if(l.get('product').id===p.id&&((l.get('qty')>0&&qty>0)||(l.get('qty')<0&&qty<0))){affectedByPack=l.isAffectedByPack();if(!affectedByPack){return true;}else if((options&&options.packId===affectedByPack.ruleId)||!(options&&options.packId)){return true;}}});}
OB.UTIL.HookManager.executeHooks('OBPOS_GroupedProductPreCreateLine',{receipt:me,line:line,allLines:me.get('lines'),p:p,qty:qty,options:options,attrs:attrs},function(args){if(args&&args.cancelOperation){if(callback){callback(false);}
return;}
if(args.line&&(qty!==1||args.line.get('qty')!==-1||args.p.get('productType')!=='S'||(args.p.get('productType')==='S'&&!args.p.get('isLinkedToProduct')))){args.receipt.addUnit(args.line,args.qty);if(!_.isUndefined(args.attrs)){_.each(_.keys(args.attrs),function(key){if(args.p.get('productType')==='S'&&key==='relatedLines'&&args.line.get('relatedLines')){args.line.set('relatedLines',OB.UTIL.mergeArrays(args.line.get('relatedLines'),attrs[key]));}else{args.line.set(key,attrs[key]);}});}
args.line.trigger('selected',args.line);line=args.line;newLine=false;}else{if(args.attrs&&args.attrs.relatedLines&&args.attrs.relatedLines[0].deferred&&args.p.get('quantityRule')==='PP'){line=args.receipt.createLine(args.p,args.attrs.relatedLines[0].qty,args.options,args.attrs);}else{line=args.receipt.createLine(args.p,args.qty,args.options,args.attrs);}}});}else{if(options&&options.line&&qty===-1){me.addUnit(options.line,qty);line=options.line;newLine=false;}else{line=me.createLine(p,qty,options,attrs);}}}
me.save();OB.UTIL.HookManager.executeHooks('OBPOS_PostAddProductToOrder',{receipt:me,productToAdd:p,orderline:line,qtyToAdd:qty,options:options,newLine:newLine},function(args){if(args.newLine&&me.get('lines').contains(line)&&args.productToAdd.get('productType')!=='S'){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('HasServices');var productId=args.productToAdd.get('forceFilterId')?args.productToAdd.get('forceFilterId'):args.productToAdd.id;args.receipt._loadRelatedServices(args.productToAdd.get('productType'),productId,args.productToAdd.get('productCategory'),function(data){if(data){if(data.hasservices){args.orderline.set('hasRelatedServices',true);args.orderline.trigger('showServicesButton');}else{args.orderline.set('hasRelatedServices',false);}
args.receipt.save();if(data.hasmandatoryservices){args.receipt.trigger('showProductList',args.orderline,'mandatory');}}
OB.UTIL.SynchronizationHelper.finished(synchId,'HasServices');if(callback){callback(true);}},args.orderline);}else{if(callback){callback(true);}}});}
if(((options&&options.line)?options.line.get('qty')+qty:qty)<0&&p.get('productType')==='S'){OB.UTIL.Approval.requestApproval(OB.MobileApp.view.$.containerWindow.getRoot().model,'OBPOS_approval.returnService',function(approved,supervisor,approvalType){if(approved){addProductToOrder();}});}else{addProductToOrder();}},_loadRelatedServices:function(productType,productId,productCategory,callback,line){if(productType!=='S'&&(!line||!line.get('originalOrderLineId'))){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){var process=new OB.DS.Process('org.openbravo.retail.posterminal.process.HasServices');var params={},date=new Date(),i,prod,synchId;params.terminalTime=date;params.terminalTimeOffset=date.getTimezoneOffset();process.exec({product:productId,productCategory:productCategory,parameters:params},function(data,message){if(data&&data.exception){OB.error(OB.I18N.getLabel('OBPOS_ErrorGettingRelatedServices'));callback(null);}else if(data){callback(data);}else{callback(null);}},function(error){OB.error(OB.I18N.getLabel('OBPOS_ErrorGettingRelatedServices'));callback(null);});}else{var criteria={};criteria._whereClause='';criteria.params=[];criteria._whereClause=" as product where product.productType = 'S' and (product.isLinkedToProduct = 'true' and ";criteria._whereClause+="((product.includeProducts = 'Y' and not exists (select 1 from m_product_service sp where product.m_product_id = sp.m_product_id and sp.m_related_product_id = ? ))";criteria._whereClause+="or (product.includeProducts = 'N' and exists (select 1 from m_product_service sp where product.m_product_id = sp.m_product_id and sp.m_related_product_id = ? ))";criteria._whereClause+="or product.includeProducts is null) ";criteria._whereClause+="and ((product.includeProductCategories = 'Y' and not exists (select 1 from m_product_category_service spc where product.m_product_id = spc.m_product_id and spc.m_product_category_id =  ? )) ";criteria._whereClause+="or (product.includeProductCategories = 'N' and exists (select 1 from m_product_category_service spc where product.m_product_id = spc.m_product_id and spc.m_product_category_id  = ? )) ";criteria._whereClause+="or product.includeProductCategories is null)) ";criteria.params.push(productId);criteria.params.push(productId);criteria.params.push(productCategory);criteria.params.push(productCategory);OB.Dal.find(OB.Model.Product,criteria,function(data){if(data){data.hasservices=data.length>0;data.hasmandatoryservices=_.find(data.models,function(model){return model.get('proposalType')==='MP';});callback(data);}else{callback(null);}},function(trx,error){OB.error(OB.I18N.getLabel('OBPOS_ErrorGettingRelatedServices'));callback(null);});}}else{callback(null);}},_drawLinesDistribution:function(data){if(data&&data.linesToModify&&data.linesToModify.length>0){_.each(data.linesToModify,function(lineToChange){var line=this.get('lines').getByCid(lineToChange.lineCid);var unitsToAdd=lineToChange.newQty-line.get('qty');if(unitsToAdd>0){this.addUnit(line,unitsToAdd);}else if(unitsToAdd<0){this.removeUnit(line,-unitsToAdd);}
this.setPrice(line,lineToChange.newPrice,{setUndo:false});_.each(lineToChange.productProperties,function(propToSet){line.get('product').set(propToSet.name,propToSet.value);});_.each(lineToChange.lineProperties,function(propToSet){line.set(propToSet.name,propToSet.value);});},this);}
if(data&&data.linesToRemove&&data.linesToRemove.length>0){_.each(data.linesToRemove,function(lineCidToRemove){var line=this.get('lines').getByCid(lineCidToRemove);this.set('preventServicesUpdate',true);this.set('deleting',true);this.deleteLine(line);this.unset('preventServicesUpdate');this.unset('deleting');this.get('lines').trigger('updateRelations');},this);}
if(data&&data.linesToAdd&&data.linesToAdd.length>0){_.each(data.linesToAdd,function(lineToAdd){this.createLine(lineToAdd.product,lineToAdd.qtyToAdd);},this);}},addProduct:function(p,qty,options,attrs,callback){OB.debug('_addProduct');var me=this;if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)&&this.get('priceList')!==OB.MobileApp.model.get('terminal').priceList){var criteria={};if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){criteria={m_pricelist_id:this.get('priceList'),m_product_id:p.id};}else{var remoteCriteria=[];var productId={columns:['m_product_id'],operator:'equals',value:p.id,isId:true},pricelistId={columns:['m_pricelist_id'],operator:'equals',value:this.get('priceList'),isId:true};remoteCriteria.push(productId);remoteCriteria.push(pricelistId);criteria.remoteFilters=remoteCriteria;}
OB.Dal.find(OB.Model.ProductPrice,criteria,function(productPrices){if(productPrices.length>0){p=p.clone();p.set('standardPrice',productPrices.at(0).get('pricestd'));p.set('listPrice',productPrices.at(0).get('pricelist'));me.addProductToOrder(p,qty,options,attrs,function(success){if(callback){callback(success);}});}else{OB.UTIL.showI18NWarning('OBPOS_ProductNotFoundInPriceList');if(callback){callback(false);}}},function(){OB.UTIL.showI18NWarning('OBPOS_ProductNotFoundInPriceList');if(callback){callback(false);}});}else{me.addProductToOrder(p,qty,options,attrs,function(success){if(callback){callback(success);}});}},addProductToOrder:function(p,qty,options,attrs,callback){var me=this;OB.UTIL.HookManager.executeHooks('OBPOS_AddProductToOrder',{receipt:this,productToAdd:p,qtyToAdd:qty,options:options},function(args){if(args&&args.productToAdd&&args.productToAdd.get('isGeneric')){OB.UTIL.showI18NWarning('OBPOS_GenericNotAllowed');if(callback){callback(false);}
return;}
if(OB.MobileApp.model.get('terminal').businessPartner===me.get('bp').get('id')&&args&&args.productToAdd&&args.productToAdd.has('oBPOSAllowAnonymousSale')&&!args.productToAdd.get('oBPOSAllowAnonymousSale')){if(args.receipt&&args.receipt.get('deferredOrder')){args.receipt.unset("deferredOrder",{silent:true});OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),OB.I18N.getLabel('OBPOS_AnonymousSaleNotAllowedDeferredSale'));}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),OB.I18N.getLabel('OBPOS_AnonymousSaleNotAllowed'));}
if(callback){callback(false);}
return;}
if(args&&args.receipt&&args.receipt.get('deferredOrder')){args.receipt.unset("deferredOrder",{silent:true});}
if(args&&args.useLines){me._drawLinesDistribution(args);if(callback){callback(false);}
return;}
me._addProduct(p,qty,options,attrs,function(success){if(callback){callback(success);}});});},splitLine:function(line,qtyToKeep){var originalQty=line.get('qty'),newLine,p,qtyToMove;if(originalQty===qtyToKeep){return;}
qtyToMove=originalQty-qtyToKeep;this.setUnit(line,qtyToKeep,null,true);p=line.get('product');newLine=this.get('lines').find(function(l){return l!==line&&l.get('product').id===p.id&&!l.isAffectedByPack();});if(!newLine){newLine=line.clone();newLine.set({promotions:null,addedBySplit:true});this.get('lines').add(newLine);this.setUnit(newLine,qtyToMove,null,true);return newLine;}else{this.setUnit(newLine,newLine.get('qty')+qtyToMove,null,true);}},mergeLines:function(line){var p=line.get('product'),lines=this.get('lines'),merged=false;line.set('promotions',null);lines.forEach(function(l){if(l===line){return;}
if(l.get('product').id===p.id&&l.get('price')===line.get('price')){line.set({qty:line.get('qty')+l.get('qty'),promotions:null});lines.remove(l);merged=true;}},this);},mergeLinesWithSamePromotions:function(){var lines=this.get('lines'),line,i,j,k,otherLine,toRemove=[],matches,otherPromos,found,compareRule;compareRule=function(p){var basep=line.get('promotions')[k];return p.ruleId===basep.ruleId&&((!p.family&&!basep.family)||(p.family&&basep.family&&p.family===basep.family));};for(i=0;i<lines.length;i++){line=lines.at(i);for(j=i+1;j<lines.length;j++){otherLine=lines.at(j);if(otherLine.get('product').id!==line.get('product').id){continue;}
if((!line.get('promotions')||line.get('promotions').length===0)&&(!otherLine.get('promotions')||otherLine.get('promotions').length===0)){line.set('qty',line.get('qty')+otherLine.get('qty'));toRemove.push(otherLine);}else if(line.get('promotions')&&otherLine.get('promotions')&&line.get('promotions').length===otherLine.get('promotions').length&&line.get('price')===otherLine.get('price')){matches=true;otherPromos=otherLine.get('promotions');for(k=0;k<line.get('promotions').length;k++){found=_.find(otherPromos,compareRule);if(!found){matches=false;break;}}
if(matches){line.set('qty',line.get('qty')+otherLine.get('qty'));for(k=0;k<line.get('promotions').length;k++){found=_.find(otherPromos,compareRule);line.get('promotions')[k].amt+=found.amt;line.get('promotions')[k].displayedTotalAmount+=found.displayedTotalAmount;}
toRemove.push(otherLine);}}}}
_.forEach(toRemove,function(l){lines.remove(l);});},addPromotion:function(line,rule,discount){if(this.get('isQuotation')&&this.get('hasbeenpaid')==='Y'){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_QuotationClosed'));return;}
var promotions=line.get('promotions')||[],disc={},i,replaced=false,discountRule=OB.Model.Discounts.discountRules[rule.attributes.discountType];if(discountRule.getIdentifier){disc.identifier=discountRule.getIdentifier(rule,discount);}
disc.name=discount.name||rule.get('printName')||rule.get('name');disc.ruleId=rule.id||rule.get('ruleId');disc.amt=discount.amt;disc.fullAmt=discount.amt?discount.amt:0;disc.actualAmt=discount.actualAmt;disc.pack=discount.pack;disc.discountType=rule.get('discountType');disc.priority=rule.get('priority');disc.manual=discount.manual;disc.userAmt=discount.userAmt;disc.lastApplied=discount.lastApplied;disc.obdiscQtyoffer=rule.get('qtyOffer')?OB.DEC.toNumber(rule.get('qtyOffer')):line.get('qty');disc.qtyOffer=disc.obdiscQtyoffer;disc.doNotMerge=discount.doNotMerge;disc.hidden=discount.hidden===true||(discount.actualAmt&&!disc.amt);disc.preserve=discount.preserve===true;if(OB.UTIL.isNullOrUndefined(discount.actualAmt)&&!disc.amt&&disc.pack){disc.hidden=true;}
if(disc.hidden){disc.displayedTotalAmount=0;}else{disc.displayedTotalAmount=disc.amt||discount.actualAmt;}
if(discount.percentage){disc.percentage=discount.percentage;}
if(discount.family){disc.family=discount.family;}
if(typeof discount.applyNext!=='undefined'){disc.applyNext=discount.applyNext;}else{disc.applyNext=rule.get('applyNext');}
if(!disc.applyNext){disc.qtyOfferReserved=disc.obdiscQtyoffer;}else{disc.qtyOfferReserved=0;}
disc._idx=discount._idx||rule.get('_idx');for(i=0;i<promotions.length;i++){if(disc._idx!==-1&&disc._idx<promotions[i]._idx){OB.Model.Discounts.applyPromotionsImp(this,line,true);return;}}
for(i=0;i<promotions.length;i++){if(promotions[i].ruleId===rule.id){if(promotions[i].hidden!==true){promotions[i]=disc;replaced=true;break;}}}
if(!replaced){promotions.push(disc);}
line.set('promotions',promotions);line.trigger('change');},removePromotion:function(line,rule){var promotions=line.get('promotions'),ruleId=rule.id,removed=false,res=[],i;if(!promotions){return;}
for(i=0;i<promotions.length;i++){if(promotions[i].ruleId===rule.id){removed=true;}else{res.push(promotions[i]);}}
if(removed){line.set('promotions',res);line.trigger('change');this.save();}},createLine:function(p,units,options,attrs){var me=this;if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){OB.Dal.saveTemporally(p,function(){},function(){OB.error(arguments);},true);}
if(this.validateAllowSalesWithReturn(units,false)){return;}
var newline=new OrderLine({id:OB.UTIL.get_UUID(),product:p,uOM:p.get('uOM'),qty:OB.DEC.number(units),price:OB.DEC.number(p.get('standardPrice')),priceList:OB.DEC.number(p.get('listPrice')),priceIncludesTax:this.get('priceIncludesTax'),warehouse:{id:OB.MobileApp.model.get('warehouses')[0].warehouseid,warehousename:OB.MobileApp.model.get('warehouses')[0].warehousename}});if(!_.isUndefined(attrs)){_.each(_.keys(attrs),function(key){newline.set(key,attrs[key]);});}
if(newline.get('relatedLines')){newline.set('groupService',newline.get('product').get('groupProduct'));}
if(newline.get('product').get("showstock")===true){newline.get('product').set("showstock",false);newline.get('product').set("_showstock",true);}
this.get('lines').add(newline,options);newline.trigger('created',newline);this.setUndo('CreateLine',{text:OB.I18N.getLabel('OBPOS_AddLine',[newline.get('qty'),newline.get('product').get('_identifier')]),line:newline,undo:function(modelObj){var order=OB.MobileApp.model.receipt;OB.UTIL.Approval.requestApproval((modelObj?modelObj:this.model),'OBPOS_approval.deleteLine',function(approved){if(approved){if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){if(!order.get('deletedLines')){order.set('deletedLines',[]);}
newline.set('obposIsDeleted',true);order.get('deletedLines').push(new OrderLine(newline.attributes));order.save(function(){order.get('lines').remove(newline);order.calculateGross();order.set('undo',null);});}else{order.get('lines').remove(newline);order.calculateGross();order.set('undo',null);}}});}});this.adjustPayment();return newline;},returnLine:function(line,options,skipValidaton){var me=this;if(this.validateAllowSalesWithReturn(-line.get('qty'),skipValidaton)){return;}
if(line.get('qty')>0){line.get('product').set('ignorePromotions',true);}else{line.get('product').set('ignorePromotions',false);}
line.set('qty',-line.get('qty'));if(me.get('multipleUndo')){var text='',lines=[],undo=me.get('undo');if(undo&&undo.lines){text=undo.text+', ';lines=undo.lines;}
text+=OB.I18N.getLabel('OBPOS_ReturnLine',[line.get('qty'),line.get('product').get('_identifier')]);lines.push(line);me.setUndo('ReturnLine',{text:text,lines:lines,undo:function(){_.each(lines,function(line){line.set('qty',-line.get('qty'));});me.calculateReceipt();me.set('undo',null);}});}else{this.setUndo('ReturnLine',{text:OB.I18N.getLabel('OBPOS_ReturnLine',[line.get('product').get('_identifier')]),line:line,undo:function(){line.set('qty',-line.get('qty'));me.set('undo',null);}});}
this.adjustPayment();if(line.get('promotions')){line.unset('promotions');}
this.save();},setBPandBPLoc:function(businessPartner,showNotif,saveChange,callback){var me=this,undef;var i,oldbp=this.get('bp');if(OB.MobileApp.model.get('terminal').businessPartner===businessPartner.id){for(i=0;i<me.get('lines').models.length;i++){if(!me.get('lines').models[i].get('product').get('oBPOSAllowAnonymousSale')){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),OB.I18N.getLabel('OBPOS_AnonymousSaleForProductNotAllowed',[me.get('lines').models[i].get('product').get('_identifier')]));return;}}}
if(OB.UTIL.isNullOrUndefined(businessPartner.get('paymentTerms'))){OB.UTIL.showWarning(enyo.format(OB.I18N.getLabel('OBPOS_MsgBPNotPaymentTerm'),businessPartner.get('name')));businessPartner.set('paymentTerms',OB.MobileApp.model.get('terminal').defaultbp_paymentterm);}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){if(oldbp.id!==businessPartner.id){OB.Dal.removeTemporally(new OB.Model.BusinessPartner(oldbp),function(){},function(){OB.UTIL.showError('Error removing');});OB.Dal.saveTemporally(businessPartner,function(){},function(){OB.error(arguments);},true);if(OB.MobileApp.model.hasPermission('OBPOS_remote.discount.bp',true)){var oldbpfilter={columns:['businessPartner'],operator:'equals',value:oldbp.id,isId:true};var oldRemoteCriteria=[oldbpfilter];var criteria={};criteria.remoteFilters=oldRemoteCriteria;OB.Dal.find(OB.Model.DiscountFilterBusinessPartner,criteria,function(discountsBP){_.each(discountsBP.models,function(dsc){OB.Dal.removeTemporally(dsc,function(){},function(){OB.error(arguments);},true);});},function(){OB.error(arguments);});var bp={columns:['businessPartner'],operator:'equals',value:businessPartner.id,isId:true};var remoteCriteria=[bp];var criteriaFilter={};criteriaFilter.remoteFilters=remoteCriteria;OB.Dal.find(OB.Model.DiscountFilterBusinessPartner,criteriaFilter,function(discountsBP){_.each(discountsBP.models,function(dsc){OB.Dal.saveTemporally(dsc,function(){},function(){OB.error(arguments);},true);});},function(){OB.error(arguments);});}
OB.Dal.get(OB.Model.BPLocation,businessPartner.get('locId'),function(location){var loc=oldbp.get('locationModel');OB.Dal.removeTemporally(loc,function(){},function(){OB.UTIL.showError('Error removing');});OB.Dal.saveTemporally(location,function(){businessPartner.set('locationModel',location);me.set('bp',businessPartner);me.save();},function(){OB.error(arguments);},true);},function(){OB.error(arguments);});}else if(businessPartner.get('locationModel')){var location=oldbp.get('locationModel');OB.Dal.removeTemporally(location,function(){},function(){OB.UTIL.showError('Error removing');});OB.Dal.saveTemporally(businessPartner.get('locationModel'),function(){me.set('bp',businessPartner);me.save();},function(){OB.error(arguments);},true);}}else{this.set('bp',businessPartner);this.save();}
if(showNotif===undef||showNotif===true){this.setUndo('SetBPartner',{text:businessPartner?OB.I18N.getLabel('OBPOS_SetBP',[businessPartner.get('_identifier')]):OB.I18N.getLabel('OBPOS_ResetBP'),bp:businessPartner,undo:function(){me.set('bp',oldbp);me.save();me.set('undo',null);}});}
if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)){if(oldbp.get('priceList')!==businessPartner.get('priceList')){me.set('priceList',businessPartner.get('priceList'));var priceIncludesTax=businessPartner.get('priceIncludesTax');if(OB.UTIL.isNullOrUndefined(priceIncludesTax)){priceIncludesTax=OB.MobileApp.model.get('pricelist').priceIncludesTax;}
me.set('priceIncludesTax',priceIncludesTax);me.removeAndInsertLines(function(){me.calculateReceipt(function(){if(saveChange){me.save();}
if(callback){callback();}});});}else{me.calculateReceipt(function(){if(saveChange){me.save();}
if(callback){callback();}});}}else{if(saveChange){this.save();}
if(callback){callback();}}},validateAllowSalesWithReturn:function(qty,skipValidaton){if(OB.MobileApp.model.hasPermission('OBPOS_NotAllowSalesWithReturn',true)&&!skipValidaton){var negativeLines=_.filter(this.get('lines').models,function(line){return line.get('qty')<0;}).length;if(this.get('lines').length>0){if(qty>0&&negativeLines>0){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgCannotAddPositive'));return true;}else if(qty<0&&negativeLines!==this.get('lines').length){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgCannotAddNegative'));return true;}}}
if(this.isLayaway()&&qty<0){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_layawaysOrdersWithReturnsNotAllowed'));return true;}
return false;},removeAndInsertLines:function(callback){this.set('skipCalculateReceipt',true);var me=this;var orderlines=[];var promotionlines=[];var addProductsOfLines=null;addProductsOfLines=function(receipt,lines,index,callback,promotionLines){if(index===lines.length){me.set('skipCalculateReceipt',false);if(callback){callback();}
return;}
OB.Dal.get(OB.Model.Product,lines[index].get('product').id,function(product){me.addProduct(product,lines[index].get('qty'),undefined,undefined,function(isInPriceList){if(isInPriceList){me.get('lines').at(index).set('promotions',promotionLines[index]);me.get('lines').at(index).calculateGross();addProductsOfLines(receipt,lines,index+1,callback,promotionLines);}else{promotionLines.splice(index,1);lines.splice(index,1);addProductsOfLines(receipt,lines,index,callback,promotionLines);}});});};_.each(me.get('lines').models,function(line){orderlines.push(line);promotionlines.push(line.get('promotions'));});this.set('preventServicesUpdate',true);this.set('deleting',true);_.each(orderlines,function(line){me.deleteLine(line,true);});this.unset('preventServicesUpdate');this.unset('deleting');this.get('lines').trigger('updateRelations');addProductsOfLines(this,orderlines,0,callback,promotionlines);},setOrderType:function(permission,orderType,options){var me=this,i,approvalNeeded,servicesToApprove;function finishSetOrderType(){me.set('orderType',orderType);if(orderType!==3){if(!(options&&!OB.UTIL.isNullOrUndefined(options.saveOrder)&&options.saveOrder===false)){me.save();}}else{me.set('layawayGross',me.getGross());me.set('gross',me.get('payment'));me.set('payment',OB.DEC.Zero);me.get('payments').reset();}
if(!(options&&!OB.UTIL.isNullOrUndefined(options.applyPromotions)&&options.applyPromotions===false)){OB.Model.Discounts.applyPromotions(me);}}
function returnLines(){me.set('preventServicesUpdate',true);_.each(me.get('lines').models,function(line){if(line.get('qty')>0){me.returnLine(line,null,true);}},me);me.unset('preventServicesUpdate');finishSetOrderType();}
if(orderType===OB.DEC.One){this.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns);if(options.saveOrder!==false){approvalNeeded=false;servicesToApprove='';for(i=0;i<this.get('lines').models.length;i++){var line=this.get('lines').models[i];if(line.get('product').get('productType')==='S'&&!line.isReturnable()){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableProduct'),OB.I18N.getLabel('OBPOS_UnreturnableProductMessage',[line.get('product').get('_identifier')]));return;}else{if(line.get('product').get('productType')==='S'){if(!approvalNeeded){approvalNeeded=true;}
servicesToApprove+='<br>· '+line.get('product').get('_identifier');}}}
if(approvalNeeded){OB.UTIL.Approval.requestApproval(OB.MobileApp.view.$.containerWindow.getRoot().model,[{approval:'OBPOS_approval.returnService',message:'OBPOS_approval.returnService',params:[servicesToApprove]}],function(approved,supervisor,approvalType){if(approved){returnLines();}});}else{returnLines();}}}else{this.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentType);finishSetOrderType();}},getOrderType:function(){return this.get('orderType');},shouldApplyPromotions:function(){return this.get('orderType')!==1;},hasOneLineToIgnoreDiscounts:function(){return _.some(this.get('lines').models,function(line){return line.get('product').get('ignorePromotions');});},setOrderInvoice:function(){if(OB.MobileApp.model.hasPermission('OBPOS_receipt.invoice')){this.set('generateInvoice',true);this.save();}},updatePrices:function(callback){var order=this,newAllLinesCalculated;function allLinesCalculated(){callback(order);}
newAllLinesCalculated=_.after(this.get('lines').length,allLinesCalculated);this.get('lines').each(function(line){line.unset('promotions');var successCallbackPrices,criteria={};if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){criteria={'id':line.get('product').get('id')};}else{criteria={};var remoteCriteria=[];var productId={columns:['id'],operator:'equals',value:line.get('product').get('id'),isId:true};remoteCriteria.push(productId);criteria.remoteFilters=remoteCriteria;}
successCallbackPrices=function(dataPrices){dataPrices.each(function(price){order.setPrice(line,price.get('standardPrice',{setUndo:false}));});newAllLinesCalculated();};OB.Dal.find(OB.Model.Product,criteria,successCallbackPrices,function(){},line);});},createQuotation:function(){if(OB.MobileApp.model.hasPermission('OBPOS_receipt.quotation')){this.set('isQuotation',true);this.set('generateInvoice',false);this.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentTypeForQuotations);this.save();}},createOrderFromQuotation:function(updatePrices){var idMap={},me=this;this.get('lines').each(function(line){line.set('id',OB.UTIL.get_UUID());if(!this.get('priceIncludesTax')){line.set('net',line.get('nondiscountednet'));}
line.unset('nondiscountedprice');line.unset('nondiscountednet');line.unset('netFull');line.unset('grossListPrice');line.unset('grossUnitPrice');line.unset('lineGrossAmount');idMap[line.get('id')]=OB.Dal.get_uuid();line.set('id',idMap[line.get('id')]);},this);this.set('id',null);this.set('isQuotation',false);this.set('orderType',OB.MobileApp.model.get('terminal').terminalType.layawayorder?2:0);this.set('generateInvoice',OB.MobileApp.model.get('terminal').terminalType.generateInvoice);this.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentType);this.set('createdBy',OB.MobileApp.model.get('orgUserId'));if(OB.MobileApp.model.get('context').user.isSalesRepresentative){this.set('salesRepresentative',OB.MobileApp.model.get('context').user.id);}else{this.set('salesRepresentative',null);}
this.set('hasbeenpaid','N');this.set('skipApplyPromotions',false);this.set('isPaid',false);this.set('isEditable',true);this.set('orderDate',OB.I18N.normalizeDate(new Date()));this.set('creationDate',null);var nextDocumentno=OB.MobileApp.model.getNextDocumentno();this.set('documentnoPrefix',OB.MobileApp.model.get('terminal').docNoPrefix);this.set('documentnoSuffix',nextDocumentno.documentnoSuffix);this.set('quotationnoPrefix',-1);this.set('quotationnoSuffix',-1);this.set('documentNo',nextDocumentno.documentNo);this.set('posTerminal',OB.MobileApp.model.get('terminal').id);this.set('session',OB.MobileApp.model.get('session'));this.save();this.get('lines').each(function(line){if(line.get('relatedLines')){line.get('relatedLines').forEach(function(rl){rl.orderId=me.get('id');if(idMap[rl.orderlineId]){rl.orderlineId=idMap[rl.orderlineId];}});}},this);if(updatePrices){this.updatePrices(function(order){order.calculateReceipt(function(){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_QuotationCreatedOrder'));order.trigger('orderCreatedFromQuotation');});});}else{this.set('skipApplyPromotions',true);this.calculateReceipt(function(){me.unset('skipApplyPromotions');OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_QuotationCreatedOrder'));me.trigger('orderCreatedFromQuotation');});}},reactivateQuotation:function(){var nextQuotationno,idMap={},me=this;this.get('lines').each(function(line){line.set('id',OB.UTIL.get_UUID());if(!this.get('priceIncludesTax')){line.set('net',line.get('nondiscountednet'));}
line.unset('nondiscountedprice');line.unset('nondiscountednet');line.unset('netFull');line.unset('grossListPrice');line.unset('grossUnitPrice');line.unset('lineGrossAmount');idMap[line.get('id')]=OB.Dal.get_uuid();line.set('id',idMap[line.get('id')]);},this);this.set('hasbeenpaid','N');this.set('isEditable',true);this.set('createdBy',OB.MobileApp.model.get('orgUserId'));this.set('session',OB.MobileApp.model.get('session'));this.set('orderDate',OB.I18N.normalizeDate(new Date()));this.set('skipApplyPromotions',false);if(this.get('id')&&!_.isNull(this.get('id'))){this.set('oldId',this.get('id'));nextQuotationno=OB.MobileApp.model.getNextQuotationno();this.set('quotationnoPrefix',OB.MobileApp.model.get('terminal').quotationDocNoPrefix);this.set('quotationnoSuffix',nextQuotationno.quotationnoSuffix);this.set('documentNo',nextQuotationno.documentNo);}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_QuotationCannotBeReactivated_title'),OB.I18N.getLabel('OBPOS_QuotationCannotBeReactivated_body'));return;}
this.get('lines').each(function(line){if(line.get('relatedLines')){line.get('relatedLines').forEach(function(rl){rl.orderId=me.get('id');if(idMap[rl.orderlineId]){rl.orderlineId=idMap[rl.orderlineId];}});}},this);this.set('id',null);this.save();},rejectQuotation:function(rejectReasonId,scope,callback){if(!this.get('id')){OB.error("The Id of the order is not defined (current value: "+this.get('id')+"'");}
var process=new OB.DS.Process('org.openbravo.retail.posterminal.QuotationsReject');OB.UTIL.showLoading(true);process.exec({messageId:OB.UTIL.get_UUID(),data:[{orderid:this.get('id'),rejectReasonId:rejectReasonId}]},function(data){OB.UTIL.showLoading(false);OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_SuccessRejectQuotation'));if(callback){callback.call(scope,data!==null);}});},resetOrderInvoice:function(){if(OB.MobileApp.model.hasPermission('OBPOS_receipt.invoice')){this.set('generateInvoice',false);this.save();}},getPrecision:function(payment){var i,p,max;for(i=0,max=OB.MobileApp.model.get('payments').length;i<max;i++){p=OB.MobileApp.model.get('payments')[i];if(p.payment.searchKey===payment.paymenttype){if(p.obposPrecision){return p.obposPrecision;}}}},getSumOfOrigAmounts:function(paymentToIgnore){var payments=this.get('payments');var sumOfPayments=OB.DEC.Zero;if(payments&&payments.length>0){sumOfPayments=_.reduce(payments.models,function(memo,pymnt,index){if(paymentToIgnore&&(pymnt.get('kind')===paymentToIgnore.get('kind'))){return OB.DEC.add(memo,OB.DEC.Zero);}else{return OB.DEC.add(memo,pymnt.get('origAmount'));}},OB.DEC.Zero);return sumOfPayments;}else{return sumOfPayments;}},getDifferenceBetweenPaymentsAndTotal:function(paymentToIgnore){return OB.DEC.abs(OB.DEC.sub(OB.DEC.abs(this.getTotal()),this.getSumOfOrigAmounts(paymentToIgnore)));},getDifferenceRemovingSpecificPayment:function(currentPayment){var differenceInDefaultCurrency;var differenceInForeingCurrency;differenceInDefaultCurrency=this.getDifferenceBetweenPaymentsAndTotal(currentPayment);if(currentPayment&&currentPayment.get('rate')){differenceInForeingCurrency=OB.DEC.div(differenceInDefaultCurrency,currentPayment.get('rate'));return differenceInForeingCurrency;}else{return differenceInDefaultCurrency;}},adjustPayment:function(){var i,max,p;var payments=this.get('payments');var total=OB.DEC.abs(this.getTotal());var nocash=OB.DEC.Zero;var cash=OB.DEC.Zero;var origCash=OB.DEC.Zero;var auxCash=OB.DEC.Zero;var prevCash=OB.DEC.Zero;var paidCash=OB.DEC.Zero;var pcash;var precision;var multiCurrencyDifference;for(i=0,max=payments.length;i<max;i++){p=payments.at(i);precision=this.getPrecision(p);if(p.get('rate')&&p.get('rate')!=='1'){p.set('origAmount',OB.DEC.mul(p.get('amount'),p.get('rate')));if(OB.DEC.compare(OB.DEC.sub(this.getDifferenceRemovingSpecificPayment(p),OB.DEC.abs(p.get('amount'))))===OB.DEC.Zero){multiCurrencyDifference=this.getDifferenceBetweenPaymentsAndTotal(p);if(p.get('origAmount')!==multiCurrencyDifference){p.set('origAmount',multiCurrencyDifference);}}}else{p.set('origAmount',p.get('amount'));}
p.set('paid',p.get('origAmount'));if(p.get('kind')===OB.MobileApp.model.get('paymentcash')){cash=OB.DEC.add(cash,p.get('origAmount'));pcash=p;paidCash=OB.DEC.add(paidCash,p.get('origAmount'));}else if(OB.MobileApp.model.hasPayment(p.get('kind'))&&OB.MobileApp.model.hasPayment(p.get('kind')).paymentMethod.iscash){origCash=OB.DEC.add(origCash,p.get('origAmount'));pcash=p;paidCash=OB.DEC.add(paidCash,p.get('origAmount'));}else{nocash=OB.DEC.add(nocash,p.get('origAmount'));}}
if(pcash){if(pcash.get('kind')!==OB.MobileApp.model.get('paymentcash')){auxCash=origCash;prevCash=cash;}else{auxCash=cash;prevCash=origCash;}
if(OB.DEC.compare(nocash-total)>0){pcash.set('paid',OB.DEC.Zero);this.set('payment',nocash);this.set('change',OB.DEC.add(cash,origCash));}else if(OB.DEC.compare(OB.DEC.sub(OB.DEC.add(OB.DEC.add(nocash,cash),origCash),total))>0){pcash.set('paid',OB.DEC.sub(total,OB.DEC.add(nocash,OB.DEC.sub(paidCash,pcash.get('origAmount')))));this.set('payment',total);this.set('change',OB.DEC.sub(OB.DEC.add(OB.DEC.add(nocash,cash,precision),origCash,precision),OB.Utilities.Number.roundJSNumber(total,2),precision));}else{pcash.set('paid',auxCash);this.set('payment',OB.DEC.add(OB.DEC.add(nocash,cash),origCash));this.set('change',OB.DEC.Zero);}}else{if(payments.length>0){if(this.get('payment')===0||nocash>0){this.set('payment',nocash);}}else{this.set('payment',OB.DEC.Zero);}
this.set('change',OB.DEC.Zero);}},addPayment:function(payment){var payments,total;var i,max,p,order;if(!OB.DEC.isNumber(payment.get('amount'))){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_MsgPaymentAmountError'));return;}
if(this.stopAddingPayments){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_CannotAddPayments'));return;}
order=this;if(order.get('orderType')===3&&order.getGross()===0){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_MsgVoidLayawayPaymentError'));return;}
payments=this.get('payments');total=OB.DEC.abs(this.getTotal());OB.UTIL.HookManager.executeHooks('OBPOS_preAddPayment',{paymentToAdd:payment,payments:payments,receipt:this},function(){if(!payment.get('paymentData')){for(i=0,max=payments.length;i<max;i++){p=payments.at(i);if(p.get('kind')===payment.get('kind')&&!p.get('isPrePayment')){p.set('amount',OB.DEC.add(payment.get('amount'),p.get('amount')));if(p.get('rate')&&p.get('rate')!=='1'){p.set('origAmount',OB.DEC.add(payment.get('origAmount'),OB.DEC.mul(p.get('origAmount'),p.get('rate'))));}
order.adjustPayment();order.trigger('displayTotal');return;}}}else{for(i=0,max=payments.length;i<max;i++){p=payments.at(i);if(p.get('kind')===payment.get('kind')&&p.get('paymentData')&&payment.get('paymentData')&&p.get('paymentData').groupingCriteria&&payment.get('paymentData').groupingCriteria&&p.get('paymentData').groupingCriteria===payment.get('paymentData').groupingCriteria){p.set('amount',OB.DEC.add(payment.get('amount'),p.get('amount')));if(p.get('rate')&&p.get('rate')!=='1'){p.set('origAmount',OB.DEC.add(payment.get('origAmount'),OB.DEC.mul(p.get('origAmount'),p.get('rate'))));}
payment.set('date',new Date());order.adjustPayment();order.trigger('displayTotal');return;}}}
if(payment.get('openDrawer')&&(payment.get('allowOpenDrawer')||payment.get('isCash'))){order.set('openDrawer',payment.get('openDrawer'));}
payment.set('date',new Date());payment.set('id',OB.UTIL.get_UUID());payments.add(payment);order.adjustPayment();order.trigger('displayTotal');order.save();});},overpaymentExists:function(){return this.getPaymentStatus().overpayment?true:false;},removePayment:function(payment){var payments=this.get('payments');OB.UTIL.HookManager.executeHooks('OBPOS_preRemovePayment',{paymentToRem:payment,payments:payments,receipt:this},function(args){if(args.cancellation){return true;}
payments.remove(payment);if(payment.get('openDrawer')){args.receipt.set('openDrawer',false);}
args.receipt.adjustPayment();args.receipt.save();});},serializeToJSON:function(){var jsonorder=JSON.parse(JSON.stringify(this.toJSON()));delete jsonorder.undo;delete jsonorder.json;_.forEach(jsonorder.lines,function(item){delete item.product.img;delete item.product._filter;});return jsonorder;},changeSignToShowReturns:function(){this.set('change',OB.DEC.mul(this.get('change'),-1));this.set('gross',OB.DEC.mul(this.get('gross'),-1));this.set('net',OB.DEC.mul(this.get('net'),-1));this.set('qty',OB.DEC.mul(this.get('qty'),-1));_.each(this.get('lines').models,function(line){line.set('gross',OB.DEC.mul(line.get('gross'),-1));line.set('qty',OB.DEC.mul(line.get('qty'),-1));},this);_.each(this.get('payments').models,function(payment){payment.set('amount',OB.DEC.mul(payment.get('amount'),-1));payment.set('origAmount',OB.DEC.mul(payment.get('origAmount'),-1));},this);_.each(this.get('taxes'),function(tax){tax.amount=OB.DEC.mul(tax.amount,-1);tax.gross=OB.DEC.mul(tax.gross,-1);tax.net=OB.DEC.mul(tax.net,-1);},this);},setProperty:function(_property,_value){this.set(_property,_value);this.save();},groupLinesByProduct:function(){var lineToMerge,lines=this.get('lines'),auxLines=lines.models.slice(0),localSkipApplyPromotions;localSkipApplyPromotions=this.get('skipApplyPromotions');this.set({'skipApplyPromotions':true},{silent:true});_.each(auxLines,function(l){lineToMerge=_.find(lines.models,function(line){if(l!==line&&l.get('product').id===line.get('product').id&&l.get('price')===line.get('price')&&line.get('qty')>0&&l.get('qty')>0&&!_.find(line.get('promotions'),function(promo){return promo.manual;})&&!_.find(l.get('promotions'),function(promo){return promo.manual;})){return line;}});if(lineToMerge){lineToMerge.set({qty:lineToMerge.get('qty')+l.get('qty')},{silent:true});lines.remove(l);}});this.set({'skipApplyPromotions':localSkipApplyPromotions},{silent:true});},fillPromotionsWith:function(groupedOrder,isFirstTime){var me=this,copiedPromo,linesToMerge,auxPromo,idx,actProm,linesToCreate=[],qtyToReduce,lineToEdit,lineProm,linesToReduce,linesCreated=false,localSkipApplyPromotions;localSkipApplyPromotions=this.get('skipApplyPromotions');this.set({'skipApplyPromotions':true},{silent:true});groupedOrder.get('lines').forEach(function(l){_.each(l.get('promotions'),function(promo){promo.pendingQtyOffer=promo.qtyOffer;});if(_.find(l.get('promotions'),function(promo){return promo.doNotMerge;})){lineToEdit=_.find(me.get('lines').models,function(line){if(l!==line&&l.get('product').id===line.get('product').id&&l.get('price')===line.get('price')&&line.get('qty')===l.get('qty')&&!_.find(line.get('promotions'),function(promo){return promo.manual;})&&!_.find(line.get('promotions'),function(promo){return promo.doNotMerge;})){return line;}});if(!lineToEdit){lineToEdit=_.find(me.get('lines').models,function(line){if(l!==line&&l.get('product').id===line.get('product').id&&l.get('price')===line.get('price')&&line.get('qty')>0&&!_.find(line.get('promotions'),function(promo){return promo.manual;})){return line;}});}
lineToEdit.set('noDiscountCandidates',l.get('noDiscountCandidates'),{silent:true});if(lineToEdit.get('qty')>l.get('qty')){linesToCreate.push({product:lineToEdit.get('product'),qty:l.get('qty'),attrs:{promotions:l.get('promotions'),promotionCandidates:l.get('promotionCandidates'),qtyToApplyDiscount:l.get('qtyToApplyDiscount')}});lineToEdit.set('qty',OB.DEC.sub(lineToEdit.get('qty'),l.get('qty')),{silent:true});}else if(lineToEdit.get('qty')<l.get('qty')){qtyToReduce=OB.DEC.sub(l.get('qty'),lineToEdit.get('qty'));linesToReduce=_.filter(me.get('lines').models,function(line){if(l!==line&&l.get('product').id===line.get('product').id&&l.get('price')===line.get('price')&&line.get('qty')>0&&!_.find(line.get('promotions'),function(promo){return promo.manual||promo.doNotMerge;})){return line;}});lineProm=linesToReduce.shift();lineProm.set('qty',l.get('qty'));lineProm.set('promotions',l.get('promotions'));lineProm.set('promotionCandidates',l.get('promotionCandidates'));lineProm.set('qtyToApplyDiscount',l.get('qtyToApplyDiscount'));lineProm.trigger('change');_.each(linesToReduce,function(line){if(line.get('qty')>qtyToReduce){line.set({qty:line.get('qty')-qtyToReduce},{silent:true});qtyToReduce=OB.DEC.Zero;}else if(line.get('qty')===qtyToReduce){me.get('lines').remove(line);qtyToReduce=OB.DEC.Zero;}else{qtyToReduce=qtyToReduce-line.get('qty');me.get('lines').remove(line);}});}else{lineToEdit.set('qty',l.get('qty'));lineToEdit.set('promotions',l.get('promotions'));lineToEdit.set('promotionCandidates',l.get('promotionCandidates'));lineToEdit.set('qtyToApplyDiscount',l.get('qtyToApplyDiscount'));lineToEdit.trigger('change');}}else{linesToMerge=_.filter(me.get('lines').models,function(line){var qtyReserved=0;var promotions=line.get('promotions')||[];if(promotions.length>0){promotions.forEach(function(p){qtyReserved=OB.DEC.add(qtyReserved,p.qtyOfferReserved||0);});}
if(l!==line&&l.get('product').id===line.get('product').id&&l.get('price')===line.get('price')&&OB.UTIL.Math.sign(line.get('qty'))===OB.UTIL.Math.sign(l.get('qty'))){if(OB.DEC.sub(Math.abs(line.get('qty')),qtyReserved)>0){var isManualOrNotMerge=_.find(line.get('promotions'),function(promo){return promo.manual||promo.doNotMerge;});if(!isManualOrNotMerge){return line;}}}});linesToMerge=_.sortBy(linesToMerge,function(lsb){lsb.getQty();});if(linesToMerge.length>0){_.each(linesToMerge,function(line){line.set({promotionCandidates:l.get('promotionCandidates'),promotionMessages:me.showMessagesPromotions(line.get('promotionMessages'),l.get('promotionMessages')),qtyToApplyDiscount:l.get('qtyToApplyDiscount'),noDiscountCandidates:l.get('noDiscountCandidates')},{silent:true});_.each(l.get('promotions'),function(promo){copiedPromo=JSON.parse(JSON.stringify(promo));promo.distributedAmt=promo.distributedAmt?promo.distributedAmt:OB.DEC.Zero;promo.pendingQtyOffer=!_.isUndefined(promo.pendingQtyOffer)?promo.pendingQtyOffer:promo.qtyOffer;if(promo.pendingQtyOffer&&promo.pendingQtyOffer>=line.get('qty')){if(_.isUndefined(promo.actualAmt)){if(promo.pendingQtyOffer!==promo.qtyOffer){copiedPromo.hidden=true;copiedPromo.amt=OB.DEC.Zero;}}else{copiedPromo.actualAmt=(promo.fullAmt/promo.qtyOffer)*line.get('qty');copiedPromo.amt=(promo.fullAmt/promo.qtyOffer)*line.get('qty');copiedPromo.obdiscQtyoffer=line.get('qty');promo.distributedAmt=OB.DEC.add(promo.distributedAmt,OB.DEC.toNumber(OB.DEC.toBigDecimal((promo.fullAmt/promo.qtyOffer)*line.get('qty'))));}
if(promo.pendingQtyOffer===line.get('qty')){if(!_.isUndefined(promo.actualAmt)&&promo.actualAmt&&promo.actualAmt!==promo.distributedAmt){copiedPromo.actualAmt=OB.DEC.add(copiedPromo.actualAmt,OB.DEC.sub(promo.actualAmt,promo.distributedAmt));copiedPromo.amt=promo.amt?OB.DEC.add(copiedPromo.amt,OB.DEC.sub(promo.amt,promo.distributedAmt)):promo.amt;}
promo.pendingQtyOffer=null;}else{promo.pendingQtyOffer=promo.pendingQtyOffer-line.get('qty');}
if(line.get('promotions')){auxPromo=_.find(line.get('promotions'),function(promo){return promo.ruleId===copiedPromo.ruleId;});if(auxPromo){idx=line.get('promotions').indexOf(auxPromo);line.get('promotions').splice(idx,1,copiedPromo);}else{line.get('promotions').push(copiedPromo);}}else{line.set('promotions',[copiedPromo]);}}else if(promo.pendingQtyOffer){if(_.isUndefined(promo.actualAmt)){if(promo.pendingQtyOffer!==promo.qtyOffer){copiedPromo.hidden=true;copiedPromo.amt=OB.DEC.Zero;}}else{copiedPromo.actualAmt=(promo.fullAmt/promo.qtyOffer)*promo.pendingQtyOffer;copiedPromo.amt=(promo.fullAmt/promo.qtyOffer)*promo.pendingQtyOffer;copiedPromo.obdiscQtyoffer=promo.pendingQtyOffer;promo.distributedAmt=OB.DEC.add(promo.distributedAmt,OB.DEC.toNumber(OB.DEC.toBigDecimal((promo.fullAmt/promo.qtyOffer)*promo.pendingQtyOffer)));}
if(!_.isUndefined(promo.actualAmt)&&promo.actualAmt&&promo.actualAmt!==promo.distributedAmt){copiedPromo.actualAmt=OB.DEC.add(copiedPromo.actualAmt,OB.DEC.sub(promo.actualAmt,promo.distributedAmt));copiedPromo.amt=promo.amt?OB.DEC.add(copiedPromo.amt,OB.DEC.sub(promo.amt,promo.distributedAmt)):promo.amt;}
if(line.get('promotions')){auxPromo=_.find(line.get('promotions'),function(promo){return promo.ruleId===copiedPromo.ruleId&&promo.preserve!==true;});if(auxPromo){idx=line.get('promotions').indexOf(auxPromo);line.get('promotions').splice(idx,1,copiedPromo);}else{line.get('promotions').push(copiedPromo);}}else{line.set('promotions',[copiedPromo]);}
promo.pendingQtyOffer=null;}else if(isFirstTime){actProm=_.find(line.get('promotions'),function(prom){return prom.ruleId===promo.ruleId;});if(actProm){idx=line.get('promotions').indexOf(actProm);if(idx>-1){line.get('promotions').splice(idx,1);}}}});line.trigger('change');});}}});if(!linesCreated){_.each(linesToCreate,function(line){me.createLine(line.product,line.qty,null,line.attrs);});linesCreated=true;}
this.set({'skipApplyPromotions':localSkipApplyPromotions},{silent:true});this.trigger('promotionsUpdated');},removeQtyOffer:function(){var linesPending=new Backbone.Collection();this.get('lines').forEach(function(l){var promotionsApplyNext=[],promotionsCascadeApplied=[],qtyReserved=0,qtyPending;if(l.get('promotions')){promotionsApplyNext=[];promotionsCascadeApplied=[];l.get('promotions').forEach(function(p){if(p.qtyOfferReserved>0){qtyReserved=OB.DEC.add(qtyReserved,p.qtyOfferReserved);}
if(p.applyNext){promotionsApplyNext.push(p);promotionsCascadeApplied.push(p);}});}
qtyPending=OB.DEC.sub(l.get('qty'),qtyReserved);l.set('qty',qtyPending);l.set('promotions',promotionsApplyNext);l.set('promotionsCascadeApplied',promotionsCascadeApplied);});_.each(this.get('lines').models,function(line){if(line.get('qty')>0){linesPending.add(line);}});this.get('lines').reset(linesPending.models);},removeLinesWithoutPromotions:function(){var linesPending=new Backbone.Collection();_.each(this.get('lines').models,function(l){if(l.get('promotions')&&l.get('promotions').length>0){linesPending.push(l);}});this.set('lines',linesPending);},hasPromotions:function(){var hasPromotions=false;this.get('lines').forEach(function(l){if(l.get('promotions')&&l.get('promotions').length>0){hasPromotions=true;}});return hasPromotions;},isSimilarLine:function(line1,line2){var equalPromotions=function(x,y){var isEqual=true;if(x.length!==y.length){isEqual=false;}else{x.forEach(function(p1,ind){if(p1.amt!==y[ind].amt||p1.displayedTotalAmount!==y[ind].displayedTotalAmount||p1.qtyOffer!==y[ind].qtyOffer||p1.qtyOfferReserved!==y[ind].qtyOfferReserved||p1.ruleId!==y[ind].ruleId||p1.obdiscQtyoffer!==y[ind].obdiscQtyoffer){isEqual=false;}});}
return isEqual;};if(line1.get('product').get('id')===line2.get('product').get('id')&&line1.get('price')===line2.get('price')&&line1.get('discountedLinePrice')===line2.get('discountedLinePrice')&&line1.get('qty')===line2.get('qty')){return equalPromotions(line1.get('promotions')||[],line2.get('promotions')||[]);}else{return false;}},removePromotionsCascadeApplied:function(){this.get('lines').forEach(function(l){if(!OB.UTIL.isNullOrUndefined(l.get('promotions'))&&l.get('promotions').length>0&&!OB.UTIL.isNullOrUndefined(l.get('promotionsCascadeApplied'))&&l.get('promotionsCascadeApplied').length>0){l.get('promotions').forEach(function(p,ind){l.get('promotionsCascadeApplied').forEach(function(pc){if(p.ruleId===pc.ruleId){l.get('promotions')[ind]=pc;}});});}});},showMessagesPromotions:function(arrayMessages1,arrayMessages2){arrayMessages1=arrayMessages1||[];(arrayMessages2||[]).forEach(function(m2){if(_.filter(arrayMessages1,function(m1){return m1===m2;}).length===0){arrayMessages1.push(m2);OB.UTIL.showAlert.display(m2);}});return arrayMessages1;},getOrderDescription:function(){var desc="{id: '"+this.get('id')+"', Docno: '"+this.get('documentNo')+"', Total gross: '"+this.get('gross')+"', Lines: ['";var i=0;var propt;this.get('lines').forEach(function(l){if(i!==0){desc+=",";}
desc+="'{Product: '"+l.get('product').get('_identifier')+"', Quantity: '"+l.get('qty')+"', Gross: '"+l.get('gross')+"', LineGrossAmount: '"+l.get('lineGrossAmount')+"', DiscountedGross: '"+l.get('discountedGross')+"', Net: '"+l.get('net')+"', DiscountedNet: '"+l.get('discountedNet')+"', NonDiscountedNet: '"+l.get('nondiscountednet')+"', TaxAmount: '"+l.get('taxAmount')+"', GrossUnitPrice: '"+l.get('grossUnitPrice')+"'}";i++;});desc+="], Payments: [";i=0;this.get('payments').forEach(function(l){if(i!==0){desc+=",";}
desc+="{PaymentMethod: '"+l.get('kind')+"', Amount: '"+l.get('amount')+"', OrigAmount: '"+l.get('origAmount')+"', Date: '"+l.get('date')+"', isocode: '"+l.get('isocode')+"'}";i++;});desc+="], Taxes: [";i=0;for(propt in this.get('taxes')){if(this.get('taxes').hasOwnProperty(propt)){var obj=this.get('taxes')[propt];if(i!==0){desc+=",";}
desc+="{TaxId: '"+propt+"', TaxRate: '"+obj.rate+"', TaxNet: '"+obj.net+"', TaxAmount: '"+obj.amount+"', TaxName: '"+obj.name+"'}";i++;}}
desc+="]";desc+="}";return desc;},canAddAsServices:function(model,product,callback,scope){if(product.get('productType')==='S'){if(!OB.UTIL.isNullOrUndefined(product.get('allowDeferredSell'))&&product.get('allowDeferredSell')){if(!OB.UTIL.isNullOrUndefined(product.get('deferredSellMaxDays'))){var oneDay=24*60*60*1000,today=new Date(),orderDate=new Date(this.get('orderDate'));today.setHours(0,0,0,0);orderDate.setHours(0,0,0,0);var diffDays=Math.round(OB.DEC.abs(today.getTime()-orderDate.getTime())/oneDay);if(diffDays>product.get('deferredSellMaxDays')){OB.UTIL.Approval.requestApproval(model,[{approval:'OBPOS_approval.deferred_sell_max_days',message:'OBPOS_approval.deferred_sell_max_days',params:[product.get('deferredSellMaxDays')]}],function(approved,supervisor,approvalType){callback.call(scope,approved?'OK':'NOT_ALLOW_MAX_DAYS');});}else{callback.call(scope,'OK');}}else{callback.call(scope,'OK');}}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_msgDeferredSellCaption'),OB.I18N.getLabel('OBPOS_msgNotDeferredSell'),[{label:OB.I18N.getLabel('OBMOBC_LblOk')}]);callback.call(scope,'NOT_ALLOW');}}else{callback.call(scope,'ABORT');}},getOrderlLineIndex:function(orderlineId){var index=0;this.get('lines').forEach(function(line,indx){if(line.id===orderlineId){index=indx;}});return index;}});var OrderList=Backbone.Collection.extend({model:Order,constructor:function(modelOrder){if(modelOrder){this.modelorder=modelOrder;}
Backbone.Collection.prototype.constructor.call(this);},initialize:function(){var me=this;this.current=null;if(this.modelorder){this.modelorder.on('saveCurrent',function(){me.saveCurrent();});}},newOrder:function(bp){var order=new Order(),receiptProperties,i,p;bp=bp?bp:OB.MobileApp.model.get('businessPartner');if(OB.MobileApp.view.$.containerWindow&&OB.MobileApp.view.$.containerWindow.getRoot()&&OB.MobileApp.view.$.containerWindow.getRoot().$.receiptPropertiesDialog){receiptProperties=OB.MobileApp.view.$.containerWindow.getRoot().$.receiptPropertiesDialog.newAttributes;for(i=0;i<receiptProperties.length;i++){if(receiptProperties[i].modelProperty){order.set(receiptProperties[i].modelProperty,'');}
if(receiptProperties[i].extraProperties){for(p=0;p<receiptProperties[i].extraProperties.length;p++){order.set(receiptProperties[i].extraProperties[p],'');}}}}
order.set('client',OB.MobileApp.model.get('terminal').client);order.set('organization',OB.MobileApp.model.get('terminal').organization);order.set('createdBy',OB.MobileApp.model.get('orgUserId'));order.set('updatedBy',OB.MobileApp.model.get('orgUserId'));order.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentType);order.set('orderType',OB.MobileApp.model.get('terminal').terminalType.layawayorder?2:0);order.set('generateInvoice',false);order.set('isQuotation',false);order.set('oldId',null);order.set('session',OB.MobileApp.model.get('session'));order.set('bp',bp);if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)){order.set('priceList',bp.get('priceList'));var priceIncludesTax=bp.get('priceIncludesTax');if(OB.UTIL.isNullOrUndefined(priceIncludesTax)){priceIncludesTax=OB.MobileApp.model.get('pricelist').priceIncludesTax;}
order.set('priceIncludesTax',priceIncludesTax);}else{order.set('priceList',OB.MobileApp.model.get('terminal').priceList);order.set('priceIncludesTax',OB.MobileApp.model.get('pricelist').priceIncludesTax);}
if(OB.MobileApp.model.hasPermission('OBPOS_receipt.invoice')){if(OB.MobileApp.model.hasPermission('OBPOS_retail.restricttaxidinvoice',true)&&!bp.get('taxID')){if(OB.MobileApp.model.get('terminal').terminalType.generateInvoice){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_BP_No_Taxid'));}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_BP_No_Taxid'));}
order.set('generateInvoice',false);}else{order.set('generateInvoice',OB.MobileApp.model.get('terminal').terminalType.generateInvoice);}}else{order.set('generateInvoice',false);}
order.set('currency',OB.MobileApp.model.get('terminal').currency);order.set('currency'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,OB.MobileApp.model.get('terminal')['currency'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER]);order.set('warehouse',OB.MobileApp.model.get('terminal').warehouse);if(OB.MobileApp.model.get('context').user.isSalesRepresentative){order.set('salesRepresentative',OB.MobileApp.model.get('context').user.id);order.set('salesRepresentative'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,OB.MobileApp.model.get('context').user._identifier);}else{order.set('salesRepresentative',null);order.set('salesRepresentative'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,null);}
order.set('posTerminal',OB.MobileApp.model.get('terminal').id);order.set('posTerminal'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,OB.MobileApp.model.get('terminal')._identifier);order.set('orderDate',OB.I18N.normalizeDate(new Date()));order.set('creationDate',null);order.set('isPaid',false);order.set('paidOnCredit',false);order.set('isLayaway',false);order.set('taxes',{});var nextDocumentno=OB.MobileApp.model.getNextDocumentno();order.set('documentnoPrefix',OB.MobileApp.model.get('terminal').docNoPrefix);order.set('documentnoSuffix',nextDocumentno.documentnoSuffix);order.set('documentNo',nextDocumentno.documentNo);order.set('print',true);order.set('sendEmail',false);order.set('openDrawer',false);return order;},newPaidReceipt:function(model,callback){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('newPaidReceipt');enyo.$.scrim.show();var order=new Order(),lines,newline,payments,curPayment,taxes,bpId,bpLocId,bpLoc,numberOfLines=model.receiptLines.length,orderQty=0,NoFoundProduct=true,NoFoundCustomer=true,isLoadedPartiallyFromBackend=false;_.each(OB.Model.modelLoaders,function(f){f(model);});lines=new Backbone.Collection();order.set(model);order.set('isbeingprocessed','N');order.set('hasbeenpaid','Y');order.set('isEditable',false);order.set('checked',model.checked);order.set('orderDate',OB.I18N.normalizeDate(model.orderDate));order.set('creationDate',OB.I18N.normalizeDate(model.creationDate));order.set('paidOnCredit',false);order.set('skipApplyPromotions',true);if(model.isQuotation){order.set('isQuotation',true);order.set('oldId',model.orderid);order.set('id',null);order.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentTypeForQuotations);}
if(model.isLayaway){order.set('isLayaway',true);order.set('id',model.orderid);order.set('createdBy',OB.MobileApp.model.usermodel.id);order.set('hasbeenpaid','N');order.set('session',OB.MobileApp.model.get('session'));}else{order.set('isPaid',true);if(model.receiptPayments.length===0&&model.totalamount>0&&!model.isQuotation){order.set('paidOnCredit',true);}
order.set('id',model.orderid);if(order.get('documentType')===OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns){order.set('orderType',1);}}
bpLocId=model.bpLocId;bpId=model.bp;var bpartnerForProduct=function(bp){var locationForBpartner=function(bpLoc){bp.set('locName',bpLoc.get('name'));bp.set('locId',bpLoc.get('id'));bp.set('locationModel',bpLoc);order.set('bp',bp);order.set('gross',model.totalamount);order.set('net',model.totalNetAmount);var linepos=0;_.each(model.receiptLines,function(iter){var price;iter.linepos=linepos;var addLineForProduct=function(prod){if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){OB.Dal.saveTemporally(prod,function(){},function(){OB.error(arguments);},true);}
order._loadRelatedServices(prod.get('productType'),prod.get('id'),prod.get('productCategory'),function(data){var hasservices;if(!OB.UTIL.isNullOrUndefined(data)&&OB.DEC.number(iter.quantity)>0){hasservices=data.hasservices;}
newline=new OrderLine({id:iter.lineId,product:prod,uOM:iter.uOM,qty:OB.DEC.number(iter.quantity),price:price,priceList:prod.get('listPrice'),promotions:iter.promotions,description:iter.description,priceIncludesTax:order.get('priceIncludesTax'),hasRelatedServices:hasservices,warehouse:{id:iter.warehouse,warehousename:iter.warehousename},relatedLines:iter.relatedLines});_.each(iter,function(value,key){if(!newline.ownProperties[key]){newline.set(key,value);}});lines.add(newline,{at:iter.linepos});numberOfLines--;orderQty=OB.DEC.add(iter.quantity,orderQty);if(numberOfLines===0){order.set('lines',lines);order.set('qty',orderQty);order.set('json',JSON.stringify(order.toJSON()));callback(order);enyo.$.scrim.hide();OB.UTIL.SynchronizationHelper.finished(synchId,'newPaidReceipt');}});};if(order.get('priceIncludesTax')){price=OB.DEC.number(iter.unitPrice);}else{price=OB.DEC.number(iter.baseNetUnitPrice);}
OB.Dal.get(OB.Model.Product,iter.id,function(product){addLineForProduct(product);},null,function(){new OB.DS.Request('org.openbravo.retail.posterminal.master.LoadedProduct').exec({productId:iter.id},function(data){addLineForProduct(OB.Dal.transform(OB.Model.Product,data[0]));},function(){if(NoFoundProduct){NoFoundProduct=false;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_InformationTitle'),OB.I18N.getLabel('OBPOS_NoReceiptLoadedText'),[{label:OB.I18N.getLabel('OBPOS_LblOk'),isConfirmButton:true}]);}});});linepos++;});payments=new PaymentLineList();_.each(model.receiptPayments,function(iter){var paymentProp;curPayment=new PaymentLine();for(paymentProp in iter){if(iter.hasOwnProperty(paymentProp)){if(paymentProp==="paymentDate"){if(!OB.UTIL.isNullOrUndefined(iter[paymentProp])&&moment(iter[paymentProp]).isValid()){curPayment.set(paymentProp,new Date(iter[paymentProp]));}else{curPayment.set(paymentProp,null);}}else{curPayment.set(paymentProp,iter[paymentProp]);}}}
payments.add(curPayment);});order.set('payments',payments);order.adjustPayment();taxes={};_.each(model.receiptTaxes,function(iter){var taxProp;taxes[iter.taxid]={};for(taxProp in iter){if(iter.hasOwnProperty(taxProp)){taxes[iter.taxid][taxProp]=iter[taxProp];}}});order.set('taxes',taxes);if(!model.isLayaway&&!model.isQuotation){if(model.totalamount>0&&order.get('payment')<model.totalamount){order.set('paidOnCredit',true);}else if(model.totalamount<0&&(order.get('payment')===0||(order.get('payment')>model.totalamount))){order.set('paidOnCredit',true);}}};if(isLoadedPartiallyFromBackend){locationForBpartner(bpLoc);}else{OB.Dal.get(OB.Model.BPLocation,bpLocId,function(bpLoc){locationForBpartner(bpLoc);},function(){});}};OB.Dal.get(OB.Model.BusinessPartner,bpId,function(bp){bpartnerForProduct(bp);},null,function(){new OB.DS.Request('org.openbravo.retail.posterminal.master.LoadedCustomer').exec({bpartnerId:bpId,bpLocationId:bpLocId},function(data){isLoadedPartiallyFromBackend=true;bpLoc=OB.Dal.transform(OB.Model.BPLocation,data[1]);bpartnerForProduct(OB.Dal.transform(OB.Model.BusinessPartner,data[0]));},function(){if(NoFoundCustomer){NoFoundCustomer=false;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_InformationTitle'),OB.I18N.getLabel('OBPOS_NoReceiptLoadedText'),[{label:OB.I18N.getLabel('OBPOS_LblOk'),isConfirmButton:true}]);}});});},newDynamicOrder:function(model,callback){var order=new OB.Model.Order(),undf;_.each(_.keys(model),function(key){if(model[key]!==undf){if(model[key]===null){order.set(key,null);}else{order.set(key,model[key]);}}});callback(order);},addNewOrder:function(isFirstOrder){var me=this;if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){if(isFirstOrder){this.doCleanBPSettings(function(){me.doRemoteBPSettings(OB.MobileApp.model.get('businessPartner'));});}else{me.doRemoteBPSettings(OB.MobileApp.model.get('businessPartner'));}}
this.saveCurrent();this.current=this.newOrder();this.unshift(this.current);this.loadCurrent(true);},addThisOrder:function(model){this.saveCurrent();this.current=model;this.unshift(this.current);this.loadCurrent();},addFirstOrder:function(){this.addNewOrder(true);},addPaidReceipt:function(model){var synchId=null;enyo.$.scrim.show();if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){this.doRemoteBPSettings(model.get('bp'));}else{OB.UTIL.showLoading(false);}
this.saveCurrent();this.current=model;this.unshift(this.current);this.loadCurrent(true);if(model.get('isLayaway')){synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('addPaidReceipt');OB.Dal.save(model,function(){enyo.$.scrim.hide();OB.UTIL.SynchronizationHelper.finished(synchId,'addPaidReceipt');},function(){OB.error(arguments);},true);}},addMultiReceipt:function(model){OB.Dal.save(model,function(){},function(){OB.error(arguments);},model.get('isLayaway'));},doCleanBPSettings:function(callback){OB.Dal.removeAllTemporally(OB.Model.BusinessPartner,null,function(){OB.Dal.removeAllTemporally(OB.Model.BPLocation,null,function(){if(OB.MobileApp.model.hasPermission('OBPOS_remote.discount.bp',true)){OB.Dal.removeAllTemporally(OB.Model.DiscountFilterBusinessPartner,null,function(){if(callback){callback();}},function(){OB.error(arguments);},true);}else{if(callback){callback();}}},function(){OB.error(arguments);},true);},function(){OB.error(arguments);},true);},doRemoteBPSettings:function(businessPartner){OB.Dal.saveTemporally(businessPartner,function(){},function(){OB.error(arguments);},true);OB.Dal.saveTemporally(businessPartner.get('locationModel'),function(){},function(){OB.error(arguments);},true);if(OB.MobileApp.model.hasPermission('OBPOS_remote.discount.bp',true)){var bp={columns:['businessPartner'],operator:'equals',value:businessPartner.id,isId:true};var remoteCriteria=[bp];var criteria={};criteria.remoteFilters=remoteCriteria;OB.Dal.find(OB.Model.DiscountFilterBusinessPartner,criteria,function(discountsBP){_.each(discountsBP.models,function(dsc){OB.Dal.saveTemporally(dsc,function(){},function(){OB.error(arguments);},true);});OB.UTIL.showLoading(false);},function(){OB.error(arguments);});}else{OB.UTIL.showLoading(false);}},addNewQuotation:function(){this.saveCurrent();this.current=this.newOrder();this.current.set('isQuotation',true);this.current.set('generateInvoice',false);this.current.set('orderType',0);this.current.set('documentType',OB.MobileApp.model.get('terminal').terminalType.documentTypeForQuotations);var nextQuotationno=OB.MobileApp.model.getNextQuotationno();this.current.set('quotationnoPrefix',OB.MobileApp.model.get('terminal').quotationDocNoPrefix);this.current.set('quotationnoSuffix',nextQuotationno.quotationnoSuffix);this.current.set('documentNo',nextQuotationno.documentNo);this.unshift(this.current);this.loadCurrent();},deleteCurrentFromDatabase:function(orderToDelete){OB.Dal.remove(orderToDelete,function(){return true;},function(){OB.UTIL.showError('Error removing');});},deleteCurrent:function(forceCreateNew){var i,max,me=this,successCallback=function(){return true;},errorCallback=function(){OB.UTIL.showError('Error removing');};if(!this.current){return;}
function finishDeleteCurrent(){me.remove(me.current);var createNew=forceCreateNew||me.length===0;if(createNew){var order=me.newOrder();me.add(order);if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){me.doRemoteBPSettings(OB.MobileApp.model.get('businessPartner'));}}
me.current=me.at(0);me.loadCurrent(createNew);}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){for(i=0,max=this.current.get('lines').length;i<this.current.get('lines').length;i++){var p=this.current.get('lines').models[i].get('product');OB.Dal.removeTemporally(p,successCallback,errorCallback);}}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){OB.Dal.removeTemporally(new OB.Model.BusinessPartner(this.current.get('bp')),successCallback,errorCallback);if(this.current.get('bp').get('locationModel')){OB.Dal.removeTemporally(this.current.get('bp').get('locationModel'),successCallback,errorCallback);}}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.discount.bp',true)){var oldbpfilter={columns:['businessPartner'],operator:'equals',value:this.current.get('bp').id,isId:true};var oldRemoteCriteria=[oldbpfilter];var criteria={};criteria.remoteFilters=oldRemoteCriteria;OB.Dal.find(OB.Model.DiscountFilterBusinessPartner,criteria,function(discountsBP){_.each(discountsBP.models,function(dsc){OB.Dal.removeTemporally(dsc,function(){},function(){OB.error(arguments);},true);});},function(){OB.error(arguments);});}
if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)&&!this.current.get('isQuotation')&&OB.MobileApp.model.receipt.id===this.current.id&&this.current.get('lines').length===0&&(this.current.get('documentnoSuffix')<=OB.MobileApp.model.documentnoThreshold||OB.MobileApp.model.documentnoThreshold===0)){OB.MobileApp.model.receipt.setIsCalculateGrossLockState(true);OB.MobileApp.model.receipt.set('obposIsDeleted',true);OB.MobileApp.model.receipt.prepareToSend(function(){OB.MobileApp.model.receipt.trigger('closed',{callback:function(){OB.MobileApp.model.receipt.setIsCalculateGrossLockState(false);finishDeleteCurrent();}});});}else{finishDeleteCurrent();}},load:function(model){if(model&&this.current&&model.get('documentNo')===this.current.get('documentNo')){return;}
this.saveCurrent();this.current=model;this.loadCurrent();},saveCurrent:function(){if(this.current){OB.UTIL.clone(this.modelorder,this.current);this.current.trigger('updateView');}},loadCurrent:function(isNew){if(this.current){if(isNew){this.modelorder.trigger('beforeChangeOrderForNewOne',this.current);this.current.set('isNewReceipt',true);}
this.modelorder.clearWith(this.current);this.modelorder.set('isNewReceipt',false);this.modelorder.trigger('paintTaxes');this.modelorder.setIsCalculateReceiptLockState(false);this.modelorder.setIsCalculateGrossLockState(false);}},synchronizeCurrentOrder:function(){}});var MultiOrders=Backbone.Model.extend({modelName:'MultiOrders',defaults:{total:OB.DEC.Zero,payment:OB.DEC.Zero,pending:OB.DEC.Zero,change:OB.DEC.Zero,openDrawer:false,additionalInfo:null},initialize:function(){this.set('multiOrdersList',new Backbone.Collection());this.set('payments',new Backbone.Collection());this.get('multiOrdersList').off();},getPaymentStatus:function(){var total=OB.DEC.abs(this.getTotal());var pay=this.getPayment();return{'total':OB.I18N.formatCurrency(total),'pending':OB.DEC.compare(OB.DEC.sub(pay,total))>=0?OB.I18N.formatCurrency(OB.DEC.Zero):OB.I18N.formatCurrency(OB.DEC.sub(total,pay)),'change':OB.DEC.compare(this.getChange())>0?OB.I18N.formatCurrency(this.getChange()):null,'overpayment':OB.DEC.compare(OB.DEC.sub(pay,total))>0?OB.I18N.formatCurrency(OB.DEC.sub(pay,total)):null,'isReturn':this.get('gross')<0?true:false,'isNegative':this.get('gross')<0?true:false,'changeAmt':this.getChange(),'pendingAmt':OB.DEC.compare(OB.DEC.sub(pay,total))>=0?OB.DEC.Zero:OB.DEC.sub(total,pay),'payments':this.get('payments')};},getPrecision:function(payment){var i,p,max;for(i=0,max=OB.MobileApp.model.get('payments').length;i<max;i++){p=OB.MobileApp.model.get('payments')[i];if(p.payment.searchKey===payment.paymenttype){if(p.obposPrecision){return p.obposPrecision;}}}},getSumOfOrigAmounts:function(paymentToIgnore){var payments=this.get('payments');var sumOfPayments=OB.DEC.Zero;if(payments&&payments.length>0){sumOfPayments=_.reduce(payments.models,function(memo,pymnt,index){if(paymentToIgnore&&(pymnt.get('kind')===paymentToIgnore.get('kind'))){return OB.DEC.add(memo,OB.DEC.Zero);}else{return OB.DEC.add(memo,pymnt.get('origAmount'));}},OB.DEC.Zero);return sumOfPayments;}else{return sumOfPayments;}},getDifferenceBetweenPaymentsAndTotal:function(paymentToIgnore){return OB.DEC.abs(OB.DEC.sub(OB.DEC.abs(this.getTotal()),this.getSumOfOrigAmounts(paymentToIgnore)));},getDifferenceRemovingSpecificPayment:function(currentPayment){var differenceInDefaultCurrency;var differenceInForeingCurrency;differenceInDefaultCurrency=this.getDifferenceBetweenPaymentsAndTotal(currentPayment);if(currentPayment&&currentPayment.get('rate')){differenceInForeingCurrency=OB.DEC.div(differenceInDefaultCurrency,currentPayment.get('rate'));return differenceInForeingCurrency;}else{return differenceInDefaultCurrency;}},adjustPayment:function(){var i,max,p;var payments=this.get('payments');var total=OB.DEC.abs(this.getTotal());var nocash=OB.DEC.Zero;var cash=OB.DEC.Zero;var origCash=OB.DEC.Zero;var auxCash=OB.DEC.Zero;var prevCash=OB.DEC.Zero;var paidCash=OB.DEC.Zero;var pcash;var precision;var multiCurrencyDifference;for(i=0,max=payments.length;i<max;i++){p=payments.at(i);precision=this.getPrecision(p);if(p.get('rate')&&p.get('rate')!=='1'){p.set('origAmount',OB.DEC.mul(p.get('amount'),p.get('rate')));if(OB.DEC.compare(OB.DEC.sub(this.getDifferenceRemovingSpecificPayment(p),OB.DEC.abs(p.get('amount'))))===OB.DEC.Zero){multiCurrencyDifference=this.getDifferenceBetweenPaymentsAndTotal(p);if(p.get('origAmount')!==multiCurrencyDifference){p.set('origAmount',multiCurrencyDifference);}}}else{p.set('origAmount',p.get('amount'));}
p.set('paid',p.get('origAmount'));if(p.get('kind')===OB.MobileApp.model.get('paymentcash')){cash=OB.DEC.add(cash,p.get('origAmount'));pcash=p;paidCash=OB.DEC.add(paidCash,p.get('origAmount'));}else if(OB.MobileApp.model.hasPayment(p.get('kind'))&&OB.MobileApp.model.hasPayment(p.get('kind')).paymentMethod.iscash){origCash=OB.DEC.add(origCash,p.get('origAmount'));pcash=p;paidCash=OB.DEC.add(paidCash,p.get('origAmount'));}else{nocash=OB.DEC.add(nocash,p.get('origAmount'));}}
if(pcash){if(pcash.get('kind')!==OB.MobileApp.model.get('paymentcash')){auxCash=origCash;prevCash=cash;}else{auxCash=cash;prevCash=origCash;}
if(OB.DEC.compare(nocash-total)>0){pcash.set('paid',OB.DEC.Zero);this.set('payment',nocash);this.set('change',OB.DEC.add(cash,origCash));}else if(OB.DEC.compare(OB.DEC.sub(OB.DEC.add(OB.DEC.add(nocash,cash),origCash),total))>0){pcash.set('paid',OB.DEC.sub(total,OB.DEC.add(nocash,OB.DEC.sub(paidCash,pcash.get('origAmount')))));this.set('payment',total);this.set('change',OB.DEC.sub(OB.DEC.add(OB.DEC.add(nocash,cash,precision),origCash,precision),OB.Utilities.Number.roundJSNumber(total,2),precision));}else{pcash.set('paid',auxCash);this.set('payment',OB.DEC.add(OB.DEC.add(nocash,cash),origCash));this.set('change',OB.DEC.Zero);}}else{if(payments.length>0){if(this.get('payment')===0||nocash>0){this.set('payment',nocash);}}else{this.set('payment',OB.DEC.Zero);}
this.set('change',OB.DEC.Zero);}},addPayment:function(payment){var payments,total;var i,max,p,order;if(!OB.DEC.isNumber(payment.get('amount'))){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_MsgPaymentAmountError'));return;}
if(this.stopAddingPayments){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_CannotAddPayments'));return;}
payments=this.get('payments');total=OB.DEC.abs(this.getTotal());order=this;OB.UTIL.HookManager.executeHooks('OBPOS_preAddPayment',{paymentToAdd:payment,payments:payments,receipt:this},function(){if(!payment.get('paymentData')){for(i=0,max=payments.length;i<max;i++){p=payments.at(i);if(p.get('kind')===payment.get('kind')&&!p.get('isPrePayment')){p.set('amount',OB.DEC.add(payment.get('amount'),p.get('amount')));if(p.get('rate')&&p.get('rate')!=='1'){p.set('origAmount',OB.DEC.add(payment.get('origAmount'),OB.DEC.mul(p.get('origAmount'),p.get('rate'))));}
payment.set('date',new Date());order.adjustPayment();order.trigger('displayTotal');return;}}}else{for(i=0,max=payments.length;i<max;i++){p=payments.at(i);if(p.get('kind')===payment.get('kind')&&p.get('paymentData')&&payment.get('paymentData')&&p.get('paymentData').groupingCriteria&&payment.get('paymentData').groupingCriteria&&p.get('paymentData').groupingCriteria===payment.get('paymentData').groupingCriteria){p.set('amount',OB.DEC.add(payment.get('amount'),p.get('amount')));if(p.get('rate')&&p.get('rate')!=='1'){p.set('origAmount',OB.DEC.add(payment.get('origAmount'),OB.DEC.mul(p.get('origAmount'),p.get('rate'))));}
payment.set('date',new Date());order.adjustPayment();order.trigger('displayTotal');return;}}}
if(payment.get('openDrawer')&&(payment.get('allowOpenDrawer')||payment.get('isCash'))){order.set('openDrawer',payment.get('openDrawer'));}
payment.set('date',new Date());payment.set('id',OB.UTIL.get_UUID());payments.add(payment);order.adjustPayment();order.trigger('displayTotal');});},removePayment:function(payment){var payments=this.get('payments');payments.remove(payment);if(payment.get('openDrawer')){this.set('openDrawer',false);}
this.adjustPayment();},printGross:function(){return OB.I18N.formatCurrency(this.getTotal());},getTotal:function(){return this.get('total');},getChange:function(){return this.get('change');},getPayment:function(){return this.get('payment');},getPending:function(){return OB.DEC.sub(OB.DEC.abs(this.getTotal()),this.getPayment());},toInvoice:function(status){if(status===false){this.unset('additionalInfo');_.each(this.get('multiOrdersList').models,function(order){order.unset('generateInvoice');},this);return;}
this.set('additionalInfo','I');_.each(this.get('multiOrdersList').models,function(order){order.set('generateInvoice',true);},this);},resetValues:function(){this.get('multiOrdersList').reset();this.set('total',OB.DEC.Zero);this.set('payment',OB.DEC.Zero);this.set('pending',OB.DEC.Zero);this.set('change',OB.DEC.Zero);this.get('payments').reset();this.set('openDrawer',false);this.set('additionalInfo',null);},hasDataInList:function(){if(this.get('multiOrdersList')&&this.get('multiOrdersList').length>0){return true;}
return false;}});var TaxLine=Backbone.Model.extend();OB.Data.Registry.registerModel(OrderLine);OB.Data.Registry.registerModel(PaymentLine);OB.Collection.OrderLineList=OB.Collection.OrderLineList.extend({isProductPresent:function(product){var result=null;if(this.length>0){result=_.find(this.models,function(line){if(line.get('product').get('id')===product.get('id')){return true;}},this);if(_.isUndefined(result)||_.isNull(result)){return false;}else{return true;}}else{return false;}}});window.OB.Model.Order=Order;window.OB.Collection.OrderList=OrderList;window.OB.Model.TaxLine=TaxLine;window.OB.Model.MultiOrders=MultiOrders;window.OB.Model.modelLoaders=[];}());(function(){var CashUp=OB.Data.ExtensibleModel.extend({modelName:'CashUp',tableName:'cashup',entityName:'CashUp',source:'',local:true});CashUp.addProperties([{name:'id',column:'cashup_id',primaryKey:true,type:'TEXT'},{name:'netSales',column:'netSales',type:'NUMERIC'},{name:'grossSales',column:'grossSales',type:'NUMERIC'},{name:'netReturns',column:'netReturns',type:'NUMERIC'},{name:'grossReturns',column:'grossReturns',type:'NUMERIC'},{name:'totalRetailTransactions',column:'totalRetailTransactions',type:'NUMERIC'},{name:'creationDate',column:'creationDate',type:'TEXT'},{name:'userId',column:'userId',type:'TEXT'},{name:'objToSend',column:'objToSend',type:'TEXT'},{name:'isbeingprocessed',column:'isbeingprocessed',type:'TEXT'},{name:'isprocessed',column:'isprocessed',type:'TEXT'},{name:'posterminal',column:'posterminal',type:'TEXT'}]);OB.Data.Registry.registerModel(CashUp);}());(function(){var CashManagement=OB.Data.ExtensibleModel.extend({modelName:'CashManagement',tableName:'cashmanagement',entityName:'CashManagement',source:'',local:true});CashManagement.addProperties([{name:'id',column:'cashmanagement_id',primaryKey:true,type:'TEXT'},{name:'description',column:'description',type:'TEXT'},{name:'amount',column:'amount',type:'NUMERIC'},{name:'origAmount',column:'origAmount',type:'NUMERIC'},{name:'type',column:'type',type:'TEXT'},{name:'reasonId',column:'reasonId',type:'TEXT'},{name:'paymentMethodId',column:'paymentMethodId',type:'TEXT'},{name:'user',column:'user',type:'TEXT'},{name:'userId',column:'userId',type:'TEXT'},{name:'creationDate',column:'creationDate',type:'TEXT'},{name:'timezoneOffset',column:'timezoneOffset',type:'TEXT'},{name:'isocode',column:'isocode',type:'TEXT'},{name:'cashup_id',column:'cashup_id',type:'TEXT'},{name:'glItem',column:'glItem',type:'TEXT'},{name:'isbeingprocessed',column:'isbeingprocessed',type:'TEXT'},{name:'posTerminal',column:'posTerminal',type:'TEXT'}]);CashManagement.addIndex([{name:'cashmgmt_idx',columns:[{name:'cashup_id',sort:'desc'},{name:'paymentMethodId',sort:'desc'}]}]);OB.Data.Registry.registerModel(CashManagement);}());(function(){OB.Model.POSTerminal=OB.Model.Terminal.extend({setTerminalName:function(terminalName){this.set('terminalName',terminalName);this.set('loginUtilsParams',{terminalName:terminalName});if(terminalName&&!window.localStorage.getItem('terminalName')){window.localStorage.setItem('terminalName',terminalName);}},initialize:function(){var me=this;me.set({appName:'WebPOS',appModuleId:'FF808181326CC34901326D53DBCF0018',supportsOffline:true,loginUtilsUrl:'../../org.openbravo.retail.posterminal.service.loginutils',loginHandlerUrl:'../../org.openbravo.retail.posterminal/POSLoginHandler',applicationFormatUrl:'../../org.openbravo.mobile.core/OBPOS_Main/ApplicationFormats',logoutUrlParams:window.localStorage.getItem('terminalAuthentication')==='Y'?{}:{terminal:OB.UTIL.getParameterByName("terminal")},logConfiguration:{deviceIdentifier:window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"),logPropertiesExtension:[function(){return{isOnline:OB.MobileApp.model.get('connectedToERP')};}]},profileOptions:{showOrganization:false,showWarehouse:false,defaultProperties:{role:'oBPOSDefaultPOSRole'}},localDB:{size:OB.UTIL.VersionManagement.current.posterminal.WebSQLDatabase.size,name:OB.UTIL.VersionManagement.current.posterminal.WebSQLDatabase.name,displayName:OB.UTIL.VersionManagement.current.posterminal.WebSQLDatabase.displayName,version:OB.UTIL.VersionManagement.current.posterminal.WebSQLDatabase.dbVersion},logDBTrxThreshold:300,logDBStmtThreshold:1000});me.setTerminalName(window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"));OB.UTIL.HookManager.registerHook('OBMOBC_InitActions',function(args,c){me.initActions(function(){me.setTerminalName(window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"));me.set('logConfiguration',{deviceIdentifier:window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"),logPropertiesExtension:[function(){return{isOnline:OB.MobileApp.model.get('connectedToERP')};}]});args.cancelOperation=true;OB.UTIL.HookManager.callbackExecutor(args,c);});});this.addPropertiesLoader({properties:['terminal'],loadFunction:function(terminalModel){OB.info('[terminal] Loading... '+this.properties);var me=this,max,i,handleError;var params={};var currentDate=new Date();params.terminalTime=currentDate;params.terminalTimeOffset=currentDate.getTimezoneOffset();handleError=function(data){if(data&&data.exception&&data.exception.message&&OB.I18N.hasLabel(data.exception.message)){OB.UTIL.showConfirmation.display('Error',OB.I18N.getLabel('OBPOS_errorLoadingTerminal')+' '+OB.I18N.getLabel(data.exception.message),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.UTIL.showLoggingOut(true);terminalModel.logout();}}],{onShowFunction:function(popup){popup.$.headerCloseButton.hide();},autoDismiss:false});}else if(OB.MobileApp.model.get('isLoggingIn')===true){var msg=OB.I18N.getLabel('OBPOS_errorLoadingTerminal')+' '+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();OB.MobileApp.view.$.containerWindow.destroyComponents();},autoDismiss:false});}};new OB.DS.Request('org.openbravo.retail.posterminal.term.Terminal').exec(params,function(data){if(data.exception){handleError(data);}else if(data[0]){for(i=0,max=data.length;i<max;i++){if(Object.keys(data[i])[0]==="businesspartner"){terminalModel.set(Object.keys(data[i])[0],data[i][Object.keys(data[i])[0]].id);}else{terminalModel.set(Object.keys(data[i])[0],data[i][Object.keys(data[i])[0]]);}}
OB.MobileApp.model.saveDocumentSequence(OB.MobileApp.model.get('terminal').lastDocumentNumber,OB.MobileApp.model.get('terminal').lastQuotationDocumentNumber,function(){if(OB.MobileApp.model.orderList){OB.MobileApp.model.orderList.synchronizeCurrentOrder();}});window.localStorage.setItem('terminalId',data[0].terminal.id);terminalModel.set('useBarcode',terminalModel.get('terminal').terminalType.usebarcodescanner);OB.MobileApp.view.scanningFocus(true);if(!terminalModel.usermodel){OB.MobileApp.model.loadingErrorsActions("The terminal.usermodel should be loaded at this point");}else if(OB.MobileApp.model.attributes.loadManifeststatus&&OB.MobileApp.model.attributes.loadManifeststatus.type==='error'){var error=OB.MobileApp.model.attributes.loadManifeststatus;OB.debug(error.reason+' failed to load: '+error.url);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_TitleFailedAppCache'),OB.I18N.getLabel('OBPOS_FailedAppCache'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true}],{autoDismiss:false,onHideFunction:function(popup){terminalModel.propertiesReady(me.properties);}});}else{terminalModel.propertiesReady(me.properties);}
OB.UTIL.HookManager.executeHooks('OBPOS_TerminalLoadedFromBackend',{data:data[0].terminal.id});}else{OB.UTIL.showError("Terminal does not exists: "+'params.terminal');}},function(data){OB.UTIL.Debug.execute(function(){OB.error("Error while retrieving the terminal info ",data);});handleError(data);});}});this.addPropertiesLoader({properties:['context'],sync:false,loadFunction:function(terminalModel){OB.info('[terminal] Loading... '+this.properties);var me=this;var rr,ajaxRequest2=new enyo.Ajax({url:'../../org.openbravo.mobile.core.context',cacheBust:false,method:'GET',handleAs:'json',timeout:20000,data:{ignoreForConnectionStatus:true},contentType:'application/json;charset=utf-8',success:function(inSender,inResponse){if(inResponse&&inResponse.data){terminalModel.set(me.properties[0],inResponse.data[0]);terminalModel.propertiesReady(me.properties);}else{if(OB.MobileApp.model.get('isLoggingIn')===true){var msg=OB.I18N.getLabel('OBMOBC_ContextErrorBody')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();},autoDismiss:false});}}},fail:function(){if(OB.MobileApp.model.get('isLoggingIn')===true){var msg=OB.I18N.getLabel('OBMOBC_ContextErrorBody')+OB.I18N.getLabel('OBMOBC_LoadingErrorBody');OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),msg,[{label:OB.I18N.getLabel('OBMOBC_Reload'),action:function(){window.location.reload();}}],{onShowFunction:function(popup){window.localStorage.removeItem('cacheAvailableForUser:'+OB.MobileApp.model.get('orgUserId'));popup.$.headerCloseButton.hide();},autoDismiss:false});}}});rr=new OB.RR.Request({ajaxRequest:ajaxRequest2});rr.exec(ajaxRequest2.url);}});this.addPropertiesLoader({properties:['rejectReasons'],loadFunction:function(terminalModel){OB.info('[terminal] Loading... '+this.properties);var me=this;new OB.DS.Request('org.openbravo.retail.posterminal.term.RejectReason').exec(null,function(data){if(data&&data.exception){terminalModel.set(me.properties[0],[]);}else{terminalModel.set(me.properties[0],data);}
terminalModel.propertiesReady(me.properties);});}});this.get('dataSyncModels').push({name:'Customer',model:OB.Model.ChangedBusinessPartners,modelFunc:'OB.Model.ChangedBusinessPartners',className:'org.openbravo.retail.posterminal.CustomerLoader',criteria:{},getIdentifier:function(model){return JSON.parse(model.get('json'))._identifier;}});this.get('dataSyncModels').push({name:'Customer Address',model:OB.Model.ChangedBPlocation,modelFunc:'OB.Model.ChangedBPlocation',className:'org.openbravo.retail.posterminal.CustomerAddrLoader',criteria:{},getIdentifier:function(model){return JSON.parse(model.get('json'))._identifier;}});this.get('dataSyncModels').push({name:'Order',model:OB.Model.Order,modelFunc:'OB.Model.Order',className:'org.openbravo.retail.posterminal.OrderLoader',timeout:20000,timePerRecord:1000,criteria:{hasbeenpaid:'Y'},getIdentifier:function(model){return model.documentNo;}});this.get('dataSyncModels').push({name:'Cash Management',model:OB.Model.CashManagement,modelFunc:'OB.Model.CashManagement',isPersistent:true,className:'org.openbravo.retail.posterminal.ProcessCashMgmt',criteria:{'isbeingprocessed':'N'},getIdentifier:function(model){return model.get('type')+': '+model.get('user')+' - '+model.get('time');}});this.get('dataSyncModels').push({name:'Cash Up',model:OB.Model.CashUp,modelFunc:'OB.Model.CashUp',isPersistent:true,className:'org.openbravo.retail.posterminal.ProcessCashClose',timeout:600000,timePerRecord:10000,criteria:{},getIdentifier:function(model){return OB.I18N.formatDateISO(new Date(model.creationDate));},changesPendingCriteria:{'isprocessed':'Y'},postProcessingFunction:function(data,callback){OB.UTIL.initCashUp(function(){var cashUpId=data.at(0).get('id');OB.Dal.find(OB.Model.CashUp,{id:cashUpId},function(cU){if(cU.length!==0){if(!cU.at(0).get('objToSend')){OB.UTIL.composeCashupInfo(data,null,function(){OB.MobileApp.model.runSyncProcess();});}}});OB.UTIL.deleteCashUps(data);OB.UTIL.calculateCurrentCash();callback();},null,true);}});this.on('ready',function(){OB.debug("next process: 'retail.pointofsale' window");var terminal=this.get('terminal');OB.UTIL.initCashUp(OB.UTIL.calculateCurrentCash);OB.POS.hwserver=new OB.DS.HWServer(terminal.hardwareurl,terminal.scaleurl);OB.DEC.setContext(OB.UTIL.getFirstValidValue([me.get('currency').obposPosprecision,me.get('currency').pricePrecision]),BigDecimal.prototype.ROUND_HALF_UP);OB.UTIL.HookManager.executeHooks('OBPOS_LoadPOSWindow',{},function(){var defaultWindow=OB.MobileApp.model.get('defaultWindow');if(defaultWindow){OB.POS.navigate(defaultWindow);OB.MobileApp.model.unset('defaultWindow');}else{OB.POS.navigate('retail.pointofsale');}});if(me.get('loggedOffline')===true){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_OfflineLogin'));}
OB.POS.hwserver.print(new OB.DS.HWResource(OB.OBPOSPointOfSale.Print.WelcomeTemplate),{});});OB.Model.Terminal.prototype.initialize.call(me);},runSyncProcess:function(successCallback,errorCallback){var me=this;function run(){OB.debug('runSyncProcess: executing pre synchronization hook');OB.UTIL.HookManager.executeHooks('OBPOS_PreSynchData',{},function(){OB.debug('runSyncProcess: synchronize all models');OB.MobileApp.model.syncAllModels(function(){OB.info('runSyncProcess: synchronization successfully done');if(successCallback){successCallback();}},function(){OB.warn("runSyncProcess failed: the WebPOS is most likely to be offline, but a real error could be present.");if(errorCallback){errorCallback();}});});}
if(window.localStorage.getItem('terminalAuthentication')==='Y'){var process=new OB.DS.Process('org.openbravo.retail.posterminal.CheckTerminalAuth');OB.trace('Checking authentication');process.exec({terminalName:window.localStorage.getItem('terminalName'),terminalKeyIdentifier:window.localStorage.getItem('terminalKeyIdentifier'),terminalAuthentication:window.localStorage.getItem('terminalAuthentication'),cacheSessionId:window.localStorage.getItem('cacheSessionId')},function(data){if(data&&data.exception){OB.error("runSyncProcess",OB.I18N.getLabel('OBPOS_TerminalAuthError'));}else if(data&&(data.isLinked===false||data.terminalAuthentication)){if(data.isLinked===false){window.localStorage.removeItem('terminalName');window.localStorage.removeItem('terminalKeyIdentifier');}
if(data.terminalAuthentication){window.localStorage.setItem('terminalAuthentication',data.terminalAuthentication);}
if(data&&data.errorReadingTerminalAuthentication){OB.UTIL.showWarning(data.errorReadingTerminalAuthentication);}
OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_TerminalAuthChange'),OB.I18N.getLabel('OBPOS_TerminalAuthChangeMsg'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.UTIL.showLoading(true);me.logout();}}],{onHideFunction:function(){OB.UTIL.showLoading(true);me.logout();}});}else{run();}});}else{run();}
this.postSyncProcessActions();},postSyncProcessActions:function(){OB.Dal.get(OB.Model.SalesRepresentative,OB.MobileApp.model.usermodel.get('id'),function(salesrepresentative){if(!salesrepresentative){OB.MobileApp.model.get('context').user.isSalesRepresentative=false;}else{OB.MobileApp.model.get('context').user.isSalesRepresentative=true;}},function(){},function(){OB.MobileApp.model.get('context').user.isSalesRepresentative=false;});},returnToOnline:function(){this.runSyncProcess();},renderMain:function(){OB.debug("next process: trigger 'ready'");if(!this.get('terminal')){OB.UTIL.Debug.execute(function(){throw"OB.MobileApp.model.get('terminal') properties have not been loaded";});OB.MobileApp.model.navigate('login');return;}
var i,paymentcashcurrency,paymentcash,paymentlegacy,max,me=this,defaultpaymentcash,defaultpaymentcashcurrency;if(!OB.UTIL.isSupportedBrowser()){OB.MobileApp.model.renderLogin();return false;}
OB.DS.commonParams=OB.DS.commonParams||{};OB.DS.commonParams={client:this.get('terminal').client,organization:this.get('terminal').organization,pos:this.get('terminal').id,terminalName:this.get('terminalName')};this.paymentnames={};for(i=0,max=this.get('payments').length;i<max;i++){this.paymentnames[this.get('payments')[i].payment.searchKey]=this.get('payments')[i];if(this.get('payments')[i].payment.searchKey==='OBPOS_payment.cash'){paymentlegacy=this.get('payments')[i].payment.searchKey;}
if(this.get('payments')[i].paymentMethod.iscash){paymentcash=this.get('payments')[i].payment.searchKey;if(this.get('payments')[i].paymentMethod.currency===this.get('terminal').currency){paymentcashcurrency=this.get('payments')[i].payment.searchKey;if(this.get('payments')[i].paymentMethod.defaultCashPaymentMethod){defaultpaymentcashcurrency=this.get('payments')[i].payment.searchKey;}}
if(this.get('payments')[i].paymentMethod.defaultCashPaymentMethod){defaultpaymentcash=this.get('payments')[i].payment.searchKey;}}}
this.set('paymentcash',defaultpaymentcashcurrency||defaultpaymentcash||paymentcashcurrency||paymentcash||paymentlegacy);_.each(OB.MobileApp.model.get('payments'),function(paymentMethod){var fromCurrencyId=parseInt(OB.MobileApp.model.get('currency').id,10);var toCurrencyId=parseInt(paymentMethod.paymentMethod.currency,10);if(fromCurrencyId!==toCurrencyId){OB.UTIL.currency.addConversion(toCurrencyId,fromCurrencyId,paymentMethod.rate);OB.UTIL.currency.addConversion(fromCurrencyId,toCurrencyId,paymentMethod.mulrate);}},this);OB.MobileApp.model.on('window:ready',function(){if(window.localStorage.getItem('terminalAuthentication')==='Y'){var process=new OB.DS.Process('org.openbravo.retail.posterminal.CheckTerminalAuth');process.exec({terminalName:window.localStorage.getItem('terminalName'),terminalKeyIdentifier:window.localStorage.getItem('terminalKeyIdentifier'),terminalAuthentication:window.localStorage.getItem('terminalAuthentication'),cacheSessionId:window.localStorage.getItem('cacheSessionId')},function(data){if(data&&data.exception){OB.error("renderMain",OB.I18N.getLabel('OBPOS_TerminalAuthError'));}else if(data&&(data.isLinked===false||data.terminalAuthentication)){if(data.isLinked===false){window.localStorage.removeItem('terminalName');window.localStorage.removeItem('terminalKeyIdentifier');}
if(data.terminalAuthentication){window.localStorage.setItem('terminalAuthentication',data.terminalAuthentication);}
if(data&&data.errorReadingTerminalAuthentication){OB.UTIL.showWarning(data.errorReadingTerminalAuthentication);}
OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_TerminalAuthChange'),OB.I18N.getLabel('OBPOS_TerminalAuthChangeMsg'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.UTIL.showLoading(true);me.logout();}}],{onHideFunction:function(){OB.UTIL.showLoading(true);me.logout();}});}});}});this.trigger('ready');},postLoginActions:function(){OB.debug("next process: renderTerminalMain");var loadModelsIncFunc;var minIncRefresh=this.get('terminal').terminalType.minutestorefreshdatainc*60*1000,minTotalRefresh=this.get('terminal').terminalType.minutestorefreshdatatotal*60*1000,lastTotalRefresh=window.localStorage.getItem('POSLastTotalRefresh'),lastIncRefresh=window.localStorage.getItem('POSLastIncRefresh');function setTerminalLockTimeout(sessionTimeoutMinutes,sessionTimeoutMilliseconds){OB.debug("Terminal lock timer reset ("+sessionTimeoutMinutes+" minutes)");clearTimeout(this.timeoutId);this.timeoutId=setTimeout(function(){OB.warn("The terminal was not used for "+sessionTimeoutMinutes+" minutes. Locking the terminal");OB.MobileApp.model.lock();},sessionTimeoutMilliseconds);}
if((minTotalRefresh||minIncRefresh)&&(lastTotalRefresh||lastIncRefresh)){OB.MobileApp.model.set('minIncRefreshSynchronized',false);OB.MobileApp.model.on('synchronized',function(){if(OB.MobileApp.model.get('minIncRefreshSynchronized')){return;}
OB.MobileApp.model.set('minIncRefreshSynchronized',true);if(OB.MobileApp.model.get('FullRefreshWasDone')){return;}
OB.MobileApp.model.loadModels(null,true);});}
if(minIncRefresh){loadModelsIncFunc=function(){OB.MobileApp.model.loadModels(null,true);};setInterval(loadModelsIncFunc,minIncRefresh);}
var sessionTimeoutMinutes=this.get('terminal').sessionTimeout;if(!this.sessionPing&&sessionTimeoutMinutes){var sessionTimeoutMilliseconds=sessionTimeoutMinutes*60*1000;this.sessionPing=setInterval(function(){new OB.DS.Process('org.openbravo.mobile.core.login.ContextInformation').exec(null,function(){});},sessionTimeoutMilliseconds);setTerminalLockTimeout(sessionTimeoutMinutes,sessionTimeoutMilliseconds);enyo.gesture.down=function(inEvent){setTerminalLockTimeout(sessionTimeoutMinutes,sessionTimeoutMilliseconds);var e=this.makeEvent("down",inEvent);enyo.dispatch(e);this.downEvent=e;};}},cleanSessionInfo:function(){this.cleanTerminalData();},preLoginActions:function(){this.cleanSessionInfo();},preLogoutActions:function(){if(OB.POS.hwserver!==undefined){OB.POS.hwserver.print(new OB.DS.HWResource(OB.OBPOSPointOfSale.Print.GoodByeTemplate),{});}
if(!OB.MobileApp.model.attributes.permissions||!OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){this.cleanSessionInfo();}},postCloseSession:function(session){var criteria={},model;var me=this;function success(collection){var i,j,saveCallback,lastDocWithData=-1;if(collection.length>0){saveCallback=function(){me.cleanSessionInfo();OB.MobileApp.model.triggerLogout();};if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){for(i=collection.models.length-1;i>=0;i--){var model=collection.models[i];if(model.get('lines').length>0){lastDocWithData=i;break;}}}
var setValuesOnLogout;setValuesOnLogout=function(models,index,callback){if(index>=models.length){if(callback){callback();}
return;}
var model=models[index];var creationDate=new Date();model.set('creationDate',creationDate);model.set('timezoneOffset',creationDate.getTimezoneOffset());model.set('created',creationDate.getTime());model.set('obposCreatedabsolute',OB.I18N.formatDateISO(creationDate));if(index<=lastDocWithData||(OB.MobileApp.model.get('permissions').OBPOS_remove_ticket===false)){model.set('obposIsDeleted',true);for(i=0;i<model.get('lines').length;i++){model.get('lines').at(i).set('obposIsDeleted',true);}
model.set('hasbeenpaid','Y');OB.MobileApp.model.updateDocumentSequenceWhenOrderSaved(model.get('documentnoSuffix'),model.get('quotationnoSuffix'),function(){model.save(function(){setValuesOnLogout(models,index+1,callback);},models);});}else{setValuesOnLogout(models,index+1,callback);}};setValuesOnLogout(collection.models,0,saveCallback);}else{me.cleanSessionInfo();OB.MobileApp.model.triggerLogout();}}
function error(){OB.error("postCloseSession",arguments);OB.MobileApp.model.triggerLogout();}
if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){criteria.session=session.get('id');criteria.hasbeenpaid='N';OB.Dal.find(OB.Model.Order,criteria,success,error);}else{OB.Dal.removeAll(OB.Model.Order,{'session':session.get('id'),'hasbeenpaid':'N'},function(){OB.MobileApp.model.triggerLogout();},error);}
this.set('currentView',{name:'order',params:null});localStorage.setItem('leftColumnCurrentView',JSON.stringify(this.get('currentView')));},documentnoThreshold:-1,quotationnoThreshold:-1,isSeqNoReadyEventSent:false,saveDocumentSequence:function(documentnoSuffix,quotationnoSuffix,callback,tx){var me=this;if(me.restartingDocNo===true){if(callback){callback();}
return;}
if(documentnoSuffix===-1&&quotationnoSuffix===-1&&this.documentnoThreshold>=0&&this.quotationnoThreshold>=0){if(callback){callback();}
return;}
if(documentnoSuffix===0||quotationnoSuffix===0){me.restartingDocNo=true;}
if(documentnoSuffix>this.documentnoThreshold||documentnoSuffix===0){this.documentnoThreshold=documentnoSuffix;}
if(quotationnoSuffix>this.quotationnoThreshold||quotationnoSuffix===0){this.quotationnoThreshold=quotationnoSuffix;}
var processDocumentSequenceList=function(documentSequenceList){var docSeq;if(documentSequenceList&&documentSequenceList.length>0){docSeq=documentSequenceList.models[0];if(docSeq.get('documentSequence')>me.documentnoThreshold&&documentnoSuffix!==0){me.documentnoThreshold=docSeq.get('documentSequence');}
if(docSeq.get('quotationDocumentSequence')>me.quotationnoThreshold&&quotationnoSuffix!==0){me.quotationnoThreshold=docSeq.get('quotationDocumentSequence');}}else{docSeq=new OB.Model.DocumentSequence();docSeq.set('posSearchKey',me.get('terminal').searchKey);}
OB.MobileApp.model.set('documentsequence',me.getLastDocumentnoSuffixInOrderlist());OB.MobileApp.model.set('quotationDocumentSequence',me.getLastQuotationnoSuffixInOrderlist());if(!me.isSeqNoReadyEventSent){me.isSeqNoReadyEventSent=true;me.trigger('seqNoReady');}
docSeq.set('documentSequence',me.documentnoThreshold);docSeq.set('quotationDocumentSequence',me.quotationnoThreshold);OB.Dal.saveInTransaction(tx,docSeq,function(){if(callback){callback();}
me.restartingDocNo=false;},function(){me.restartingDocNo=false;});};OB.Dal.findInTransaction(tx,OB.Model.DocumentSequence,{'posSearchKey':this.get('terminal').searchKey},processDocumentSequenceList,function(){me.restartingDocNo=false;});},updateDocumentSequenceWhenOrderSaved:function(documentnoSuffix,quotationnoSuffix,callback,tx){if(quotationnoSuffix>=0){documentnoSuffix=-1;}
this.saveDocumentSequence(documentnoSuffix,quotationnoSuffix,callback,tx);},getLastDocumentnoSuffixInOrderlist:function(){var lastSuffix=null;if(OB.MobileApp.model.orderList&&OB.MobileApp.model.orderList.length>0){var i=0;while(lastSuffix===null&&i<=OB.MobileApp.model.orderList.models.length-1){var order=OB.MobileApp.model.orderList.models[i];if(!order.get('isPaid')&&!order.get('isQuotation')&&order.get('documentnoPrefix')===OB.MobileApp.model.get('terminal').docNoPrefix){lastSuffix=order.get('documentnoSuffix');}
i++;}}
if(lastSuffix===null||lastSuffix<this.documentnoThreshold){lastSuffix=this.documentnoThreshold;}
return lastSuffix;},getLastQuotationnoSuffixInOrderlist:function(){var lastSuffix=null;if(OB.MobileApp.model.orderList&&OB.MobileApp.model.orderList.length>0){var i=0;while(lastSuffix===null&&i<=OB.MobileApp.model.orderList.models.length-1){var order=OB.MobileApp.model.orderList.models[i];if(order.get('isQuotation')&&order.get('quotationnoPrefix')===OB.MobileApp.model.get('terminal').quotationDocNoPrefix){lastSuffix=order.get('quotationnoSuffix');}
i++;}}
if(lastSuffix===null||lastSuffix<this.quotationnoThreshold){lastSuffix=this.quotationnoThreshold;}
return lastSuffix;},getNextDocumentno:function(){var next=this.getLastDocumentnoSuffixInOrderlist()+1;return{documentnoSuffix:next,documentNo:OB.MobileApp.model.get('terminal').docNoPrefix+'/'+OB.UTIL.padNumber(next,7)};},getNextQuotationno:function(){var next=this.getLastQuotationnoSuffixInOrderlist()+1;return{quotationnoSuffix:next,documentNo:OB.MobileApp.model.get('terminal').quotationDocNoPrefix+'/'+OB.UTIL.padNumber(next,7)};},getPaymentName:function(key){if(this.paymentnames[key]&&this.paymentnames[key].payment&&this.paymentnames[key].payment._identifier){return this.paymentnames[key].payment._identifier;}
return null;},hasPayment:function(key){return this.paymentnames[key];},databaseCannotBeResetAction:function(){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_ResetNeededNotSafeTitle'),OB.I18N.getLabel('OBPOS_ResetNeededNotSafeMessage'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.MobileApp.model.lock();}}],{onHideFunction:function(){OB.MobileApp.model.lock();}});},isUserCacheAvailable:function(){return true;},dialog:null,preLoadContext:function(callback){if(!window.localStorage.getItem('terminalKeyIdentifier')&&window.localStorage.getItem('terminalAuthentication')==='Y'){OB.UTIL.showLoading(false);if(OB.UI.ModalSelectTerminal){this.dialog=OB.MobileApp.view.$.confirmationContainer.createComponent({kind:'OB.UI.ModalSelectTerminal',name:'modalSelectTerminal',callback:callback,context:this});this.dialog.show();}}else{callback();}},linkTerminal:function(terminalData,callback){var params=this.get('loginUtilsParams')||{},me=this;params.command='preLoginActions';params.params=terminalData;new OB.OBPOSLogin.UI.LoginRequest({url:OB.MobileApp.model.get('loginUtilsUrl')}).response(this,function(inSender,inResponse){if(inResponse.exception){OB.UTIL.showConfirmation.display('Error',OB.I18N.getLabel(inResponse.exception),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){if(OB.UI.ModalSelectTerminal){me.dialog=OB.MobileApp.view.$.confirmationContainer.createComponent({kind:'OB.UI.ModalSelectTerminal',name:'modalSelectTerminal',callback:callback,context:me});me.dialog.show();}}}],{onHideFunction:function(){if(OB.UI.ModalSelectTerminal){me.dialog=OB.MobileApp.view.$.confirmationContainer.createComponent({kind:'OB.UI.ModalSelectTerminal',name:'modalSelectTerminal',callback:callback,context:me});me.dialog.show();}}});}else{OB.appCaption=inResponse.appCaption;me.setTerminalName(inResponse.terminalName);if(me.get('logConfiguration')&&me.get('logConfiguration').deviceIdentifier===null){me.get('logConfiguration').deviceIdentifier=inResponse.terminalName;}
window.localStorage.setItem('terminalName',inResponse.terminalName);window.localStorage.setItem('terminalKeyIdentifier',inResponse.terminalKeyIdentifier);callback();}}).error(function(){callback();}).go(params);},initActions:function(callback){var params=this.get('loginUtilsParams')||{},me=this;var cacheSessionId=null;if(window.localStorage.getItem('cacheSessionId')&&window.localStorage.getItem('cacheSessionId').length===32){cacheSessionId=window.localStorage.getItem('cacheSessionId');}
params.cacheSessionId=cacheSessionId;params.command='initActions';new OB.OBPOSLogin.UI.LoginRequest({url:'../../org.openbravo.retail.posterminal.service.loginutils'}).response(this,function(inSender,inResponse){if(inResponse&&inResponse.errorReadingTerminalAuthentication){OB.UTIL.showWarning(inResponse.errorReadingTerminalAuthentication);}
window.localStorage.setItem('terminalAuthentication',inResponse.terminalAuthentication);if(!(window.localStorage.getItem('cacheSessionId')&&window.localStorage.getItem('cacheSessionId').length===32)){window.localStorage.setItem('cacheSessionId',inResponse.cacheSessionId);}
if(inResponse.servers){localStorage.servers=JSON.stringify(inResponse.servers);}
if(inResponse.services){localStorage.services=JSON.stringify(inResponse.services);}
OB.RR.RequestRouter.initialize();me.setTerminalName(window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"));callback();}).error(function(){callback();}).go(params);}});var initializeOBModelTerminal=new OB.Model.POSTerminal();OB.POS={modelterminal:OB.MobileApp.model,paramWindow:OB.UTIL.getParameterByName("window")||"retail.pointofsale",paramTerminal:window.localStorage.getItem('terminalAuthentication')==='Y'?window.localStorage.getItem('terminalName'):OB.UTIL.getParameterByName("terminal"),hrefWindow:function(windowname){return'?terminal='+window.encodeURIComponent(OB.MobileApp.model.get('terminalName'))+'&window='+window.encodeURIComponent(windowname);},logout:function(){OB.MobileApp.model.logout();},lock:function(){OB.MobileApp.model.lock();},windows:null,navigate:function(route){OB.MobileApp.model.navigate(route);},registerWindow:function(window){OB.MobileApp.windowRegistry.registerWindow(window);},cleanWindows:function(){OB.MobileApp.model.cleanWindows();}};OB.Constants={FIELDSEPARATOR:'$',IDENTIFIER:'_identifier'};}());var origTap=OB.UI.ProfileDialogApply.prototype.tap;OB.UI.ProfileDialogApply.prototype.tap=_.wrap(OB.UI.ProfileDialogApply.prototype.tap,function(){var tap=_.bind(origTap,this),widgetForm=this.owner.owner.$.bodyContent.$,newRoleId=widgetForm.roleList.getValue(),isDefault=widgetForm.defaultBox.checked,process=new OB.DS.Process('org.openbravo.retail.posterminal.Profile');if(!this.isActive){return;}
if(isDefault){this.isActive=true;process.exec({role:newRoleId},function(data){if(data.success){tap();}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_ErrorWhileSavingUser'));}},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));});}else{tap();}});OB.DS.HWResource=function(res){this.resource=res;this.resourcedata=null;};OB.DS.HWResource.prototype.getData=function(callback){if(this.resourcedata){callback(this.resourcedata);}else{OB.UTIL.loadResource(this.resource,function(data){this.resourcedata=data;callback(this.resourcedata);},this);}};OB.DS.HWServer=function(url,scaleurl){this.url=url;this.scaleurl=scaleurl;};OB.DS.HWServer.prototype.getWeight=function(callback){if(this.scaleurl){var me=this;var ajaxRequest=new enyo.Ajax({url:me.scaleurl,cacheBust:false,method:'GET',handleAs:'json',contentType:'application/x-www-form-urlencoded; charset=UTF-8',success:function(inSender,inResponse){callback(inResponse);},fail:function(inSender,inResponse){if(callback){callback({exception:{message:(OB.I18N.getLabel('OBPOS_MsgScaleServerNotAvailable'))},result:1});}}});ajaxRequest.go().response('success').error('fail');}else{callback({result:1});}};OB.DS.HWServer.prototype.openDrawerTemplate='res/opendrawer.xml';OB.DS.HWServer.prototype.openDrawer=function(popup,timeout){var template=new OB.DS.HWResource(this.openDrawerTemplate);this.print(template,null,function(args){if(args&&args.exception&&args.exception.message){OB.info('Error opening the drawer');}});if(OB.MobileApp.model.get('permissions').OBPOS_closeDrawerBeforeContinue){this.drawerClosed=false;OB.POS.hwserver.isDrawerClosed(popup,timeout);}};OB.DS.HWServer.prototype.openCheckDrawer=function(popup,timeout){this.checkDrawer(function(){this.openDrawer(popup,timeout);},this);};OB.DS.HWServer.prototype.checkDrawer=function(callback,context){if(!OB.MobileApp.model.get('permissions').OBPOS_closeDrawerBeforeContinue||this.drawerClosed){if(context){return callback.apply(context);}else{return callback();}}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_drawerOpened'));return false;}};OB.DS.HWServer.prototype.isDrawerClosedTemplate='res/checkdrawerstatus.xml';OB.DS.HWServer.prototype.isDrawerClosed=function(popup,timeout){var statusChecker,beepTimeout,sound=new Audio('sounds/drawerAlert.mp3'),template=new OB.DS.HWResource(this.isDrawerClosedTemplate),me=this,errorCounter=0,symbol,symbolAtRight,popupDrawerOpened=OB.MobileApp.view.$.confirmationContainer.$.popupDrawerOpened;if(timeout&&!isNaN(parseInt(timeout,10))){beepTimeout=setTimeout(function(){sound.loop=true;sound.play();},parseInt(timeout,10));}
if(popup){if(!popupDrawerOpened){popupDrawerOpened=OB.MobileApp.view.$.confirmationContainer.createComponent({kind:'OB.UI.PopupDrawerOpened'});}
if(popup.receipt){var paymentStatus=popup.receipt.getPaymentStatus();popupDrawerOpened.$.table.setStyle('position:relative; top: 0px;');if(paymentStatus.isReturn||paymentStatus.isNegative){popupDrawerOpened.$.bodyContent.$.label.setContent(OB.I18N.getLabel('OBPOS_ToReturn')+':');_.each(popup.receipt.get('payments').models,function(payment){if(payment.get('isCash')){symbol=OB.MobileApp.model.paymentnames[payment.get('kind')].symbol;symbolAtRight=OB.MobileApp.model.paymentnames[payment.get('kind')].currencySymbolAtTheRight;popupDrawerOpened.$.bodyContent.$.label.setContent(popupDrawerOpened.$.bodyContent.$.label.getContent()+' '+OB.I18N.formatCurrencyWithSymbol(payment.get('paid'),symbol,symbolAtRight));}});}else{if(!paymentStatus.change){popupDrawerOpened.$.bodyContent.$.label.setContent(OB.I18N.getLabel('OBPOS_PaymentsExact'));}else{popupDrawerOpened.$.bodyContent.$.label.setContent(OB.I18N.getLabel('OBPOS_ticketChange')+': '+OB.MobileApp.model.get('changeReceipt'));}}}else{popupDrawerOpened.$.bodyContent.$.label.setContent('');popupDrawerOpened.$.table.setStyle('position:relative; top: 35px;');}
if(popup.openFirst){OB.UTIL.showLoading(false);popupDrawerOpened.show();}}
statusChecker=setInterval(function(){me.print(template,null,function(args){if(args&&args.exception&&args.exception.message){OB.info('Error checking the status of the drawer');me.drawerClosed=true;}else{if(args.resultData==="Closed"){me.drawerClosed=true;errorCounter=0;}else if(args.resultData==="Opened"){me.drawerClosed=false;errorCounter=0;if(popup&&!popupDrawerOpened.showing){OB.UTIL.showLoading(false);popupDrawerOpened.show();}}else if(args.resultData==="Error"){errorCounter++;if(popup){if(errorCounter>=15){me.drawerClosed=true;OB.info('Error checking the status of the drawer');}else{me.drawerClosed=false;if(!popupDrawerOpened.showing){OB.UTIL.showLoading(false);popupDrawerOpened.show();}}}else{if(errorCounter>=4){me.drawerClosed=true;OB.info('Error checking the status of the drawer');}else{me.drawerClosed=false;}}}else{me.drawerClosed=true;OB.info('Error checking the status of the drawer');}}
if(me.drawerClosed){clearTimeout(beepTimeout);sound.pause();clearInterval(statusChecker);if(popup&&popupDrawerOpened.showing){popupDrawerOpened.hide();}}});},700);};OB.DS.HWServer.prototype.print=function(template,params,callback){if(template){if(template.getData){var me=this;template.getData(function(data){me.print(data,params,callback);});}else{this._print(template,params,callback);}}};OB.DS.HWServer.prototype._print=function(templatedata,params,callback){var promisedata=function(template){return new Promise(function(resolve,reject){template.getData(function(){resolve();});});};var computeddata;try{computeddata=this._template(templatedata,params).trim();if(computeddata.substr(0,6)==='jrxml:'){var returnedparams=JSON.parse(computeddata.substr(6));var getdatas=[];var i=0;var me=this;var newtemplate=new OB.DS.HWResource(returnedparams.report);newtemplate.ispdf=true;newtemplate.printer=returnedparams.printer||1;newtemplate.dateFormat=OB.Format.date;getdatas.push(promisedata(newtemplate));newtemplate.subreports=[];for(i=0;i<returnedparams.subreports.length;i++){newtemplate.subreports[i]=new OB.DS.HWResource(returnedparams.subreports[i]);getdatas.push(promisedata(newtemplate.subreports[i]));}
Promise.all(getdatas).then(function(){me._printPDF({param:params.order.serializeToJSON(),mainReport:newtemplate,subReports:newtemplate.subreports},callback);});}else{this._send(computeddata,callback);}}catch(ex){OB.error('Error computing the template to print.',ex);callback({data:templatedata,exception:{message:OB.I18N.getLabel('OBPOS_MsgPrintError')}});}};OB.DS.HWServer.prototype._template=function(templatedata,params){return params?_.template(templatedata,params):templatedata;};OB.DS.HWServer.prototype._send=function(data,callback){if(this.url){var me=this;var ajaxRequest=new enyo.Ajax({url:me.url,cacheBust:false,method:'POST',handleAs:'json',timeout:20000,contentType:'application/xml;charset=utf-8',data:data,success:function(inSender,inResponse){if(callback){callback(inResponse,data);}},fail:function(inSender,inResponse){if(this.failed){return;}
this.failed=true;if(callback){callback({data:data,exception:{message:(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'))}});}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'));}}});ajaxRequest.go(ajaxRequest.data).response('success').error('fail');}};OB.DS.HWServer.prototype._printPDF=function(params,callback){this._sendPDF(JSON.stringify(params),callback);};OB.DS.HWServer.prototype._sendPDF=function(data,callback){if(this.url){var me=this;var ajaxRequest=new enyo.Ajax({url:me.url+'pdf',cacheBust:false,method:'POST',handleAs:'json',timeout:20000,contentType:'application/json;charset=utf-8',data:data,success:function(inSender,inResponse){if(callback){callback(inResponse);}},fail:function(inSender,inResponse){if(this.failed){return;}
this.failed=true;if(callback){callback({exception:{data:data,message:(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'))}});}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'));}}});ajaxRequest.go(ajaxRequest.data).response('success').error('fail');}};OB.UTIL=window.OB.UTIL||{};OB.UTIL.isDisableDiscount=function(receipt,callback){if(receipt.get('lines').length>0){OB.Dal.findUsingCache('ManualDiscountsExist',OB.Model.Discount,{_whereClause:"where m_offer_type_id in ("+OB.Model.Discounts.getManualPromotions()+")"},function(promos){if(promos.length===0){callback(true);}else{callback(false);}},function(){callback(true);});}else{callback(true);}};OB.UTIL.getImageURL=function(id){var imageUrl='productImages/';var i;for(i=0;i<id.length;i+=3){if(i!==0){imageUrl+="/";}
imageUrl+=id.substring(i,((i+3)<id.length)?(i+3):id.length);}
imageUrl+="/"+id;return imageUrl;};OB.UTIL.getNumberOfSequence=function(documentNo,isQuotation){if(!OB.UTIL.isNullOrUndefined(OB.MobileApp.model.get('terminal'))&&!OB.UTIL.isNullOrUndefined(OB.MobileApp.model.get('terminal')).docNoPrefix){var posDocumentNoPrefix=OB.MobileApp.model.get('terminal').docNoPrefix;if(isQuotation){posDocumentNoPrefix=OB.MobileApp.model.get('terminal').quotationDocNoPrefix;}
return parseInt(documentNo.substr(posDocumentNoPrefix.length+1),10);}else{return null;}};OB.UTIL.currency={conversions:[],webPOSDefaultCurrencyId:function(){return OB.MobileApp.model.get('currency').id.toString();},isDefaultCurrencyId:function(currencyId){OB.UTIL.Debug.isDefined(currencyId,"Missing required argument 'currencyId' in OB.UTIL.currency.isDefaultCurrencyId");currencyId=currencyId.toString();return currencyId===OB.UTIL.currency.webPOSDefaultCurrencyId();},addConversion:function(fromCurrencyId,toCurrencyId,rate){OB.UTIL.Debug.isDefined(fromCurrencyId,"Missing required argument 'fromCurrencyId' in OB.UTIL.currency.addConversion");OB.UTIL.Debug.isDefined(toCurrencyId,"Missing required argument 'toCurrencyId' in OB.UTIL.currency.addConversion");OB.UTIL.Debug.isDefined(rate,"Missing required argument 'rate' in OB.UTIL.currency.addConversion");fromCurrencyId=fromCurrencyId.toString();toCurrencyId=toCurrencyId.toString();rate=parseFloat(rate,10);if(fromCurrencyId===toCurrencyId){OB.error('There is no point in converting a currencyId to itself');return;}
var conversionAlreadyExists=this.findConverter(fromCurrencyId,toCurrencyId);if(conversionAlreadyExists){if(conversionAlreadyExists.rate!==rate){OB.error('The rate for a currency is trying to be changed. If you are not trying to change the rate, something needs critical and inmediate fixing. If you really want to change the rate and know what you are doing, clean the OB.UTIL.currency.conversions array and fill it again.');}
return;}
this.conversions.push({fromCurrencyId:fromCurrencyId,toCurrencyId:toCurrencyId,rate:rate,toCurrencyIdPrecision:OB.DEC.getScale(),isToCurrencyIdForeign:toCurrencyId!==OB.UTIL.currency.webPOSDefaultCurrencyId(),getTangibleOf:function(amountToRound){if(this.toCurrencyId===OB.UTIL.currency.webPOSDefaultCurrencyId()){OB.error('You cannot get a tangible of a foreign currency because it has already a value in local currency. If you are trying to get the amount for a financial account, use the getFinancialAmountOf function');return;}
return OB.DEC.mul(amountToRound,rate,OB.UTIL.currency.toCurrencyIdPrecision);},getFinancialAmountOf:function(amount){if(this.fromCurrencyId===OB.UTIL.currency.webPOSDefaultCurrencyId()){OB.error('You are trying to get a financial amount value that is not from a foreign currency');return;}
return OB.DEC.mul(amount,rate);},toString:function(){return this.fromCurrencyId+' -> '+this.toCurrencyId+'; rate:'+this.rate.toFixed(5);}});},getConversions:function(){return this.conversions;},findConverter:function(fromCurrencyId,toCurrencyId){OB.UTIL.Debug.isDefined(fromCurrencyId,"Missing required argument 'fromCurrencyId' in OB.UTIL.currency.findConverter");OB.UTIL.Debug.isDefined(toCurrencyId,"Missing required argument 'toCurrencyId' in OB.UTIL.currency.findConverter");fromCurrencyId=fromCurrencyId.toString();toCurrencyId=toCurrencyId.toString();return _.find(this.conversions,function(c){return(c.fromCurrencyId===fromCurrencyId)&&(c.toCurrencyId===toCurrencyId);});},getConverter:function(fromCurrencyId,toCurrencyId){OB.UTIL.Debug.isDefined(fromCurrencyId,"Missing required argument 'fromCurrencyId' in OB.UTIL.currency.getConverter");OB.UTIL.Debug.isDefined(toCurrencyId,"Missing required argument 'toCurrencyId' in OB.UTIL.currency.getConverter");fromCurrencyId=fromCurrencyId.toString();toCurrencyId=toCurrencyId.toString();var found=this.findConverter(fromCurrencyId,toCurrencyId);if(!found){OB.error('Currency converter not added: '+fromCurrencyId+' -> '+toCurrencyId);}
return found;},getToLocalConverter:function(fromCurrencyId){OB.UTIL.Debug.isDefined(fromCurrencyId,"Missing required argument 'fromCurrencyId' in OB.UTIL.currency.getToLocalConverter");fromCurrencyId=fromCurrencyId.toString();return this.getConverter(fromCurrencyId,this.webPOSDefaultCurrencyId());},getFromLocalConverter:function(toCurrencyId){OB.UTIL.Debug.isDefined(toCurrencyId,"Missing required argument 'toCurrencyId' in OB.UTIL.currency.getFromLocalConverter");toCurrencyId=toCurrencyId.toString();return this.getConverter(this.webPOSDefaultCurrencyId(),toCurrencyId);},toDefaultCurrency:function(fromCurrencyId,amount){OB.UTIL.Debug.isDefined(fromCurrencyId,"Missing required argument 'fromCurrencyId' in OB.UTIL.currency.toDefaultCurrency");OB.UTIL.Debug.isDefined(amount,"Missing required argument 'amount' in OB.UTIL.currency.toDefaultCurrency");fromCurrencyId=fromCurrencyId.toString();if(fromCurrencyId===this.webPOSDefaultCurrencyId()){return amount;}
var converter=this.getToLocalConverter(fromCurrencyId);var foreignAmount=converter.getFinancialAmountOf(amount);return foreignAmount;},toForeignCurrency:function(toCurrencyId,amount){OB.UTIL.Debug.isDefined(toCurrencyId,"Missing required argument 'toCurrencyId' in OB.UTIL.currency.toForeignCurrency");OB.UTIL.Debug.isDefined(amount,"Missing required argument 'amount' in OB.UTIL.currency.toForeignCurrency");toCurrencyId=toCurrencyId.toString();if(toCurrencyId===this.webPOSDefaultCurrencyId()){return amount;}
var converter=this.getFromLocalConverter(toCurrencyId);var foreignAmount=converter.getTangibleOf(amount);return foreignAmount;}};OB.UTIL.Math=window.OB.UTIL.Math||{};OB.UTIL.Math.sign=function(x){x=+x;if(x===0||isNaN(x)){return x;}
return x>0?1:-1;};OB.UTIL.getPriceListName=function(priceListId,callback){if(priceListId){if(OB.MobileApp.model.get('pricelist').id===priceListId){callback(OB.MobileApp.model.get('pricelist').name);}else{OB.Dal.get(OB.Model.PriceList,priceListId,function(pList){callback(pList.get('name'));});}}else{callback('');}};(function(){var BPCategory=OB.Data.ExtensibleModel.extend({modelName:'BPCategory',tableName:'c_bp_group',entityName:'BPCategory',source:'org.openbravo.retail.posterminal.master.BPCategory',dataLimit:OB.Dal.DATALIMIT});BPCategory.addProperties([{name:'id',column:'c_bp_group_id',primaryKey:true,type:'TEXT'},{name:'searchKey',column:'value',type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);OB.Data.Registry.registerModel(BPCategory);}());(function(){var BPLocation=OB.Data.ExtensibleModel.extend({modelName:'BPLocation',tableName:'c_bpartner_location',entityName:'BPLocation',source:'org.openbravo.retail.posterminal.master.BPLocation',dataLimit:OB.Dal.DATALIMIT,local:false,remote:'OBPOS_remote.customer',saveCustomerAddr:function(silent){var nameLength,newSk;this.set('_identifier',this.get('name'));this.trigger('customerAddrSaved');return true;},loadById:function(CusAddrId,userCallback){var me=this;OB.Dal.get(OB.Model.BPLocation,CusAddrId,function(customerAddr){var successCallback,errorCallback;if(!customerAddr||customerAddr.length===0){me.clearModelWith(null);userCallback(me);}else{me.clearModelWith(customerAddr);userCallback(me);}});},newCustomerAddr:function(){this.trigger('beforeChangeCustomerAddrForNewOne',this);this.clearModelWith(null);},clearModelWith:function(cusToLoad){var me=this,undf;if(cusToLoad===null){OB.UTIL.clone(new OB.Model.BPLocation(),this);this.set('countryId',OB.MobileApp.model.get('terminal').defaultbp_bpcountry);this.set('countryName',OB.MobileApp.model.get('terminal').defaultbp_bpcountry_name);this.set('client',OB.MobileApp.model.get('terminal').client);this.set('organization',OB.MobileApp.model.get('terminal').defaultbp_bporg);}else{OB.UTIL.clone(cusToLoad,this);}},loadByJSON:function(obj){var me=this,undf;_.each(_.keys(me.attributes),function(key){if(obj[key]!==undf){if(obj[key]===null){me.set(key,null);}else{me.set(key,obj[key]);}}});},serializeToJSON:function(){return JSON.parse(JSON.stringify(this.toJSON()));}});BPLocation.addProperties([{name:'id',column:'c_bpartner_location_id',primaryKey:true,type:'TEXT'},{name:'bpartner',column:'c_bpartner_id',type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'postalCode',column:'postalCode',type:'TEXT'},{name:'cityName',column:'cityName',type:'TEXT'},{name:'countryName',column:'countryName',type:'TEXT'},{name:'countryId',column:'countryId',type:'TEXT'},{name:'regionName',column:'regionName',type:'TEXT'},{name:'regionId',column:'regionId',type:'TEXT'},{name:'_identifier',column:'_identifier',filter:true,type:'TEXT'}]);BPLocation.addIndex([{name:'bploc_name_idx',columns:[{name:'name',sort:'desc'}]}]);OB.Data.Registry.registerModel(BPLocation);}());(function(){var CurrencyPanel=OB.Data.ExtensibleModel.extend({modelName:'CurrencyPanel',tableName:'obpos_currency_panel',entityName:'OBPOS_CurrencyPanel',source:'org.openbravo.retail.posterminal.master.CurrencyPanel'});CurrencyPanel.addProperties([{name:'id',column:'obpos_currency_panel_id',primaryKey:true,type:'TEXT'},{name:'currency',column:'c_currency_id',type:'TEXT'},{name:'amount',column:'amount',type:'NUMERIC'},{name:'backcolor',column:'backcolor',type:'TEXT'},{name:'bordercolor',column:'bordercolor',type:'TEXT'},{name:'lineNo',column:'line',type:'NUMERIC'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);CurrencyPanel.addIndex([{name:'currency_panel_idx',columns:[{name:'c_currency_id',sort:'desc'}]}]);OB.Data.Registry.registerModel(CurrencyPanel);}());(function(){var SalesRepresentative=OB.Data.ExtensibleModel.extend({modelName:'SalesRepresentative',tableName:'ad_sales_representative',entityName:'SalesRepresentative',source:'org.openbravo.retail.posterminal.master.SalesRepresentative',remote:'OBPOS_remote.customer',dataLimit:OB.Dal.DATALIMIT});SalesRepresentative.addProperties([{name:'id',column:'ad_sales_representative_id',primaryKey:true,type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'username',column:'username',type:'TEXT'},{name:'_identifier',column:'_identifier',filter:true,type:'TEXT'}]);SalesRepresentative.addIndex([{name:'salesrep_identifier_idx',columns:[{name:'_identifier',sort:'desc'}]}]);OB.Data.Registry.registerModel(SalesRepresentative);}());(function(){var ProductCharacteristicValue=OB.Data.ExtensibleModel.extend({modelName:'ProductCharacteristicValue',tableName:'m_product_ch_value',entityName:'ProductCharacteristicValue',source:'org.openbravo.retail.posterminal.master.ProductCharacteristicValue',includeTerminalDate:true,remote:'OBPOS_remote.product',dataLimit:OB.Dal.DATALIMIT});ProductCharacteristicValue.addProperties([{name:'id',column:'m_product_ch_value_id',primaryKey:true,type:'TEXT'},{name:'product',column:'m_product_id',type:'TEXT'},{name:'characteristic',column:'m_characteristic_id',type:'TEXT'},{name:'characteristicValue',column:'m_ch_value_id',type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'},{name:'active',column:'active',type:'TEXT'},{name:'obposFilteronwebpos',column:'obposFilteronwebpos',type:'TEXT'}]);ProductCharacteristicValue.addIndex([{name:'m_ch_vl_prod_idx',columns:[{name:'m_ch_value_id',sort:'desc'},{name:'m_product_id',sort:'desc'}]}]);OB.Data.Registry.registerModel(ProductCharacteristicValue);}());(function(){var CharacteristicValue=OB.Data.ExtensibleModel.extend({modelName:'CharacteristicValue',tableName:'m_ch_value',entityName:'CharacteristicValue',remote:'OBPOS_remote.product',dataLimit:OB.Dal.DATALIMIT,source:'org.openbravo.retail.posterminal.master.CharacteristicValue'});CharacteristicValue.addProperties([{name:'id',column:'id',primaryKey:true,type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'characteristic_id',column:'characteristic_id',type:'TEXT'},{name:'parent',column:'parent',type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);OB.Data.Registry.registerModel(CharacteristicValue);}());(function(){var Characteristic=OB.Data.ExtensibleModel.extend({modelName:'Characteristic',tableName:'m_characteristic',entityName:'Characteristic',remote:'OBPOS_remote.product',dataLimit:OB.Dal.DATALIMIT,source:'org.openbravo.retail.posterminal.master.Characteristic'});Characteristic.addProperties([{name:'id',column:'id',primaryKey:true,type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);OB.Data.Registry.registerModel(Characteristic);}());(function(){var Brand=OB.Data.ExtensibleModel.extend({modelName:'Brand',tableName:'m_brand',entityName:'Brand',remote:'OBPOS_remote.product',source:'org.openbravo.retail.posterminal.master.Brand',dataLimit:OB.Dal.DATALIMIT});Brand.addProperties([{name:'id',column:'m_product_id',primaryKey:true,type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'_identifier',column:'_identifier',filter:true,type:'TEXT'}]);OB.Data.Registry.registerModel(Brand);}());(function(){var ReturnReason=OB.Data.ExtensibleModel.extend({modelName:'ReturnReason',tableName:'c_return_reason',entityName:'ReturnReason',source:'org.openbravo.retail.posterminal.master.ReturnReason',dataLimit:OB.Dal.DATALIMIT});ReturnReason.addProperties([{name:'id',column:'c_return_reason_id',primaryKey:true,type:'TEXT'},{name:'searchKey',column:'searchKey',type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);OB.Data.Registry.registerModel(ReturnReason);}());OB.Model.Executor=Backbone.Model.extend({defaults:{executing:false},initialize:function(){var eventQueue=new Backbone.Collection();this.set('eventQueue',eventQueue);this.set('actionQueue',new Backbone.Collection());eventQueue.on('add',function(event){if(!this.get('executing')&&!event.get('avoidTrigger')){this.nextEvent();}
event.set('avoidTrigger',false);},this);},removeGroup:function(groupId){var evtQueue=this.get('eventQueue');evtQueue.where({groupId:groupId}).forEach(function(evt){evt.reportSynchronizationHelper();evtQueue.remove(evt);},this);this.set('eventQueue',evtQueue);},addEvent:function(event,replaceExistent){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('executor');var evtQueue=this.get('eventQueue'),currentEvt,actionQueue,currentExecutionQueue;if(replaceExistent&&evtQueue){currentEvt=this.get('currentEvent');evtQueue.where({id:event.get('id')}).forEach(function(evt){if(currentEvt===evt){this.set('eventQueue');actionQueue.remove(actionQueue.models);}
if(evt.reportSynchronizationHelper){evt.reportSynchronizationHelper();}
evtQueue.remove(evt);currentExecutionQueue=(this.get('exec')||0)-1;this.set('exec',currentExecutionQueue);},this);}
this.set('exec',(this.get('exec')||0)+1);event.reportSynchronizationHelper=function(){OB.UTIL.SynchronizationHelper.finished(synchId,'executor');};event.on('finish',function(){event.reportSynchronizationHelper();var currentExecutionQueue=(this.get('exec')||0)-1;this.set('exec',currentExecutionQueue);OB.debug('event execution time',(new Date().getTime())-event.get('start'),currentExecutionQueue);if(currentExecutionQueue===0&&event.get('receipt')){event.get('receipt').trigger('eventExecutionDone');}},this);evtQueue.add(event);},preEvent:function(){},postEvent:function(){},nextEvent:function(){var evt=this.get('eventQueue').shift(),previousEvt=this.get('currentEvent');if(previousEvt){previousEvt.trigger('finish');this.postEvent();}
if(evt){this.preEvent();this.set('executing',true);this.set('currentEvent',evt);evt.set('start',new Date().getTime());evt.on('actionsCreated',function(){this.preAction(evt);this.nextAction(evt);},this);this.createActions(evt);}else{this.set('executing',false);this.set('currentEvent',null);}},preAction:function(event){},nextAction:function(event){var action=this.get('actionQueue').shift();if(action){action.get('action').call(this,action.get('args'),event,action.get('promCandidates'));}else{this.postAction(event);this.nextEvent();}},postAction:function(event){},createActions:function(event){}});OB.Model.DiscountsExecutor=OB.Model.Executor.extend({criteriaParams:['date','bpId','bpId','bpId','bpId','productId','productId','productId','productId','productId','productId','priceListId','priceListId'],paramsTranslation:{bpId:{model:'receipt',property:'bp'},productId:{model:'line',property:'product'},priceListId:{model:'receipt',property:'priceList'},date:{model:'receipt',property:'orderDate'}},convertParams:function(evt,line,receipt,pTrl){var translatedParams=[];_.forEach(this.criteriaParams,function(param){var paraTrl,model;paraTrl=pTrl[param];if(!paraTrl){window.console.error('Not found param to calculate discounts',param);return;}
if(paraTrl.model==='receipt'){model=receipt;}else if(paraTrl.model==='line'){model=line;}else{model=evt.get(paraTrl.model);}
if(param==='date'){translatedParams.push(OB.I18N.formatDateISO(new Date()));}else{translatedParams.push(model.get(paraTrl.property).id?model.get(paraTrl.property).id:model.get(paraTrl.property));}});return translatedParams;},createActions:function(evt){var line=evt.get('line'),receipt=evt.get('receipt'),bpId=receipt.get('bp').id,productId=line.get('product').id,actionQueue=this.get('actionQueue'),me=this,criteria,t0=new Date().getTime(),whereClause=OB.Model.Discounts.computeStandardFilter(receipt)
+" AND M_OFFER_TYPE_ID NOT IN ("+OB.Model.Discounts.getManualPromotions()+")"
+" AND ((EM_OBDISC_ROLE_SELECTION = 'Y' AND NOT EXISTS (SELECT 1 FROM OBDISC_OFFER_ROLE WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID "+" AND AD_ROLE_ID = '"+OB.MobileApp.model.get('context').role.id+"')) OR (EM_OBDISC_ROLE_SELECTION = 'N' "
+" AND EXISTS (SELECT 1 FROM OBDISC_OFFER_ROLE WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID "
+" AND AD_ROLE_ID = '"+OB.MobileApp.model.get('context').role.id+"')))";if(!receipt.shouldApplyPromotions()||line.get('product').get('ignorePromotions')){evt.trigger('actionsCreated');return;}
criteria={'_whereClause':whereClause,params:this.convertParams(evt,line,receipt,this.paramsTranslation)};OB.Dal.findUsingCache('discountsCache',OB.Model.Discount,criteria,function(d){if(d.size()===0){line.set('noDiscountCandidates',true,{silent:true});}
d.forEach(function(disc){actionQueue.add({action:me.applyRule,args:disc,promCandidates:d,avoidTrigger:true});});evt.trigger('actionsCreated');},function(){OB.error('Error getting promotions',arguments);});},applyRule:function(disc,evt,promCandidates){var receipt=evt.get('receipt'),line=evt.get('line'),rule=OB.Model.Discounts.discountRules[disc.get('discountType')],ds,ruleListener;if(line.stopApplyingPromotions()){this.nextAction(evt);return;}
if(rule&&rule.implementation){if(rule.async){ruleListener=new Backbone.Model();ruleListener.on('completed',function(obj){if(obj&&obj.alerts){var localArrayMessages=line.get('promotionMessages')||[];localArrayMessages.push(obj.alerts);line.set('promotionMessages',localArrayMessages);}
ruleListener.off('completed');this.nextAction(evt);},this);}
ds=rule.implementation(disc,receipt,line,ruleListener,promCandidates);if(ds&&ds.alerts){var localArrayMessages=line.get('promotionMessages')||[];localArrayMessages.push(ds.alerts);line.set('promotionMessages',localArrayMessages);}
if(!rule.async){this.nextAction(evt);}}else{OB.warn('No POS implementation for discount '+disc.get('discountType'));this.nextAction(evt);}},preEvent:function(){},postEvent:function(){},preAction:function(evt){var line=evt.get('line'),order=evt.get('receipt'),manualPromotions=[],appliedPromotions,appliedPack;appliedPromotions=line.get('promotions');if(appliedPromotions){if(line.lastAppliedPromotion()&&!line.lastAppliedPromotion().applyNext){manualPromotions.push(line.lastAppliedPromotion());}else{_.forEach(appliedPromotions,function(promotion){if(promotion.manual){manualPromotions.push(promotion);}});}}
appliedPack=line.isAffectedByPack();if(appliedPack){order.get('lines').forEach(function(l){var promos=l.get('promotions'),newPromos=[];if(!promos){return;}
promos.forEach(function(p){if(p.ruleId!==appliedPack.ruleId){newPromos.push(p);}});l.set('promotions',newPromos);});}
if(!line.get('originalOrderLineId')){line.set({promotions:null,discountedLinePrice:null,promotionCandidates:null});}
_.forEach(manualPromotions,function(promo){var promotion={rule:new Backbone.Model(promo),definition:{userAmt:promo.userAmt,applyNext:promo.applyNext,lastApplied:promo.lastApplied},alreadyCalculated:true};OB.Model.Discounts.addManualPromotion(order,[line],promotion);});},postAction:function(evt){if(this.get('eventQueue').filter(function(p){return p.get('receipt')===evt.get('receipt');}).length===0){evt.get('receipt').trigger('discountsApplied');}
if(!evt.get('skipSave')&&evt.get('receipt')&&evt.get('receipt').get('lines')&&evt.get('receipt').get('lines').length>0){evt.get('receipt').save();}}});(function(){OB.Model.TerminalWindowModel=OB.Model.WindowModel.extend({approvedRequest:function(approved,supervisor,approvalType,callback){if(enyo.isFunction(callback)){callback(approved,supervisor,approvalType);}},checkApproval:function(approvalType,username,password,callback){OB.Dal.initCache(OB.Model.Supervisor,[],null,null);var approvalList=[];approvalType.forEach(function(approvalType){approvalList.push(typeof(approvalType)==='object'?approvalType.approval:approvalType);});new OB.DS.Process('org.openbravo.retail.posterminal.utility.CheckApproval').exec({u:username,p:password,approvalType:JSON.stringify(approvalList)},enyo.bind(this,function(response,message){var approved=false;if(response.exception){OB.UTIL.showError(response.exception.message);this.approvedRequest(false,null,null,callback);}else{approved=response.canApprove;if(!approved){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_UserCannotApprove'));}
OB.Dal.find(OB.Model.Supervisor,{'id':response.userId},enyo.bind(this,function(users){var supervisor,date,permissions=[];if(users.models.length===0){if(response.canApprove){date=new Date().toString();supervisor=new OB.Model.Supervisor();supervisor.set('id',response.userId);supervisor.set('name',username);supervisor.set('password',OB.MobileApp.model.generate_sha1(password+date));supervisor.set('created',date);if(response.preference){_.each(response.preference,function(perm){permissions.push(perm);},this);supervisor.set('permissions',JSON.stringify(permissions));}else{supervisor.set('permissions',JSON.stringify(approvalType));}
OB.Dal.save(supervisor,null,null,true);}}else{supervisor=users.models[0];supervisor.set('password',OB.MobileApp.model.generate_sha1(password+supervisor.get('created')));if(supervisor.get('permissions')){permissions=JSON.parse(supervisor.get('permissions'));}
if(response.canApprove){_.each(approvalType,function(perm){if(!_.contains(permissions,perm)){permissions.push(perm);}},this);}else{_.each(approvalType,function(perm){if(_.contains(permissions,perm)){permissions=_.without(permissions,perm);}},this);}
supervisor.set('permissions',JSON.stringify(permissions));OB.Dal.save(supervisor);}
this.approvedRequest(approved,supervisor,approvalType,callback);}));}}),enyo.bind(this,function(){OB.Dal.find(OB.Model.Supervisor,{'name':username},enyo.bind(this,function(users){var supervisor,countApprovals=0,approved=false;if(users.models.length===0){countApprovals=0;OB.Dal.find(OB.Model.User,null,enyo.bind(this,function(users){_.each(users.models,function(user){if(username===user.get('name')&&user.get('password')===OB.MobileApp.model.generate_sha1(password+user.get('created'))){_.each(approvalType,function(perm){if(JSON.parse(user.get('terminalinfo')).permissions[perm]){countApprovals+=1;supervisor=user;}},this);}});if(countApprovals===approvalType.length){approved=true;this.approvedRequest(approved,supervisor,approvalType,callback);}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_UserCannotApprove'));}}),function(){});}else{supervisor=users.models[0];if(supervisor.get('password')===OB.MobileApp.model.generate_sha1(password+supervisor.get('created'))){_.each(approvalType,function(perm){if(_.contains(JSON.parse(supervisor.get('permissions')),perm)){countApprovals+=1;}},this);if(countApprovals===approvalType.length){approved=true;this.approvedRequest(approved,supervisor,approvalType,callback);}else{countApprovals=0;OB.Dal.find(OB.Model.User,null,enyo.bind(this,function(users){_.each(users.models,function(user){if(username===user.get('name')&&user.get('password')===OB.MobileApp.model.generate_sha1(password+user.get('created'))){_.each(approvalType,function(perm){if(JSON.parse(user.get('terminalinfo')).permissions[perm]){countApprovals+=1;supervisor=user;}},this);}});if(countApprovals===approvalType.length){approved=true;this.approvedRequest(approved,supervisor,approvalType,callback);}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_UserCannotApprove'));}}),function(){});}}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_InvalidUserPassword'));}}}),function(){});}));}});}());(function(){var PaymentMethodCashUp=OB.Data.ExtensibleModel.extend({modelName:'PaymentMethodCashUp',tableName:'paymentmethodcashup',entityName:'PaymentMethodCashUp',source:'',local:true});PaymentMethodCashUp.addProperties([{name:'id',column:'paymentmethodcashup_id',primaryKey:true,type:'TEXT'},{name:'paymentmethod_id',column:'paymentmethod_id',type:'TEXT'},{name:'searchKey',column:'searchKey',type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'startingCash',column:'startingCash',type:'NUMERIC'},{name:'totalSales',column:'totalSales',type:'NUMERIC'},{name:'totalReturns',column:'totalReturns',type:'NUMERIC'},{name:'totalDeposits',column:'totalDeposits',type:'NUMERIC'},{name:'totalDrops',column:'totalDrops',type:'NUMERIC'},{name:'rate',column:'rate',type:'NUMERIC'},{name:'cashup_id',column:'cashup_id',type:'TEXT'},{name:'isocode',column:'isocode',type:'TEXT'}]);OB.Data.Registry.registerModel(PaymentMethodCashUp);}());(function(){var TaxCashUp=OB.Data.ExtensibleModel.extend({modelName:'TaxCashUp',tableName:'taxcashup',entityName:'TaxCashUp',source:'',local:true});TaxCashUp.addProperties([{name:'id',column:'taxcashup_id',primaryKey:true,type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'amount',column:'amount',type:'NUMERIC'},{name:'orderType',column:'orderType',type:'TEXT'},{name:'cashup_id',column:'cashup_id',type:'TEXT'}]);OB.Data.Registry.registerModel(TaxCashUp);}());(function(){var ReturnReason=OB.Data.ExtensibleModel.extend({modelName:'ReturnReason',tableName:'c_return_reason',entityName:'ReturnReason',source:'org.openbravo.retail.posterminal.master.ReturnReason',dataLimit:OB.Dal.DATALIMIT});ReturnReason.addProperties([{name:'id',column:'c_return_reason_id',primaryKey:true,type:'TEXT'},{name:'searchKey',column:'searchKey',type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);OB.Data.Registry.registerModel(ReturnReason);}());(function(){var OfflinePrinter=OB.Data.ExtensibleModel.extend({modelName:'OfflinePrinter',tableName:'OfflinePrinter',entityName:'OfflinePrinter',source:'',local:true});OfflinePrinter.addProperties([{name:'id',column:'offline_id',primaryKey:true,type:'TEXT'},{name:'data',column:'data',type:'TEXT'},{name:'sendfunction',column:'sendfunction',type:'TEXT'}]);OfflinePrinter.printPendingJobs=function(){OB.Dal.find(OB.Model.OfflinePrinter,{},function(jobs){OB.Model.OfflinePrinter._printPendingJobs(jobs);});};OfflinePrinter._printPendingJobs=function(jobs){var job,sendfunction;if(jobs.length>0){job=jobs.at(0);OB.POS.hwserver[job.get('sendfunction')](job.get('data'),function(result){if(result&&result.exception){OB.UTIL.showError(result.exception.message);}else{OB.Dal.remove(job);jobs.remove(job);OB.Model.OfflinePrinter._printPendingJobs(jobs);}});}};OB.Data.Registry.registerModel(OfflinePrinter);}());(function(){var ProductBOM=OB.Data.ExtensibleModel.extend({modelName:'ProductBOM',tableName:'m_product_bom',entityName:'ProductBOM',source:'org.openbravo.retail.posterminal.master.ProductBOM'});ProductBOM.addProperties([{name:'id',column:'id',primaryKey:true,type:'TEXT'},{name:'product',column:'product',type:'TEXT'},{name:'bomproduct',column:'bomproduct',type:'TEXT'},{name:'bomtaxcategory',column:'bomtaxcategory',type:'TEXT'},{name:'bomquantity',column:'bomquantity',type:'NUMERIC'},{name:'bomprice',column:'bomprice',type:'NUMERIC'}]);ProductBOM.addIndex([{name:'obpos_productbom',columns:[{name:'product',sort:'asc'}]}]);OB.Data.Registry.registerModel(ProductBOM);}());(function(){var TaxCategoryBOM=OB.Data.ExtensibleModel.extend({modelName:'TaxCategoryBOM',tableName:'c_taxcategory_bom',entityName:'FinancialMgmtTaxCategory',source:'org.openbravo.retail.posterminal.master.TaxCategoryBOM'});TaxCategoryBOM.addProperties([{name:'id',column:'id',primaryKey:true,type:'TEXT'}]);OB.Data.Registry.registerModel(TaxCategoryBOM);}());enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalCancel',popup:'modalCancel',i18nHeader:'OBMOBC_LblCancel',bodyContent:{i18nContent:'OBPOS_ProcessCancelDialog'},bodyButtons:{components:[{kind:'OB.UI.ModalCancel_OkButton'},{kind:'OB.UI.ModalCancel_CancelButton'}]}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ModalCancel_OkButton',i18nContent:'OBMOBC_LblOk',isDefaultAction:true,popup:'modalCancel',tap:function(){this.doHideThisPopup();OB.POS.navigate('retail.pointofsale');}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ModalCancel_CancelButton',i18nContent:'OBMOBC_LblCancel',popup:'modalCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({name:'OB.UI.Subwindow',kind:'enyo.Popup',modal:false,autoDismiss:false,floating:false,events:{onChangeSubWindow:''},classes:'subwindow',showing:false,handlers:{onkeydown:'keydownHandler'},keydownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===27&&this.showing){this.$.subWindowHeader.getComponents()[0].onTapCloseButton();return true;}else if(keyCode===13&&this.defaultActionButton){this.defaultActionButton.executeTapAction();return true;}else{return false;}},showingChanged:function(){this.inherited(arguments);if(this.showing){this.originalScanMode=OB.MobileApp.view.scanMode;OB.MobileApp.view.scanningFocus(false);OB.MobileApp.view.openedSubwindow=this;this.setDefaultActionButton();}else{OB.MobileApp.view.scanningFocus(this.originalScanMode);OB.MobileApp.view.openedSubwindow=null;}},focusInPopup:function(){var allChildsArray=OB.UTIL.getAllChildsSorted(this),isFirstFocusableElementObtained=false,tagName,element,i;for(i=0;i<allChildsArray.length;i++){if(allChildsArray[i].hasNode()&&allChildsArray[i].hasNode().tagName){tagName=allChildsArray[i].hasNode().tagName.toUpperCase();}else{tagName='';}
if((tagName==='INPUT'||tagName==='SELECT'||tagName==='TEXTAREA'||tagName==='BUTTON')&&allChildsArray[i].showing&&!isFirstFocusableElementObtained){element=allChildsArray[i];isFirstFocusableElementObtained=true;}else if(allChildsArray[i].isFirstFocus){element=allChildsArray[i];break;}}
if(element){element.focus();}
return true;},setDefaultActionButton:function(element){var allChildsArray,tagName,i;if(element){allChildsArray=[element];}else{allChildsArray=OB.UTIL.getAllChildsSorted(this);}
for(i=0;i<allChildsArray.length;i++){if(allChildsArray[i].hasNode()&&allChildsArray[i].hasNode().tagName){tagName=allChildsArray[i].hasNode().tagName.toUpperCase();}else{tagName='';}
if(tagName==='BUTTON'&&allChildsArray[i].isDefaultAction){element=allChildsArray[i];break;}}
if(element){this.defaultActionButton=element;}
return true;},mainBeforeSetShowing:function(args){var valueToReturn=true;if(args.caller){this.caller=args.caller;}
if(args.navigateOnClose){this.navigateOnClose=args.navigateOnClose;}else{this.navigateOnClose=this.defaultNavigateOnClose;}
if(this.beforeSetShowing){valueToReturn=this.beforeSetShowing(args);}
return valueToReturn;},mainAfterShow:function(args){this.focusInPopup();if(this.afterShow){this.afterShow(args);}},mainBeforeClose:function(dest){var valueToReturn=true;if(dest){this.lastLeaveTo=dest;}
if(this.beforeClose){valueToReturn=this.beforeClose(dest);}
return valueToReturn;},header:{},body:{},goBack:function(){},components:[{name:'subWindowHeader'},{name:'subWindowBody'}],relComponentsWithSubWindow:function(comp,subWin){if(!comp||!comp.getComponents){return;}
enyo.forEach(comp.getComponents(),function(child){subWin.relComponentsWithSubWindow(child,subWin);child.subWindow=subWin;});},initComponents:function(){this.inherited(arguments);this.$.subWindowHeader.createComponent(this.header);this.$.subWindowBody.createComponent(this.body);this.relComponentsWithSubWindow(this,this);}});enyo.kind({name:'OB.UI.SubwindowHeader',classes:'subwindowheader',components:[{name:"closebutton",tag:'div',classes:'subwindow-closebutton',components:[{tag:'span',allowHtml:true,content:'&times;'}]},{classes:'subwindowheadertext',name:'headermessage'}],initComponents:function(){this.inherited(arguments);if(this.i18nHeaderMessage){this.$.headermessage.setContent(OB.I18N.getLabel(this.i18nHeaderMessage));}else if(this.headerMessage){this.$.headermessage.setContent(this.headermessage);}else{this.$.headermessage.setContent(OB.I18N.getLabel('OBPOS_TitleCustomerAdvancedSearch'));}
this.$.closebutton.headerContainer=this.$.closebutton.parent;this.$.closebutton.tap=this.onTapCloseButton;}});enyo.kind({name:'OB.UI.LeftSubWindow',classes:'span6',showing:false,events:{onShowLeftSubWindow:'',onCloseLeftSubWindow:''},components:[{style:'margin: 5px; height: 612px; background-color: white;',components:[{name:'leftSubWindowHeader'},{name:'leftSubWindowBody'}]}],mainBeforeSetShowing:function(params){if(this.beforeSetShowing){return this.beforeSetShowing(params);}
return true;},mainBeforeSetHidden:function(params){if(this.beforeSetHidden){return this.beforeSetHidden(params);}
return true;},relComponentsWithLeftSubWindow:function(comp,leftSubWin){if(!comp||!comp.getComponents){return;}
enyo.forEach(comp.getComponents(),function(child){leftSubWin.relComponentsWithLeftSubWindow(child,leftSubWin);child.leftSubWindow=leftSubWin;});},initComponents:function(){this.inherited(arguments);if(this.header){this.$.leftSubWindowHeader.createComponent(this.header);this.headerComponent=this.$.leftSubWindowHeader.getComponents()[0];}
if(this.body){this.$.leftSubWindowBody.createComponent(this.body);this.bodyComponent=this.$.leftSubWindowBody.getComponents()[0];}
this.relComponentsWithLeftSubWindow(this,this);}});enyo.kind({name:'OB.UI.ModalReceiptPropertiesImpl',kind:'OB.UI.ModalReceiptProperties',newAttributes:[{kind:'OB.UI.renderTextProperty',name:'receiptDescription',modelProperty:'description',i18nLabel:'OBPOS_LblDescription',maxLength:255},{kind:'OB.UI.renderBooleanProperty',name:'printBox',checked:true,classes:'modal-dialog-btn-check active',modelProperty:'print',i18nLabel:'OBPOS_Lbl_RP_Print'},{kind:'OB.UI.renderComboProperty',name:'salesRepresentativeBox',modelProperty:'salesRepresentative',i18nLabel:'OBPOS_SalesRepresentative',permission:'OBPOS_salesRepresentative.receipt',permissionOption:'OBPOS_SR.comboOrModal',retrievedPropertyForValue:'id',retrievedPropertyForText:'_identifier',init:function(model){this.collection=new OB.Collection.SalesRepresentativeList();this.model=model;this.doLoadValueNeeded=true;if(!OB.MobileApp.model.hasPermission(this.permission)){this.doLoadValueNeeded=false;this.parent.parent.parent.hide();}else{if(OB.MobileApp.model.hasPermission(this.permissionOption,true)){this.doLoadValueNeeded=false;this.parent.parent.parent.hide();}}},loadValue:function(){if(this.doLoadValueNeeded){OB.UI.renderComboProperty.prototype.loadValue.apply(this,arguments);}},fetchDataFunction:function(args){var me=this,actualUser;OB.Dal.find(OB.Model.SalesRepresentative,null,function(data){if(me.destroyed){return;}
if(data.length>0){data.unshift({id:null,_identifier:null});me.dataReadyFunction(data,args);}else{actualUser=new OB.Model.SalesRepresentative();actualUser.set('_identifier',me.model.get('order').get('salesRepresentative$_identifier'));actualUser.set('id',me.model.get('order').get('salesRepresentative'));data.models=[actualUser];me.dataReadyFunction(data,args);}},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_ErrorGettingSalesRepresentative'));me.dataReadyFunction(null,args);},args);}},{kind:'OB.UI.SalesRepresentative',name:'salesrepresentativebutton',i18nLabel:'OBPOS_SalesRepresentative',permission:'OBPOS_salesRepresentative.receipt',permissionOption:'OBPOS_SR.comboOrModal'}],resetProperties:function(){var p,att;for(p in this.newAttributes){if(this.newAttributes.hasOwnProperty(p)){att=this.$.bodyContent.$.attributes.$['line_'+this.newAttributes[p].name].$.newAttribute.$[this.newAttributes[p].name];if(att&&att.setValue){att.setValue('');}}}},init:function(model){this.setHeader(OB.I18N.getLabel('OBPOS_ReceiptPropertiesDialogTitle'));this.model=model.get('order');this.model.on('change',function(){var diff=this.model.changedAttributes(),att;for(att in diff){if(diff.hasOwnProperty(att)){this.loadValue(att);}}},this);this.model.on('paymentAccepted',function(){this.resetProperties();},this);}});enyo.kind({name:'OB.UI.ModalReceiptLinesProperties',kind:'OB.UI.ModalAction',handlers:{onApplyChanges:'applyChanges'},executeOnShow:function(){if(this.currentLine){var diff=this.propertycomponents;var att;for(att in diff){if(diff.hasOwnProperty(att)){this.loadValue(att,diff[att]);}}}
this.autoDismiss=true;if(this&&this.args&&this.args.autoDismiss===false){this.autoDismiss=false;}},executeOnHide:function(){if(this.args&&this.args.requiredFiedls&&this.args.requiredFieldNotPresentFunction){var smthgPending=_.find(this.args.requiredFiedls,function(fieldName){return OB.UTIL.isNullOrUndefined(this.currentLine.get(fieldName));},this);if(smthgPending){this.args.requiredFieldNotPresentFunction(this.currentLine,smthgPending);}}},i18nHeader:'OBPOS_ReceiptLinePropertiesDialogTitle',bodyContent:{kind:'Scroller',maxHeight:'225px',style:'background-color: #ffffff;',thumb:true,horizontal:'hidden',components:[{name:'attributes'}]},bodyButtons:{components:[{kind:'OB.UI.ReceiptPropertiesDialogApply',name:'receiptLinePropertiesApplyBtn'},{kind:'OB.UI.ReceiptPropertiesDialogCancel',name:'receiptLinePropertiesCancelBtn'}]},loadValue:function(mProperty,component){this.waterfall('onLoadValue',{model:this.currentLine,modelProperty:mProperty});if(component.showProperty){component.showProperty(this.currentLine,function(value){component.owner.owner.setShowing(value);});}},applyChanges:function(inSender,inEvent){var diff,att,result=true;diff=this.propertycomponents;for(att in diff){if(diff.hasOwnProperty(att)){if(diff[att].owner.owner.getShowing()){result=result&&diff[att].applyValue(this.currentLine);}}}
return result;},validationMessage:function(args){this.owner.doShowPopup({popup:'modalValidateAction',args:args});},initComponents:function(){this.inherited(arguments);this.attributeContainer=this.$.bodyContent.$.attributes;this.setHeader(OB.I18N.getLabel(this.i18nHeader));this.propertycomponents={};enyo.forEach(this.newAttributes,function(natt){var editline=this.$.bodyContent.$.attributes.createComponent({kind:'OB.UI.PropertyEditLine',name:'line_'+natt.name,newAttribute:natt});this.propertycomponents[natt.modelProperty]=editline.propertycomponent;this.propertycomponents[natt.modelProperty].propertiesDialog=this;},this);},init:function(model){this.model=model;this.model.get('order').get('lines').on('selected',function(lineSelected){var diff,att;this.currentLine=lineSelected;if(lineSelected){diff=this.propertycomponents;for(att in diff){if(diff.hasOwnProperty(att)){this.loadValue(att,diff[att]);}}}},this);}});enyo.kind({name:'OB.UI.ModalReceiptLinesPropertiesImpl',kind:'OB.UI.ModalReceiptLinesProperties',newAttributes:[{kind:'OB.UI.renderTextProperty',name:'receiptLineDescription',modelProperty:'description',style:'height: 30px; margin-bottom: 3px; padding: 3px;',i18nLabel:'OBPOS_LblDescription'}]});enyo.kind({kind:'OB.UI.ModalInfo',name:'OB.UI.ValidateAction',header:'',isDefaultAction:true,bodyContent:{name:'message',content:''},executeOnShow:function(){this.$.header.setContent(this.args.header);this.$.bodyContent.$.message.setContent(this.args.message);}});enyo.kind({name:'OB.UI.Modalnoteditableorder',kind:'OB.UI.ModalInfo',i18nHeader:'OBPOS_modalNoEditableHeader',bodyContent:{i18nContent:'OBPOS_modalNoEditableBody'}});enyo.kind({name:'OB.UI.ModalNotEditableLine',kind:'OB.UI.ModalInfo',i18Header:'OBPOS_modalNoEditableLineHeader',bodyContent:{i18nContent:'OBPOS_modalNoEditableLineBody'}});enyo.kind({name:'OB.UI.ModalModulesInDev',kind:'OB.UI.ModalInfo',bodyContent:{components:[{name:'message',content:''},{name:'link',tag:'a href="http://wiki.openbravo.com/wiki/WebPOS_and_HTTPS" target="_blank"',content:'',showing:false}]},executeOnShow:function(){if(!OB.UTIL.isHTTPSAvailable()){this.$.bodyContent.$.message.setContent(OB.I18N.getLabel('OBPOS_NonSecureModalPopup'));this.$.bodyContent.$.link.setContent(OB.I18N.getLabel('OBPOS_link'));this.$.bodyContent.$.link.setShowing(true);}else if(OB.UTIL.Debug.isDebug()){var ifInDevelopment='OBPOS_modalModulesInDevBody';var ifInTestEnvironment='OBPOS_modalApplicationInTestEnvironmentBody';var i18nLabel='OBMOBC_Debug';if(OB.UTIL.Debug.getDebugCauses().isInDevelopment){i18nLabel=ifInDevelopment;}else if(OB.UTIL.Debug.getDebugCauses().isTestEnvironment){i18nLabel=ifInTestEnvironment;}
this.$.bodyContent.$.message.setContent(OB.I18N.getLabel(i18nLabel));}}});(function(){OB.POS.EventBus=OB.POS.EventBus||_.extend({callscounter:0,startProcess:function(){if(this.callscounter===0){this.trigger('UI_Enabled',false);}
this.callscounter++;},endProcess:function(){this.callscounter--;if(this.callscounter===0){this.trigger('UI_Enabled',true);}},isProcessEnabled:function(){return this.callscounter===0;}},Backbone.Events);}());(function(){OB.UTIL=window.OB.UTIL||{};function findAndSave(cashuptaxes,i,finishCallback,tx){if(i<cashuptaxes.length){OB.Dal.findInTransaction(tx,OB.Model.TaxCashUp,{'cashup_id':cashuptaxes[i].cashupID,'name':cashuptaxes[i].taxName,'orderType':cashuptaxes[i].taxOrderType},function(tax){if(tax.length===0){OB.Dal.saveInTransaction(tx,new OB.Model.TaxCashUp({name:cashuptaxes[i].taxName,amount:cashuptaxes[i].taxAmount,orderType:cashuptaxes[i].taxOrderType,cashup_id:cashuptaxes[i].cashupID}),function(){findAndSave(cashuptaxes,i+1,finishCallback,tx);},null);}else{tax.at(0).set('amount',OB.DEC.add(tax.at(0).get('amount'),cashuptaxes[i].taxAmount));OB.Dal.saveInTransaction(tx,tax.at(0),function(){findAndSave(cashuptaxes,i+1,finishCallback,tx);},null);}});}else{if(finishCallback){finishCallback();}}}
function updateCashUpInfo(cashUp,receipt,j,callback,tx){var cashuptaxes,order,orderType,gross,i,taxOrderType,taxAmount,auxPay;var netSales=OB.DEC.Zero;var grossSales=OB.DEC.Zero;var netReturns=OB.DEC.Zero;var grossReturns=OB.DEC.Zero;var taxSales=OB.DEC.Zero;var taxReturns=OB.DEC.Zero;var ctaxSales;var maxtaxSales=OB.DEC.Zero;var ctaxReturns;var maxtaxReturns=OB.DEC.Zero;if(j<receipt.length&&!receipt[j].has('obposIsDeleted')){order=receipt[j];orderType=order.get('orderType');if(cashUp.length!==0){_.each(order.get('lines').models,function(line){if(order.get('priceIncludesTax')){gross=line.get('lineGrossAmount');}else{gross=line.get('discountedGross');}
if(!(order.has('isQuotation')&&order.get('isQuotation'))){if(line.get('qty')>0&&orderType!==3&&!order.get('isLayaway')){netSales=OB.DEC.add(netSales,line.get('net'));grossSales=OB.DEC.add(grossSales,gross);}else if(line.get('qty')<0&&orderType!==3&&!order.get('isLayaway')){netReturns=OB.DEC.add(netReturns,-line.get('net'));grossReturns=OB.DEC.add(grossReturns,-gross);}else if(orderType===3){if(line.get('qty')>0){netSales=OB.DEC.add(netSales,-line.get('net'));grossSales=OB.DEC.add(grossSales,-gross);}else{netReturns=OB.DEC.add(netReturns,line.get('net'));grossReturns=OB.DEC.add(grossReturns,gross);}}}});cashUp.at(0).set('netSales',OB.DEC.add(cashUp.at(0).get('netSales'),netSales));cashUp.at(0).set('grossSales',OB.DEC.add(cashUp.at(0).get('grossSales'),grossSales));cashUp.at(0).set('netReturns',OB.DEC.add(cashUp.at(0).get('netReturns'),netReturns));cashUp.at(0).set('grossReturns',OB.DEC.add(cashUp.at(0).get('grossReturns'),grossReturns));cashUp.at(0).set('totalRetailTransactions',OB.DEC.sub(cashUp.at(0).get('grossSales'),cashUp.at(0).get('grossReturns')));OB.Dal.saveInTransaction(tx,cashUp.at(0),null,null);cashuptaxes=[];order.get('lines').each(function(line,taxIndex){var taxLines,taxLine;taxLines=line.get('taxLines');if(orderType===1||line.get('qty')<0){taxOrderType='1';}else{taxOrderType='0';}
_.each(taxLines,function(taxLine){if(!(order.has('isQuotation')&&order.get('isQuotation'))){if(line.get('qty')>0&&orderType!==3&&!order.get('isLayaway')){taxAmount=taxLine.amount;}else if(line.get('qty')<0&&orderType!==3&&!order.get('isLayaway')){taxAmount=-taxLine.amount;}else if(orderType===3){if(line.get('qty')>0){taxAmount=-taxLine.amount;}else{taxAmount=taxLine.amount;}}}
if(!OB.UTIL.isNullOrUndefined(taxAmount)){cashuptaxes.push({taxName:taxLine.name,taxAmount:taxAmount,taxOrderType:taxOrderType,cashupID:cashUp.at(0).get('id')});}});});_.each(cashuptaxes,function(t){if(t.taxOrderType==='0'){taxSales=OB.DEC.add(taxSales,t.taxAmount);if(t.taxAmount>maxtaxSales){ctaxSales=t;}}else{taxReturns=OB.DEC.add(taxReturns,t.taxAmount);if(t.taxAmount>maxtaxReturns){ctaxReturns=t;}}});if(ctaxSales){ctaxSales.taxAmount=OB.DEC.add(ctaxSales.taxAmount,OB.DEC.sub(OB.DEC.sub(grossSales,netSales),taxSales));}
if(ctaxReturns){ctaxReturns.taxAmount=OB.DEC.add(ctaxReturns.taxAmount,OB.DEC.sub(OB.DEC.sub(grossReturns,netReturns),taxReturns));}
OB.Dal.findInTransaction(tx,OB.Model.PaymentMethodCashUp,{'cashup_id':cashUp.at(0).get('id')},function(payMthds){_.each(order.get('payments').models,function(payment){auxPay=payMthds.filter(function(payMthd){return payMthd.get('searchKey')===payment.get('kind')&&!payment.get('isPrePayment');})[0];if(!auxPay){return;}
if(payment.get('amount')<0){auxPay.set('totalReturns',OB.DEC.sub(auxPay.get('totalReturns'),payment.get('amount')));}else if(orderType===3){auxPay.set('totalReturns',OB.DEC.add(auxPay.get('totalReturns'),payment.get('amount')));}else{auxPay.set('totalSales',OB.DEC.add(auxPay.get('totalSales'),payment.get('amount')));}
OB.Dal.saveInTransaction(tx,auxPay,null,null);},this);findAndSave(cashuptaxes,0,function(){OB.UTIL.composeCashupInfo(cashUp,null,function(){updateCashUpInfo(cashUp,receipt,j+1,callback,tx);},tx);},tx);});}}else if(typeof callback==='function'){callback();}}
OB.UTIL.cashUpReport=function(receipt,callback,tx){var auxPay,orderType,taxOrderType,taxAmount,gross;if(!Array.isArray(receipt)){receipt=[receipt];}
OB.Dal.findInTransaction(tx,OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){updateCashUpInfo(cashUp,receipt,0,callback,tx);});};OB.UTIL.deleteCashUps=function(cashUpModels){var deleteCallback=function(models){models.each(function(model){OB.Dal.remove(model,null,function(tx,err){OB.UTIL.showError(err);});});};_.each(cashUpModels.models,function(cashup){var cashUpId=cashup.get('id');if(cashup.get('isprocessed')==='Y'){OB.Dal.find(OB.Model.TaxCashUp,{cashup_id:cashUpId},deleteCallback,null);OB.Dal.find(OB.Model.CashManagement,{cashup_id:cashUpId},deleteCallback,null);OB.Dal.find(OB.Model.PaymentMethodCashUp,{cashup_id:cashUpId},deleteCallback,null);OB.Dal.remove(cashup,null,function(tx,err){OB.UTIL.showError(err);});}});};OB.UTIL.createNewCashupFromServer=function(cashup,callback){OB.Dal.save(cashup,function(){_.each(cashup.get('cashTaxInfo'),function(taxCashup){var taxModel=new OB.Model.TaxCashUp();taxModel.set(taxCashup);OB.Dal.save(taxModel,null,function(){OB.error(OB.I18N.getLabel('OBPOS_DalSaveError'));},true);});_.each(cashup.get('cashMgmInfo'),function(cashMgm){var cashMgmModel=new OB.Model.CashManagement();cashMgmModel.set(cashMgm);OB.Dal.save(cashMgmModel,null,function(){OB.error(OB.I18N.getLabel('OBPOS_DalSaveError'));},true);});if(cashup.get('cashPaymentMethodInfo').length!==0){_.each(cashup.get('cashPaymentMethodInfo'),function(paymentMethodCashUp){var paymentMethodCashUpModel=new OB.Model.PaymentMethodCashUp();paymentMethodCashUpModel.set(paymentMethodCashUp);var payments=OB.MobileApp.model.get('payments');var pAux=payments.filter(function(payMthd){return paymentMethodCashUpModel.get('paymentmethod_id')===payMthd.payment.id;})[0];if(!pAux){OB.info('Payment method not found. This is likely due to the fact that the payment method was disabled.');return;}
if(pAux.payment.active===true||(pAux.payment.active===false&&paymentMethodCashUpModel.get('totalSales')!==0&&paymentMethodCashUpModel.get('totalReturns')!==0&&paymentMethodCashUpModel.get('totalDepostis')!==0&&paymentMethodCashUpModel.get('totalDrops')!==0)){OB.Dal.save(paymentMethodCashUpModel,null,function(){OB.error(OB.I18N.getLabel('OBPOS_DalSaveError'));},true);}});}else{OB.UTIL.initializePaymentMethodCashup(null,cashup);}
if(callback){callback();}},function(){OB.MobileApp.model.get('terminal').cashUpId=cashup.get('id');},true);};OB.UTIL.createNewCashup=function(callback){var uuid=OB.UTIL.get_UUID();OB.Dal.save(new OB.Model.CashUp({id:uuid,netSales:OB.DEC.Zero,grossSales:OB.DEC.Zero,netReturns:OB.DEC.Zero,grossReturns:OB.DEC.Zero,totalRetailTransactions:OB.DEC.Zero,creationDate:(new Date()).toISOString(),userId:OB.MobileApp.model.get('context').user.id,objToSend:null,cashTaxInfo:[],cashCloseInfo:[],isbeingprocessed:'Y',posterminal:OB.MobileApp.model.get('terminal').id,isprocessed:'N'}),function(){OB.MobileApp.model.get('terminal').cashUpId=uuid;var criteria={'isprocessed':'Y','_orderByClause':'creationDate desc'};OB.Dal.find(OB.Model.CashUp,criteria,function(lastCashUp){var lastCashUpPayments;if(lastCashUp.length!==0){lastCashUpPayments=JSON.parse(lastCashUp.at(0).get('objToSend')).cashCloseInfo;OB.UTIL.initializePaymentMethodCashup(lastCashUpPayments);if(callback){callback();}}else{new OB.DS.Process('org.openbravo.retail.posterminal.master.Cashup').exec({isprocessed:'Y'},function(data){if(data[0]){lastCashUp=new OB.Model.CashUp();lastCashUp.set(data[0]);lastCashUpPayments=lastCashUp.get('cashPaymentMethodInfo');}else{lastCashUpPayments=null;}
OB.UTIL.initializePaymentMethodCashup(lastCashUpPayments,null,true);if(callback){callback();}},function(){});}},function(){});},function(){},true);};OB.UTIL.initializePaymentMethodCashup=function(lastCashUpPayments,cashup,funcType){_.each(OB.MobileApp.model.get('payments'),function(payment){var startingCash=payment.currentBalance,pAux,cashupId,deposits=payment.payment.totalDeposits,drops=payment.payment.totalDrops;if(cashup){cashupId=cashup.get('id');}else{cashupId=OB.MobileApp.model.get('terminal').cashUpId;}
if(lastCashUpPayments){pAux=lastCashUpPayments.filter(function(payMthd){return payMthd.paymentTypeId===payment.payment.id;})[0];if(!OB.UTIL.isNullOrUndefined(pAux)){startingCash=pAux.paymentMethod.amountToKeep;}}
if(!deposits){deposits=OB.DEC.Zero;}
if(!drops){drops=OB.DEC.Zero;}
if(payment.payment.active===true||(payment.payment.active===false&&deposits!==0&&drops!==0)){if(OB.POS.modelterminal.get('terminal').isslave&&payment.paymentMethod.isshared){startingCash=OB.DEC.Zero;}
OB.Dal.save(new OB.Model.PaymentMethodCashUp({id:OB.UTIL.get_UUID(),paymentmethod_id:payment.payment.id,searchKey:payment.payment.searchKey,name:payment.payment._identifier,startingCash:startingCash,totalSales:OB.DEC.Zero,totalReturns:OB.DEC.Zero,totalDeposits:deposits,totalDrops:drops,rate:payment.rate,isocode:payment.isocode,cashup_id:cashupId}),null,null,true);}},this);};OB.UTIL.initCashUp=function(callback,errorCallback,skipSearchBackend){var criteria={'isprocessed':'N','_orderByClause':'creationDate desc'};OB.Dal.find(OB.Model.CashUp,criteria,function(cashUp){if(cashUp.length===0){if(!skipSearchBackend){new OB.DS.Process('org.openbravo.retail.posterminal.master.Cashup').exec({isprocessed:'N',isprocessedbo:'N'},function(data){if(data[0]){cashUp=new OB.Model.CashUp();cashUp.set(data[0]);var cashUpCollection=new Backbone.Collection();cashUpCollection.push(cashUp);OB.UTIL.createNewCashupFromServer(cashUp,function(callback){OB.UTIL.composeCashupInfo(cashUpCollection,null,null);OB.UTIL.calculateCurrentCash(callback);});}else{OB.UTIL.createNewCashup(callback);}});}else{OB.UTIL.createNewCashup(callback);}}else{if(!OB.UTIL.isNullOrUndefined(OB.MobileApp.model.get('terminal'))){OB.MobileApp.model.get('terminal').cashUpId=cashUp.at(0).get('id');}
OB.Dal.find(OB.Model.PaymentMethodCashUp,{'cashup_id':cashUp.at(0).get('id')},function(lastCashUpPayments){_.each(OB.MobileApp.model.get('payments'),function(payment){var pAux,startingCash=payment.currentBalance;if(lastCashUpPayments){pAux=lastCashUpPayments.filter(function(payMthd){return payMthd.get('paymentmethod_id')===payment.payment.id;})[0];if(OB.UTIL.isNullOrUndefined(pAux)&&payment.payment.active===true){OB.Dal.save(new OB.Model.PaymentMethodCashUp({id:OB.UTIL.get_UUID(),paymentmethod_id:payment.payment.id,searchKey:payment.payment.searchKey,name:payment.payment._identifier,startingCash:startingCash,totalSales:OB.DEC.Zero,totalReturns:OB.DEC.Zero,totalDeposits:OB.DEC.Zero,totalDrops:OB.DEC.Zero,rate:payment.rate,isocode:payment.isocode,cashup_id:cashUp.at(0).get('id')}),null,null,true);}else if(!OB.UTIL.isNullOrUndefined(pAux)){if(pAux.get("name")!==payment.payment._identifier){pAux.set("name",payment.payment._identifier);OB.Dal.save(pAux);}}}},function(lastCashUpPayments){});if(callback){callback();}},function(){if(callback){callback();}},this);}});};OB.UTIL.deleteUnactivePaymentMethod=function(lastCashUpPayment){var pAux,payments=OB.MobileApp.model.get('payments');if(payments){pAux=payments.filter(function(payMthd){return lastCashUpPayment.get('paymentmethod_id')===payMthd.payment.id;})[0];if((OB.UTIL.isNullOrUndefined(pAux)||pAux.get('active')===true)&&lastCashUpPayment.get('totalReturns')===OB.DEC.Zero&&lastCashUpPayment.get('totalSales')===OB.DEC.Zero&&lastCashUpPayment.get('totalDepostis')===OB.DEC.Zero&&lastCashUpPayment.get('totalDrops')===OB.DEC.Zero){OB.Dal.remove(lastCashUpPayment,null,function(tx,err){OB.UTIL.showError(err);});}}};OB.UTIL.sumCashManagementToCashup=function(payment){if(!OB.UTIL.isNullOrUndefined(payment)){var cashupId=payment.get('cashup_id'),criteria={'cashup_id':cashupId,'paymentmethod_id':payment.get('paymentMethodId')};OB.Dal.find(OB.Model.PaymentMethodCashUp,criteria,function(paymentMethods){var paymentMethod=paymentMethods.at(0),totalDeposits=paymentMethod.get('totalDeposits'),totalDrops=paymentMethod.get('totalDrops');totalDeposits=OB.DEC.add(totalDeposits,payment.get('totalDeposits'));paymentMethod.set('totalDeposits',totalDeposits);totalDrops=OB.DEC.add(totalDrops,payment.get('totalDrops'));paymentMethod.set('totalDrops',totalDrops);OB.Dal.save(paymentMethod,function(success){OB.Dal.find(OB.Model.CashUp,{'id':cashupId},function(cashUpObj){OB.UTIL.composeCashupInfo(cashUpObj,null,null);});},function(error){});});}};OB.UTIL.calculateCurrentCash=function(callback,tx){var me=this;OB.Dal.findInTransaction(tx,OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){OB.Dal.findInTransaction(tx,OB.Model.PaymentMethodCashUp,{'cashup_id':cashUp.at(0).get('id')},function(payMthds){var payMthdsCash;_.each(OB.MobileApp.model.get('payments'),function(paymentType,index){var cash=0,auxPay=payMthds.filter(function(payMthd){return payMthd.get('paymentmethod_id')===paymentType.payment.id;})[0];if(!auxPay){return;}
auxPay.set('_id',paymentType.payment.searchKey);auxPay.set('isocode',paymentType.isocode);auxPay.set('paymentMethod',paymentType.paymentMethod);auxPay.set('id',paymentType.payment.id);var startingCash=auxPay.get('startingCash'),rate=auxPay.get('rate'),totalSales=auxPay.get('totalSales'),totalReturns=auxPay.get('totalReturns'),totalDeps=auxPay.get('totalDeposits'),totalDrops=auxPay.get('totalDrops'),payment=OB.MobileApp.model.paymentnames[paymentType.payment.searchKey];if(!totalDeps){totalDeps=0;}
if(!totalDrops){totalDrops=0;}
var cashMgmt=OB.DEC.sub(totalDeps,totalDrops);cash=OB.DEC.add(OB.DEC.add(startingCash,OB.DEC.sub(totalSales,totalReturns)),cashMgmt);payment.currentCash=OB.UTIL.currency.toDefaultCurrency(payment.paymentMethod.currency,cash);payment.foreignCash=OB.UTIL.currency.toForeignCurrency(payment.paymentMethod.currency,cash);},this);if(typeof callback==='function'){callback();}});});};OB.UTIL.getPaymethodCashUp=function(payMthds,objToSend,cashUp){_.each(OB.MobileApp.model.get('payments'),function(curModel){var cashPaymentMethodInfo={paymentMethodId:0,name:"",id:"",searchKey:"",startingCash:0,totalSales:0,totalReturns:0,rate:0,isocode:0};cashPaymentMethodInfo.paymentMethodId=curModel.payment.id;cashPaymentMethodInfo.name=curModel.payment.name;cashPaymentMethodInfo.searchKey=curModel.payment.searchKey;var auxPay=payMthds.filter(function(payMthd){return payMthd.get('paymentmethod_id')===curModel.payment.id;})[0];if(!auxPay){return;}
cashPaymentMethodInfo.id=auxPay.get('id');cashPaymentMethodInfo.startingCash=auxPay.get('startingCash');cashPaymentMethodInfo.totalSales=auxPay.get('totalSales');cashPaymentMethodInfo.totalReturns=auxPay.get('totalReturns');cashPaymentMethodInfo.totalDeposits=auxPay.get('totalDeposits');cashPaymentMethodInfo.totalDrops=auxPay.get('totalDrops');cashPaymentMethodInfo.rate=curModel.rate;cashPaymentMethodInfo.isocode=curModel.isocode;cashPaymentMethodInfo.paymentmethod_id=auxPay.get('paymentmethod_id');objToSend.get('cashPaymentMethodInfo').push(cashPaymentMethodInfo);cashUp.at(0).set('objToSend',JSON.stringify(objToSend));},this);};OB.UTIL.saveComposeInfo=function(me,callback,objToSend,cashUp,tx){cashUp.at(0).set('userId',OB.MobileApp.model.get('context').user.id);objToSend.set('userId',OB.MobileApp.model.get('context').user.id);objToSend.set('organization',OB.MobileApp.model.get('terminal').organization);cashUp.at(0).set('objToSend',JSON.stringify(objToSend));OB.Dal.saveInTransaction(tx,cashUp.at(0),function(){if(callback){callback(me);}},null);};OB.UTIL.getTaxCashUp=function(taxcashups,objToSend,cashUp){_.each(taxcashups.models,function(currentTax){var cashTaxInfo={name:"",amount:0,orderType:0,cashupId:"",id:""};cashTaxInfo.name=currentTax.get('name');cashTaxInfo.amount=currentTax.get('amount');cashTaxInfo.orderType=currentTax.get('orderType');cashTaxInfo.cashupId=currentTax.get('cashup_id');cashTaxInfo.id=currentTax.get('id');objToSend.get('cashTaxInfo').push(cashTaxInfo);cashUp.at(0).set('objToSend',JSON.stringify(objToSend));},this);};OB.UTIL.composeCashupInfo=function(cashUp,me,callback,tx){var objToSend=new Backbone.Model({posterminal:OB.MobileApp.model.get('terminal').id,id:cashUp.at(0).get('id'),isprocessed:cashUp.at(0).get('isprocessed'),isbeingprocessed:cashUp.at(0).get('isbeingprocessed'),netSales:cashUp.at(0).get('netSales'),grossSales:cashUp.at(0).get('grossSales'),netReturns:cashUp.at(0).get('netReturns'),grossReturns:cashUp.at(0).get('grossReturns'),totalRetailTransactions:cashUp.at(0).get('totalRetailTransactions'),cashPaymentMethodInfo:[],cashTaxInfo:[],cashCloseInfo:[],cashUpDate:"",creationDate:(new Date(cashUp.at(0).get('creationDate'))).toISOString()});OB.Dal.findInTransaction(tx,OB.Model.PaymentMethodCashUp,{'cashup_id':cashUp.at(0).get('id'),'_orderByClause':'name asc'},function(payMthds){OB.UTIL.getPaymethodCashUp(payMthds,objToSend,cashUp);OB.Dal.findInTransaction(tx,OB.Model.TaxCashUp,{'cashup_id':cashUp.at(0).get('id'),'_orderByClause':'name asc'},function(taxcashups){OB.UTIL.getTaxCashUp(taxcashups,objToSend,cashUp);OB.UTIL.saveComposeInfo(me,callback,objToSend,cashUp,tx);});});};}());(function(){OB=window.OB||{};OB.UTILS=window.OB.UTILS||{};OB.UTILS.CashManagementUtils=window.OB.UTILS.CashManagementUtils||{};OB.UTILS.CashManagementUtils.addCashManagementTransaction=function(newCashManagementTransaction,successCallback,errorCallback,options){var cashUp=null;var paymentMethodCashUp=null;var warns=[];var errors=[];var cashManagementTransactionToAdd=null;var optionsObj={};var printCashManagementModel=null;var availableAmountToDrop,startingAmt,salesAmt,returnsAmt,totalDrops,totalDeposits;if(options&&!OB.UTIL.isNullOrUndefined(options.printTicket)){optionsObj.printTicket=options.printTicket;}else{optionsObj.printTicket=true;}
if(options&&!OB.UTIL.isNullOrUndefined(options.ticketTemplate)){optionsObj.ticketTemplate=options.ticketTemplate;}else{optionsObj.ticketTemplate=new OB.OBPOSCashMgmt.Print.CashMgmt();}
if(options&&!OB.UTIL.isNullOrUndefined(options.executeSync)){optionsObj.executeSync=options.executeSync;}else{optionsObj.executeSync=true;}
if(options&&!OB.UTIL.isNullOrUndefined(options.customGLItem)){optionsObj.glItem=options.customGLItem;}else{if(newCashManagementTransaction.get('cashManagementEvent').type==='drop'){optionsObj.glItem=newCashManagementTransaction.get('paymentMethod').paymentMethod.gLItemForDrops;}else if(newCashManagementTransaction.get('cashManagementEvent').type==='deposit'){optionsObj.glItem=newCashManagementTransaction.get('paymentMethod').paymentMethod.gLItemForDeposits;}else{errorCallback('Error getting the G/L item to create a cash managment');return;}}
OB.Dal.find(OB.Model.CashUp,{'isprocessed':'N'},function(cashUpResults){if(cashUpResults.length!==1){errorCallback("Zero or more than one cash ups found.");return;}else{cashUp=cashUpResults.at(0);if(newCashManagementTransaction.get('cashManagementEvent').type==='drop'&&!newCashManagementTransaction.get('paymentMethod').paymentMethod.allowdrops){errorCallback('Current payment method doesn\'t allow drops');}else if(newCashManagementTransaction.get('cashManagementEvent').type==='deposit'&&!newCashManagementTransaction.get('paymentMethod').paymentMethod.allowdeposits){errorCallback('Current payment method doesn\'t allow deposits');return;}else if(newCashManagementTransaction.get('cashManagementEvent').type!=='deposit'&&newCashManagementTransaction.get('cashManagementEvent').type!=='drop'){errorCallback('Cash Managment event type is not valid.');return;}
OB.UTIL.calculateCurrentCash(function(){if(newCashManagementTransaction.get('cashManagementEvent').type==='drop'){if(OB.DEC.sub(newCashManagementTransaction.get('paymentMethod').currentCash,newCashManagementTransaction.get('amount'))<0){errorCallback('Amount to drop is greater than available amount ('+OB.I18N.formatCurrency(newCashManagementTransaction.get('paymentMethod').currentCash)+')');return;}}
var criteria={'cashup_id':cashUp.id,'paymentmethod_id':newCashManagementTransaction.get('paymentMethod').payment.id};OB.Dal.find(OB.Model.PaymentMethodCashUp,criteria,function(paymentMethods){var paymentMethod=paymentMethods.at(0),totalDrops=paymentMethod.get('totalDrops'),totalDeposits=paymentMethod.get('totalDeposits');if(newCashManagementTransaction.get('cashManagementEvent').type==='deposit'){totalDeposits=OB.DEC.add(totalDeposits,newCashManagementTransaction.get('amount'));paymentMethod.set('totalDeposits',totalDeposits);}else{totalDrops=OB.DEC.add(totalDrops,newCashManagementTransaction.get('amount'));paymentMethod.set('totalDrops',totalDrops);}
OB.Dal.transaction(function(tx){OB.Dal.saveInTransaction(tx,paymentMethod,function(){var now=new Date();cashManagementTransactionToAdd=new OB.Model.CashManagement({id:OB.Dal.get_uuid(),description:newCashManagementTransaction.get('paymentMethod').payment._identifier+' - '+newCashManagementTransaction.get('cashManagementEvent').name,amount:newCashManagementTransaction.get('amount'),origAmount:OB.DEC.mul(newCashManagementTransaction.get('amount'),newCashManagementTransaction.get('paymentMethod').rate),type:newCashManagementTransaction.get('cashManagementEvent').type,reasonId:newCashManagementTransaction.get('cashManagementEvent').id,paymentMethodId:newCashManagementTransaction.get('paymentMethod').payment.id,user:OB.MobileApp.model.get('context').user._identifier,userId:OB.MobileApp.model.get('context').user.id,creationDate:OB.I18N.normalizeDate(now),timezoneOffset:now.getTimezoneOffset(),isocode:newCashManagementTransaction.get('paymentMethod').isocode,glItem:optionsObj.glItem,cashup_id:cashUp.get('id'),posTerminal:OB.MobileApp.model.get('terminal').id,isbeingprocessed:'N'});OB.UTIL.HookManager.executeHooks('OBPOS_cashManagementTransactionHook',{newCashManagementTransaction:newCashManagementTransaction,cashManagementTransactionToAdd:cashManagementTransactionToAdd},function(args){if(args&&args.cancelOperation){errorCallback(args.errorMessage);}
OB.Dal.saveInTransaction(tx,cashManagementTransactionToAdd,function(){if(optionsObj.executeSync){OB.MobileApp.model.runSyncProcess(function(){if(optionsObj.printTicket){if(OB.MobileApp.model.hasPermission('OBPOS_print.cashmanagement')){var toPrint=new Backbone.Collection();toPrint.add(cashManagementTransactionToAdd);printCashManagementModel=optionsObj.ticketTemplate;printCashManagementModel.print(toPrint.toJSON());successCallback();}else{warns.push({msg:OB.I18N.getLabel('OBPOS_NoPermissionToPrintCashManagment'),errObj:{}});successCallback({warnings:warns});}}else{successCallback();}},function(error){warns.push({msg:OB.I18N.getLabel('OBPOS_CashManagmentNoSync'),errObj:error});if(optionsObj.printTicket){if(OB.MobileApp.model.hasPermission('OBPOS_print.cashmanagement')){var toPrint=new Backbone.Collection();toPrint.add(cashManagementTransactionToAdd);printCashManagementModel=optionsObj.ticketTemplate;printCashManagementModel.print(toPrint.toJSON());successCallback();}else{warns.push({msg:OB.I18N.getLabel('OBPOS_NoPermissionToPrintCashManagment'),errObj:{}});successCallback({warnings:warns});}}else{successCallback();}});}else{if(optionsObj.printTicket){if(OB.MobileApp.model.hasPermission('OBPOS_print.cashmanagement')){var toPrint=new Backbone.Collection();toPrint.add(cashManagementTransactionToAdd);printCashManagementModel=optionsObj.ticketTemplate;printCashManagementModel.print(toPrint.toJSON());successCallback();}else{warns.push({msg:OB.I18N.getLabel('OBPOS_NoPermissionToPrintCashManagment'),errObj:{}});successCallback({warnings:warns});}}else{successCallback();}}},function(error){errorCallback('Error while saving cash management transaction');},true);});},function(){errorCallback('Error while saving payment method cashup information');});},function(){errorCallback('Transaction has failed');});},function(){errorCallback("Error while retrieving paymentMethodCashup info");});},null);}},function(){errorCallback("Error while retrieving current cash up info");return;},null);};}());enyo.kind({name:'OB.UI.KeypadCoinsLegacy',padName:'Coins-102',padPayment:'OBPOS_payment.cash',components:[{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.ButtonKey',name:'OBKEY_legacy_A1',classButton:'btnkeyboard-num',label:'/',command:'/'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',name:'OBKEY_legacy_B1',label:'*',command:'*'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',name:'OBKEY_legacy_C1',label:'%',command:'%'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_A2',amount:10,background:'#e9b7c3'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_B2',amount:20,background:'#bac3de'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_C2',amount:50,background:'#f9bb92'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_A3',amount:1,background:'#e4e0e3',bordercolor:'#f9e487'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_B3',amount:2,background:'#f9e487',bordercolor:'#e4e0e3'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_C3',amount:5,background:'#bccdc5'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_A4',amount:0.10,background:'#f9e487'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_B4',amount:0.20,background:'#f9e487'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_C4',amount:0.50,background:'#f9e487'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_A5',amount:0.01,background:'#f3bc9e'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',paymenttype:'OBPOS_payment.cash',name:'OBKEY_OBPOS_payment.cash_B5',amount:0.02,background:'#f3bc9e'}]},{classes:'span4',components:[{kind:'OB.UI.PaymentButton',name:'OBKEY_OBPOS_payment.cash_C5',paymenttype:'OBPOS_payment.cash',amount:0.05,background:'#f3bc9e'}]}]}],initComponents:function(){this.inherited(arguments);this.label=OB.I18N.getLabel('OBPOS_KeypadCoins');}});enyo.kind({name:'OB.UI.PaymentButton',style:'margin: 5px;',components:[{kind:'OB.UI.Button',classes:'btnkeyboard',name:'btn'}],background:'#6cb33f',initComponents:function(){var btn;this.inherited(arguments);btn=this.$.btn;btn.setContent(this.label||OB.I18N.formatCoins(this.amount));btn.applyStyle('background-color',this.background);btn.applyStyle('border','10px solid '+(this.bordercolor||this.background));},tap:function(){if(OB.MobileApp.model.hasPermission(this.paymenttype)){var me=this,myWindowModel=this.owner.owner.owner.owner.owner.owner.model;var i,max,p,receipt=myWindowModel.get('order'),multiOrders=myWindowModel.get('multiOrders'),openDrawer=false,isCash=false,allowOpenDrawer=false,printtwice=false;for(i=0,max=OB.MobileApp.model.get('payments').length;i<max;i++){p=OB.MobileApp.model.get('payments')[i];if(p.payment.searchKey===me.paymenttype){if(p.paymentMethod.openDrawer){openDrawer=p.paymentMethod.openDrawer;}
if(p.paymentMethod.iscash){isCash=p.paymentMethod.iscash;}
if(p.paymentMethod.allowopendrawer){allowOpenDrawer=p.paymentMethod.allowopendrawer;}
if(p.paymentMethod.printtwice){printtwice=p.paymentMethod.printtwice;}
break;}}
var amountToPay=me.amount;var receiptToPay=myWindowModel.isValidMultiOrderState()?multiOrders:receipt;if(receiptToPay.get("payments").length>0){receiptToPay.get("payments").each(function(item){if(item.get("kind")===me.paymenttype){amountToPay+=item.get("amount");}});}
var paymentMethod=OB.POS.terminal.terminal.paymentnames[this.paymenttype];if(paymentMethod.paymentMethod.maxLimitAmount&&amountToPay>paymentMethod.paymentMethod.maxLimitAmount){this.bubble('onMaxLimitAmountError',{show:true,maxLimitAmount:paymentMethod.paymentMethod.maxLimitAmount,currency:paymentMethod.symbol,symbolAtRight:paymentMethod.currencySymbolAtTheRight});}else{this.bubble('onMaxLimitAmountError',{show:false,maxLimitAmount:0,currency:'',symbolAtRight:true});myWindowModel.addPayment(new OB.Model.PaymentLine({kind:me.paymenttype,name:OB.MobileApp.model.getPaymentName(me.paymenttype),amount:OB.DEC.number(me.amount),rate:p.rate,mulrate:p.mulrate,isocode:p.isocode,isCash:isCash,allowOpenDrawer:allowOpenDrawer,openDrawer:openDrawer,printtwice:printtwice}));}}}});(function(){OB.DATA=window.OB.DATA||{};OB.DATA.OrderSave=function(model){this.context=model;this.receipt=model.get('order');this.ordersToSend=OB.DEC.Zero;this.hasInvLayaways=false;this.receipt.on('closed',function(){var errorHeader="Receipt verification error";var eventParams='closed';try{var totalTaxes=OB.DEC.Zero;_.each(this.get('taxes'),function(tax){totalTaxes=OB.DEC.add(totalTaxes,tax.amount);},this);var gross=this.get('gross');var accum=totalTaxes;var isFieldUndefined=false;_.each(this.get('lines').models,function(line){var fieldValue=line.get('discountedNet');if(!fieldValue){isFieldUndefined=true;return;}
accum=OB.DEC.add(accum,fieldValue);});var difference=OB.DEC.sub(gross,accum);if(!isFieldUndefined&&difference!==0){OB.error(enyo.format("%s: The sum of the net of each line plus taxes does not equal the gross: '%s', gross: %s, difference: %s",errorHeader,eventParams,gross,difference));}
var cashupId=OB.MobileApp.model.get('terminal').cashUpId;if(!cashupId){OB.error("The receipt has been closed with empty cashUpId (current value: "+cashupId+")");}
_.each(this.get('lines').models,function(line){if(OB.UTIL.isNullOrUndefined(line.get('net'))||line.get('net')===''){OB.error("The receipt has been closed with an empty 'net' amount in a line (value: "+line.get('net')+")");}});}catch(e){}});this.receipt.on('closed',function(eventParams){this.receipt=model.get('order');if(this.receipt.get('isbeingprocessed')==='Y'){return;}
OB.info('Ticket closed: ',OB.UTIL.argumentsToStringifyed(this.receipt.getOrderDescription()),"caller: "+OB.UTIL.getStackTrace('Backbone.Events.trigger',true));var orderDate=new Date();var normalizedCreationDate=OB.I18N.normalizeDate(this.receipt.get('creationDate'));var creationDate;if(normalizedCreationDate===null){creationDate=new Date();normalizedCreationDate=OB.I18N.normalizeDate(creationDate);}else{creationDate=new Date(normalizedCreationDate);}
OB.trace('Executing pre order save hook.');OB.UTIL.HookManager.executeHooks('OBPOS_PreOrderSave',{context:this,model:model,receipt:model.get('order')},function(args){var receipt=args.context.receipt;if(args&&args.cancellation&&args.cancellation===true){args.context.receipt.set('isbeingprocessed','N');args.context.receipt.set('hasbeenpaid','N');args.context.receipt.trigger('paymentCancel');if(eventParams&&eventParams.callback){eventParams.callback({frozenReceipt:receipt,isCancelled:true});}
args.context.receipt.setIsCalculateReceiptLockState(false);args.context.receipt.setIsCalculateGrossLockState(false);return true;}
OB.trace('Execution of pre order save hook OK.');delete receipt.attributes.json;receipt.set('creationDate',normalizedCreationDate);receipt.set('timezoneOffset',creationDate.getTimezoneOffset());receipt.set('created',creationDate.getTime());receipt.set('obposCreatedabsolute',OB.I18N.formatDateISO(creationDate));receipt.set('orderDate',orderDate);receipt.set('movementDate',OB.I18N.normalizeDate(new Date()));receipt.set('accountingDate',OB.I18N.normalizeDate(new Date()));receipt.set('posTerminal',OB.MobileApp.model.get('terminal').id);receipt.set('posTerminal'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,OB.MobileApp.model.get('terminal')._identifier);receipt.get("approvals").forEach(function(approval){if(typeof(approval.approvalType)==='object'){approval.approvalMessage=OB.I18N.getLabel(approval.approvalType.message,approval.approvalType.params);approval.approvalType=approval.approvalType.approval;}});receipt.set('obposAppCashup',OB.MobileApp.model.get('terminal').cashUpId);if(receipt.getGross()<0){_.forEach(receipt.get('payments').models,function(item){item.set('amount',-item.get('amount'));item.set('origAmount',-item.get('origAmount'));item.set('paid',-item.get('paid'));});}
receipt.set('json',JSON.stringify(receipt.serializeToJSON()));OB.trace('Calculationg cashup information.');var frozenReceipt=new OB.Model.Order();OB.UTIL.clone(receipt,frozenReceipt);OB.info("[receipt.closed] Starting transaction. ReceiptId: "+receipt.get('id'));OB.Dal.transaction(function(tx){receipt.set('hasbeenpaid','Y');frozenReceipt.set('hasbeenpaid','Y');OB.UTIL.cashUpReport(receipt,function(){OB.UTIL.calculateCurrentCash(null,tx);OB.MobileApp.model.updateDocumentSequenceWhenOrderSaved(receipt.get('documentnoSuffix'),receipt.get('quotationnoSuffix'),function(){OB.trace('Saving receipt.');OB.Dal.saveInTransaction(tx,receipt,function(){receipt.trigger('integrityOk');});},tx);},tx);},function(){OB.error("[receipt.closed] The transaction failed to be commited. ReceiptId: "+receipt.get('id'));receipt.set('hasbeenpaid','N');frozenReceipt.set('hasbeenpaid','N');if(eventParams&&eventParams.callback){eventParams.callback({frozenReceipt:frozenReceipt,isCancelled:false});}},function(){OB.info("[receipt.closed] Transaction success. ReceiptId: "+receipt.get('id'));function serverMessageForQuotation(receipt){var isLayaway=(receipt.get('orderType')===2||receipt.get('isLayaway'));var currentDocNo=receipt.get('documentNo');if(receipt&&receipt.get('isQuotation')){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_QuotationSaved',[currentDocNo]));}else{if(isLayaway){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_MsgLayawaySaved',[currentDocNo]));}else{OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_MsgReceiptSaved',[currentDocNo]));}}
OB.trace('Order successfully removed.');}
if(OB.UTIL.HookManager.get('OBPOS_PostSyncReceipt')){var receiptForPostSyncReceipt=new OB.Model.Order();OB.UTIL.clone(receipt,receiptForPostSyncReceipt);OB.trace('Execution Sync process.');OB.MobileApp.model.runSyncProcess(function(){OB.UTIL.HookManager.executeHooks('OBPOS_PostSyncReceipt',{receipt:receiptForPostSyncReceipt},function(){serverMessageForQuotation(receipt);if(eventParams&&eventParams.callback){eventParams.callback({frozenReceipt:frozenReceipt,isCancelled:false});}});},function(){OB.UTIL.HookManager.executeHooks('OBPOS_PostSyncReceipt',{receipt:receiptForPostSyncReceipt},function(){if(eventParams&&eventParams.callback){eventParams.callback({frozenReceipt:frozenReceipt,isCancelled:false});}});});}else{OB.trace('Execution Sync process.');if(eventParams&&eventParams.callback){eventParams.callback({frozenReceipt:frozenReceipt,isCancelled:false});}
OB.MobileApp.model.runSyncProcess(function(){serverMessageForQuotation(frozenReceipt);OB.debug("Ticket closed: runSyncProcess executed");});}});});},this);this.context.get('multiOrders').on('closed',function(receipt){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("multiOrdersClosed");OB.info('Multiorders ticket closed',receipt,"caller: "+OB.UTIL.getStackTrace('Backbone.Events.trigger',true));var me=this;if(!_.isUndefined(receipt)){this.receipt=receipt;}
var receiptId=this.receipt.get('id');var normalizedCreationDate=OB.I18N.normalizeDate(this.receipt.get('creationDate'));var creationDate;if(normalizedCreationDate===null){creationDate=new Date();normalizedCreationDate=OB.I18N.normalizeDate(creationDate);}else{creationDate=new Date(normalizedCreationDate);}
this.receipt.set('creationDate',normalizedCreationDate);this.receipt.set('movementDate',OB.I18N.normalizeDate(new Date()));this.receipt.set('accountingDate',OB.I18N.normalizeDate(new Date()));this.receipt.set('hasbeenpaid','Y');this.context.get('multiOrders').trigger('integrityOk',this.receipt);OB.UTIL.calculateCurrentCash();OB.MobileApp.model.updateDocumentSequenceWhenOrderSaved(this.receipt.get('documentnoSuffix'),this.receipt.get('quotationnoSuffix'));delete this.receipt.attributes.json;this.receipt.set('timezoneOffset',creationDate.getTimezoneOffset());this.receipt.set('created',creationDate.getTime());this.receipt.set('obposCreatedabsolute',OB.I18N.formatDateISO(creationDate));receipt.set('posTerminal',OB.MobileApp.model.get('terminal').id);receipt.set('posTerminal'+OB.Constants.FIELDSEPARATOR+OB.Constants.IDENTIFIER,OB.MobileApp.model.get('terminal')._identifier);this.receipt.set('obposAppCashup',OB.MobileApp.model.get('terminal').cashUpId);this.receipt.set('json',JSON.stringify(this.receipt.serializeToJSON()));OB.trace('Executing pre order save hook.');OB.UTIL.HookManager.executeHooks('OBPOS_PreOrderSave',{context:this,model:model,receipt:this.receipt},function(args){OB.trace('Execution of pre order save hook OK.');if(args&&args.cancellation&&args.cancellation===true){args.context.receipt.set('isbeingprocessed','N');OB.UTIL.SynchronizationHelper.finished(synchId,"multiOrdersClosed");return true;}
OB.trace('Saving receipt.');OB.Dal.save(me.receipt,function(){OB.Dal.get(OB.Model.Order,receiptId,function(receipt){var successCallback=function(){OB.trace('Sync process success.');OB.UTIL.showLoading(false);if(me.hasInvLayaways){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_noInvoiceIfLayaway'));me.hasInvLayaways=false;}
OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_MsgAllReceiptSaved'));OB.UTIL.SynchronizationHelper.finished(synchId,"multiOrdersClosed");};var errorCallback=function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgAllReceiptNotSaved'));OB.UTIL.SynchronizationHelper.finished(synchId,"multiOrdersClosed");};if(!_.isUndefined(receipt.get('amountToLayaway'))&&!_.isNull(receipt.get('amountToLayaway'))&&receipt.get('generateInvoice')){me.hasInvLayaways=true;}
model.get('orderList').current=receipt;model.get('orderList').deleteCurrent();me.ordersToSend+=1;if(model.get('multiOrders').get('multiOrdersList').length===me.ordersToSend){model.get('multiOrders').resetValues();OB.trace('Execution Sync process.');OB.MobileApp.model.runSyncProcess(successCallback,errorCallback);me.ordersToSend=OB.DEC.Zero;}else{OB.UTIL.SynchronizationHelper.finished(synchId,"multiOrdersClosed");}},null);},function(){OB.UTIL.SynchronizationHelper.finished(synchId,"multiOrdersClosed");});});},this);};}());(function(){function navigateTaxesTree(taxrates,taxid,iteratee){_.each(taxrates,function(tax){if(tax.get('taxBase')===taxid){iteratee(tax);navigateTaxesTree(taxrates,tax.get('id'),iteratee);}});}
var isTaxCategoryBOM=function(taxcategory){return new Promise(function(fulfill){OB.Dal.findUsingCache('taxCategoryBOM',OB.Model.TaxCategoryBOM,{'id':taxcategory},function(data){fulfill(data.length>0);});});};var getProductBOM=function(product){return new Promise(function(fulfill){OB.Dal.findUsingCache('taxProductBOM',OB.Model.ProductBOM,{'product':product},function(data){var groupeddata=data.chain().groupBy(function(productbom){return productbom.get('bomtaxcategory');}).map(function(productboms,bomtaxcategory){var ratio=_.reduce(productboms,function(memo,productbom){return memo+OB.DEC.mul(productbom.get('bomprice'),productbom.get('bomquantity'));},0);return{'bomtaxcategory':bomtaxcategory,'ratio':ratio};}).sortBy(function(groupedbom){return groupedbom.ratio;}).value();groupeddata.totalratio=_.reduce(groupeddata,function(s,productbom){return OB.DEC.add(s,productbom.ratio);},OB.DEC.Zero);fulfill(groupeddata);});});};var getTaxRateNumber=function(taxRate){var rate=new BigDecimal(String(taxRate));return rate.divide(new BigDecimal('100'),20,BigDecimal.prototype.ROUND_HALF_UP);};var calculateDiscountedGross=function(line){var discountedGross=line.get('gross');if(line.get('promotions')){discountedGross=line.get('promotions').reduce(function(memo,element){return OB.DEC.sub(memo,element.actualAmt||element.amt||0);},discountedGross);}
return discountedGross;};var distributeBOM=function(data,property,amount){var accamount=amount;_.forEach(data,function(productbom){var bomamount=OB.DEC.div(OB.DEC.mul(productbom.ratio,amount),data.totalratio);accamount=OB.DEC.sub(accamount,bomamount);productbom[property]=bomamount;});if(data&&data.length>0){var lastitem=data[data.length-1];lastitem[property]=OB.DEC.add(lastitem[property],accamount);}};var findTaxesCollection=function(receipt,line,taxCategory){return new Promise(function(fulfill,reject){var fromRegionOrg=OB.MobileApp.model.get('terminal').organizationRegionId,fromCountryOrg=OB.MobileApp.model.get('terminal').organizationCountryId,bpTaxCategory=receipt.get('bp').get('taxCategory'),bpIsExempt=receipt.get('bp').get('taxExempt'),bpLocId=receipt.get('bp').get('locId'),bplCountryId=receipt.get('bp').get('locationModel')?receipt.get('bp').get('locationModel').get('countryId'):null,bplRegionId=receipt.get('bp').get('locationModel')?receipt.get('bp').get('locationModel').get('regionId'):null,bpName=receipt.get('bp').get('name')||OB.I18N.getLabel('OBPOS_LblEmptyAddress'),bpLocName=receipt.get('bp').get('locName')||OB.I18N.getLabel('OBPOS_LblEmptyAddress');var sql="";if(!bplCountryId){sql="select c_tax.c_tax_id, c_tax.name,  c_tax.description, c_tax.taxindicator, c_tax.validfrom, c_tax.issummary, c_tax.rate, c_tax.parent_tax_id, (case when c_tax.c_country_id = '"+fromCountryOrg+"' then c_tax.c_country_id else tz.from_country_id end) as c_country_id, (case when c_tax.c_region_id = '"+fromRegionOrg+"' then c_tax.c_region_id else tz.from_region_id end) as c_region_id, (case when c_tax.to_country_id = bpl.countryId then c_tax.to_country_id else tz.to_country_id end) as to_country_id, (case when c_tax.to_region_id = bpl.regionId then c_tax.to_region_id else tz.to_region_id end)  as to_region_id, c_tax.c_taxcategory_id, c_tax.isdefault, c_tax.istaxexempt, c_tax.sopotype, c_tax.cascade, c_tax.c_bp_taxcategory_id,  c_tax.line, c_tax.iswithholdingtax, c_tax.isnotaxable, c_tax.deducpercent, c_tax.originalrate, c_tax.istaxundeductable,  c_tax.istaxdeductable, c_tax.isnovat, c_tax.baseamount, c_tax.c_taxbase_id, c_tax.doctaxamount, c_tax.iscashvat,  c_tax._identifier,  c_tax._idx,  (case when (c_tax.to_country_id = bpl.countryId or tz.to_country_id= bpl.countryId) then 0 else 1 end) as orderCountryTo,  (case when (c_tax.to_region_id = bpl.regionId or tz.to_region_id = bpl.regionId) then 0 else 1 end) as orderRegionTo,  (case when coalesce(c_tax.c_country_id, tz.from_country_id) is null then 1 else 0 end) as orderCountryFrom,  (case when coalesce(c_tax.c_region_id, tz.from_region_id) is null then 1 else 0 end) as orderRegionFrom  from c_tax left join c_tax_zone tz on tz.c_tax_id = c_tax.c_tax_id  join c_bpartner_location bpl on bpl.c_bpartner_location_id = '"+bpLocId+"'   where c_tax.sopotype in ('B', 'S') ";}else{sql="select c_tax.c_tax_id, c_tax.name,  c_tax.description, c_tax.taxindicator, c_tax.validfrom, c_tax.issummary, c_tax.rate, c_tax.parent_tax_id, (case when c_tax.c_country_id = '"+fromCountryOrg+"' then c_tax.c_country_id else tz.from_country_id end) as c_country_id, (case when c_tax.c_region_id = '"+fromRegionOrg+"' then c_tax.c_region_id else tz.from_region_id end) as c_region_id, (case when c_tax.to_country_id = '"+bplCountryId+"' then c_tax.to_country_id else tz.to_country_id end) as to_country_id, (case when c_tax.to_region_id = '"+bplRegionId+"' then c_tax.to_region_id else tz.to_region_id end)  as to_region_id, c_tax.c_taxcategory_id, c_tax.isdefault, c_tax.istaxexempt, c_tax.sopotype, c_tax.cascade, c_tax.c_bp_taxcategory_id,  c_tax.line, c_tax.iswithholdingtax, c_tax.isnotaxable, c_tax.deducpercent, c_tax.originalrate, c_tax.istaxundeductable,  c_tax.istaxdeductable, c_tax.isnovat, c_tax.baseamount, c_tax.c_taxbase_id, c_tax.doctaxamount, c_tax.iscashvat,  c_tax._identifier,  c_tax._idx,  (case when (c_tax.to_country_id = '"+bplCountryId+"' or tz.to_country_id= '"+bplCountryId+"') then 0 else 1 end) as orderCountryTo,  (case when (c_tax.to_region_id = '"+bplRegionId+"' or tz.to_region_id = '"+bplRegionId+"') then 0 else 1 end) as orderRegionTo,  (case when coalesce(c_tax.c_country_id, tz.from_country_id) is null then 1 else 0 end) as orderCountryFrom,  (case when coalesce(c_tax.c_region_id, tz.from_region_id) is null then 1 else 0 end) as orderRegionFrom  from c_tax left join c_tax_zone tz on tz.c_tax_id = c_tax.c_tax_id  where c_tax.sopotype in ('B', 'S') ";}
if(bpIsExempt){sql=sql+" and c_tax.istaxexempt = 'true'";}else{sql=sql+" and c_tax.c_taxCategory_id = '"+taxCategory+"'";if(bpTaxCategory){sql=sql+" and c_tax.c_bp_taxcategory_id = '"+bpTaxCategory+"'";}else{sql=sql+" and c_tax.c_bp_taxcategory_id is null";}}
sql=sql+" and c_tax.validFrom <= date()";if(!bplCountryId){sql=sql+" and (c_tax.to_country_id = bpl.countryId   or tz.to_country_id = bpl.countryId   or (c_tax.to_country_id is null       and (not exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id)           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_country_id = bpl.countryId)           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_country_id is null))))";sql=sql+" and (c_tax.to_region_id = bpl.regionId   or tz.to_region_id = bpl.regionId  or (c_tax.to_region_id is null       and (not exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id)           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_region_id = bpl.regionId)           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_region_id is null))))";}else{sql=sql+" and (c_tax.to_country_id = '"+bplCountryId+"'   or tz.to_country_id = '"+bplCountryId+"'   or (c_tax.to_country_id is null       and (not exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id)           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_country_id = '"+bplCountryId+"')           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_country_id is null))))";sql=sql+" and (c_tax.to_region_id = '"+bplRegionId+"'   or tz.to_region_id = '"+bplRegionId+"'  or (c_tax.to_region_id is null       and (not exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id)           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_region_id = '"+bplRegionId+"')           or exists (select 1 from c_tax_zone z where z.c_tax_id = c_tax.c_tax_id and z.to_region_id is null))))";}
sql=sql+" order by orderRegionTo, orderRegionFrom, orderCountryTo, orderCountryFrom, c_tax.validFrom desc, c_tax.isdefault desc";OB.UTIL.HookManager.executeHooks('OBPOS_FindTaxRate',{context:receipt,line:line,sql:sql},function(args){OB.Dal.queryUsingCache(OB.Model.TaxRate,args.sql,[],function(coll){if(coll&&coll.length>0){fulfill(coll);}else{reject(OB.I18N.getLabel('OBPOS_TaxNotFound_Message',[bpName,bpLocName]));}},function(){reject(OB.I18N.getLabel('OBPOS_TaxCalculationError_Message'));});});});};var calcProductTaxesIncPrice=function(receipt,line,taxCategory,orggross,discountedGross){return findTaxesCollection(receipt,line,taxCategory).then(function(coll){var linerate=BigDecimal.prototype.ONE;var linetaxid=coll.at(0).get('id');var validFromDate=coll.at(0).get('validFromDate');var taxamt=new BigDecimal(String(orggross));var baseTaxAmt;var baseTaxdcAmt;var taxamtdc;if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){taxamtdc=new BigDecimal(String(discountedGross));}
var fromCountryId=coll.at(0).get('country');var fromRegionId=coll.at(0).get('region');var toCountryId=coll.at(0).get('destinationCountry');var toRegionId=coll.at(0).get('destinationRegion');coll=_.filter(coll.models,function(taxRate){return(taxRate.get('destinationCountry')===toCountryId)&&(taxRate.get('destinationRegion')===toRegionId)&&(taxRate.get('country')===fromCountryId)&&(taxRate.get('region')===fromRegionId)&&(taxRate.get('validFromDate')===validFromDate);});var taxeslineAux={};var callbackTaxRate=function(taxRate,taxIndex,taxList){if(!taxRate.get('summaryLevel')){var taxId=taxRate.get('id');var rate=getTaxRateNumber(taxRate.get('rate'));if(taxRate.get('cascade')){linerate=linerate.multiply(rate.add(BigDecimal.prototype.ONE));taxamt=taxamt.multiply(new BigDecimal(String(OB.DEC.add(1,rate))));if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){taxamtdc=taxamtdc.multiply(new BigDecimal(String(OB.DEC.add(1,rate))));}}else if(taxRate.get('taxBase')){var baseTax=taxeslineAux[taxRate.get('taxBase')];if(!_.isUndefined(baseTax)){linerate=linerate.add(rate);baseTaxAmt=new BigDecimal(String(orggross)).add(new BigDecimal(String(baseTax.amount)));taxamt=taxamt.add(baseTaxAmt.multiply(rate));if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){baseTaxdcAmt=new BigDecimal(String(discountedGross)).add(new BigDecimal(String(baseTax.discAmount)));taxamtdc=taxamtdc.add(baseTaxdcAmt.multiply(rate));}}else{return;}}else{linerate=linerate.add(rate);taxamt=taxamt.add(new BigDecimal(String(orggross)).multiply(rate));if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){taxamtdc=taxamtdc.add(new BigDecimal(String(new BigDecimal(String(discountedGross)).multiply(rate))));}}
taxeslineAux[taxId]={};taxeslineAux[taxId].amount=new BigDecimal(String(orggross)).multiply(rate);if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){taxeslineAux[taxId].discAmount=new BigDecimal(String(discountedGross)).multiply(rate);}}else{linetaxid=taxRate.get('id');}
taxList.splice(taxList.indexOf(taxRate),1);};var collClone=coll.slice(0);while(collClone.length>0){_.each(collClone,callbackTaxRate);}
var linenet,roundedLinePriceNet,linepricenet,pricenet,discountedNet,pricenetcascade,discountedLinePriceNet,roundedDiscountedLinePriceNet;if(orggross===0){linenet=0;linepricenet=new BigDecimal('0');roundedLinePriceNet=0;}else{linenet=new BigDecimal(String(orggross)).multiply(new BigDecimal(String(orggross))).divide(new BigDecimal(String(taxamt)),20,BigDecimal.prototype.ROUND_HALF_UP);linepricenet=linenet.divide(new BigDecimal(String(line.get('qty'))),20,BigDecimal.prototype.ROUND_HALF_UP);linenet=OB.DEC.toNumber(linenet);roundedLinePriceNet=OB.DEC.toNumber(linepricenet);}
if(!line.get('tax')){line.set('tax',linetaxid,{silent:true});}
line.set({'taxAmount':OB.DEC.add(line.get('taxAmount'),OB.DEC.sub(orggross,linenet)),'net':OB.DEC.add(line.get('net'),linenet),'pricenet':OB.DEC.add(line.get('pricenet'),roundedLinePriceNet)});if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){if(taxamtdc&&OB.DEC.toNumber(taxamtdc)!==0){discountedNet=new BigDecimal(String(discountedGross)).multiply(new BigDecimal(String(discountedGross))).divide(new BigDecimal(String(taxamtdc)),20,BigDecimal.prototype.ROUND_HALF_UP);discountedLinePriceNet=discountedNet.divide(new BigDecimal(String(line.get('qty'))),20,BigDecimal.prototype.ROUND_HALF_UP);roundedDiscountedLinePriceNet=OB.DEC.toNumber(discountedLinePriceNet);discountedNet=OB.DEC.toNumber(discountedNet);pricenet=roundedDiscountedLinePriceNet;}else{discountedNet=0;pricenet=0;}}else{pricenet=roundedLinePriceNet;discountedNet=OB.DEC.mul(pricenet,new BigDecimal(String(line.get('qty'))));}
pricenetcascade=pricenet;line.set('discountedNet',OB.DEC.add(line.get('discountedNet'),discountedNet),{silent:true});var taxesline={};var callbackTaxLinesCreate=function(taxRate,taxIndex,taxList){var pricenetAux=pricenet;if(!taxRate.get('summaryLevel')){var taxId=taxRate.get('id');var rate=new BigDecimal(String(taxRate.get('rate')));rate=rate.divide(new BigDecimal('100'),20,BigDecimal.prototype.ROUND_HALF_UP);var net=discountedNet;if(taxRate.get('cascade')){pricenetAux=pricenetcascade;}else if(taxRate.get('taxBase')){var baseTax=taxesline[taxRate.get('taxBase')];if(!_.isUndefined(baseTax)){net=OB.DEC.add(OB.DEC.mul(pricenetAux,line.get('qty')),baseTax.amount);}else{return;}}
var amount=OB.DEC.mul(net,rate);pricenetcascade=OB.DEC.mul(pricenetAux,rate.add(BigDecimal.prototype.ONE));taxesline[taxId]={};taxesline[taxId].name=taxRate.get('name');taxesline[taxId].rate=taxRate.get('rate');taxesline[taxId].net=net;taxesline[taxId].amount=amount;}
taxList.splice(taxList.indexOf(taxRate),1);};collClone=coll.slice(0);while(collClone.length>0){_.each(collClone,callbackTaxLinesCreate);}
var summedTaxAmt=0;var expectedGross=(_.isNull(discountedGross)||_.isUndefined(discountedGross))?orggross:discountedGross;var greaterTax=null;_.each(coll,function(taxRate){if(!taxRate.get('summaryLevel')){var taxId=taxRate.get('id');summedTaxAmt=OB.DEC.add(summedTaxAmt,taxesline[taxId].amount);if((greaterTax===null||Math.abs(taxesline[greaterTax].amount)<Math.abs(taxesline[taxId].amount))){greaterTax=taxId;}}});var netandtax,adjustment;if(!(_.isNull(discountedGross)||_.isUndefined(discountedGross))){netandtax=OB.DEC.add(discountedNet,summedTaxAmt);}else{netandtax=OB.DEC.add(OB.DEC.mul(pricenet,line.get('qty')),summedTaxAmt);}
if(expectedGross!==netandtax){adjustment=OB.DEC.sub(expectedGross,netandtax);taxesline[greaterTax].amount=OB.DEC.add(taxesline[greaterTax].amount,adjustment);navigateTaxesTree(coll,greaterTax,function(tax){taxesline[tax.get('id')].net=OB.DEC.add(taxesline[tax.get('id')].net,adjustment);});}
var accumtaxesline=line.get('taxLines');_.each(taxesline,function(taxline,taxid){if(accumtaxesline[taxid]){accumtaxesline[taxid].net=OB.DEC.add(accumtaxesline[taxid].net,taxline.net);accumtaxesline[taxid].amount=OB.DEC.add(accumtaxesline[taxid].amount,taxline.amount);}else{accumtaxesline[taxid]={};accumtaxesline[taxid].name=taxline.name;accumtaxesline[taxid].rate=taxline.rate;accumtaxesline[taxid].net=taxline.net;accumtaxesline[taxid].amount=taxline.amount;}});var taxes=receipt.get('taxes');_.each(coll,function(taxRate){var taxId=taxRate.get('id');delete taxes[taxId];receipt.get('lines').each(function(line){var taxLines=line.get('taxLines');if(!taxLines||!taxLines[taxId]){return;}
if(!taxRate.get('summaryLevel')){if(taxes[taxId]){taxes[taxId].net=OB.DEC.add(taxes[taxId].net,taxLines[taxId].net);taxes[taxId].amount=OB.DEC.add(taxes[taxId].amount,taxLines[taxId].amount);}else{taxes[taxId]={};taxes[taxId].name=taxRate.get('name');taxes[taxId].docTaxAmount=taxRate.get('docTaxAmount');taxes[taxId].rate=taxRate.get('rate');taxes[taxId].net=taxLines[taxId].net;taxes[taxId].amount=taxLines[taxId].amount;}}});});_.each(coll,function(taxRate){var taxId=taxRate.get('id');if(taxes[taxId]){taxes[taxId].net=OB.DEC.toNumber(taxes[taxId].net);taxes[taxId].amount=OB.DEC.toNumber(taxes[taxId].amount);}});});};var calcLineTaxesIncPrice=function(receipt,line){line.set({'taxLines':{},'tax':null,'taxAmount':OB.DEC.Zero,'net':OB.DEC.Zero,'pricenet':OB.DEC.Zero,'discountedNet':OB.DEC.Zero,'linerate':BigDecimal.prototype.ONE},{silent:true});var product=line.get('product');var orggross=line.get('gross');var discountedGross=calculateDiscountedGross(line);return isTaxCategoryBOM(product.get('taxCategory')).then(function(isbom){if(isbom){return findTaxesCollection(receipt,line,product.get('taxCategory')).then(function(coll){line.set('tax',coll.at(0).get('id'),{silent:true});return getProductBOM(product.get('id')).then(function(data){distributeBOM(data,'bomgross',orggross);if(!_.isNull(discountedGross)){distributeBOM(data,'bomdiscountedgross',discountedGross);}
return Promise.all(_.map(data,function(productbom){return calcProductTaxesIncPrice(receipt,line,productbom.bomtaxcategory,productbom.bomgross,productbom.bomdiscountedgross);}));});});}else{return calcProductTaxesIncPrice(receipt,line,product.get('taxCategory'),orggross,discountedGross);}}).then(function(){line.set('linerate',(orggross===0||line.get('net')===0)?BigDecimal.prototype.ONE:OB.DEC.div(orggross,line.get('net')),{silent:true});})['catch'](function(reason){var title=OB.I18N.getLabel('OBPOS_TaxNotFound_Header');OB.error(title+":"+reason);line.set('hasTaxError',true,{silent:true});receipt.set('preventServicesUpdate',true);receipt.set('deleting',true);receipt.deleteLine(line);receipt.unset('preventServicesUpdate');receipt.unset('deleting');receipt.get('lines').trigger('updateRelations');OB.MobileApp.view.$.containerWindow.getRoot().doShowPopup({popup:'OB_UI_MessageDialog',args:{header:title,message:reason}});});};var calcTaxesIncPrice=function(receipt){receipt.set({'taxes':{},'net':OB.DEC.Zero},{silent:true});return Promise.all(_.map(receipt.get('lines').models,function(line){return calcLineTaxesIncPrice(receipt,line);})).then(function(){var taxFinal;var newNet;var newAmount;var adjustAmount;var candidateLine=null;var candidateTaxLineAmount=OB.DEC.Zero;var totalGross=OB.DEC.Zero;var newTotalTaxAmount=OB.DEC.Zero;var newTotalNet=OB.DEC.Zero;_.forEach(receipt.get('taxes'),function(tax,taxid){if(tax.docTaxAmount==='D'){taxFinal=OB.DEC.add(tax.net,tax.amount);newNet=OB.DEC.div(taxFinal,getTaxRateNumber(tax.rate).add(new BigDecimal('1')));newAmount=OB.DEC.sub(taxFinal,newNet);adjustAmount=OB.DEC.sub(tax.amount,newAmount);tax.net=newNet;tax.amount=newAmount;if(adjustAmount!==0){receipt.get('lines').forEach(function(line){if(!_.isUndefined(line.get('discountedNet'))){_.each(line.get('taxLines'),function(taxline,taxlineid){if(taxid===taxlineid&&Math.sign(newAmount)===Math.sign(taxline.amount)){if(OB.DEC.abs(taxline.amount)>candidateTaxLineAmount){candidateTaxLineAmount=OB.DEC.abs(candidateTaxLineAmount);candidateLine=line;}}});}});if(candidateLine){candidateLine.set('discountedNet',OB.DEC.add(candidateLine.get('discountedNet'),adjustAmount),{silent:true});}}}
newTotalTaxAmount=OB.DEC.add(newTotalTaxAmount,tax.amount);});receipt.get('lines').forEach(function(line){if(!_.isUndefined(line.get('discountedNet'))){totalGross=OB.DEC.add(totalGross,calculateDiscountedGross(line));}});newTotalNet=OB.DEC.sub(totalGross,newTotalTaxAmount);receipt.set('net',newTotalNet,'taxAmount',newTotalTaxAmount,{silent:true});});};var calcProductTaxesExcPrice=function(receipt,line,taxCategory,linepricenet,linenet,discountedprice,discountedNet){return findTaxesCollection(receipt,line,taxCategory).then(function(coll){var linetaxid=coll.at(0).get('id');var validFromDate=coll.at(0).get('validFromDate');var fromCountryId=coll.at(0).get('country');var fromRegionId=coll.at(0).get('region');var toCountryId=coll.at(0).get('destinationCountry');var toRegionId=coll.at(0).get('destinationRegion');coll=_.filter(coll.models,function(taxRate){return(taxRate.get('destinationCountry')===toCountryId)&&(taxRate.get('destinationRegion')===toRegionId)&&(taxRate.get('country')===fromCountryId)&&(taxRate.get('region')===fromRegionId)&&(taxRate.get('validFromDate')===validFromDate);});var discountedGross=new BigDecimal(String(discountedNet));var linegross=new BigDecimal(String(linenet));var pricenet=new BigDecimal(String(discountedprice))||(new BigDecimal(String(linepricenet)));var pricenetcascade=pricenet;var taxes=receipt.get('taxes');var taxesline={};var callbackNotInclTax=function(taxRate,taxIndex,taxList){var pricenetAux=pricenet;if(!taxRate.get('summaryLevel')){var taxId=taxRate.get('id');var rate=getTaxRateNumber(taxRate.get('rate'));var net=OB.DEC.mul(pricenetAux,line.get('qty'));if(taxRate.get('cascade')){linegross=linegross.multiply(rate.add(BigDecimal.prototype.ONE));discountedGross=discountedGross.add(new BigDecimal(OB.DEC.toNumber(discountedGross.multiply(rate)).toString()));pricenetAux=pricenetcascade;}else if(taxRate.get('taxBase')){var baseTax=taxesline[taxRate.get('taxBase')];if(!_.isUndefined(baseTax)){net=OB.DEC.add(OB.DEC.mul(pricenetAux,line.get('qty')),baseTax.amount);var baseAmount=new BigDecimal(String(linenet)).add(new BigDecimal(String(baseTax.amount)));linegross=linegross.add(baseAmount.multiply(new BigDecimal(String(rate))));var discBaseAmount=new BigDecimal(String(discountedNet)).add(new BigDecimal(String(baseTax.amount)));discountedGross=discountedGross.add(discBaseAmount.multiply(new BigDecimal(String(rate))));}else{return;}}else{linegross=linegross.add(new BigDecimal(String(linenet)).multiply(new BigDecimal(String(rate))));discountedGross=discountedGross.add(new BigDecimal(OB.DEC.toNumber(new BigDecimal(String(discountedNet)).multiply(rate)).toString()));}
var roundingLoses;var amount=OB.DEC.mul(net,rate);pricenetcascade=pricenetAux.multiply(rate.add(BigDecimal.prototype.ONE));taxesline[taxId]={};taxesline[taxId].name=taxRate.get('name');taxesline[taxId].rate=taxRate.get('rate');taxesline[taxId].net=net;taxesline[taxId].amount=amount;if(taxes[taxId]){taxes[taxId].net=OB.DEC.add(taxes[taxId].net,OB.DEC.mul(discountedprice,line.get('qty')));if(discountedNet!==linenet){roundingLoses=discountedprice.subtract(discountedprice).multiply(new BigDecimal('2'));if(roundingLoses.compareTo(BigDecimal.prototype.ZERO)!==0){roundingLoses=OB.DEC.toNumber(roundingLoses);taxes[taxId].net=OB.DEC.add(taxes[taxId].net,roundingLoses);}}
taxes[taxId].amount=OB.DEC.add(taxes[taxId].amount,amount);}else{taxes[taxId]={};taxes[taxId].name=taxRate.get('name');taxes[taxId].rate=taxRate.get('rate');taxes[taxId].docTaxAmount=taxRate.get('docTaxAmount');taxes[taxId].net=net;if(discountedNet!==linenet){roundingLoses=discountedprice.subtract(discountedprice).multiply(new BigDecimal('2'));if(roundingLoses.compareTo(BigDecimal.prototype.ZERO)!==0){roundingLoses=OB.DEC.toNumber(roundingLoses);taxes[taxId].net=OB.DEC.add(taxes[taxId].net,roundingLoses);}}
taxes[taxId].amount=amount;}}else{linetaxid=taxRate.get('id');}
taxList.splice(taxList.indexOf(taxRate),1);};var collClone=coll.slice(0);while(collClone.length>0){_.each(collClone,callbackNotInclTax);}
var accumtaxesline=line.get('taxLines');_.each(taxesline,function(taxline,taxid){if(accumtaxesline[taxid]){accumtaxesline[taxid].net=OB.DEC.add(accumtaxesline[taxid].net,taxline.net);accumtaxesline[taxid].amount=OB.DEC.add(accumtaxesline[taxid].amount,taxline.amount);}else{accumtaxesline[taxid]={};accumtaxesline[taxid].name=taxline.name;accumtaxesline[taxid].rate=taxline.rate;accumtaxesline[taxid].net=taxline.net;accumtaxesline[taxid].amount=taxline.amount;}});if(!line.get('tax')){line.set('tax',linetaxid,{silent:true});}
line.set({'gross':OB.DEC.add(line.get('gross'),OB.DEC.sub(OB.DEC.toNumber(linegross),linenet)),'discountedGross':OB.DEC.add(line.get('discountedGross'),OB.DEC.sub(OB.DEC.toNumber(discountedGross),discountedNet))},{silent:true});});};var calcLineTaxesExcPrice=function(receipt,line){line.set({'pricenet':line.get('price'),'net':OB.DEC.mul(line.get('price'),line.get('qty')),'linerate':OB.DEC.One,'tax':null,'taxAmount':OB.DEC.Zero,'taxLines':{}},{silent:true});var resultpromise;var product=line.get('product');if(line.get('ignoreTaxes')===true||product.get('ignoreTaxes')===true){var taxLine=line.get('taxLines');taxLine[OB.MobileApp.model.get('terminal').taxexempid]={amount:0,rate:0,net:line.get('net')};line.set({'tax':OB.MobileApp.model.get('terminal').taxexempid,'discountedNet':line.get('net'),'discountedNetPrice':new BigDecimal(String(line.get('price'))),'gross':line.get('net'),'discountedGross':line.get('net')},{silent:true});resultpromise=Promise.resolve();}else{var linepricenet=line.get('price');var linenet=line.get('net');var discAmt=null;var discountedprice,discountedNet;if(line.get('promotions')&&line.get('promotions').length>0){discAmt=new BigDecimal(String(line.get('net')));discAmt=line.get('promotions').reduce(function(memo,element){return memo.subtract(new BigDecimal(String(element.actualAmt||element.amt||0)));},discAmt);discountedprice=discAmt.divide(new BigDecimal(String(line.get('qty'))),20,BigDecimal.prototype.ROUND_HALF_UP);discountedNet=OB.DEC.toNumber(discAmt);}else{discountedprice=new BigDecimal(String(line.get('price')));discountedNet=linenet;}
line.set({'discountedNet':discountedNet,'discountedNetPrice':OB.DEC.toNumber(discountedprice),'gross':linenet,'discountedGross':discountedNet},{silent:true});resultpromise=isTaxCategoryBOM(product.get('taxCategory')).then(function(isbom){if(isbom){return findTaxesCollection(receipt,line,product.get('taxCategory')).then(function(coll){line.set('tax',coll.at(0).get('id'),{silent:true});return getProductBOM(product.get('id')).then(function(data){distributeBOM(data,'bomnet',linenet);distributeBOM(data,'bomdiscountednet',discountedNet);distributeBOM(data,'bomlinepricenet',linepricenet);return Promise.all(_.map(data,function(productbom){return calcProductTaxesExcPrice(receipt,line,productbom.bomtaxcategory,productbom.bomlinepricenet,productbom.bomnet,new BigDecimal(String(productbom.bomdiscountednet)).divide(new BigDecimal(String(line.get('qty'))),20,BigDecimal.prototype.ROUND_HALF_UP),productbom.bomdiscountednet);}));});});}else{return calcProductTaxesExcPrice(receipt,line,product.get('taxCategory'),linepricenet,linenet,discountedprice,discountedNet);}});}
return resultpromise.then(function(){line.set({'linerate':(line.get('gross')===0||line.get('net')===0)?BigDecimal.prototype.ONE:OB.DEC.div(line.get('gross'),line.get('net')),'taxAmount':OB.DEC.sub(line.get('discountedGross'),line.get('discountedNet'))},{silent:true});})['catch'](function(reason){var title=OB.I18N.getLabel('OBPOS_TaxNotFound_Header');OB.error(title+":"+reason);line.set('hasTaxError',true,{silent:true});receipt.set('preventServicesUpdate',true);receipt.set('deleting',true);receipt.deleteLine(line);receipt.unset('preventServicesUpdate');receipt.unset('deleting');receipt.get('lines').trigger('updateRelations');OB.MobileApp.view.$.containerWindow.getRoot().doShowPopup({popup:'OB_UI_MessageDialog',args:{header:title,message:reason}});});};var calcTaxesExcPrice=function(receipt){receipt.set('taxes',{},{silent:true});return Promise.all(_.map(receipt.get('lines').models,function(line){return calcLineTaxesExcPrice(receipt,line);})).then(function(){var newAmount;var adjustAmount;var candidateLine=null;var candidateTaxLineAmount=OB.DEC.Zero;var totalNet=OB.DEC.Zero;_.forEach(receipt.get('taxes'),function(tax,taxid){if(tax.docTaxAmount==='D'){newAmount=OB.DEC.mul(tax.net,getTaxRateNumber(tax.rate));adjustAmount=OB.DEC.sub(tax.amount,newAmount);tax.amount=newAmount;if(adjustAmount!==0){receipt.get('lines').forEach(function(line){_.each(line.get('taxLines'),function(taxline,taxlineid){if(taxid===taxlineid&&Math.sign(newAmount)===Math.sign(taxline.amount)){if(OB.DEC.abs(taxline.amount)>candidateTaxLineAmount){candidateTaxLineAmount=OB.DEC.abs(candidateTaxLineAmount);candidateLine=line;}}});});if(candidateLine){candidateLine.set({'discountedGross':OB.DEC.sub(candidateLine.get('discountedGross'),adjustAmount),'gross':OB.DEC.sub(candidateLine.get('gross'),adjustAmount)},{silent:true});}}}});receipt.get('lines').forEach(function(line){totalNet=OB.DEC.add(totalNet,line.get('discountedNet'));});receipt.set('net',totalNet,{silent:true});});};var calcTaxes=function(receipt){if(receipt.get('priceIncludesTax')){return calcTaxesIncPrice(receipt);}else{return calcTaxesExcPrice(receipt);}};OB.DATA.OrderTaxes=function(modelOfAnOrder){modelOfAnOrder.calculateTaxes=function(callback){var me=this;var synchId;synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('taxescalculation');calcTaxes(me).then(function(){me.trigger('paintTaxes');callback();OB.UTIL.SynchronizationHelper.finished(synchId,'taxescalculation');});};};}());(function(){OB.DATA=window.OB.DATA||{};OB.DATA.CustomerSave=function(model){this.context=model;this.customer=model.get('customer');this.customer.on('customerSaved',function(){var me=this,customersList,customerId=this.customer.get('id'),isNew=false,bpToSave=new OB.Model.ChangedBusinessPartners(),bpLocation,bpLocToSave=new OB.Model.BPLocation(),customersListToChange;bpToSave.set('isbeingprocessed','N');this.customer.set('createdBy',OB.MobileApp.model.get('orgUserId'));bpToSave.set('createdBy',OB.MobileApp.model.get('orgUserId'));if(customerId){this.customer.set('posTerminal',OB.MobileApp.model.get('terminal').id);bpToSave.set('json',JSON.stringify(this.customer.serializeToJSON()));bpToSave.set('c_bpartner_id',this.customer.get('id'));}else{isNew=true;}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){if(isNew){me.customer.set('posTerminal',OB.MobileApp.model.get('terminal').id);var uuid=OB.UTIL.get_UUID();me.customer.set('id',uuid);me.customer.id=uuid;bpToSave.set('json',JSON.stringify(me.customer.serializeToJSON()));bpToSave.set('id',me.customer.get('id'));}
if(!bpToSave.get('locationModel')){bpLocation=new OB.Model.BPLocation();bpLocation.set('id',me.customer.get('locId'));bpLocation.set('bpartner',me.customer.get('id'));bpLocation.set('name',me.customer.get('locName'));bpLocation.set('postalCode',me.customer.get('postalCode'));bpLocation.set('cityName',me.customer.get('cityName'));bpLocation.set('_identifier',me.customer.get('locName'));bpLocation.set('countryName',OB.MobileApp.model.get('terminal').defaultbp_bpcountry_name);bpLocation.set('countryId',OB.MobileApp.model.get('terminal').defaultbp_bpcountry);bpToSave.set('locationModel',bpLocation);}
bpToSave.set('isbeingprocessed','Y');OB.UTIL.HookManager.executeHooks('OBPOS_PostCustomerSave',{customer:me.customer,bpToSave:bpToSave},function(args){OB.Dal.save(bpToSave,function(){bpToSave.set('json',me.customer.serializeToJSON());var successCallback=function(){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_customerSaved',[me.customer.get('_identifier')]));};OB.MobileApp.model.runSyncProcess(successCallback);},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_errorSavingCustomerChanges',[me.customer.get('_identifier')]));},isNew);});}else{OB.Dal.save(this.customer,function(){if(!isNew){OB.Dal.get(OB.Model.BPLocation,me.customer.get('locId'),function(bpLocToUpdate){if(bpLocToUpdate){bpLocToUpdate.set('name',me.customer.get('locName'));bpLocToUpdate.set('postalCode',me.customer.get('postalCode'));bpLocToUpdate.set('cityName',me.customer.get('cityName'));bpLocToUpdate.set('_identifier',me.customer.get('locName'));OB.Dal.save(bpLocToUpdate,function(){},function(){OB.error(arguments);},isNew);}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_errorSavingBPLoc_header'),OB.I18N.getLabel('OBPOS_errorSavingBPLoc_body'));}},function(){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_errorSavingBPLoc_header'),OB.I18N.getLabel('OBPOS_errorSavingBPLoc_body'));});}else{bpLocToSave.set('id',me.customer.get('locId'));bpLocToSave.set('bpartner',me.customer.get('id'));bpLocToSave.set('name',me.customer.get('locName'));bpLocToSave.set('postalCode',me.customer.get('postalCode'));bpLocToSave.set('cityName',me.customer.get('cityName'));bpLocToSave.set('_identifier',me.customer.get('locName'));bpLocToSave.set('countryName',OB.MobileApp.model.get('terminal').defaultbp_bpcountry_name);bpLocToSave.set('countryId',OB.MobileApp.model.get('terminal').defaultbp_bpcountry);OB.Dal.save(bpLocToSave,function(){},function(){OB.error(arguments);},isNew);}
if(isNew){me.customer.set('posTerminal',OB.MobileApp.model.get('terminal').id);bpToSave.set('json',JSON.stringify(me.customer.serializeToJSON()));bpToSave.set('c_bpartner_id',me.customer.get('id'));}
bpToSave.set('isbeingprocessed','Y');OB.UTIL.HookManager.executeHooks('OBPOS_PostCustomerSave',{customer:me.customer,bpToSave:bpToSave},function(args){OB.Dal.save(bpToSave,function(){bpToSave.set('json',me.customer.serializeToJSON());var successCallback,errorCallback,List;successCallback=function(){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_customerSaved',[me.customer.get('_identifier')]));};OB.MobileApp.model.runSyncProcess(successCallback);},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_errorSavingCustomerChanges',[me.customer.get('_identifier')]));});});},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_errorSavingCustomerLocally',[me.customer.get('_identifier')]));});}},this);};}());(function(){OB.DATA=window.OB.DATA||{};OB.DATA.CustomerAddrSave=function(model){this.context=model;this.customerAddr=model.get('customerAddr');this.customerAddr.on('customerAddrSaved',function(){var me=this,customerAddrList,customerAddrId=this.customerAddr.get('id'),isNew=false,bpLocToSave=new OB.Model.ChangedBPlocation(),customerAddrListToChange;bpLocToSave.set('isbeingprocessed','N');this.customerAddr.set('createdBy',OB.MobileApp.model.get('orgUserId'));bpLocToSave.set('createdBy',OB.MobileApp.model.get('orgUserId'));if(customerAddrId){this.customerAddr.set('posTerminal',OB.MobileApp.model.get('terminal').id);bpLocToSave.set('json',JSON.stringify(this.customerAddr.serializeToJSON()));bpLocToSave.set('c_bpartner_location_id',this.customerAddr.get('id'));}else{isNew=true;}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){if(isNew){me.customerAddr.set('posTerminal',OB.MobileApp.model.get('terminal').id);var uuid=OB.UTIL.get_UUID();me.customerAddr.set('id',uuid);me.customerAddr.id=uuid;bpLocToSave.set('json',JSON.stringify(me.customerAddr.serializeToJSON()));bpLocToSave.set('id',me.customerAddr.get('id'));}
bpLocToSave.set('isbeingprocessed','Y');OB.Dal.save(bpLocToSave,function(){bpLocToSave.set('json',me.customerAddr.serializeToJSON());var successCallback,errorCallback,List;successCallback=function(){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_customerAddrSaved',[me.customerAddr.get('_identifier')]));};customerAddrListToChange=new OB.Collection.ChangedBPlocationList();customerAddrListToChange.add(bpLocToSave);OB.MobileApp.model.runSyncProcess(successCallback);},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_errorSavingCustomerAddrChn',[me.customerAddr.get('_identifier')]));},isNew);}else{OB.Dal.save(this.customerAddr,function(){function errorCallback(tx,error){OB.error(tx);}
function successCallbackBPs(dataBps){if(dataBps.length===0){OB.Dal.get(OB.Model.BusinessPartner,me.customerAddr.get('bpartner'),function success(dataBps){dataBps.set('locId',me.customerAddr.get('id'));dataBps.set('locName',me.customerAddr.get('name'));OB.Dal.save(dataBps,function(){},function(tx){OB.error(tx);});},function error(tx){OB.error(tx);});}}
var criteria={};criteria._whereClause="where c_bpartner_id = '"+me.customerAddr.get('bpartner')+"' and c_bpartnerlocation_id > '"+me.customerAddr.get('id')+"'";criteria.params=[];OB.Dal.find(OB.Model.BusinessPartner,criteria,successCallbackBPs,errorCallback);if(isNew){me.customerAddr.set('posTerminal',OB.MobileApp.model.get('terminal').id);bpLocToSave.set('json',JSON.stringify(me.customerAddr.serializeToJSON()));bpLocToSave.set('c_bpartner_location_id',me.customerAddr.get('id'));}
bpLocToSave.set('isbeingprocessed','Y');OB.Dal.save(bpLocToSave,function(){bpLocToSave.set('json',me.customerAddr.serializeToJSON());var successCallback,errorCallback,List;successCallback=function(){OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_customerAddrSaved',[me.customerAddr.get('_identifier')]));};customerAddrListToChange=new OB.Collection.ChangedBPlocationList();customerAddrListToChange.add(bpLocToSave);OB.MobileApp.model.runSyncProcess(successCallback);},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_errorSavingCustomerAddrChn',[me.customerAddr.get('_identifier')]));});},function(){OB.error(arguments);OB.UTIL.showError(OB.I18N.getLabel('OBPOS_errorSavingCustomerAddrLocally',[me.customerAddr.get('_identifier')]));});}},this);};}());(function(){OB.DATA=window.OB.DATA||{};OB.DATA.OrderDiscount=function(receipt){receipt.on('discount',function(line,percentage){if(line){if(OB.DEC.compare(percentage)>0&&OB.DEC.compare(OB.DEC.sub(percentage,OB.DEC.number(100)))<=0){receipt.setPrice(line,OB.DEC.toNumber(new BigDecimal(String(line.get('price'))).multiply(new BigDecimal(String(OB.DEC.sub(OB.DEC.number(100),percentage)))).divide(new BigDecimal("100"),OB.DEC.getScale(),OB.DEC.getRoundingMode())));}else if(OB.DEC.compare(percentage)===0){receipt.setPrice(line,line.get('price'));}}},this);};}());enyo.kind({name:'OB.UI.ModalReceipts',kind:'OB.UI.Modal',topPosition:'125px',published:{receiptsList:null},i18nHeader:'OBPOS_LblAssignReceipt',body:{kind:'OB.UI.ListReceipts',name:'listreceipts'},receiptsListChanged:function(oldValue){this.$.body.$.listreceipts.setReceiptsList(this.receiptsList);}});enyo.kind({name:'OB.UI.ListReceipts',classes:'row-fluid',published:{receiptsList:null},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;'},{components:[{name:'receiptslistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.UI.ListReceiptLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}],receiptsListChanged:function(oldValue){this.$.receiptslistitemprinter.setCollection(this.receiptsList);}});enyo.kind({name:'OB.UI.ListReceiptLine',kind:'OB.UI.SelectButton',events:{onHideThisPopup:'',onChangeCurrentOrder:''},tap:function(){this.inherited(arguments);this.doChangeCurrentOrder({newCurrentOrder:this.model});this.doHideThisPopup();},components:[{name:'line',style:'line-height: 23px; width: 100%;',components:[{components:[{style:'float: left; width: 15%',name:'time'},{style:'float: left; width: 25%',name:'orderNo'},{style:'float: left; width: 60%',name:'bp'},{style:'clear: both;'}]},{components:[{style:'float: left; width: 15%; font-weight: bold;'},{style:'float: left; width: 25%; font-weight: bold;'},{style:'float: right; text-align: right; width: 25%; font-weight: bold;',name:'total'},{style:'clear: both;'}]}]}],create:function(){this.inherited(arguments);if(this.model.get('isPaid')){this.$.time.setContent(OB.I18N.formatDate(this.model.get('orderDate')));}else{this.$.time.setContent(OB.I18N.formatHour(this.model.get('orderDate')));}
this.$.orderNo.setContent(this.model.get('documentNo'));this.$.bp.setContent(this.model.get('bp').get('_identifier'));this.$.total.setContent(this.model.printTotal());OB.UTIL.HookManager.executeHooks('OBPOS_RenderListReceiptLine',{listReceiptLine:this},function(args){});}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalDeleteReceipt',bodyContent:{i18nContent:'OBPOS_MsgConfirmDelete'},bodyButtons:{components:[{kind:'OB.UI.btnModalApplyDelete'},{kind:'OB.UI.btnModalCancelDelete'}]},initComponents:function(){this.header=OB.I18N.getLabel('OBPOS_ConfirmDeletion');this.inherited(arguments);}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.btnModalApplyDelete',isDefaultAction:true,i18nContent:'OBPOS_LblYesDelete',events:{onDeleteOrder:''},tap:function(){this.doHideThisPopup();this.doDeleteOrder({notSavedOrder:true});}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.btnModalCancelDelete',i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalMultiOrdersLayaway',executeOnShow:function(){this.$.bodyButtons.$.btnModalMultiSearchInput.setValue('');},bodyContent:{i18nContent:'OBPOS_MultiOrdersLayaway'},bodyButtons:{components:[{name:'btnModalMultiSearchInput',kind:'OB.UI.SearchInput'},{kind:'OB.UI.btnApplyMultiLayaway'}]},initComponents:function(){this.header=OB.I18N.getLabel('OBPOS_MultiOrdersLayawayHeader');this.inherited(arguments);}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.btnApplyMultiLayaway',isDefaultAction:true,i18nContent:'OBPOS_LblApplyButton',tap:function(){var amount=OB.DEC.Zero,total=OB.DEC.Zero,tmp;if(this.owner.$.btnModalMultiSearchInput.getValue().indexOf('%')!==-1){try{tmp=this.owner.$.btnModalMultiSearchInput.getValue().replace('%','');amount=OB.DEC.div(OB.DEC.mul(this.model.get('multiOrders').get('multiOrdersList').get(this.owner.owner.args.id).getPending(),tmp),100);}catch(ex){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_notValidInput_header'),OB.I18N.getLabel('OBPOS_notValidQty'));return;}}else{try{amount=OB.I18N.parseNumber(this.owner.$.btnModalMultiSearchInput.getValue());}catch(exc){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_notValidInput_header'),OB.I18N.getLabel('OBPOS_notValidQty'));return;}}
if(_.isNaN(amount)){this.model.get('multiOrders').get('multiOrdersList').get(this.owner.owner.args.id).setOrderType(null,0);this.model.get('multiOrders').get('multiOrdersList').get(this.owner.owner.args.id).set('amountToLayaway',null);this.doHideThisPopup();return;}
total=this.model.get('multiOrders').get('multiOrdersList').get(this.owner.owner.args.id).get('gross');if(OB.DEC.compare(OB.DEC.sub(amount,total))>0||OB.DEC.compare(amount)<0){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_notValidInput_header'),OB.I18N.getLabel('OBPOS_notValidQty'));this.doHideThisPopup();return;}
this.model.get('multiOrders').get('multiOrdersList').get(this.owner.owner.args.id).set('amountToLayaway',amount);this.model.get('multiOrders').get('multiOrdersList').get(this.owner.owner.args.id).setOrderType(null,2);this.doHideThisPopup();},init:function(model){this.model=model;}});enyo.kind({name:'OB.UI.RenderCategory',kind:'OB.UI.listItemButton',components:[{style:'float: left; width: 25%',components:[{kind:'OB.UI.Thumbnail',name:'thumbnail'}]},{style:'float: left; width: 75%;',components:[{name:'identifier',style:'padding-left: 5px;'},{style:'clear:both;'}]}],initComponents:function(){this.inherited(arguments);this.addClass('btnselect-browse');this.$.identifier.setContent(this.model.get('_identifier'));this.$.thumbnail.setImg(this.model.get('img'));OB.UTIL.HookManager.executeHooks('OBPOS_RenderCategory',{context:this},function(args){});}});enyo.kind({name:'OB.UI.RenderProduct',kind:'OB.UI.listItemButton',components:[{style:'max-width: 100%;',components:[{style:'display: table-cell; vertical-align: top;  width: 50px;',components:[{tag:'div',classes:'image-wrap',contentType:'image/png',style:'width: 49px; height: 49px;',components:[{tag:'img',name:'icon',style:'margin: auto; height: 100%; width: 100%; background-size: contain; background-repeat:no-repeat; background-position:center;'}]},{kind:'OB.UI.Thumbnail',name:'thumbnail'}]},{style:'display: table-cell; min-width: 10px;'},{style:'display: table-cell; vertical-align: top; width: 100%; word-break: break-word;',name:'identifierContainer',components:[{name:'identifier',style:'max-height: 70px; overflow: hidden;'},{style:'color: #888888',name:'filterAttr',allowHtml:true}]},{style:'display: table-cell; min-width: 10px;'},{name:'bestseller',style:'display: table-cell; min-width: 21px; height: 16px;',kind:'OB.UI.Thumbnail.Bestseller','default':'img/iconBestsellerSmall.png',showing:false},{style:'display: table-cell; vertical-align: top; ',components:[{style:'width: 100%;',components:[{name:'price',style:'float: right; text-align: right; font-weight: bold;'},{name:'priceList',style:'width: 100%; text-align: right; font-weight: bold; color: grey; font-size: 14px;'}]}]}]},{style:'clear:both;'},{name:'generic',style:'float: right; width: 30%; text-align: right; font-style: italic; color: grey; font-weight: bold;',showing:false},{style:'clear:both;'},{style:'color: #888888; float: left; width: 100%; text-align: left; font-style: italic; color: grey; font-size: 13px; padding-top: 10px;',name:'bottonLine'}],initComponents:function(){this.inherited(arguments);var filterTxt='',filterAttr=this.model.get("filterAttr");if(filterAttr&&_.isArray(filterAttr)&&filterAttr.length>0){filterAttr.forEach(function(attr){if(filterTxt!==''){filterTxt=filterTxt+attr.separator;}
filterTxt=filterTxt+attr.value;});}
this.$.identifierContainer.addStyles('width: 38%;');this.$.identifier.setContent(this.setIdentifierContent());this.$.filterAttr.setContent(filterTxt);if(this.model.get('showchdesc')){this.$.bottonLine.setContent(this.model.get('characteristicDescription'));}
if(this.model.get('currentStandardPrice')&&this.model.get('currentStandardPrice')!=="undefined"){if(OB.MobileApp.model.hasPermission('ShowStandardPriceOnSearchAndBrowse',true)){this.$.priceList.setContent(OB.I18N.formatCurrency(this.model.get('currentStandardPrice')));}
this.$.price.setContent(OB.I18N.formatCurrency(this.model.get('standardPrice')));}else{this.$.price.setContent(OB.I18N.formatCurrency(this.model.get('standardPrice')));}
if(OB.MobileApp.model.get('permissions')["OBPOS_retail.productImages"]){this.$.icon.applyStyle('background-image','url('+OB.UTIL.getImageURL(this.model.get('id'))+'), url('+"../org.openbravo.mobile.core/assets/img/box.png"+')');this.$.thumbnail.hide();}else{this.$.thumbnail.setImg(this.model.get('img'));this.$.icon.parent.hide();}
if(this.model.get('bestseller')!==true){this.$.bestseller.applyStyle('min-width','0px !important');this.$.bestseller.applyStyle('width','0px');this.$.bestseller.$.image.hide();}
if(OB.MobileApp.model.hasPermission('OBPOS_HideProductImagesInSearchAndBrowse',true)){this.$.thumbnail.hide();this.$.icon.parent.hide();this.$.identifierContainer.addStyles('width: 70%;');}
if(this.model.get('isGeneric')){this.$.generic.setContent(OB.I18N.getLabel('OBMOBC_LblGeneric'));this.$.generic.show();}},setIdentifierContent:function(){return this.model.get('_identifier');}});enyo.kind({name:'OB.UI.Thumbnail.Bestseller',kind:'OB.UI.Thumbnail',drawImage:function(){this.inherited(arguments);this.$.image.applyStyle('background-position','0px 0px');this.$.image.applyStyle('background-color','transparent');this.$.image.applyStyle('background-size','14px 16px !important');},initComponents:function(){this.inherited(arguments);this.removeClass('image-wrap');}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.RenderProductCh',style:'width: 86%; padding: 0px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;',classes:'btnlink-white-simple',events:{onShowPopup:''},tap:function(){if(!this.disabled){this.doShowPopup({popup:'modalproductcharacteristic',args:{model:this.model}});}},initComponents:function(){this.inherited(arguments);if(this.model.get('_identifier').length<13){this.setContent(this.model.get('_identifier'));}else{this.setContent(this.model.get('_identifier').substring(0,10)+'...');}
if(this.model.get('filtering')){this.addClass('btnlink-yellow-bold');}}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.RenderEmptyCh',style:'width: 86%; border: 2px solid #cccccc;',classes:'btnlink-white',events:{onClearAction:''},tap:function(){this.doClearAction();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_ClearFilters'));}});enyo.kind({name:'OB.UI.Total',tag:'span',attributes:{style:'font-weight:bold;'},renderTotal:function(total){this.setContent(OB.I18N.formatCurrency(total));}});enyo.kind({name:'OB.UI.ModalPayment',kind:'OB.UI.ModalAction',header:'',maxheight:'600px',bodyContent:{},bodyButtons:{},executeOnShow:function(){this.$.header.setContent(this.args.receipt.getTotal()>0?OB.I18N.getLabel('OBPOS_LblModalPayment',[OB.I18N.formatCurrency(this.args.amount)]):OB.I18N.getLabel('OBPOS_LblModalReturn',[OB.I18N.formatCurrency(this.args.amount)]));this.$.bodyContent.destroyComponents();this.closeOnEscKey=this.dfCloseOnEscKey;this.autoDismiss=this.dfAutoDismiss;this.executeOnShown=null;this.executeBeforeHide=null;this.executeOnHide=null;this.$.bodyContent.createComponent({mainPopup:this,kind:this.args.provider,paymentMethod:this.args.paymentMethod,paymentType:this.args.name,paymentAmount:this.args.amount,isocode:this.args.isocode,key:this.args.key,receipt:this.args.receipt,allowOpenDrawer:this.args.paymentMethod.allowopendrawer,isCash:this.args.paymentMethod.iscash,openDrawer:this.args.paymentMethod.openDrawer}).render();},initComponents:function(){this.inherited(arguments);this.dfAutoDismiss=this.autoDismiss;this.dfCloseOnEscKey=this.closeOnEscKey;}});enyo.kind({name:'OB.UI.ModalPaymentVoid',kind:'OB.UI.ModalAction',header:'',maxheight:'600px',bodyContent:{},bodyButtons:{},executeOnShow:function(){this.$.header.setContent(OB.I18N.getLabel('OBPOS_LblModalVoidTransaction',[OB.I18N.formatCurrency(this.args.amount)]));this.$.headerCloseButton.hide();this.autoDismiss=false;}});enyo.kind({kind:'OB.UI.listItemButton',name:'OB.UI.RenderOrderLine',classes:'btnselect-orderline',handlers:{onChangeEditMode:'changeEditMode',onCheckBoxBehaviorForTicketLine:'checkBoxForTicketLines',onSetMultiSelected:'setMultiSelected',onkeyup:'keyupHandler'},tap:function(){if(OB.MobileApp.model.get('serviceSearchMode')){return;}
this.model.trigger('selected',this.model);this.model.trigger('click',this.model);},events:{onLineChecked:''},components:[{name:'checkBoxColumn',kind:'OB.UI.CheckboxButton',tag:'div',tap:function(){},style:'float: left; width: 10%;'},{name:'nameContainner',tag:'div',style:'float: left;width: 40%; padding: 0px;',components:[{name:'serviceIcon',kind:'Image',src:'img/iconService_ticketline.png',style:'float: left; padding-right: 5px; '},{name:'product'}]},{name:'quantity',attributes:{style:'float: left; width: 20%; text-align: right;'}},{name:'price',attributes:{style:'float: left; width: 20%; text-align: right;'}},{name:'gross',attributes:{style:'float: left; width: 20%; text-align: right;'}},{style:'clear: both;'}],initComponents:function(){var me=this;this.inherited(arguments);if(this.model.get('product').get('productType')==='S'){this.$.serviceIcon.show();this.$.product.addStyles('margin-left: 24px;');}else{this.$.serviceIcon.hide();this.$.product.addStyles('float: left;');}
this.$.checkBoxColumn.hide();this.$.product.setContent(this.setIdentifierContent());this.$.quantity.setContent(this.model.printQty());this.$.price.setContent(this.model.printPrice());if(this.model.get('priceIncludesTax')){this.$.gross.setContent(this.model.printGross());}else{this.$.gross.setContent(this.model.printNet());}
if(this.model.get('product').get('characteristicDescription')){this.createComponent({style:'display: block; ',components:[{name:'characteristicsDescription',content:OB.UTIL.getCharacteristicValues(this.model.get('product').get('characteristicDescription')),attributes:{style:'width: 60.1%; color:grey; padding-left: 0%; clear: both; '}},{style:'clear: both;'}]});}
if(this.model.get('promotions')){enyo.forEach(this.model.get('promotions'),function(d){if(d.hidden){return;}
var identifierName=d.identifier?d.identifier:d.name;this.createComponent({style:'display: block;',components:[{content:'-- '+identifierName,attributes:{style:'float: left; width: 80%; clear: left;'}},{content:OB.I18N.formatCurrency(-d.amt),attributes:{style:'float: right; width: 20%; text-align: right;'}},{style:'clear: both;'}]});},this);}
if(this.model.get('relatedLines')){if(!this.$.relatedLinesContainer){this.createComponent({name:'relatedLinesContainer',style:'clear:both; float: left; width: 80%;'});}
enyo.forEach(this.model.get('relatedLines'),function(line){this.$.relatedLinesContainer.createComponent({components:[{content:line.otherTicket?OB.I18N.getLabel('OBPOS_lblRelatedLinesOtherTicket',[line.productName,line.orderDocumentNo]):OB.I18N.getLabel('OBPOS_lblRelatedLines',[line.productName]),attributes:{style:'font-size: 14px; font-style: italic; text-align: left; padding-left: 25px'}}]});},this);}
if(this.model.get('hasRelatedServices')){me.createComponent({kind:'OB.UI.ShowServicesButton',name:'showServicesButton'});}else if(!this.model.has('hasRelatedServices')){this.model.on('showServicesButton',function(){me.model.off('showServicesButton');me.createComponent({kind:'OB.UI.ShowServicesButton',name:'showServicesButton'}).render();});}
OB.UTIL.HookManager.executeHooks('OBPOS_RenderOrderLine',{orderline:this},function(args){});},keyupHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===13||keyCode===32){this.executeTapAction();return true;}
OB.MobileApp.view.keypressHandler(inSender,inEvent);},setMultiSelected:function(inSender,inEvent){if(inEvent.models&&inEvent.models.length>0&&inEvent.models[0]instanceof OB.Model.OrderLine&&this.$.showServicesButton){if(inEvent.models.length>1){this.$.showServicesButton.hide();}else{this.$.showServicesButton.show();}}},changeEditMode:function(inSender,inEvent){this.addRemoveClass('btnselect-orderline-edit',inEvent.edit);this.bubble('onShowColumn',{colNum:1});},checkBoxForTicketLines:function(inSender,inEvent){if(inEvent.status){this.$.gross.hasNode().style.width='18%';this.$.quantity.hasNode().style.width='16%';this.$.price.hasNode().style.width='18%';this.$.nameContainner.hasNode().style.width='38%';if(this.$.characteristicsDescription){this.$.characteristicsDescription.addStyles('padding-left: 10%; clear: both; width: 50.1%; color:grey');}
if(this.$.relatedLinesContainer){this.$.relatedLinesContainer.addStyles('padding-left: 10%; clear: both; float: left; width: 80%;');}
this.$.checkBoxColumn.show();this.changeEditMode(this,inEvent.status);}else{this.$.gross.hasNode().style.width='20%';this.$.quantity.hasNode().style.width='20%';this.$.price.hasNode().style.width='20%';this.$.nameContainner.hasNode().style.width='40%';if(this.$.characteristicsDescription){this.$.characteristicsDescription.addStyles('padding-left: 0%; clear: both; width: 60.1%; color:grey');}
if(this.$.relatedLinesContainer){this.$.relatedLinesContainer.addStyles('padding-left: 0%; clear: both; float: left; width: 80%;');}
this.$.checkBoxColumn.hide();this.changeEditMode(this,false);}},setIdentifierContent:function(){return this.model.get('product').get('_identifier');}});enyo.kind({name:'OB.UI.RenderOrderLineEmpty',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_ReceiptNew'));}});enyo.kind({name:'OB.UI.RenderTaxLineEmpty',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',initComponents:function(){this.inherited(arguments);}});enyo.kind({name:'OB.UI.ShowServicesButton',style:'float: right; display: block;',published:{disabled:false},handlers:{onRightToolbarDisabled:'toggleVisibility'},tap:function(inSender,inEvent){var product=this.owner.model.get('product');if(product){OB.UI.SearchProductCharacteristic.prototype.filtersCustomClear();OB.UI.SearchProductCharacteristic.prototype.filtersCustomAdd(new OB.UI.SearchServicesFilter({text:product.get("_identifier"),productId:product.id,productList:null,orderline:this.owner.model,orderlineList:null}));var me=this;setTimeout(function(){me.bubble('onTabChange',{tabPanel:'searchCharacteristic'});me.bubble('onSelectFilter',{});me.owner.model.set("obposServiceProposed",true);OB.MobileApp.model.receipt.save();},1);}},toggleVisibility:function(inSender,inEvent){this.isVisible=!inEvent.status;if(this.isVisible){this.show();}else{this.hide();}},initComponents:function(){this.inherited(arguments);if(this.owner.model.get('obposServiceProposed')){this.addRemoveClass('iconServices_unreviewed',false);this.addRemoveClass('iconServices_reviewed',true);}else{this.addRemoveClass('iconServices_unreviewed',true);this.addRemoveClass('iconServices_reviewed',false);}
if(OB.MobileApp.model.get('serviceSearchMode')){this.hide();}}});enyo.kind({kind:'OB.UI.listItemButton',name:'OB.UI.RenderTaxLine',classes:'btnselect-orderline',tap:function(){},components:[{name:'tax',attributes:{style:'float: left; width: 60%;'}},{name:'base',attributes:{style:'float: left; width: 20%; text-align: right;'}},{name:'totaltax',attributes:{style:'float: left; width: 20%; text-align: right;'}},{style:'clear: both;'}],selected:function(){},initComponents:function(){this.inherited(arguments);this.$.tax.setContent(this.model.get('name'));this.$.base.setContent(OB.I18N.formatCurrency(this.model.get('net')));this.$.totaltax.setContent(OB.I18N.formatCurrency(this.model.get('amount')));}});enyo.kind({kind:'OB.UI.SelectButton',name:'OB.UI.RenderPaymentLine',classes:'btnselect-orderline',style:'border-bottom: 0px',tap:function(){},components:[{name:'name',attributes:{style:'float: left; width: 40%; padding: 5px 0px 0px 0px;'}},{name:'date',attributes:{style:'float: left; width: 20%; padding: 5px 0px 0px 0px; text-align: right;'}},{name:'foreignAmount',attributes:{style:'float: left; width: 20%; padding: 5px 0px 0px 0px; text-align: right;'}},{name:'amount',attributes:{style:'float: left; width: 20%; padding: 5px 0px 0px 0px; text-align: right;'}},{style:'clear: both;'}],selected:function(){},initComponents:function(){var paymentDate;this.inherited(arguments);this.$.name.setContent(OB.MobileApp.model.getPaymentName(this.model.get('kind'))||this.model.get('name'));if(this&&this.model&&this.model.get('paymentData')&&this.model.get('paymentData').name&&this.model.get('paymentData').name.length>0){this.$.name.setContent((OB.MobileApp.model.getPaymentName(this.model.get('kind'))||this.model.get('name'))+' ('+this.model.get('paymentData').name+')');}
if(OB.UTIL.isNullOrUndefined(this.model.get('paymentDate'))){paymentDate=new Date();}else{paymentDate=this.model.get('paymentDate');if(typeof(this.model.get('paymentDate'))==='string'){paymentDate=new Date(paymentDate);}
paymentDate=new Date(paymentDate.getTime()+(60000*paymentDate.getTimezoneOffset()));}
this.$.date.setContent(OB.I18N.formatDate(paymentDate));if(this.model.get('rate')&&this.model.get('rate')!=='1'){this.$.foreignAmount.setContent(this.model.printForeignAmount());}else{this.$.foreignAmount.setContent('');}
this.$.amount.setContent(this.model.printAmount());}});enyo.kind({name:'OB.UI.RenderPaymentLineEmpty',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',initComponents:function(){this.inherited(arguments);}});enyo.kind({name:'OB.UI.RemoveMultiOrders',kind:'OB.UI.SmallButton',classes:'btnlink-darkgray btnlink-payment-clear btn-icon-small btn-icon-clearPayment',events:{onRemoveMultiOrders:''},tap:function(){var me=this;if((_.isUndefined(this.deleting)||this.deleting===false)){this.deleting=true;this.removeClass('btn-icon-clearPayment');this.addClass('btn-icon-loading');this.doRemoveMultiOrders({order:this.owner.model});}}});enyo.kind({kind:'OB.UI.SelectButton',name:'OB.UI.RenderMultiOrdersLineValues',classes:'btnselect-orderline',handlers:{onChangeEditMode:'changeEditMode'},events:{onShowPopup:''},components:[{name:'line',style:'line-height: 23px; width: 100%;',components:[{style:'display: inline;',name:'multiTopLine',components:[{style:'display: inline-block;',name:'documentNo',initComponents:function(){this.setContent(this.owner.owner.model.get('documentNo')+' - '+this.owner.owner.model.get('bp').get('_identifier'));}},{style:'font-weight: bold; float: right; text-align:right; display: inline-block;',name:'total',initComponents:function(){this.setContent((!_.isUndefined(this.owner.owner.model.get('amountToLayaway'))&&!_.isNull(this.owner.owner.model.get('amountToLayaway')))?OB.I18N.formatCurrency(this.owner.owner.model.get('amountToLayaway')):this.owner.owner.model.printPending());}}]},{style:'line-height: 23px; width: 100%;',name:'totalAndLayaway',components:[{style:'color: #888888; display: inline-block;',name:'totalOrder',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LineTotal')+': '+this.owner.owner.model.printTotal());}},{style:'font-weight: bold; color: lightblue; float: right; text-align:right; display: inline-block;',name:'isLayaway',initComponents:function(){if(!_.isUndefined(this.owner.owner.model.get('amountToLayaway'))&&!_.isNull(this.owner.owner.model.get('amountToLayaway'))){this.setContent(OB.I18N.getLabel('OBPOS_ToBeLaidaway'));}}}]},{style:'color: #888888; display: inline',name:'multiBottonLine',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_RemainingToPay')+': '+this.owner.owner.model.printPending()+' - ('+OB.I18N.formatDate(new Date(this.owner.owner.model.get('orderDate')))+') ');}},{style:'clear: both;'}]}],tap:function(){if(OB.MobileApp.model.hasPermission('OBPOS_receipt.layawayReceipt')){this.doShowPopup({popup:'modalmultiorderslayaway',args:this.owner.model});}},changeEditMode:function(inSender,inEvent){this.addRemoveClass('btnselect-orderline-edit',inEvent.edit);this.bubble('onShowColumn',{colNum:1});}});enyo.kind({name:'OB.UI.RenderMultiOrdersLine',style:'border-bottom: 1px solid #cccccc; width: 100%',components:[{style:'display: inline-block; width: 8%;',kind:'OB.UI.RemoveMultiOrders'},{style:'display: inline-block; width: 87%; border: none; margin: 1px; padding-rigth: 5px;',kind:'OB.UI.RenderMultiOrdersLineValues'}]});enyo.kind({name:'OB.UI.RenderMultiOrdersLineEmpty',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_ReceiptNew'));}});enyo.kind({name:'OB.UI.OrderMultiSelect',kind:'Image',src:'../org.openbravo.retail.posterminal/img/iconPinSelected.png',sizing:"cover",width:28,height:28,style:'float: right; cursor: pointer; margin-top: 8px;',showing:false,events:{onToggleSelection:''},published:{disabled:false},tap:function(){this.doToggleSelection({multiselection:false});}});enyo.kind({name:'OB.UI.OrderSingleSelect',kind:'Image',src:'../org.openbravo.retail.posterminal/img/iconPinUnselected.png',sizing:"cover",width:28,height:28,style:'float: right; cursor: pointer; margin-top: 8px;',events:{onToggleSelection:''},published:{disabled:false},tap:function(){this.doToggleSelection({multiselection:true});}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.OrderMultiSelectAll',i18nContent:'OBPOS_lblSelectAll',classes:'btnlink-orange',style:'float: right; margin-top: 6px;',showing:false,events:{onMultiSelectAll:''},published:{disabled:false},tap:function(){this.doMultiSelectAll();}});enyo.kind({name:'OB.UI.OrderHeader',classes:'row-fluid span12',published:{order:null},events:{onToggleSelectionMode:'',onTableMultiSelectAll:''},handlers:{onShowMultiSelected:'showMultiSelected',onToggleSelection:'toggleSelection',onMultiSelectAll:'multiSelectAll'},newLabelComponents:[{kind:'OB.UI.OrderDetails',name:'orderdetails'},{kind:'OB.UI.OrderMultiSelect',name:'btnMultiSelection'},{kind:'OB.UI.OrderMultiSelectAll',name:'btnMultiSelectAll'},{kind:'OB.UI.OrderSingleSelect',name:'btnSingleSelection'},{style:'clear: both;'}],newButtonComponents:[{kind:'OB.UI.BusinessPartner',name:'bpbutton'},{kind:'OB.UI.BPLocation',name:'bplocbutton'}],style:'border-bottom: 1px solid #cccccc;',components:[{name:'receiptLabels'},{name:'receiptButtons',style:'clear: both; '}],resizeHandler:function(){this.inherited(arguments);this.setOrderDetailWidth(this.showPin,this.showSelectAll);},orderChanged:function(oldValue){_.each(this.$.receiptLabels.$,function(comp){if(comp.setOrder){comp.setOrder(this.order);}},this);_.each(this.$.receiptButtons.$,function(comp){if(comp.setOrder){comp.setOrder(this.order);}},this);},setOrderDetailWidth:function(pin,selectAll){this.showPin=pin;this.showSelectAll=selectAll;var w=$("#"+this.$.receiptLabels.id).width()-25;if(pin){w=w-$("#"+this.$.receiptLabels.$.btnSingleSelection.id).width()-20;}
if(selectAll){w=w-$("#"+this.$.receiptLabels.$.btnMultiSelectAll.id).width()-20;}
$("#"+this.$.receiptLabels.$.orderdetails.id).width(w+'px');},showMultiSelected:function(inSender,inEvent){if(inEvent.show){this.$.receiptLabels.$.btnSingleSelection.setShowing(true);}else{this.$.receiptLabels.$.btnSingleSelection.setShowing(false);}
this.$.receiptLabels.$.btnMultiSelection.setShowing(false);this.$.receiptLabels.$.btnMultiSelectAll.setShowing(false);this.setOrderDetailWidth(inEvent.show,false);this.doToggleSelectionMode({multiselection:false});},toggleSelection:function(inSender,inEvent){if(inEvent.multiselection){this.$.receiptLabels.$.btnSingleSelection.setShowing(false);this.$.receiptLabels.$.btnMultiSelection.setShowing(true);this.$.receiptLabels.$.btnMultiSelectAll.setShowing(true);}else{this.$.receiptLabels.$.btnSingleSelection.setShowing(true);this.$.receiptLabels.$.btnMultiSelection.setShowing(false);this.$.receiptLabels.$.btnMultiSelectAll.setShowing(false);}
this.setOrderDetailWidth(true,inEvent.multiselection);this.doToggleSelectionMode(inEvent);},multiSelectAll:function(inSender,inEvent){this.doTableMultiSelectAll();},initComponents:function(){this.inherited(arguments);this.showPin=false;this.showSelectAll=false;enyo.forEach(this.newLabelComponents,function(comp){this.$.receiptLabels.createComponent(comp);},this);enyo.forEach(this.newButtonComponents,function(comp){this.$.receiptButtons.createComponent(comp);},this);}});enyo.kind({name:'OB.UI.OrderFooter',classes:'row-fluid span12',published:{order:null},style:'border-bottom: 1px solid #cccccc;',newComponents:[],orderChanged:function(){_.each(this.$,function(comp){if(comp.setOrder){comp.setOrder(this.order);}},this);},initComponents:function(){this.inherited(arguments);enyo.forEach(this.newComponents,function(comp){this.createComponent(comp);},this);}});enyo.kind({name:'OB.UI.TotalMultiReceiptLine',style:'position: relative; padding: 10px;',components:[{name:'lblTotal',style:'float: left; width: 40%;'},{name:'totalqty',style:'float: left; width: 20%; text-align:right; font-weight:bold;'},{name:'totalgross',style:'float: left; width: 40%; text-align:right; font-weight:bold;'},{style:'clear: both;'}],renderTotal:function(newTotal){this.$.totalgross.setContent(OB.I18N.formatCurrency(newTotal));},renderQty:function(newQty){this.$.totalqty.setContent(newQty);},initComponents:function(){this.inherited(arguments);this.$.lblTotal.setContent(OB.I18N.getLabel('OBPOS_LblTotal'));}});enyo.kind({name:'OB.UI.TotalReceiptLine',handlers:{onCheckBoxBehaviorForTicketLine:'checkBoxForTicketLines'},style:'position: relative; padding: 10px; height: 35px',components:[{name:'lblTotal',style:'float: left; width: 40%;'},{name:'totalqty',style:'float: left; width: 20%; text-align:right; font-weight:bold;'},{name:'totalgross',style:'float: left; width: 40%; text-align:right; font-weight:bold;'},{style:'clear: both;'}],renderTotal:function(newTotal){this.$.totalgross.setContent(OB.I18N.formatCurrency(newTotal));OB.UTIL.HookManager.executeHooks('OBPOS_UpdateTotalReceiptLine',{totalline:this},function(args){});},renderQty:function(newQty){this.$.totalqty.setContent(newQty);},checkBoxForTicketLines:function(inSender,inEvent){if(inEvent.status){this.$.lblTotal.hasNode().style.width='48%';this.$.totalqty.hasNode().style.width='16%';this.$.totalgross.hasNode().style.width='36%';}else{this.$.lblTotal.hasNode().style.width='40%';this.$.totalqty.hasNode().style.width='20%';this.$.totalgross.hasNode().style.width='40%';}},initComponents:function(){this.inherited(arguments);this.$.lblTotal.setContent(OB.I18N.getLabel('OBPOS_LblTotal'));OB.UTIL.HookManager.executeHooks('OBPOS_RenderTotalReceiptLine',{totalline:this},function(args){});}});enyo.kind({name:'OB.UI.TotalTaxLine',style:'position: relative; padding: 10px;',components:[{name:'lblTotalTax',style:'float: left; width: 40%;'},{name:'totalbase',style:'float: left; width: 20%; text-align:right; font-weight:bold;'},{name:'totaltax',style:'float: left; width: 60%; text-align:right; font-weight:bold;'},{style:'clear: both;'}],renderTax:function(newTax){this.$.totaltax.setContent(OB.I18N.formatCurrency(newTax));},renderBase:function(newBase){},initComponents:function(){this.inherited(arguments);this.$.lblTotalTax.setContent(OB.I18N.getLabel('OBPOS_LblTotalTax'));}});enyo.kind({name:'OB.UI.TaxBreakdown',style:'position: relative; padding: 10px;',components:[{name:'lblTotalTaxBreakdown',style:'float: left; width: 40%;'},{style:'clear: both;'}],initComponents:function(){this.inherited(arguments);this.$.lblTotalTaxBreakdown.setContent(OB.I18N.getLabel('OBPOS_LblTaxBreakdown'));}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.BtnReceiptToInvoice',events:{onCancelReceiptToInvoice:''},style:'width: 40px;',classes:'btnlink-white btnlink-payment-clear btn-icon-small btn-icon-check',tap:function(){this.doCancelReceiptToInvoice();}});enyo.kind({name:'btninvoice',showing:false,style:'float: left; width: 40%;',components:[{kind:'OB.UI.BtnReceiptToInvoice'},{tag:'span',content:' '},{tag:'span',name:'lblInvoiceReceipt',style:'font-weight:bold; '}],initComponents:function(){this.inherited(arguments);this.$.lblInvoiceReceipt.setContent(OB.I18N.getLabel('OBPOS_LblInvoiceReceipt'));}});enyo.kind({name:'OB.UI.OrderView',published:{order:null},handlers:{onCheckBoxBehaviorForTicketLine:'checkBoxBehavior',onAllTicketLinesChecked:'allTicketLinesChecked',onToggleSelectionTable:'toggleSelectionTable',onMultiSelectAllTable:'multiSelectAllTable',onTableMultiSelectedItems:'tableMultiSelectedItems'},components:[{kind:'OB.UI.ScrollableTable',name:'listOrderLines',columns:['product','quantity','price','gross'],scrollAreaMaxHeight:'250px',renderLine:'OB.UI.RenderOrderLine',renderEmpty:'OB.UI.RenderOrderLineEmpty',listStyle:'edit',isSelectableLine:function(model){if(!OB.UTIL.isNullOrUndefined(model)&&!OB.UTIL.isNullOrUndefined(model.attributes)&&!OB.UTIL.isNullOrUndefined(model.attributes.originalOrderLineId)){return false;}
return true;}},{tag:'ul',classes:'unstyled',components:[{tag:'li',components:[{kind:'OB.UI.TotalTaxLine',name:'totalTaxLine'},{kind:'OB.UI.TotalReceiptLine',name:'totalReceiptLine'}]},{tag:'li',components:[{style:'padding: 10px; border-top: 1px solid #cccccc; height: 40px;',components:[{kind:'btninvoice',name:'divbtninvoice',showing:false},{name:'divText',style:'float: right; text-align: right; font-weight:bold; font-size: 30px;',showing:false,content:''},{style:'clear: both;'}]}]},{tag:'li',components:[{style:'padding: 10px; border-top: 1px solid #cccccc; height: 40px;',components:[{kind:'OB.UI.TaxBreakdown',name:'taxBreakdown'}]}]},{kind:'OB.UI.ScrollableTable',name:'listTaxLines',scrollAreaMaxHeight:'250px',renderLine:'OB.UI.RenderTaxLine',renderEmpty:'OB.UI.RenderTaxLineEmpty',listStyle:'nonselectablelist',columns:['tax','base','totaltax'],executeAfterRender:function(){if(this.owner.$.listOrderLines.scrollToBottom){this.owner.$.listOrderLines.getScrollArea().scrollToBottom();}
this.owner.$.listOrderLines.scrollToBottom=false;}},{tag:'li',components:[{name:'paymentBreakdown',style:'padding: 10px; height: 40px;',showing:false,components:[{style:'position: relative; padding: 10px;',components:[{name:'lblTotalPayment',style:'float: left; width: 40%;'},{style:'clear: both;'}]}]}]},{kind:'OB.UI.ScrollableTable',style:'border-bottom: 1px solid #cccccc;',name:'listPaymentLines',showing:false,scrollAreaMaxHeight:'250px',renderLine:'OB.UI.RenderPaymentLine',renderEmpty:'OB.UI.RenderPaymentLineEmpty',listStyle:'nonselectablelist'}]}],initComponents:function(){this.inherited(arguments);this.$.lblTotalPayment.setContent(OB.I18N.getLabel('OBPOS_LblPaymentBreakdown'));},checkBoxBehavior:function(inSender,inEvent){if(inEvent.status){this.$.listOrderLines.setListStyle('checkboxlist');}else{this.$.listOrderLines.setListStyle('edit');}},allTicketLinesChecked:function(inSender,inEvent){if(inEvent.status){this.order.get('lines').trigger('checkAll');}else{this.order.get('lines').trigger('unCheckAll');}},setTaxes:function(){var taxList=new Backbone.Collection();var taxes=this.order.get('taxes');var empty=true,prop;for(prop in taxes){if(taxes.hasOwnProperty(prop)){taxList.add(new OB.Model.TaxLine(taxes[prop]));empty=false;}}
if(empty){this.$.taxBreakdown.hide();}else{this.$.taxBreakdown.show();}
taxList.models=_.sortBy(taxList.models,function(taxLine){return taxLine.get('name');});this.$.listTaxLines.setCollection(taxList);},toggleSelectionTable:function(inSender,inEvent){this.$.listOrderLines.setSelectionMode(inEvent.multiselection?'multiple':'single');},multiSelectAllTable:function(){this.$.listOrderLines.selectAll();},tableMultiSelectedItems:function(inSender,inEvent){this.$.listOrderLines.setSelectedModels(inEvent.selection);},orderChanged:function(oldValue){var me=this;this.$.totalReceiptLine.renderTotal(this.order.getTotal());this.$.totalReceiptLine.renderQty(this.order.getQty());this.$.totalTaxLine.renderTax(OB.DEC.sub(this.order.getTotal(),this.order.getNet()));this.$.totalTaxLine.renderBase('');this.$.listOrderLines.setCollection(this.order.get('lines'));this.$.listOrderLines.collection.on('add change:qty change:promotions',function(model,list){me.$.listOrderLines.scrollToBottom=false;if(me.$.listOrderLines.collection.models.length>0&&me.$.listOrderLines.collection.models[me.$.listOrderLines.collection.models.length-1]._changing){me.$.listOrderLines.scrollToBottom=true;}else if(list&&list.models&&list.length>0&&model.id===list.models[list.length-1].id){me.$.listOrderLines.scrollToBottom=true;}});this.$.listPaymentLines.setCollection(this.order.get('payments'));this.setTaxes();this.order.on('change:gross change:net',function(model){if(model.get('orderType')!==3){this.$.totalReceiptLine.renderTotal(model.getTotal());this.$.totalTaxLine.renderTax(OB.DEC.sub(model.getTotal(),model.getNet()));}},this);this.order.on('paintTaxes',function(){if(this.order.get('orderType')!==3){this.setTaxes();}},this);this.order.on('change:priceIncludesTax ',function(model){if(this.order.get('priceIncludesTax')){this.$.totalTaxLine.hide();}else{this.$.totalTaxLine.show();}},this);this.order.on('change:qty',function(model){this.$.totalReceiptLine.renderQty(model.getQty());},this);this.order.on('change:orderType change:documentNo',function(model){if(model.get('orderType')===1){this.$.divText.addStyles('width: 50%; color: #f8941d;');if(model.get('isPaid')!==true){this.$.divText.setContent(OB.I18N.getLabel('OBPOS_ToBeReturned'));this.$.divText.show();}}else if(model.get('orderType')===2){this.$.divText.addStyles('width: 60%; color: lightblue;');this.$.divText.setContent(OB.I18N.getLabel('OBPOS_ToBeLaidaway'));this.$.divText.show();}else if(model.get('orderType')===3){this.$.divText.addStyles('width: 50%; color: lightblue;');this.$.divText.setContent(OB.I18N.getLabel('OBPOS_VoidLayaway'));this.$.divText.show();}else if(model.get('isLayaway')){this.$.divText.addStyles('width: 50%; color: lightblue;');this.$.divText.setContent(OB.I18N.getLabel('OBPOS_LblLayaway'));this.$.divText.show();}else if(this.$.divText.content===OB.I18N.getLabel('OBPOS_ToBeReturned')||this.$.divText.content===OB.I18N.getLabel('OBPOS_ToBeLaidaway')||this.$.divText.content===OB.I18N.getLabel('OBPOS_VoidLayaway')){this.$.divText.hide();}},this);this.order.on('change:generateInvoice',function(model){if(model.get('generateInvoice')){this.$.divbtninvoice.show();}else{this.$.divbtninvoice.hide();}},this);this.order.on('change:isQuotation',function(model){if(model.get('isQuotation')){this.$.divText.addStyles('width: 100%; color: #f8941d;');this.$.listOrderLines.children[4].children[0].setContent(OB.I18N.getLabel('OBPOS_QuotationNew'));if(model.get('hasbeenpaid')==='Y'){this.$.divText.setContent(OB.I18N.getLabel('OBPOS_QuotationUnderEvaluation'));}else{this.$.divText.setContent(OB.I18N.getLabel('OBPOS_QuotationDraft'));}
this.$.divText.show();}else{this.$.listOrderLines.children[4].children[0].setContent(OB.I18N.getLabel('OBPOS_ReceiptNew'));if(this.$.divText.content===OB.I18N.getLabel('OBPOS_QuotationUnderEvaluation')||this.$.divText.content===OB.I18N.getLabel('OBPOS_QuotationDraft')){this.$.divText.hide();}}},this);this.order.on('change:hasbeenpaid',function(model){if(model.get('isQuotation')&&model.get('hasbeenpaid')==='Y'&&!model.get('obposIsDeleted')&&this.$.divText.content&&(this.$.divText.content===OB.I18N.getLabel('OBPOS_QuotationNew')||this.$.divText.content===OB.I18N.getLabel('OBPOS_QuotationDraft'))){this.$.divText.setContent(OB.I18N.getLabel('OBPOS_QuotationUnderEvaluation'));}else if(model.get('isQuotation')&&model.get('hasbeenpaid')==='N'&&!model.get('isLayaway')){this.$.divText.setContent(OB.I18N.getLabel('OBPOS_QuotationDraft'));}},this);this.order.on('change:isPaid change:paidOnCredit change:isQuotation',function(model){if(model.get('isPaid')===true&&!model.get('isQuotation')){this.$.divText.addStyles('width: 50%; color: #f8941d;');if(model.get('paidOnCredit')){this.$.divText.setContent(OB.I18N.getLabel('OBPOS_paidOnCredit'));}else if(model.get('documentType')===OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns){this.$.divText.setContent(OB.I18N.getLabel('OBPOS_paidReturn'));}else{this.$.divText.setContent(OB.I18N.getLabel('OBPOS_paid'));}
this.$.divText.show();this.$.listPaymentLines.show();this.$.paymentBreakdown.show();}else if(this.$.divText.content===OB.I18N.getLabel('OBPOS_paid')||this.$.divText.content===OB.I18N.getLabel('OBPOS_paidReturn')||this.$.divText.content===OB.I18N.getLabel('OBPOS_paidOnCredit')){this.$.divText.hide();this.$.listPaymentLines.hide();this.$.paymentBreakdown.hide();}},this);this.order.on('change:isLayaway',function(model){if(model.get('isLayaway')===true){this.$.divText.addStyles('width: 50%; color: lightblue;');this.$.divText.setContent(OB.I18N.getLabel('OBPOS_LblLayaway'));this.$.divText.show();this.$.listPaymentLines.show();this.$.paymentBreakdown.show();}else if(this.$.divText.content===OB.I18N.getLabel('OBPOS_LblLayaway')){this.$.divText.hide();this.$.listPaymentLines.hide();this.$.paymentBreakdown.hide();}},this);this.order.get('lines').on('add change:qty change:relatedLines updateRelations',function(){var approvalNeeded=false,linesToRemove=[],servicesToApprove='',line,k,oldUndo=this.order.get('undo');if(this.updating||this.order.get('preventServicesUpdate')){return;}else{this.updating=true;}
function getServiceLines(service){var serviceLines;if(service.get('groupService')){serviceLines=_.filter(me.order.get('lines').models,function(l){return(l.get('product').get('id')===service.get('product').get('id'))&&!l.get('originalOrderLineId');});}else{serviceLines=[service];}
return serviceLines;}
function filterLines(newRelatedLines,lines){return _.filter(newRelatedLines,function(rl){return _.indexOf(_.pluck(lines,'id'),rl.orderlineId)!==-1;});}
function getSiblingServicesLines(productId,orderlineId){var serviceLines=_.filter(me.order.get('lines').models,function(l){return l.has('relatedLines')&&l.get('relatedLines').length>0&&!l.get('originalOrderLineId')&&l.get('product').id===productId&&l.get('relatedLines')[0].orderlineId===orderlineId;});return serviceLines;}
function adjustNotGroupedServices(line,qty){if(line.get('product').get('quantityRule')==='PP'&&!line.get('groupService')){var qtyService=OB.DEC.abs(qty),qtyLineServ=qty>0?1:-1;var siblingServicesLines=getSiblingServicesLines(line.get('product').id,line.get('relatedLines')[0].orderlineId);if(!me.order.get('deleting')){if(siblingServicesLines.length<qtyService){var i;for(i=0;i<qtyService-siblingServicesLines.length;i++){var p=line.get('product').clone();p.set('groupProduct',false);var newLine=me.order.createLine(p,qtyLineServ);newLine.set('relatedLines',siblingServicesLines[0].get('relatedLines'));newLine.set('groupService',false);}}}else if(siblingServicesLines.length>qtyService){linesToRemove=OB.UTIL.mergeArrays(linesToRemove,_.initial(siblingServicesLines,qtyService));}
return qtyLineServ;}
return qty;}
if(!OB.MobileApp.model.receipt.get('notApprove')){for(k=0;k<this.order.get('lines').length;k++){line=this.order.get('lines').models[k];var prod=line.get('product'),newLine,i,j,l,rlp,rln,newqtyplus=0,newqtyminus=0,serviceLines=[],positiveLines=[],negativeLines=[],newRelatedLines=[];if(line.has('relatedLines')&&line.get('relatedLines').length>0&&!line.get('originalOrderLineId')){serviceLines=getServiceLines(line);for(i=0;i<serviceLines.length;i++){newRelatedLines=OB.UTIL.mergeArrays(newRelatedLines,(serviceLines[i].get('relatedLines')||[]));}
for(j=0;j<newRelatedLines.length;j++){l=me.order.get('lines').get(newRelatedLines[j].orderlineId);if(l&&l.get('qty')>0){newqtyplus+=l.get('qty');positiveLines.push(l);}else if(l&&l.get('qty')<0){newqtyminus+=l.get('qty');negativeLines.push(l);}}
rlp=filterLines(newRelatedLines,positiveLines);rln=filterLines(newRelatedLines,negativeLines);if(prod.get('quantityRule')==='UQ'){newqtyplus=(newqtyplus?1:0);newqtyminus=(newqtyminus?-1:0);}
for(i=0;i<serviceLines.length;i++){l=serviceLines[i];if(l.get('qty')>0&&serviceLines.length===1&&newqtyminus){if(!l.get('product').get('returnable')){me.order.get('lines').remove(l);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableProduct'),OB.I18N.getLabel('OBPOS_UnreturnableProductMessage',[l.get('product').get('_identifier')]));this.updating=false;return;}else{if(!approvalNeeded){approvalNeeded=true;}
servicesToApprove+='<br>· '+line.get('product').get('_identifier');}}}}}}
function fixServiceOrderLines(approved){linesToRemove=[];me.order.get('lines').forEach(function(line){var prod=line.get('product'),newLine,i,j,l,rlp,rln,deferredLines,deferredQty,notDeferredRelatedLines,positiveLine,newqtyplus=0,newqtyminus=0,serviceLines=[],positiveLines=[],negativeLines=[],newRelatedLines=[];if(line.has('relatedLines')&&line.get('relatedLines').length>0&&!line.get('originalOrderLineId')){serviceLines=getServiceLines(line);for(i=0;i<serviceLines.length;i++){newRelatedLines=OB.UTIL.mergeArrays(newRelatedLines,(serviceLines[i].get('relatedLines')||[]));}
for(j=0;j<newRelatedLines.length;j++){l=me.order.get('lines').get(newRelatedLines[j].orderlineId);if(l&&l.get('qty')>0){newqtyplus+=l.get('qty');positiveLines.push(l);}else if(l&&l.get('qty')<0){newqtyminus+=l.get('qty');negativeLines.push(l);}}
rlp=filterLines(newRelatedLines,positiveLines);rln=filterLines(newRelatedLines,negativeLines);if(prod.get('quantityRule')==='UQ'){newqtyplus=(newqtyplus?1:0);newqtyminus=(newqtyminus?-1:0);}
serviceLines.forEach(function(l){if(l.get('qty')>0){if(serviceLines.length===1&&newqtyminus&&newqtyplus){deferredLines=l.get('relatedLines').filter(function getDeferredServices(relatedLine){return relatedLine.deferred===true;});if(deferredLines){deferredQty=0;if(line.get('product').get('quantityRule')==='PP'){_.each(deferredLines,function(deferredLine){deferredQty+=deferredLine.qty;});}
rlp=OB.UTIL.mergeArrays(rlp,(deferredLines||[]));newqtyplus+=deferredQty;}
newLine=me.order.createLine(prod,newqtyminus);newLine.set('relatedLines',rln);newLine.set('groupService',newLine.get('product').get('groupProduct'));l.set('relatedLines',rlp);l.set('qty',newqtyplus);}else if(serviceLines.length===1&&newqtyminus){if(approved){deferredLines=l.get('relatedLines').filter(function getDeferredServices(relatedLine){return relatedLine.deferred===true;});if(deferredLines.length){deferredQty=0;if(line.get('product').get('quantityRule')==='PP'){_.each(deferredLines,function(deferredLine){deferredQty+=deferredLine.qty;});}else{deferredQty=1;}
newLine=me.order.createLine(prod,deferredQty);newLine.set('relatedLines',deferredLines);newLine.set('qty',deferredQty);}
l.set('relatedLines',rln);newqtyminus=adjustNotGroupedServices(l,newqtyminus,linesToRemove);l.set('qty',newqtyminus);}else{linesToRemove.push(l);}}else if(newqtyplus&&!me.positiveLineUpdated){me.positiveLineUpdated=true;deferredLines=l.get('relatedLines').filter(function getDeferredServices(relatedLine){return relatedLine.deferred===true;});rlp=OB.UTIL.mergeArrays(rlp,(deferredLines||[]));l.set('relatedLines',rlp);if(line.get('product').get('quantityRule')==='PP'){if(line.get('groupService')){_.each(deferredLines,function(deferredLine){newqtyplus+=deferredLine.qty;});}else{newqtyplus=adjustNotGroupedServices(line,newqtyplus,linesToRemove);}}
l.set('qty',newqtyplus);}else if(newqtyplus&&newqtyminus&&me.positiveLineUpdated){newLine=me.order.createLine(prod,newqtyminus);newLine.set('relatedLines',rln);newLine.set('groupService',newLine.get('product').get('groupProduct'));me.order.get('lines').remove(l);}else{deferredLines=l.get('relatedLines').filter(function getDeferredServices(relatedLine){return relatedLine.deferred===true;});if(!deferredLines.length){me.order.get('lines').remove(l);}else{deferredQty=0;if(line.get('product').get('quantityRule')==='PP'){_.each(deferredLines,function(deferredLine){deferredQty+=deferredLine.qty;});}else{deferredQty=1;}
l.set('relatedLines',deferredLines);l.set('qty',deferredQty);}}}else{if(serviceLines.length===1&&newqtyminus&&newqtyplus){newLine=me.order.createLine(prod,newqtyplus);newLine.set('relatedLines',rlp);l.set('relatedLines',rln);l.set('qty',newqtyminus);}else if(serviceLines.length===1&&newqtyplus){l.set('relatedLines',rlp);newqtyplus=adjustNotGroupedServices(l,newqtyplus,linesToRemove);l.set('qty',newqtyplus);}else if(newqtyminus&&!me.negativeLineUpdated){me.negativeLineUpdated=true;l.set('relatedLines',rln);newqtyminus=adjustNotGroupedServices(l,newqtyminus,linesToRemove);l.set('qty',newqtyminus);}else if(newqtyplus&&newqtyminus&&me.negativeLineUpdated){positiveLine=me.order.get('lines').filter(function getLine(currentLine){return currentLine.get('product').id===l.get('product').id&&currentLine.get('qty')>0;});if(positiveLine){deferredLines=l.get('relatedLines').filter(function getDeferredServices(relatedLine){return relatedLine.deferred===true;});rlp=OB.UTIL.mergeArrays(rlp,(deferredLines||[]));positiveLine.set('relatedLines',rlp);positiveLine.set('qty',newqtyplus);}else{newLine=me.order.createLine(prod,newqtyplus);newLine.set('relatedLines',rlp);}
me.order.get('lines').remove(l);}else{deferredLines=l.get('relatedLines').filter(function getDeferredServices(relatedLine){return relatedLine.deferred===true;});if(!deferredLines.length){me.order.get('lines').remove(l);}}}});me.positiveLineUpdated=false;me.negativeLineUpdated=false;notDeferredRelatedLines=line.get('relatedLines').filter(function getNotDeferredLines(rl){return!rl.deferred;});if(!line.get('groupService')&&notDeferredRelatedLines.length>1){notDeferredRelatedLines.forEach(function(rl){newLine=me.order.createLine(prod,me.order.get('lines').get(rl.orderlineId).get('qty'));newLine.set('relatedLines',[rl]);newLine.set('groupService',false);});me.order.get('lines').remove(line);}}});linesToRemove.forEach(function(l){me.order.get('lines').remove(l);OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_DeletedService',[l.get('product').get('_identifier')]));});me.order.setUndo('FixOrderLines',oldUndo);me.updating=false;me.order.get('lines').trigger('updateServicePrices');}
if(approvalNeeded){OB.UTIL.Approval.requestApproval(OB.MobileApp.view.$.containerWindow.getRoot().model,[{approval:'OBPOS_approval.returnService',message:'OBPOS_approval.returnService',params:[servicesToApprove]}],function(approved,supervisor,approvalType){if(approved){fixServiceOrderLines(true);}else{fixServiceOrderLines(false);}});}else{fixServiceOrderLines(true);}},this);this.order.on('change:net change:gross updateServicePrices',function(){var me=this,handleError;handleError=function(line,message){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_ErrorGettingServicePrice'),OB.I18N.getLabel(message,[line.get('product').get('_identifier')]),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true}],{onHideFunction:function(){me.order.get('lines').remove(line);me.order.set('undo',null);me.$.totalReceiptLine.renderQty();}});};if(this.updating||this.order.get('preventServicesUpdate')){return;}
this.order.get('lines').forEach(function(line){var prod=line.get('product'),amountBeforeDiscounts=0,amountAfterDiscounts=0,rangeAmountBeforeDiscounts=0,rangeAmountAfterDiscounts=0,relatedQuantity=0;if(prod.get('productType')==='S'&&prod.get('isPriceRuleBased')&&!line.get('originalOrderLineId')){var criteria={};line.get('relatedLines').forEach(function(rl){var l=me.order.get('lines').get(rl.orderlineId);if(l){relatedQuantity+=l.get('qty');}else{relatedQuantity+=rl.qty;}
if(me.order.get('priceIncludesTax')){if(l){amountBeforeDiscounts+=Math.abs(l.get('gross'));amountAfterDiscounts+=Math.abs(l.get('gross')-_.reduce(l.get('promotions'),function(memo,promo){return memo+promo.amt;},0));if(prod.get('quantityRule')==='PP'){rangeAmountBeforeDiscounts+=Math.abs(OB.DEC.div(l.get('gross'),l.get('qty')));rangeAmountAfterDiscounts+=Math.abs(OB.DEC.div(l.get('gross')-_.reduce(l.get('promotions'),function(memo,promo){return memo+promo.amt;},0),l.get('qty')));}}else{amountBeforeDiscounts+=Math.abs(rl.gross);amountAfterDiscounts+=Math.abs(rl.gross-_.reduce(rl.promotions,function(memo,promo){return memo+promo.amt;},0));if(prod.get('quantityRule')==='PP'){rangeAmountBeforeDiscounts+=Math.abs(OB.DEC.div(rl.gross,rl.qty));rangeAmountAfterDiscounts+=Math.abs(OB.DEC.div(rl.gross-_.reduce(rl.promotions,function(memo,promo){return memo+promo.amt;},0),rl.qty));}}}else{if(l){amountBeforeDiscounts+=Math.abs(l.get('net'));amountAfterDiscounts+=Math.abs(l.get('net')-_.reduce(l.get('promotions'),function(memo,promo){return memo+promo.amt;},0));if(prod.get('quantityRule')==='PP'){rangeAmountBeforeDiscounts+=Math.abs(OB.DEC.div(l.get('net'),l.get('qty')));rangeAmountAfterDiscounts+=Math.abs(OB.DEC.div(l.get('net')-_.reduce(l.get('promotions'),function(memo,promo){return memo+promo.amt;},0),l.get('qty')));}}else{amountBeforeDiscounts+=Math.abs(rl.net);amountAfterDiscounts+=Math.abs(rl.net-_.reduce(rl.promotions,function(memo,promo){return memo+promo.amt;},0));if(prod.get('quantityRule')==='PP'){rangeAmountBeforeDiscounts+=Math.abs(OB.DEC.div(rl.net,rl.qty));rangeAmountAfterDiscounts+=Math.abs(OB.DEC.div(rl.net-_.reduce(rl.promotions,function(memo,promo){return memo+promo.amt;},0),rl.qty));}}}});if(prod.get('quantityRule')==='UQ'){rangeAmountBeforeDiscounts=amountBeforeDiscounts;rangeAmountAfterDiscounts=amountAfterDiscounts;}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){criteria.remoteFilters=[];criteria.remoteFilters.push({columns:['product'],operator:'equals',value:line.get('product').get('id'),isId:true});criteria.remoteFilters.push({columns:[],operator:'filter',value:'ServicePriceRuleVersion_DateFilter',params:[]});}else{criteria._whereClause="where product = '"+line.get('product').get('id')+"' and validFromDate <= date('now')";criteria._orderByClause='validFromDate desc';criteria._limit=1;}
OB.Dal.find(OB.Model.ServicePriceRuleVersion,criteria,function(sprvs){var priceruleVersion;if(sprvs&&sprvs.length>0){priceruleVersion=sprvs.at(0);OB.Dal.get(OB.Model.ServicePriceRule,priceruleVersion.get('servicePriceRule'),function(spr){if(spr.get('ruletype')==='P'){var amount,newprice,oldprice=line.get('priceList');if(spr.get('afterdiscounts')){amount=amountAfterDiscounts*spr.get('percentage')/100;}else{amount=amountBeforeDiscounts*spr.get('percentage')/100;}
if(!line.get('groupService')){amount=amount/relatedQuantity;}
newprice=OB.Utilities.Number.roundJSNumber(oldprice+amount/line.get('qty'),2);me.order.setPrice(line,newprice,{setUndo:false});}else{var rangeCriteria={};if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){rangeCriteria.remoteFilters=[];rangeCriteria.remoteFilters.push({columns:['servicepricerule'],operator:'equals',value:spr.get('id'),isId:true});rangeCriteria.remoteFilters.push({columns:[],operator:'filter',value:'ServicePriceRuleRange_AmountFilter',params:[spr.get('afterdiscounts')?rangeAmountAfterDiscounts:rangeAmountBeforeDiscounts]});}else{rangeCriteria._whereClause="where servicepricerule = '"+spr.get('id')+"' and (( amountUpTo >= "+(spr.get('afterdiscounts')?rangeAmountAfterDiscounts:rangeAmountBeforeDiscounts)+") or (amountUpTo is null))";rangeCriteria._orderByClause='amountUpTo is null, amountUpTo';rangeCriteria._limit=1;}
OB.Dal.find(OB.Model.ServicePriceRuleRange,rangeCriteria,function(sppr){var range,priceCriteria={};if(sppr&&sppr.length>0){range=sppr.at(0);if(range.get('ruleType')==='P'){var amount,newprice,oldprice=line.get('priceList');if(range.get('afterdiscounts')){amount=amountAfterDiscounts*range.get('percentage')/100;}else{amount=amountBeforeDiscounts*range.get('percentage')/100;}
if(!line.get('groupService')){amount=amount/relatedQuantity;}
newprice=OB.Utilities.Number.roundJSNumber(oldprice+amount/line.get('qty'),2);me.order.setPrice(line,newprice,{setUndo:false});}else{if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){priceCriteria.remoteFilters=[];priceCriteria.remoteFilters.push({columns:['product'],operator:'equals',value:prod.get('id'),isId:true});priceCriteria.remoteFilters.push({columns:['priceList'],operator:'equals',value:range.get('priceList'),isId:true});}else{priceCriteria.product=prod.get('id');priceCriteria.priceList=range.get('priceList');}
OB.Dal.find(OB.Model.ServicePriceRuleRangePrices,priceCriteria,function(price){var oldprice=line.get('priceList'),newprice;if(price&&price.length>0){newprice=OB.Utilities.Number.roundJSNumber(oldprice+price.at(0).get('listPrice'),2);me.order.setPrice(line,newprice,{setUndo:false});}else{handleError(line,'OBPOS_ErrorPriceRuleRangePriceNotFound');}},function(){handleError(line,'OBPOS_ErrorGettingPriceRuleRangePrice');});}}else{handleError(line,'OBPOS_ErrorPriceRuleRangeNotFound');}},function(){handleError(line,'OBPOS_ErrorGettingPriceRuleRange');});}},function(){handleError(line,'OBPOS_ErrorGettingPriceRule');});}else{handleError(line,'OBPOS_ErrorPriceRuleVersionNotFound');}},function(){handleError(line,'OBPOS_ErrorGettingPriceRuleVersion');});}});},this);this.order.get('lines').on('remove',function(model,list,index){var lineToDelete=model,removedId=model.get('id'),serviceLinesToCheck=[],text,linesToDelete,relations;if(!me.order.get('undo')){text=OB.I18N.getLabel('OBPOS_DeleteLine')+': '+model.get('qty')+' x '+model.get('product').get('_identifier');linesToDelete=[model];relations=[];me.order.setUndo('DeleteLine',{text:text,lines:linesToDelete,relations:relations});}else{linesToDelete=me.order.get('undo').lines;if(!linesToDelete){linesToDelete=[];}
linesToDelete.push(model);text=me.order.get('undo').text;if(text){text+=', '+model.get('qty')+' x '+model.get('product').get('_identifier');}else{text=OB.I18N.getLabel('OBPOS_DeleteLine')+': '+model.get('qty')+' x '+model.get('product').get('_identifier');}
relations=me.order.get('undo').relations;if(!relations){relations=[];}
me.order.get('undo').text=text;me.order.get('undo').lines=linesToDelete;me.order.get('undo').relations=relations;}
me.order.get('lines').forEach(function(line,idx){var prod=line.get('product');if(line.has('relatedLines')&&line.get('relatedLines').length>0){var i,l=0,relationIds=_.pluck(line.get('relatedLines'),'orderlineId');if(_.indexOf(relationIds,removedId)!==-1){serviceLinesToCheck.push([line,idx]);}}});if(serviceLinesToCheck.length>0){serviceLinesToCheck.forEach(function(lineToCheck){var rl,rls;if(lineToCheck[0].get('relatedLines').length>1){rl=_.filter(lineToCheck[0].get('relatedLines'),function(rl){return rl.orderlineId===lineToDelete.get('id');});relations.push([lineToCheck[0],rl[0]]);rls=lineToCheck[0].get('relatedLines').slice();rls.splice(lineToCheck[0].get('relatedLines').indexOf(rl[0]),1);lineToCheck[0].set('relatedLines',rls);if(lineToCheck[0].get('product').get('quantityRule')==='PP'){text+=', '+model.get('qty')+' x '+lineToCheck[0].get('product').get('_identifier');me.order.get('undo').text=text;}}else{me.order.deleteLine(lineToCheck[0],true);}});}},this);this.order.on('change:selectedPayment',function(model){OB.UTIL.HookManager.executeHooks('OBPOS_PaymentSelected',{order:this.order,paymentSelected:OB.MobileApp.model.paymentnames[model.get('selectedPayment')]},function(args){});},this);}});enyo.kind({name:'OB.UI.MultiOrderView',published:{order:null},events:{onChangeTotal:''},components:[{kind:'OB.UI.ScrollableTable',name:'listMultiOrderLines',scrollAreaMaxHeight:'450px',renderLine:'OB.UI.RenderMultiOrdersLine',renderEmpty:'OB.UI.RenderMultiOrdersLineEmpty',listStyle:'edit'},{tag:'ul',classes:'unstyled',components:[{tag:'li',components:[{kind:'OB.UI.TotalMultiReceiptLine',name:'totalMultiReceiptLine'}]},{tag:'li',components:[{style:'padding: 10px; border-top: 1px solid #cccccc; height: 40px;',components:[{kind:'btninvoice',name:'multiOrder_btninvoice',showing:false},{style:'clear: both;'}]}]}]}],listMultiOrders:null,init:function(model){this.model=model;var me=this;this.total=0;this.listMultiOrders=new Backbone.Collection();this.$.listMultiOrderLines.setCollection(this.listMultiOrders);this.model.get('multiOrders').on('change:additionalInfo',function(changedModel){if(changedModel.get('additionalInfo')==='I'){this.$.multiOrder_btninvoice.show();return;}
this.$.multiOrder_btninvoice.hide();},this);this.model.get('multiOrders').get('multiOrdersList').on('reset add remove change',function(){me.total=_.reduce(me.model.get('multiOrders').get('multiOrdersList').models,function(memo,order){return memo+((!_.isUndefined(order.get('amountToLayaway'))&&!_.isNull(order.get('amountToLayaway')))?order.get('amountToLayaway'):order.getPending());},0);this.model.get('multiOrders').set('total',this.total);this.model.get('multiOrders').on('change:total',function(model){this.doChangeTotal({newTotal:model.get('total')});},this);this.$.totalMultiReceiptLine.renderTotal(this.total);me.listMultiOrders.reset(me.model.get('multiOrders').get('multiOrdersList').models);if(this.model.get('leftColumnViewManager').isMultiOrder()){this.doChangeTotal({newTotal:this.total});}
this.$.totalMultiReceiptLine.renderQty(me.model.get('multiOrders').get('multiOrdersList').length);},this);},initComponents:function(){this.inherited(arguments);}});enyo.kind({name:'OB.UI.OrderDetails',published:{order:null},tap:function(){if(!this.order.get('isEditable')){return;}
this.inherited(arguments);this.doShowReceiptProperties();},attributes:{style:'padding: 13px 0px 15px 10px; font-weight: bold; color: #6CB33F; float: left; calc(100% - 50px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;'},events:{onPricelistChanged:'',onShowReceiptProperties:''},initComponents:function(){return this;},renderData:function(docNo){this.preSetContentDetail(this.order,docNo);},renderDataFromModel:function(order){var docNo=order.get('documentNo');this.preSetContentDetail(order,docNo);},preSetContentDetail:function(order,docNo){var orderDate=new Date(order.get('orderDate'));if(order.get('hasbeenpaid')==='Y'||order.get('isLayaway')){if(this.order.get('creationDate')!==null){orderDate=new Date(OB.I18N.normalizeDate(this.order.get('creationDate')));}}
var content=OB.I18N.formatHour(orderDate)+' - '+docNo;this.setContentDetail(content,docNo,orderDate);},setContentDetail:function(content,docNo,orderDate){var me=this;var setContentHookFn=function(){OB.UTIL.HookManager.executeHooks('OBPOS_OrderDetailContentHook',{content:content,docNo:docNo,order:me.order,orderDate:orderDate},function(args){me.setContent(args.content);});};if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)){OB.UTIL.getPriceListName(this.order.get('priceList'),function(priceListName){content+=" - "+priceListName;setContentHookFn();});}else{setContentHookFn();}},orderChanged:function(){this.renderData(this.order.get('documentNo'));this.order.on('change:documentNo',function(model){this.renderData(model.get('documentNo'));},this);this.order.on('change:creationDate',function(model){this.renderDataFromModel(model);},this);if(OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)){this.order.on('change:priceList',function(model){this.renderData(model.get('documentNo'));this.doPricelistChanged({priceList:model.get('priceList')});},this);}}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.BusinessPartner',classes:'btnlink-gray',style:'float: left; text-overflow:ellipsis; white-space: nowrap; overflow: hidden;',published:{order:null},events:{onShowPopup:''},handlers:{onBPSelectionDisabled:'buttonDisabled'},buttonDisabled:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled){this.removeClass('btnlink');this.addClass('btnbp');}else{this.removeClass('btnbp');this.addClass('btnlink');}},tap:function(){var qty=0;enyo.forEach(this.order.get('lines').models,function(l){if(l.get('originalOrderLineId')){qty=qty+1;return;}});if(qty!==0){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_Cannot_Change_BPartner'));return;}
if(!this.disabled){this.doShowPopup({popup:'modalcustomer'});}},initComponents:function(){},renderCustomer:function(newCustomer){this.setContent(newCustomer);},orderChanged:function(oldValue){if(this.order.get('bp')){this.renderCustomer(this.order.get('bp').get('_identifier'));}else{this.renderCustomer('');}
this.order.on('change:bp',function(model){if(model.get('bp')){if(OB.MobileApp.model.hasPermission('OBPOS_receipt.invoice')){if(OB.MobileApp.model.hasPermission('OBPOS_retail.restricttaxidinvoice',true)){if(!model.get('bp').get('taxID')){if(OB.MobileApp.model.get('terminal').terminalType.generateInvoice){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_BP_No_Taxid'));}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_BP_No_Taxid'));}
model.set('generateInvoice',false);}else{model.set('generateInvoice',OB.MobileApp.model.get('terminal').terminalType.generateInvoice);}}}else{model.set('generateInvoice',false);}
this.renderCustomer(model.get('bp').get('_identifier'));}else{this.renderCustomer('');}},this);}});enyo.kind({kind:'OB.UI.Button',name:'OB.UI.NewCustomerWindowButton',events:{onChangeSubWindow:'',onHideThisPopup:''},disabled:false,style:'width: 170px; margin: 0px 5px 8px 19px;',classes:'btnlink-yellow btnlink btnlink-small',i18nLabel:'OBPOS_LblNewCustomer',handlers:{onSetModel:'setModel',onNewBPDisabled:'doDisableNewBP'},setModel:function(inSender,inEvent){this.model=inEvent.model;},doDisableNewBP:function(inSender,inEvent){this.putDisabled(inEvent.status);},tap:function(model){if(this.disabled){return true;}
this.doHideThisPopup();this.doChangeSubWindow({newWindow:{name:'customerCreateAndEdit',params:{navigateOnClose:'mainSubWindow'}}});},putDisabled:function(status){if(status===false){this.disabled=false;this.setDisabled(false);this.removeClass('disabled');return;}else{this.disabled=true;this.setDisabled(true);this.addClass('disabled');}}});enyo.kind({kind:'OB.UI.Button',name:'OB.UI.AdvancedSearchCustomerWindowButton',style:'margin: 0px 0px 8px 5px;',classes:'btnlink-yellow btnlink btnlink-small',i18nLabel:'OBPOS_LblAdvancedSearch',disabled:false,handlers:{onSetModel:'setModel',onNewBPDisabled:'doDisableNewBP'},setModel:function(inSender,inEvent){this.model=inEvent.model;},doDisableNewBP:function(inSender,inEvent){this.putDisabled(inEvent.status);},events:{onHideThisPopup:''},tap:function(){if(this.disabled){return true;}
this.doHideThisPopup();this.model.get('subWindowManager').set('currentWindow',{name:'customerAdvancedSearch',params:{caller:'mainSubWindow'}});},putDisabled:function(status){if(status===false){this.disabled=false;this.setDisabled(false);this.removeClass('disabled');return;}else{this.disabled=true;this.setDisabled(true);this.addClass('disabled');}},initComponents:function(){this.inherited(arguments);this.putDisabled(!OB.MobileApp.model.hasPermission('OBPOS_receipt.customers'));}});enyo.kind({name:'OB.UI.ModalBpScrollableHeader',kind:'OB.UI.ScrollableTableHeader',events:{onSearchAction:'',onClearAction:''},handlers:{onSearchActionByKey:'searchAction',onFiltered:'searchAction'},components:[{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'customerFilterText',style:'width: 100%'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',name:'OB.UI.Bp.Modal.search',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]}]},{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell;',components:[{kind:'OB.UI.NewCustomerWindowButton',name:'newAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.AdvancedSearchCustomerWindowButton'}]}]}]}],clearAction:function(){this.$.customerFilterText.setValue('');this.doClearAction();},searchAction:function(){this.doSearchAction({bpName:this.$.customerFilterText.getValue()});return true;}});enyo.kind({name:'OB.UI.ListBpsLine',kind:'OB.UI.listItemButton',components:[{name:'line',style:'line-height: 23px;',components:[{style:'display: inline-block;',name:'identifier'},{style:'display: inline-block; font-weight: bold; color: red; padding-left:5px;',name:'onHold'},{style:'clear: left; color: #888888',name:'address'},{style:'clear: both;'}]}],events:{onHideThisPopup:''},tap:function(){this.inherited(arguments);this.doHideThisPopup();},create:function(){this.inherited(arguments);this.$.identifier.setContent(this.model.get('_identifier'));if(this.model.get('customerBlocking')&&this.model.get('salesOrderBlocking')){this.$.onHold.setContent('('+OB.I18N.getLabel('OBPOS_OnHold')+')');}
this.$.address.setContent(this.model.get('locName'));}});enyo.kind({name:'OB.UI.ListBps',classes:'row-fluid',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},events:{onChangeBusinessPartner:''},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;',classes:'row-fluid',components:[{classes:'span12',components:[{name:'stBPAssignToReceipt',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'350px',renderHeader:'OB.UI.ModalBpScrollableHeader',renderLine:'OB.UI.ListBpsLine',renderEmpty:'OB.UI.RenderEmpty'},{name:'renderLoading',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',showing:false,initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblLoading'));}}]}]}]}],clearAction:function(inSender,inEvent){this.bpsList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,filter=OB.UTIL.unAccent(inEvent.bpName);this.$.stBPAssignToReceipt.$.tempty.hide();this.$.stBPAssignToReceipt.$.tbody.hide();this.$.stBPAssignToReceipt.$.tlimit.hide();this.$.renderLoading.show();function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBPs(dataBps){me.$.renderLoading.hide();if(dataBps&&dataBps.length>0){me.bpsList.reset(dataBps.models);me.$.stBPAssignToReceipt.$.tbody.show();}else{me.bpsList.reset();me.$.stBPAssignToReceipt.$.tempty.show();}}
var criteria={};if(filter&&filter!==''){criteria._filter={operator:OB.Dal.CONTAINS,value:filter};}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){var filterIdentifier={columns:['_filter'],operator:'startsWith',value:filter};var remoteCriteria=[filterIdentifier];criteria.remoteFilters=remoteCriteria;}
if(OB.MobileApp.model.hasPermission('OBPOS_customerLimit',true)){criteria._limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_customerLimit',true));}
OB.Dal.find(OB.Model.BusinessPartner,criteria,successCallbackBPs,errorCallback);return true;},bpsList:null,init:function(model){this.bpsList=new Backbone.Collection();this.$.stBPAssignToReceipt.setCollection(this.bpsList);this.bpsList.on('click',function(model){if(model.get('customerBlocking')&&model.get('salesOrderBlocking')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_BPartnerOnHold',[model.get('_identifier')]));}else{this.doChangeBusinessPartner({businessPartner:model});}},this);}});enyo.kind({name:'OB.UI.ModalBusinessPartners',topPosition:'125px',kind:'OB.UI.Modal',executeOnShow:function(){this.$.body.$.listBps.$.stBPAssignToReceipt.$.theader.$.modalBpScrollableHeader.$.newAction.putDisabled(!OB.MobileApp.model.hasPermission('OBPOS_retail.editCustomers'));return true;},executeOnHide:function(){this.$.body.$.listBps.$.stBPAssignToReceipt.$.theader.$.modalBpScrollableHeader.clearAction();},i18nHeader:'OBPOS_LblAssignCustomer',body:{kind:'OB.UI.ListBps'},init:function(model){this.model=model;this.waterfall('onSetModel',{model:this.model});}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.BPLocation',classes:'btnlink-gray',style:'float: right; text-overflow:ellipsis; white-space: nowrap; overflow: hidden;',published:{order:null},events:{onShowPopup:''},handlers:{onBPLocSelectionDisabled:'buttonDisabled'},buttonDisabled:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled){this.removeClass('btnlink');this.addClass('btnbp');}else{this.removeClass('btnbp');this.addClass('btnlink');}},tap:function(){if(!this.disabled){this.doShowPopup({popup:'modalcustomeraddress'});}},initComponents:function(){},renderBPLocation:function(newLocation){this.setContent(newLocation);},orderChanged:function(oldValue){if(this.order.get('bp')){this.renderBPLocation(this.order.get('bp').get('locName'));}else{this.renderBPLocation('');}
this.order.on('change:bp',function(model){if(model.get('bp')){this.renderBPLocation(model.get('bp').get('locName'));}else{this.renderBPLocation('');}},this);}});enyo.kind({kind:'OB.UI.Button',name:'OB.UI.NewCustomerAddressWindowButton',events:{onChangeSubWindow:'',onHideThisPopup:''},disabled:false,style:'width: 170px; margin: 0px 5px 8px 19px;',classes:'btnlink-yellow btnlink btnlink-small',i18nLabel:'OBPOS_LblNewCustomerAddress',handlers:{onSetModel:'setModel',onNewBPLocDisabled:'doDisableNewBPLoc'},setModel:function(inSender,inEvent){this.model=inEvent.model;},doDisableNewBPLoc:function(inSender,inEvent){this.putDisabled(inEvent.status);},tap:function(model){if(this.disabled){return true;}
this.doHideThisPopup();var me=this;function errorCallback(tx,error){OB.error(tx);OB.error(error);}
function successCallbackBPs(dataBps){me.doChangeSubWindow({newWindow:{name:'customerAddrCreateAndEdit',params:{navigateOnClose:'mainSubWindow',businessPartner:dataBps}}});}
OB.Dal.get(OB.Model.BusinessPartner,this.model.get('order').get('bp').get('id'),successCallbackBPs,errorCallback);},putDisabled:function(status){if(status===false){this.disabled=false;this.setDisabled(false);this.removeClass('disabled');return;}else{this.disabled=true;this.setDisabled(true);this.addClass('disabled');}}});enyo.kind({kind:'OB.UI.Button',name:'OB.UI.SearchCustomerAddressWindowButton',style:'width: 170px; margin: 0px 0px 8px 5px;',classes:'btnlink-yellow btnlink btnlink-small',i18nLabel:'OBPOS_LblEditAddress',disabled:false,handlers:{onSetModel:'setModel',onNewBPLocDisabled:'doDisableNewBPLoc'},doDisableNewBPLoc:function(inSender,inEvent){this.putDisabled(inEvent.status);},setModel:function(inSender,inEvent){this.model=inEvent.model;},events:{onHideThisPopup:''},tap:function(){if(this.disabled){return true;}
this.doHideThisPopup();this.model.get('subWindowManager').set('currentWindow',{name:'customerAddressSearch',params:{caller:'mainSubWindow',bPartner:this.model.get('order').get('bp').get('id')}});},putDisabled:function(status){if(status===false){this.disabled=false;this.setDisabled(false);this.removeClass('disabled');return;}else{this.disabled=true;this.setDisabled(true);this.addClass('disabled');}},initComponents:function(){this.inherited(arguments);this.putDisabled(!OB.MobileApp.model.hasPermission('OBPOS_receipt.customers'));}});enyo.kind({name:'OB.UI.ModalBpLocScrollableHeader',kind:'OB.UI.ScrollableTableHeader',events:{onSearchAction:'',onClearAction:''},handlers:{onSearchActionByKey:'searchAction',onFiltered:'searchAction'},components:[{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'bpsLocationSearchfilterText',style:'width: 100%'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',name:'bpsLocationSearchClearButton',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',name:'bpsLocationSearchButton',ontap:'searchAction'}]}]}]},{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell;',components:[{kind:'OB.UI.NewCustomerAddressWindowButton',name:'newAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SearchCustomerAddressWindowButton'}]}]}]}],clearAction:function(){this.$.bpsLocationSearchfilterText.setValue('');this.doSearchAction({locName:this.$.bpsLocationSearchfilterText.getValue()});return true;},searchAction:function(){this.doSearchAction({locName:this.$.bpsLocationSearchfilterText.getValue()});return true;}});enyo.kind({name:'OB.UI.ListBpsLocLine',kind:'OB.UI.SelectButton',components:[{name:'line',style:'line-height: 30px;',components:[{name:'identifier'},{style:'clear: both;'}]}],events:{onHideThisPopup:''},tap:function(){this.inherited(arguments);this.doHideThisPopup();},create:function(){this.inherited(arguments);this.$.identifier.setContent(this.model.get('name'));}});enyo.kind({name:'OB.UI.ListBpsLoc',classes:'row-fluid',published:{bPartnerId:null},handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},events:{onChangeBusinessPartner:''},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;',classes:'row-fluid',components:[{classes:'span12',components:[{name:'bpsloclistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderHeader:'OB.UI.ModalBpLocScrollableHeader',renderLine:'OB.UI.ListBpsLocLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}]}],clearAction:function(inSender,inEvent){this.bpsList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,criteria={},filter=inEvent.locName;function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBPsLoc(dataBps){if(dataBps&&dataBps.length>0){me.bpsList.reset(dataBps.models);}else{me.bpsList.reset();}}
criteria.name={operator:OB.Dal.CONTAINS,value:filter};criteria.bpartner=this.bPartnerId;if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){var filterIdentifier={columns:['_filter'],operator:'startsWith',value:filter},bPartnerId={columns:['bpartner'],operator:'equals',value:this.bPartnerId,isId:true};var remoteCriteria=[filterIdentifier,bPartnerId];criteria.remoteFilters=remoteCriteria;}
OB.Dal.find(OB.Model.BPLocation,criteria,successCallbackBPsLoc,errorCallback);return true;},bpsList:null,init:function(model){this.bpsList=new Backbone.Collection();this.$.bpsloclistitemprinter.setCollection(this.bpsList);this.bpsList.on('click',function(model){var me=this;function errorCallback(tx,error){OB.error(tx);OB.error(error);}
function successCallbackBPs(dataBps){dataBps.set('locationModel',model);dataBps.set('locId',model.get('id'));dataBps.set('locName',model.get('name'));dataBps.set('postalCode',model.get('postalCode'));dataBps.set('cityName',model.get('cityName'));dataBps.set('countryName',model.get('countryName'));me.doChangeBusinessPartner({businessPartner:dataBps});}
OB.Dal.get(OB.Model.BusinessPartner,this.bPartnerId,successCallbackBPs,errorCallback);},this);}});enyo.kind({name:'OB.UI.ModalBPLocation',topPosition:'125px',kind:'OB.UI.Modal',executeOnShow:function(){this.$.body.$.listBpsLoc.setBPartnerId(this.model.get('order').get('bp').get('id'));this.$.body.$.listBpsLoc.$.bpsloclistitemprinter.$.theader.$.modalBpLocScrollableHeader.searchAction();this.$.body.$.listBpsLoc.$.bpsloclistitemprinter.$.theader.$.modalBpLocScrollableHeader.$.newAction.putDisabled(!OB.MobileApp.model.hasPermission('OBPOS_retail.editCustomers'));return true;},executeOnHide:function(){this.$.body.$.listBpsLoc.$.bpsloclistitemprinter.$.theader.$.modalBpLocScrollableHeader.$.bpsLocationSearchfilterText.setValue('');},i18nHeader:'OBPOS_LblAssignCustomerAddress',body:{kind:'OB.UI.ListBpsLoc'},init:function(model){this.model=model;this.waterfall('onSetModel',{model:this.model});}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.UI.SalesRepresentative',classes:'btnlink btnlink-small btnlink-gray',style:'float:left; margin:7px; height:27px; padding: 4px 15px 7px 15px;',published:{order:null},events:{onShowPopup:''},tap:function(){if(!this.disabled){this.doShowPopup({popup:'modalsalesrepresentative'});}},init:function(model){if(!OB.MobileApp.model.hasPermission(this.permission)){this.parent.parent.parent.hide();}else{if(!OB.MobileApp.model.hasPermission(this.permissionOption,true)){this.parent.parent.parent.hide();}}
this.setOrder(model.get('order'));},renderSalesRepresentative:function(newSalesRepresentative){this.setContent(newSalesRepresentative);},orderChanged:function(oldValue){if(this.order.get('salesRepresentative')){this.renderSalesRepresentative(this.order.get('salesRepresentative'));}else{this.renderSalesRepresentative('');}
this.order.on('change:salesRepresentative$_identifier change:salesRepresentative',function(model){if(!_.isUndefined(model.get('salesRepresentative$_identifier'))&&!_.isNull(model.get('salesRepresentative$_identifier'))){this.renderSalesRepresentative(model.get('salesRepresentative$_identifier'));}else{this.renderSalesRepresentative('');}},this);}});enyo.kind({name:'OB.UI.ModalSrScrollableHeader',kind:'OB.UI.ScrollableTableHeader',events:{onSearchAction:'',onClearAction:''},handlers:{onSearchActionByKey:'searchAction',onFiltered:'searchAction'},components:[{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'filterText',style:'width: 100%'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]}]}],clearAction:function(){this.$.filterText.setValue('');this.doClearAction();},searchAction:function(){this.doSearchAction({srName:this.$.filterText.getValue()});return true;}});enyo.kind({name:'OB.UI.ListSrsLine',kind:'OB.UI.SelectButton',components:[{name:'line',style:'line-height: 23px;',components:[{name:'name'},{style:'clear: both;'}]}],events:{onHideThisPopup:''},tap:function(){this.inherited(arguments);this.doHideThisPopup();},create:function(){this.inherited(arguments);this.$.name.setContent(this.model.get('name'));}});enyo.kind({name:'OB.UI.ListSrs',classes:'row-fluid',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},events:{onChangeSalesRepresentative:''},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;',classes:'row-fluid',components:[{classes:'span12',components:[{name:'srslistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderHeader:'OB.UI.ModalSrScrollableHeader',renderLine:'OB.UI.ListSrsLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}]}],clearAction:function(inSender,inEvent){this.srsList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,filter=inEvent.srName;function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBPs(dataSrs){if(dataSrs&&dataSrs.length>0){dataSrs.unshift({id:null,_identifier:null,name:OB.I18N.getLabel('OBPOS_None')});me.srsList.reset(dataSrs.models);}else{me.srsList.reset();}}
var criteria={};if(filter&&filter!==''){criteria._identifier={operator:OB.Dal.CONTAINS,value:filter};}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){var filterIdentifier={columns:['_filter'],operator:'startsWith',value:filter};var remoteCriteria=[filterIdentifier];criteria.remoteFilters=remoteCriteria;}
OB.Dal.find(OB.Model.SalesRepresentative,criteria,successCallbackBPs,errorCallback);return true;},srsList:null,init:function(model){this.srsList=new Backbone.Collection();this.$.srslistitemprinter.setCollection(this.srsList);this.srsList.on('click',function(model){if(model.attributes.name===OB.I18N.getLabel('OBPOS_None')){model.attributes.name=null;}
this.doChangeSalesRepresentative({salesRepresentative:model});},this);}});enyo.kind({name:'OB.UI.ModalSalesRepresentative',topPosition:'125px',kind:'OB.UI.Modal',executeOnHide:function(){this.$.body.$.listSrs.$.srslistitemprinter.$.theader.$.modalSrScrollableHeader.clearAction();},i18nHeader:'OBPOS_LblAssignSalesRepresentative',body:{kind:'OB.UI.ListSrs'},init:function(model){this.model=model;this.waterfall('onSetModel',{model:this.model});}});enyo.kind({name:'OB.UI.ReceiptsCounter',style:'position: absolute; top:0px; right: 0px;',showing:false,published:{orderList:null},components:[{kind:'OB.UI.ReceiptsCounterButton',name:'receiptsCounterButton'}],events:{onSetReceiptsList:''},renderNrItems:function(nrItems){var receiptLabels;try{receiptLabels=OB.POS.terminal.$.containerWindow.getRoot().$.multiColumn.$.leftPanel.$.receiptview.$.receiptheader.$.receiptLabels;}catch(e){OB.error('receiptLabels not found');}
if(nrItems>1){this.$.receiptsCounterButton.$.counter.setContent(nrItems-1);if(receiptLabels){receiptLabels.applyStyle('padding-right','55px');}
this.show();}else{this.$.receiptsCounterButton.$.counter.setContent('');if(receiptLabels){receiptLabels.applyStyle('padding-right','5px');}
this.hide();}},orderListChanged:function(oldValue){var me=this;this.doSetReceiptsList({orderList:this.orderList});this.renderNrItems(this.orderList.length);this.orderList.on('add remove reset',function(){me.renderNrItems(me.orderList.length);},this);},initComponents:function(){this.inherited(arguments);}});enyo.kind({name:'OB.UI.ReceiptsCounterButton',kind:'OB.UI.Button',classes:'btnlink btnlink-gray',style:'position: relative; overflow: hidden; margin:0px; padding:0px; height:50px; width: 50px;',events:{onShowPopup:''},handlers:{onOrderSelectionDisabled:'orderDisabled'},orderDisabled:function(inSender,inEvent){this.setDisabled(inEvent.status);this.addRemoveClass('disabled',inEvent.status);},tap:function(){if(!this.disabled){this.doShowPopup({popup:'modalreceipts'});}},components:[{style:'position: absolute; top: -35px; right:-35px; background: #404040; height:70px; width: 70px; -webkit-transform: rotate(45deg); -moz-transform: rotate(45deg); -ms-transform: rotate(45deg); -transform: rotate(45deg);'},{name:'counter',style:'position: absolute; top: 0px; right:0px; padding-top: 5px; padding-right: 10px; font-weight: bold; color: white;'}]});enyo.kind({name:'OB.UI.MenuReturn',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.return',events:{onShowDivText:'',onRearrangeEditButtonBar:''},i18nLabel:'OBPOS_LblReturn',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);this.doShowDivText({permission:this.permission,orderType:1});if(OB.MobileApp.model.get('lastPaneShown')==='payment'){this.model.get('order').trigger('scan');}
this.doRearrangeEditButtonBar();},displayLogic:function(){var negativeLines=_.filter(this.model.get('order').get('lines').models,function(line){return line.get('qty')<0;}).length;if(!this.model.get('order').get('isQuotation')){this.show();}else{this.hide();return;}
if(negativeLines>0){this.hide();return;}
if(this.model.get('order').get('isEditable')===false){this.setShowing(false);return;}
this.adjustVisibilityBasedOnPermissions();},init:function(model){this.model=model;var receipt=model.get('order'),me=this;receipt.on('change:isEditable change:isQuotation change:gross',function(changedModel){this.displayLogic();},this);this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isOrder()){this.displayLogic();return;}
if(changedModel.isMultiOrder()){this.setShowing(false);return;}},this);}});enyo.kind({name:'OB.UI.MenuVoidLayaway',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.voidLayaway',events:{onShowDivText:'',onTabChange:''},i18nLabel:'OBPOS_VoidLayaway',tap:function(){var voidAllowed=true,notValid={};if(this.disabled){return true;}
this.inherited(arguments);if(this.model.get('order').get('orderType')===3){return;}
enyo.forEach(this.model.get('order').get('payments').models,function(curPayment){if(_.isUndefined(curPayment.get('isPrePayment'))||_.isNull(curPayment.get('isPrePayment'))){voidAllowed=false;notValid=curPayment;return;}},this);if(voidAllowed){this.doShowDivText({permission:this.permission,orderType:3});this.doTabChange({tabPanel:'payment',keyboard:'toolbarpayment',edit:false});}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_lblPaymentNotProcessedHeader'),OB.I18N.getLabel('OBPOS_lblPaymentNotProcessedMessage',[notValid.get('name'),notValid.get('origAmount'),OB.MobileApp.model.paymentnames[notValid.get('kind')].isocode]));}},displayLogic:function(){if(this.model.get('order').get('isLayaway')){this.show();this.adjustVisibilityBasedOnPermissions();}else{this.hide();}},init:function(model){this.model=model;var receipt=model.get('order'),me=this;this.setShowing(false);receipt.on('change:isLayaway',function(model){this.displayLogic();},this);this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isOrder()){this.displayLogic();return;}
if(changedModel.isMultiOrder()){this.setShowing(false);return;}},this);}});enyo.kind({name:'OB.UI.MenuReceiptLayaway',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.receiptLayaway',events:{onShowDivText:''},i18nLabel:'OBPOS_LblReceiptLayaway',tap:function(){var receiptAllowed=true,notValid={};if(this.disabled){return true;}
this.inherited(arguments);if(this.model.get('order').get('orderType')===3){return;}
var order=this.model.get('order');enyo.forEach(this.model.get('order').get('payments').models,function(curPayment){receiptAllowed=false;return;},this);if(receiptAllowed){this.doShowDivText({permission:this.permission,orderType:0});}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_LayawayHasPayment'));}},displayLogic:function(){if(this.model.get('order').get('orderType')===2){this.show();this.adjustVisibilityBasedOnPermissions();}else{this.hide();}},init:function(model){this.model=model;var receipt=model.get('order'),me=this;this.setShowing(false);receipt.on('change:orderType',function(model){this.displayLogic();},this);receipt.on('change:isLayaway',function(model){this.displayLogic();},this);this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isOrder()){this.displayLogic();return;}
if(changedModel.isMultiOrder()){this.setShowing(false);return;}},this);}});enyo.kind({name:'OB.UI.MenuLayaway',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.layawayReceipt',events:{onShowDivText:'',onRearrangeEditButtonBar:''},i18nLabel:'OBPOS_LblLayawayReceipt',tap:function(){var negativeLines;if(this.disabled){return true;}
this.inherited(arguments);if(OB.UTIL.isNullOrUndefined(this.model.get('order').get('bp'))){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_layawaysOrderWithNotBP'));return true;}
negativeLines=_.find(this.model.get('order').get('lines').models,function(line){return line.get('qty')<0;});if(negativeLines){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_layawaysOrdersWithReturnsNotAllowed'));return true;}
this.doShowDivText({permission:this.permission,orderType:2});this.doRearrangeEditButtonBar();},updateVisibility:function(isVisible){if(!OB.MobileApp.model.hasPermission(this.permission)){this.hide();return;}
if(!isVisible){this.hide();return;}
this.show();},init:function(model){this.model=model;var receipt=model.get('order'),me=this;receipt.on('change:isQuotation',function(model){if(!model.get('isQuotation')){me.updateVisibility(true);}else{me.updateVisibility(false);}},this);receipt.on('change:isEditable',function(newValue){if(newValue){if(newValue.get('isEditable')===false){me.updateVisibility(false);return;}
if(newValue.get('isEditable')===true&&newValue.get('isQuotation')){me.updateVisibility(false);return;}}
me.updateVisibility(true);},this);this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isOrder()){if(model.get('order').get('isEditable')&&!this.model.get('order').get('isQuotation')){me.updateVisibility(true);}else{me.updateVisibility(false);}
return;}
if(changedModel.isMultiOrder()){me.updateVisibility(false);}},this);}});enyo.kind({name:'OB.UI.MenuProperties',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.properties',events:{onShowReceiptProperties:''},i18nLabel:'OBPOS_LblProperties',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);this.doShowReceiptProperties();},init:function(model){this.model=model;this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isOrder()){if(model.get('order').get('isEditable')){this.setDisabled(false);this.adjustVisibilityBasedOnPermissions();}else{this.setDisabled(true);}
return;}
if(changedModel.isMultiOrder()){this.setDisabled(true);}},this);this.model.get('order').on('change:isEditable',function(newValue){if(newValue){if(newValue.get('isEditable')===false){this.setShowing(false);return;}}
this.setShowing(true);},this);}});enyo.kind({name:'OB.UI.MenuInvoice',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.invoice',events:{onReceiptToInvoice:'',onCancelReceiptToInvoice:''},i18nLabel:'OBPOS_LblInvoice',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);this.taxIdValidation(this.model.get('order'));},taxIdValidation:function(model){if(!OB.MobileApp.model.hasPermission('OBPOS_receipt.invoice')){this.doCancelReceiptToInvoice();}else if(OB.MobileApp.model.hasPermission('OBPOS_retail.restricttaxidinvoice',true)&&!model.get('bp').get('taxID')){if(OB.MobileApp.model.get('terminal').terminalType.generateInvoice){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_BP_No_Taxid'));}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_BP_No_Taxid'));}
this.doCancelReceiptToInvoice();}else{this.doReceiptToInvoice();}},updateVisibility:function(isVisible){if(!OB.MobileApp.model.hasPermission(this.permission)){this.hide();return;}
if(!isVisible){this.hide();return;}
this.show();},init:function(model){this.model=model;var receipt=model.get('order'),me=this;receipt.on('change:isQuotation change:isLayaway',function(model){if(!model.get('isQuotation')||model.get('isLayaway')){me.updateVisibility(true);}else{me.updateVisibility(false);}},this);receipt.on('change:bp',function(model){if(model.get('generateInvoice')&&!model.get('cloningReceipt')){me.taxIdValidation(model);}},this);receipt.on('change:isEditable',function(newValue){if(newValue){if(newValue.get('isEditable')===false&&!newValue.get('isLayaway')){this.updateVisibility(false);return;}
if(newValue.get('isEditable')===true&&newValue.get('isQuotation')){this.updateVisibility(false);return;}}
this.updateVisibility(true);},this);}});enyo.kind({name:'OB.UI.MenuOpenDrawer',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.opendrawerfrommenu',i18nLabel:'OBPOS_LblOpenDrawer',init:function(model){this.model=model;},tap:function(){var me=this;if(this.disabled){return true;}
OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.opendrawer.menu',function(approved,supervisor,approvalType){if(approved){OB.POS.hwserver.openDrawer({openFirst:true},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}});this.inherited(arguments);}});enyo.kind({name:'OB.UI.MenuCustomers',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.customers',events:{onChangeSubWindow:''},i18nLabel:'OBPOS_LblCustomers',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);this.doChangeSubWindow({newWindow:{name:'customerAdvancedSearch',params:{navigateOnClose:'mainSubWindow'}}});},init:function(model){this.model=model;model.get('leftColumnViewManager').on('order',function(){this.setDisabled(false);this.adjustVisibilityBasedOnPermissions();},this);model.get('leftColumnViewManager').on('multiorder',function(){this.setDisabled(true);},this);}});enyo.kind({name:'OB.UI.MenuPrint',kind:'OB.UI.MenuAction',permission:'OBPOS_print.receipt',events:{onPrintReceipt:''},i18nLabel:'OBPOS_LblPrintReceipt',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(OB.MobileApp.model.hasPermission(this.permission)){this.doPrintReceipt();}}});enyo.kind({name:'OB.UI.MenuQuotation',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.quotation',events:{onCreateQuotation:''},i18nLabel:'OBPOS_CreateQuotation',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(OB.MobileApp.model.get('terminal').terminalType.documentTypeForQuotations){if(OB.MobileApp.model.hasPermission(this.permission)){if(this.model.get('leftColumnViewManager').isMultiOrder()){if(this.model.get('multiorders')){this.model.get('multiorders').resetValues();}
this.model.get('leftColumnViewManager').setOrderMode();}
this.doCreateQuotation();}}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_QuotationNoDocType'));}},updateVisibility:function(model){if(!model.get('isQuotation')){this.show();this.adjustVisibilityBasedOnPermissions();}},init:function(model){var receipt=model.get('order'),me=this;this.model=model;receipt.on('change:isQuotation',function(model){this.updateVisibility(model);},this);}});enyo.kind({name:'OB.UI.MenuDiscounts',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.advDiscounts',events:{onDiscountsMode:''},i18nLabel:'OBPOS_LblReceiptDiscounts',tap:function(){if(!this.disabled){this.inherited(arguments);this.doDiscountsMode({tabPanel:'edit',keyboard:'toolbardiscounts',edit:false,options:{discounts:true}});}},updateVisibility:function(){var me=this;if(this.model.get('leftColumnViewManager').isMultiOrder()){me.setDisabled(true);return;}
if(this.receipt.get('isEditable')===false){me.setDisabled(true);return;}
OB.UTIL.isDisableDiscount(this.receipt,function(disable){me.setDisabled(disable);});me.adjustVisibilityBasedOnPermissions();},init:function(model){var me=this;this.model=model;this.receipt=model.get('order');me.setDisabled(true);if(!OB.MobileApp.model.hasPermission(this.permission)){return;}
model.get('leftColumnViewManager').on('order',function(){this.updateVisibility();},this);model.get('leftColumnViewManager').on('multiorder',function(){me.setDisabled(true);},this);this.receipt.on('change',function(){this.updateVisibility();},this);this.receipt.get('lines').on('all',function(){this.updateVisibility();},this);}});enyo.kind({name:'OB.UI.MenuCreateOrderFromQuotation',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.createorderfromquotation',events:{onShowPopup:''},i18nLabel:'OBPOS_CreateOrderFromQuotation',tap:function(){if(this.disabled){return true;}
if(OB.MobileApp.model.hasPermission(this.permission)){this.inherited(arguments);this.doShowPopup({popup:'modalCreateOrderFromQuotation'});}},updateVisibility:function(model){if(OB.MobileApp.model.hasPermission(this.permission)&&model.get('isQuotation')&&model.get('hasbeenpaid')==='Y'){this.show();}else{this.hide();}},init:function(model){var receipt=model.get('order'),me=this;me.hide();model.get('leftColumnViewManager').on('order',function(){this.updateVisibility(receipt);this.adjustVisibilityBasedOnPermissions();},this);model.get('leftColumnViewManager').on('multiorder',function(){me.hide();},this);receipt.on('change:isQuotation',function(model){this.updateVisibility(model);},this);receipt.on('change:hasbeenpaid',function(model){this.updateVisibility(model);},this);}});enyo.kind({name:'OB.UI.MenuReactivateQuotation',kind:'OB.UI.MenuAction',permission:'OBPOS_receipt.reactivatequotation',events:{onShowReactivateQuotation:''},i18nLabel:'OBPOS_ReactivateQuotation',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(OB.MobileApp.model.hasPermission(this.permission)){this.doShowReactivateQuotation();}},updateVisibility:function(model){if(OB.MobileApp.model.hasPermission(this.permission)&&model.get('isQuotation')&&model.get('hasbeenpaid')==='Y'){this.show();}else{this.hide();}},init:function(model){var receipt=model.get('order'),me=this;me.hide();model.get('leftColumnViewManager').on('order',function(){this.updateVisibility(receipt);this.adjustVisibilityBasedOnPermissions();},this);model.get('leftColumnViewManager').on('multiorder',function(){me.hide();},this);receipt.on('change:isQuotation',function(model){this.updateVisibility(model);},this);receipt.on('change:hasbeenpaid',function(model){this.updateVisibility(model);},this);}});enyo.kind({name:'OB.UI.MenuRejectQuotation',kind:'OB.UI.MenuAction',permission:'OBPOS_quotation.rejections',events:{onShowRejectQuotation:''},i18nLabel:'OBPOS_RejectQuotation',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(OB.MobileApp.model.hasPermission(this.permission,true)){this.doShowRejectQuotation();}},updateVisibility:function(model){if(OB.MobileApp.model.hasPermission(this.permission,true)&&model.get('isQuotation')&&model.get('hasbeenpaid')==='Y'){this.show();}else{this.hide();}},init:function(model){var receipt=model.get('order'),me=this;me.hide();model.get('leftColumnViewManager').on('order',function(){this.updateVisibility(receipt);this.adjustVisibilityBasedOnPermissions();},this);model.get('leftColumnViewManager').on('multiorder',function(){me.hide();},this);receipt.on('change:isQuotation',function(model){this.updateVisibility(model);},this);receipt.on('change:hasbeenpaid',function(model){this.updateVisibility(model);},this);}});enyo.kind({name:'OB.UI.MenuPaidReceipts',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.paidReceipts',events:{onPaidReceipts:''},i18nLabel:'OBPOS_LblPaidReceipts',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(!OB.MobileApp.model.get('connectedToERP')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));return;}
if(OB.MobileApp.model.hasPermission(this.permission)){this.doPaidReceipts({isQuotation:false});}}});enyo.kind({name:'OB.UI.MenuQuotations',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.quotations',events:{onQuotations:''},i18nLabel:'OBPOS_Quotations',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(!OB.MobileApp.model.get('connectedToERP')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));return;}
if(OB.MobileApp.model.hasPermission(this.permission)){this.doQuotations();}}});enyo.kind({name:'OB.UI.MenuLayaways',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.layaways',events:{onLayaways:''},i18nLabel:'OBPOS_LblLayaways',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(!OB.MobileApp.model.get('connectedToERP')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));return;}
if(OB.MobileApp.model.hasPermission(this.permission)){this.doLayaways();}}});enyo.kind({name:'OB.UI.MenuMultiOrders',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.multiorders',events:{onMultiOrders:''},i18nLabel:'OBPOS_LblPayOpenTickets',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(!OB.MobileApp.model.get('connectedToERP')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));return;}
if(OB.MobileApp.model.hasPermission(this.permission)){this.doMultiOrders();}}});enyo.kind({name:'OB.UI.MenuBackOffice',kind:'OB.UI.MenuAction',permission:'OBPOS_retail.backoffice',url:'../..',events:{onBackOffice:''},i18nLabel:'OBPOS_LblOpenbravoWorkspace',tap:function(){if(this.disabled){return true;}
this.inherited(arguments);if(OB.MobileApp.model.hasPermission(this.permission)){this.doBackOffice({url:this.url});}}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalSelectTerminal',closeOnEscKey:false,autoDismiss:false,executeOnShow:function(){this.$.bodyButtons.$.terminalKeyIdentifier.attributes.placeholder=OB.I18N.getLabel('OBPOS_TerminalKeyIdentifier');this.$.bodyButtons.$.username.attributes.placeholder=OB.I18N.getLabel('OBMOBC_LoginUserInput');this.$.bodyButtons.$.password.attributes.placeholder=OB.I18N.getLabel('OBMOBC_LoginPasswordInput');},bodyContent:{i18nContent:'OBPOS_SelectTerminalMsg'},bodyButtons:{components:[{kind:'enyo.Input',type:'text',name:'terminalKeyIdentifier',classes:'input-login',style:'display: block; margin-left: auto; margin-right: auto;',onkeydown:'inputKeydownHandler'},{kind:'enyo.Input',type:'text',name:'username',classes:'input-login',style:'display: block; margin-left: auto; margin-right: auto;',onkeydown:'inputKeydownHandler'},{kind:'enyo.Input',type:'password',name:'password',classes:'input-login',style:'display: block; margin-left: auto; margin-right: auto;',onkeydown:'inputKeydownHandler'},{kind:'OB.UI.btnApplyTerminal'}]},initComponents:function(){this.header=OB.I18N.getLabel('OBPOS_SelectTerminalHeader');this.inherited(arguments);this.$.headerCloseButton.hide();OB.MobileApp.view.currentWindow='terminalAuthentication';}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.btnApplyTerminal',isDefaultAction:true,i18nContent:'OBPOS_LblApplyButton',tap:function(){var terminalData={terminalKeyIdentifier:this.owner.$.terminalKeyIdentifier.getValue(),username:this.owner.$.username.getValue(),password:this.owner.$.password.getValue(),cacheSessionId:window.localStorage.getItem('cacheSessionId')};this.doHideThisPopup();this.owner.owner.context.linkTerminal(JSON.stringify(terminalData),this.owner.owner.callback);}});enyo.kind({name:'OB.UI.PopupDrawerOpened',kind:'OB.UI.Popup',classes:'modal-dialog',bodyContentClass:'modal-dialog-header-text',showing:false,closeOnEscKey:false,autoDismiss:false,keydownHandler:'',i18nHeader:'OBPOS_closeDrawerContinue',components:[{classes:'modal-dialog-header',name:'table',components:[{name:'header',classes:'modal-dialog-header-text'}]},{classes:'modal-dialog-body',name:'bodyParent',components:[{name:'bodyContent'}]}],bodyContent:{kind:'enyo.Control',name:'label'},initComponents:function(){this.inherited(arguments);this.setStyle('min-height: 180px;');if(this.i18nHeader){this.$.header.setContent(OB.I18N.getLabel(this.i18nHeader));}else{this.$.header.setContent(this.header);}
this.$.bodyContent.setClasses(this.bodyContentClass);if(this.bodyContent&&this.bodyContent.i18nContent){this.$.bodyContent.setContent(OB.I18N.getLabel(this.bodyContent.i18nContent));}else{this.$.bodyContent.createComponent(this.bodyContent);}}});OB.UTIL.HookManager.registerHook('OBPOS_LoadPOSWindow',function(args,callbacks){if(OB.MobileApp.model.get('permissions').OBPOS_closeDrawerBeforeContinue){OB.POS.hwserver.isDrawerClosed({openFirst:false},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}
OB.UTIL.HookManager.callbackExecutor(args,callbacks);});enyo.kind({kind:'OB.UI.SearchProductCharacteristicFilter',name:'OB.UI.SearchServicesFilter',filterName:'ServicesFilter',published:{type:'PANEL',productId:null,productList:null,orderline:null,orderlineList:null},handlers:{onAddProduct:'addProduct'},sqlFilter:function(){var me=this,result={},where='',filters=[],auxProdFilters=[],auxCatFilters=[],auxProdStr='(',auxCatStr='(',appendProdComma=false,appendCatComma=false,existingServices,lineIdList;if(this.productList&&this.productList.length>0){lineIdList=this.orderlineList.map(function(line){return line.get('id');});existingServices=OB.MobileApp.model.receipt.get('lines').filter(function(l){if(l.get('relatedLines')&&_.intersection(lineIdList,_.pluck(l.get('relatedLines'),'orderlineId')).length>0){return true;}
return false;}).map(function(line){var product=line.get('product');return product.get('forceFilterId')?product.get('forceFilterId'):product.get('id');});this.orderlineList.forEach(function(l){if(appendProdComma){auxProdStr+=', ';}else{appendProdComma=true;}
auxProdStr+='?';var product=l.get('product');auxProdFilters.push(product.get('forceFilterId')?product.get('forceFilterId'):product.get('id'));if(auxCatFilters.indexOf(l.get('product').get('productCategory'))<0){if(appendCatComma){auxCatStr+=', ';}else{appendCatComma=true;}
auxCatStr+='?';auxCatFilters.push(l.get('product').get('productCategory'));}});auxProdStr+=')';auxCatStr+=')';where=" and product.productType = 'S' and (product.isLinkedToProduct = 'true' and ";if(this.productList.length>1){where+=" product.availableForMultiline = 'true' and ";}
where+="((product.includeProducts = 'Y' and not exists (select 1 from m_product_service sp where product.m_product_id = sp.m_product_id and sp.m_related_product_id in "+auxProdStr+" )) ";where+="or (product.includeProducts = 'N' and "+auxProdFilters.length+" = (select count(*) from m_product_service sp where product.m_product_id = sp.m_product_id and sp.m_related_product_id in "+auxProdStr+" )) ";where+="or product.includeProducts is null) ";where+="and ((product.includeProductCategories = 'Y' and not exists (select 1 from m_product_category_service spc where product.m_product_id = spc.m_product_id and spc.m_product_category_id in "+auxCatStr+" )) ";where+="or (product.includeProductCategories = 'N' and "+auxCatFilters.length+" = (select count(*) from m_product_category_service spc where product.m_product_id = spc.m_product_id and spc.m_product_category_id in "+auxCatStr+" )) ";where+="or product.includeProductCategories is null)) ";where+="and product.m_product_id not in ('"+existingServices.join("','")+"')";filters=filters.concat(auxProdFilters);filters=filters.concat(auxProdFilters);filters=filters.concat(auxCatFilters);filters=filters.concat(auxCatFilters);}else if(this.productId){existingServices=OB.MobileApp.model.receipt.get('lines').filter(function(l){if(l.get('relatedLines')&&_.indexOf(_.pluck(l.get('relatedLines'),'orderlineId'),me.orderline.get('id'))!==-1){return true;}
return false;}).map(function(line){var product=line.get('product');return product.get('forceFilterId')?product.get('forceFilterId'):product.get('id');});where=" and product.productType = 'S' and (product.isLinkedToProduct = 'true' and ";where+="((product.includeProducts = 'Y' and not exists (select 1 from m_product_service sp where product.m_product_id = sp.m_product_id and sp.m_related_product_id = ? )) ";where+="or (product.includeProducts = 'N' and exists (select 1 from m_product_service sp where product.m_product_id = sp.m_product_id and sp.m_related_product_id = ? )) ";where+="or product.includeProducts is null) ";where+="and ((product.includeProductCategories = 'Y' and not exists (select 1 from m_product_category_service spc where product.m_product_id = spc.m_product_id and spc.m_product_category_id =  ? )) ";where+="or (product.includeProductCategories = 'N' and exists (select 1 from m_product_category_service spc where product.m_product_id = spc.m_product_id and spc.m_product_category_id  = ? )) ";where+="or product.includeProductCategories is null)) ";where+="and product.m_product_id not in ('"+existingServices.join("','")+"')";var product=this.orderline.get('product'),productId=product.get('forceFilterId')?product.get('forceFilterId'):product.get('id');filters.push(productId);filters.push(productId);filters.push(this.orderline.get('product').get('productCategory'));filters.push(this.orderline.get('product').get('productCategory'));}
result.where=where;result.filters=filters;return result;},hqlCriteria:function(){var me=this,prodList,catList,lineIdList,existingServices;if(this.orderlineList&&this.orderlineList.length>0){prodList=this.orderlineList.map(function(line){var product=line.get('product');return product.get('forceFilterId')?product.get('forceFilterId'):product.get('id');});catList=this.orderlineList.map(function(line){return line.get('product').get('productCategory');});catList=catList.sort().filter(function(item,pos,ary){return!pos||item!==ary[pos-1];});lineIdList=this.orderlineList.map(function(line){return line.get('id');});existingServices=OB.MobileApp.model.receipt.get('lines').filter(function(l){if(l.get('relatedLines')&&_.intersection(lineIdList,_.pluck(l.get('relatedLines'),'orderlineId')).length>0){return true;}
return false;}).map(function(line){var product=line.get('product');return product.get('forceFilterId')?product.get('forceFilterId'):product.get('id');});return[{columns:[],operator:OB.Dal.FILTER,value:(this.orderlineList.length>1?'Services_Filter_Multi':'Services_Filter'),params:[prodList,catList,prodList.length,catList.length,(existingServices.length>0?existingServices:'-')],fieldType:'Long'},{columns:['ispack'],operator:'equals',value:false,fieldType:'forceString'}];}else{existingServices=OB.MobileApp.model.receipt.get('lines').filter(function(l){if(l.get('relatedLines')&&_.indexOf(_.pluck(l.get('relatedLines'),'orderlineId'),me.orderline.get('id'))!==-1){return true;}
return false;}).map(function(line){var product=line.get('product');return product.get('forceFilterId')?product.get('forceFilterId'):product.get('id');});var product=this.orderline.get('product');return[{columns:[],operator:OB.Dal.FILTER,value:'Services_Filter',params:[product.get('forceFilterId')?product.get('forceFilterId'):product.get('id'),product.get('productCategory'),'','',(existingServices.length>0?existingServices.join("','"):'-')]},{columns:['ispack'],operator:'equals',value:false,fieldType:'forceString'}];}},lineAttributes:function(){var productList=[];if(this.orderlineList){this.orderlineList.forEach(function(ol){ol.set('preserveId',true);productList.push({orderlineId:ol.get('id'),productName:ol.get('product').get('_identifier')});});}else if(this.orderline){this.orderline.set('preserveId',true);productList.push({orderlineId:this.orderline.get('id'),productName:this.orderline.get('product').get('_identifier')});}
return{relatedLines:productList};},initComponents:function(){this.inherited(arguments);this.caption=OB.I18N.getLabel('OBPOS_ServicesFor');}});enyo.kind({kind:'OB.UI.SearchProductCharacteristicFilter',name:'OB.UI.MandatoryServicesFilter',filterName:'MandatoryServicesFilter',published:{type:'HIDDEN'},sqlFilter:function(){var result={};result.where=" and product.proposalType = 'MP'";result.filters=[];return result;},hqlCriteria:function(){return[{columns:[],operator:OB.Dal.FILTER,value:'Mandatory_Services',params:[]}];}});enyo.kind({kind:'OB.UI.SearchProductCharacteristicFilter',name:'OB.UI.FinalMandatoryServicesFilter',filterName:'FinalMandatoryServicesFilter',published:{type:'PANEL'},sqlFilter:function(){var result={};result.where=" and product.productType = 'S' and product.proposalType = 'FMA'";result.filters=[];return result;},hqlCriteria:function(){return[{columns:[],operator:OB.Dal.FILTER,value:'Final_Services',params:[]},{columns:['ispack'],operator:'equals',value:false,fieldType:'forceString'}];},renderInfo:function(){var content={content:OB.I18N.getLabel('OBPOS_FinalServices')};return content;}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ModalSelectOpenedReceipt_btnApply',isDefaultAction:true,i18nContent:'OBPOS_LblApplyButton',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ModalSelectOpenedReceipt_btnCancel',isDefaultAction:false,i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalSelectOpenedReceipt',i18nHeader:'OBPOS_lblHeaderSelectOpenedReceiptModal',bodyContent:{components:[{name:'lblSelectOpenedReceiptModal'},{name:'listSelectOpenedReceiptModal',kind:'OB.UI.OpenedReceiptsList'},{style:'display: inline-block',components:[{name:'chkSelectOpenedReceiptModal',kind:'OB.UI.CheckboxButton',style:'float: left; width: 44px; height: 44px; background-position: center center; border: 1px solid white; cursor: pointer;',classes:'btn-check-alt'},{name:'lblSelectOpenedReceiptModalChk',style:'float: left; padding: 6px 0px 0px 14px;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_lblSelectOpenedReceiptModalChk'));}}]}]},bodyButtons:{components:[{kind:'OB.UI.ModalSelectOpenedReceipt_btnApply',disabled:true,tap:function(){var orderModel=this.owner.owner.selectedLine.model;if(this.owner.owner.selectedLine.id.indexOf('openedReceiptsListLine')===-1){var orderList=this.owner.owner.owner.model.get('orderList');orderList.saveCurrent();var newOrder=orderList.newOrder(orderList.current.get('bp'));orderList.unshift(newOrder);orderModel=newOrder;orderModel.set('deferredOrder',true);}
this.owner.owner.doAddProduct({targetOrder:orderModel,product:this.owner.owner.args.product,attrs:this.owner.owner.args.attrs,context:this.owner.owner.args.context,callback:this.owner.owner.args.callback});this.owner.owner.args.callback=null;if(this.owner.owner.$.bodyContent.$.chkSelectOpenedReceiptModal.checked){var me=this,onCalculategross;me.owner.owner.doChangeCurrentOrder({newCurrentOrder:orderModel});me.owner.owner.owner.model.get('order').calculateReceipt();onCalculategross=function(){orderModel.off('saveCurrent',onCalculategross);me.owner.owner.owner.model.get('order').trigger('updateServicePrices');};orderModel.on('saveCurrent',onCalculategross);}
this.owner.owner.doHideThisPopup();}},{kind:'OB.UI.ModalSelectOpenedReceipt_btnCancel'}]},executeOnHide:function(){if(this.args.callback){this.args.callback.call(this.args.context,false);}},executeOnShow:function(){this.uncheckAllItems();this.$.bodyContent.$.chkSelectOpenedReceiptModal.check();this.$.bodyButtons.$.modalSelectOpenedReceipt_btnApply.setDisabled(true);this.$.bodyContent.$.lblSelectOpenedReceiptModal.setContent(OB.I18N.getLabel('OBPOS_LblSelectOpenedReceiptModal',[this.args.product.attributes._identifier]));},published:{receiptsList:null},receiptsListChanged:function(oldValue){this.$.bodyContent.$.listSelectOpenedReceiptModal.setReceiptsList(this.receiptsList);},init:function(model){this.$.bodyButtons.setStyle('padding-top: 5px');},events:{onChangeCurrentOrder:'',onHideThisPopup:'',onAddProduct:''},selectedLine:null,uncheckAllItems:function(){var items=this.$.bodyContent.$.listSelectOpenedReceiptModal.$.openedreceiptslistitemprinter.$.tbody.$,buttonContainer,control,openedReceiptsListLine,i;this.$.bodyContent.$.listSelectOpenedReceiptModal.$.button.setStyle(this.$.bodyContent.$.listSelectOpenedReceiptModal.$.button.style.replace(' background-color: #cccccc;',''));for(control in items){if(items.hasOwnProperty(control)){if(control.substring(0,7)==='control'){buttonContainer=items[control].$;for(openedReceiptsListLine in buttonContainer){if(buttonContainer.hasOwnProperty(openedReceiptsListLine)){if(openedReceiptsListLine.substring(0,22)==='openedReceiptsListLine'){buttonContainer[openedReceiptsListLine].setStyle(buttonContainer[openedReceiptsListLine].style.replace(' background-color: #cccccc;',''));}}}}}}},checkItem:function(line){this.selectedLine=line;this.uncheckAllItems();line.setStyle(line.style+' background-color: #cccccc;');if(this.$.bodyButtons.$.modalSelectOpenedReceipt_btnApply.disabled){this.$.bodyButtons.$.modalSelectOpenedReceipt_btnApply.setDisabled(false);}}});enyo.kind({name:'OB.UI.OpenedReceiptsList',classes:'row-fluid',published:{receiptsList:null},components:[{classes:'span12',style:'margin: 20px 0px 20px 0px; height: 189px; overflow-y: auto;',components:[{components:[{kind:'OB.UI.Button',classes:'btnselect',style:'height: 63px; line-height: 23px; width: 100%; font-size: 16px; background-color: white; border-bottom: 1px solid #cccccc;',components:[{style:'width: 100%',components:[{style:'float: left; width: 15%; color: black;',components:[{tag:"img",style:'float: left; width: 19px; height: 19px; color: black; margin-left: 10px;',attributes:{src:'../org.openbravo.mobile.core/assets/img/iconCreateNew-alt.png'}}]},{style:'float: left; width: 80%; color: black;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblCreateNewReceipt'));}},{style:'float: left; width: 80%; color: white; display: hidden;',content:'.'},{style:'clear: both;'}]}],tap:function(){if(this.owner.owner.owner.checkItem){this.owner.owner.owner.checkItem(this);}}},{name:'openedreceiptslistitemprinter',kind:'OB.UI.ScrollableTable',renderLine:'OB.UI.OpenedReceiptsListLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}],receiptsListChanged:function(oldValue){this.$.openedreceiptslistitemprinter.setCollection(this.receiptsList);}});enyo.kind({name:'OB.UI.OpenedReceiptsListLine',kind:'OB.UI.SelectButton',tap:function(){this.inherited(arguments);if(this.owner.owner.owner.owner.owner.owner.checkItem){this.owner.owner.owner.owner.owner.owner.checkItem(this);}},components:[{name:'line',style:'line-height: 23px; width: 100%; font-size: 16px;',components:[{components:[{style:'float: left; width: 15%',name:'time'},{style:'float: left; width: 25%',name:'orderNo'},{style:'float: left; width: 60%',name:'bp'},{style:'clear: both;'}]},{components:[{style:'float: left; width: 15%; font-weight: bold;'},{style:'float: left; width: 25%; font-weight: bold;'},{style:'float: right; text-align: right; width: 25%; font-weight: bold;',name:'total'},{style:'clear: both;'}]}]}],create:function(){this.inherited(arguments);if(this.model.get('isPaid')||this.model.get('isLayaway')){this.setStyle('display: none');}
if(this.model.get('isPaid')||this.model.get('isLayaway')){this.$.time.setContent(OB.I18N.formatDate(this.model.get('orderDate')));}else{this.$.time.setContent(OB.I18N.formatHour(this.model.get('orderDate')));}
this.$.orderNo.setContent(this.model.get('documentNo'));this.$.bp.setContent(this.model.get('bp').get('_identifier'));this.$.total.setContent(this.model.printTotal());OB.UTIL.HookManager.executeHooks('OBPOS_RenderListReceiptLine',{listReceiptLine:this},function(args){});}});enyo.kind({name:'OB.UI.ModalPRScrollableHeader',kind:'OB.UI.ScrollableTableHeader',events:{onSearchAction:'',onClearAction:''},handlers:{onFiltered:'searchAction'},components:[{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'filterText',style:'width: 100%'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]},{style:'display: table;',components:[{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblStartDate'));},style:'width: 200px;  margin: 0px 0px 2px 5px;'}]},{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblEndDate'));},style:'width 200px; margin: 0px 0px 2px 65px;'}]}]},{style:'display: table;',components:[{style:'display: table-cell;',components:[{kind:'enyo.Input',name:'startDate',size:'10',type:'text',style:'width: 100px;  margin: 0px 0px 8px 5px;',onchange:'searchAction'}]},{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getDateFormatLabel());},style:'width: 100px; color:gray;  margin: 0px 0px 8px 5px;'}]},{kind:'enyo.Input',name:'endDate',size:'10',type:'text',style:'width: 100px;  margin: 0px 0px 8px 50px;',onchange:'searchAction'},{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getDateFormatLabel());},style:'width: 100px; color:gray;  margin: 0px 0px 8px 5px;'}]}]}]}],showValidationErrors:function(stDate,endDate){var me=this;if(stDate===false){this.$.startDate.addClass('error');setTimeout(function(){me.$.startDate.removeClass('error');},5000);}
if(endDate===false){this.$.endDate.addClass('error');setTimeout(function(){me.$.endDate.removeClass('error');},5000);}},disableFilterText:function(value){this.$.filterText.setDisabled(value);},clearAction:function(){if(!this.$.filterText.disabled){this.$.filterText.setValue('');}
this.$.startDate.setValue('');this.$.endDate.setValue('');this.doClearAction();},getDateFilters:function(){var startDate,endDate,startDateValidated=true,endDateValidated=true,formattedStartDate='',formattedEndDate='';startDate=this.$.startDate.getValue();endDate=this.$.endDate.getValue();if(startDate!==''){startDateValidated=OB.Utilities.Date.OBToJS(startDate,OB.Format.date);if(startDateValidated){formattedStartDate=OB.Utilities.Date.JSToOB(startDateValidated,'yyyy-MM-dd');}}
if(endDate!==''){endDateValidated=OB.Utilities.Date.OBToJS(endDate,OB.Format.date);if(endDateValidated){formattedEndDate=OB.Utilities.Date.JSToOB(endDateValidated,'yyyy-MM-dd');}}
if(startDate!==''&&startDateValidated&&endDate!==''&&endDateValidated){if(moment(endDateValidated).diff(moment(startDateValidated))<0){endDateValidated=null;startDateValidated=null;}}
if(startDateValidated===null||endDateValidated===null){this.showValidationErrors(startDateValidated!==null,endDateValidated!==null);return false;}else{this.$.startDate.removeClass('error');this.$.endDate.removeClass('error');}
this.filters=_.extend(this.filters,{startDate:formattedStartDate,endDate:formattedEndDate});return true;},searchAction:function(){var params=this.parent.parent.parent.parent.parent.parent.parent.parent.params;this.filters={documentType:params.isQuotation?([OB.MobileApp.model.get('terminal').terminalType.documentTypeForQuotations]):([OB.MobileApp.model.get('terminal').terminalType.documentType,OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns]),docstatus:params.isQuotation?'UE':null,isQuotation:params.isQuotation?true:false,isLayaway:params.isLayaway?true:false,isReturn:params.isReturn?true:false,filterText:this.$.filterText.getValue(),pos:OB.MobileApp.model.get('terminal').id,client:OB.MobileApp.model.get('terminal').client,organization:OB.MobileApp.model.get('terminal').organization};if(!this.getDateFilters()){return true;}
this.doSearchAction({filters:this.filters});return true;}});enyo.kind({name:'OB.UI.ListPRsLine',kind:'OB.UI.listItemButton',allowHtml:true,events:{onHideThisPopup:''},tap:function(){this.inherited(arguments);this.doHideThisPopup();},components:[{name:'line',style:'line-height: 23px;',components:[{name:'topLine'},{style:'color: #888888',name:'bottonLine'},{style:'clear: both;'}]}],create:function(){var returnLabel='';this.inherited(arguments);if(this.model.get('documentTypeId')===OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns){this.model.set('totalamount',OB.DEC.mul(this.model.get('totalamount'),-1));returnLabel=' ('+OB.I18N.getLabel('OBPOS_ToReturn')+')';}
this.$.topLine.setContent(this.model.get('documentNo')+' - '+this.model.get('businessPartner')+returnLabel);this.$.bottonLine.setContent(this.model.get('totalamount')+' ('+this.model.get('orderDate').substring(0,10)+') ');OB.UTIL.HookManager.executeHooks('OBPOS_RenderPaidReceiptLine',{paidReceiptLine:this},function(){});this.render();}});enyo.kind({name:'OB.UI.ListPRs',classes:'row-fluid',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},events:{onChangePaidReceipt:'',onShowPopup:'',onAddProduct:'',onHideThisPopup:'',onChangeCurrentOrder:''},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;',classes:'row-fluid',components:[{classes:'span12',components:[{name:'prslistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'350px',renderHeader:'OB.UI.ModalPRScrollableHeader',renderLine:'OB.UI.ListPRsLine',renderEmpty:'OB.UI.RenderEmpty'},{name:'renderLoading',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',showing:false,initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblLoading'));}}]}]}]}],clearAction:function(){this.prsList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,ordersLoaded=[],process=new OB.DS.Process('org.openbravo.retail.posterminal.PaidReceiptsHeader');me.filters=inEvent.filters;this.clearAction();this.$.prslistitemprinter.$.tempty.hide();this.$.prslistitemprinter.$.tbody.hide();this.$.prslistitemprinter.$.tlimit.hide();this.$.renderLoading.show();var limit=OB.Model.Order.prototype.dataLimit;if(OB.MobileApp.model.hasPermission('OBPOS_orderLimit',true)){limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_orderLimit',true));OB.Model.Order.prototype.tempDataLimit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_orderLimit',true));}
process.exec({filters:me.filters,_limit:limit+1,_dateFormat:OB.Format.date},function(data){if(data){ordersLoaded=[];_.each(data,function(iter){me.model.get('orderList').newDynamicOrder(iter,function(order){ordersLoaded.push(order);});});me.prsList.reset(ordersLoaded);me.$.renderLoading.hide();if(data&&data.length>0){me.$.prslistitemprinter.$.tbody.show();}else{me.$.prslistitemprinter.$.tempty.show();}
me.$.prslistitemprinter.getScrollArea().scrollToTop();}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgErrorDropDep'));}},function(error){if(error){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));}});return true;},prsList:null,init:function(model){var me=this,process=new OB.DS.Process('org.openbravo.retail.posterminal.PaidReceipts');this.model=model;this.prsList=new Backbone.Collection();this.$.prslistitemprinter.setCollection(this.prsList);this.prsList.on('click',function(model){function loadOrder(model){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('clickSearch');OB.UTIL.showLoading(true);process.exec({orderid:model.get('id')},function(data){if(data){if(me.model.get('leftColumnViewManager').isMultiOrder()){if(me.model.get('multiorders')){me.model.get('multiorders').resetValues();}
me.model.get('leftColumnViewManager').setOrderMode();}
OB.UTIL.HookManager.executeHooks('OBRETUR_ReturnFromOrig',{order:data[0],context:me,params:me.parent.parent.params},function(args){if(!args.cancelOperation){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('clickSearchNewReceipt');me.model.get('orderList').newPaidReceipt(data[0],function(order){me.doChangePaidReceipt({newPaidReceipt:order});OB.UTIL.SynchronizationHelper.finished(synchId,'clickSearchNewReceipt');});}});}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgErrorDropDep'));}
OB.UTIL.SynchronizationHelper.finished(synchId,'clickSearch');});return true;}
var i=0;for(i=0;i<me.model.get('orderList').length;i++){if(me.model.get('orderList').models[i].get('id')===model.get('id')){var orderTypeMsg=OB.I18N.getLabel('OBPOS_ticket');if(me.model.get('orderList').models[i].get('isLayaway')){orderTypeMsg=OB.I18N.getLabel('OBPOS_LblLayaway');}else if(me.model.get('orderList').models[i].get('isQuotation')){orderTypeMsg=OB.I18N.getLabel('OBPOS_Quotation');}
me.doShowPopup({popup:'OB_UI_MessageDialog',args:{message:(enyo.format(OB.I18N.getLabel('OBPOS_ticketAlreadyOpened'),orderTypeMsg,model.get('documentNo')))}});if(OB.MobileApp.model.receipt.get('documentNo')!==model.get('documentNo')){me.doChangeCurrentOrder({newCurrentOrder:me.model.get('orderList').models[i]});}
return true;}}
OB.Dal.find(OB.Model.Order,{'hasbeenpaid':'N'},function(ordersNotProcessed){if(ordersNotProcessed.length>0){var existingOrder=_.find(ordersNotProcessed.models,function(order){return order.get('id')===model.get('id')||order.get('oldId')===model.get('id');});if(existingOrder){var orderTypeMsg=OB.I18N.getLabel('OBPOS_ticket');if(existingOrder.get('isLayaway')){orderTypeMsg=OB.I18N.getLabel('OBPOS_LblLayaway');}else if(existingOrder.get('isQuotation')){orderTypeMsg=OB.I18N.getLabel('OBPOS_Quotation');}
OB.Dal.find(OB.Model.Session,{'id':existingOrder.get('session')},function(sessions){if(sessions.length>0){OB.Dal.find(OB.Model.User,{'id':sessions.models[0].get('user')},function(users){if(users.length>0){OB.UTIL.showConfirmation.display(enyo.format(OB.I18N.getLabel('OBPOS_ticketAlreadyOpenedInSession'),orderTypeMsg,model.get('documentNo'),users.models[0].get('name')),enyo.format(OB.I18N.getLabel('OBPOS_MsgConfirmSaveInCurrentSession'),users.models[0].get('name')),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){OB.Dal.remove(existingOrder,function(){loadOrder(model);},OB.UTIL.showError);}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}],{onHideFunction:function(dialog){return true;}});}});}});}else{return loadOrder(model);}}else{return loadOrder(model);}});return true;},this);}});enyo.kind({name:'OB.UI.ModalPaidReceipts',kind:'OB.UI.Modal',topPosition:'125px',i18nHeader:'OBPOS_LblPaidReceipts',published:{params:null},changedParams:function(){},body:{kind:'OB.UI.ListPRs'},handlers:{onChangePaidReceipt:'changePaidReceipt'},changePaidReceipt:function(inSender,inEvent){this.model.get('orderList').addPaidReceipt(inEvent.newPaidReceipt);this.model.attributes.order.calculateReceipt();return true;},executeOnShow:function(){this.$.body.$.listPRs.$.prslistitemprinter.$.theader.$.modalPRScrollableHeader.disableFilterText(false);this.$.body.$.listPRs.$.prslistitemprinter.$.theader.$.modalPRScrollableHeader.clearAction();if(this.params.isQuotation){this.$.header.setContent(OB.I18N.getLabel('OBPOS_Quotations'));}else if(this.params.isLayaway){this.$.header.setContent(OB.I18N.getLabel('OBPOS_LblLayaways'));}else{this.$.header.setContent(OB.I18N.getLabel('OBPOS_LblPaidReceipts'));if(this.params.isReturn&&this.params.bpartner){var me=this;me.$.body.$.listPRs.$.prslistitemprinter.$.theader.$.modalPRScrollableHeader.$.filterText.setValue(this.params.bpartner.get('name'));me.$.body.$.listPRs.$.prslistitemprinter.$.theader.$.modalPRScrollableHeader.searchAction();enyo.forEach(this.model.get('orderList').current.get('lines').models,function(l){if(l.get('originalOrderLineId')){me.$.body.$.listPRs.$.prslistitemprinter.$.theader.$.modalPRScrollableHeader.disableFilterText(true);return;}});}}},init:function(model){this.model=model;}});enyo.kind({name:'OB.UI.ModalMultiOrdersHeader',kind:'OB.UI.ModalPRScrollableHeader',events:{onSearchAction:'',onClearAction:''},handlers:{onSearchActionByKey:'searchAction',onFiltered:'searchAction'},components:[{style:'padding: 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'filterText',style:'width: 100%',isFirstFocus:true}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]},{style:'display: table;',components:[{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblStartDate'));},style:'width: 200px;  margin: 0px 0px 2px 5px;'}]},{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblEndDate'));},style:'width 200px; margin: 0px 0px 2px 65px;'}]}]},{style:'display: table;',components:[{style:'display: table-cell;',components:[{kind:'enyo.Input',name:'startDate',size:'10',type:'text',style:'width: 100px;  margin: 0px 0px 8px 5px;',onchange:'searchAction'}]},{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getDateFormatLabel());},style:'width: 100px; color:gray;  margin: 0px 0px 8px 5px;'}]},{kind:'enyo.Input',name:'endDate',size:'10',type:'text',style:'width: 100px;  margin: 0px 0px 8px 50px;',onchange:'searchAction'},{style:'display: table-cell;',components:[{tag:'h4',initComponents:function(){this.setContent(OB.I18N.getDateFormatLabel());},style:'width: 100px; color:gray;  margin: 0px 0px 8px 5px;'}]}]}]}],searchAction:function(){this.filters={documentType:[OB.MobileApp.model.get('terminal').terminalType.documentType,OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns],docstatus:null,isQuotation:false,isLayaway:true,filterText:this.$.filterText.getValue(),startDate:this.$.startDate.getValue(),endDate:this.$.endDate.getValue(),pos:OB.MobileApp.model.get('terminal').id,client:OB.MobileApp.model.get('terminal').client,organization:OB.MobileApp.model.get('terminal').organization};if(!this.getDateFilters()){return true;}
this.doSearchAction({filters:this.filters});return true;}});enyo.kind({name:'OB.UI.ListMultiOrdersLine',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check',style:'border-bottom: 1px solid #cccccc;text-align: left; padding-left: 70px; height: 58px;',events:{onHideThisPopup:''},tap:function(){this.inherited(arguments);this.model.set('checked',!this.model.get('checked'));this.model.trigger('verifyDoneButton',this.model);},components:[{name:'line',style:'line-height: 23px; display: inline',components:[{style:'display: inline',name:'topLine'},{style:'font-weight: bold; color: lightblue; float: right; text-align:right; ',name:'isLayaway'},{style:'color: #888888',name:'bottonLine'},{style:'clear: both;'}]}],create:function(){var returnLabel='';this.inherited(arguments);if(this.model.get('documentTypeId')===OB.MobileApp.model.get('terminal').terminalType.documentTypeForReturns){this.model.set('totalamount',OB.DEC.mul(this.model.get('totalamount'),-1));returnLabel=' ('+OB.I18N.getLabel('OBPOS_ToReturn')+')';}
this.$.topLine.setContent(this.model.get('documentNo')+' - '+(this.model.get('bp')?this.model.get('bp').get('_identifier'):this.model.get('businessPartner'))+returnLabel);this.$.bottonLine.setContent(((this.model.get('totalamount')||this.model.get('totalamount')===0)?this.model.get('totalamount'):this.model.getPending())+' ('+OB.I18N.formatDate(new Date(this.model.get('orderDate')))+') ');if(this.model.get('checked')){this.addClass('active');}else{this.removeClass('active');}
if(this.model.get('isLayaway')){this.$.isLayaway.setContent(OB.I18N.getLabel('OBPOS_LblLayaway'));}
this.render();}});enyo.kind({name:'OB.UI.ListMultiOrders',classes:'row-fluid',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},components:[{classes:'span12',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'multiorderslistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'300px',renderHeader:'OB.UI.ModalMultiOrdersHeader',renderLine:'OB.UI.ListMultiOrdersLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}]}],cleanFilter:false,clearAction:function(inSender,inEvent){this.multiOrdersList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,toMatch=0,re,actualDate,i,processHeader=new OB.DS.Process('org.openbravo.retail.posterminal.PaidReceiptsHeader'),negativeLines;me.filters=inEvent.filters;var limit=OB.Model.Order.prototype.dataLimit;if(OB.MobileApp.model.hasPermission('OBPOS_orderLimit',true)){limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_orderLimit',true));}
this.clearAction();processHeader.exec({filters:me.filters,_limit:limit},function(data){if(data){_.each(me.model.get('orderList').models,function(iter){if(iter.get('lines')&&iter.get('lines').length>0){re=new RegExp(me.filters.filterText,'gi');toMatch=iter.get('documentNo').match(re)+iter.get('bp').get('_identifier').match(re);if((me.filters.filterText===""||toMatch!==0)&&(iter.get('orderType')===0||iter.get('orderType')===2)&&!iter.get('isPaid')&&!iter.get('isQuotation')&&iter.get('gross')>=0){actualDate=new Date().setHours(0,0,0,0);if(me.filters.endDate===""||new Date(me.filters.endDate)>=actualDate){for(i=0;i<me.filters.documentType.length;i++){if(me.filters.documentType[i]===iter.get('documentType')){if(!_.isNull(iter.id)&&!_.isUndefined(iter.id)){if(me.cleanFilter){iter.unset("checked");}
me.multiOrdersList.add(iter);break;}}}}}}});if(me.cleanFilter){me.cleanFilter=false;}
_.each(data,function(iter){me.multiOrdersList.add(iter);});}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgErrorDropDep'));}});return true;},multiOrdersList:null,init:function(model){var me=this;this.model=model;this.multiOrdersList=new Backbone.Collection();this.$.multiorderslistitemprinter.setCollection(this.multiOrdersList);this.multiOrdersList.on('verifyDoneButton',function(item){if(item.get('checked')){me.parent.parent.$.header.$.modalMultiOrdersTopHeader.disableDoneButton(false);}else{me.parent.parent.$.header.$.modalMultiOrdersTopHeader.disableDoneButton(true);_.each(me.multiOrdersList.models,function(e){if(e.get('checked')){me.parent.parent.$.header.$.modalMultiOrdersTopHeader.disableDoneButton(false);return;}});}});}});enyo.kind({name:'OB.UI.ModalMultiOrdersTopHeader',kind:'OB.UI.ScrollableTableHeader',events:{onHideThisPopup:'',onSelectMultiOrders:'',onTabChange:'',onRightToolDisabled:''},components:[{style:'display: table;',components:[{style:'display: table-cell; float:left',components:[{name:'doneMultiOrdersButton',kind:'OB.UI.SmallButton',ontap:'doneAction'}]},{style:'display: table-cell; vertical-align: middle; width: 100%;',components:[{name:'title',style:'text-align: center;'}]},{style:'display: table-cell; float:right',components:[{classes:'btnlink-green',name:'cancelMultiOrdersButton',kind:'OB.UI.SmallButton',ontap:'cancelAction'}]}]}],initComponents:function(){this.inherited(arguments);this.$.doneMultiOrdersButton.setContent(OB.I18N.getLabel('OBMOBC_LblDone'));this.$.cancelMultiOrdersButton.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));},disableDoneButton:function(value){this.$.doneMultiOrdersButton.setDisabled(value);},doneAction:function(){var selectedMultiOrders=[],me=this,process=new OB.DS.Process('org.openbravo.retail.posterminal.PaidReceipts'),checkedMultiOrders=_.compact(this.parent.parent.parent.$.body.$.listMultiOrders.multiOrdersList.map(function(e){if(e.get('checked')){return e;}}));if(checkedMultiOrders.length===0){return true;}
me.owner.owner.model.deleteMultiOrderList();_.each(checkedMultiOrders,function(iter){if(_.indexOf(me.owner.owner.model.get('orderList').models,iter)!==-1){iter.save();selectedMultiOrders.push(iter);}else{process.exec({orderid:iter.id},function(data){OB.UTIL.showLoading(false);if(data){me.owner.owner.model.get('orderList').newPaidReceipt(data[0],function(order){order.set('loadedFromServer',true);order.set('checked',iter.get('checked'));OB.DATA.OrderTaxes(order);order.set('belongsToMultiOrder',true);order.calculateReceipt(function(){selectedMultiOrders.push(order);order.save();if(selectedMultiOrders.length===checkedMultiOrders.length){me.doSelectMultiOrders({value:selectedMultiOrders});}});});}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgErrorDropDep'));}});}
if(selectedMultiOrders.length===checkedMultiOrders.length){me.doSelectMultiOrders({value:selectedMultiOrders});}});this.doTabChange({tabPanel:'payment',keyboard:'toolbarpayment',edit:false});this.doHideThisPopup();},cancelAction:function(){this.doHideThisPopup();}});enyo.kind({name:'OB.UI.ModalMultiOrders',topPosition:'125px',kind:'OB.UI.Modal',executeOnHide:function(){this.$.body.$.listMultiOrders.$.multiorderslistitemprinter.$.theader.$.modalMultiOrdersHeader.clearAction();},executeOnShow:function(){var i,j;this.$.header.$.modalMultiOrdersTopHeader.$.title.setContent(OB.I18N.getLabel('OBPOS_LblMultiOrders'));this.$.body.$.listMultiOrders.cleanFilter=true;this.$.header.$.modalMultiOrdersTopHeader.disableDoneButton(true);},i18nHeader:'',body:{kind:'OB.UI.ListMultiOrders'},initComponents:function(){this.inherited(arguments);this.$.closebutton.hide();this.$.header.createComponent({kind:'OB.UI.ModalMultiOrdersTopHeader'});},init:function(model){this.model=model;this.waterfall('onSetModel',{model:this.model});}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.btnModalCreateOrderCancel',i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.btnModalCreateOrderAccept',i18nContent:'OBPOS_CreateOrderFromQuotation',events:{onCreateOrderFromQuotation:''},tap:function(){var checked=!this.owner.$.updateprices.checked;this.parent.parent.parent.parent.theQuotation.createOrderFromQuotation(checked);this.doHideThisPopup();}});enyo.kind({name:'OB.UI.updateprices',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check',checked:false,init:function(){this.checked=!OB.MobileApp.model.get('permissions')['OBPOS_quotation.defaultNotFirm'];this.addRemoveClass('active',this.checked);this.setDisabled(!OB.MobileApp.model.hasPermission('OBPOS_quotation.editableFirmCheck'));}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalCreateOrderFromQuotation',myId:'modalCreateOrderFromQuotation',bodyContent:{i18nContent:'OBPOS_QuotationUpdatePricesText'},bodyButtons:{components:[{style:'height: 40px; width: 120px; float:left;'},{style:'height: 40px; width: 50px; background-color: rgb(226, 226, 226); float:left',components:[{kind:'OB.UI.updateprices',myId:'updatePricesCheck'}]},{style:'text-align: left; padding: 11px; float: left; width: 248px; background: #dddddd;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_QuotationUpdatePrices'));}},{style:'clear: both;'},{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModalCreateOrderAccept'},{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModalCreateOrderCancel'}]},init:function(model){var salesOrder;this.model=model;var receipt=this.model.get('order');this.theQuotation=receipt;}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.btnModalReactivateQuotationCancel',i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.btnModalReactivateQuotationAccept',i18nContent:'OBMOBC_LblOk',events:{onReactivateQuotation:''},tap:function(){this.doReactivateQuotation();this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalReactivateQuotation',myId:'modalReactivateQuotation',bodyContent:{i18nContent:'OBPOS_ReactivateQuotationMessage'},i18nHeader:'OBPOS_ReactivateQuotation',bodyButtons:{components:[{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModalReactivateQuotationAccept'},{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModalReactivateQuotationCancel'}]}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.btnModalRejectQuotationCancel',i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.btnModalRejectQuotationAccept',i18nContent:'OBMOBC_LblOk',events:{onRejectQuotationDone:''},tap:function(){this.doRejectQuotationDone();this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.List',name:'OB.UI.ModalRejectQuotationRejectReason',classes:'combo',style:'width: 80%',renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));}}),renderEmpty:'enyo.Control',initComponents:function(){this.setCollection(new Backbone.Collection());}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalRejectQuotation',myId:'modalRejectQuotation',bodyContent:{components:[{name:'labelRejectReason',style:'text-align: right; padding-right:10px; width: 40%; height: 40px; float: left;'},{style:'width: 50%; float: left;',kind:'OB.UI.ModalRejectQuotationRejectReason',name:'rejectReason'}]},i18nHeader:'OBPOS_RejectQuotation',bodyButtons:{components:[{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModalRejectQuotationAccept'},{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModalRejectQuotationCancel'}]},events:{onRejectQuotation:''},handlers:{onRejectQuotationDone:'doRejectQuotationDone'},doRejectQuotationDone:function(){this.doRejectQuotation({rejectReason:this.$.bodyContent.$.rejectReason.getValue()});},initComponents:function(){this.inherited(arguments);this.$.bodyContent.$.labelRejectReason.setContent(OB.I18N.getLabel('OBPOS_lblRejectReason'));var rejectReasonCollection=[];_.each(OB.MobileApp.model.get('rejectReasons'),function(reason){rejectReasonCollection.push(new Backbone.Model({id:reason.id,_identifier:reason._identifier}));});this.$.bodyContent.$.rejectReason.getCollection().reset(rejectReasonCollection);}});enyo.kind({kind:'OB.UI.Button',name:'OB.OBPOSPointOfSale.UI.Modals.btnModaContextChangedAccept',classes:'btnlink btnlink-gray modal-dialog-button',i18nContent:'OBMOBC_LblOk',events:{onHideThisPopup:''},tap:function(){OB.MobileApp.model.logout();}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalContextChanged',bodyContent:{},closeOnEscKey:false,autoDismiss:false,i18nHeader:'OBPOS_ContextChanged',bodyButtons:{components:[{initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_ContextChangedMessage'));}},{kind:'OB.OBPOSPointOfSale.UI.Modals.btnModaContextChangedAccept'}]}});enyo.kind({name:'OB.UI.ListValuesLineCheck',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check',style:'width: 86%; text-align: left; padding-left: 70px;',events:{onAddToSelected:''},tap:function(){this.inherited(arguments);var me=this;if(!this.parent.model.get('childrenSelected')){this.removeClass('half-active');}
this.doAddToSelected({value:me.parent.model,checked:!this.parent.model.get('checked'),selected:!this.parent.model.get('selected')});},create:function(){this.inherited(arguments);this.setContent(this.parent.model.get('name'));if(this.parent.model.get('selected')){this.addClass('active');}else{this.removeClass('active');if(this.parent.model.get('childrenSelected')){this.addClass('half-active');}}}});enyo.kind({name:'OB.UI.ListValuesLineChildren',kind:'OB.UI.Button',classes:'btn-icon-inspectTree',style:'width: 14%; margin: 0px; ',showing:false,childrenArray:[],events:{onSetCollection:''},create:function(){this.inherited(arguments);var me=this;OB.Dal.query(OB.Model.CharacteristicValue,"select distinct(id), name, characteristic_id from m_ch_value where parent = '"+this.parent.model.get('id')+"' order by UPPER(name) asc",[],function(dataValues,me){if(dataValues&&dataValues.length>0){me.childrenArray=dataValues.models;me.show();}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);},tap:function(){this.doSetCollection({value:this.childrenArray,parentValue:this.parent.model.get('id')});}});enyo.kind({name:'OB.UI.ListValuesLine',style:'border-bottom: 1px solid #cccccc',components:[{kind:'OB.UI.ListValuesLineCheck'},{kind:'OB.UI.ListValuesLineChildren'}]});enyo.kind({name:'OB.UI.ListValues',classes:'row-fluid',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction',onSetCollection:'setCollection'},components:[{classes:'span12',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'valueslistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.UI.ListValuesLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}]}],productCharacteristicValueFilterQualifier:'ProductCH_Filter',clearAction:function(inSender,inEvent){this.valuesList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,i,j,whereClause='',params=[],products=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.products,productCharacteristic=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.parent,forceRemote=false;productCharacteristic.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteriaCharacteristicsValue)&&!_.isUndefined(hqlFilter.forceRemote)){var hqlCriteriaFilter=hqlFilter.hqlCriteriaCharacteristicsValue();if(!_.isUndefined(hqlCriteriaFilter)){hqlCriteriaFilter.forEach(function(filter){if(filter&&forceRemote===false){forceRemote=hqlFilter.forceRemote;}});}}});if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)&&!forceRemote){var sql,productsIdsList;if(products.collection.length>0){productsIdsList="('";for(i=0;i<products.collection.length;i++){productsIdsList+=products.collection.models[i].id+"'";if(i<products.collection.length-1){productsIdsList+=",'";}}
productsIdsList+=")";}
if(products.collection.length>0){sql="select distinct(id), name, characteristic_id, parent from m_ch_value chv left join m_product_ch_value pchv on id=m_ch_value_id where parent = '"+this.parentValue+"' and characteristic_id = ? and m_product_id in "+productsIdsList+" "+whereClause+' order by UPPER(name) asc';}else{sql="select distinct(id), name, characteristic_id, parent from m_ch_value where parent = '"+this.parentValue+"' and characteristic_id = ?"+whereClause+' order by UPPER(name) asc';}
params.push(this.parent.parent.characteristic.get('characteristic'));OB.Dal.query(OB.Model.CharacteristicValue,sql,params,function(dataValues,me){if(dataValues&&dataValues.length>0){for(i=0;i<dataValues.length;i++){for(j=0;j<me.parent.parent.model.get('filter').length;j++){if(dataValues.models[i].get('id')===me.parent.parent.model.get('filter')[j].id){dataValues.models[i].set('checked',true);dataValues.models[i].set('selected',me.parent.parent.model.get('filter')[j].selected);break;}else{dataValues.models[i].set('checked',false);}
dataValues.models[i].set('childrenSelected',null);me.hasSelectedChildrenTree([dataValues.models[i]],dataValues.models[i]);}}
me.parent.parent.$.body.$.listValues.valuesList.reset(dataValues.models);}else{me.parent.parent.$.body.$.listValues.valuesList.reset();}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);return true;}else{var productFilterText,productcategory,productCharacteristicModel;productFilterText=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.productFilterText.getValue();productcategory=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.productcategory.getValue();productCharacteristicModel=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.parent.model;var remoteCriteria=[],brandparams=[],characteristic=[],characteristicValue=[];var productFilter={},criteria={},brandfilter={},chFilter={},characteristicValuefilter={},productText,characteristicfilter={columns:['characteristic_id'],operator:'equals',value:this.parent.parent.characteristic.get('id'),isId:true};if(products.collection.length>0){if(productCharacteristicModel.get('brandFilter').length>0){for(i=0;i<productCharacteristicModel.get('brandFilter').length;i++){brandparams.push(productCharacteristicModel.get('brandFilter')[i].id);}
if(brandparams.length>0){brandfilter={columns:[],operator:OB.Dal.FILTER,value:'BChV_Filter',params:[brandparams]};remoteCriteria.push(brandfilter);}}
if(productFilterText!==""||productcategory!=="__all__"){productFilter.columns=[];productFilter.operator=OB.Dal.FILTER;productFilter.value=this.productCharacteristicValueFilterQualifier;productText=(OB.MobileApp.model.hasPermission('OBPOS_remote.product'+OB.Dal.USESCONTAINS,true)?'%':'')+productFilterText+'%';productFilter.params=[productText,productcategory];remoteCriteria.push(productFilter);}
if(me.parent.parent.model.get('filter').length>0){for(i=0;i<me.parent.parent.model.get('filter').length;i++){if(!characteristic.includes(me.parent.parent.model.get('filter')[i].characteristic_id)){characteristic.push(me.parent.parent.model.get('filter')[i].characteristic_id);}}
for(i=0;i<characteristic.length;i++){for(j=0;j<me.parent.parent.model.get('filter').length;j++){if(characteristic[i]===me.parent.parent.model.get('filter')[j].characteristic_id){characteristicValue.push(me.parent.parent.model.get('filter')[j].id);}}
if(characteristicValue.length>0){chFilter={columns:[],operator:OB.Dal.FILTER,value:'Chv_Filter',filter:characteristic[i],params:[characteristicValue]};remoteCriteria.push(chFilter);characteristicValue=[];}}}
criteria.hqlCriteria=[];productCharacteristic.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteriaCharacteristicsValue)){var hqlCriteriaFilter=hqlFilter.hqlCriteriaCharacteristicsValue();if(!_.isUndefined(hqlCriteriaFilter)){hqlCriteriaFilter.forEach(function(filter){if(filter){remoteCriteria.push(filter);}});}}});}
remoteCriteria.push(characteristicfilter);criteria.remoteFilters=remoteCriteria;criteria.forceRemote=forceRemote;OB.Dal.find(OB.Model.CharacteristicValue,criteria,function(dataValues){if(dataValues&&dataValues.length>0){for(i=0;i<dataValues.length;i++){for(j=0;j<me.parent.parent.model.get('filter').length;j++){if(dataValues.models[i].get('id')===me.parent.parent.model.get('filter')[j].id){dataValues.models[i].set('checked',true);dataValues.models[i].set('selected',me.parent.parent.model.get('filter')[j].selected);break;}else{dataValues.models[i].set('checked',false);}
dataValues.models[i].set('childrenSelected',null);me.hasSelectedChildrenTree([dataValues.models[i]],dataValues.models[i]);}}
me.parent.parent.$.body.$.listValues.valuesList.reset(dataValues.models);}else{me.parent.parent.$.body.$.listValues.valuesList.reset();}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);return true;}},parentValue:0,setCollection:function(inSender,inEvent){var i,j,k;if(inEvent.parentValue!==0){this.parent.parent.$.header.$.modalProductChTopHeader.$.backChButton.addStyles('visibility: visible');}
this.parentValue=inEvent.parentValue;for(i=0;i<inEvent.value.length;i++){for(j=0;j<this.parent.parent.model.get('filter').length;j++){if(inEvent.value[i].get('id')===this.parent.parent.model.get('filter')[j].id){inEvent.value[i].set('checked',this.parent.parent.model.get('filter')[j].selected);inEvent.value[i].set('selected',this.parent.parent.model.get('filter')[j].selected);}}
for(k=0;k<this.parent.parent.selected.length;k++){if(inEvent.value[i].get('id')===this.parent.parent.selected[k].id){inEvent.value[i].set('checked',this.parent.parent.selected[k].get('checked'));inEvent.value[i].set('selected',this.parent.parent.selected[k].get('selected'));}}
inEvent.value[i].set('childrenSelected',null);this.hasSelectedChildrenTree([inEvent.value[i]],inEvent.value[i]);}
this.valuesList.reset(inEvent.value);},hasSelectedChildrenTree:function(selected,rootObject){var aux;for(aux=0;aux<selected.length;aux++){this.hasSelectedChildren(selected,aux,rootObject,this);}},hasSelectedChildren:function(selected,aux,rootObject,me){var j,k;me.exist=null;me.selected=selected;me.aux=aux;me.rootObject=rootObject;OB.Dal.query(OB.Model.CharacteristicValue,"select distinct(id), name, characteristic_id, parent "+"from m_ch_value where parent = '"+selected[aux].get('id')+"' order by UPPER(name) asc",[],function(dataValues,me){for(j=0;j<me.parent.parent.model.get('filter').length;j++){if(selected[aux].id===me.parent.parent.model.get('filter')[j].id&&selected[aux].id!==rootObject.id&&me.parent.parent.model.get('filter')[j].selected){me.exist=true;break;}}
for(k=0;k<me.parent.parent.selected.length;k++){if(selected[aux].id===me.parent.parent.selected[k].id&&selected[aux].id!==rootObject.id){me.exist=me.parent.parent.selected[k].get('selected');break;}}
if(_.isNull(rootObject.get('childrenSelected'))||!rootObject.get('childrenSelected')){rootObject.set('childrenSelected',me.exist);}
me.exist=null;if(dataValues&&dataValues.length>0){me.hasSelectedChildrenTree(dataValues.models,rootObject);}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);},valuesList:null,init:function(model){this.valuesList=new Backbone.Collection();this.$.valueslistitemprinter.setCollection(this.valuesList);}});enyo.kind({name:'OB.UI.ModalProductChTopHeader',kind:'OB.UI.ScrollableTableHeader',style:'',events:{onHideThisPopup:'',onSelectCharacteristicValue:'',onGetPrevCollection:''},components:[{style:'display: table;  width: 100%;',components:[{style:'display: table-cell; ',components:[{classes:'btnlink-gray',name:'backChButton',kind:'OB.UI.SmallButton',ontap:'backAction'}]},{style:'display: table-cell; width: 55%;',components:[{name:'title',style:'text-align: center; vertical-align: middle;'}]},{style:'display: table-cell; ',components:[{name:'doneChButton',kind:'OB.UI.SmallButton',ontap:'doneAction'}]},{style:'display: table-cell;',components:[{classes:'btnlink-gray',name:'cancelChButton',kind:'OB.UI.SmallButton',ontap:'cancelAction'}]}]}],initComponents:function(){this.inherited(arguments);this.$.backChButton.setContent(OB.I18N.getLabel('OBMOBC_LblBack'));this.$.backChButton.addStyles('visibility: hidden');this.$.doneChButton.setContent(OB.I18N.getLabel('OBMOBC_LblDone'));this.$.cancelChButton.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));this.selectedToSend=[];this.parent.parent.parent.selected=[];},backAction:function(){this.doGetPrevCollection();},doneAction:function(){var me=this;this.countingValues=this.countingValues+me.parent.parent.parent.selected.length;if(me.parent.parent.parent.selected.length>0){this.inspectTree(me.parent.parent.parent.selected);OB.UTIL.showLoading(true);}else{this.doHideThisPopup();}},cancelAction:function(){this.parent.parent.parent.selected=[];this.parent.parent.parent.countedValues=0;this.doHideThisPopup();},checkFinished:function(){var me=this;if(this.parent.parent.parent.countedValues===this.countingValues){this.doSelectCharacteristicValue({value:me.selectedToSend});this.parent.parent.parent.selected=[];this.selectedToSend=[];this.parent.parent.parent.countedValues=0;this.countingValues=0;OB.UTIL.showLoading(false);this.doHideThisPopup();}},countingValues:0,inspectTree:function(selected,checkedParent){var aux;for(aux=0;aux<selected.length;aux++){this.getChildren(selected,aux,checkedParent,this);}},getChildren:function(selected,aux,checkedParent,me){OB.Dal.query(OB.Model.CharacteristicValue,"select distinct(id), name, characteristic_id, parent "+"from m_ch_value where parent = '"+selected[aux].get('id')+"' order by UPPER(name) asc",[],function(dataValues,me){var index;if(dataValues&&dataValues.length>0){if(!_.isUndefined(checkedParent)){selected[aux].set('checked',checkedParent);}
index=me.selectedToSend.map(function(e){return e.id;}).indexOf(selected[aux].id);if(index===-1){me.selectedToSend.push(selected[aux]);}else if(!_.isNull(selected[aux].get('selected'))&&!_.isUndefined(selected[aux].get('selected'))){me.selectedToSend[index]=selected[aux];}
if(!_.isUndefined(checkedParent)){me.inspectTree(dataValues.models,checkedParent);}else{me.inspectTree(dataValues.models,selected[aux].get('checked'));}}else{if(!_.isUndefined(checkedParent)){selected[aux].set('checked',checkedParent);}
index=me.selectedToSend.map(function(e){return e.id;}).indexOf(selected[aux].id);if(index===-1){me.selectedToSend.push(selected[aux]);}else if(!_.isNull(selected[aux].get('selected'))&&!_.isUndefined(selected[aux].get('selected'))){me.selectedToSend[index]=selected[aux];}
me.countingValues++;me.checkFinished();}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);}});enyo.kind({name:'OB.UI.ModalProductCharacteristic',topPosition:'170px',kind:'OB.UI.Modal',published:{characteristic:null,selected:[]},events:{onAddToSelected:''},handlers:{onAddToSelected:'addToSelected',onGetPrevCollection:'getPrevCollection'},executeOnShow:function(){var i,j;this.$.body.$.listValues.parentValue=0;this.$.header.parent.addStyles('padding: 0px; border-bottom: 1px solid #cccccc');this.$.header.$.modalProductChTopHeader.$.backChButton.addStyles('visibility: hidden');this.characteristic=this.args.model;this.$.header.$.modalProductChTopHeader.$.title.setContent(this.args.model.get('_identifier'));this.waterfall('onSearchAction');},i18nHeader:'',body:{kind:'OB.UI.ListValues'},initComponents:function(){this.inherited(arguments);this.$.closebutton.hide();this.$.header.createComponent({kind:'OB.UI.ModalProductChTopHeader',style:'border-bottom: 0px'});},addToSelected:function(inSender,inEvent){var index=this.selected.map(function(e){return e.get('id');}).indexOf(inEvent.value.get('id'));if(!inEvent.checked){inEvent.value.set('childrenSelected',false);this.inspectDeselectTree([inEvent.value],inEvent.value);}
if(index!==-1){inEvent.value.set('checked',inEvent.checked);inEvent.value.set('selected',inEvent.selected);this.selected[index].set('checked',inEvent.checked);this.selected[index].set('selected',inEvent.selected);}else{inEvent.value.set('checked',inEvent.checked);inEvent.value.set('selected',inEvent.selected);this.selected.push(inEvent.value);this.inspectCountTree([inEvent.value]);this.countedValues++;}},getPrevCollection:function(inSender,inEvent){var me=this,i,j,k;OB.Dal.query(OB.Model.CharacteristicValue,"select distinct(id) , name , characteristic_id, parent as parent from m_ch_value "+"where parent = (select parent from m_ch_value where id = '"+this.$.body.$.listValues.parentValue+"') and "+"characteristic_id = (select characteristic_id from m_ch_value where id = '"+this.$.body.$.listValues.parentValue+"') order by UPPER(name) asc",[],function(dataValues,me){if(dataValues&&dataValues.length>0){for(i=0;i<dataValues.length;i++){for(j=0;j<me.model.get('filter').length;j++){if(dataValues.models[i].get('id')===me.model.get('filter')[j].id){dataValues.models[i].set('checked',me.model.get('filter')[j].checked);dataValues.models[i].set('selected',me.model.get('filter')[j].selected);}}
for(k=0;k<me.selected.length;k++){if(dataValues.models[i].get('id')===me.selected[k].id){dataValues.models[i].set('checked',me.selected[k].get('checked'));dataValues.models[i].set('selected',me.selected[k].get('selected'));}}
dataValues.models[i].set('childrenSelected',null);me.$.body.$.listValues.hasSelectedChildrenTree([dataValues.models[i]],dataValues.models[i]);}
me.$.body.$.listValues.valuesList.reset(dataValues.models);me.$.body.$.listValues.parentValue=dataValues.models[0].get('parent');if(me.$.body.$.listValues.parentValue==='0'){me.$.header.$.modalProductChTopHeader.$.backChButton.addStyles('visibility: hidden');}}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);},countedValues:0,inspectCountTree:function(selected){var aux;for(aux=0;aux<selected.length;aux++){this.countChildren(selected,aux,this);}},countChildren:function(selected,aux,me){OB.Dal.query(OB.Model.CharacteristicValue,"select distinct(id), name, characteristic_id, parent "+"from m_ch_value where parent = '"+selected[aux].get('id')+"'  order by UPPER(name) asc",[],function(dataValues,me){if(dataValues&&dataValues.length>0){me.inspectCountTree(dataValues.models);}else{me.countedValues++;}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);},inspectDeselectTree:function(selected,rootObject){var aux;for(aux=0;aux<selected.length;aux++){this.deselectChildren(selected,aux,rootObject,this);}},deselectChildren:function(selected,aux,rootObject,me){OB.Dal.query(OB.Model.CharacteristicValue,"select distinct(id), name, characteristic_id, parent "+"from m_ch_value where parent = '"+selected[aux].get('id')+"' order by UPPER(name) asc",[],function(dataValues,me){var index=me.selected.map(function(e){return e.id;}).indexOf(selected[aux].id);if(!rootObject.get('selected')&&rootObject.get('id')!==selected[aux].get('id')){selected[aux].set('selected',rootObject.get('selected'));if(index===-1){me.doAddToSelected({value:selected[aux],checked:selected[aux].get('checked'),selected:selected[aux].get('selected')});}else{me.selected[index]=selected[aux];}}
if(dataValues&&dataValues.length>0){me.inspectDeselectTree(dataValues.models,rootObject);}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);},init:function(model){this.model=model;this.waterfall('onSetModel',{model:this.model});}});enyo.kind({name:'OB.UI.ListBrandsLine',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check',style:'border-bottom: 1px solid #cccccc;text-align: left; padding-left: 70px;',events:{onHideThisPopup:''},tap:function(){this.inherited(arguments);this.model.set('checked',!this.model.get('checked'));},create:function(){this.inherited(arguments);this.setContent(this.model.get('name'));if(this.model.get('checked')){this.addClass('active');}else{this.removeClass('active');}}});enyo.kind({name:'OB.UI.ListBrands',classes:'row-fluid',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},components:[{classes:'span12',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'brandslistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.UI.ListBrandsLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}]}],brandValueFilterQualifier:'PBrand_Filter',clearAction:function(inSender,inEvent){this.brandsList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,i,j;function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBrands(dataBrands){if(dataBrands&&dataBrands.length>0){for(i=0;i<dataBrands.length;i++){for(j=0;j<me.parent.parent.model.get('brandFilter').length;j++){if(dataBrands.models[i].get('id')===me.parent.parent.model.get('brandFilter')[j].id){dataBrands.models[i].set('checked',true);}}}
me.brandsList.reset(dataBrands.models);}else{me.brandsList.reset();}}
var criteria={'_orderBy':[{'column':'name','asc':true}]};var products=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.products;var forceRemote=false;var productCharacteristic=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.parent;productCharacteristic.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteriaBrand)&&!_.isUndefined(hqlFilter.forceRemote)){var hqlCriteriaFilter=hqlFilter.hqlCriteriaBrand();hqlCriteriaFilter.forEach(function(filter){if(filter!==""&&forceRemote===false){forceRemote=hqlFilter.forceRemote;}});}});if(!OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)&&!forceRemote){if(products.collection.length>0){var productsIdsList="('";for(i=0;i<products.collection.length;i++){productsIdsList+=products.collection.models[i].id+"'";if(i<products.collection.length-1){productsIdsList+=",'";}}
productsIdsList+=")";OB.Dal.query(OB.Model.Brand,"select distinct(b.m_product_id),b.name,b._identifier,b._filter,b._idx from m_brand b left join m_product p on p.brand=b.m_product_id where p.m_product_id in "+productsIdsList+" order by UPPER(name) asc",null,successCallbackBrands,errorCallback,this);}else{OB.Dal.find(OB.Model.Brand,criteria,successCallbackBrands,errorCallback);}}else{var productFilterText=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.productFilterText.getValue();var productcategory=inSender.parent.parent.$.multiColumn.$.rightPanel.$.toolbarpane.$.searchCharacteristic.$.searchCharacteristicTabContent.$.searchProductCharacteristicHeader.$.productcategory.getValue();var remoteCriteria=[],characteristicValue=[],characteristic=[],brandfilter={},chFilter={},productText;criteria={};if(products.collection.length>0){if(productFilterText!==""||productcategory!=="__all__"){brandfilter.columns=[];brandfilter.operator=OB.Dal.FILTER;brandfilter.value=this.brandValueFilterQualifier;productText=(OB.MobileApp.model.hasPermission('OBPOS_remote.product'+OB.Dal.USESCONTAINS,true)?'%':'')+productFilterText+'%';brandfilter.params=[productText,productcategory];remoteCriteria.push(brandfilter);}}
if(me.parent.parent.model.get('filter').length>0){for(i=0;i<me.parent.parent.model.get('filter').length;i++){if(!characteristic.includes(me.parent.parent.model.get('filter')[i].characteristic_id)){characteristic.push(me.parent.parent.model.get('filter')[i].characteristic_id);}}
for(i=0;i<characteristic.length;i++){for(j=0;j<me.parent.parent.model.get('filter').length;j++){if(characteristic[i]===me.parent.parent.model.get('filter')[j].characteristic_id){characteristicValue.push(me.parent.parent.model.get('filter')[j].id);}}
if(characteristicValue.length>0){chFilter={columns:[],operator:OB.Dal.FILTER,value:'BFilterByCH_Filter',filter:characteristic[i],params:[characteristicValue]};remoteCriteria.push(chFilter);characteristicValue=[];}}}
criteria.hqlCriteria=[];productCharacteristic.customFilters.forEach(function(hqlFilter){if(!_.isUndefined(hqlFilter.hqlCriteriaBrand)){var hqlCriteriaFilter=hqlFilter.hqlCriteriaBrand();if(!_.isUndefined(hqlCriteriaFilter)){hqlCriteriaFilter.forEach(function(filter){if(filter){remoteCriteria.push(filter);}});}}});criteria.remoteFilters=remoteCriteria;criteria.forceRemote=forceRemote;OB.Dal.find(OB.Model.Brand,criteria,successCallbackBrands,errorCallback);}
return true;},brandsList:null,init:function(model){this.brandsList=new Backbone.Collection();this.$.brandslistitemprinter.setCollection(this.brandsList);}});enyo.kind({name:'OB.UI.ModalProductBrandTopHeader',kind:'OB.UI.ScrollableTableHeader',events:{onHideThisPopup:'',onSelectBrand:'',onSearchAction:''},components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{name:'title',style:'text-align: center; vertical-align: middle'}]},{style:'display: table-cell;',components:[{name:'doneBrandButton',kind:'OB.UI.SmallButton',ontap:'doneAction'}]},{style:'display: table-cell;',components:[{classes:'btnlink-gray',name:'cancelBrandButton',kind:'OB.UI.SmallButton',ontap:'cancelAction'}]}]}],initComponents:function(){this.inherited(arguments);this.$.doneBrandButton.setContent(OB.I18N.getLabel('OBMOBC_LblDone'));this.$.cancelBrandButton.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));},doneAction:function(){var selectedBrands=_.compact(this.parent.parent.parent.$.body.$.listBrands.brandsList.map(function(e){return e;}));this.doSelectBrand({value:selectedBrands});this.doHideThisPopup();},cancelAction:function(){this.doHideThisPopup();}});enyo.kind({name:'OB.UI.ModalProductBrand',topPosition:'170px',kind:'OB.UI.Modal',published:{characteristic:null},executeOnShow:function(){var i,j;this.$.header.parent.addStyles('padding: 0px; border-bottom: 1px solid #cccccc');this.$.header.$.modalProductBrandTopHeader.$.title.setContent(OB.I18N.getLabel('OBMOBC_LblBrand'));this.waterfall('onSearchAction');},i18nHeader:'',body:{kind:'OB.UI.ListBrands'},initComponents:function(){this.inherited(arguments);this.$.closebutton.hide();this.$.header.createComponent({kind:'OB.UI.ModalProductBrandTopHeader',style:'border-bottom: 0px'});},init:function(model){this.model=model;this.waterfall('onSetModel',{model:this.model});}});(function(){var PriceList=OB.Data.ExtensibleModel.extend({modelName:'PriceList',tableName:'m_pricelist',entityName:'PriceList',source:'org.openbravo.retail.posterminal.master.PriceList',includeTerminalDate:true});PriceList.addProperties([{name:'m_pricelist_id',column:'m_pricelist_id',primaryKey:true,type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'priceIncludesTax',column:'priceIncludesTax',type:'TEXT'},{name:'c_currency_id',column:'c_currency_id',type:'TEXT'}]);PriceList.addIndex([{name:'obpos_price_list',columns:[{name:'name',sort:'asc'}]}]);OB.Data.Registry.registerModel(PriceList);}());(function(){var ProductCategory=OB.Data.ExtensibleModel.extend({modelName:'ProductCategory',tableName:'m_product_category',entityName:'ProductCategory',source:'org.openbravo.retail.posterminal.master.Category',dataLimit:OB.Dal.DATALIMIT,includeTerminalDate:true,createBestSellerCategory:function(){this.set('id','OBPOS_bestsellercategory');this.set('searchKey','bestseller');this.set('name',OB.I18N.getLabel('OBPOS_bestSellerCategory'));this.set('img','iconBestSellers');this.set('_identifier',this.get('name'));}});ProductCategory.addProperties([{name:'id',column:'m_product_category_id',primaryKey:true,type:'TEXT'},{name:'searchKey',column:'value',type:'TEXT'},{name:'name',column:'name',type:'TEXT'},{name:'img',column:'ad_image_id',type:'TEXT'},{name:'_identifier',column:'_identifier',type:'TEXT'}]);OB.Data.Registry.registerModel(ProductCategory);}());(function(){var Product=OB.Data.ExtensibleModel.extend({modelName:'Product',tableName:'m_product',entityName:'Product',source:'org.openbravo.retail.posterminal.master.Product',dataLimit:OB.Dal.DATALIMIT,includeTerminalDate:true,remote:'OBPOS_remote.product',initialize:function(){this.set('originalStandardPrice',this.get('standardPrice'));}});Product.addProperties([{name:'id',column:'m_product_id',primaryKey:true,type:'TEXT'},{name:'searchkey',column:'searchkey',filter:true,type:'TEXT'},{name:'uPCEAN',column:'upc',filter:true,type:'TEXT'},{name:'uOM',column:'c_uom_id',type:'TEXT'},{name:'uOMsymbol',column:'c_uom_symbol',type:'TEXT'},{name:'productCategory',column:'m_product_category_id',type:'TEXT'},{name:'taxCategory',column:'c_taxcategory_id',type:'TEXT'},{name:'img',column:'img',type:'TEXT'},{name:'description',column:'description',type:'TEXT'},{name:'obposScale',column:'em_obpos_scale',type:'TEXT'},{name:'groupProduct',column:'em_obpos_groupedproduct',type:'TEXT'},{name:'stocked',column:'stocked',type:'TEXT'},{name:'showstock',column:'em_obpos_showstock',type:'TEXT'},{name:'isGeneric',column:'isGeneric',type:'TEXT'},{name:'generic_product_id',column:'generic_product_id',type:'TEXT'},{name:'brand',column:'brand',type:'TEXT'},{name:'characteristicDescription',column:'characteristicDescription',type:'TEXT'},{name:'showchdesc',column:'showchdesc',type:'TEXT'},{name:'bestseller',column:'bestseller',type:'TEXT'},{name:'ispack',column:'ispack',type:'TEXT'},{name:'listPrice',column:'listPrice',type:'NUMERIC'},{name:'standardPrice',column:'standardPrice',type:'NUMERIC'},{name:'priceLimit',column:'priceLimit',type:'NUMERIC'},{name:'cost',column:'cost',type:'NUMERIC'},{name:'algorithm',column:'algorithm',type:'TEXT'},{name:'_identifier',column:'_identifier',filter:true,type:'TEXT'},{name:'currentStandardPrice',column:'currentStandardPrice',type:'NUMERIC'},{name:'productType',column:'productType',type:'TEXT'},{name:'includeProductCategories',column:'includeProductCategories',type:'TEXT'},{name:'includeProducts',column:'includeProducts',type:'TEXT'},{name:'printDescription',column:'printDescription',type:'BOOL'},{name:'oBPOSAllowAnonymousSale',column:'oBPOSAllowAnonymousSale',type:'BOOL'},{name:'returnable',column:'returnable',type:'BOOL'},{name:'overdueReturnDays',column:'overdueReturnDays',type:'NUMBER'},{name:'isPriceRuleBased',column:'isPriceRuleBased',type:'BOOL'},{name:'proposalType',column:'proposalType',type:'TEXT'},{name:'availableForMultiline',column:'availableForMultiline',type:'TEXT'},{name:'isLinkedToProduct',column:'isLinkedToProduct',type:'BOOL'},{name:'allowDeferredSell',column:'allowDeferredSell',type:'BOOL'},{name:'deferredSellMaxDays',column:'deferredSellMaxDays',type:'NUMBER'},{name:'quantityRule',column:'quantityRule',type:'TEXT'},{name:'isPrintServices',column:'isPrintServices',type:'BOOL'}]);Product.addIndex([{name:'obpos_in_prodCat',columns:[{name:'m_product_category_id',sort:'desc'}]},{name:'obpos_in_bestseller',columns:[{name:'bestseller',sort:'asc'}]},{name:'obpos_in_upc',columns:[{name:'upc',sort:'asc'}]},{name:'obpos_in_productType',columns:[{name:'productType',sort:'asc'}]}]);OB.Data.Registry.registerModel(Product);}());(function(){var ProductPrice=OB.Data.ExtensibleModel.extend({modelName:'ProductPrice',tableName:'m_productprice',entityName:'ProductPrice',source:'org.openbravo.retail.posterminal.master.ProductPrice',includeTerminalDate:true,remote:'OBPOS_remote.product'});ProductPrice.addProperties([{name:'m_productprice_id',column:'m_productprice_id',primaryKey:true,type:'TEXT'},{name:'m_pricelist_id',column:'m_pricelist_id',type:'TEXT'},{name:'m_product_id',column:'m_product_id',type:'TEXT'},{name:'pricelist',column:'pricelist',type:'NUMERIC'},{name:'pricestd',column:'pricestd',type:'NUMERIC'},{name:'pricelimit',column:'pricelimit',type:'NUMERIC'}]);ProductPrice.addIndex([{name:'obpos_product_price_list',columns:[{name:'m_pricelist_id',sort:'desc'},{name:'m_product_id',sort:'desc'}]}]);OB.Data.Registry.registerModel(ProductPrice);}());(function(){var OfferPriceList=OB.Data.ExtensibleModel.extend({modelName:'OfferPriceList',tableName:'m_offer_pricelist',entityName:'OfferPriceList',source:'org.openbravo.retail.posterminal.master.OfferPriceList',includeTerminalDate:true});OfferPriceList.addProperties([{name:'m_offer_pricelist_id',column:'m_offer_pricelist_id',primaryKey:true,type:'TEXT'},{name:'m_offer_id',column:'m_offer_id',type:'TEXT'},{name:'m_pricelist_id',column:'m_pricelist_id',type:'TEXT'}]);OfferPriceList.addIndex([{name:'m_offer_pricelist_indx',columns:[{name:'m_offer_id',sort:'desc'},{name:'m_pricelist_id',sort:'desc'}]}]);OB.Data.Registry.registerModel(OfferPriceList);}());(function(){var ServiceProduct=OB.Data.ExtensibleModel.extend({modelName:'ServiceProduct',tableName:'m_product_service',entityName:'ServiceProduct',source:'org.openbravo.retail.posterminal.master.ServiceProduct',dataLimit:100,includeTerminalDate:true,remote:'OBPOS_remote.product'});ServiceProduct.addProperties([{name:'id',column:'m_product_service_id',primaryKey:true,type:'TEXT'},{name:'service',column:'m_product_id',type:'TEXT'},{name:'relatedProduct',column:'m_related_product_id',type:'TEXT'}]);ServiceProduct.addIndex([{name:'obpos_serviceprod_service',columns:[{name:'m_product_id',sort:'asc'}]},{name:'obpos_serviceprod_product',columns:[{name:'m_related_product_id',sort:'asc'}]}]);OB.Data.Registry.registerModel(ServiceProduct);}());(function(){var ServiceProductCategory=OB.Data.ExtensibleModel.extend({modelName:'ServiceProductCategory',tableName:'m_product_category_service',entityName:'ServiceProductCategory',source:'org.openbravo.retail.posterminal.master.ServiceProductCategory',dataLimit:100,includeTerminalDate:true,remote:'OBPOS_remote.product'});ServiceProductCategory.addProperties([{name:'id',column:'m_product_category_service_id',primaryKey:true,type:'TEXT'},{name:'service',column:'m_product_id',type:'TEXT'},{name:'relatedCategory',column:'m_product_category_id',type:'TEXT'}]);ServiceProductCategory.addIndex([{name:'obpos_servicecat_service',columns:[{name:'m_product_id',sort:'asc'}]},{name:'obpos_servicecat_category',columns:[{name:'m_product_category_id',sort:'asc'}]}]);OB.Data.Registry.registerModel(ServiceProductCategory);}());(function(){var BusinessPartner=OB.Data.ExtensibleModel.extend({modelName:'BusinessPartner',tableName:'c_bpartner',entityName:'BusinessPartner',source:'org.openbravo.retail.posterminal.master.BusinessPartner',dataLimit:OB.Dal.DATALIMIT,remote:'OBPOS_remote.customer',saveCustomer:function(silent){var nameLength,newSk;if(!this.get("name")){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_BPartnerNameRequired'));return false;}
if(!this.get('locName')){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_BPartnerAddressRequired'));return false;}
if(!this.get("locId")){this.set('locId',OB.UTIL.get_UUID());}
if(!this.get("contactId")){this.set('contactId',OB.UTIL.get_UUID());}
if(!this.get('searchKey')){nameLength=this.get('name').toString().length;newSk=this.get('name');if(nameLength>30){newSk=this.get('name').substring(0,30);}
this.set('searchKey',newSk);}
this.set('_identifier',this.get('name'));this.trigger('customerSaved');return true;},loadById:function(CusId,userCallback){var me=this;OB.Dal.get(OB.Model.BusinessPartner,CusId,function(customerCol){if(!customerCol||customerCol.length===0){me.clearModelWith(null);userCallback(me);}else{OB.Dal.get(OB.Model.BPLocation,customerCol.get('locId'),function(location){customerCol.set('locationModel',location);me.clearModelWith(customerCol);userCallback(me);});}});},loadByModel:function(cusToLoad){},newCustomer:function(){this.trigger('beforeChangeCustomerForNewOne',this);this.clearModelWith(null);},clearModelWith:function(cusToLoad){var me=this,undf;if(cusToLoad===null){OB.UTIL.clone(new OB.Model.BusinessPartner(),this);this.set('paymentMethod',OB.MobileApp.model.get('terminal').defaultbp_paymentmethod);this.set('businessPartnerCategory',OB.MobileApp.model.get('terminal').defaultbp_bpcategory);this.set('businessPartnerCategory_name',OB.MobileApp.model.get('terminal').defaultbp_bpcategory_name);this.set('paymentTerms',OB.MobileApp.model.get('terminal').defaultbp_paymentterm);this.set('invoiceTerms',OB.MobileApp.model.get('terminal').defaultbp_invoiceterm);this.set('priceList',OB.MobileApp.model.get('pricelist').id);this.set('country',OB.MobileApp.model.get('terminal').defaultbp_bpcountry);this.set('countryName',OB.MobileApp.model.get('terminal').defaultbp_bpcountry_name);this.set('client',OB.MobileApp.model.get('terminal').client);this.set('organization',OB.MobileApp.model.get('terminal').defaultbp_bporg);this.set('creditLimit',OB.DEC.Zero);this.set('creditUsed',OB.DEC.Zero);}else{OB.UTIL.clone(cusToLoad,this);}},loadByJSON:function(obj){var me=this,undf;_.each(_.keys(me.attributes),function(key){if(obj[key]!==undf){if(obj[key]===null){me.set(key,null);}else{me.set(key,obj[key]);}}});},serializeToJSON:function(){return JSON.parse(JSON.stringify(this.toJSON()));}});BusinessPartner.addProperties([{name:'id',column:'c_bpartner_id',primaryKey:true,type:'TEXT'},{name:'organization',column:'ad_org_id',type:'TEXT'},{name:'searchKey',column:'value',filter:true,type:'TEXT'},{name:'_identifier',column:'_identifier',filter:true,type:'NUMERIC'},{name:'name',column:'name',type:'TEXT'},{name:'firstName',column:'first_name',type:'TEXT'},{name:'lastName',column:'last_name',type:'TEXT'},{name:'description',column:'description',type:'TEXT'},{name:'taxID',column:'taxID',filter:true,skipremote:true,type:'TEXT'},{name:'taxCategory',column:'so_bp_taxcategory_id',type:'TEXT'},{name:'paymentMethod',column:'FIN_Paymentmethod_ID',type:'TEXT'},{name:'paymentTerms',column:'c_paymentterm_id',type:'TEXT'},{name:'priceList',column:'m_pricelist_id',type:'TEXT '},{name:'invoiceTerms',column:'invoicerule',type:'TEXT'},{name:'locId',column:'c_bpartnerlocation_id',type:'TEXT'},{name:'locName',column:'c_bpartnerlocation_name',filter:true,skipremote:true,type:'TEXT'},{name:'postalCode',column:'postalCode',type:'TEXT'},{name:'cityName',column:'cityName',type:'TEXT'},{name:'countryName',column:'countryName',type:'TEXT'},{name:'contactId',column:'ad_user_id',type:'TEXT'},{name:'phone',column:'phone',filter:true,skipremote:true,type:'TEXT'},{name:'email',column:'email',filter:true,skipremote:true,type:'TEXT'},{name:'businessPartnerCategory',column:'c_bp_group_id',type:'TEXT'},{name:'businessPartnerCategory_name',column:'c_bp_group_name',type:'TEXT'},{name:'creditLimit',column:'creditLimit',type:'NUMERIC'},{name:'creditUsed',column:'creditUsed',type:'NUMERIC'},{name:'taxExempt',column:'taxExempt',type:'TEXT'},{name:'customerBlocking',column:'customerBlocking',type:'TEXT'},{name:'salesOrderBlocking',column:'salesOrderBlocking',type:'TEXT'},{name:'priceIncludesTax',column:'priceIncludesTax',type:'TEXT'},{name:'priceListName',column:'priceListName',type:'TEXT'}]);BusinessPartner.addIndex([{name:'bp_filter_idx',columns:[{name:'_filter',sort:'desc'}]},{name:'bp_name_idx',columns:[{name:'name',sort:'desc'}]}]);OB.Data.Registry.registerModel(BusinessPartner);}());(function(){var DocumentSequence=Backbone.Model.extend({modelName:'DocumentSequence',tableName:'c_document_sequence',entityName:'',source:'',local:true,properties:['id','posSearchKey','documentSequence','quotationDocumentSequence'],propertyMap:{'id':'c_document_sequence_id','posSearchKey':'pos_search_key','documentSequence':'document_sequence','quotationDocumentSequence':'quotation_document_sequence'},defaults:{documentSequence:0,quotationDocumentSequence:0},createStatement:'CREATE TABLE IF NOT EXISTS c_document_sequence (c_document_sequence_id TEXT PRIMARY KEY, pos_search_key TEXT NOT NULL UNIQUE, document_sequence NUMBER, quotation_document_sequence NUMBER)',dropStatement:'DROP TABLE IF EXISTS c_document_sequence',insertStatement:'INSERT INTO c_document_sequence(c_document_sequence_id, pos_search_key, document_sequence, quotation_document_sequence) VALUES (?,?,?,?)'});OB.Data.Registry.registerModel(DocumentSequence);}());(function(){var taxRate=OB.Data.ExtensibleModel.extend({modelName:'TaxRate',generatedStructure:true,entityName:'FinancialMgmtTaxRate',source:'org.openbravo.retail.posterminal.master.TaxRate'});OB.Data.Registry.registerModel(taxRate);}());(function(){var taxZone=OB.Data.ExtensibleModel.extend({modelName:'TaxZone',tableName:'c_tax_zone',entityName:'FinancialMgmtTaxZone',source:'org.openbravo.retail.posterminal.master.TaxZone'});taxZone.addProperties([{name:'id',column:'c_tax_zone_id',primaryKey:true,type:'TEXT'},{name:'tax',column:'c_tax_id',filter:true,type:'TEXT'},{name:'fromCountry',column:'from_country_id',filter:true,type:'TEXT'},{name:'fromRegion',column:'from_region_id',type:'TEXT'},{name:'destinationCountry',column:'to_country_id',type:'TEXT'},{name:'destinationRegion',column:'to_region_id',type:'TEXT'}]);taxZone.addIndex([{name:'obpos_in_taxZone',columns:[{name:'c_tax_id',sort:'asc'}]}]);OB.Data.Registry.registerModel(taxZone);}());(function(){var promotions=Backbone.Model.extend({modelName:'Discount',generatedStructure:true,entityName:'PricingAdjustment',source:'org.openbravo.retail.posterminal.master.Discount'});var promotionsBP=Backbone.Model.extend({modelName:'DiscountFilterBusinessPartner',generatedStructure:true,entityName:'PricingAdjustmentBusinessPartner',source:'org.openbravo.retail.posterminal.master.DiscountFilterBusinessPartner',remote:'OBPOS_remote.discount.bp'});var promotionsBPCategory=Backbone.Model.extend({modelName:'DiscountFilterBusinessPartnerGroup',generatedStructure:true,entityName:'PricingAdjustmentBusinessPartnerGroup',source:'org.openbravo.retail.posterminal.master.DiscountFilterBusinessPartnerGroup'});var promotionsProduct=Backbone.Model.extend({modelName:'DiscountFilterProduct',generatedStructure:true,entityName:'PricingAdjustmentProduct',source:'org.openbravo.retail.posterminal.master.DiscountFilterProduct'});var promotionsProductCategory=Backbone.Model.extend({modelName:'DiscountFilterProductCategory',generatedStructure:true,entityName:'PricingAdjustmentProductCategory',source:'org.openbravo.retail.posterminal.master.DiscountFilterProductCategory'});var promotionsRole=Backbone.Model.extend({modelName:'DiscountFilterRole',generatedStructure:true,entityName:'OBDISC_Offer_Role',source:'org.openbravo.retail.posterminal.master.DiscountFilterRole'});var promotionsCharacteristics=Backbone.Model.extend({modelName:'DiscountFilterCharacteristic',generatedStructure:true,entityName:'PricingAdjustmentCharacteristic',source:'org.openbravo.retail.posterminal.master.DiscountFilterCharacteristic'});OB.Data.Registry.registerModel(promotions);OB.Data.Registry.registerModel(promotionsBP);OB.Data.Registry.registerModel(promotionsBPCategory);OB.Data.Registry.registerModel(promotionsProduct);OB.Data.Registry.registerModel(promotionsProductCategory);OB.Data.Registry.registerModel(promotionsRole);OB.Data.Registry.registerModel(promotionsCharacteristics);}());(function(){var ServicePriceRule=OB.Data.ExtensibleModel.extend({modelName:'ServicePriceRule',tableName:'m_servicepricerule',entityName:'ServicePriceRule',source:'org.openbravo.retail.posterminal.master.ServicePriceRule',dataLimit:100,includeTerminalDate:true,remote:'OBPOS_remote.product'});ServicePriceRule.addProperties([{name:'id',column:'m_servicepricerule_id',primaryKey:true,type:'TEXT'},{name:'active',column:'active',type:'BOOL'},{name:'afterdiscounts',column:'afterdiscounts',type:'BOOL'},{name:'percentage',column:'percentage',type:'NUMBER'},{name:'ruletype',column:'ruletype',type:'TEXT'}]);OB.Data.Registry.registerModel(ServicePriceRule);}());(function(){var ServicePriceRuleRange=OB.Data.ExtensibleModel.extend({modelName:'ServicePriceRuleRange',tableName:'m_servicepricerule_range',entityName:'ServicePriceRuleRange',source:'org.openbravo.retail.posterminal.master.ServicePriceRuleRange',dataLimit:100,includeTerminalDate:true,remote:'OBPOS_remote.product'});ServicePriceRuleRange.addProperties([{name:'id',column:'m_servicepricerule_range_id',primaryKey:true,type:'TEXT'},{name:'active',column:'active',type:'BOOL'},{name:'afterdiscounts',column:'afterdiscounts',type:'BOOL'},{name:'amountUpTo',column:'amountUpTo',type:'NUMBER'},{name:'percentage',column:'percentage',type:'NUMBER'},{name:'priceList',column:'priceList',type:'TEXT'},{name:'ruleType',column:'ruleType',type:'TEXT'},{name:'servicepricerule',column:'servicepricerule',type:'TEXT'}]);OB.Data.Registry.registerModel(ServicePriceRuleRange);}());(function(){var ServicePriceRuleRangePrices=OB.Data.ExtensibleModel.extend({modelName:'ServicePriceRuleRangePrices',tableName:'m_servicepricerule_rangeprices',entityName:'ServicePriceRuleRangePrices',source:'org.openbravo.retail.posterminal.master.ServicePriceRuleRangePrices',dataLimit:100,includeTerminalDate:true,remote:'OBPOS_remote.product'});ServicePriceRuleRangePrices.addProperties([{name:'id',column:'id',primaryKey:true,type:'TEXT'},{name:'priceList',column:'priceList',type:'TEXT'},{name:'product',column:'product',type:'TEXT'},{name:'listPrice',column:'listPrice',type:'NUMBER'}]);OB.Data.Registry.registerModel(ServicePriceRuleRangePrices);}());(function(){var ServicePriceRuleVersion=OB.Data.ExtensibleModel.extend({modelName:'ServicePriceRuleVersion',tableName:'m_servicepricerule_version',entityName:'ServicePriceRuleVersion',source:'org.openbravo.retail.posterminal.master.ServicePriceRuleVersion',dataLimit:100,includeTerminalDate:true,remote:'OBPOS_remote.product'});ServicePriceRuleVersion.addProperties([{name:'id',column:'m_servicepricerule_version_id',primaryKey:true,type:'TEXT'},{name:'active',column:'active',type:'BOOL'},{name:'product',column:'product',type:'TEXT'},{name:'validFromDate',column:'validFromDate',type:'TEXT'},{name:'servicePriceRule',column:'servicePriceRule',type:'TEXT'}]);OB.Data.Registry.registerModel(ServicePriceRuleVersion);}());OB.Data.Registry.registerModel(Backbone.Model.extend({modelName:'Supervisor',tableName:'supervisor',entityName:'Supervisor',properties:['id','name','password','permissions','created','_identifier','_idx'],propertyMap:{'id':'supervisor_id','name':'name','password':'password','permissions':'permissions','created':'created','_identifier':'_identifier','_idx':'_idx'},createStatement:'CREATE TABLE IF NOT EXISTS supervisor (supervisor_id TEXT PRIMARY KEY , name TEXT , password TEXT , permissions TEXT, created TEXT, _identifier TEXT , _idx NUMERIC)',dropStatement:'DROP TABLE IF EXISTS supervisor',insertStatement:'INSERT INTO supervisor(supervisor_id, name, password, permissions, created, _identifier, _idx)  VALUES (?, ?, ?, ?, ?, ?, ?)',updateStatement:'',local:true}));(function(){function dumyFunction(){}
function extendHWResource(resource,template){var terminal=OB.MobileApp.model.get('terminal');if(terminal[template+'IsPdf']==='true'){resource.ispdf=true;resource.printer=terminal[template+'Printer'];var i=0,subreports=[];while(terminal.hasOwnProperty(template+'Subrep'+i)){subreports[i]=new OB.DS.HWResource(terminal[template+'Subrep'+i]);subreports[i].getData(dumyFunction);i++;}
resource.subreports=subreports;resource.getData(dumyFunction);}}
var PrintReceipt=function(model){var terminal=OB.MobileApp.model.get('terminal');this.receipt=model.get('order');this.multiOrders=model.get('multiOrders');this.multiOrders.on('print',function(order,args){this.print(order,args);},this);this.receipt.on('print',function(order,args){try{this.print(order,args);}catch(e){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_ErrorPrintingReceipt'));OB.error('Error printing the receipt:'+e);}},this);this.receipt.on('displayTotal',this.displayTotal,this);this.multiOrders.on('displayTotal',function(){this.displayTotalMultiorders();},this);this.templatereceipt=new OB.DS.HWResource(terminal.printTicketTemplate||OB.OBPOSPointOfSale.Print.ReceiptTemplate);extendHWResource(this.templatereceipt,"printTicketTemplate");this.templateclosedreceipt=new OB.DS.HWResource(terminal.printClosedReceiptTemplate||OB.OBPOSPointOfSale.Print.ReceiptClosedTemplate);extendHWResource(this.templateclosedreceipt,"printClosedReceiptTemplate");this.templateinvoice=new OB.DS.HWResource(terminal.printInvoiceTemplate||OB.OBPOSPointOfSale.Print.ReceiptTemplateInvoice);extendHWResource(this.templateinvoice,"printInvoiceTemplate");this.templatereturn=new OB.DS.HWResource(terminal.printReturnTemplate||OB.OBPOSPointOfSale.Print.ReceiptTemplateReturn);extendHWResource(this.templatereturn,"printReturnTemplate");this.templatereturninvoice=new OB.DS.HWResource(terminal.printReturnInvoiceTemplate||OB.OBPOSPointOfSale.Print.ReceiptTemplateReturnInvoice);extendHWResource(this.templatereturninvoice,"printReturnInvoiceTemplate");this.templatelayaway=new OB.DS.HWResource(terminal.printLayawayTemplate||OB.OBPOSPointOfSale.Print.ReceiptTemplateLayaway);extendHWResource(this.templatelayaway,"printLayawayTemplate");this.templatecashup=new OB.DS.HWResource(terminal.printCashUpTemplate||OB.OBPOSPointOfSale.Print.CashUpTemplate);extendHWResource(this.templatecashup,"printCashUpTemplate");this.templatequotation=new OB.DS.HWResource(terminal.printQuotationTemplate||OB.OBPOSPointOfSale.Print.QuotationTemplate);extendHWResource(this.templatequotation,"printQuotationTemplate");this.templatetotal=new OB.DS.HWResource(terminal.printDisplayTotalTemplate||OB.OBPOSPointOfSale.Print.DisplayTotal);extendHWResource(this.templatetotal,"printDisplayTotalTemplate");this.templateline=new OB.DS.HWResource(terminal.printReceiptLineTemplate||OB.OBPOSPointOfSale.Print.ReceiptLineTemplate);extendHWResource(this.templateline,"printReceiptLineTemplate");this.templategoodbye=new OB.DS.HWResource(terminal.printGoodByeTemplate||OB.OBPOSPointOfSale.Print.GoodByeTemplate);extendHWResource(this.templategoodbye,"printGoodByeTemplate");this.templatewelcome=new OB.DS.HWResource(terminal.printWelcomeTemplate||OB.OBPOSPointOfSale.Print.WelcomeTemplate);extendHWResource(this.templatewelcome,"printWelcomeTemplate");this.templateclosedinvoice=new OB.DS.HWResource(terminal.printClosedInvoiceTemplate||OB.OBPOSPointOfSale.Print.ClosedInvoiceTemplate);extendHWResource(this.templateclosedinvoice,"printClosedInvoiceTemplate");};PrintReceipt.prototype.print=function(order,printargs){printargs=printargs||{};var receipt=new OB.Model.Order(),me=this,template;OB.UTIL.HookManager.executeHooks('OBPRINT_PrePrint',{forcePrint:printargs.forcePrint,offline:printargs.offline,order:order?order:me.receipt,template:template,callback:printargs.callback},function(args){function printPDF(receipt,args){OB.POS.hwserver._printPDF({param:receipt.serializeToJSON(),mainReport:args.template,subReports:args.template.subreports},function(result){var myreceipt=receipt;if(result&&result.exception){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'),OB.I18N.getLabel('OBPOS_MsgPrintAgain'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){me.print(receipt,printargs);if(args.callback){args.callback();}
return true;}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}],{onHideFunction:function(dialog){if(printargs.offline&&OB.MobileApp.model.get('terminal').printoffline){OB.Dal.save(new OB.Model.OfflinePrinter({data:result.data,sendfunction:'_sendPDF'}));}}});}else{OB.Model.OfflinePrinter.printPendingJobs();if(args.callback){args.callback();}}});}
if(args.cancelOperation&&args.cancelOperation===true){if(args.callback){args.callback();}
return true;}
if(!_.isUndefined(args.order)&&!_.isNull(args.order)){OB.UTIL.clone(args.order,receipt);}else{OB.UTIL.clone(me.receipt,receipt);}
var linesToRemove=[];receipt.get('lines').forEach(function(line){if(!line.isPrintableService()){if(line.get('net')||line.get('gross')){return;}
linesToRemove.push(line);}});receipt.get('lines').remove(linesToRemove);if(args.forcedtemplate){args.template=args.forcedtemplate;}else if(receipt.get('generateInvoice')&&receipt.get('orderType')!==2&&receipt.get('orderType')!==3&&!receipt.get('isLayaway')){if(receipt.get('orderType')===1){args.template=me.templatereturninvoice;}else if(receipt.get('isQuotation')){args.template=me.templatequotation;}else if(receipt.get('isPaid')){args.template=me.templateclosedinvoice;}else{args.template=me.templateinvoice;}}else{if(receipt.get('isPaid')){if(receipt.get('orderType')===1){args.template=me.templatereturn;}else if(receipt.get('isQuotation')){args.template=me.templatequotation;}else{args.template=me.templateclosedreceipt;}}else{if(receipt.get('orderType')===1){args.template=me.templatereturn;}else if(receipt.get('orderType')===2||receipt.get('isLayaway')||receipt.get('orderType')===3){args.template=me.templatelayaway;}else if(receipt.get('isQuotation')){args.template=me.templatequotation;}else{args.template=me.templatereceipt;}}}
if(args.template.ispdf){args.template.dateFormat=OB.Format.date;printPDF(receipt,args);if((receipt.get('orderType')===1&&!OB.MobileApp.model.hasPermission('OBPOS_print.once'))||OB.MobileApp.model.get('terminal').terminalType.printTwice){printPDF(receipt,args);}}else{if(receipt.get('print')){OB.POS.hwserver.print(args.template,{order:receipt},function(result,printedReceipt){var myreceipt=receipt;if(result&&result.exception){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'),OB.I18N.getLabel('OBPOS_MsgPrintAgain'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){me.print(receipt,printargs);return true;}},{label:OB.I18N.getLabel('OBMOBC_LblCancel'),action:function(){if(args.callback){args.callback();}
return true;}}],{onHideFunction:function(dialog){if(printargs.offline&&OB.MobileApp.model.get('terminal').printoffline){OB.Dal.save(new OB.Model.OfflinePrinter({data:result.data,sendfunction:'_send'}));}
if(args.callback){args.callback();}}});}else{OB.Model.OfflinePrinter.printPendingJobs();OB.UTIL.HookManager.executeHooks('OBPRINT_PostPrint',{receipt:receipt,printedReceipt:printedReceipt},function(){OB.debug("Executed hooks of OBPRINT_PostPrint");if(args.callback){args.callback();}});}});}else{if(args.callback){args.callback();}}
if(!OB.POS.hwserver.url){if(args.callback){args.callback();}}
if(receipt.get('print')){if((receipt.get('orderType')===1&&!OB.MobileApp.model.hasPermission('OBPOS_print.once'))||_.filter(receipt.get('payments').models,function(iter){if(iter.get('printtwice')){return iter;}}).length>0||OB.MobileApp.model.get('terminal').terminalType.printTwice){OB.POS.hwserver.print(args.template,{order:receipt},function(result){var myreceipt=receipt;if(result&&result.exception){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'),OB.I18N.getLabel('OBPOS_MsgPrintAgain'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),action:function(){me.print(receipt,printargs);return true;}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}],{onHideFunction:function(dialog){if(printargs.offline&&OB.MobileApp.model.get('terminal').printoffline){OB.Dal.save(new OB.Model.OfflinePrinter({data:result.data,sendfunction:'_send'}));}
if(args.callback){args.callback();}}});}else{OB.Model.OfflinePrinter.printPendingJobs();}});}}}});};PrintReceipt.prototype.displayTotal=function(){var receipt=new OB.Model.Order();OB.UTIL.clone(this.receipt,receipt);OB.POS.hwserver.print(this.templatetotal,{order:receipt});};PrintReceipt.prototype.displayTotalMultiorders=function(){var multiOrders;multiOrders=this.multiOrders;OB.POS.hwserver.print(this.templatetotal,{order:multiOrders});};var PrintReceiptLine=function(receipt){var terminal=OB.MobileApp.model.get('terminal');this.receipt=receipt;this.line=null;this.receipt.get('lines').on('selected',function(line){if(this.receipt.get("isPaid")===true){return;}
if(this.line){this.line.off('change',this.print);}
this.line=line;if(this.line){this.line.on('change',this.print,this);}
this.print();},this);this.templateline=new OB.DS.HWResource(terminal.printReceiptLineTemplate||OB.OBPOSPointOfSale.Print.ReceiptLineTemplate);extendHWResource(this.templateline,'printReceiptLineTemplate');};PrintReceiptLine.prototype.print=function(){if(this.line){OB.POS.hwserver.print(this.templateline,{line:this.line});}};OB.OBPOSPointOfSale=OB.OBPOSPointOfSale||{};OB.OBPOSPointOfSale.Print=OB.OBPOSPointOfSale.Print||{};OB.OBPOSPointOfSale.Print.Receipt=PrintReceipt;OB.OBPOSPointOfSale.Print.ReceiptTemplate='../org.openbravo.retail.posterminal/res/printreceipt.xml';OB.OBPOSPointOfSale.Print.ReceiptClosedTemplate='../org.openbravo.retail.posterminal/res/printclosedreceipt.xml';OB.OBPOSPointOfSale.Print.ReceiptTemplateInvoice='../org.openbravo.retail.posterminal/res/printinvoice.xml';OB.OBPOSPointOfSale.Print.ReceiptTemplateReturn='../org.openbravo.retail.posterminal/res/printreturn.xml';OB.OBPOSPointOfSale.Print.ReceiptTemplateReturnInvoice='../org.openbravo.retail.posterminal/res/printreturninvoice.xml';OB.OBPOSPointOfSale.Print.ReceiptLine=PrintReceiptLine;OB.OBPOSPointOfSale.Print.ReceiptLineTemplate='../org.openbravo.retail.posterminal/res/printline.xml';OB.OBPOSPointOfSale.Print.ReceiptTemplateLayaway='../org.openbravo.retail.posterminal/res/printlayaway.xml';OB.OBPOSPointOfSale.Print.DisplayTotal='../org.openbravo.retail.posterminal/res/displaytotal.xml';OB.OBPOSPointOfSale.Print.CashUpTemplate='../org.openbravo.retail.posterminal/res/printcashup.xml';OB.OBPOSPointOfSale.Print.GoodByeTemplate='../org.openbravo.retail.posterminal/res/goodbye.xml';OB.OBPOSPointOfSale.Print.WelcomeTemplate='../org.openbravo.retail.posterminal/res/welcome.xml';OB.OBPOSPointOfSale.Print.QuotationTemplate='../org.openbravo.retail.posterminal/res/printquotation.xml';OB.OBPOSPointOfSale.Print.ClosedInvoiceTemplate='../org.openbravo.retail.posterminal/res/printclosedinvoice.xml';}());OB.OBPOSPointOfSale=OB.OBPOSPointOfSale||{};OB.OBPOSPointOfSale.Model=OB.OBPOSPointOfSale.Model||{};OB.OBPOSPointOfSale.UI=OB.OBPOSPointOfSale.UI||{};OB.OBPOSPointOfSale.Model.PointOfSale=OB.Model.TerminalWindowModel.extend({models:[{generatedModel:true,modelName:'TaxRate'},{generatedModel:true,modelName:'TaxZone'},OB.Model.Product,OB.Model.ProductCategory,OB.Model.PriceList,OB.Model.ProductPrice,OB.Model.OfferPriceList,OB.Model.ServiceProduct,OB.Model.ServiceProductCategory,OB.Model.ServicePriceRule,OB.Model.ServicePriceRuleRange,OB.Model.ServicePriceRuleRangePrices,OB.Model.ServicePriceRuleVersion,OB.Model.BusinessPartner,OB.Model.BPCategory,OB.Model.BPLocation,OB.Model.Order,OB.Model.DocumentSequence,OB.Model.ChangedBusinessPartners,OB.Model.ChangedBPlocation,OB.Model.ProductBOM,OB.Model.TaxCategoryBOM,{generatedModel:true,modelName:'Discount'},{generatedModel:true,modelName:'DiscountFilterBusinessPartner'},{generatedModel:true,modelName:'DiscountFilterBusinessPartnerGroup'},{generatedModel:true,modelName:'DiscountFilterProduct'},{generatedModel:true,modelName:'DiscountFilterProductCategory'},{generatedModel:true,modelName:'DiscountFilterRole'},{generatedModel:true,modelName:'DiscountFilterCharacteristic'},OB.Model.CurrencyPanel,OB.Model.SalesRepresentative,OB.Model.Brand,OB.Model.ProductCharacteristicValue,OB.Model.CharacteristicValue,OB.Model.Characteristic,OB.Model.ReturnReason,OB.Model.CashUp,OB.Model.OfflinePrinter,OB.Model.PaymentMethodCashUp,OB.Model.TaxCashUp],loadUnpaidOrders:function(loadUnpaidOrdersCallback){var orderlist=this.get('orderList'),model=this,criteria={'hasbeenpaid':'N'};OB.Dal.find(OB.Model.Order,criteria,function(ordersNotPaid){var currentOrder={},loadOrderStr;var maxDocumentNo=0,maxQuotationNo=0;_.each(ordersNotPaid.models,function(order){if(order){if(order.get('documentnoSuffix')>maxDocumentNo){maxDocumentNo=order.get('documentnoSuffix');}
if(order.get('quotationnoSuffix')>maxQuotationNo){maxQuotationNo=order.get('quotationnoSuffix');}}});if(maxDocumentNo>0&&OB.MobileApp.model.documentnoThreshold<maxDocumentNo){OB.MobileApp.model.documentnoThreshold=maxDocumentNo;}
if(maxQuotationNo>0&&OB.MobileApp.model.quotationnoThreshold<maxQuotationNo){OB.MobileApp.model.quotationnoThreshold=maxQuotationNo;}
var outOfSessionOrder=_.filter(ordersNotPaid.models,function(order){if(order&&order.get('session')!==OB.MobileApp.model.get('session')){return true;}});_.each(outOfSessionOrder,function(orderToRemove){ordersNotPaid.remove(orderToRemove);});OB.UTIL.HookManager.executeHooks('OBPOS_PreLoadUnpaidOrdersHook',{ordersNotPaid:ordersNotPaid,model:model},function(args){if(!args.ordersNotPaid||args.ordersNotPaid.length===0){orderlist.addFirstOrder();}else{orderlist.reset(args.ordersNotPaid.models);currentOrder=args.ordersNotPaid.models[0];orderlist.load(currentOrder);loadOrderStr=OB.I18N.getLabel('OBPOS_Order')+currentOrder.get('documentNo')+OB.I18N.getLabel('OBPOS_Loaded');OB.UTIL.showAlert.display(loadOrderStr,OB.I18N.getLabel('OBPOS_Info'));}
loadUnpaidOrdersCallback();});},function(){orderlist.addFirstOrder();});},loadCheckedMultiorders:function(){var checkedMultiOrders,multiOrderList=this.get('multiOrders').get('multiOrdersList'),criteria={'hasbeenpaid':'N','session':OB.MobileApp.model.get('session')};OB.Dal.find(OB.Model.Order,criteria,function(possibleMultiOrder){if(possibleMultiOrder&&possibleMultiOrder.length>0){checkedMultiOrders=_.compact(possibleMultiOrder.map(function(e){if(e.get('checked')){return e;}}));multiOrderList.reset(checkedMultiOrders);}},function(){});},isValidMultiOrderState:function(){if(this.get('leftColumnViewManager')&&this.get('multiOrders')){return this.get('leftColumnViewManager').isMultiOrder()&&this.get('multiOrders').hasDataInList();}
return false;},getPending:function(){if(this.get('leftColumnViewManager').isOrder()){return this.get('order').getPending();}else{return this.get('multiOrders').getPending();}},getChange:function(){if(this.get('leftColumnViewManager').isOrder()){return this.get('order').getChange();}else{return this.get('multiOrders').getChange();}},getTotal:function(){if(this.get('leftColumnViewManager').isOrder()){return this.get('order').getTotal();}else{return this.get('multiOrders').getTotal();}},getPayment:function(){if(this.get('leftColumnViewManager').isOrder()){return this.get('order').getPayment();}else{return this.get('multiOrders').getPayment();}},addPayment:function(payment){var modelToIncludePayment;if(this.get('leftColumnViewManager').isOrder()){modelToIncludePayment=this.get('order');}else{modelToIncludePayment=this.get('multiOrders');}
modelToIncludePayment.addPayment(payment);},deleteMultiOrderList:function(){var i;for(i=0;this.get('multiOrders').get('multiOrdersList').length>i;i++){if(!this.get('multiOrders').get('multiOrdersList').at(i).get('isLayaway')){this.get('multiOrders').get('multiOrdersList').at(i).unset('amountToLayaway');this.get('multiOrders').get('multiOrdersList').at(i).set('orderType',0);continue;}
this.get('orderList').current=this.get('multiOrders').get('multiOrdersList').at(i);this.get('orderList').deleteCurrent();if(!_.isNull(this.get('multiOrders').get('multiOrdersList').at(i).id)){this.get('orderList').deleteCurrentFromDatabase(this.get('multiOrders').get('multiOrdersList').at(i));}}},init:function(){OB.error("This init method should never be called for this model. Call initModels and loadModels instead");this.initModels(function(){});this.loadModels(function(){});},initModels:function(callback){var me=this;var receipt=new OB.Model.Order();receipt.triggerEventsIfTargetOfSourceWhenCloning=function(){return true;};OB.MobileApp.model.receipt=receipt;var multiOrders=new OB.Model.MultiOrders();var orderList=new OB.Collection.OrderList(receipt);OB.MobileApp.model.orderList=orderList;var auxReceiptList=[];this.set('order',receipt);this.set('orderList',orderList);this.set('customer',new OB.Model.BusinessPartner());this.set('customerAddr',new OB.Model.BPLocation());this.set('multiOrders',multiOrders);OB.DATA.CustomerSave(this);OB.DATA.CustomerAddrSave(this);OB.DATA.OrderDiscount(receipt);OB.DATA.OrderSave(this);OB.DATA.OrderTaxes(receipt);this.printReceipt=new OB.OBPOSPointOfSale.Print.Receipt(this);this.printLine=new OB.OBPOSPointOfSale.Print.ReceiptLine(receipt);var ViewManager=Backbone.Model.extend({defaults:{currentWindow:{name:'mainSubWindow',params:[]}},initialize:function(){}});var LeftColumnViewManager=Backbone.Model.extend({defaults:{currentView:{}},initialize:function(){this.on('change:currentView',function(changedModel){localStorage.setItem('leftColumnCurrentView',JSON.stringify(changedModel.get('currentView')));this.trigger(changedModel.get('currentView').name);},this);},setOrderMode:function(parameters){this.set('currentView',{name:'order',params:parameters});localStorage.setItem('leftColumnCurrentView',JSON.stringify(this.get('currentView')));},isOrder:function(){if(this.get('currentView').name==='order'){return true;}
return false;},setMultiOrderMode:function(parameters){this.set('currentView',{name:'multiorder',params:parameters});},isMultiOrder:function(){if(this.get('currentView').name==='multiorder'){return true;}
return false;}});this.set('leftColumnViewManager',new LeftColumnViewManager());this.set('subWindowManager',new ViewManager());OB.MobileApp.model.runSyncProcess(function(){OB.RR.RequestRouter.sendAllMessages();me.loadCheckedMultiorders();},function(){OB.RR.RequestRouter.sendAllMessages();me.loadCheckedMultiorders();});receipt.on('paymentAccepted',function(){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("receipt.paymentAccepted");receipt.setIsCalculateReceiptLockState(true);receipt.setIsCalculateGrossLockState(true);receipt.prepareToSend(function(){var oldChange=receipt.get('change'),clonedCollection=new Backbone.Collection(),paymentKind,i;if(receipt.get('orderType')!==2&&receipt.get('orderType')!==3){var negativeLines=_.filter(receipt.get('lines').models,function(line){return line.get('qty')<0;}).length;if(negativeLines===receipt.get('lines').models.length){receipt.setOrderType('OBPOS_receipt.return',OB.DEC.One,{applyPromotions:false,saveOrder:false});}else{receipt.setOrderType('',OB.DEC.Zero,{applyPromotions:false,saveOrder:false});}}
receipt.get('payments').each(function(model){clonedCollection.add(new Backbone.Model(model.toJSON()));});if(!_.isUndefined(receipt.get('selectedPayment'))&&receipt.getChange()>0){var payment=OB.MobileApp.model.paymentnames[receipt.get('selectedPayment')];if(!payment.paymentMethod.iscash){payment=OB.MobileApp.model.paymentnames[OB.MobileApp.model.get('paymentcash')];}
if(receipt.get('payment')>=receipt.get('gross')){receipt.addPayment(new OB.Model.PaymentLine({'kind':payment.payment.searchKey,'name':payment.payment.commercialName,'amount':OB.DEC.sub(0,OB.DEC.mul(receipt.getChange(),payment.mulrate)),'rate':payment.rate,'mulrate':payment.mulrate,'isocode':payment.isocode,'allowOpenDrawer':payment.paymentMethod.allowopendrawer,'isCash':payment.paymentMethod.iscash,'openDrawer':payment.paymentMethod.openDrawer,'printtwice':payment.paymentMethod.printtwice}));}
receipt.set('change',oldChange);for(i=0;i<receipt.get('payments').length;i++){paymentKind=OB.MobileApp.model.paymentnames[receipt.get('payments').models[i].get('kind')];if(paymentKind&&paymentKind.paymentMethod&&paymentKind.paymentMethod.leaveascredit){receipt.set('payment',OB.DEC.sub(receipt.get('payment'),receipt.get('payments').models[i].get('amount')));receipt.set('paidOnCredit',true);}}}else{for(i=0;i<receipt.get('payments').length;i++){paymentKind=OB.MobileApp.model.paymentnames[receipt.get('payments').models[i].get('kind')];if(paymentKind&&paymentKind.paymentMethod&&paymentKind.paymentMethod.leaveascredit){receipt.set('payment',OB.DEC.sub(receipt.get('payment'),receipt.get('payments').models[i].get('amount')));receipt.set('paidOnCredit',true);}}}
receipt.trigger('closed',{callback:function(args){OB.UTIL.Debug.execute(function(){if(!args.frozenReceipt){throw"A clone of the receipt must be provided because it is possible that some rogue process could have changed it";}
if(OB.UTIL.isNullOrUndefined(args.isCancelled)){throw"The isCancelled flag must be set";}});if(args.isCancelled!==true){var orderToPrint=OB.UTIL.clone(args.frozenReceipt);orderToPrint.get('payments').reset();clonedCollection.each(function(model){orderToPrint.get('payments').add(new Backbone.Model(model.toJSON()),{silent:true});});orderToPrint.set('hasbeenpaid','Y');receipt.trigger('print',orderToPrint,{offline:true});var diff=OB.UTIL.diffJson(receipt.serializeToJSON(),args.frozenReceipt.serializeToJSON());delete diff.hasbeenpaid;var diffStringified=JSON.stringify(diff,undefined,2);if(diffStringified!=='{}'){OB.error("The receipt has been modified while it was being closed:\n"+diffStringified+"\n");}
orderList.deleteCurrent();receipt.setIsCalculateReceiptLockState(false);receipt.setIsCalculateGrossLockState(false);orderList.synchronizeCurrentOrder();}
enyo.$.scrim.hide();OB.UTIL.SynchronizationHelper.finished(synchId,"receipt.paymentAccepted");}});});},this);receipt.on('paymentDone',function(openDrawer){if(receipt.overpaymentExists()){var symbol=OB.MobileApp.model.get('terminal').symbol;var symbolAtRight=OB.MobileApp.model.get('terminal').currencySymbolAtTheRight;var amount=receipt.getPaymentStatus().overpayment;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_OverpaymentWarningTitle'),OB.I18N.getLabel('OBPOS_OverpaymentWarningBody',[OB.I18N.formatCurrencyWithSymbol(amount,symbol,symbolAtRight)]),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){if(openDrawer){OB.POS.hwserver.openDrawer({openFirst:false,receipt:receipt},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}
receipt.trigger('paymentAccepted');}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}]);}else if((OB.DEC.abs(receipt.getPayment())!==OB.DEC.abs(receipt.getGross()))&&(!receipt.isLayaway()&&!receipt.get('paidOnCredit'))){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_PaymentAmountDistinctThanReceiptAmountTitle'),OB.I18N.getLabel('OBPOS_PaymentAmountDistinctThanReceiptAmountBody'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){receipt.trigger('paymentAccepted');}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}]);}else{if(openDrawer){OB.POS.hwserver.openDrawer({openFirst:true,receipt:receipt},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}
receipt.trigger('paymentAccepted');}},this);this.get('multiOrders').on('paymentAccepted',function(){var synchIdPaymentAccepted=OB.UTIL.SynchronizationHelper.busyUntilFinishes("multiOrders.paymentAccepted");OB.UTIL.showLoading(true);var ordersLength=this.get('multiOrders').get('multiOrdersList').length;function readyToSendFunction(){me.get('leftColumnViewManager').setOrderMode();if(me.get('orderList').length>_.filter(me.get('multiOrders').get('multiOrdersList').models,function(order){return!order.get('isLayaway');}).length){me.get('orderList').addNewOrder();}}
var SyncReadyToSendFunction=_.after(this.get('multiOrders').get('multiOrdersList').length,readyToSendFunction);function prepareToSendCallback(order){var auxReceipt=new OB.Model.Order();OB.UTIL.clone(order,auxReceipt);if(order.get('orderType')!==2&&order.get('orderType')!==3){var negativeLines=_.filter(order.get('lines').models,function(line){return line.get('qty')<0;}).length;if(negativeLines===order.get('lines').models.length){order.setOrderType('OBPOS_receipt.return',OB.DEC.One,{applyPromotions:false,saveOrder:false});}else{order.setOrderType('',OB.DEC.Zero,{applyPromotions:false,saveOrder:false});}}
me.get('multiOrders').trigger('closed',order);enyo.$.scrim.hide();me.get('multiOrders').trigger('print',order,{offline:true});SyncReadyToSendFunction();auxReceiptList.push(auxReceipt);if(auxReceiptList.length===me.get('multiOrders').get('multiOrdersList').length){OB.UTIL.cashUpReport(auxReceiptList);auxReceiptList=[];}}
var i,j;for(j=0;j<ordersLength;j++){var iter=this.get('multiOrders').get('multiOrdersList').at(j);var amountToPay=!_.isUndefined(iter.get('amountToLayaway'))&&!_.isNull(iter.get('amountToLayaway'))?iter.get('amountToLayaway'):OB.DEC.sub(iter.get('gross'),iter.get('payment'));while(((_.isUndefined(iter.get('amountToLayaway'))||iter.get('amountToLayaway')>0)&&iter.get('gross')>iter.get('payment'))||(iter.get('amountToLayaway')>0)){for(i=0;i<this.get('multiOrders').get('payments').length;i++){var payment=this.get('multiOrders').get('payments').at(i),paymentMethod=OB.MobileApp.model.paymentnames[payment.get('kind')];if(this.get('multiOrders').get('change')>0&&paymentMethod.paymentMethod.iscash){payment.set('origAmount',OB.DEC.sub(payment.get('origAmount'),this.get('multiOrders').get('change')));this.get('multiOrders').set('change',OB.DEC.Zero);}
if(payment.get('origAmount')<=amountToPay){var bigDecAmount=new BigDecimal(String(OB.DEC.mul(payment.get('origAmount'),paymentMethod.mulrate)));iter.addPayment(new OB.Model.PaymentLine({'kind':payment.get('kind'),'name':payment.get('name'),'amount':OB.DEC.toNumber(bigDecAmount),'rate':paymentMethod.rate,'mulrate':paymentMethod.mulrate,'isocode':paymentMethod.isocode,'allowOpenDrawer':payment.get('allowopendrawer'),'isCash':payment.get('iscash'),'openDrawer':payment.get('openDrawer'),'printtwice':payment.get('printtwice')}));if(!_.isUndefined(iter.get('amountToLayaway'))&&!_.isNull(iter.get('amountToLayaway'))){iter.set('amountToLayaway',OB.DEC.sub(iter.get('amountToLayaway'),payment.get('origAmount')));}
this.get('multiOrders').get('payments').remove(this.get('multiOrders').get('payments').at(i));amountToPay=!_.isUndefined(iter.get('amountToLayaway'))&&!_.isNull(iter.get('amountToLayaway'))?iter.get('amountToLayaway'):OB.DEC.sub(iter.get('gross'),iter.get('payment'));}else{var bigDecAmountAux,amtAux;if(j===this.get('multiOrders').get('multiOrdersList').length-1&&!paymentMethod.paymentMethod.iscash){bigDecAmountAux=new BigDecimal(String(payment.get('origAmount')));amtAux=OB.DEC.toNumber(bigDecAmountAux);this.get('multiOrders').get('payments').at(i).set('origAmount',OB.DEC.sub(this.get('multiOrders').get('payments').at(i).get('origAmount'),payment.get('origAmount')));}else{bigDecAmountAux=new BigDecimal(String(OB.DEC.mul(amountToPay,paymentMethod.mulrate)));amtAux=OB.DEC.toNumber(bigDecAmountAux);this.get('multiOrders').get('payments').at(i).set('origAmount',OB.DEC.sub(this.get('multiOrders').get('payments').at(i).get('origAmount'),amountToPay));}
iter.addPayment(new OB.Model.PaymentLine({'kind':payment.get('kind'),'name':payment.get('name'),'amount':amtAux,'rate':paymentMethod.rate,'mulrate':paymentMethod.mulrate,'isocode':paymentMethod.isocode,'allowOpenDrawer':payment.get('allowopendrawer'),'isCash':payment.get('iscash'),'openDrawer':payment.get('openDrawer'),'printtwice':payment.get('printtwice')}));if(!_.isUndefined(iter.get('amountToLayaway'))&&!_.isNull(iter.get('amountToLayaway'))){iter.set('amountToLayaway',OB.DEC.sub(iter.get('amountToLayaway'),amtAux));}
amountToPay=!_.isUndefined(iter.get('amountToLayaway'))&&!_.isNull(iter.get('amountToLayaway'))?iter.get('amountToLayaway'):OB.DEC.sub(iter.get('gross'),iter.get('payment'));break;}}}
iter.prepareToSend(prepareToSendCallback);}
OB.UTIL.SynchronizationHelper.finished(synchIdPaymentAccepted,"multiOrders.paymentAccepted");},this);this.get('multiOrders').on('paymentDone',function(openDrawer){var me=this,paymentstatus=this.get('multiOrders');if(OB.DEC.compare(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total')))>0){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_OverpaymentWarningTitle'),OB.I18N.getLabel('OBPOS_OverpaymentWarningBody'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){if(openDrawer){OB.POS.hwserver.openDrawer({openFirst:false,receipt:me.get('multiOrders')},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}
me.get('multiOrders').trigger('paymentAccepted');}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}]);}else{if(openDrawer){OB.POS.hwserver.openDrawer({openFirst:true,receipt:me.get('multiOrders')},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}
this.get('multiOrders').trigger('paymentAccepted');}},this);receipt.get('lines').on('add change:qty change:price',function(line){if(!receipt.get('isEditable')){return;}
if(receipt.get('cloningReceipt')||receipt.get('skipApplyPromotions')||line.get('skipApplyPromotions')){return;}
receipt.calculateReceipt(null,line);},this);receipt.get('lines').on('remove',function(){if(!receipt.get('isEditable')){return;}
receipt.calculateReceipt();});receipt.on('change:bp',function(){if(!receipt.get('isEditable')||receipt.get('lines').length===0){return;}
receipt.get('lines').forEach(function(l){l.unset('noDiscountCandidates',{silent:true});});if(!OB.MobileApp.model.hasPermission('EnableMultiPriceList',true)){receipt.calculateReceipt();}},this);receipt.on('voidLayaway',function(){var finishVoidLayaway=function(){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('finishVoidLayaway');var process=new OB.DS.Process('org.openbravo.retail.posterminal.ProcessVoidLayaway');var auxReceipt=new OB.Model.Order();OB.UTIL.clone(receipt,auxReceipt);receipt.set('obposAppCashup',OB.MobileApp.model.get('terminal').cashUpId);receipt.set('timezoneOffset',new Date().getTimezoneOffset());receipt.set('gross',OB.DEC.mul(receipt.get('gross'),-1));receipt.get('payments').forEach(function(payment){payment.set('origAmount',OB.DEC.mul(payment.get('origAmount'),-1));payment.set('paid',OB.DEC.mul(payment.get('paid'),-1));});process.exec({messageId:OB.UTIL.get_UUID(),data:[{order:receipt}]},function(data){if(data&&data.exception){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgErrorVoidLayaway'));OB.UTIL.SynchronizationHelper.finished(synchId,"finishVoidLayaway");}else{auxReceipt.prepareToSend(function(){OB.UTIL.cashUpReport(auxReceipt);OB.UTIL.SynchronizationHelper.finished(synchId,"finishVoidLayaway");});OB.Dal.remove(receipt,null,function(tx,err){OB.UTIL.showError(err);});receipt.trigger('print');if(receipt.get('layawayGross')){receipt.set('layawayGross',null);}
orderList.deleteCurrent();receipt.trigger('change:gross',receipt);OB.UTIL.showSuccess(OB.I18N.getLabel('OBPOS_MsgSuccessVoidLayaway'));}},function(){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));OB.UTIL.SynchronizationHelper.finished(synchId,"finishVoidLayaway");});};if(receipt.overpaymentExists()){var symbol=OB.MobileApp.model.get('terminal').symbol;var symbolAtRight=OB.MobileApp.model.get('terminal').currencySymbolAtTheRight;var amount=receipt.getPaymentStatus().overpayment;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_OverpaymentWarningTitle'),OB.I18N.getLabel('OBPOS_OverpaymentWarningBody',[OB.I18N.formatCurrencyWithSymbol(amount,symbol,symbolAtRight)]),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){finishVoidLayaway();}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}]);}else{finishVoidLayaway();}},this);callback();},loadModels:function(loadModelsCallback){var me=this;this.set('filter',[]);this.set('brandFilter',[]);function searchCurrentBP(callback){var errorCallback=function(){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_BPInfoErrorTitle'),OB.I18N.getLabel('OBPOS_BPInfoErrorMessage'),[{label:OB.I18N.getLabel('OBPOS_Reload')}],{onShowFunction:function(popup){popup.$.headerCloseButton.hide();window.localStorage.removeItem('POSLastTotalRefresh');window.localStorage.removeItem('POSLastIncRefresh');},onHideFunction:function(){window.localStorage.removeItem('POSLastTotalRefresh');window.localStorage.removeItem('POSLastIncRefresh');window.location.reload();},autoDismiss:false});};function successCallbackBPs(dataBps){var partnerAddressId=OB.MobileApp.model.get('terminal').partnerAddress,successCallbackBPLoc;if(dataBps){if(partnerAddressId&&dataBps.get('locId')!==partnerAddressId){successCallbackBPLoc=function(bpLoc){dataBps.set('locId',bpLoc.get('id'));dataBps.set('locName',bpLoc.get('name'));dataBps.set('cityName',bpLoc.get('cityName'));dataBps.set('countryName',bpLoc.get('countryName'));dataBps.set('postalCode',bpLoc.get('postalCode'));dataBps.set('locationModel',bpLoc);OB.MobileApp.model.set('businessPartner',dataBps);me.loadUnpaidOrders(callback);};OB.Dal.get(OB.Model.BPLocation,partnerAddressId,successCallbackBPLoc,errorCallback,errorCallback);}else{if(dataBps.get('locId')){successCallbackBPLoc=function(bpLoc){dataBps.set('locId',bpLoc.get('id'));dataBps.set('locName',bpLoc.get('name'));dataBps.set('cityName',bpLoc.get('cityName'));dataBps.set('countryName',bpLoc.get('countryName'));dataBps.set('postalCode',bpLoc.get('postalCode'));dataBps.set('locationModel',bpLoc);OB.MobileApp.model.set('businessPartner',dataBps);me.loadUnpaidOrders(callback);};OB.Dal.get(OB.Model.BPLocation,dataBps.get('locId'),successCallbackBPLoc,errorCallback,errorCallback);}}}}
OB.Dal.get(OB.Model.BusinessPartner,OB.MobileApp.model.get('businesspartner'),successCallbackBPs,errorCallback,errorCallback);}
searchCurrentBP(loadModelsCallback);},completePayment:function(caller){var me=this;OB.UTIL.HookManager.executeHooks('OBPOS_PrePaymentHook',{context:this,caller:caller},function(){OB.UTIL.HookManager.executeHooks('OBPOS_PrePaymentApproval',{context:me,caller:caller},function(){me.checkPaymentApproval(caller);});});},checkPaymentApproval:function(caller){var me=this;OB.UTIL.HookManager.executeHooks('OBPOS_CheckPaymentApproval',{approvals:[],context:this,caller:caller},function(args){var negativeLines=_.filter(me.get('order').get('lines').models,function(line){return line.get('qty')<0;}).length;if(negativeLines>0&&!OB.MobileApp.model.get('permissions')['OBPOS_approval.returns']){args.approvals.push('OBPOS_approval.returns');}
if(args.approvals.length>0){OB.UTIL.Approval.requestApproval(me,args.approvals,function(approved){if(approved){me.trigger('approvalChecked',{approved:(args.approved!==undefined)?args.approved:true});}});}else{me.trigger('approvalChecked',{approved:(args.approved!==undefined)?args.approved:true});}});},approvedRequest:function(approved,supervisor,approvalType,callback){var order=this.get('order'),newApprovals=[],approvals,approval,i,date;approvals=order.get('approvals')||[];if(!Array.isArray(approvalType)){approvalType=[approvalType];}
_.each(approvals,function(appr){var results;results=_.find(approvalType,function(apprType){return apprType===appr.approvalType;});if(_.isUndefined(results)){newApprovals.push(appr);}});if(approved){date=new Date();date=date.getTime();for(i=0;i<approvalType.length;i++){approval={approvalType:approvalType[i],userContact:supervisor.get('id'),created:(new Date()).getTime()};newApprovals.push(approval);}
order.set('approvals',newApprovals);}
this.trigger('approvalChecked',{approved:approved});if(enyo.isFunction(callback)){callback(approved,supervisor,approvalType);}}});(function(){OB.OBPOSPointOfSale=OB.OBPOSPointOfSale||{};OB.OBPOSPointOfSale.UsedModels=OB.OBPOSPointOfSale.UsedModels||{};OB.OBPOSPointOfSale.UsedModels.LocalStock=Backbone.Model.extend({defaults:{product:OB.Model.Product,qty:0,warehouses:OB.OBPOSPointOfSale.UsedModels.WarehouseStockDetailList},initialize:function(serverData){var warehouses;if(serverData.product){this.set('product',serverData.product);}
this.set('qty',serverData.qty);warehouses=new OB.OBPOSPointOfSale.UsedModels.WarehouseStockDetailList(serverData.warehouses);this.set('warehouses',warehouses);},getWarehouseById:function(warId){return _.find(this.get('warehouses').models,function(whmodel){if(whmodel.get('warehouseid')===warId){return warId;}});}});OB.OBPOSPointOfSale.UsedModels.WarehouseStockDetail=Backbone.Model.extend({defaults:{warehouseid:null,warehousename:null,warehouseqty:0,bins:OB.OBPOSPointOfSale.UsedModels.BinStockDetailList},initialize:function(warehouse){var bins;bins=new OB.OBPOSPointOfSale.UsedModels.BinStockDetailList(warehouse.bins);this.set('warehouseid',warehouse.warehouseid);this.set('warehousename',warehouse.warehousename);this.set('warehouseqty',warehouse.warehouseqty);this.set('bins',bins);}});OB.OBPOSPointOfSale.UsedModels.BinStockDetail=Backbone.Model.extend({defaults:{binid:null,binname:null,binqty:0},initialize:function(bin){this.set('binid',bin.binid);this.set('binname',bin.binname);this.set('binqty',bin.binqty);}});OB.OBPOSPointOfSale.UsedModels.WarehouseStockDetailList=Backbone.Collection.extend({model:OB.OBPOSPointOfSale.UsedModels.WarehouseStockDetail});OB.OBPOSPointOfSale.UsedModels.BinStockDetailList=Backbone.Collection.extend({model:OB.OBPOSPointOfSale.UsedModels.BinStockDetail});}());(function(){OB.OBPOSPointOfSale=OB.OBPOSPointOfSale||{};OB.OBPOSPointOfSale.UsedModels=OB.OBPOSPointOfSale.UsedModels||{};OB.OBPOSPointOfSale.UsedModels.OtherStoresWarehousesStock=Backbone.Model.extend({defaults:{product:OB.Model.Product,qty:0,organizations:OB.OBPOSPointOfSale.UsedModels.OrganizationStockList},initialize:function(serverData){var organizations;if(serverData.product){this.set('product',serverData.product);}
this.set('qty',serverData.qty);organizations=new OB.OBPOSPointOfSale.UsedModels.OrganizationStockList(serverData.organizations);this.set('organizations',organizations);}});OB.OBPOSPointOfSale.UsedModels.OrganizationStock=Backbone.Model.extend({defaults:{organizationid:null,organizationname:null,organizationqty:0,warehouses:OB.OBPOSPointOfSale.UsedModels.OrganizationWarehousesList},initialize:function(organization){var warehouses;warehouses=new OB.OBPOSPointOfSale.UsedModels.OrganizationWarehousesList(organization.warehouses);this.set('organizationid',organization.organizationid);this.set('organizationname',organization.organizationname);this.set('organizationqty',organization.organizationqty);this.set('warehouses',warehouses);}});OB.OBPOSPointOfSale.UsedModels.OrganizationWarehouses=Backbone.Model.extend({defaults:{warehouseid:null,warehousename:null,warehouseqty:0},initialize:function(warehouse){this.set('warehouseid',warehouse.warehouseid);this.set('warehousename',warehouse.warehousename);this.set('warehouseqty',warehouse.warehouseqty);}});OB.OBPOSPointOfSale.UsedModels.OrganizationStockList=Backbone.Collection.extend({model:OB.OBPOSPointOfSale.UsedModels.OrganizationStock});OB.OBPOSPointOfSale.UsedModels.OrganizationWarehousesList=Backbone.Collection.extend({model:OB.OBPOSPointOfSale.UsedModels.OrganizationWarehouses});}());enyo.kind({name:'OB.OBPOSPointOfSale.UI.PointOfSale',kind:'OB.UI.WindowView',windowmodel:OB.OBPOSPointOfSale.Model.PointOfSale,tag:'section',handlers:{onAddProduct:'addProductToOrder',onViewProductDetails:'viewProductDetails',onCloseProductDetailsView:'showOrder',onCancelReceiptToInvoice:'cancelReceiptToInvoice',onReceiptToInvoice:'receiptToInvoice',onCreateQuotation:'createQuotation',onCreateOrderFromQuotation:'createOrderFromQuotation',onShowCreateOrderPopup:'showCreateOrderPopup',onReactivateQuotation:'reactivateQuotation',onShowReactivateQuotation:'showReactivateQuotation',onShowRejectQuotation:'showRejectQuotation',onRejectQuotation:'rejectQuotation',onQuotations:'quotations',onShowDivText:'showDivText',onAddNewOrder:'addNewOrder',onDeleteOrder:'deleteCurrentOrder',onTabChange:'tabChange',onDeleteLine:'deleteLine',onEditLine:'editLine',onReturnLine:'returnLine',onExactPayment:'exactPayment',onRemovePayment:'removePayment',onChangeCurrentOrder:'changeCurrentOrder',onChangeBusinessPartner:'changeBusinessPartner',onPrintReceipt:'printReceipt',onBackOffice:'backOffice',onPaidReceipts:'paidReceipts',onChangeSubWindow:'changeSubWindow',onShowLeftSubWindow:'showLeftSubWindow',onCloseLeftSubWindow:'showOrder',onSetProperty:'setProperty',onSetLineProperty:'setLineProperty',onSetReceiptsList:'setReceiptsList',onShowReceiptProperties:'showModalReceiptProperties',onDiscountsMode:'discountsMode',onDiscountsModeFinished:'discountsModeFinished',onDisableLeftToolbar:'leftToolbarDisabled',onDisableBPSelection:'BPSelectionDisabled',onDisableBPLocSelection:'BPLocSelectionDisabled',onDisableNewBP:'newBPDisabled',onDisableNewBPLoc:'newBPLocDisabled',onDisableOrderSelection:'orderSelectionDisabled',onDisableKeyboard:'keyboardDisabled',onDiscountsModeKeyboard:'keyboardOnDiscountsMode',onCheckAllTicketLines:'allTicketLinesChecked',onSetDiscountQty:'discountQtyChanged',onLineChecked:'checkedLine',onStatusChanged:'statusChanged',onPaymentChanged:'paymentChanged',onPaymentActionPay:'paymentActionPay',onClearPaymentSelect:'clearPaymentSelect',onLayaways:'layaways',onChangeSalesRepresentative:'changeSalesRepresentative',onMaxLimitAmountError:'maxLimitAmountError',onMultiOrders:'multiOrders',onSelectMultiOrders:'selectMultiOrders',onRemoveMultiOrders:'removeMultiOrders',onRightToolDisabled:'rightToolbarDisabled',onSelectCharacteristicValue:'selectCharacteristicValue',onSelectBrand:'selectBrand',onSelectFilter:'selectFilter',onShowLeftHeader:'doShowLeftHeader',onWarehouseSelected:'warehouseSelected',onClearUserInput:'clearUserInput',onPricelistChanged:'pricelistChanged',onChangeDiscount:'changeDiscount',onReceiptLineSelected:'receiptLineSelected',onManageServiceProposal:'manageServiceProposal',onDisableUserInterface:'disableUserInterface',onEnableUserInterface:'enableUserInterface',onShowActionIcons:'showActionIcons',onSetMultiSelection:'setMultiSelection',onShowMultiSelection:'showMultiSelection',onSetMultiSelectionItems:'setMultiSelectionItems',onToggleLineSelection:'toggleLineSelection',onFinishServiceProposal:'finishServiceProposal',onkeydown:'keyDownHandler',onkeyup:'keyUpHandler',onRearrangeEditButtonBar:'rearrangeEditButtonBar'},events:{onShowPopup:'',onHidePopup:'',onButtonStatusChanged:''},components:[{name:'otherSubWindowsContainer',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.ModalConfigurationRequiredForCreateCustomers',name:'modalConfigurationRequiredForCreateNewCustomers'},{kind:'OB.OBPOSPointOfSale.UI.customers.cas',name:'customerAdvancedSearch'},{kind:'OB.OBPOSPointOfSale.UI.customers.newcustomer',name:'customerCreateAndEdit'},{kind:'OB.OBPOSPointOfSale.UI.customers.editcustomer',name:'customerView'},{kind:'OB.OBPOSPointOfSale.UI.customeraddr.cas',name:'customerAddressSearch'},{kind:'OB.OBPOSPointOfSale.UI.customeraddr.newcustomeraddr',name:'customerAddrCreateAndEdit'},{kind:'OB.OBPOSPointOfSale.UI.customeraddr.editcustomeraddr',name:'customerAddressView'},{kind:'OB.UI.ModalDeleteReceipt',name:'modalConfirmReceiptDelete'},{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalProductCannotBeGroup',name:'modalProductCannotBeGroup'},{kind:'OB.UI.Modalnoteditableorder',name:'modalNotEditableOrder'},{kind:'OB.UI.ModalNotEditableLine',name:'modalNotEditableLine'},{kind:'OB.UI.ModalBusinessPartners',name:"modalcustomer"},{kind:'OB.UI.ModalBPLocation',name:"modalcustomeraddress"},{kind:'OB.UI.ModalReceipts',name:'modalreceipts'},{kind:'OB.UI.ModalPaidReceipts',name:'modalPaidReceipts'},{kind:'OB.UI.ModalMultiOrders',name:'modalMultiOrders'},{kind:'OB.UI.ModalCreateOrderFromQuotation',name:'modalCreateOrderFromQuotation'},{kind:'OB.UI.ModalReactivateQuotation',name:'modalReactivateQuotation'},{kind:'OB.UI.ModalRejectQuotation',name:'modalRejectQuotation'},{kind:'OB.UI.ModalReceiptPropertiesImpl',name:'receiptPropertiesDialog'},{kind:'OB.UI.ModalReceiptLinesPropertiesImpl',name:"receiptLinesPropertiesDialog"},{kind:'OB.UI.ModalPayment',name:"modalpayment"},{kind:'OB.UI.ModalPaymentVoid',name:"modalpaymentvoid"},{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalConfigurationRequiredForCrossStore',name:'modalConfigurationRequiredForCrossStore'},{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore',name:'modalLocalStock'},{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStoreClickable',name:'modalLocalStockClickable'},{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInOtherStores',name:'modalStockInOtherStores'},{kind:'OB.OBPOSPointOfSale.UI.Modals.modalEnoughCredit',name:'modalEnoughCredit'},{kind:'OB.OBPOSPointOfSale.UI.Modals.modalNotEnoughCredit',name:'modalNotEnoughCredit'},{kind:'OB.UI.ValidateAction',name:'modalValidateAction'},{kind:'OB.OBPOSPointOfSale.UI.Modals.modalDiscountNeedQty',name:'modalDiscountNeedQty'},{kind:'OB.OBPOSPointOfSale.UI.Modals.modalNotValidValueForDiscount',name:'modalNotValidValueForDiscount'},{kind:'OB.UI.ModalSalesRepresentative',name:"modalsalesrepresentative"},{kind:'OB.UI.ModalMultiOrdersLayaway',name:"modalmultiorderslayaway"},{kind:'OB.UI.ModalProductCharacteristic',name:"modalproductcharacteristic"},{kind:'OB.UI.ModalProductBrand',name:"modalproductbrand"},{kind:'OB.UI.ModalSearchFilterBuilder',name:'modalsearchfilterbuilder'},{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalPaymentsSelect',name:'modalPaymentsSelect'},{kind:'OB.UI.ModalModulesInDev',name:'modalModulesInDev'},{kind:'OB.UI.ModalSelectOpenedReceipt',name:'OBPOS_modalSelectOpenedReceipt'}]},{name:'mainSubWindow',isMainSubWindow:true,components:[{kind:'OB.UI.MultiColumn',name:'multiColumn',handlers:{onChangeTotal:'processChangeTotal'},leftToolbar:{kind:'OB.OBPOSPointOfSale.UI.LeftToolbarImpl',name:'leftToolbar',showMenu:true,showWindowsMenu:true},leftPanel:{name:'leftPanel',style:'max-height: 622px;',components:[{classes:'span12',kind:'OB.OBPOSPointOfSale.UI.LeftHeader',style:'height: 35px;',name:'divHeader'},{classes:'span12',kind:'OB.OBPOSPointOfSale.UI.ReceiptView',name:'receiptview',init:function(model){this.model=model;this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){this.setShowing(changedModel.isOrder());},this);}},{classes:'span12',kind:'OB.OBPOSPointOfSale.UI.MultiReceiptView',name:'multireceiptview',showing:false,init:function(model){this.model=model;this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){this.setShowing(changedModel.isMultiOrder());},this);}},{name:'leftSubWindowsContainer',components:[{classes:'span12',kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView',name:'productdetailsview'}]}]},rightToolbar:{kind:'OB.OBPOSPointOfSale.UI.RightToolbarImpl',name:'rightToolbar'},rightPanel:{name:'keyboardTabsPanel',components:[{classes:'span12',components:[{kind:'OB.OBPOSPointOfSale.UI.RightToolbarPane',name:'toolbarpane'},{kind:'OB.OBPOSPointOfSale.UI.KeyboardOrder',name:'keyboard'}]}]},processChangeTotal:function(inSender,inEvent){this.waterfall('onChangedTotal',{newTotal:inEvent.newTotal});}}]}],classModel:new Backbone.Model(),printReceipt:function(){if(OB.MobileApp.model.hasPermission('OBPOS_print.receipt')){if(this.model.get('leftColumnViewManager').isOrder()){var receipt=this.model.get('order');if(receipt.get("isPaid")){OB.UTIL.HookManager.executeHooks('OBPOS_PrePrintPaidReceipt',{context:this,receipt:this.model.get('order')},function(args){if(args&&args.cancelOperation&&args.cancelOperation===true){return;}
receipt.trigger('print',receipt,{forcePrint:true});});return;}
receipt.trigger('print',receipt,{forcePrint:true});return;}
if(this.model.get('leftColumnViewManager').isMultiOrder()){_.each(this.model.get('multiOrders').get('multiOrdersList').models,function(order){this.model.get('multiOrders').trigger('print',order,{forcePrint:true});},this);}}},keyDownHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;OB.MobileApp.model.ctrlPressed=keyCode===17;OB.MobileApp.model.shiftPressed=keyCode===16;},keyUpHandler:function(inSender,inEvent){var keyCode=inEvent.keyCode;if(keyCode===17){OB.MobileApp.model.ctrlPressed=false;}
if(keyCode===16){OB.MobileApp.model.shiftPressed=false;}},paidReceipts:function(inSender,inEvent){var receipt=this.model.get('order');if(inEvent&&inEvent.isReturn){if(receipt&&receipt.get('bp')&&receipt.get('bp').get('id')!==OB.MobileApp.model.get('businessPartner').get('id')){inEvent.bpartner=receipt.get('bp');}else if(receipt&&receipt.get('lines').length>0){inEvent.bpartner=receipt.get('bp');inEvent.defaultBP=true;}}
this.$.modalPaidReceipts.setParams(inEvent);this.$.modalPaidReceipts.waterfall('onClearAction');this.doShowPopup({popup:'modalPaidReceipts'});return true;},quotations:function(inSender,inEvent){this.$.modalPaidReceipts.setParams({isQuotation:true});this.$.modalPaidReceipts.waterfall('onClearAction');this.doShowPopup({popup:'modalPaidReceipts'});},backOffice:function(inSender,inEvent){if(inEvent.url){window.open(inEvent.url,'_blank');}},addNewOrder:function(inSender,inEvent){this.$.receiptPropertiesDialog.resetProperties();this.model.get('orderList').addNewOrder();return true;},deleteCurrentOrder:function(inSender,inEvent){function removeOrder(context){var isPaidQuotation=(context.model.get('order').has('isQuotation')&&context.model.get('order').get('isQuotation')&&context.model.get('order').has('hasbeenpaid')&&context.model.get('order').get('hasbeenpaid')==='Y');var receipt=context.model.get('order');if(receipt.get('id')&&!isPaidQuotation&&receipt.get('lines')&&receipt.get('lines').length>0){if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)&&!inEvent.originator.hasClass('paidticket')){receipt.setIsCalculateGrossLockState(true);receipt.set('obposIsDeleted',true);var i;for(i=0;i<receipt.get('lines').length;i++){receipt.get('lines').at(i).set('obposIsDeleted',true);}
receipt.prepareToSend(function(){receipt.trigger('closed',{callback:function(){context.model.get('orderList').deleteCurrent();context.model.get('orderList').synchronizeCurrentOrder();receipt.setIsCalculateGrossLockState(false);}});});}else{context.model.get('orderList').saveCurrent();OB.Dal.remove(context.model.get('orderList').current,null,null);context.model.get('orderList').deleteCurrent();}}else if(receipt.has('deletedLines')){if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){receipt.setIsCalculateGrossLockState(true);receipt.set('obposIsDeleted',true);receipt.prepareToSend(function(){receipt.trigger('closed',{callback:function(){context.model.get('orderList').deleteCurrent();context.model.get('orderList').synchronizeCurrentOrder();receipt.setIsCalculateGrossLockState(false);}});});}else{context.model.get('orderList').saveCurrent();OB.Dal.remove(context.model.get('orderList').current,null,null);context.model.get('orderList').deleteCurrent();}}else{if(receipt.get('id')){context.model.get('orderList').saveCurrent();OB.Dal.remove(context.model.get('orderList').current,null,null);}
context.model.get('orderList').deleteCurrent();}}
if(inEvent&&inEvent.notSavedOrder===true){OB.UTIL.HookManager.executeHooks('OBPOS_PreDeleteCurrentOrder',{context:this,receipt:this.model.get('order')},function(args){if(args&&args.cancelOperation&&args.cancelOperation===true){return;}
removeOrder(args.context);});}else{removeOrder(this);}
return true;},addProductToOrder:function(inSender,inEvent){var targetOrder;if(inEvent&&inEvent.targetOrder){targetOrder=inEvent.targetOrder;}else{targetOrder=this.model.get('order');}
if(targetOrder.pendingAddProduct&&targetOrder.pendingAddProduct===true){return false;}
if(targetOrder.get('isEditable')===false){targetOrder.canAddAsServices(this.model,inEvent.product,function(addAsServices){if(addAsServices!=='ABORT'){if(addAsServices==='OK'){var deferedSellApproval=_.find(targetOrder.get('approvals'),function(approval){return approval.approvalType.approval==='OBPOS_approval.deferred_sell_max_days';});if(deferedSellApproval){deferedSellApproval.approvalType.message='OBPOS_approval.deferred_sell_max_days_erp';deferedSellApproval.approvalType.params.push(inEvent.attrs.relatedLines[0].productName);deferedSellApproval.approvalType.params.push(targetOrder.get('documentNo'));}
_.each(inEvent.attrs.relatedLines,function(relatedLine){relatedLine.orderDocumentNo=targetOrder.get('documentNo');relatedLine.otherTicket=OB.UTIL.isNullOrUndefined(inEvent.targetOrder);relatedLine.deferred=true;var currentLine=targetOrder.get('lines').models.filter(function getCurrentLine(line){return line.id===relatedLine.orderlineId;});relatedLine.qty=currentLine[0].get('qty');relatedLine.gross=currentLine[0].get('gross');relatedLine.net=currentLine[0].get('net');relatedLine.promotions=currentLine[0].get('promotions').slice();});this.doShowPopup({popup:'OBPOS_modalSelectOpenedReceipt',args:{product:inEvent.product,approval:deferedSellApproval,attrs:inEvent.attrs,context:inEvent.context,callback:inEvent.callback}});if(deferedSellApproval){var index=_.indexOf(targetOrder.get('approvals'),deferedSellApproval);if(index>=0){targetOrder.get('approvals').splice(index,1);}}}else{if(inEvent.callback){inEvent.callback.call(inEvent.context,false);}}}else{this.doShowPopup({popup:'modalNotEditableOrder'});if(inEvent.callback){inEvent.callback.call(inEvent.context,false);}}},this);return true;}
if(inEvent.attrs&&inEvent.attrs.relatedLines&&inEvent.attrs.relatedLines[0].deferred&&inEvent.product.get('quantityRule')==='PP'){inEvent.qty=inEvent.attrs.relatedLines[0].qty;}
if(inEvent.ignoreStockTab){this.showOrder(inSender,inEvent);}else{if(!targetOrder.get('lines').isProductPresent(inEvent.product)&&inEvent.product.get('showstock')&&!inEvent.product.get('ispack')&&OB.MobileApp.model.get('connectedToERP')){inEvent.leftSubWindow=OB.OBPOSPointOfSale.UICustomization.stockLeftSubWindow;this.showLeftSubWindow(inSender,inEvent);if(enyo.Panels.isScreenNarrow()){this.$.multiColumn.switchColumn();}
return true;}else{this.showOrder(inSender,inEvent);}}
OB.UTIL.HookManager.executeHooks('OBPOS_PreAddProductToOrder',{context:this,receipt:targetOrder,productToAdd:inEvent.product,qtyToAdd:inEvent.qty?inEvent.qty:1,options:inEvent.options,attrs:inEvent.attrs},function(args){if(args.cancelOperation&&args.cancelOperation===true){if(inEvent.callback){inEvent.callback.call(inEvent.context,false);}
return true;}
args.receipt.pendingAddProduct=true;args.receipt.addProduct(args.productToAdd,args.qtyToAdd,args.options,args.attrs,function(success){args.receipt.pendingAddProduct=false;args.context.model.get('orderList').saveCurrent();if(inEvent.callback){inEvent.callback.call(inEvent.context,success);}});});return true;},showOrder:function(inSender,inEvent){var allHidden=true;enyo.forEach(this.$.multiColumn.$.leftPanel.$.leftSubWindowsContainer.getControls(),function(component){if(component.showing===true){if(component.mainBeforeSetHidden){if(!component.mainBeforeSetHidden(inEvent)){allHidden=false;return false;}else{component.setShowing(false);}}}},this);if(allHidden){this.$.multiColumn.$.leftPanel.$.receiptview.setShowing(true);}},showLeftSubWindow:function(inSender,inEvent){if(this.$.multiColumn.$.leftPanel.$[inEvent.leftSubWindow]){if(this.$.multiColumn.$.leftPanel.$[inEvent.leftSubWindow].mainBeforeSetShowing){var allHidden=true;enyo.forEach(this.$.multiColumn.$.leftPanel.getControls(),function(component){if(component.showing===true){if(component.mainBeforeSetHidden){if(!component.mainBeforeSetHidden(inEvent)){allHidden=false;return false;}}}},this);if(this.$.multiColumn.$.leftPanel.$[inEvent.leftSubWindow].mainBeforeSetShowing(inEvent)&&allHidden){this.$.multiColumn.$.leftPanel.$.receiptview.setShowing(false);this.$.multiColumn.$.leftPanel.$[inEvent.leftSubWindow].setShowing(true);this.$.multiColumn.$.leftPanel.$[inEvent.leftSubWindow].inEvent=inEvent;}}}},viewProductDetails:function(inSender,inEvent){this.$.multiColumn.$.leftPanel.$.receiptview.applyStyle('display','none');this.$.productdetailsview.updateProduct(inEvent.product);this.$.productdetailsview.applyStyle('display','inline');return true;},changeBusinessPartner:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
this.model.get('order').setBPandBPLoc(inEvent.businessPartner,false,true);this.model.get('orderList').saveCurrent();return true;},receiptToInvoice:function(){if(this.model.get('leftColumnViewManager').isOrder()){if(this.model.get('order').get('isEditable')===false&&!this.model.get('order').get('isLayaway')){if(!this.model.get('order').get('hasbeenpaid')){this.doShowPopup({popup:'modalNotEditableOrder'});}
return true;}
this.model.get('order').setOrderInvoice();return true;}
if(this.model.get('leftColumnViewManager').isMultiOrder()){this.model.get('multiOrders').toInvoice(true);}},createQuotation:function(){this.model.get('orderList').addNewQuotation();return true;},createOrderFromQuotation:function(){this.model.get('order').createOrderFromQuotation();this.model.get('orderList').saveCurrent();return true;},showReactivateQuotation:function(){this.doShowPopup({popup:'modalReactivateQuotation'});},showRejectQuotation:function(){this.doShowPopup({popup:'modalRejectQuotation'});},reactivateQuotation:function(){this.model.get('order').reactivateQuotation();this.model.get('orderList').saveCurrent();if(this.model.get('order').get('isEditable')&&this.model.get('order').get('isQuotation')){this.$.multiColumn.$.rightPanel.$.toolbarpane.$.edit.$.editTabContent.$.actionButtonsContainer.$.descriptionButton.show();}
return true;},rejectQuotation:function(inSender,inEvent){this.model.get('order').rejectQuotation(inEvent.rejectReason,this,function(success){if(success){this.deleteCurrentOrder(inSender,inEvent);}});return true;},showDivText:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false&&!this.model.get('order').get('isLayaway')){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(inEvent.orderType===3){this.$.multiColumn.$.rightPanel.$.keyboard.setStatus('');}
this.model.get('order').setOrderType(inEvent.permission,inEvent.orderType,{applyPromotions:false});this.model.get('orderList').saveCurrent();return true;},cancelReceiptToInvoice:function(inSender,inEvent){if(this.model.get('leftColumnViewManager').isOrder()){if(this.model.get('order').get('isEditable')===false&&!this.model.get('order').get('isLayaway')){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
this.model.get('order').resetOrderInvoice();return true;}
if(this.model.get('leftColumnViewManager').isMultiOrder()){if(this.model.get('leftColumnViewManager').isMultiOrder()){this.model.get('multiOrders').toInvoice(false);}}},checkedLine:function(inSender,inEvent){if(inEvent.originator.kind==='OB.UI.RenderOrderLine'){this.waterfall('onCheckedTicketLine',inEvent);return true;}},changeDiscount:function(inSender,inEvent){this.waterfall('onDiscountChanged',inEvent);},discountQtyChanged:function(inSender,inEvent){this.waterfall('onDiscountQtyChanged',inEvent);},keyboardOnDiscountsMode:function(inSender,inEvent){this.waterfall('onKeyboardOnDiscountsMode',inEvent);},keyboardDisabled:function(inSender,inEvent){this.waterfall('onKeyboardDisabled',inEvent);},allTicketLinesChecked:function(inSender,inEvent){this.waterfall('onAllTicketLinesChecked',inEvent);},leftToolbarDisabled:function(inSender,inEvent){this.waterfall('onLeftToolbarDisabled',inEvent);},rightToolbarDisabled:function(inSender,inEvent){this.waterfall('onRightToolbarDisabled',inEvent);},BPSelectionDisabled:function(inSender,inEvent){this.waterfall('onBPSelectionDisabled',inEvent);},BPLocSelectionDisabled:function(inSender,inEvent){this.waterfall('onBPLocSelectionDisabled',inEvent);},newBPDisabled:function(inSender,inEvent){this.waterfall('onNewBPDisabled',inEvent);},newBPLocDisabled:function(inSender,inEvent){this.waterfall('onNewBPLocDisabled',inEvent);},orderSelectionDisabled:function(inSender,inEvent){this.waterfall('onOrderSelectionDisabled',inEvent);},discountsMode:function(inSender,inEvent){this.leftToolbarDisabled(inSender,{status:true});this.rightToolbarDisabled(inSender,{status:true});this.BPSelectionDisabled(inSender,{status:true});this.BPLocSelectionDisabled(inSender,{status:true});this.orderSelectionDisabled(inSender,{status:true});this.keyboardOnDiscountsMode(inSender,{status:true});this.waterfall('onCheckBoxBehaviorForTicketLine',{status:true});this.tabChange(inSender,inEvent);},disableUserInterface:function(inSender,inEvent){this.leftToolbarDisabled(inSender,{status:true});this.rightToolbarDisabled(inSender,{status:true});this.BPSelectionDisabled(inSender,{status:true});this.BPLocSelectionDisabled(inSender,{status:true});this.orderSelectionDisabled(inSender,{status:true});},enableUserInterface:function(inSender,inEvent){this.leftToolbarDisabled(inSender,{status:false});this.rightToolbarDisabled(inSender,{status:false});this.BPSelectionDisabled(inSender,{status:false});this.BPLocSelectionDisabled(inSender,{status:false});this.orderSelectionDisabled(inSender,{status:false});},showActionIcons:function(inSender,inEvent){this.waterfall('onShowingActionIcons',inEvent);},tabChange:function(inSender,inEvent){this.leftToolbarDisabled(inSender,{status:false,disableButtonNew:(this.model.get('leftColumnViewManager').isMultiOrder()?true:false)});this.waterfall('onTabButtonTap',{tabPanel:inEvent.tabPanel,options:inEvent.options});this.waterfall('onChangeEditMode',{edit:inEvent.edit});if(inEvent.keyboard){this.$.multiColumn.$.rightPanel.$.keyboard.showToolbar(inEvent.keyboard);}else{this.$.multiColumn.$.rightPanel.$.keyboard.hide();}
if(!_.isUndefined(inEvent.status)){this.$.multiColumn.$.rightPanel.$.keyboard.setStatus(inEvent.status);}},discountsModeFinished:function(inSender,inEvent){this.leftToolbarDisabled(inSender,{status:false});this.keyboardOnDiscountsMode(inSender,{status:false});this.rightToolbarDisabled(inSender,{status:false});this.keyboardDisabled(inSender,{status:false});this.BPSelectionDisabled(inSender,{status:false});this.BPLocSelectionDisabled(inSender,{status:false});this.orderSelectionDisabled(inSender,{status:false});this.waterfall('onCheckBoxBehaviorForTicketLine',{status:false});this.allTicketLinesChecked(inSender,{status:false});this.tabChange(inSender,inEvent);},deleteLine:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
var line=inEvent.line,receipt=this.model.get('order');if(line&&receipt){receipt.deleteLine(line,false,inEvent.callback);receipt.trigger('scan');}},editLine:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
this.doShowPopup({popup:'receiptLinesPropertiesDialog',args:inEvent?inEvent.args:null});},returnLine:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
this.model.get('order').returnLine(inEvent.line);},exactPayment:function(inSender,inEvent){this.$.multiColumn.$.rightPanel.$.keyboard.execStatelessCommand('cashexact');},changeCurrentOrder:function(inSender,inEvent){this.model.get('orderList').load(inEvent.newCurrentOrder);return true;},removePayment:function(inSender,inEvent){var me=this;var voidTransaction;var voidConfirmation;var removeTransaction=function(){if(me.model.get('leftColumnViewManager').isOrder()){me.model.get('order').removePayment(inEvent.payment);me.model.get('order').trigger('displayTotal');return;}
if(me.model.get('leftColumnViewManager').isMultiOrder()){me.model.get('multiOrders').removePayment(inEvent.payment);me.model.get('multiOrders').trigger('displayTotal');return;}};var callVoidTransaction=function(){me.doShowPopup({popup:'modalpaymentvoid',args:{'amount':inEvent.payment.get('amount')}});voidTransaction(function(hasError,error){me.doHidePopup({popup:'modalpaymentvoid'});if(inEvent.removeCallback){inEvent.removeCallback();}
if(hasError){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_LblPaymentMethod'),error,[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true}],{autoDismiss:false});}else{removeTransaction();}});};if(inEvent.payment.get('paymentData')){voidTransaction=inEvent.payment.get('paymentData').voidTransaction;voidConfirmation=inEvent.payment.get('paymentData').voidConfirmation;if(voidConfirmation===false){if(voidTransaction!==undefined){callVoidTransaction();}else{removeTransaction();}
return;}
OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_LblPaymentMethod'),OB.I18N.getLabel('OBPOS_MsgConfirmRemovePayment'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){if(voidTransaction!==undefined){callVoidTransaction();}else{removeTransaction();}
return true;}},{label:OB.I18N.getLabel('OBMOBC_LblCancel'),action:function(){if(inEvent.removeCallback){inEvent.removeCallback();}
return true;}}],{autoDismiss:false,onHideFunction:function(){if(inEvent.removeCallback){inEvent.removeCallback();}}});}else{removeTransaction();}},changeSubWindow:function(inSender,inEvent){this.model.get('subWindowManager').set('currentWindow',inEvent.newWindow);},setReceiptsList:function(inSender,inEvent){this.$.modalreceipts.setReceiptsList(inEvent.orderList);this.$.OBPOS_modalSelectOpenedReceipt.setReceiptsList(inEvent.orderList);},showModalReceiptProperties:function(inSender,inEvent){this.doShowPopup({popup:'receiptPropertiesDialog'});return true;},setProperty:function(inSender,inEvent){var i;if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(inEvent.extraProperties){for(i=0;i<inEvent.extraProperties.length;i++){this.model.get('order').setProperty(inEvent.extraProperties[i],inEvent.value);}}
this.model.get('order').setProperty(inEvent.property,inEvent.value);this.model.get('orderList').saveCurrent();return true;},setLineProperty:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
var line=inEvent.line,receipt=this.model.get('order');if(line&&receipt){receipt.setLineProperty(line,inEvent.property,inEvent.value);}
this.model.get('orderList').saveCurrent();return true;},statusChanged:function(inSender,inEvent){this.waterfall('onButtonStatusChanged',{value:inEvent});},paymentChanged:function(inSender,inEvent){this.waterfall('onButtonPaymentChanged',inEvent);},paymentActionPay:function(inSender,inEvent){this.waterfall('onActionPay',inEvent);},clearPaymentSelect:function(inSender,inEvent){this.waterfall('onClearPaymentMethodSelect',inEvent);},layaways:function(inSender,inEvent){this.$.modalPaidReceipts.setParams({isLayaway:true});this.$.modalPaidReceipts.waterfall('onClearAction');this.doShowPopup({popup:'modalPaidReceipts'});},changeSalesRepresentative:function(inSender,inEvent){if(this.model.get('order').get('isEditable')===false){this.doShowPopup({popup:'modalNotEditableOrder'});return true;}
this.model.get('order').set('salesRepresentative',inEvent.salesRepresentative.get('id'));this.model.get('order').set('salesRepresentative$_identifier',inEvent.salesRepresentative.get('_identifier'));this.model.get('orderList').saveCurrent();return true;},selectCharacteristicValue:function(inSender,inEvent){this.waterfall('onUpdateFilter',{value:inEvent});},multiOrders:function(inSender,inEvent){this.doShowPopup({popup:'modalMultiOrders'});return true;},maxLimitAmountError:function(inSender,inEvent){this.waterfallDown('onMaxLimitAmountError',inEvent);return true;},selectBrand:function(inSender,inEvent){this.waterfall('onUpdateBrandFilter',{value:inEvent});},selectFilter:function(inSender,inEvent){this.waterfall('onCustomFilterUpdate',inEvent);},warehouseSelected:function(inSender,inEvent){this.waterfall('onModifyWarehouse',inEvent);},selectMultiOrders:function(inSender,inEvent){var me=this;me.model.get('multiOrders').get('multiOrdersList').reset();_.each(inEvent.value,function(iter){me.model.get('orderList').addMultiReceipt(iter);me.model.get('multiOrders').get('multiOrdersList').add(iter);});this.model.get('leftColumnViewManager').setMultiOrderMode();return true;},removeMultiOrders:function(inSender,inEvent){var me=this;me.model.get('multiOrders').get('multiOrdersList').remove(inEvent.order);if(inEvent&&inEvent.order&&inEvent.order.get('loadedFromServer')){me.model.get('orderList').current=inEvent.order;me.model.get('orderList').deleteCurrent();me.model.get('orderList').deleteCurrentFromDatabase(inEvent.order);}
return true;},doShowLeftHeader:function(inSender,inEvent){this.waterfall('onLeftHeaderShow',inEvent);},clearUserInput:function(inSender,inEvent){this.waterfall('onClearEditBox',inEvent);},pricelistChanged:function(inSender,inEvent){this.waterfall('onChangePricelist',inEvent);},receiptLineSelected:function(inSender,inEvent){var enableButton=true,selectedLines=this.$.multiColumn.$.rightPanel.$.keyboard.selectedModels,selectedLinesSameQty=this.$.multiColumn.$.rightPanel.$.keyboard.selectedModelsSameQty,selectedLinesLength=selectedLines?this.$.multiColumn.$.rightPanel.$.keyboard.selectedModels.length:0,product,i;if(selectedLinesLength>1){for(i=0;i<selectedLinesLength;i++){product=selectedLines[i].get('product');if(!product.get('groupProduct')||(product.get('productType')==='S'&&product.get('isLinkedToProduct'))||selectedLines[i].get('originalOrderLineId')){enableButton=false;break;}}
if(enableButton&&!selectedLinesSameQty){enableButton=false;}}else if(selectedLinesLength===1){product=selectedLines[0].get('product');if(!product.get('groupProduct')||(product.get('productType')==='S'&&product.get('isLinkedToProduct'))||selectedLines[0].get('originalOrderLineId')){enableButton=false;}}else{enableButton=false;}
this.enableKeyboardButton(enableButton);OB.UTIL.HookManager.executeHooks('OBPOS_LineSelected',{line:inEvent.line,selectedLines:selectedLines,context:this},function(args){});},enableKeyboardButton:function(enableButton){if(enableButton&&this.model.get('order').get('hasbeenpaid')==='Y'){enableButton=false;}
this.waterfall('onEnableQtyButton',{enable:enableButton});this.waterfall('onEnablePlusButton',{enable:enableButton});this.waterfall('onEnableMinusButton',{enable:enableButton});},manageServiceProposal:function(inSender,inEvent){this.waterfallDown('onManageServiceProposal',inEvent);},toggleLineSelection:function(inSender,inEvent){this.waterfall('onToggledLineSelection',inEvent);},finishServiceProposal:function(inSender,inEvent){this.waterfallDown('onFinishServiceProposal',inEvent);},setMultiSelection:function(inSender,inEvent){this.waterfall('onSetMultiSelected',inEvent);},showMultiSelection:function(inSender,inEvent){this.waterfall('onShowMultiSelected',inEvent);},setMultiSelectionItems:function(inSender,inEvent){this.waterfall('onTableMultiSelectedItems',inEvent);},rearrangeEditButtonBar:function(inSender,inEvent){this.waterfall('onRearrangedEditButtonBar',inEvent);},init:function(){var receipt,receiptList,LeftColumnCurrentView;this.inherited(arguments);receipt=this.model.get('order');receiptList=this.model.get('orderList');OB.MobileApp.view.scanningFocus(true);OB.Model.OfflinePrinter.printPendingJobs();this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isMultiOrder()){this.rightToolbarDisabled({},{status:true,exceptionPanel:'payment'});this.tabChange({},{tabPanel:'payment',keyboard:'toolbarpayment'});return;}
if(changedModel.isOrder()){this.rightToolbarDisabled({},{status:false});this.tabChange({},{tabPanel:'scan',keyboard:'toolbarscan'});return;}},this);LeftColumnCurrentView=enyo.json.parse(localStorage.getItem('leftColumnCurrentView'));if(LeftColumnCurrentView===null){LeftColumnCurrentView={name:'order',params:[]};}
this.model.get('leftColumnViewManager').set('currentView',LeftColumnCurrentView);this.model.get('subWindowManager').on('change:currentWindow',function(changedModel){function restorePreviousState(swManager,changedModel){swManager.set('currentWindow',changedModel.previousAttributes().currentWindow,{silent:true});}
var showNewSubWindow=false,currentWindowClosed=true;if(this.$[changedModel.get('currentWindow').name]){if(!changedModel.get('currentWindow').params){changedModel.get('currentWindow').params={};}
changedModel.get('currentWindow').params.caller=changedModel.previousAttributes().currentWindow.name;if(this.$[changedModel.previousAttributes().currentWindow.name].mainBeforeClose){currentWindowClosed=this.$[changedModel.previousAttributes().currentWindow.name].mainBeforeClose(changedModel.get('currentWindow').name);}
if(currentWindowClosed){if(this.$[changedModel.get('currentWindow').name].mainBeforeSetShowing){showNewSubWindow=this.$[changedModel.get('currentWindow').name].mainBeforeSetShowing(changedModel.get('currentWindow').params);if(showNewSubWindow){this.$[changedModel.previousAttributes().currentWindow.name].setShowing(false);this.$[changedModel.get('currentWindow').name].setShowing(true);if(this.$[changedModel.get('currentWindow').name].mainAfterShow){this.$[changedModel.get('currentWindow').name].mainAfterShow();}}else{restorePreviousState(this.model.get('subWindowManager'),changedModel);}}else{if(this.$[changedModel.get('currentWindow').name].isMainSubWindow){this.$[changedModel.previousAttributes().currentWindow.name].setShowing(false);this.$[changedModel.get('currentWindow').name].setShowing(true);OB.MobileApp.view.scanningFocus(true);}else{restorePreviousState(this.model.get('subWindowManager'),changedModel);}}}else{restorePreviousState(this.model.get('subWindowManager'),changedModel);}}else{restorePreviousState(this.model.get('subWindowManager'),changedModel);}},this);receipt.get('lines').on('created',function(line){this.classModel.trigger('createdLine',this,line);},this);receipt.get('lines').on('removed',function(line){this.classModel.trigger('removedLine',this,line);},this);receipt.on('change:hasbeenpaid',function(model){this.enableKeyboardButton(true);},this);this.$.multiColumn.$.leftPanel.$.receiptview.setOrder(receipt);this.$.multiColumn.$.leftPanel.$.receiptview.setOrderList(receiptList);this.$.multiColumn.$.rightPanel.$.toolbarpane.setModel(this.model);this.$.multiColumn.$.rightPanel.$.keyboard.setReceipt(receipt);this.$.multiColumn.$.rightToolbar.$.rightToolbar.setReceipt(receipt);},initComponents:function(){this.inherited(arguments);if(OB.UTIL.Debug.isDebug()){document.body.style.background='';document.body.className+=' indev-background';this.waterfall('onInDevHeaderShow');}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LeftHeader',showing:false,published:{text:null},handlers:{onLeftHeaderShow:'doShowHeader'},doShowHeader:function(inSender,inEvent){this.setText(inEvent.text);if(inEvent.style){this.$.innerDiv.addStyles(inEvent.style);}
this.show();},components:[{name:'innerDiv',style:'text-align: center; font-size: 30px; padding: 5px; padding-top: 0px;',components:[{name:'headerText',attributes:{style:'background-color: #ffffff; height: 30px; font-weight:bold; padding-top: 15px;'},content:''}]}],textChanged:function(){this.$.headerText.setContent(this.text);}});OB.OBPOSPointOfSale.UICustomization=OB.OBPOSPointOfSale.UICustomization||{};OB.OBPOSPointOfSale.UICustomization.stockLeftSubWindow='productdetailsview';OB.POS.registerWindow({windowClass:OB.OBPOSPointOfSale.UI.PointOfSale,route:'retail.pointofsale',menuPosition:null,permission:'OBPOS_retail.pointofsale',menuLabel:'POS'});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ReceiptView',classes:'span6',published:{order:null,orderList:null},events:{onChangeSelectionMode:''},handlers:{onCheckBoxBehaviorForTicketLine:'checkBoxBehavior',onToggleSelectionMode:'toggleSelectionMode',onTableMultiSelectAll:'tableMultiSelectAll'},components:[{style:'margin: 5px',components:[{style:'position: relative; background-color: #ffffff; color: black;overflow-y: auto; max-height: 612px',components:[{kind:'OB.UI.ReceiptsCounter',name:'receiptcounter'},{style:'padding: 5px;',components:[{kind:'OB.UI.OrderHeader',name:'receiptheader'},{classes:'row-fluid',style:'max-height: 536px;',components:[{classes:'span12',components:[{kind:'OB.UI.OrderView',name:'orderview'}]}]},{kind:'OB.UI.OrderFooter',name:'receiptfooter'}]}]}]}],orderChanged:function(oldValue){this.$.receiptheader.setOrder(this.order);this.$.orderview.setOrder(this.order);this.$.receiptfooter.setOrder(this.order);},orderListChanged:function(oldValue){this.$.receiptcounter.setOrderList(this.orderList);},toggleSelectionMode:function(inSender,inEvent){this.waterfall('onToggleSelectionTable',inEvent);this.doChangeSelectionMode(inEvent);},tableMultiSelectAll:function(inSender,inEvent){this.waterfall('onMultiSelectAllTable');}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.MultiReceiptView',classes:'span6',published:{order:null,orderList:null},components:[{style:'margin: 5px',components:[{style:'position: relative; background-color: #ffffff; color: black; overflow-y: auto; max-height: 622px',components:[{style:'padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{style:'padding: 5px 0px 10px 0px; border-bottom: 1px solid #cccccc;',components:[{style:'clear:both;'}]}]}]},{classes:'row-fluid',style:'max-height: 536px;',components:[{classes:'span12',components:[{kind:'OB.UI.MultiOrderView',name:'multiorderview'}]}]}]}]}]}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonStockThisStore',kind:'OB.UI.SmallButton',events:{onOpenLocalStockModal:'',onOpenLocalStockClickableModal:''},classes:'btnlink-green',style:'min-width: 200px; margin: 2px 5px 2px 5px;',tap:function(){if(!OB.MobileApp.model.get('permissions').OBPOS_warehouseselectionforline||!this.model.get('order').get('isEditable')){this.doOpenLocalStockModal();}else{this.doOpenLocalStockClickableModal();}},init:function(model){this.model=model;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonStockOtherStore',kind:'OB.UI.SmallButton',events:{onOpenOtherStoresStockModal:''},classes:'btnlink-green',style:'min-width: 200px; margin: 2px 5px 2px 5px;',tap:function(){var me=this;if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){var serverCallStoreDetailedStock=new OB.DS.Process('org.openbravo.retail.posterminal.stock.OtherStoresDetailedStock'),leftSubWindow=this.parent.leftSubWindow;leftSubWindow.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_loadingStock'));serverCallStoreDetailedStock.exec({organization:OB.MobileApp.model.get('terminal').organization,product:leftSubWindow.product.get('id')},function(data){if(data&&data.exception){leftSubWindow.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_stockCannotBeRetrieved'));leftSubWindow.bodyComponent.$.stockOthers.addClass('error');}else if(data.product===leftSubWindow.product.get('id')&&leftSubWindow.showing&&(data.qty||data.qty===0)){data.product=leftSubWindow.product;leftSubWindow.otherStoresStockModel=new OB.OBPOSPointOfSale.UsedModels.OtherStoresWarehousesStock(data);me.doOpenOtherStoresStockModal();leftSubWindow.bodyComponent.$.stockOthers.removeClass('error');leftSubWindow.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_otherStoresStock')+data.qty);}});}else{this.doOpenOtherStoresStockModal();}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonAddToTicket',kind:'OB.UI.RegularButton',classes:'btnlink-green',style:'min-width: 70px; margin: 2px 5px 2px 5px;',i18nLabel:'OBPOS_addToTicket',events:{onAddProduct:'',onSetLineProperty:'',onCloseLeftSubWindow:''},setLabel:function(){if(this.leftSubWindow&&this.leftSubWindow.line){this.setContent(OB.I18N.getLabel('OBMOBC_LblApply'));}else{this.setContent(OB.I18N.getLabel('OBPOS_addToTicket'));}},tap:function(){if(this.leftSubWindow.product){var line=null;if(this.leftSubWindow&&this.leftSubWindow.line){line=this.leftSubWindow.line;}
var attrs=(this.leftSubWindow.inEvent&&this.leftSubWindow.inEvent.attrs)?this.leftSubWindow.inEvent.attrs:{};attrs.warehouse={id:this.leftSubWindow.warehouse.warehouseid,warehousename:this.leftSubWindow.warehouse.warehousename,warehouseqty:this.leftSubWindow.warehouse.warehouseqty};if(line){this.doSetLineProperty({line:line,property:'warehouse',value:attrs.warehouse});this.doCloseLeftSubWindow();}else{this.doAddProduct({attrs:attrs,options:{line:line},product:this.leftSubWindow.product,ignoreStockTab:true});}}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonClose',style:'float: right; cursor: pointer; font-size: 150%; font-weight: bold; color: #CCCCCC; width: 40px; height: 40px; margin: -10px; text-align: right; padding: 8px;',init:function(){this.setContent(OB.I18N.getLabel('OBMOBC_Character')[2]);},tap:function(){this.leftSubWindow.doCloseLeftSubWindow();}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProductDetailsView_header',style:'font-size: 22px; height: 25px; padding: 15px 15px 5px 15px;',components:[{name:'productName',style:'float: left;'},{kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonClose',name:'buttonClose'}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProductDetailsView_body',handlers:{onOpenLocalStockModal:'openLocalStockModal',onOpenLocalStockClickableModal:'openLocalStockClickableModal',onOpenOtherStoresStockModal:'openOtherStoresStockModal'},events:{onShowPopup:''},openLocalStockModal:function(){if(this.leftSubWindow.localStockModel){this.doShowPopup({popup:'modalLocalStock',args:{stockInfo:this.leftSubWindow.localStockModel}});}
return true;},openLocalStockClickableModal:function(){if(this.leftSubWindow.localStockModel){this.doShowPopup({popup:'modalLocalStockClickable',args:{stockInfo:this.leftSubWindow.localStockModel}});}
return true;},openOtherStoresStockModal:function(){if(this.leftSubWindow.otherStoresStockModel){this.doShowPopup({popup:'modalStockInOtherStores',args:{stockInfo:this.leftSubWindow.otherStoresStockModel}});}
return true;},components:[{style:'height: 160px; padding: 20px;',components:[{name:'productImage',baseStyle:'background:#ffffff url(data:image/png;base64,xxImgBinaryDataxx) center center no-repeat;background-size:contain;margin: auto; height: 100%; width: 100%; background-size: contain;',style:'background-color:#ffffff; background-repeat: no-repeat; background-position: center center; background-size: contain; margin: auto; height: 100%; width: 100%;'}]},{style:'margin: 5px 15px;',components:[{name:'warehouseToGet',allowHtml:true,style:'line-height: 20px; font-size: 20px; padding: 10px; color: black;'}]},{style:'height: 80px;  padding: 10px;',components:[{style:'float: left; width: 50%;',components:[{style:'padding: 0px 0px 15px 0px;',components:[{kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonStockThisStore',name:'stockHere'}]},{kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonStockOtherStore',name:'stockOthers'}]},{style:'float: right;',components:[{name:'productPrice',allowHtml:true,style:'margin: 5px 0px 12px 0px; text-align: center; font-size: 18px; font-weight: 600;'},{components:[{name:'productAddToReceipt',kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView_ButtonAddToTicket'}]}]}]},{kind:'Scroller',maxHeight:'191px',style:'padding: 15px;',components:[{name:'descriptionArea'}]}]});enyo.kind({kind:'OB.UI.LeftSubWindow',name:'OB.OBPOSPointOfSale.UI.ProductDetailsView',events:{onShowPopup:''},handlers:{onModifyWarehouse:'changeWarehouseInfo'},changeWarehouseInfo:function(inSender,inEvent){this.bodyComponent.$.warehouseToGet.setContent(OB.I18N.getLabel('OBPOS_warehouseSelected',[inEvent.warehousename,inEvent.warehouseqty]));this.warehouse=inEvent;},loadDefaultWarehouseData:function(defaultWarehouse){if(defaultWarehouse){this.bodyComponent.$.warehouseToGet.setContent(OB.I18N.getLabel('OBPOS_warehouseSelected',[defaultWarehouse.get('warehousename'),defaultWarehouse.get('warehouseqty')]));}else{this.bodyComponent.$.warehouseToGet.setContent(OB.I18N.getLabel('OBPOS_warehouseSelected',[OB.MobileApp.model.get('warehouses')[0].warehousename,'0']));}},getStoreStock:function(){var serverCallStoreDetailedStock=new OB.DS.Process('org.openbravo.retail.posterminal.stock.StoreDetailedStock'),me=this;this.bodyComponent.$.stockHere.setContent(OB.I18N.getLabel('OBPOS_loadingStock'));serverCallStoreDetailedStock.exec({organization:OB.MobileApp.model.get('terminal').organization,product:this.product.get('id')},function(data){if(data&&data.exception){me.bodyComponent.$.stockHere.setContent(OB.I18N.getLabel('OBPOS_stockCannotBeRetrieved'));me.bodyComponent.$.stockHere.addClass('error');}else if(data.product===me.product.get('id')&&me.showing){if(data.qty||data.qty===0){data.product=me.product;me.localStockModel=new OB.OBPOSPointOfSale.UsedModels.LocalStock(data);if(me.localStockModel.get('warehouses').at(0)){if(me.warehouse.warehouseid){me.loadDefaultWarehouseData(me.localStockModel.getWarehouseById(me.warehouse.warehouseid));}else{me.loadDefaultWarehouseData(me.localStockModel.getWarehouseById(me.warehouse.id));}}
me.bodyComponent.$.stockHere.removeClass('error');me.bodyComponent.$.stockHere.setContent(OB.I18N.getLabel('OBPOS_storeStock')+data.qty);}}});},getOtherStock:function(){var serverCallStoreDetailedStock=new OB.DS.Process('org.openbravo.retail.posterminal.stock.OtherStoresDetailedStock'),me=this;if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){this.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_otherStoresStock_NotCalculated'));}else{this.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_loadingStock'));serverCallStoreDetailedStock.exec({organization:OB.MobileApp.model.get('terminal').organization,product:this.product.get('id')},function(data){if(data&&data.exception){me.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_stockCannotBeRetrieved'));me.bodyComponent.$.stockOthers.addClass('error');}else if(data.product===me.product.get('id')&&me.showing&&(data.qty||data.qty===0)){data.product=me.product;me.otherStoresStockModel=new OB.OBPOSPointOfSale.UsedModels.OtherStoresWarehousesStock(data);me.bodyComponent.$.stockOthers.removeClass('error');me.bodyComponent.$.stockOthers.setContent(OB.I18N.getLabel('OBPOS_otherStoresStock')+data.qty);}});}},beforeSetShowing:function(params){if(!params.product||OB.MobileApp.model.get('warehouses').length===0){this.doShowPopup({popup:'modalConfigurationRequiredForCrossStore'});return false;}
this.line=params.line||null;this.product=params.product;this.localStockModel=null;this.otherStoresStockModel=null;if(params.warehouse){this.warehouse=params.warehouse;if(this.warehouse&&this.warehouse.id){this.warehouse.warehouseid=this.warehouse.id;}}else{this.warehouse=OB.MobileApp.model.get('warehouses')[0];}
this.headerComponent.$.productName.setContent(params.product.get('_identifier')+' ('+params.product.get('uOMsymbol')+')');if(OB.MobileApp.model.get('permissions')["OBPOS_retail.productImages"]){this.bodyComponent.$.productImage.applyStyle('background-image','url('+OB.UTIL.getImageURL(params.product.get('id'))+'), url('+"../org.openbravo.mobile.core/assets/img/box.png"+')');}else{this.bodyComponent.$.productImage.applyStyle('background-image','url(data:image/png;base64,'+params.product.get('img')+')');}
this.bodyComponent.$.warehouseToGet.setContent(OB.I18N.getLabel('OBPOS_loadingFromWarehouse',[this.warehouse.warehousename]));this.bodyComponent.$.productPrice.setContent(OB.I18N.getLabel('OBPOS_priceInfo')+'<b>'+OB.I18N.formatCurrency(params.product.get('standardPrice'))+'</b>');this.bodyComponent.$.descriptionArea.setContent(params.product.get('description'));this.bodyComponent.$.productAddToReceipt.setLabel();this.getOtherStock();this.getStoreStock();return true;},header:{kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView_header',name:'header'},body:{kind:'OB.OBPOSPointOfSale.UI.ProductDetailsView_body',name:'body'}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LeftToolbarButton',tag:'li',classes:'span4',components:[{name:'theButton',attributes:{style:'margin: 0px 5px 0px 5px;'}}],initComponents:function(){this.inherited(arguments);this.$.theButton.createComponent(this.button);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LeftToolbar',classes:'span3',components:[{tag:'ul',classes:'unstyled nav-pos row-fluid',name:'toolbar'}],initComponents:function(){this.inherited(arguments);enyo.forEach(this.buttons,function(btn){this.$.toolbar.createComponent({kind:'OB.OBPOSPointOfSale.UI.LeftToolbarButton',button:btn});},this);}});enyo.kind({name:'OB.UI.ButtonNew',kind:'OB.UI.ToolbarButton',icon:'btn-icon btn-icon-new',events:{onAddNewOrder:''},handlers:{onLeftToolbarDisabled:'disabledButton',calculatingReceipt:'disableButton',calculatedReceipt:'enableButton'},disableButton:function(){if(!this.model.get('leftColumnViewManager').isMultiOrder()){this.isEnabled=false;this.setDisabled(true);}},enableButton:function(){if(!this.model.get('leftColumnViewManager').isMultiOrder()){if(OB.UTIL.isNullOrUndefined(OB.MobileApp.model.get('serviceSearchMode'))||!OB.MobileApp.model.get('serviceSearchMode')){this.isEnabled=true;this.setDisabled(false);}}},disabledButton:function(inSender,inEvent){this.isEnabled=inEvent.disableButtonNew||!inEvent.status;this.setDisabled(inEvent.disableButtonNew||inEvent.status);if(!this.isEnabled){this.removeClass('btn-icon-new');}else{this.addClass('btn-icon-new');}},init:function(model){this.model=model;},tap:function(){var me=this;OB.UTIL.HookManager.executeHooks('OBPOS_PreCreateNewReceipt',{model:this.model,context:this},function(args){if(!args.cancelOperation){var i;if(me.model.get('leftColumnViewManager').isMultiOrder()){me.model.deleteMultiOrderList();me.model.get('multiOrders').resetValues();me.model.get('leftColumnViewManager').setOrderMode();}else{if(OB.MobileApp.model.get('permissions')['OBPOS_print.suspended']&&this.model.get('order').get('lines').length!==0){me.model.get('order').trigger('print');}}
me.doAddNewOrder();OB.UTIL.HookManager.executeHooks('OBPOS_PostAddNewReceipt',{model:me.model,context:me},function(){});return true;}});}});enyo.kind({name:'OB.UI.ButtonDelete',kind:'OB.UI.ToolbarButton',icon:'btn-icon btn-icon-delete',events:{onShowPopup:'',onDeleteOrder:''},handlers:{onLeftToolbarDisabled:'disabledButton',calculatingReceipt:'disableButton',calculatedReceipt:'enableButton'},disableButton:function(){this.isEnabled=false;this.setDisabled(true);},enableButton:function(){if(OB.UTIL.isNullOrUndefined(OB.MobileApp.model.get('serviceSearchMode'))||!OB.MobileApp.model.get('serviceSearchMode')){this.isEnabled=true;this.setDisabled(false);}},disabledButton:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled){this.removeClass('btn-icon-delete');}else{this.addClass('btn-icon-delete');}},updateDisabled:function(isDisabled){this.isEnabled=!isDisabled;this.setDisabled(isDisabled);if(!this.isEnabled){this.removeClass('btn-icon-delete');}else{this.addClass('btn-icon-delete');}},tap:function(){var i,me=this;if(me.model.get('leftColumnViewManager').isMultiOrder()){me.model.deleteMultiOrderList();me.model.get('multiOrders').resetValues();me.model.get('leftColumnViewManager').setOrderMode();return true;}
if(me.hasClass('paidticket')){me.doDeleteOrder();}else{if(OB.MobileApp.model.hasPermission('OBPOS_approval.removereceipts',true)){me.doShowPopup({popup:'modalConfirmReceiptDelete'});}else{OB.UTIL.Approval.requestApproval(this.model,'OBPOS_approval.removereceipts',function(approved){if(approved){me.doDeleteOrder({notSavedOrder:true});}});}}},init:function(model){this.model=model;this.model.get('leftColumnViewManager').on('multiorder',function(){this.addClass('paidticket');return true;},this);this.model.get('leftColumnViewManager').on('order',function(){this.removeClass('paidticket');if(this.model.get('order').get('isPaid')||this.model.get('order').get('isLayaway')||(this.model.get('order').get('isQuotation')&&this.model.get('order').get('hasbeenpaid')==='Y')){this.addClass('paidticket');}
this.bubble('onChangeTotal',{newTotal:this.model.get('order').getTotal()});},this);this.model.get('order').on('change:isPaid change:isQuotation change:isLayaway change:hasbeenpaid',function(changedModel){if(changedModel.get('isPaid')||changedModel.get('isLayaway')||(changedModel.get('isQuotation')&&changedModel.get('hasbeenpaid')==='Y')){this.addClass('paidticket');return;}
this.removeClass('paidticket');},this);this.model.get('order').on('showDiscount',function(model){this.updateDisabled(true);},this);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonTabPayment',kind:'OB.UI.ToolbarButtonTab',tabPanel:'payment',handlers:{onChangedTotal:'renderTotal',onRightToolbarDisabled:'disabledButton',synchronizing:'disableButton',synchronized:'enableButton'},isEnabled:true,disabledButton:function(inSender,inEvent){if(inEvent.exceptionPanel===this.tabPanel){return true;}
this.isEnabled=!inEvent.status;this.disabledChanged(inEvent.status);},disableButton:function(){this.disabledChanged(true);},enableButton:function(){this.disabledChanged(false);},disabledChanged:function(isDisabled){var requirements,me=this;function requirementsAreMet(model){requirements={isSynchronized:undefined,isModel:undefined,isReceipt:undefined,receiptId:undefined,receiptDocno:undefined,isReceiptDocnoLengthGreaterThanThree:undefined,isReceiptBp:undefined,receiptBpId:undefined,isReceiptLines:undefined,isReceiptLinesLengthGreaterThanZero:undefined,isReceiptHasbeenpaidEqualToN:undefined,isToolbarEnabled:undefined,isDisabledRequest:undefined};requirements.isDisabledRequest=isDisabled;if(requirements.isDisabledRequest){return false;}
requirements.isToolbarEnabled=me.isEnabled;if(!requirements.isToolbarEnabled){return false;}
requirements.isSynchronized=OB.UTIL.SynchronizationHelper.isSynchronized();if(!requirements.isSynchronized){return false;}
requirements.isModel=!OB.UTIL.isNullOrUndefined(model);if(!requirements.isModel){return false;}
var receipt=model.get('order');requirements.isReceipt=!OB.UTIL.isNullOrUndefined(receipt);if(!requirements.isReceipt){return false;}
requirements.receiptId=receipt.get('id');requirements.receiptDocno=receipt.get('documentNo');requirements.isReceiptBp=!OB.UTIL.isNullOrUndefined(receipt.get('bp'));requirements.isReceiptLines=!OB.UTIL.isNullOrUndefined(receipt.get('lines'));if(OB.UTIL.isNullOrUndefined(requirements.receiptId)||OB.UTIL.isNullOrUndefined(requirements.receiptDocno)||!requirements.isReceiptBp||!requirements.isReceiptLines){return false;}
requirements.receiptBpId=receipt.get('bp').get('id');requirements.isReceiptDocnoLengthGreaterThanThree=receipt.get('documentNo').length>3;requirements.isReceiptLinesLengthGreaterThanZero=receipt.get('lines').length>0;requirements.isReceiptHasbeenpaidEqualToN=receipt.get('hasbeenpaid')==='N';if(OB.UTIL.isNullOrUndefined(requirements.receiptBpId)||!requirements.isReceiptDocnoLengthGreaterThanThree||!requirements.isReceiptLinesLengthGreaterThanZero||!requirements.isReceiptHasbeenpaidEqualToN){return false;}
return true;}
var newIsDisabledState;var discountEdit=this.owner.owner.owner.owner.owner.owner.$.rightPanel.$.toolbarpane?this.owner.owner.owner.owner.owner.owner.$.rightPanel.$.toolbarpane.$.edit.$.editTabContent.$.discountsEdit.showing:false;if(requirementsAreMet(this.model)){newIsDisabledState=false;this.$.totalPrinter.show();this.$.totalPrinter.addStyles('color: white!important;');}else{newIsDisabledState=true;if(discountEdit){this.$.totalPrinter.hide();}else if(OB.MobileApp.model.get('serviceSearchMode')){this.$.totalPrinter.addStyles('color: black!important;');}}
OB.UTIL.Debug.execute(function(){if(!requirements){throw"The 'requirementsAreMet' function must have been called before this point";}});var msg=enyo.format("Pay button is %s",(newIsDisabledState?'disabled':'enabled'));if(newIsDisabledState===true&&requirements.isReceiptLinesLengthGreaterThanZero&&requirements.isReceiptHasbeenpaidEqualToN){msg+=" and should be enabled";OB.error(msg,requirements);OB.UTIL.Debug.execute(function(){throw msg;});}else{OB.debug(msg,requirements);}
this.disabled=newIsDisabledState;this.setAttribute('disabled',newIsDisabledState);},events:{onTabChange:'',onClearUserInput:'',onShowPopup:''},showPaymentTab:function(){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('showPaymentTab');var receipt=this.model.get('order'),me=this;if(receipt.get('isQuotation')){if(receipt.get('hasbeenpaid')!=='Y'){receipt.set('isEditable',false);receipt.prepareToSend(function(){receipt.trigger('closed',{callback:function(){if(receipt.get('isQuotation')){if(!(receipt.get('oldId')&&receipt.get('oldId').length>0)){receipt.set('oldId',receipt.get('id'));}
receipt.set('isbeingprocessed','N');}
if(OB.MobileApp.model.get('permissions')['OBPOS_print.quotation']){receipt.trigger('print');}
receipt.trigger('scan');OB.MobileApp.model.orderList.synchronizeCurrentOrder();}});});}else{receipt.prepareToSend(function(){receipt.trigger('scan');OB.UTIL.showError(OB.I18N.getLabel('OBPOS_QuotationClosed'));});}
OB.UTIL.SynchronizationHelper.finished(synchId,'showPaymentTab');return;}
if(this.model.get('order').get('isEditable')===false&&!this.model.get('order').get('isLayaway')){OB.UTIL.SynchronizationHelper.finished(synchId,'showPaymentTab');return true;}
if(this.model.get('order').get('orderType')===3){me.doTabChange({tabPanel:me.tabPanel,keyboard:'toolbarpayment',edit:false});}
OB.MobileApp.view.scanningFocus(false);if(this.model.get('leftColumnViewManager').isMultiOrder()){this.model.get('multiOrders').trigger('displayTotal');}else{receipt.trigger('displayTotal');}
me.doTabChange({tabPanel:me.tabPanel,keyboard:'toolbarpayment',edit:false});me.bubble('onShowColumn',{colNum:1});OB.UTIL.SynchronizationHelper.finished(synchId,'showPaymentTab');},tap:function(){var me=this,criteria={};if(this.disabled===false){if(this.model.get('order').get('orderType')===3){this.showPaymentTab();return;}
var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('toolbarButtonTabTap');this.model.on('approvalChecked',function(event){this.model.off('approvalChecked');if(event.approved){this.showPaymentTab();}},this);if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){criteria.remoteFilters=[];criteria.remoteFilters.push({columns:[],operator:OB.Dal.FILTER,value:'Final_Services',params:[]});criteria.remoteFilters.push({columns:['ispack'],operator:'equals',value:false,fieldType:'forceString'});}else{criteria.productType='S';criteria.proposalType='FMA';}
OB.Dal.find(OB.Model.Product,criteria,function(data){if(data&&data.length>0){me.model.get('order').trigger('showProductList',null,'final',function(){me.model.completePayment();me.doClearUserInput();});}else{me.model.completePayment(this);me.doClearUserInput();}
OB.UTIL.SynchronizationHelper.finished(synchId,'toolbarButtonTabTap');},function(trx,error){me.model.completePayment(this);me.doClearUserInput();OB.UTIL.SynchronizationHelper.finished(synchId,'toolbarButtonTabTap');});}},attributes:{style:'text-align: center; font-size: 30px;'},components:[{style:'font-weight: bold; margin: 0px 5px 0px 0px;',kind:'OB.UI.Total',name:'totalPrinter'}],getLabel:function(){return this.$.totalPrinter.getContent();},initComponents:function(){this.inherited(arguments);this.removeClass('btnlink-gray');},renderTotal:function(inSender,inEvent){this.$.totalPrinter.renderTotal(inEvent.newTotal);this.disabledChanged(false);},init:function(model){this.model=model;this.model.get('order').on('change:isEditable change:isLayaway',function(newValue){if(newValue){if(newValue.get('isEditable')===false&&!newValue.get('isLayaway')){this.tabPanel=null;this.disabledChanged(true);return;}}
this.tabPanel='payment';this.disabledChanged(false);},this);this.model.get('order').on('change:id',function(){this.disabledChanged(false);},this);this.setDisabled(true);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LeftToolbarImpl',kind:'OB.UI.MultiColumn.Toolbar',menuEntries:[],buttons:[{kind:'OB.UI.ButtonNew',span:3},{kind:'OB.UI.ButtonDelete',span:3},{kind:'OB.OBPOSPointOfSale.UI.ButtonTabPayment',name:'btnTotalToPay',span:6}],initComponents:function(){this.menuEntries.push({kind:'OB.UI.MenuReturn'});this.menuEntries.push({kind:'OB.UI.MenuVoidLayaway'});this.menuEntries.push({kind:'OB.UI.MenuReceiptLayaway'});this.menuEntries.push({kind:'OB.UI.MenuProperties'});this.menuEntries.push({kind:'OB.UI.MenuInvoice'});this.menuEntries.push({kind:'OB.UI.MenuPrint'});this.menuEntries.push({kind:'OB.UI.MenuLayaway'});this.menuEntries.push({kind:'OB.UI.MenuCustomers'});this.menuEntries.push({kind:'OB.UI.MenuPaidReceipts'});this.menuEntries.push({kind:'OB.UI.MenuQuotations'});this.menuEntries.push({kind:'OB.UI.MenuOpenDrawer'});this.menuEntries.push({kind:'OB.UI.MenuSeparator',name:'sep1'});this.menuEntries.push({kind:'OB.UI.MenuDiscounts'});this.menuEntries.push({kind:'OB.UI.MenuSeparator',name:'sep2'});this.menuEntries.push({kind:'OB.UI.MenuReactivateQuotation'});this.menuEntries.push({kind:'OB.UI.MenuRejectQuotation'});this.menuEntries.push({kind:'OB.UI.MenuCreateOrderFromQuotation'});this.menuEntries.push({kind:'OB.UI.MenuQuotation'});this.menuEntries.push({kind:'OB.UI.MenuLayaways'});this.menuEntries.push({kind:'OB.UI.MenuMultiOrders'});this.menuEntries.push({kind:'OB.UI.MenuSeparator',name:'sep3'});this.menuEntries.push({kind:'OB.UI.MenuBackOffice'});this.menuEntries=_.uniq(this.menuEntries,false,function(p){return p.kind+p.name;});this.inherited(arguments);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.RightToolbarImpl',published:{receipt:null},events:{onShowMultiSelection:''},handlers:{onTabButtonTap:'tabButtonTapHandler'},lastSelectedTabPanel:'',tabButtonTapHandler:function(inSender,inEvent){if(inEvent.tabPanel){this.setTabButtonActive(inEvent.tabPanel);if(this.lastSelectedTabPanel!==inEvent.tabPanel){this.lastSelectedTabPanel=inEvent.tabPanel;if(inEvent.tabPanel==='edit'){this.doShowMultiSelection({show:true});}else{this.doShowMultiSelection({show:false});}}}},setTabButtonActive:function(tabName){var buttonContainerArray=this.$.toolbar.getComponents(),i;for(i=0;i<buttonContainerArray.length;i++){buttonContainerArray[i].removeClass('active');if(buttonContainerArray[i].getComponents()[0].getComponents()[0].tabToOpen===tabName){buttonContainerArray[i].addClass('active');}}},manualTap:function(tabName,options){var tab,defaultTab;function getButtonByName(name,me){var componentArray=me.$.toolbar.getComponents(),i;for(i=0;i<componentArray.length;i++){if(componentArray[i].$.theButton.getComponents()[0].tabToOpen===name&&componentArray[i].$.theButton.getComponents()[0].showing){return componentArray[i].$.theButton.getComponents()[0];}}
return null;}
tab=getButtonByName(tabName,this);if(options){options.isManual=true;}else{options={isManual:true};}
if(tab){tab.tap(options);}else{defaultTab=_.find(this.$.toolbar.getComponents(),function(component){if(component.button.defaultTab){return component;}}).$.theButton.getComponents()[0];defaultTab.tap(options);}},kind:'OB.UI.MultiColumn.Toolbar',buttons:[{kind:'OB.OBPOSPointOfSale.UI.ButtonTabScan',name:'toolbarBtnScan',tabToOpen:'scan',defaultTab:true},{kind:'OB.OBPOSPointOfSale.UI.ButtonTabBrowse',name:'toolbarBtnCatalog',tabToOpen:'catalog'},{kind:'OB.OBPOSPointOfSale.UI.ButtonTabSearchCharacteristic',name:'toolbarBtnSearchCharacteristic',tabToOpen:'searchCharacteristic'},{kind:'OB.OBPOSPointOfSale.UI.ButtonTabEditLine',name:'toolbarBtnEdit',tabToOpen:'edit'}],receiptChanged:function(){var totalPrinterComponent;this.receipt.on('clear',function(){this.waterfall('onChangeTotal',{newTotal:this.receipt.getTotal()});if(this.receipt.get('isEditable')===false){this.manualTap('edit');}else{this.manualTap(OB.MobileApp.model.get('terminal').defaultwebpostab);}},this);this.receipt.on('scan',function(params){if(OB.MobileApp.model.get('lastPaneShown')!=='scan'){this.manualTap('scan',params);}},this);this.receipt.get('lines').on('click',function(){this.manualTap('edit');},this);if(this.receipt.get('orderType')!==3){this.bubble('onChangeTotal',{newTotal:this.receipt.getTotal()});}
this.receipt.on('change:gross',function(model){if(this.receipt.get('orderType')!==3){this.bubble('onChangeTotal',{newTotal:this.receipt.getTotal()});}},this);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.RightToolbarButton',tag:'li',components:[{name:'theButton',attributes:{style:'margin: 0px 5px 0px 5px;'}}],initComponents:function(){this.inherited(arguments);if(this.button.containerCssClass){this.setClassAttribute(this.button.containerCssClass);}
this.$.theButton.createComponent(this.button);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonTabScan',kind:'OB.UI.ToolbarButtonTab',tabPanel:'scan',i18nLabel:'OBMOBC_LblScan',events:{onTabChange:'',onRightToolbarDisabled:''},handlers:{onRightToolbarDisabled:'disabledButton'},init:function(model){this.model=model;},disabledButton:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled){this.$.lbl.hide();}else{this.$.lbl.show();}},tap:function(options){if(!this.disabled){this.doTabChange({tabPanel:this.tabPanel,keyboard:'toolbarscan',edit:false,options:options,status:''});}
OB.MobileApp.view.scanningFocus(true);return true;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonTabBrowse',kind:'OB.UI.ToolbarButtonTab',events:{onTabChange:'',onRightToolbarDisabled:''},handlers:{onRightToolbarDisabled:'disabledButton'},init:function(model){this.model=model;},disabledButton:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled){this.$.lbl.hide();}else{this.$.lbl.show();}},tabPanel:'catalog',i18nLabel:'OBMOBC_LblBrowse',tap:function(){if(!this.disabled){this.doTabChange({tabPanel:this.tabPanel,keyboard:false,edit:false});}
OB.MobileApp.view.scanningFocus(true);},initComponents:function(){this.inherited(arguments);if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){this.hide();}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonTabSearchCharacteristic',kind:'OB.UI.ToolbarButtonTab',tabPanel:'searchCharacteristic',i18nLabel:'OBPOS_LblSearch',events:{onTabChange:'',onRightToolbarDisabled:''},handlers:{onRightToolbarDisabled:'disabledButton'},init:function(model){this.model=model;},disabledButton:function(inSender,inEvent){this.isEnabled=!inEvent.status;this.setDisabled(inEvent.status);if(!this.isEnabled&&!OB.MobileApp.model.get('serviceSearchMode')){this.$.lbl.hide();}else{this.$.lbl.show();}},tap:function(){if(this.disabled===false){OB.UI.SearchProductCharacteristic.prototype.filtersCustomClear();this.doTabChange({tabPanel:this.tabPanel,keyboard:false,edit:false});OB.MobileApp.view.scanningFocus(true);}},initComponents:function(){this.inherited(arguments);if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){this.owner.owner.setStyle('width: 50% !important;');}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonTabEditLine',published:{ticketLines:null},kind:'OB.UI.ToolbarButtonTab',tabPanel:'edit',i18nLabel:'OBPOS_LblEdit',events:{onTabChange:'',onRightToolbarDisabled:'',onDisableUserInterface:'',onEnableUserInterface:'',onFinishServiceProposal:'',onToggleLineSelection:'',onShowActionIcons:''},handlers:{onRightToolbarDisabled:'disabledButton',onManageServiceProposal:'manageServiceProposal'},init:function(model){this.model=model;this.model.get('order').get('lines').on('selected',function(lineSelected){this.currentLine=lineSelected;},this);},disabledButton:function(inSender,inEvent){this.setDisabled(inEvent.status);},manageServiceProposal:function(inSender,inEvent){OB.MobileApp.model.set('serviceSearchMode',inEvent.proposalType);this.previousStatus=inEvent.previousStatus;this.$.lbl.setContent(OB.I18N.getLabel('OBPOS_LblContinue'));this.doDisableUserInterface();this.setDisabled(false);this.doShowActionIcons({show:false});},tap:function(options){if(OB.MobileApp.model.get('serviceSearchMode')){this.$.lbl.setContent(OB.I18N.getLabel('OBPOS_LblEdit'));this.doEnableUserInterface();this.doShowActionIcons({show:true});this.doToggleLineSelection({status:false});if(OB.MobileApp.model.get('serviceSearchMode')==='mandatory'){this.restoreStatus();}else if(OB.MobileApp.model.get('serviceSearchMode')==='final'){this.previousStatus.callback();}
OB.MobileApp.model.unset('serviceSearchMode');}else{if(!options.isManual){var lines=this.model.get('order').get('lines');var lastLine;if(lines&&lines.length>0){lastLine=lines.models[lines.length-1];}
if(this.currentLine){this.currentLine.trigger('selected',this.currentLine);}else if(lastLine){lastLine.trigger('selected',lastLine);}}
if(!this.disabled){this.doTabChange({tabPanel:this.tabPanel,keyboard:'toolbarscan',edit:true});}
OB.MobileApp.view.scanningFocus(true);}},restoreStatus:function(){if(this.previousStatus.tab==='scan'||this.previousStatus.tab==='edit'){this.doTabChange({tabPanel:this.previousStatus.tab,keyboard:'toolbarscan'});}else if(this.previousStatus.tab==='catalog'){this.doTabChange({tabPanel:this.previousStatus.tab});}else{this.doTabChange({tabPanel:this.previousStatus.tab});this.doFinishServiceProposal({status:this.previousStatus});}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.RightToolbarPane',published:{model:null},classes:'postab-content',handlers:{onTabButtonTap:'tabButtonTapHandler'},components:[{kind:'OB.OBPOSPointOfSale.UI.TabScan',name:'scan'},{kind:'OB.OBPOSPointOfSale.UI.TabBrowse',name:'catalog'},{kind:'OB.OBPOSPointOfSale.UI.TabSearchCharacteristic',name:'searchCharacteristic',style:'margin: 5px'},{kind:'OB.OBPOSPointOfSale.UI.TabPayment',name:'payment'},{kind:'OB.OBPOSPointOfSale.UI.TabEditLine',name:'edit'}],tabButtonTapHandler:function(inSender,inEvent){if(inEvent.tabPanel){this.showPane(inEvent.tabPanel,inEvent.options);}},showPane:function(tabName,options){OB.MobileApp.model.set('lastPaneShown','unknown');var paneArray=this.getComponents(),i;for(i=0;i<paneArray.length;i++){paneArray[i].removeClass('active');if(paneArray[i].name===tabName){if(paneArray[i].executeOnShow){paneArray[i].executeOnShow(options);}
paneArray[i].addClass('active');OB.MobileApp.model.set('lastPaneShown',tabName);}}},modelChanged:function(){var receipt=this.model.get('order');this.$.scan.setReceipt(receipt);this.$.searchCharacteristic.setReceipt(receipt);this.$.payment.setReceipt(receipt);this.$.edit.setReceipt(receipt);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.TabSearchCharacteristic',kind:'OB.UI.TabPane',published:{receipt:null},components:[{kind:'OB.UI.SearchProductCharacteristic',name:'searchCharacteristicTabContent'}],receiptChanged:function(){this.$.searchCharacteristicTabContent.setReceipt(this.receipt);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.TabBrowse',kind:'OB.UI.TabPane',components:[{kind:'OB.UI.ProductBrowser',name:'catalogTabContent'}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.TabScan',kind:'OB.UI.TabPane',published:{receipt:null},components:[{kind:'OB.OBPOSPointOfSale.UI.Scan',name:'scanTabContent'}],receiptChanged:function(){this.$.scanTabContent.setReceipt(this.receipt);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.TabEditLine',kind:'OB.UI.TabPane',published:{receipt:null},components:[{kind:'OB.OBPOSPointOfSale.UI.EditLine',name:'editTabContent'}],receiptChanged:function(){this.$.editTabContent.setReceipt(this.receipt);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.TabPayment',kind:'OB.UI.TabPane',published:{receipt:null},components:[{kind:'OB.OBPOSPointOfSale.UI.Payment',name:'paymentTabContent'}],receiptChanged:function(){this.$.paymentTabContent.setReceipt(this.receipt);},executeOnShow:function(options){var me=this;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.InDevHeader',showing:false,handlers:{onInDevHeaderShow:'doShowHeader'},events:{onShowPopup:''},doShowHeader:function(inSender,inEvent){this.show();},components:[{name:'innerDiv',style:'text-align: center; font-size: 30px; padding: 5px; padding-top: 0px;',components:[{name:'headerText',kind:'OB.UI.SmallButton',classes:'span12 '+(OB.UTIL.Debug.isDebug()&&OB.UTIL.Debug.getDebugCauses().isTestEnvironment?'btnlink-orange':'btnlink-red'),style:'  height: 50px; margin: 5px 5px 0px 0px; font-size: 20px; cursor: pointer; font-weight: bold',tap:function(){this.owner.doShowPopup({popup:'modalModulesInDev'});},content:'',init:function(){if(!OB.UTIL.isHTTPSAvailable()){this.setContent(OB.I18N.getLabel('OBPOS_NonSecureConnection'));}else if(OB.UTIL.Debug.isDebug()){var ifInDevelopment='OBPOS_ModulesInDevelopment';var ifInTestEnvironment='OBPOS_ApplicationInTestEnvironment';var i18nLabel='OBMOBC_Debug';if(OB.UTIL.Debug.getDebugCauses().isInDevelopment){i18nLabel=ifInDevelopment;}else if(OB.UTIL.Debug.getDebugCauses().isTestEnvironment){i18nLabel=ifInTestEnvironment;}
this.setContent(OB.I18N.getLabel(i18nLabel));}}}]}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Scan',published:{receipt:null},components:[{style:'position:relative; background-color: #7da7d9; background-size: cover; color: white; height: 200px; margin: 5px; padding: 5px',components:[{kind:'OB.UI.Clock',classes:'pos-clock'},{components:[{name:'msgwelcome',showing:false,style:'padding: 10px;',components:[{style:'float:right;',name:'msgwelcomeLbl'}]},{name:'msgaction',showing:false,components:[{name:'txtaction',style:'padding: 10px; float: left; width: 320px; line-height: 23px;'},{style:'float: right;',components:[{name:'undobutton',kind:'OB.UI.SmallButton',i18nContent:'OBMOBC_LblUndo',classes:'btnlink-white btnlink-fontblue',tap:function(){var me=this,undoaction=this.undoaction;OB.UTIL.HookManager.executeHooks('OBPOS_PreUndo_'+undoaction,{undoBtn:me,order:OB.MobileApp.model.receipt},function(args){if(!args.cancellation&&me.undoclick){me.undoclick();}
OB.UTIL.HookManager.executeHooks('OBPOS_PostUndo_'+undoaction,{undoBtn:me,order:OB.MobileApp.model.receipt});});},init:function(model){this.model=model;}}]}]},{kind:'OB.OBPOSPointOfSale.UI.InDevHeader',style:'height: 35px;',name:'divInDevHeader'}]}]}],receiptChanged:function(){this.receipt.on('clear change:undo',function(){this.manageUndo();},this);this.manageUndo();},manageUndo:function(){var undoaction=this.receipt.get('undo');if(undoaction){this.$.msgwelcome.hide();this.$.msgaction.show();this.$.txtaction.setContent(undoaction.text);this.$.undobutton.undoaction=undoaction.action;this.$.undobutton.undoclick=undoaction.undo;}else{this.$.msgaction.hide();this.$.msgwelcome.show();this.$.undobutton.undoaction=null;delete this.$.undobutton.undoclick;}},initComponents:function(){this.inherited(arguments);this.$.msgwelcomeLbl.setContent(OB.I18N.getLabel('OBPOS_WelcomeMessage'));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LineProperty',components:[{classes:'row-fluid',style:'clear: both;',components:[{classes:'span4',style:'width: 95px;',name:'propertyLabel'},{classes:'span8',style:'width: 60%;',components:[{tag:'span',name:'propertyValue'}]}]}],render:function(model){if(model){this.$.propertyValue.setContent(model.get(this.propertyToPrint));}else{this.$.propertyValue.setContent('');}},initComponents:function(){this.inherited(arguments);this.$.propertyLabel.setContent(OB.I18N.getLabel(this.I18NLabel));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LinePropertyDiv',components:[{classes:'row-fluid',style:'clear: both;',components:[{classes:'span4',name:'propertyLabel'},{classes:'span8',components:[{tag:'div',name:'propertyValue'}]}]}],render:function(model){if(model){this.$.propertyValue.setContent(model.get(this.propertyToPrint));}else{this.$.propertyValue.setContent('');}},initComponents:function(){this.inherited(arguments);this.$.propertyLabel.setContent(OB.I18N.getLabel(this.I18NLabel));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.EditLine',propertiesToShow:[{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:10,name:'descLine',I18NLabel:'OBPOS_LineDescription',render:function(line){if(line){this.$.propertyValue.setContent(line.get('product').get('_identifier'));}else{this.$.propertyValue.setContent('');}}},{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:20,name:'qtyLine',I18NLabel:'OBPOS_LineQuantity',multiSelection:false,render:function(line){if(line){if(line.get('qty')===0){this.$.propertyValue.setContent(OB.I18N.getLabel('OBPOS_lblMultiSelectQuantity'));}else{this.$.propertyValue.setContent(line.printQty()+(this.multiSelection?" "+OB.I18N.getLabel('OBPOS_lblMultiSelectPerLines'):""));}}else{this.$.propertyValue.setContent('');}}},{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:25,name:'priceStdLine',I18NLabel:'OBPOS_LinePriceStd',render:function(line){if(line){this.$.propertyValue.setContent(OB.I18N.formatCurrency(line.get('product').get('standardPrice')));}else{this.$.propertyValue.setContent('');}}},{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:30,name:'priceLine',I18NLabel:'OBPOS_LinePrice',render:function(line){if(line){if(this.multiSelection){this.$.propertyValue.setContent(line.get('hasPrice')?line.printPrice()+" "+OB.I18N.getLabel('OBPOS_lblMultiSelectPerLines'):OB.I18N.getLabel('OBPOS_lblMultiSelectPrice'));}else{this.$.propertyValue.setContent(line.printPrice());}}else{this.$.propertyValue.setContent('');}}},{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:40,name:'discountedAmountLine',I18NLabel:'OBPOS_LineDiscount',multiSelection:false,render:function(line){if(line){if(this.multiSelection){var lineDisc=line.printDiscount();this.$.propertyValue.setContent(line.get('hasDiscount')?lineDisc+(lineDisc!==''?' '+OB.I18N.getLabel('OBPOS_lblMultiSelectPerLines'):''):OB.I18N.getLabel('OBPOS_lblMultiSelectDiscount'));}else{var discount=line.getTotalAmountOfPromotions();if(discount===0){this.$.propertyValue.setContent('');}else{this.$.propertyValue.setContent(OB.I18N.formatCurrency(discount));}}}else{this.$.propertyValue.setContent('');}}},{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:50,name:'grossLine',I18NLabel:'OBPOS_LineTotal',render:function(line){if(line){if(line.get('editlinetotal')){this.$.propertyValue.setContent(OB.I18N.formatCurrency(line.get('editlinetotal')));}else if(line.get('priceIncludesTax')){this.$.propertyValue.setContent(line.printTotalLine());}else{this.$.propertyValue.setContent(OB.I18N.formatCurrency(line.get('discountedNet')));}}else{this.$.propertyValue.setContent('');}}},{kind:'OB.OBPOSPointOfSale.UI.LineProperty',position:60,name:'warehouseLine',I18NLabel:'OBPOS_LineWarehouse',render:function(line){if(line&&line.get('warehouse')){this.$.propertyValue.setContent(line.get('warehouse').warehousename);}else{this.$.propertyValue.setContent(OB.MobileApp.model.get('warehouses')[0].warehousename);}}}],actionButtons:[{kind:'OB.UI.SmallButton',name:'deleteLine',i18nContent:'OBPOS_ButtonDelete',classes:'btnlink-orange',tap:function(){var me=this,order=this.model.get('order');function callback(){OB.UTIL.HookManager.executeHooks('OBPOS_PostDeleteLine',{order:order,selectedLines:me.owner.owner.selectedModels},function(){order.unset('preventServicesUpdate');order.unset('deleting');order.get('lines').trigger('updateRelations');order.calculateReceipt();enyo.$.scrim.hide();});}
OB.UTIL.HookManager.executeHooks('OBPOS_PreDeleteLine',{order:me.owner.owner.receipt,selectedLines:me.owner.owner.selectedModels},function(){me.owner.owner.receipt.set('undo',null);if(order&&order.get('isQuotation')&&order.get('hasbeenpaid')==='Y'){me.owner.owner.doShowPopup({popup:'modalNotEditableOrder'});return;}
OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.deleteLine',function(approved,supervisor,approvalType){if(approved){order.set('preventServicesUpdate',true);order.set('deleting',true);if(me.owner.owner.selectedModels&&me.owner.owner.selectedModels.length>1){order.deleteLines(me.owner.owner.selectedModels,0,me.owner.owner.selectedModels.length,callback);order.trigger('scan');}else{me.owner.owner.doDeleteLine({line:me.owner.owner.line,callback:callback});}}});});},init:function(model){this.model=model;this.model.get('order').on('change:isPaid change:isLayaway',function(newValue){if(newValue){if(newValue.get('isPaid')===true||newValue.get('isLayaway')===true){this.setShowing(false);return;}}
this.setShowing(true);},this);}},{kind:'OB.UI.SmallButton',i18nContent:'OBPOS_LblDescription',name:'descriptionButton',classes:'btnlink-orange',tap:function(){if(this.owner.owner.receipt.get('isQuotation')&&this.owner.owner.receipt.get('hasbeenpaid')==='Y'){this.owner.owner.doShowPopup({popup:'modalNotEditableOrder'});return;}
this.owner.owner.doEditLine({line:this.owner.owner.line});},init:function(model){this.model=model;this.model.get('order').on('change:isPaid change:isLayaway',function(newValue){if(newValue){if(newValue.get('isPaid')===true||newValue.get('isLayaway')===true){this.setShowing(false);return;}}
this.setShowing(true);},this);}},{kind:'OB.UI.SmallButton',name:'returnLine',i18nContent:'OBPOS_LblReturnLine',permission:'OBPOS_ReturnLine',classes:'btnlink-orange',showing:false,tap:function(){var me=this,approvalNeeded=false,i,j,k,h,line,relatedLine,lineFromSelected,servicesToApprove='',servicesList=[],order=this.owner.owner.receipt;for(i=0;i<this.owner.owner.selectedModels.length;i++){line=this.owner.owner.selectedModels[i];if(line.get('product').get('productType')==='S'&&!line.isReturnable()){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableProduct'),OB.I18N.getLabel('OBPOS_UnreturnableProductMessage',[line.get('product').get('_identifier')]));return;}else{if(line.get('product').get('productType')==='S'){if(line.get('relatedLines')){for(j=0;j<line.get('relatedLines').length;j++){relatedLine=line.get('relatedLines')[j];for(k=0;k<this.owner.owner.selectedModels.length;k++){lineFromSelected=this.owner.owner.selectedModels[k];if(lineFromSelected.id===relatedLine.orderlineId){line.set('notReturnThisLine',true);servicesToApprove+='<br>· '+line.get('product').get('_identifier');servicesList.push(line.get('product'));break;}}
if(k===this.owner.owner.selectedModels.length){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_NotProductSelectedToReturn',[line.get('product').get('_identifier')]));return;}}}else{servicesToApprove+='<br>· '+line.get('product').get('_identifier');servicesList.push(line.get('product'));}
if(!approvalNeeded&&line.get('net')>0){approvalNeeded=true;}}}}
for(i=0;i<order.get('lines').length;i++){line=OB.MobileApp.model.receipt.get('lines').models[i];if(line.get('product').get('productType')==='S'&&!line.isReturnable()){if(line.get('relatedLines')){for(j=0;j<line.get('relatedLines').length;j++){relatedLine=line.get('relatedLines')[j];for(k=0;k<this.owner.owner.selectedModels.length;k++){lineFromSelected=this.owner.owner.selectedModels[k];if(lineFromSelected.id===relatedLine.orderlineId){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableRelatedService'),OB.I18N.getLabel('OBPOS_UnreturnableRelatedServiceMessage',[line.get('product').get('_identifier'),relatedLine.productName]));return;}}}}}else if(line.get('product').get('productType')==='S'&&line.isReturnable()){if(line.get('relatedLines')){for(j=0;j<line.get('relatedLines').length;j++){relatedLine=line.get('relatedLines')[j];for(k=0;k<this.owner.owner.selectedModels.length;k++){lineFromSelected=this.owner.owner.selectedModels[k];if(lineFromSelected.id===relatedLine.orderlineId){for(h=0;h<servicesList.length;h++){if(servicesList[h].id===line.get('product').id){break;}}
if(h===servicesList.length){servicesToApprove+='<br>· '+line.get('product').get('_identifier');servicesList.push(line.get('product'));if(!approvalNeeded&&line.get('net')>0){approvalNeeded=true;}}}}}}}}
function returnLines(){order.set('undo',null);order.set('multipleUndo',true);_.each(me.owner.owner.selectedModels,function(line){if(!line.get('notReturnThisLine')){me.owner.owner.doReturnLine({line:line});}else{line.unset('notReturnThisLine');}});order.set('multipleUndo',null);}
if(approvalNeeded){OB.UTIL.Approval.requestApproval(me.model,[{approval:'OBPOS_approval.returnService',message:'OBPOS_approval.returnService',params:[servicesToApprove]}],function(approved,supervisor,approvalType){if(approved){order.set('notApprove',true);returnLines();order.unset('notApprove');}else{_.each(me.owner.owner.selectedModels,function(line){if(line.get('notReturnThisLine')){line.unset('notReturnThisLine');}});}});}else{returnLines();}},init:function(model){this.model=model;if(OB.MobileApp.model.get('permissions')[this.permission]){this.setShowing(true);}
this.model.get('order').on('change:isPaid change:isLayaway change:isQuotation',function(newValue){if(newValue){if(newValue.get('isPaid')===true||newValue.get('isLayaway')===true||newValue.get('isQuotation')===true){this.setShowing(false);return;}}
if(OB.MobileApp.model.get('permissions')[this.permission]){this.setShowing(true);}},this);}},{kind:'OB.UI.SmallButton',name:'showRelatedServices',classes:'btnlink-orange',style:'width: 45px; background-repeat: no-repeat; background-position: center; color: rgba(0, 0, 0, 0)',content:'-',tap:function(inSender,inEvent){var product=this.owner.owner.line.get('product');if(product){OB.UI.SearchProductCharacteristic.prototype.filtersCustomClear();OB.UI.SearchProductCharacteristic.prototype.filtersCustomAdd(new OB.UI.SearchServicesFilter({text:this.owner.owner.selectedModels.filter(function(line){return line.get('hasRelatedServices');}).map(function(line){return line.get('product').get('_identifier');}).join(', '),productList:this.owner.owner.selectedModels.filter(function(line){return line.get('hasRelatedServices');}).map(function(line){return line.get('product').get('id');}),orderlineList:this.owner.owner.selectedModels.filter(function(line){return line.get('hasRelatedServices');})}));var me=this;setTimeout(function(){me.bubble('onTabChange',{tabPanel:'searchCharacteristic'});me.bubble('onSelectFilter',{});me.owner.owner.selectedModels.filter(function(line){return line.get('hasRelatedServices');}).forEach(function(l){l.set("obposServiceProposed",true);});},1);this.addRemoveClass('iconServices_unreviewed',false);this.addRemoveClass('iconServices_reviewed',true);}}},{kind:'OB.UI.SmallButton',name:'removeDiscountButton',i18nContent:'OBPOS_LblRemoveDiscount',showing:false,classes:'btnlink-orange',tap:function(){_.each(this.owner.owner.selectedModels,function(lineModel){if(lineModel.get('promotions')&&lineModel.get('promotions').length>0){var filtered=_.filter(lineModel.get('promotions'),function(prom){return prom.discountType==='20E4EC27397344309A2185097392D964'||prom.discountType==='D1D193305A6443B09B299259493B272A'||prom.discountType==='8338556C0FBF45249512DB343FEFD280'||prom.discountType==='7B49D8CC4E084A75B7CB4D85A6A3A578';},this);if(filtered.length===lineModel.get('promotions').length){lineModel.unset('promotions');}}});this.hide();this.model.get('order').calculateReceipt();},init:function(model){this.model=model;}},{kind:'OB.OBPOSPointOfSale.UI.EditLine.OpenStockButton',name:'checkStockButton',showing:false}],published:{receipt:null},events:{onDeleteLine:'',onEditLine:'',onReturnLine:'',onShowPopup:'',onShowMultiSelection:'',onReceiptLineSelected:''},handlers:{onCheckBoxBehaviorForTicketLine:'checkBoxBehavior',onToggledLineSelection:'toggleLineSelection',onSetMultiSelected:'setMultiSelected',onHideReturnLineButton:'hideReturnLineButton',onRearrangedEditButtonBar:'rearrangeEditButtonBar'},checkBoxBehavior:function(inSender,inEvent){if(inEvent.status){this.line=null;this.selectedCallbacks=this.receipt.get('lines')._callbacks.selected;this.receipt.get('lines').off('selected');this.render();}else{this.receipt.get('lines')._callbacks.selected=this.selectedCallbacks;if(this.receipt.get('lines').length>0){var line=this.receipt.get('lines').at(0);line.trigger('selected',line);}}},hideReturnLineButton:function(inSender,inEvent){if(inEvent.hide){this.$.actionButtonsContainer.$.returnLine.hide();}else{this.$.actionButtonsContainer.$.returnLine.show();}},rearrangeEditButtonBar:function(line){if(OB.MobileApp.model.get('permissions')[this.$.actionButtonsContainer.$.returnLine.permission]&&!(this.model.get('order').get('isPaid')===true||this.model.get('order').get('isLayaway')===true||this.model.get('order').get('isQuotation')===true)){this.$.actionButtonsContainer.$.returnLine.show();}
if(this.model.get('order').get('orderType')===1||this.model.get('order').get('orderType')===2){this.$.actionButtonsContainer.$.returnLine.hide();}
if(line&&!this.isLineInSelection(line)){return;}
this.$.returnreason.setSelected(0);if(this.line){this.line.off('change',this.render);}
this.line=line;if(this.line){this.line.on('change',this.render,this);}
if(!this.selectedModels||this.selectedModels.length<=1){if(this.model.get('order').get('isEditable')){this.$.actionButtonsContainer.$.descriptionButton.show();}
if(this.line){if((this.line.get('product').get('showstock')||this.line.get('product').get('_showstock'))&&!this.line.get('product').get('ispack')&&OB.MobileApp.model.get('connectedToERP')){this.$.actionButtonsContainer.$.checkStockButton.show();}else{this.$.actionButtonsContainer.$.checkStockButton.hide();}}else{this.$.actionButtonsContainer.$.checkStockButton.hide();}}else{this.$.actionButtonsContainer.$.checkStockButton.hide();this.$.actionButtonsContainer.$.descriptionButton.hide();}
var promotions=false;if(this.selectedModels){_.each(this.selectedModels,function(lineModel){if(lineModel.get('promotions')&&lineModel.get('promotions').length>0){var filtered;filtered=_.filter(lineModel.get('promotions'),function(prom){return prom.discountType==='20E4EC27397344309A2185097392D964'||prom.discountType==='D1D193305A6443B09B299259493B272A'||prom.discountType==='8338556C0FBF45249512DB343FEFD280'||prom.discountType==='7B49D8CC4E084A75B7CB4D85A6A3A578';},this);if(filtered.length===lineModel.get('promotions').length){promotions=true;}}});}
if(promotions){this.$.actionButtonsContainer.$.removeDiscountButton.show();}else{this.$.actionButtonsContainer.$.removeDiscountButton.hide();}
if((!_.isUndefined(line)&&!_.isUndefined(line.get('originalOrderLineId')))||this.model.get('order').get('orderType')===1){this.$.actionButtonsContainer.$.returnLine.hide();}else if(OB.MobileApp.model.get('permissions')[this.$.actionButtonsContainer.$.returnLine.permission]&&!(this.model.get('order').get('isPaid')===true||this.model.get('order').get('isLayaway')===true||this.model.get('order').get('isQuotation')===true)){this.$.actionButtonsContainer.$.returnLine.show();}
if(this.selectedModels&&this.selectedModels.length>0){var proposedServices,existRelatedServices;existRelatedServices=this.selectedModels.filter(function(line){return line.get('hasRelatedServices');}).length===this.selectedModels.length;proposedServices=this.selectedModels.filter(function(line){return!line.get('hasRelatedServices')||line.get('obposServiceProposed');}).length===this.selectedModels.length;if(existRelatedServices){this.$.actionButtonsContainer.$.showRelatedServices.show();if(proposedServices){this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_unreviewed',false);this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_reviewed',true);}else{this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_unreviewed',true);this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_reviewed',false);}}else{this.$.actionButtonsContainer.$.showRelatedServices.hide();}}else if(this.line&&this.line.get('hasRelatedServices')){this.$.actionButtonsContainer.$.showRelatedServices.show();if(this.line.get('obposServiceProposed')){this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_unreviewed',false);this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_reviewed',true);}else{this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_unreviewed',true);this.$.actionButtonsContainer.$.showRelatedServices.addRemoveClass('iconServices_reviewed',false);}}else{this.$.actionButtonsContainer.$.showRelatedServices.hide();}
this.render();},toggleLineSelection:function(inSender,inEvent){if(inEvent.status){this.selectedLine=this.line;this.line=null;this.selectedCallbacks=this.receipt.get('lines')._callbacks.selected;this.clickCallbacks=this.receipt.get('lines')._callbacks.click;this.receipt.get('lines').off('selected');this.receipt.get('lines').off('click');this.render();}else{this.receipt.get('lines')._callbacks.selected=this.selectedCallbacks;this.receipt.get('lines')._callbacks.click=this.clickCallbacks;if(this.receipt.get('lines').length>0){var line=this.selectedLine;line.trigger('selected',line);}}},setMultiSelected:function(inSender,inEvent){if(inEvent.models&&inEvent.models.length>0&&!(inEvent.models[0]instanceof OB.Model.OrderLine)){return;}
this.selectedModels=inEvent.models;if(this.$.linePropertiesContainer.$.priceLine){this.$.linePropertiesContainer.$.priceLine.multiSelection=inEvent.models.length>1;}
if(this.$.linePropertiesContainer.$.qtyLine){this.$.linePropertiesContainer.$.qtyLine.multiSelection=inEvent.models.length>1;}
this.$.linePropertiesContainer.$.discountedAmountLine.multiSelection=inEvent.models.length>1;this.selectedListener(this.selectedModels.length>0?this.selectedModels[0]:undefined);this.render();},isLineInSelection:function(line){var model=_.find(this.selectedModels,function(model){return model.id===line.id;});return model!==undefined;},executeOnShow:function(args){if(args&&args.discounts){this.$.defaultEdit.hide();this.$.discountsEdit.show();this.doShowMultiSelection({show:false});return;}
this.$.defaultEdit.show();this.$.discountsEdit.hide();},components:[{kind:'OB.OBPOSPointOfSale.UI.Discounts',showing:false,name:'discountsEdit'},{name:'defaultEdit',style:'background-color: #ffffff; color: black; height: 200px; margin: 5px; padding: 5px',components:[{name:'msgedit',classes:'row-fluid',showing:false,components:[{name:'actionButtonsContainer',kind:'Scroller',maxHeight:'50px',thumb:true,horizontal:'hidden',classes:'span12',style:'padding: 0px 0px 1px 0px; line-height: 50%;'},{kind:'OB.UI.List',name:'returnreason',classes:'combo',style:'width: 90%; margin-bottom: 2px; margin-left: 2%; height: 30px ',events:{onSetReason:''},handlers:{onchange:'changeReason'},changeReason:function(inSender,inEvent){if(this.children[this.getSelected()].getValue()===''){this.owner.line.unset('returnReason');}else{this.owner.line.set('returnReason',this.children[this.getSelected()].getValue());}},renderHeader:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue('');this.setContent(OB.I18N.getLabel('OBPOS_ReturnReasons'));}}),renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('_identifier'));}}),renderEmpty:'enyo.Control'},{classes:'span12',components:[{classes:'span7',kind:'Scroller',name:'linePropertiesContainer',maxHeight:'134px',thumb:true,horizontal:'hidden',style:'padding: 1% 0px 5px 2%; line-height: 120%; width: 65%;'},{classes:'span3',sytle:'text-align: right',components:[{style:'padding: 2px 10px 10px 10px;',components:[{tag:'div',classes:'image-wrap image-editline',contentType:'image/png',style:'width: 128px; height: 128px',components:[{tag:'img',name:'icon',style:'margin: auto; height: 100%; width: 100%; background-size: contain; background-repeat:no-repeat; background-position:center;'}]},{name:'editlineimage',kind:'OB.UI.Thumbnail',classes:'image-wrap image-editline',width:'105px',height:'105px'}]}]}]},{name:'msgaction',style:'padding: 10px;',components:[{name:'txtaction',style:'float:left;'}]}]}]}],selectedListener:function(line){this.rearrangeEditButtonBar(line);},receiptChanged:function(){this.inherited(arguments);this.line=null;var me=this;this.receipt.on('change:qty',function(){if(me.receipt.get('lines').length===0){me.line=null;me.selectedModels=null;me.render();}},this);this.receipt.get('lines').on('selected',function(lineSelected){if(lineSelected){me.selectedListener(lineSelected);me.doReceiptLineSelected({line:lineSelected});}},this);},render:function(){var me=this,selectedReason;this.inherited(arguments);if(this.line){this.$.msgaction.hide();this.$.msgedit.show();if(OB.MobileApp.model.get('permissions')["OBPOS_retail.productImages"]){if(this.selectedModels&&this.selectedModels.length>1){this.$.icon.applyStyle('background-image','url('+"../org.openbravo.mobile.core/assets/img/box.png"+')');}else{this.$.icon.applyStyle('background-image','url('+OB.UTIL.getImageURL(this.line.get('product').get('id'))+'), url('+"../org.openbravo.mobile.core/assets/img/box.png"+')');}
this.$.editlineimage.hide();}else{if(this.selectedModels&&this.selectedModels.length>1){this.$.editlineimage.setImg(null);}else{this.$.editlineimage.setImg(this.line.get('product').get('img'));}
this.$.icon.parent.hide();}
if(this.line.get('qty')<OB.DEC.Zero){if(!_.isUndefined(this.line.get('returnReason'))){selectedReason=_.filter(this.$.returnreason.children,function(reason){return reason.getValue()===me.line.get('returnReason');})[0];this.$.returnreason.setSelected(selectedReason.getNodeProperty('index'));}
this.$.returnreason.show();this.$.linePropertiesContainer.setMaxHeight("110px");}else{this.$.returnreason.hide();this.$.linePropertiesContainer.setMaxHeight("134px");}}else{this.$.txtaction.setContent(OB.I18N.getLabel('OBPOS_NoLineSelected'));this.$.msgedit.hide();this.$.msgaction.show();if(OB.MobileApp.model.get('permissions')["OBPOS_retail.productImages"]){this.$.icon.applyStyle('background-image','');}else{if(OB.MobileApp.model.get('permissions')["OBPOS_retail.productImages"]){this.$.icon.applyStyle('background-image','');}else{this.$.editlineimage.setImg(null);}}}
if(this.selectedModels&&this.selectedModels.length>1){var i,quantity=this.selectedModels[0].get('qty'),price=this.selectedModels[0].get('price'),priceTotal=OB.DEC.mul(price,quantity),hasPrice=true,hasDiscount=true,disc=OB.DEC.mul(OB.DEC.sub(this.selectedModels[0].get('product').get('standardPrice'),this.selectedModels[0].get('price')),this.selectedModels[0].get('qty')),discount=this.selectedModels[0].getTotalAmountOfPromotions(),warehousename=this.selectedModels[0].get('warehouse')?this.selectedModels[0].get('warehouse').warehousename:'',editlinetotal=this.selectedModels[0].get('priceIncludesTax')?this.selectedModels[0].getTotalLine():this.selectedModels[0].get('discountedNet'),orderLine=this.selectedModels[0].clone();for(i=1;i<this.selectedModels.length;i++){if(price&&price!==this.selectedModels[i].get('price')){hasPrice=false;}
var lineDisc=OB.DEC.mul(OB.DEC.sub(this.selectedModels[i].get('product').get('standardPrice'),this.selectedModels[i].get('price')),this.selectedModels[i].get('qty'));if(lineDisc!==disc){hasDiscount=false;}
if(discount!==this.selectedModels[i].getTotalAmountOfPromotions()){hasDiscount=false;}
var warehouse=this.selectedModels[i].get('warehouse')?this.selectedModels[i].get('warehouse').warehousename:'';if(warehousename!==warehouse){warehousename=OB.I18N.getLabel('OBPOS_lblMultiSelectValues');}
if(quantity!==this.selectedModels[i].get('qty')){quantity=0;}
priceTotal+=this.selectedModels[i].get('price')*this.selectedModels[i].get('qty');editlinetotal=OB.DEC.add(editlinetotal,this.selectedModels[i].get('priceIncludesTax')?this.selectedModels[i].getTotalLine():this.selectedModels[i].get('discountedNet'));}
orderLine.get('product').set('_identifier',OB.I18N.getLabel('OBPOS_lblMultiSelectDescription',[this.selectedModels.length]));orderLine.set('qty',quantity);orderLine.set('_gross',priceTotal);orderLine.set('hasPrice',hasPrice);if(!hasPrice){price=orderLine.get('product').get('standardPrice');}
orderLine.set('price',price);orderLine.set('hasDiscount',hasDiscount);if(hasDiscount){orderLine.set('promotions',[{amt:discount}]);}
if(warehousename!==''){orderLine.set('warehouse',{warehousename:warehousename});}else{orderLine.unset('warehouse');}
this.$.linePropertiesContainer.$.descLine.render(orderLine);if(this.$.linePropertiesContainer.$.qtyLine){this.$.linePropertiesContainer.$.qtyLine.render(orderLine);}
if(this.$.linePropertiesContainer.$.priceLine){this.$.linePropertiesContainer.$.priceLine.render(orderLine);}
this.$.linePropertiesContainer.$.discountedAmountLine.render(orderLine);this.$.linePropertiesContainer.$.warehouseLine.render(orderLine);orderLine.get('product').set('standardPrice',priceTotal);orderLine.set('price',priceTotal);if(!orderLine.get('priceIncludesTax')){orderLine.set('net',priceTotal);}
orderLine.set('editlinetotal',editlinetotal);this.$.linePropertiesContainer.$.grossLine.render(orderLine);}else{enyo.forEach(this.$.linePropertiesContainer.getComponents(),function(compToRender){if(compToRender.kindName.indexOf("enyo.")!==0){compToRender.render(this.line);}},this);}},initComponents:function(){var sortedPropertiesByPosition;this.inherited(arguments);sortedPropertiesByPosition=_.sortBy(this.propertiesToShow,function(comp){return(comp.position?comp.position:(comp.position===0?0:999));});enyo.forEach(sortedPropertiesByPosition,function(compToCreate){this.$.linePropertiesContainer.createComponent(compToCreate);},this);enyo.forEach(this.actionButtons,function(compToCreate){this.$.actionButtonsContainer.createComponent(compToCreate);},this);},init:function(model){this.model=model;this.reasons=new OB.Collection.ReturnReasonList();this.$.returnreason.setCollection(this.reasons);function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackReasons(dataReasons,me){if(me.destroyed){return;}
if(dataReasons&&dataReasons.length>0){me.reasons.reset(dataReasons.models);}else{me.reasons.reset();}}
OB.Dal.find(OB.Model.ReturnReason,null,successCallbackReasons,errorCallback,this);}});enyo.kind({kind:'OB.UI.SmallButton',name:'OB.OBPOSPointOfSale.UI.EditLine.OpenStockButton',events:{onShowLeftSubWindow:''},content:'',classes:'btnlink-orange',tap:function(){var line=this.owner.owner.line;var product=this.owner.owner.line.get('product');var params={};if((product.get('showstock')||product.get('_showstock'))&&!product.get('ispack')&&OB.MobileApp.model.get('connectedToERP')){params.leftSubWindow=OB.OBPOSPointOfSale.UICustomization.stockLeftSubWindow;params.product=product;params.line=line;params.warehouse=this.owner.owner.line.get('warehouse');this.doShowLeftSubWindow(params);}},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_checkStock'));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Payment',published:{receipt:null},events:{onShowPopup:'',onPaymentActionPay:''},handlers:{onButtonStatusChanged:'buttonStatusChanged',onMaxLimitAmountError:'maxLimitAmountError',onButtonPaymentChanged:'paymentChanged',onClearPaymentMethodSelect:'clearPaymentMethodSelect',ontap:'dispalyErrorLabels',onmouseover:'pauseAnimation',onmouseout:'resumeAnimation'},getSelectedPayment:function(){if(this.receipt&&this.receipt.get('selectedPayment')){return this.receipt.get('selectedPayment');}
return null;},setTotalPending:function(pending,mulrate,symbol,currencySymbolAtTheRight,inSender,inEvent){this.$.totalpending.setContent(OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(pending,mulrate),symbol,currencySymbolAtTheRight));},clearPaymentMethodSelect:function(inSender,inEvent){this.$.paymentMethodSelect.setContent('');},buttonStatusChanged:function(inSender,inEvent){this.$.paymentMethodSelect.setContent('');if(inEvent.value.status&&inEvent.value.status.indexOf('paymentMethodCategory.showitems.')===0){this.doShowPopup({popup:'modalPaymentsSelect',args:{idCategory:inEvent.value.status.substring(inEvent.value.status.lastIndexOf('.')+1)}});}else{var payment,change,pending,isMultiOrders,paymentstatus;payment=inEvent.value.payment||OB.MobileApp.model.paymentnames[OB.MobileApp.model.get('paymentcash')];if(_.isUndefined(payment)){return true;}
if(OB.POS.terminal.terminal.paymentnames[inEvent.value.status]){this.bubble('onMaxLimitAmountError',{show:false,maxLimitAmount:0,currency:'',symbolAtRight:true});}
isMultiOrders=this.model.isValidMultiOrderState();change=this.model.getChange();pending=this.model.getPending();if(!isMultiOrders){if(!_.isNull(this.receipt)){this.receipt.set('selectedPayment',payment.payment.searchKey);paymentstatus=this.receipt.getPaymentStatus();}}else{this.model.get('multiOrders').set('selectedPayment',payment.payment.searchKey);paymentstatus=this.model.get('multiOrders').getPaymentStatus();}
if(!_.isNull(change)&&change){this.$.change.setContent(OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(change,payment.mulrate),payment.symbol,payment.currencySymbolAtTheRight));OB.MobileApp.model.set('changeReceipt',OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(change,payment.mulrate),payment.symbol,payment.currencySymbolAtTheRight));}else if(!_.isNull(pending)&&pending){this.setTotalPending(pending,payment.mulrate,payment.symbol,payment.currencySymbolAtTheRight,inSender,inEvent);}
if(paymentstatus&&inEvent.value.status!==""&&!this.receipt.isCalculateReceiptLocked&&!this.receipt.isCalculateGrossLocked){this.checkValidPayments(paymentstatus,payment);}
if(inEvent.value.amount){this.doPaymentActionPay({amount:inEvent.value.amount,key:payment.payment.searchKey,name:payment.payment._identifier,paymentMethod:payment.paymentMethod,rate:payment.rate,mulrate:payment.mulrate,isocode:payment.isocode,options:inEvent.value.options});}}},paymentChanged:function(inSender,inEvent){if(!inEvent.amount){this.$.paymentMethodSelect.setContent(OB.I18N.getLabel('OBPOS_PaymentsSelectedMethod',[inEvent.payment.payment._identifier]));}},maxLimitAmountError:function(inSender,inEvent){var maxHeight;if(inEvent.show){this.$.errorMaxlimitamount.setContent(OB.I18N.getLabel('OBPOS_PaymentMaxLimitAmount',[OB.I18N.formatCurrencyWithSymbol(inEvent.maxLimitAmount,inEvent.currency,inEvent.symbolAtRight)]));this.$.errorMaxlimitamount.show();}else{this.$.errorMaxlimitamount.setContent('');this.$.errorMaxlimitamount.hide();}
this.alignErrorMessages();},components:[{style:'background-color: #363636; color: white; height: 200px; margin: 5px; padding: 5px; position: relative;',components:[{classes:'row-fluid',components:[{classes:'span12'}]},{classes:'row-fluid',components:[{classes:'span9',components:[{style:'padding: 10px 0px 0px 10px; height: 28px;',components:[{tag:'span',name:'totalpending',style:'font-size: 24px; font-weight: bold;'},{tag:'span',name:'totalpendinglbl'},{tag:'span',name:'change',style:'font-size: 24px; font-weight: bold;'},{tag:'span',name:'changelbl'},{tag:'span',name:'overpayment',style:'font-size: 24px; font-weight: bold;'},{tag:'span',name:'overpaymentlbl'},{tag:'span',name:'exactlbl'},{tag:'span',name:'donezerolbl'}]},{components:[{style:'padding: 5px',components:[{style:'margin: 2px 0px 0px 0px; border-bottom: 1px solid #cccccc;'},{kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'115px',style:'height: 115px',name:'payments',renderEmpty:enyo.kind({style:'height: 36px'}),renderLine:'OB.OBPOSPointOfSale.UI.RenderPaymentLine'},{kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'115px',style:'height: 115px',name:'multiPayments',showing:false,renderEmpty:enyo.kind({style:'height: 36px'}),renderLine:'OB.OBPOSPointOfSale.UI.RenderPaymentLine'},{style:'position: absolute; bottom: 20px; height: 20px; font-weight: bold; color:DodgerBlue;',name:'extrainfo'},{style:'overflow: hidden; height: 30px; margin-top: 3px; color: #ff0000; padding: 5px; position: relative;',name:'errorLabelArea',components:[{name:'noenoughchangelbl',showing:false,type:'error'},{name:'overpaymentnotavailable',showing:false,type:'error'},{name:'overpaymentexceedlimit',showing:false,type:'error'},{name:'onlycashpaymentmethod',showing:false,type:'error'},{name:'errorMaxlimitamount',showing:false,type:'error'}]}]}]}]},{classes:'span3',components:[{name:'donebutton',kind:'OB.OBPOSPointOfSale.UI.DoneButton'},{name:'exactbutton',kind:'OB.OBPOSPointOfSale.UI.ExactButton'},{name:'creditsalesaction',kind:'OB.OBPOSPointOfSale.UI.CreditButton'},{name:'layawayaction',kind:'OB.OBPOSPointOfSale.UI.LayawayButton'}]}]},{classes:'span12',components:[{name:'paymentMethodSelect',style:'color: orange; padding-left: 1em'}]}]}],receiptChanged:function(){var me=this;this.$.payments.setCollection(this.receipt.get('payments'));this.$.multiPayments.setCollection(this.model.get('multiOrders').get('payments'));this.receipt.on('change:payment change:change calculategross change:bp change:gross',function(){if(this.receipt.isCalculateReceiptLocked||this.receipt.isCalculateGrossLocked){return;}
this.updatePending();},this);this.model.get('leftColumnViewManager').on('change:currentView',function(){if(!this.model.get('leftColumnViewManager').isMultiOrder()){this.updatePending();}else{this.updatePendingMultiOrders();}},this);this.updatePending();if(this.model.get('leftColumnViewManager').isMultiOrder()){this.updatePendingMultiOrders();}
this.receipt.on('change:orderType change:isLayaway change:payment',function(model){if(this.model.get('leftColumnViewManager').isMultiOrder()){this.updateCreditSalesAction();this.$.layawayaction.hide();return;}
var payment=OB.MobileApp.model.paymentnames[OB.MobileApp.model.get('paymentcash')];if((model.get('orderType')===2||(model.get('isLayaway')))&&model.get('orderType')!==3&&!model.getPaymentStatus().done){this.$.layawayaction.setContent(OB.I18N.getLabel('OBPOS_LblLayaway'));this.$.layawayaction.show();}else if(model.get('orderType')===3){this.$.layawayaction.hide();}else{this.$.layawayaction.hide();}
this.updateCreditSalesAction();},this);this.$.extrainfo.setContent('');this.receipt.on('extrainfo',function(info){this.$.extrainfo.setContent(info||'');},this);},updateCreditSalesAction:function(){var visible=OB.MobileApp.model.get('terminal').allowpayoncredit;visible=visible&&((this.receipt.get('isLayaway')||this.receipt.get('orderType')!==2)&&this.receipt.get('orderType')!==3);visible=visible&&!this.receipt.getPaymentStatus().done;visible=visible&&this.receipt.get('bp')&&(this.receipt.get('bp').get('creditLimit')>0||this.receipt.get('bp').get('creditUsed')<0||this.receipt.getGross()<0);if(visible){this.$.creditsalesaction.show();}else{this.$.creditsalesaction.hide();}},updatePending:function(){if(this.model.get('leftColumnViewManager').isMultiOrder()){return true;}
var paymentstatus=this.receipt.getPaymentStatus();var symbol='',rate=OB.DEC.One,symbolAtRight=true,isCashType=true;if(_.isEmpty(OB.MobileApp.model.paymentnames)){symbol=OB.MobileApp.model.get('terminal').symbol;symbolAtRight=OB.MobileApp.model.get('terminal').currencySymbolAtTheRight;}
if(!_.isUndefined(this.receipt)&&!_.isUndefined(OB.MobileApp.model.paymentnames[this.receipt.get('selectedPayment')])){symbol=OB.MobileApp.model.paymentnames[this.receipt.get('selectedPayment')].symbol;rate=OB.MobileApp.model.paymentnames[this.receipt.get('selectedPayment')].mulrate;symbolAtRight=OB.MobileApp.model.paymentnames[this.receipt.get('selectedPayment')].currencySymbolAtTheRight;isCashType=OB.MobileApp.model.paymentnames[this.receipt.get('selectedPayment')].paymentMethod.iscash;}
this.checkValidPayments(paymentstatus,OB.MobileApp.model.paymentnames[this.receipt.get('selectedPayment')||OB.MobileApp.model.get('paymentcash')]);if(paymentstatus.change){this.$.change.setContent(OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(this.receipt.getChange(),rate),symbol,symbolAtRight));OB.MobileApp.model.set('changeReceipt',OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(this.receipt.getChange(),rate),symbol,symbolAtRight));this.$.change.show();this.$.changelbl.show();}else{this.$.change.hide();this.$.changelbl.hide();}
if(paymentstatus.overpayment){this.$.overpayment.setContent(OB.I18N.formatCurrencyWithSymbol(paymentstatus.overpayment,symbol,symbolAtRight));this.$.overpayment.show();this.$.overpaymentlbl.show();}else{this.$.overpayment.hide();this.$.overpaymentlbl.hide();}
if(paymentstatus.done){this.$.totalpending.hide();this.$.totalpendinglbl.hide();if(!_.isEmpty(OB.MobileApp.model.paymentnames)){this.$.donebutton.show();}
this.updateCreditSalesAction();this.$.layawayaction.hide();}else{this.setTotalPending(this.receipt.getPending(),rate,symbol,symbolAtRight);this.$.totalpending.show();if(paymentstatus.isNegative||this.receipt.get('orderType')===3){this.$.totalpendinglbl.setContent(OB.I18N.getLabel('OBPOS_ReturnRemaining'));}else{this.$.totalpendinglbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsRemaining'));}
this.$.totalpendinglbl.show();this.$.donebutton.hide();if(this.$.donebutton.drawerpreference){this.$.donebutton.setContent(OB.I18N.getLabel('OBPOS_LblOpen'));this.$.donebutton.drawerOpened=false;}}
if(paymentstatus.done||this.receipt.getGross()===0){this.$.exactbutton.hide();this.$.layawayaction.hide();}else{if(!_.isEmpty(OB.MobileApp.model.paymentnames)){this.$.exactbutton.show();}
if(this.receipt.get('orderType')===2||(this.receipt.get('isLayaway')&&this.receipt.get('orderType')!==3)){this.$.layawayaction.show();}else if(this.receipt.get('orderType')===3){this.$.layawayaction.hide();}}
if(paymentstatus.done&&!paymentstatus.change&&!paymentstatus.overpayment){if(this.receipt.getGross()===0){this.$.exactlbl.hide();this.$.donezerolbl.show();}else{this.$.donezerolbl.hide();if(paymentstatus.isNegative||this.receipt.get('orderType')===3){this.$.exactlbl.setContent(OB.I18N.getLabel('OBPOS_ReturnExact'));}else{this.$.exactlbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsExact'));}
this.$.exactlbl.show();}}else{this.$.exactlbl.hide();this.$.donezerolbl.hide();}
this.updateCreditSalesAction();},updatePendingMultiOrders:function(){var paymentstatus=this.model.get('multiOrders');var symbol='',symbolAtRight=true,rate=OB.DEC.One,isCashType=true,selectedPayment;this.$.layawayaction.hide();if(_.isEmpty(OB.MobileApp.model.paymentnames)){symbol=OB.MobileApp.model.get('terminal').symbol;symbolAtRight=OB.MobileApp.model.get('terminal').currencySymbolAtTheRight;}
if(paymentstatus.get('selectedPayment')){selectedPayment=OB.MobileApp.model.paymentnames[paymentstatus.get('selectedPayment')];}else{selectedPayment=OB.MobileApp.model.paymentnames[OB.MobileApp.model.get('paymentcash')];}
if(!_.isUndefined(selectedPayment)){symbol=selectedPayment.symbol;rate=selectedPayment.mulrate;symbolAtRight=selectedPayment.currencySymbolAtTheRight;isCashType=selectedPayment.paymentMethod.iscash;}
this.checkValidPayments(paymentstatus.getPaymentStatus(),selectedPayment);if(paymentstatus.get('change')){this.$.change.setContent(OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(paymentstatus.get('change'),rate),symbol,symbolAtRight));OB.MobileApp.model.set('changeReceipt',OB.I18N.formatCurrencyWithSymbol(OB.DEC.mul(paymentstatus.get('change'),rate),symbol,symbolAtRight));this.$.change.show();this.$.changelbl.show();}else{this.$.change.hide();this.$.changelbl.hide();}
if(OB.DEC.compare(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total')))>0){this.$.overpayment.setContent(OB.I18N.formatCurrency(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total'))));this.$.overpayment.show();this.$.overpaymentlbl.show();}else{this.$.overpayment.hide();this.$.overpaymentlbl.hide();}
if(paymentstatus.get('multiOrdersList').length>0&&OB.DEC.compare(paymentstatus.get('total'))>=0&&OB.DEC.compare(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total')))>=0){this.$.totalpending.hide();this.$.totalpendinglbl.hide();if(!_.isEmpty(OB.MobileApp.model.paymentnames)){this.$.donebutton.show();}
this.updateCreditSalesAction();}else{this.setTotalPending(OB.DEC.sub(paymentstatus.get('total'),paymentstatus.get('payment')),rate,symbol,symbolAtRight);this.$.totalpending.show();this.$.totalpendinglbl.show();this.$.donebutton.hide();if(this.$.donebutton.drawerpreference){this.$.donebutton.setContent(OB.I18N.getLabel('OBPOS_LblOpen'));this.$.donebutton.drawerOpened=false;}}
this.updateCreditSalesAction();this.$.layawayaction.hide();if(paymentstatus.get('multiOrdersList').length>0&&OB.DEC.compare(paymentstatus.get('total'))>=0&&(OB.DEC.compare(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total')))>=0||paymentstatus.get('total')===0)){this.$.exactbutton.hide();}else{if(!_.isEmpty(OB.MobileApp.model.paymentnames)){this.$.exactbutton.show();}}
if(paymentstatus.get('multiOrdersList').length>0&&OB.DEC.compare(paymentstatus.get('total'))>=0&&OB.DEC.compare(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total')))>=0&&!paymentstatus.get('change')&&OB.DEC.compare(OB.DEC.sub(paymentstatus.get('payment'),paymentstatus.get('total')))<=0){if(paymentstatus.get('total')===0){this.$.exactlbl.hide();this.$.donezerolbl.show();}else{this.$.donezerolbl.hide();this.$.exactlbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsExact'));this.$.exactlbl.show();}}else{this.$.exactlbl.hide();this.$.donezerolbl.hide();}},checkEnoughCashAvailable:function(paymentstatus,selectedPayment,scope,callback){var requiredCash,hasEnoughCash,hasAllEnoughCash=true;this.checkSlaveCashAvailable(selectedPayment,this,function(currentCash){if(OB.UTIL.isNullOrUndefined(selectedPayment)||!selectedPayment.paymentMethod.iscash){requiredCash=OB.DEC.Zero;}else if(!_.isUndefined(paymentstatus)&&paymentstatus.isNegative){requiredCash=paymentstatus.pendingAmt;paymentstatus.payments.each(function(payment){var paymentmethod;if(payment.get('kind')===selectedPayment.payment.searchKey){requiredCash=OB.DEC.add(requiredCash,payment.get('origAmount'));}else{paymentmethod=OB.POS.terminal.terminal.paymentnames[payment.get('kind')];if(paymentmethod&&payment.get('amount')>paymentmethod.currentCash&&payment.get('isCash')){hasAllEnoughCash=false;}}});}else if(!_.isUndefined(paymentstatus)){requiredCash=paymentstatus.changeAmt;}
if(!_.isUndefined(requiredCash)&&requiredCash===0){hasEnoughCash=true;}else if(!_.isUndefined(requiredCash)){hasEnoughCash=OB.DEC.compare(OB.DEC.sub(currentCash,requiredCash))>=0;}
if(hasEnoughCash&&hasAllEnoughCash){return callback.call(scope,true);}else{return callback.call(scope,false);}});},checkValidCashOverpayment:function(paymentstatus,selectedPayment){var currentCash=OB.DEC.Zero,requiredCash;if(OB.UTIL.isNullOrUndefined(selectedPayment)||OB.UTIL.isNullOrUndefined(selectedPayment.paymentMethod.overpaymentLimit)){return true;}
requiredCash=paymentstatus.changeAmt;if(requiredCash!==0){if(selectedPayment.paymentMethod.overpaymentLimit===0&&selectedPayment.paymentMethod.overpaymentLimit<requiredCash){this.$.overpaymentnotavailable.show();return false;}else if(selectedPayment.paymentMethod.overpaymentLimit<requiredCash){this.$.overpaymentexceedlimit.show();return false;}else{return true;}}else if(requiredCash===0){return true;}
return true;},checkValidPaymentMethod:function(paymentstatus,payment){var change=this.model.getChange();var check=true;var currentcash=payment.currentCash;var cashIsPresent=false;var alternativeCashPayment;var alternativePaymentInfo;if(change&&change>0){if(!payment.paymentMethod.iscash){if(paymentstatus.payments.size()>1){alternativeCashPayment=_.find(paymentstatus.payments.models,function(item){if(item.get('isCash')){return item;}});if(alternativeCashPayment){alternativePaymentInfo=_.find(OB.MobileApp.model.get('payments'),function(defPayment){if(defPayment.payment.searchKey===alternativeCashPayment.get('kind')){return defPayment;}});}
if(!alternativeCashPayment){check=false;this.$.onlycashpaymentmethod.show();}else if(alternativePaymentInfo&&alternativePaymentInfo.currentCash<change){check=false;this.$.noenoughchangelbl.show();}}else{check=false;this.$.onlycashpaymentmethod.show();}}else{if(currentcash<change){check=false;this.$.noenoughchangelbl.show();}}}
return check;},checkValidPayments:function(paymentstatus,selectedPayment){var resultOK,me=this;if(!selectedPayment){return;}
if(_.isNull(paymentstatus.overpayment)){this.$.overpaymentnotavailable.hide();this.$.overpaymentexceedlimit.hide();}
this.$.noenoughchangelbl.hide();this.$.onlycashpaymentmethod.hide();this.receipt.stopAddingPayments=!_.isEmpty(this.getShowingErrorMessages());resultOK=!selectedPayment.paymentMethod.iscash||paymentstatus.changeAmt>0?this.checkValidCashOverpayment(paymentstatus,selectedPayment):undefined;if(resultOK||_.isUndefined(resultOK)){if(!_.isNull(paymentstatus.change)||(paymentstatus.isNegative&&!_.isNull(paymentstatus.pending))){resultOK=this.checkEnoughCashAvailable(paymentstatus,selectedPayment,this,function(success){var lsuccess=success;if(lsuccess){lsuccess=this.checkValidPaymentMethod(paymentstatus,selectedPayment);}else{this.$.noenoughchangelbl.show();this.$.donebutton.setLocalDisabled(true);this.$.exactbutton.setLocalDisabled(true);}
me.receipt.stopAddingPayments=!_.isEmpty(me.getShowingErrorMessages());this.setStatusButtons(lsuccess);});}else if(!this.receipt.stopAddingPayments){this.$.donebutton.setLocalDisabled(false);this.$.exactbutton.setLocalDisabled(false);}}else{me.receipt.stopAddingPayments=!_.isEmpty(me.getShowingErrorMessages());this.setStatusButtons(resultOK);}
this.alignErrorMessages();},alignErrorMessages:function(){if(OB.MobileApp.view.currentWindow==='retail.pointofsale'&&typeof(this.$.errorLabelArea)!=='undefined'){var me=this,delay=1500;this.errorLabels=this.pushErrorMessagesToArray();this.showingCount=this.getShowingMessagesCount(this.errorLabels);clearInterval(this.maxAnimateErrorInterval);if(this.showingCount>1){me.animateErrorMessages();this.maxAnimateErrorInterval=setInterval(function(){clearInterval(this.animateErrorInterval);me.animateErrorMessages();},delay+1700*this.showingCount);}}},animateErrorMessages:function(){if(OB.MobileApp.view.currentWindow==='retail.pointofsale'&&typeof(this.$.errorLabelArea)!=='undefined'){clearInterval(this.animateErrorInterval);var me=this,marginTop=0,resizediStyle='',initialTop=0,defaultStyle='position: absolute; bottom: 0px; height: 20px; color: #ff0000;';this.errorLabels=this.pushErrorMessagesToArray();this.showingCount=this.getShowingMessagesCount(this.errorLabels);this.firstShowingObject=this.getFirstShowingObject(this.errorLabels);if(this.firstShowingObject&&this.showingCount>1){this.animateErrorInterval=setInterval(function(){marginTop=marginTop-2;this.marginTop=marginTop;resizediStyle='margin-top: '+marginTop+'px';me.firstShowingObject.addStyles(resizediStyle);},100);}
if(this.showingCount===1){defaultStyle='margin-top: '+initialTop+'px';this.firstShowingObject.addStyles(defaultStyle);}}},pushErrorMessagesToArray:function(){var errorLabelArray=[];errorLabelArray.push(this.$.noenoughchangelbl);errorLabelArray.push(this.$.overpaymentnotavailable);errorLabelArray.push(this.$.overpaymentexceedlimit);errorLabelArray.push(this.$.onlycashpaymentmethod);errorLabelArray.push(this.$.errorMaxlimitamount);return errorLabelArray;},getFirstShowingObject:function(errorLabelArray){var showingObj='',i;for(i=0;i<errorLabelArray.length;i++){var arrayContent=errorLabelArray[i];if(arrayContent.showing){showingObj=arrayContent;break;}}
return showingObj;},getShowingMessagesCount:function(errorLabelArray){var count=0,i;for(i=0;i<errorLabelArray.length;i++){var arrayContent=errorLabelArray[i];if(arrayContent.showing){count=count+1;}}
return count;},resumeAnimation:function(inSender,inEvent){if(inEvent.originator.type==='error'){this.alignErrorMessages();}},pauseAnimation:function(inSender,inEvent){if(inEvent.originator.type==='error'){clearInterval(this.maxAnimateErrorInterval);clearInterval(this.animateErrorInterval);inEvent.originator.addStyles(this.marginTop);}},dispalyErrorLabels:function(inSender,inEvent){if(inEvent.originator.type==='error'){var message=this.getShowingErrorMessages();OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_Error'),message);this.alignErrorMessages(false);}},getShowingErrorMessages:function(){var msgToReturn='';var count=0,i;if(this.errorLabels){for(i=0;i<this.errorLabels.length;i++){var arrayContent=this.errorLabels[i];if(arrayContent.showing){count=count+1;msgToReturn=msgToReturn+'\n'+count+')'+arrayContent.content;}}}
return msgToReturn;},setStatusButtons:function(resultOK){if(resultOK){this.$.donebutton.setLocalDisabled(false);this.$.exactbutton.setLocalDisabled(false);}else{if(this.$.overpaymentnotavailable.showing||this.$.overpaymentexceedlimit.showing){this.$.noenoughchangelbl.hide();}else{this.$.noenoughchangelbl.show();}
this.$.donebutton.setLocalDisabled(true);this.$.exactbutton.setLocalDisabled(true);}},checkSlaveCashAvailable:function(selectedPayment,scope,callback){function processCashMgmtMaster(cashMgntCallback){new OB.DS.Process('org.openbravo.retail.posterminal.ProcessCashMgmtMaster').exec({cashUpId:OB.POS.modelterminal.get('terminal').cashUpId,terminalSlave:OB.POS.modelterminal.get('terminal').isslave},function(data){if(data&&data.exception){OB.log('error',data.exception.message);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashMgmtError'),OB.I18N.getLabel('OBPOS_ErrorServerGeneric')+data.exception.message,[{label:OB.I18N.getLabel('OBPOS_LblRetry'),action:function(){processCashMgmtMaster(cashMgntCallback);}}],{autoDismiss:false,onHideFunction:function(){cashMgntCallback(false,null);}});}else{cashMgntCallback(true,data);}});}
var currentCash=OB.DEC.Zero;if(selectedPayment&&selectedPayment.paymentMethod.iscash){currentCash=selectedPayment.currentCash||OB.DEC.Zero;}
if((OB.POS.modelterminal.get('terminal').ismaster||OB.POS.modelterminal.get('terminal').isslave)&&selectedPayment.paymentMethod.iscash&&selectedPayment.paymentMethod.isshared){processCashMgmtMaster(function(success,data){if(success){_.each(data,function(pay){if(pay.searchKey===selectedPayment.payment.searchKey){currentCash=OB.DEC.add(currentCash,pay.startingCash+pay.totalDeposits+pay.totalSales-pay.totalReturns-pay.totalDrops);}});}
callback.call(scope,currentCash);});}else{callback.call(scope,currentCash);}},initComponents:function(){this.inherited(arguments);this.$.errorLabelArea.render();this.$.totalpendinglbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsRemaining'));this.$.changelbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsChange'));this.$.overpaymentlbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsOverpayment'));this.$.exactlbl.setContent(OB.I18N.getLabel('OBPOS_PaymentsExact'));this.$.donezerolbl.setContent(OB.I18N.getLabel('OBPOS_MsgPaymentAmountZero'));this.$.noenoughchangelbl.setContent(OB.I18N.getLabel('OBPOS_NoEnoughCash'));this.$.overpaymentnotavailable.setContent(OB.I18N.getLabel('OBPOS_OverpaymentNotAvailable'));this.$.overpaymentexceedlimit.setContent(OB.I18N.getLabel('OBPOS_OverpaymentExcededLimit'));this.$.onlycashpaymentmethod.setContent(OB.I18N.getLabel('OBPOS_OnlyCashPaymentMethod'));},init:function(model){var me=this;this.model=model;if(_.isEmpty(OB.MobileApp.model.paymentnames)){this.$.donebutton.show();this.$.exactbutton.hide();}
this.model.get('multiOrders').get('multiOrdersList').on('all',function(event){if(this.model.isValidMultiOrderState()){this.updatePendingMultiOrders();}},this);this.model.get('multiOrders').on('change:payment change:total change:change',function(){this.updatePendingMultiOrders();},this);this.model.get('leftColumnViewManager').on('change:currentView',function(changedModel){if(changedModel.isOrder()){this.$.multiPayments.hide();this.$.payments.show();return;}
if(changedModel.isMultiOrder()){this.$.multiPayments.show();this.$.payments.hide();return;}},this);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ProcessButton',kind:'OB.UI.RegularButton',style:'width: 120px; float: right; margin: 5px 5px 10px 0px; height: 2.5em; display:block; clear: right; font-weight: normal; padding: 0px',processdisabled:false,localdisabled:false,setLocalDisabled:function(value){this.localdisabled=value;this.setDisabled(this.processdisabled||this.localdisabled);},initComponents:function(){var me=this;this.inherited(arguments);OB.POS.EventBus.on('UI_Enabled',function(state){me.processdisabled=!state;me.setDisabled(me.processdisabled||me.localdisabled);});me.processdisabled=!OB.POS.EventBus.isProcessEnabled();me.setDisabled(me.processdisabled||me.localdisabled);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.DoneButton',kind:'OB.OBPOSPointOfSale.UI.ProcessButton',handlers:{synchronizing:'isSynchronizing',synchronized:'isSynchronized'},drawerOpened:true,isLocked:true,lasDisabledPetition:true,isSynchronizing:function(){this.isLocked=true;this.setDisabledIfSynchronized();},isSynchronized:function(){this.isLocked=false;this.setDisabledIfSynchronized();},setDisabled:function(value){this.lasDisabledPetition=value;this.setDisabledIfSynchronized(value);},setDisabledIfSynchronized:function(){var value=this.lasDisabledPetition;if(value===undefined){OB.UTIL.Debug.execute(function(){throw"The disabled value must be true or false";});value=false;}
if(this.isLocked){value=true;}
this.disabled=value;this.setAttribute('disabled',value);},init:function(model){this.model=model;this.setContent(OB.I18N.getLabel('OBPOS_LblDone'));this.model.get('order').on('change:openDrawer',function(){this.drawerpreference=this.model.get('order').get('openDrawer');var me=this;if(this.drawerpreference){this.drawerOpened=false;this.setContent(OB.I18N.getLabel('OBPOS_LblOpen'));}else{this.drawerOpened=true;this.setContent(OB.I18N.getLabel('OBPOS_LblDone'));}},this);this.model.get('multiOrders').on('change:openDrawer',function(){this.drawerpreference=this.model.get('multiOrders').get('openDrawer');if(this.drawerpreference){this.drawerOpened=false;this.setContent(OB.I18N.getLabel('OBPOS_LblOpen'));}else{this.drawerOpened=true;this.setContent(OB.I18N.getLabel('OBPOS_LblDone'));}},this);this.model.get('order').on('paymentCancel',function(){OB.UTIL.showLoading(false);this.setDisabled(false);},this);},blocked:false,tap:function(){var myModel=this.owner.model,me=this,payments,orderDesc='';if(this.getContent()===OB.I18N.getLabel('OBPOS_LblDone')){if(me.blocked){if(this.owner.receipt&&this.owner.receipt.getOrderDescription){orderDesc=this.owner.receipt.getOrderDescription();}
OB.error('Time: '+new Date()+'. Done button has been pressed 2 times and second execution is discarded '+orderDesc);return;}else{me.blocked=true;setTimeout(function(){me.blocked=false;},1000);}}
if(this&&this.owner&&this.owner.receipt&&this.owner.receipt.getOrderDescription){orderDesc=this.owner.receipt.getOrderDescription();}
OB.info('Time: '+new Date()+'. Payment Button Pressed ( Status: '+this.disabled+') '+orderDesc);this.allowOpenDrawer=false;if(this.disabled){return true;}
var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("doneButton");if(myModel.get('leftColumnViewManager').isOrder()){payments=this.owner.receipt.get('payments');}else{payments=this.owner.model.get('multiOrders').get('payments');}
payments.each(function(payment){if(payment.get('allowOpenDrawer')||payment.get('isCash')){me.allowOpenDrawer=true;}});if(myModel.get('leftColumnViewManager').isOrder()){if(this.drawerpreference&&this.allowOpenDrawer){if(this.drawerOpened){if(this.owner.receipt.get('orderType')===3){this.owner.receipt.trigger('voidLayaway');}else{this.setDisabled(true);enyo.$.scrim.show();me.owner.model.get('order').trigger('paymentDone',false);}
this.drawerOpened=false;this.setContent(OB.I18N.getLabel('OBPOS_LblOpen'));}else{OB.POS.hwserver.openDrawer({openFirst:true,receipt:me.owner.receipt},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);this.drawerOpened=true;this.setContent(OB.I18N.getLabel('OBPOS_LblDone'));}}else{if(this.owner.receipt.get('orderType')===3){this.owner.receipt.trigger('voidLayaway');}else{this.setDisabled(true);enyo.$.scrim.show();me.owner.receipt.trigger('paymentDone',this.allowOpenDrawer);}}}else{if(this.drawerpreference&&this.allowOpenDrawer){if(this.drawerOpened){enyo.$.scrim.show();this.owner.model.get('multiOrders').trigger('paymentDone',false);this.owner.model.get('multiOrders').set('openDrawer',false);this.drawerOpened=false;this.setContent(OB.I18N.getLabel('OBPOS_LblOpen'));}else{OB.POS.hwserver.openDrawer({openFirst:true,receipt:me.owner.model.get('multiOrders')},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);this.drawerOpened=true;this.setContent(OB.I18N.getLabel('OBPOS_LblDone'));}}else{enyo.$.scrim.show();this.owner.model.get('multiOrders').trigger('paymentDone',this.allowOpenDrawer);this.owner.model.get('multiOrders').set('openDrawer',false);}}
OB.UTIL.SynchronizationHelper.finished(synchId,"doneButton");}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ExactButton',kind:'OB.OBPOSPointOfSale.UI.ProcessButton',events:{onExactPayment:''},classes:'btn-icon-adaptative btn-icon-check btnlink-green',tap:function(){if(this.disabled){return true;}
this.doExactPayment();}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.RenderPaymentLine',classes:'btnselect',components:[{style:'color:white;',components:[{name:'name',style:'float: left; width: 20%; padding: 5px 0px 0px 0px;'},{name:'info',style:'float: left; width: 15%; padding: 5px 0px 0px 0px;'},{name:'foreignAmount',style:'float: left; width: 20%; padding: 5px 0px 0px 0px; text-align: right;'},{name:'amount',style:'float: left; width: 25%; padding: 5px 0px 0px 0px; text-align: right;'},{style:'float: left; width: 20%; text-align: right;',components:[{kind:'OB.OBPOSPointOfSale.UI.RemovePayment'}]},{style:'clear: both;'}]}],initComponents:function(){this.inherited(arguments);this.$.name.setContent(OB.MobileApp.model.getPaymentName(this.model.get('kind'))||this.model.get('name'));this.$.amount.setContent(this.model.printAmount());if(this.model.get('rate')&&this.model.get('rate')!=='1'){this.$.foreignAmount.setContent(this.model.printForeignAmount());}else{this.$.foreignAmount.setContent('');}
if(this.model.get('description')){this.$.info.setContent(this.model.get('description'));}else{if(this.model.get('paymentData')){if(this.model.get('paymentData').Name){this.model.get('paymentData').name=this.model.get('paymentData').Name;}
this.$.info.setContent(this.model.get('paymentData').name);}else{this.$.info.setContent('');}}
if(this.model.get('isPrePayment')){this.hide();}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.RemovePayment',events:{onRemovePayment:''},kind:'OB.UI.SmallButton',classes:'btnlink-darkgray btnlink-payment-clear btn-icon-small btn-icon-clearPayment',tap:function(){var me=this;if((_.isUndefined(this.deleting)||this.deleting===false)){this.deleting=true;this.removeClass('btn-icon-clearPayment');this.addClass('btn-icon-loading');this.bubble('onMaxLimitAmountError',{show:false,maxLimitAmount:0,currency:'',symbolAtRight:true});this.bubble('onClearPaymentSelect');this.doRemovePayment({payment:this.owner.model,removeCallback:function(){me.deleting=false;me.removeClass('btn-icon-loading');me.addClass('btn-icon-clearPayment');}});}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.CreditButton',kind:'OB.OBPOSPointOfSale.UI.ProcessButton',i18nLabel:'OBPOS_LblCreditSales',classes:'btn-icon-small btnlink-green',permission:'OBPOS_receipt.creditsales',events:{onShowPopup:''},init:function(model){this.model=model;},disabled:false,putDisabled:function(status){if(status===false){this.setDisabled(false);this.removeClass('disabled');this.disabled=false;}else{this.setDisabled(true);this.addClass('disabled');this.disabled=true;}},initComponents:function(){this.inherited(arguments);this.putDisabled(!OB.MobileApp.model.hasPermission(this.permission));},tap:function(){if(this.disabled){return true;}
var process=new OB.DS.Process('org.openbravo.retail.posterminal.CheckBusinessPartnerCredit');var me=this;var paymentstatus=this.model.get('order').getPaymentStatus();if(!paymentstatus.isReturn){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("creditButtonTap");process.exec({businessPartnerId:this.model.get('order').get('bp').get('id'),totalPending:this.model.get('order').getPending()},function(data){OB.UTIL.SynchronizationHelper.finished(synchId,"creditButtonTap");if(data){if(data.enoughCredit){me.doShowPopup({popup:'modalEnoughCredit',args:{order:me.model.get('order')}});}else{var bpName=data.bpName;var actualCredit=data.actualCredit;me.doShowPopup({popup:'modalNotEnoughCredit',args:{bpName:bpName,actualCredit:actualCredit}});}}else{OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgErrorCreditSales'));}},function(){OB.UTIL.SynchronizationHelper.finished(synchId,"creditButtonTap");me.doShowPopup({popup:'modalEnoughCredit',args:{order:me.model.get('order'),message:'OBPOS_Unabletocheckcredit'}});});}else if(paymentstatus.isReturn){var actualCredit;var creditLimit=this.model.get('order').get('bp').get('creditLimit');var creditUsed=this.model.get('order').get('bp').get('creditUsed');var totalPending=this.model.get('order').getPending();this.doShowPopup({popup:'modalEnoughCredit',args:{order:this.model.get('order')}});}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.LayawayButton',kind:'OB.OBPOSPointOfSale.UI.ProcessButton',content:'',classes:'btn-icon-small btnlink-green',permission:'OBPOS_receipt.layawayReceipt',init:function(model){this.model=model;this.setContent(OB.I18N.getLabel('OBPOS_LblLayaway'));},updateVisibility:function(isVisible){if(!OB.MobileApp.model.hasPermission(this.permission)){this.hide();return;}
if(!isVisible){this.hide();return;}
this.show();},tap:function(){var receipt=this.owner.receipt,negativeLines,me=this,myModel=this.owner.model,payments;this.allowOpenDrawer=false;if(receipt.get('bp').id===OB.MobileApp.model.get('terminal').businessPartner&&!OB.MobileApp.model.get('terminal').layaway_anonymouscustomer){OB.UTIL.showConfirmation.display("Error",OB.I18N.getLabel('OBPOS_layawaysOrdersWithAnonimousCust'));return;}
if(!this.showing){return true;}
if(myModel.get('leftColumnViewManager').isOrder()){payments=this.owner.receipt.get('payments');}else{payments=this.owner.model.get('multiOrders').get('payments');}
payments.each(function(payment){if(payment.get('allowOpenDrawer')||payment.get('isCash')){me.allowOpenDrawer=true;}});if(receipt){negativeLines=_.find(receipt.get('lines').models,function(line){return line.get('qty')<0;});if(negativeLines){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_layawaysOrdersWithReturnsNotAllowed'));return true;}
if(receipt.get('generateInvoice')){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_noInvoiceIfLayaway'));receipt.set('generateInvoice',false);}}
this.hide();enyo.$.scrim.show();receipt.trigger('paymentDone',me.allowOpenDrawer);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Discounts',handlers:{onApplyDiscounts:'applyDiscounts',onDiscountsClose:'closingDiscounts',onDiscountChanged:'discountChanged',onDiscountQtyChanged:'discountQtyChanged',onCheckedTicketLine:'ticketLineChecked'},events:{onDiscountsModeFinished:'',onDisableKeyboard:'',onDiscountsModeKeyboard:'',onShowPopup:'',onCheckAllTicketLines:''},checkedLines:[],style:'position:relative; background-color: orange; background-size: cover; color: white; height: 200px; margin: 5px; padding: 5px;',components:[{kind:'Scroller',maxHeight:'130px',thumb:true,horizontal:'hidden',components:[{components:[{style:'border: 1px solid #F0F0F0; background-color: #E2E2E2; color: black; width: 35%; height: 40px; float: left; text-align: left;',components:[{style:'padding: 5px 8px 0px 3px;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LineDiscount'));}}]},{name:'discountsContainer',style:'border: 1px solid #F0F0F0; float: left; width: 63%;',components:[{name:'discountsList',kind:'OB.UI.DiscountList'}]}]},{style:'clear: both'},{components:[{style:'border: 1px solid #F0F0F0; background-color: #E2E2E2; color: black; width: 35%; height: 40px; float: left; text-align: left;',components:[{style:'padding: 5px 8px 0px 3px;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_overridePromotions'));}}]},{style:'border: 1px solid #F0F0F0; float: left; width: 63%;',components:[{classes:'modal-dialog-profile-checkbox',components:[{kind:'OB.OBPOSPointOfSale.UI.Discounts.btnCheckOverride',name:'checkOverride',classes:'modal-dialog-btn-check'}]}]}]},{style:'clear: both'},{components:[{style:'border: 1px solid #F0F0F0; background-color: #E2E2E2; color: black; width: 35%; height: 40px; float: left;  text-align: left;',components:[{style:'padding: 5px 8px 0px 3px;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_applyToAllLines'));}}]},{style:'border: 1px solid #F0F0F0; float: left; width: 63%;',components:[{classes:'modal-dialog-profile-checkbox',components:[{kind:'OB.OBPOSPointOfSale.UI.Discounts.btnCheckAll',name:'checkSelectAll',classes:'modal-dialog-btn-check'}]}]}]},{style:'clear: both'}]},{style:'padding: 10px;',components:[{style:'text-align: center;',components:[{kind:'OB.OBPOSPointOfSale.UI.Discounts.btnDiscountsApply',name:'btnApply'},{kind:'OB.OBPOSPointOfSale.UI.Discounts.btnDiscountsCancel'}]}]}],show:function(){var me=this;OB.MobileApp.view.scanningFocus(false);me.$.btnApply.setDisabled(true);me.discounts.reset();me.order.trigger('showDiscount');this.doCheckAllTicketLines({status:false});OB.Dal.find(OB.Model.Discount,{_whereClause:"where m_offer_type_id in ("+OB.Model.Discounts.getManualPromotions()+") AND date('now') BETWEEN DATEFROM AND COALESCE(date(DATETO), date('9999-12-31'))"
+" AND ("+" (pricelist_selection = 'Y' AND NOT EXISTS "
+" (SELECT 1 FROM m_offer_pricelist opl WHERE m_offer.m_offer_id = opl.m_offer_id AND opl.m_pricelist_id = '"+me.order.get('priceList')+"'))"
+" OR (pricelist_selection = 'N' AND EXISTS "
+" (SELECT 1 FROM m_offer_pricelist opl WHERE m_offer.m_offer_id = opl.m_offer_id AND opl.m_pricelist_id = '"+me.order.get('priceList')+"')))"
+" AND ((EM_OBDISC_ROLE_SELECTION = 'Y'"
+" AND NOT EXISTS"
+" (SELECT 1"
+" FROM OBDISC_OFFER_ROLE"
+" WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND AD_ROLE_ID = '"+OB.MobileApp.model.get('context').role.id+"'"
+" ))"
+" OR (EM_OBDISC_ROLE_SELECTION = 'N'"
+" AND EXISTS"
+" (SELECT 1"
+" FROM OBDISC_OFFER_ROLE"
+" WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND AD_ROLE_ID = '"+OB.MobileApp.model.get('context').role.id+"'"
+" )))"},function(promos){promos.comparator=function(model){return model.get('_identifier');};promos.sort();me.discounts.reset(promos.models);me.ticketLineChecked({},{checkedLines:me.checkedLines});me.discountChanged({},{originator:me.$.discountsList});},function(){var tr;me.discounts.reset();tr=me.$.discountsList.createComponent({kind:'enyo.Option',text:OB.I18N.getLabel('OBPOS_errorGettingDiscounts'),value:'error',initComponents:function(){this.setValue(this.value);this.setContent(this.text);}});tr.render();me.ticketLineChecked({},{checkedLines:me.checkedLines});});this.inherited(arguments);},disableKeyboard:function(){this.doDiscountsModeKeyboard({status:true,writable:false});},enableKeyboard:function(){this.doDiscountsModeKeyboard({status:true,writable:true});},_searchSelectedComponent:function(selectedId){return _.find(this.$.discountsList.getComponents(),function(comp){if(comp.getValue()===selectedId){return true;}},this);},discountQtyChanged:function(inSender,inEvent){if(!OB.DEC.isNumber(inEvent.qty)){this.doShowPopup({popup:'modalNotValidValueForDiscount'});return;}
var comp=this._searchSelectedComponent(this.$.discountsList.getValue());if(comp.units==='%'&&OB.DEC.toBigDecimal(inEvent.qty)>100){this.doShowPopup({popup:'modalNotValidValueForDiscount'});return;}
comp.setContent(comp.originalText+' - '+inEvent.qty+' '+comp.units);this.$.discountsContainer.amt=inEvent.qty;},initComponents:function(){var discountsModel=Backbone.Collection.extend({model:OB.Model.Discounts});this.inherited(arguments);this.discounts=new discountsModel();this.$.discountsList.setCollection(this.discounts);},ticketLineChecked:function(inSender,inEvent){if(inEvent.allChecked){this.$.checkSelectAll.check();}else{this.$.checkSelectAll.unCheck();}
this.checkedLines=inEvent.checkedLines;if(this.checkedLines.length>0&&this.discounts.length!==0){this.$.btnApply.setDisabled(false);this.$.btnApply.addStyles('color: orange;');}else{this.$.btnApply.setDisabled(true);this.$.btnApply.addStyles('color: #4C4949;');}},discountChanged:function(inSender,inEvent){var comp=this._searchSelectedComponent(this.$.discountsList.getValue()),discountsContainer=this.$.discountsContainer;discountsContainer.model=comp.model;discountsContainer.requiresQty=comp.requiresQty;discountsContainer.amt=comp.amt;discountsContainer.units=comp.units;if(comp.model.get('discountType')==="8338556C0FBF45249512DB343FEFD280"||comp.model.get('discountType')==="7B49D8CC4E084A75B7CB4D85A6A3A578"){this.disableKeyboard();}else{this.enableKeyboard();}},closingDiscounts:function(inSender,inEvent){OB.MobileApp.view.scanningFocus(true);this.$.checkSelectAll.unCheck();this.setShowing(false);this.doDiscountsModeFinished({tabPanel:'scan',keyboard:'toolbarscan',edit:false,options:{discounts:false}});},applyDiscounts:function(inSender,inEvent){var promotionToAplly={},discountsContainer=this.$.discountsContainer,orderLinesCollection=new OB.Collection.OrderLineList();promotionToAplly.rule=discountsContainer.model;promotionToAplly.definition={};promotionToAplly.definition.userAmt=discountsContainer.amt;promotionToAplly.definition.applyNext=!this.$.checkOverride.checked;promotionToAplly.definition.lastApplied=true;if(discountsContainer.requiresQty&&!discountsContainer.amt){this.doShowPopup({popup:'modalDiscountNeedQty'});return true;}
_.each(this.checkedLines,function(line){orderLinesCollection.add(line);});OB.Model.Discounts.addManualPromotion(this.order,orderLinesCollection,promotionToAplly);this.closingDiscounts();},init:function(model){this.order=model.get('order');}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Discounts.btnDiscountsApply',kind:'OB.UI.ModalDialogButton',style:'color: orange; font-weight: bold;',i18nLabel:'OBMOBC_LblApply',events:{onApplyDiscounts:''},tap:function(){this.doApplyDiscounts();},initComponents:function(){this.inherited(arguments);this.setDisabled(true);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Discounts.btnCheckAll',kind:'OB.UI.CheckboxButton',events:{onCheckAllTicketLines:''},checked:false,tap:function(){this.inherited(arguments);this.doCheckAllTicketLines({status:this.checked});}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Discounts.btnCheckOverride',kind:'OB.UI.CheckboxButton',checked:false});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Discounts.btnDiscountsCancel',kind:'OB.UI.ModalDialogButton',style:'color: orange; font-weight: bold;',events:{onDiscountsClose:''},i18nContent:'OBMOBC_LblCancel',tap:function(){this.doDiscountsClose();}});enyo.kind({name:'OB.UI.DiscountList',kind:'OB.UI.List',tag:'select',onchange:'discountChanged',classes:'discount-dialog-profile-combo',renderEmpty:enyo.Control,renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.setValue(this.model.get('id'));this.originalText=this.model.get('_identifier');if(this.model.get('discountType')==='D1D193305A6443B09B299259493B272A'||this.model.get('discountType')==='20E4EC27397344309A2185097392D964'){this.requiresQty=true;if(this.model.get('discountType')==='20E4EC27397344309A2185097392D964'){this.units='%';if(!_.isUndefined(this.model.get('obdiscPercentage'))&&!_.isNull(this.model.get('obdiscPercentage'))){this.amt=this.model.get('obdiscPercentage');}}else if(this.model.get('discountType')==='D1D193305A6443B09B299259493B272A'){this.units=OB.MobileApp.model.get('terminal').currency$_identifier;if(this.model.get('obdiscAmt')){this.amt=this.model.get('obdiscAmt');}}}else{this.requiresQty=false;if(this.model.get('discountType')==='8338556C0FBF45249512DB343FEFD280'){this.units='%';if(!_.isUndefined(this.model.get('obdiscPercentage'))&&!_.isNull(this.model.get('obdiscPercentage'))){this.amt=this.model.get('obdiscPercentage');}}else if(this.model.get('discountType')==='7B49D8CC4E084A75B7CB4D85A6A3A578'){this.units=OB.MobileApp.model.get('terminal').currency$_identifier;if(!_.isUndefined(this.model.get('obdiscAmt'))&&!_.isNull(this.model.get('obdiscAmt'))){this.amt=this.model.get('obdiscAmt');}}}
if(this.amt){this.setContent(this.originalText+' - '+this.amt+' '+this.units);}else{this.setContent(this.originalText);}}}),initComponents:function(){this.inherited(arguments);}});OB.OBPOSPointOfSale.UI.ToolbarScan={name:'toolbarscan',buttons:[{command:'code',i18nLabel:'OBMOBC_KbCode',classButtonActive:'btnactive-blue',idSufix:'upcean'}],shown:function(){var keyboard=this.owner.owner;keyboard.showKeypad('basic');keyboard.showSidepad('sideenabled');keyboard.defaultcommand='code';keyboard.disableCommandKey(this,{disabled:true,commands:['%']});}};OB.OBPOSPointOfSale.UI.ToolbarDiscounts={name:'toolbardiscounts',buttons:[],shown:function(){var keyboard=this.owner.owner;keyboard.showKeypad('basic');keyboard.showSidepad('sideenabled');keyboard.defaultcommand='line:dto';keyboard.disableCommandKey(this,{disabled:true,commands:['%']});}};enyo.kind({name:'OB.OBPOSPointOfSale.UI.ToolbarPayment',sideButtons:[],published:{receipt:null},toolbarName:'toolbarpayment',events:{onShowPopup:'',onClearPaymentSelect:''},handlers:{onShowAllButtons:'showAllButtons',onCloseAllPopups:'closeAllPopups',onButtonPaymentChanged:'paymentChanged',onActionPay:'actionPay'},components:[{kind:'OB.OBPOSPointOfSale.UI.PaymentMethods',name:'OBPOS_UI_PaymentMethods'}],init:function(model){this.model=model;},actionPay:function(inSender,inEvent){this.bubble('onClearPaymentSelect');this.pay(inEvent.amount,inEvent.key,inEvent.name,inEvent.paymentMethod,inEvent.rate,inEvent.mulrate,inEvent.isocode,inEvent.options);},pay:function(amount,key,name,paymentMethod,rate,mulrate,isocode,options){if(this.receipt.stopAddingPayments){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_CannotAddPayments'));return;}
if(options&&options.percentaje){var pending=this.model.getPending();if(mulrate&&mulrate!=='1'){pending=OB.DEC.mul(pending,mulrate);}
amount=OB.DEC.div(OB.DEC.mul(pending,amount),100);}
if(OB.DEC.compare(amount)>0){var provider,receiptToPay,me=this;if(this.model.get('leftColumnViewManager').isOrder()){receiptToPay=this.receipt;}
if(this.model.get('leftColumnViewManager').isMultiOrder()){receiptToPay=this.model.get('multiOrders');}
provider=receiptToPay.getTotal()>0?paymentMethod.paymentProvider:paymentMethod.refundProvider;if(provider){this.doShowPopup({popup:'modalpayment',args:{'receipt':receiptToPay,'provider':provider,'key':key,'name':name,'paymentMethod':paymentMethod,'amount':amount,'rate':rate,'mulrate':mulrate,'isocode':isocode}});}else{var amountToPay=amount;if(receiptToPay.get("payments").length>0){receiptToPay.get("payments").each(function(item){if(item.get("kind")===key){amountToPay+=item.get("amount");}});}
if(paymentMethod.maxLimitAmount&&amountToPay>paymentMethod.maxLimitAmount){this.bubble('onMaxLimitAmountError',{show:true,maxLimitAmount:paymentMethod.maxLimitAmount,currency:OB.MobileApp.model.paymentnames[key].symbol,symbolAtRight:OB.MobileApp.model.paymentnames[key].currencySymbolAtTheRight});}else{this.bubble('onMaxLimitAmountError',{show:false,maxLimitAmount:0,currency:'',symbolAtRight:true});this.model.addPayment(new OB.Model.PaymentLine({'kind':key,'name':name,'amount':amount,'rate':rate,'mulrate':mulrate,'isocode':isocode,'allowOpenDrawer':paymentMethod.allowopendrawer,'isCash':paymentMethod.iscash,'openDrawer':paymentMethod.openDrawer,'printtwice':paymentMethod.printtwice}));}}}},getButtonComponent:function(sidebutton){if(sidebutton.i18nLabel){sidebutton.label=OB.I18N.getLabel(sidebutton.i18nLabel);}
return{kind:'OB.UI.BtnSide',btn:{command:sidebutton.command,label:sidebutton.label,permission:sidebutton.permission,definition:{holdActive:true,permission:sidebutton.permission,stateless:sidebutton.stateless,action:sidebutton.action}}};},addPaymentButton:function(btncomponent,countbuttons,paymentsbuttons,dialogbuttons,payment){if(countbuttons<paymentsbuttons){this.createComponent(btncomponent);}else{this.addSideButton(btncomponent);dialogbuttons[payment.payment.searchKey]=payment.payment._identifier;}},addSideButton:function(btncomponent){var hasSideButton=false,sideButtons=OB.OBPOSPointOfSale.UI.PaymentMethods.prototype.sideButtons,i;for(i=0;i<sideButtons.length;i++){if(_.isEqual(sideButtons[i].btn.command,btncomponent.btn.command)){hasSideButton=true;break;}}
if(!hasSideButton){OB.OBPOSPointOfSale.UI.PaymentMethods.prototype.sideButtons.push(btncomponent);}},initComponents:function(){var i,max,payments,paymentsdialog,paymentsbuttons,countbuttons,btncomponent,Btn,inst,cont,exactdefault,cashdefault,allpayments={},me=this,paymentCategories=[],dialogbuttons={};this.inherited(arguments);payments=OB.MobileApp.model.get('payments');countbuttons=0;enyo.forEach(payments,function(payment){if(payment.paymentMethod.paymentMethodCategory){var paymentCategory=null;paymentCategories.every(function(category){if(category.id===payment.paymentMethod.paymentMethodCategory){paymentCategory=category;return false;}
return true;});if(paymentCategory===null){countbuttons++;paymentCategories.push({id:payment.paymentMethod.paymentMethodCategory,name:payment.paymentMethod.paymentMethodCategory$_identifier});}}else{countbuttons++;}});paymentsdialog=countbuttons+this.sideButtons.length>5;paymentsbuttons=paymentsdialog?4:5;countbuttons=0;paymentCategories=[];enyo.forEach(payments,function(payment){if(payment.paymentMethod.id===OB.MobileApp.model.get('terminal').terminalType.paymentMethod){exactdefault=payment;}
if(payment.payment.searchKey===OB.MobileApp.model.get('paymentcash')){cashdefault=payment;}
allpayments[payment.payment.searchKey]=payment;if(payment.paymentMethod.paymentMethodCategory){btncomponent=null;if(paymentCategories.indexOf(payment.paymentMethod.paymentMethodCategory)===-1){btncomponent=me.getButtonComponent({command:'paymentMethodCategory.showitems.'+payment.paymentMethod.paymentMethodCategory,label:payment.paymentMethod.paymentMethodCategory$_identifier,stateless:false,action:function(keyboard,txt){var options={};if(_.last(txt)==='%'){options.percentaje=true;}
var amount=OB.DEC.number(OB.I18N.parseNumber(txt));if(_.isNaN(amount)){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_NotValidNumber',[txt]));return;}
var buttonClass=keyboard.buttons['paymentMethodCategory.showitems.'+payment.paymentMethod.paymentMethodCategory].attributes['class'];if(me.currentPayment&&buttonClass.indexOf('btnactive-green')>0){me.pay(amount,me.currentPayment.payment.searchKey,me.currentPayment.payment._identifier,me.currentPayment.paymentMethod,me.currentPayment.rate,me.currentPayment.mulrate,me.currentPayment.isocode,options);}else{me.doShowPopup({popup:'modalPaymentsSelect',args:{idCategory:payment.paymentMethod.paymentMethodCategory,amount:amount,options:options}});}}});paymentCategories.push(payment.paymentMethod.paymentMethodCategory);}}else{btncomponent=this.getButtonComponent({command:payment.payment.searchKey,label:payment.payment._identifier+(payment.paymentMethod.paymentMethodCategory?'*':''),permission:payment.payment.searchKey,stateless:false,action:function(keyboard,txt){var options={};if(_.last(txt)==='%'){options.percentaje=true;}
var amount=OB.DEC.number(OB.I18N.parseNumber(txt));if(_.isNaN(amount)){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_NotValidNumber',[txt]));return;}
me.pay(amount,payment.payment.searchKey,payment.payment._identifier,payment.paymentMethod,payment.rate,payment.mulrate,payment.isocode,options);}});}
if(btncomponent!==null){if(payment.paymentMethod.paymentMethodCategory){me.addPaymentButton(btncomponent,countbuttons++,paymentsbuttons,dialogbuttons,{payment:{searchKey:'paymentMethodCategory.showitems.'+payment.paymentMethod.paymentMethodCategory,_identifier:payment.paymentMethod.paymentMethodCategory$_identifier}});}else{me.addPaymentButton(btncomponent,countbuttons++,paymentsbuttons,dialogbuttons,payment);}}},this);exactdefault=exactdefault||cashdefault||payments[0];enyo.forEach(this.sideButtons,function(sidebutton){btncomponent=this.getButtonComponent(sidebutton);if(countbuttons++<paymentsbuttons){this.createComponent(btncomponent);}else{me.addSideButton(btncomponent);dialogbuttons[sidebutton.command]=sidebutton.label;}},this);while(countbuttons++<paymentsbuttons){this.createComponent({kind:'OB.UI.BtnSide',btn:{}});}
if(paymentsdialog){this.createComponent({name:'btnMore',toolbar:this,dialogbuttons:dialogbuttons,kind:'OB.OBPOSPointOfSale.UI.ButtonMore'});}
this.createComponent({kind:'OB.OBPOSPointOfSale.UI.ButtonSwitch',keyboard:this.keyboard});this.owner.owner.addCommand('cashexact',{action:function(keyboard,txt){var status=keyboard.status.indexOf('paymentMethodCategory.showitems.')===0&&me.currentPayment?me.currentPayment.payment.searchKey:keyboard.status;if(status&&!allpayments[status]){keyboard.execCommand(status,null);}else{me.bubble('onClearPaymentSelect');var exactpayment=allpayments[status]||exactdefault,amount=me.model.getPending(),altexactamount=me.receipt.get('exactpayment');if(altexactamount&&altexactamount[exactpayment.payment.searchKey]){amount=altexactamount[exactpayment.payment.searchKey];}
if(exactpayment.rate&&exactpayment.rate!=='1'){amount=OB.DEC.div(amount,exactpayment.rate);}
if(amount>0&&exactpayment&&OB.MobileApp.model.hasPermission(exactpayment.payment.searchKey)){me.pay(amount,exactpayment.payment.searchKey,exactpayment.payment._identifier,exactpayment.paymentMethod,exactpayment.rate,exactpayment.mulrate,exactpayment.isocode);}}}});},showAllButtons:function(){this.$.OBPOS_UI_PaymentMethods.show();},closeAllPopups:function(){this.$.OBPOS_UI_PaymentMethods.hide();},paymentChanged:function(inSender,inEvent){this.currentPayment=inEvent.payment;},shown:function(){var me=this,i,max,p,keyboard=this.owner.owner;keyboard.showKeypad('Coins-'+OB.MobileApp.model.get('currency').id);keyboard.showSidepad('sidedisabled');keyboard.disableCommandKey(this,{commands:['%'],disabled:false});for(i=0,max=OB.MobileApp.model.get('payments').length;i<max;i++){p=OB.MobileApp.model.get('payments')[i];if(p.paymentMethod.id===OB.MobileApp.model.get('terminal').terminalType.paymentMethod){keyboard.defaultcommand=OB.MobileApp.model.get('payments')[i].payment.searchKey;keyboard.setStatus(OB.MobileApp.model.get('payments')[i].payment.searchKey);break;}}
if(keyboard&&OB.MobileApp.model.get('paymentcash')&&keyboard.status===''){keyboard.defaultcommand=OB.MobileApp.model.get('paymentcash');keyboard.setStatus(OB.MobileApp.model.get('paymentcash'));}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.PaymentMethods',kind:'OB.UI.Modal',topPosition:'125px',i18nHeader:'OBPOS_MorePaymentsHeader',sideButtons:[],body:{classes:'row-fluid',components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;',classes:'row-fluid',components:[{name:'buttonslist',classes:'span12'}]}]}]},executeOnShow:function(){if(this.$.body.$.buttonslist.children.length===0){enyo.forEach(this.sideButtons,function(sidebutton){sidebutton.btn.definition.includedInPopUp=true;this.$.body.$.buttonslist.createComponent(sidebutton,{owner:this.args.toolbar});},this);}
return true;},init:function(model){this.model=model;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonMore',style:'display:table; width:100%;',events:{onShowAllButtons:''},handlers:{onButtonStatusChanged:'buttonStatusChanged'},components:[{style:'margin: 5px;',components:[{kind:'OB.UI.Button',classes:'btnkeyboard',name:'btn',label:''}]}],initComponents:function(){this.inherited(arguments);this.$.btn.setContent(OB.I18N.getLabel('OBPOS_MorePayments'));this.activegreen=false;},tap:function(){this.toolbar.keyboard.setStatus('');this.doShowAllButtons();},buttonStatusChanged:function(inSender,inEvent){var status=inEvent.value.status;if(this.activegreen){this.$.btn.setContent(OB.I18N.getLabel('OBPOS_MorePayments'));this.$.btn.removeClass('btnactive-green');this.activegreen=false;}
if(this.dialogbuttons[status]){this.$.btn.setContent(OB.I18N.getLabel('OBPOS_MorePayments')+' ('+this.dialogbuttons[status]+')');this.$.btn.addClass('btnactive-green');this.activegreen=true;}
OB.UTIL.createElipsisEffect(this.$.btn);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.ButtonSwitch',style:'display:table; width:100%;',components:[{style:'margin: 5px;',components:[{kind:'OB.UI.Button',classes:'btnkeyboard',name:'btn'}]}],setLabel:function(lbl){this.$.btn.setContent(lbl);},tap:function(){this.keyboard.showNextKeypad();},create:function(){this.inherited(arguments);this.keyboard.state.on('change:keypadNextLabel',function(){this.setLabel(this.keyboard.state.get('keypadNextLabel'));},this);this.setLabel(this.keyboard.state.get('keypadNextLabel'));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.KeyboardOrder',kind:'OB.UI.Keyboard',keypads:[],published:{receipt:null},events:{onShowPopup:'',onAddProduct:'',onSetDiscountQty:'',onDiscountsMode:'',onSetMultiSelectionItems:''},discountsMode:false,handlers:{onSetMultiSelected:'setMultiSelected',onKeyboardOnDiscountsMode:'keyboardOnDiscountsMode'},setMultiSelected:function(inSender,inEvent){if(inEvent.models&&inEvent.models.length>0&&!(inEvent.models[0]instanceof OB.Model.OrderLine)){return;}
this.selectedModels=inEvent.models;this.selectedModelsSameQty=true;if(this.selectedModels.length>1){var i,qty=this.selectedModels[0].get('qty');for(i=1;i<this.selectedModels.length;i++){if(qty!==this.selectedModels[i].get('qty')){this.selectedModelsSameQty=false;break;}}}},keyboardOnDiscountsMode:function(inSender,inEvent){if(inEvent.status){this.showSidepad('ticketDiscountsToolbar');}else{this.showSidepad('sideenabled');}
if(!inEvent.status){this.discountsMode=false;if(this.prevdefaultcommand){this.defaultcommand=this.prevdefaultcommand;}
if(this.buttons['ticket:discount']){this.buttons['ticket:discount'].removeClass('btnactive');}
this.keyboardDisabled(inSender,{status:false});}else{this.discountsMode=true;this.prevdefaultcommand=this.defaultcommand;this.clearInput();this.defaultcommand='ticket:discount';if(inEvent.writable){this.keyboardDisabled(inSender,{status:false});if(this.buttons['ticket:discount']){this.buttons['ticket:discount'].addClass('btnactive');}}else{if(this.buttons['ticket:discount']){this.buttons['ticket:discount'].removeClass('btnactive');}
this.keyboardDisabled(inSender,{status:true});return true;}}},sideBarEnabled:true,receiptChanged:function(){this.$.toolbarcontainer.$.toolbarPayment.setReceipt(this.receipt);this.line=null;this.receipt.get('lines').on('selected',function(line){this.line=line;this.clearInput();},this);},initComponents:function(){var me=this;var actionAddProduct=function(keyboard,value){if(!keyboard.line.get('notReturnThisLine')){if(keyboard.receipt.get('isEditable')===false){me.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(keyboard.line&&keyboard.line.get('product').get('isEditableQty')===false){me.doShowPopup({popup:'modalNotEditableLine'});return true;}
if(keyboard.line){if(_.isNaN(value)){return true;}else{me.doAddProduct({product:keyboard.line.get('product'),qty:value,options:{line:keyboard.line}});keyboard.receipt.trigger('scan');}}}else{keyboard.line.unset('notReturnThisLine');}};var actionAddMultiProduct=function(keyboard,qty){if(me.selectedModelsSameQty){keyboard.receipt.set('undo',null);keyboard.receipt.set('multipleUndo',true);var selection=[];_.each(me.selectedModels,function(model){selection.push(model);keyboard.line=model;actionAddProduct(keyboard,qty);});keyboard.receipt.set('multipleUndo',null);me.doSetMultiSelectionItems({selection:selection});}};var actionRemoveProduct=function(keyboard,value){if(keyboard.receipt.get('isEditable')===false){me.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(keyboard.line&&keyboard.line.get('product').get('isEditableQty')===false){me.doShowPopup({popup:'modalNotEditableLine'});return true;}
if(keyboard.line){keyboard.receipt.removeUnit(keyboard.line,value);keyboard.receipt.trigger('scan');}};var actionDeleteLine=function(keyboard){function callback(){OB.UTIL.HookManager.executeHooks('OBPOS_PostDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.receipt.unset('preventServicesUpdate');keyboard.receipt.unset('deleting');keyboard.receipt.get('lines').trigger('updateRelations');keyboard.receipt.calculateReceipt();enyo.$.scrim.hide();});}
if(keyboard.receipt.get('isEditable')===false){me.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(keyboard.line&&keyboard.line.get('product').get('isEditableQty')===false){me.doShowPopup({popup:'modalNotEditableLine'});return true;}
if(keyboard.line){OB.UTIL.HookManager.executeHooks('OBPOS_PreDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.receipt.set('preventServicesUpdate',true);keyboard.receipt.set('deleting',true);if(me.selectedModels.length>1){keyboard.receipt.deleteLines(me.selectedModels,0,me.selectedModels.length,callback);}else{keyboard.receipt.deleteLine(keyboard.line,false,callback);}
keyboard.receipt.trigger('scan');});}};this.addCommand('line:qty',{action:function(keyboard,txt){var value=OB.I18N.parseNumber(txt),toadd;function callback(){OB.UTIL.HookManager.executeHooks('OBPOS_PostDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.receipt.unset('preventServicesUpdate');keyboard.receipt.unset('deleting');keyboard.receipt.get('lines').trigger('updateRelations');keyboard.receipt.calculateReceipt();enyo.$.scrim.hide();});}
if(!keyboard.line){return true;}
if(value||value===0){keyboard.receipt.set('undo',null);var selection=[];if(me.selectedModels&&me.selectedModels.length>1){keyboard.receipt.set('multipleUndo',true);}
_.each(me.selectedModels,function(model){selection.push(model);keyboard.line=model;if(keyboard.receipt.get('orderType')===1){toadd=value-(-keyboard.line.get('qty'));}else{toadd=value-keyboard.line.get('qty');}
if(toadd!==0){if(value===0){OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.deleteLine',function(approved,supervisor,approvalType){if(approved){OB.UTIL.HookManager.executeHooks('OBPOS_PreDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.receipt.set('preventServicesUpdate',true);keyboard.receipt.set('deleting',true);if(me.selectedModels.length>1){keyboard.receipt.deleteLines(me.selectedModels,0,me.selectedModels.length,callback);}else{keyboard.receipt.deleteLine(me.line,false,callback);}
keyboard.receipt.trigger('scan');});}});}else{actionAddProduct(keyboard,toadd);}}});keyboard.receipt.set('multipleUndo',null);me.doSetMultiSelectionItems({selection:selection});}}});this.addCommand('line:price',{permission:'OBPOS_order.changePrice',action:function(keyboard,txt){if(keyboard.receipt.get('isEditable')===false){me.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(!keyboard.line){return true;}
if(keyboard.line.get('product').get('isEditablePrice')===false){me.doShowPopup({popup:'modalNotEditableLine'});return true;}
if(keyboard.line){OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.setPrice',function(approved,supervisor,approvalType){if(approved){var price=OB.I18N.parseNumber(txt);if(me.selectedModels.length>1){keyboard.receipt.set('undo',null);keyboard.receipt.set('multipleUndo',true);_.each(me.selectedModels,function(model){keyboard.receipt.setPrice(model,price);});keyboard.receipt.set('multipleUndo',null);}else{keyboard.receipt.setPrice(keyboard.line,price);}
keyboard.receipt.calculateReceipt();keyboard.receipt.trigger('scan');}});}}});this.addCommand('line:dto',{permission:'OBPOS_order.discount',action:function(keyboard,txt){if(keyboard.receipt.get('isEditable')===false){me.doShowPopup({popup:'modalNotEditableOrder'});return true;}
if(OB.MobileApp.model.get('permissions')["OBPOS_retail.discountkeyboard"]===true||keyboard.line.getQty()<0){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_LineCanNotBeSelected'));return true;}
keyboard.receipt.set('undo',null);keyboard.receipt.set('multipleUndo',true);var discount=OB.I18N.parseNumber(txt);_.each(me.selectedModels,function(model){keyboard.receipt.trigger('discount',model,discount);});keyboard.receipt.set('multipleUndo',null);}});this.addCommand('screen:dto',{stateless:true,permission:'OBPOS_order.discount',action:function(keyboard,txt){if(keyboard.receipt.get('isEditable')===false){me.doShowPopup({popup:'modalNotEditableOrder'});return true;}
me.doDiscountsMode({tabPanel:'edit',keyboard:'toolbardiscounts',edit:false,options:{discounts:true}});}});this.addCommand('ticket:discount',{permission:'OBPOS_retail.advDiscounts',action:function(keyboard,txt){if(keyboard.discountsMode){me.doSetDiscountQty({qty:OB.I18N.parseNumber(txt)});return true;}}});this.addCommand('code',new OB.UI.BarcodeActionHandler());this.addCommand('+',{stateless:true,action:function(keyboard,txt){var qty=1;if(!me.selectedModels||!keyboard.line){return;}
function callback(){OB.UTIL.HookManager.executeHooks('OBPOS_PostDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.receipt.unset('preventServicesUpdate');keyboard.receipt.unset('deleting');keyboard.receipt.get('lines').trigger('updateRelations');keyboard.receipt.calculateReceipt();enyo.$.scrim.hide();});}
if((!_.isNull(txt)||!_.isUndefined(txt))&&!_.isNaN(OB.I18N.parseNumber(txt))){qty=OB.I18N.parseNumber(txt);}
if(me.selectedModels.length>1){actionAddMultiProduct(keyboard,qty);}else{keyboard.receipt.set('multipleUndo',null);actionAddProduct(keyboard,qty);}}});this.addCommand('-',{stateless:true,action:function(keyboard,txt){var qty=1,value,i,j,k,h,line,relatedLine,lineFromSelected;if(!me.selectedModels||!keyboard.line){return;}
function callback(){OB.UTIL.HookManager.executeHooks('OBPOS_PostDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.receipt.unset('preventServicesUpdate');keyboard.receipt.unset('deleting');keyboard.receipt.get('lines').trigger('updateRelations');keyboard.receipt.calculateReceipt();enyo.$.scrim.hide();});}
function actionAddProducts(){if(me.selectedModels.length>1){actionAddMultiProduct(keyboard,-qty);}else{keyboard.receipt.set('multipleUndo',null);actionAddProduct(keyboard,-qty);}}
if((!_.isNull(txt)||!_.isUndefined(txt))&&!_.isNaN(OB.I18N.parseNumber(txt))){qty=OB.I18N.parseNumber(txt);}
if(me.selectedModels.length>0){value=me.selectedModels[0].get('qty')-qty;}else if(!_.isUndefined(keyboard.line)){value=keyboard.line.get('qty')-qty;}
if(value===0){OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.deleteLine',function(approved,supervisor,approvalType){if(approved){OB.UTIL.HookManager.executeHooks('OBPOS_PreDeleteLine',{order:me.receipt,selectedLines:me.selectedModels},function(){keyboard.line.set('deleteApproved',true);keyboard.receipt.set('preventServicesUpdate',true);keyboard.receipt.set('deleting',true);if(me.selectedModels.length>1){keyboard.receipt.deleteLines(me.selectedModels,0,me.selectedModels.length,callback);}else{keyboard.receipt.deleteLine(me.line,false,callback);}
keyboard.receipt.trigger('scan');});}});}else{var approvalNeeded=false,servicesToApprove='',servicesList=[];if(keyboard.receipt.validateAllowSalesWithReturn(value,false)){return;}
if(value<0){for(i=0;i<me.selectedModels.length;i++){line=me.selectedModels[i];if(line.get('product').get('productType')==='S'&&!line.isReturnable()){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableProduct'),OB.I18N.getLabel('OBPOS_UnreturnableProductMessage',[line.get('product').get('_identifier')]));return;}else if(!approvalNeeded){if(line.get('product').get('productType')==='S'){if(line.get('relatedLines')){for(j=0;j<line.get('relatedLines').length;j++){relatedLine=line.get('relatedLines')[j];for(k=0;k<me.selectedModels.length;k++){lineFromSelected=me.selectedModels[k];if(lineFromSelected.id===relatedLine.orderlineId){line.set('notReturnThisLine',true);servicesToApprove+='<br>· '+line.get('product').get('_identifier');servicesList.push(line.get('product'));break;}}
if(k===me.selectedModels.length){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_NotProductSelectedToReturn',[line.get('product').get('_identifier')]));return;}}}else{servicesToApprove+='<br>· '+line.get('product').get('_identifier');servicesList.push(line.get('product'));}
if(!approvalNeeded){approvalNeeded=true;}}}}
for(i=0;i<me.getReceipt().get('lines').length;i++){line=OB.MobileApp.model.receipt.get('lines').models[i];if(line.get('product').get('productType')==='S'&&!line.isReturnable()){if(line.get('relatedLines')){for(j=0;j<line.get('relatedLines').length;j++){relatedLine=line.get('relatedLines')[j];for(k=0;k<me.selectedModels.length;k++){lineFromSelected=me.selectedModels[k];if(lineFromSelected.id===relatedLine.orderlineId){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableRelatedService'),OB.I18N.getLabel('OBPOS_UnreturnableRelatedServiceMessage',[line.get('product').get('_identifier'),relatedLine.productName]));return;}}}}}else if(line.get('product').get('productType')==='S'&&line.isReturnable()){if(line.get('relatedLines')){for(j=0;j<line.get('relatedLines').length;j++){relatedLine=line.get('relatedLines')[j];for(k=0;k<me.selectedModels.length;k++){lineFromSelected=me.selectedModels[k];if(lineFromSelected.id===relatedLine.orderlineId){for(h=0;h<servicesList.length;h++){if(servicesList[h].id===line.get('product').id){break;}}
if(h===servicesList.length){servicesToApprove+='<br>· '+line.get('product').get('_identifier');servicesList.push(line.get('product'));if(!approvalNeeded){approvalNeeded=true;}}}}}}}}}
if(approvalNeeded){OB.UTIL.Approval.requestApproval(me.model,[{approval:'OBPOS_approval.returnService',message:'OBPOS_approval.returnService',params:[servicesToApprove]}],function(approved,supervisor,approvalType){if(approved){me.getReceipt().set('notApprove',true);actionAddProducts();me.getReceipt().unset('notApprove');}else{_.each(me.selectedModels,function(line){if(line.get('notReturnThisLine')){line.unset('notReturnThisLine');}});}});}else{actionAddProducts();}}}});this.addCommand('line:delete',{stateless:true,action:function(keyboard){if(keyboard.line){OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.deleteLine',function(approved,supervisor,approvalType){if(approved){keyboard.line.set('deleteApproved',true);actionDeleteLine(keyboard);}});}}});this.inherited(arguments);this.addToolbarComponent('OB.OBPOSPointOfSale.UI.ToolbarPayment');this.addToolbar(OB.OBPOSPointOfSale.UI.ToolbarScan);this.addToolbar(OB.OBPOSPointOfSale.UI.ToolbarDiscounts);},init:function(model){this.model=model;this.initCurrencyKeypads();_.each(this.keypads,function(keypadname){this.addKeypad(keypadname);},this);},initCurrencyKeypads:function(){var me=this;var currenciesManaged={};_.each(OB.MobileApp.model.get('payments'),function(payment){if((payment.paymentMethod.iscash&&payment.paymentMethod.showkeypad)&&!currenciesManaged[payment.paymentMethod.currency]){currenciesManaged[payment.paymentMethod.currency]=true;OB.Dal.find(OB.Model.CurrencyPanel,{'currency':payment.paymentMethod.currency,_orderByClause:'line'},function(datacurrency){if(datacurrency.length>0){me.buildCoinsAndNotesPanel(payment,payment.symbol,datacurrency);}else if(payment.payment.searchKey==='OBPOS_payment.cash'&&payment.paymentMethod.currency==='102'){me.addKeypad('OB.UI.KeypadCoinsLegacy');}},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);});}},this);},buildCoinsAndNotesButton:function(paymentkey,coin){if(coin){return{kind:'OB.UI.PaymentButton',paymenttype:paymentkey,amount:coin.get('amount'),background:coin.get('backcolor')||'#f3bc9e',bordercolor:coin.get('bordercolor')||coin.get('backcolor')||'#f3bc9e'};}else{return{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'',command:'dummy'};}},buildCoinsAndNotesPanel:function(payment,symbol,datacurrency){enyo.kind({name:'OB.UI.Keypad'+payment.payment.searchKey,label:_.template('<%= symbol %>,<%= symbol %>,<%= symbol %>,...',{symbol:symbol}),padName:'Coins-'+payment.paymentMethod.currency,padPayment:payment.payment.searchKey,components:[{classes:'row-fluid',components:[{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'/',command:'/'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'*',command:'*'}]},{classes:'span4',components:[{kind:'OB.UI.ButtonKey',classButton:'btnkeyboard-num',label:'%',command:'%'}]}]},{classes:'row-fluid',components:[{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(9))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(10))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(11))]}]},{classes:'row-fluid',components:[{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(6))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(7))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(8))]}]},{classes:'row-fluid',components:[{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(3))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(4))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(5))]}]},{classes:'row-fluid',components:[{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(0))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(1))]},{classes:'span4',components:[this.buildCoinsAndNotesButton(payment.payment.searchKey,datacurrency.at(2))]}]}]});this.addKeypad('OB.UI.Keypad'+payment.payment.searchKey);}});enyo.kind({name:'OB.UI.BarcodeActionHandler',kind:'OB.UI.AbstractBarcodeActionHandler',errorCallback:function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},findProductByBarcode:function(code,callback){var me=this;OB.debug('BarcodeActionHandler - id: '+code);if(code.length>0){OB.UTIL.HookManager.executeHooks('OBPOS_BarcodeScan',{context:me,code:code,callback:callback},function(args){if(args.cancellation){return;}
me.searchProduct(args.code,args.callback);});}},searchProduct:function(code,callback){var me=this,criteria={uPCEAN:code};if(OB.MobileApp.model.hasPermission('OBPOS_remote.product',true)){var uPCEAN={columns:['uPCEAN'],operator:'equals',value:code};var remoteCriteria=[uPCEAN];criteria.remoteFilters=remoteCriteria;}
OB.Dal.find(OB.Model.Product,criteria,function(data){me.searchProductCallback(data,code,callback);},me.errorCallback,this);},searchProductCallback:function(data,code,callback){this.successCallbackProducts(data,code,callback);},successCallbackProducts:function(dataProducts,code,callback){OB.UTIL.HookManager.executeHooks('OBPOS_BarcodeSearch',{dataProducts:dataProducts,code:code,callback:callback},function(args){if(args.cancellation){return;}
if(args.dataProducts&&args.dataProducts.length>0){OB.debug('productfound');args.callback(args.dataProducts.at(0));}else{OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_KbUPCEANCodeNotFound',[args.code]));}});},addProductToReceipt:function(keyboard,product){keyboard.doAddProduct({product:product,ignoreStockTab:true});keyboard.receipt.trigger('scan');}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.ModalConfigurationRequiredForCreateCustomers',kind:'OB.UI.ModalInfo',i18nHeader:'OBPOS_configurationRequired',bodyContent:{i18nContent:'OBPOS_configurationNeededToCreateCustomers'}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.cancelEdit',kind:'OB.UI.Button',style:'width: 100px; margin: 0px 0px 8px 5px;',classes:'btnlink-gray btnlink btnlink-small',i18nContent:'OBMOBC_LblCancel'});enyo.kind({name:'OB.UI.CustomerPropertyLine',components:[{name:'labelLine',style:'font-size: 15px; color: black; text-align: right; border: 1px solid #FFFFFF; background-color: #E2E2E2; width: 20%; height: 28px; padding: 12px 5px 1px 0; float: left;'},{style:'border: 1px solid #FFFFFF; float: left; width: 75%;',name:'newAttribute'},{style:'clear: both'}],initComponents:function(){this.inherited(arguments);this.$.newAttribute.createComponent(this.newAttribute);this.$.labelLine.content=this.newAttribute.i18nLabel?OB.I18N.getLabel(this.newAttribute.i18nLabel):this.newAttribute.label;}});enyo.kind({name:'OB.UI.CustomerTextProperty',kind:'enyo.Input',type:'text',classes:'input',style:'width: 100%; height: 30px; margin:0;',handlers:{onLoadValue:'loadValue',onSaveChange:'saveChange'},events:{onSaveProperty:''},loadValue:function(inSender,inEvent){if(inEvent.customer!==undefined){if(inEvent.customer.get(this.modelProperty)!==undefined){this.setValue(inEvent.customer.get(this.modelProperty));}}else{this.setValue('');}},saveChange:function(inSender,inEvent){inEvent.customer.set(this.modelProperty,this.getValue());},initComponents:function(){if(this.readOnly){this.setAttribute('readonly','readonly');}
if(this.maxlength){this.setAttribute('maxlength',this.maxlength);}}});enyo.kind({name:'OB.UI.CustomerComboProperty',handlers:{onLoadValue:'loadValue',onSaveChange:'saveChange'},events:{onSaveProperty:''},components:[{kind:'OB.UI.List',name:'customerCombo',classes:'combo',style:'width: 101%; margin:0;',renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get(this.parent.parent.retrievedPropertyForValue));this.setContent(this.model.get(this.parent.parent.retrievedPropertyForText));}}),renderEmpty:'enyo.Control'}],loadValue:function(inSender,inEvent){this.$.customerCombo.setCollection(this.collection);this.fetchDataFunction(inEvent);},dataReadyFunction:function(data,inEvent){var index=0,result=null;if(this.destroyed){return;}
if(data){this.collection.reset(data.models);}else{this.collection.reset(null);return;}
result=_.find(this.collection.models,function(categ){if(inEvent.customer){if(categ.get(this.retrievedPropertyForValue)===inEvent.customer.get(this.modelProperty)){return true;}}else{if(categ.get(this.retrievedPropertyForValue)===this.defaultValue()){return true;}}
index+=1;},this);if(result){this.$.customerCombo.setSelected(index);}else{this.$.customerCombo.setSelected(0);}},saveChange:function(inSender,inEvent){var selected=this.collection.at(this.$.customerCombo.getSelected());inEvent.customer.set(this.modelProperty,selected.get(this.retrievedPropertyForValue));if(this.modelPropertyText){inEvent.customer.set(this.modelPropertyText,selected.get(this.retrievedPropertyForText));}},initComponents:function(){if(this.collectionName&&OB&&OB.Collection&&OB.Collection[this.collectionName]){this.collection=new OB.Collection[this.collectionName]();}else{OB.info('OB.UI.CustomerComboProperty: Collection is required');}
this.inherited(arguments);if(this.readOnly){this.setAttribute('readonly','readonly');}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.edit_createcustomers',handlers:{onSetCustomer:'setCustomer',onSaveCustomer:'preSaveCustomer'},events:{},components:[{name:'bodyheader'},{name:'customerAttributes',style:'overflow-x: hidden; overflow-y: auto; max-height: 622px;'}],setCustomer:function(inSender,inEvent){this.customer=inEvent.customer;this.waterfall('onLoadValue',{customer:this.customer});},preSaveCustomer:function(inSender,inEvent){var me=this,inSenderOriginal=inSender,inEventOriginal=inEvent;OB.UTIL.HookManager.executeHooks('OBPOS_PreCustomerSave',{inSender:inSenderOriginal,inEvent:inEventOriginal,passValidation:true,error:'',meObject:me},function(args){if(args.passValidation){args.meObject.saveCustomer(args.inSender,args.inEvent);}else{OB.UTIL.showError(args.error);}});},saveCustomer:function(inSender,inEvent){var me=this,sw=me.subWindow;function getCustomerValues(params){me.waterfall('onSaveChange',{customer:params.customer});}
function goToViewWindow(sw,params){if(sw.caller==='mainSubWindow'){sw.doChangeSubWindow({newWindow:{name:'customerView',params:{navigateOnClose:'mainSubWindow',businessPartner:params.customer}}});}else{sw.doChangeSubWindow({newWindow:{name:'customerView',params:{navigateOnClose:'customerAdvancedSearch',businessPartner:params.customer}}});}}
if(this.customer===undefined){this.model.get('customer').newCustomer();this.waterfall('onSaveChange',{customer:this.model.get('customer')});this.adjustNames(this.model.get('customer'));OB.UTIL.HookManager.executeHooks('OBPOS_BeforeCustomerSave',{customer:this.model.get('customer'),isNew:true},function(args){if(args&&args.cancellation&&args.cancellation===true){return true;}
var success=args.customer.saveCustomer();if(success){goToViewWindow(sw,{customer:OB.UTIL.clone(args.customer)});}});}else{var that=this;this.model.get('customer').loadById(this.customer.get('id'),function(customer){getCustomerValues({customer:customer});that.adjustNames(customer);OB.UTIL.HookManager.executeHooks('OBPOS_BeforeCustomerSave',{customer:customer,isNew:false},function(args){if(args&&args.cancellation&&args.cancellation===true){return true;}
var success=args.customer.saveCustomer();if(success){goToViewWindow(sw,{customer:args.customer});}});});}},adjustNames:function(customer){var firstName=customer.get('firstName'),lastName=customer.get('lastName');if(firstName){firstName=firstName.trim();}
if(lastName){lastName=lastName.trim();}
customer.set('firstName',firstName);customer.set('lastName',lastName);customer.set('name',firstName+(lastName?' '+lastName:''));},initComponents:function(){this.inherited(arguments);this.$.bodyheader.createComponent({kind:this.windowHeader});this.attributeContainer=this.$.customerAttributes;enyo.forEach(this.newAttributes,function(natt){var resultDisplay=true,undf;if(natt.displayLogic!==undf&&natt.displayLogic!==null){if(enyo.isFunction(natt.displayLogic)){resultDisplay=natt.displayLogic(this);}else{resultDisplay=natt.displayLogic;}}
if(resultDisplay){this.$.customerAttributes.createComponent({kind:'OB.UI.CustomerPropertyLine',name:'line_'+natt.name,newAttribute:natt});}},this);},init:function(model){this.model=model;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.cas',kind:'OB.UI.Subwindow',events:{onSearchAction:''},beforeSetShowing:function(params){if(this.caller==='mainSubWindow'){this.waterfall('onSearchAction',{cleanResults:true});}else{this.waterfall('onSearchAction',{executeLastCriteria:true});}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){this.$.subWindowBody.$.casbody.$.listcustomers.$.leftbar.$.searchByLetter.hide();}
this.$.subWindowBody.$.casbody.$.listcustomers.$.leftbar.$.newAction.putDisabled(!OB.MobileApp.model.hasPermission('OBPOS_retail.editCustomers'));return true;},beforeClose:function(dest){if(dest==='mainSubWindow'){this.waterfall('onSearchAction',{cleanResults:true});}
return true;},defaultNavigateOnClose:'mainSubWindow',header:{kind:'OB.OBPOSPointOfSale.UI.customers.casheader'},body:{kind:'OB.OBPOSPointOfSale.UI.customers.casbody',name:'casbody'}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.ModalCustomerScrollableHeader',kind:'OB.UI.ScrollableTableHeader',style:'border-bottom: 10px solid #ff0000;',events:{onSearchAction:'',onClearAction:''},handlers:{onFiltered:'searchAction'},components:[{style:'padding: 10px; 10px; 0px; 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'customerFilterText',style:'width: 100%',isFirstFocus:true}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',ontap:'searchAction'}]}]}]}],clearAction:function(){this.$.customerFilterText.setValue('');this.doClearAction();},searchAction:function(){this.doSearchAction({bpName:this.$.customerFilterText.getValue(),operator:OB.Dal.CONTAINS});return true;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.ListCustomersLine',kind:'OB.UI.SelectButton',classes:'btnselect-customer',components:[{name:'line',style:'line-height: 23px;',components:[{style:'float: left; font-weight: bold;',name:'identifier'},{style:'float: left; padding-left:5px; font-weight: bold; color: red;',name:'onHold'},{style:'float: left;',name:'address'},{style:'float: left;',name:'phone'},{style:'float: left;',name:'email'},{style:'float: left;',name:'taxID'},{style:'clear: both;'}]}],create:function(){this.inherited(arguments);this.$.identifier.setContent(this.model.get('_identifier'));if(this.model.get('customerBlocking')&&this.model.get('salesOrderBlocking')){this.$.onHold.setContent(' ('+OB.I18N.getLabel('OBPOS_OnHold')+') ');}
this.$.address.setContent(' / '+this.model.get('locName'));if(this.model.get('phone')){this.$.phone.setContent(' / '+this.model.get('phone'));}
if(this.model.get('email')){this.$.email.setContent(' / '+this.model.get('email'));}
if(this.model.get('taxID')){this.$.taxID.setContent(' / '+this.model.get('taxID'));}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',kind:'OB.UI.Button',events:{onSearchAction:''},classes:'btnlink-left-toolbar',searchAction:function(params){this.doSearchAction({bpName:params.initial,operator:params.operator});},initComponents:function(){this.inherited(arguments);this.setContent(this.i18nLabel?OB.I18N.getLabel(this.i18nLabel):this.label);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.NewCustomerButton',kind:'OB.UI.Button',events:{onChangeSubWindow:''},disabled:false,classes:'btnlink-left-toolbar',tap:function(){if(this.disabled){return true;}
var sw=this.subWindow;this.doChangeSubWindow({newWindow:{name:'customerCreateAndEdit',params:{navigateOnClose:'customerView'}}});},putDisabled:function(status){if(status===false){this.disabled=false;this.setDisabled(false);this.removeClass('disabled');return;}else{this.disabled=true;this.setDisabled(true);this.addClass('disabled');}},initComponents:function(){this.inherited(arguments);this.setContent(this.i18nLabel?OB.I18N.getLabel(this.i18nLabel):this.label);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.CustomerLeftBar',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.NewCustomerButton',i18nLabel:'OBPOS_LblNew',name:'newAction'},{name:'searchByLetter',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblAC',tap:function(){this.searchAction({initial:'A,B,C',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblDF',tap:function(){this.searchAction({initial:'D,E,F',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblGI',tap:function(){this.searchAction({initial:'G,H,I',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblJL',tap:function(){this.searchAction({initial:'J,K,L',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblMO',tap:function(){this.searchAction({initial:'M,N,O',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblPR',tap:function(){this.searchAction({initial:'P,Q,R',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblSV',tap:function(){this.searchAction({initial:'S,T,U,V',operator:OB.Dal.STARTSWITH});}},{kind:'OB.OBPOSPointOfSale.UI.customers.SearchCustomerButton',i18nLabel:'OBPOS_LblWZ',tap:function(){this.searchAction({initial:'W,X,Y,Z',operator:OB.Dal.STARTSWITH});}}]}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.ListCustomers',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},events:{onChangeBusinessPartner:'',onChangeSubWindow:''},components:[{style:'text-align: center; padding-top: 10px; float: left; width: 19%;',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.CustomerLeftBar',name:'leftbar'}]},{style:'float: left; width: 80%;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'stBPAdvSearch',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'301px',renderHeader:'OB.OBPOSPointOfSale.UI.customers.ModalCustomerScrollableHeader',renderLine:'OB.OBPOSPointOfSale.UI.customers.ListCustomersLine',renderEmpty:'OB.UI.RenderEmpty'},{name:'renderLoading',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',showing:false,initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblLoading'));}}]}]}]},{style:'clear: both'}],clearAction:function(inSender,inEvent){this.bpsList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,filter,splitFilter,splitFilterLength,_operator,i,criteria={},lastCriteria=[];this.$.stBPAdvSearch.$.tbody.hide();this.$.stBPAdvSearch.$.tempty.hide();this.$.renderLoading.show();function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBPs(dataBps,args){me.$.renderLoading.hide();if(args===0&&(!dataBps||dataBps.length===0)){me.$.stBPAdvSearch.$.tempty.show();}
if(dataBps&&dataBps.length>0){me.bpsList.add(dataBps.models);me.bpsList.trigger('reset');me.$.stBPAdvSearch.$.tbody.show();}}
function reset(me){me.$.stBPAdvSearch.$.theader.$.modalCustomerScrollableHeader.$.customerFilterText.setValue('');me.bpsList.reset();me.lastCriteria=null;me.$.renderLoading.hide();me.$.stBPAdvSearch.$.tempty.show();return true;}
if(inEvent.executeLastCriteria){if(this.lastCriteria){for(i=0;i<this.lastCriteria.length;i++){OB.Dal.find(OB.Model.BusinessPartner,this.lastCriteria[i],successCallbackBPs,errorCallback,i);lastCriteria.push(this.lastCriteria[i]);}
this.lastCriteria=lastCriteria;return true;}else{return reset(this);}}
if(inEvent.cleanResults){return reset(this);}
me.bpsList.reset();filter=OB.UTIL.unAccent(inEvent.bpName);splitFilter=filter.split(",");splitFilterLength=splitFilter.length;_operator=inEvent.operator;if(OB.MobileApp.model.hasPermission('OBPOS_customerLimit',true)){criteria._limit=OB.DEC.abs(OB.MobileApp.model.hasPermission('OBPOS_customerLimit',true));}
if(filter&&filter!==''){for(i=0;i<splitFilter.length;i++){if(_operator==='startsWith'){criteria._identifier={operator:_operator,value:splitFilter[i]};}else{criteria._filter={operator:_operator,value:splitFilter[i]};}
if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){var filterIdentifier={columns:['_filter'],operator:'startsWith',value:splitFilter[i]};var remoteCriteria=[filterIdentifier];criteria.remoteFilters=remoteCriteria;}
OB.Dal.find(OB.Model.BusinessPartner,criteria,successCallbackBPs,errorCallback,i);lastCriteria.push(enyo.clone(criteria));}
this.lastCriteria=lastCriteria;}else{OB.Dal.find(OB.Model.BusinessPartner,criteria,successCallbackBPs,errorCallback,0);}
return true;},bpsList:null,init:function(){this.bpsList=new Backbone.Collection();this.$.stBPAdvSearch.setCollection(this.bpsList);this.bpsList.on('click',function(model){var sw=this.subWindow;if(model.get('customerBlocking')&&model.get('salesOrderBlocking')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_BPartnerOnHold',[model.get('_identifier')]));}else{this.doChangeSubWindow({newWindow:{name:'customerView',params:{navigateOnClose:sw.getName(),businessPartner:model}}});}},this);}});enyo.kind({kind:'OB.UI.SubwindowHeader',name:'OB.OBPOSPointOfSale.UI.customers.casheader',onTapCloseButton:function(){var subWindow=this.subWindow;subWindow.doChangeSubWindow({newWindow:{name:'mainSubWindow'}});},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_TitleCustomerAdvancedSearch'));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.casbody',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.ListCustomers',name:'listcustomers'}]});enyo.kind({kind:'OB.UI.Subwindow',name:'OB.OBPOSPointOfSale.UI.customers.newcustomer',events:{onShowPopup:''},beforeSetShowing:function(params){if(OB.MobileApp.model.get('terminal').defaultbp_paymentmethod!==null&&OB.MobileApp.model.get('terminal').defaultbp_bpcategory!==null&&OB.MobileApp.model.get('terminal').defaultbp_paymentterm!==null&&OB.MobileApp.model.get('terminal').defaultbp_invoiceterm!==null&&OB.MobileApp.model.get('terminal').defaultbp_bpcountry!==null&&OB.MobileApp.model.get('terminal').defaultbp_bporg!==null){this.waterfall('onSetCustomer',{customer:params.businessPartner});return true;}else{this.doShowPopup({popup:'modalConfigurationRequiredForCreateNewCustomers'});return false;}},defaultNavigateOnClose:'customerView',header:{kind:'OB.UI.SubwindowHeader',name:'OB.OBPOSPointOfSale.UI.customers.newcustomerheader',handlers:{onSetCustomer:'setCustomer'},i18nHeaderMessage:'OBPOS_TitleEditNewCustomer',setCustomer:function(inSender,inEvent){this.customer=inEvent.customer;},onTapCloseButton:function(){var subWindow=this.subWindow;if(subWindow.caller==='mainSubWindow'){subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller}});}else{subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller,params:{navigateOnClose:'customerAdvancedSearch',businessPartner:(this.headerContainer&&this.headerContainer.customer)?this.headerContainer.customer:(this.customer?this.customer:null)}}});}}},body:{kind:'OB.OBPOSPointOfSale.UI.customers.edit_createcustomers_impl'}});enyo.kind({kind:'OB.UI.Button',name:'OB.OBPOSPointOfSale.UI.customers.newcustomersave',style:'width: 100px; margin: 0px 5px 8px 19px;',classes:'btnlink btnlink-small',i18nLabel:'OBPOS_LblSave',events:{onSaveCustomer:''},tap:function(){this.doSaveCustomer();}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.subwindowNewCustomer_bodyheader',components:[{components:[{style:'display: table; margin: 0 auto;',components:[{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.newcustomersave'}]},{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.cancelEdit',handlers:{onSetCustomer:'setCustomer'},setCustomer:function(inSender,inEvent){this.customer=inEvent.customer;},tap:function(){var subWindow=this.subWindow;if(subWindow.caller==='mainSubWindow'){subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller}});}else{subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller,params:{navigateOnClose:'customerAdvancedSearch',businessPartner:this.customer}}});}}}]}]}]}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.edit_createcustomers_impl',kind:'OB.OBPOSPointOfSale.UI.customers.edit_createcustomers',style:'padding: 9px 15px;',windowHeader:'OB.OBPOSPointOfSale.UI.customers.subwindowNewCustomer_bodyheader',newAttributes:[{kind:'OB.UI.CustomerTextProperty',name:'firstName',modelProperty:'firstName',isFirstFocus:true,i18nLabel:'OBPOS_LblName',maxlength:60},{kind:'OB.UI.CustomerTextProperty',name:'lastName',modelProperty:'lastName',isFirstFocus:true,i18nLabel:'OBPOS_LblLastName',maxlength:60},{kind:'OB.UI.CustomerComboProperty',name:'customerCategory',modelProperty:'businessPartnerCategory',modelPropertyText:'businessPartnerCategory_name',collectionName:'BPCategoryList',defaultValue:function(){return OB.MobileApp.model.get('terminal').defaultbp_bpcategory;},retrievedPropertyForValue:'id',retrievedPropertyForText:'_identifier',fetchDataFunction:function(args){var me=this,criteria;criteria={_orderByClause:'_identifier asc'};OB.Dal.find(OB.Model.BPCategory,criteria,function(data,args){me.dataReadyFunction(data,args);},function(error){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_ErrorGettingBPCategories'));me.dataReadyFunction(null,args);},args);},i18nLabel:'OBPOS_BPCategory',displayLogic:function(){return OB.MobileApp.model.get('terminal').bp_showcategoryselector;}},{kind:'OB.UI.CustomerTextProperty',name:'customerTaxId',modelProperty:'taxID',i18nLabel:'OBPOS_LblTaxId',displayLogic:function(){return OB.MobileApp.model.get('terminal').bp_showtaxid;},maxlength:20},{kind:'OB.UI.CustomerTextProperty',name:'customerLocName',modelProperty:'locName',i18nLabel:'OBPOS_LblAddress',maxlength:60},{kind:'OB.UI.CustomerTextProperty',name:'customerPostalCode',modelProperty:'postalCode',i18nLabel:'OBPOS_LblPostalCode',maxlength:10},{kind:'OB.UI.CustomerTextProperty',name:'customerCity',modelProperty:'cityName',i18nLabel:'OBPOS_LblCity',maxlength:60},{kind:'OB.UI.CustomerTextProperty',name:'customerPhone',modelProperty:'phone',i18nLabel:'OBPOS_LblPhone',maxlength:40},{kind:'OB.UI.CustomerTextProperty',name:'customerEmail',modelProperty:'email',i18nLabel:'OBPOS_LblEmail',maxlength:255},{kind:'OB.UI.CustomerComboProperty',name:'customerPriceList',modelProperty:'priceList',modelPropertyText:'priceList_name',collectionName:'PriceListList',defaultValue:function(){return OB.MobileApp.model.get('pricelist').id;},retrievedPropertyForValue:'m_pricelist_id',retrievedPropertyForText:'name',fetchDataFunction:function(args){var me=this,criteria;criteria={_orderByClause:'name asc'};OB.Dal.find(OB.Model.PriceList,criteria,function(data,args){data.add([{m_pricelist_id:OB.MobileApp.model.get('pricelist').id,name:OB.MobileApp.model.get('pricelist').name}],{at:0});me.dataReadyFunction(data,args);},function(error){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_ErrorGettingBPPriceList'));me.dataReadyFunction(null,args);},args);},i18nLabel:'OBPOS_PriceList',displayLogic:function(){return OB.MobileApp.model.hasPermission('EnableMultiPriceList',true);}}]});enyo.kind({kind:'OB.UI.Subwindow',name:'OB.OBPOSPointOfSale.UI.customers.editcustomer',events:{onShowPopup:''},beforeSetShowing:function(params){this.waterfall('onSetCustomer',{customer:params.businessPartner});return true;},defaultNavigateOnClose:'customerAdvancedSearch',header:{kind:'OB.UI.SubwindowHeader',i18nHeaderMessage:'OBPOS_TitleViewCustomer',onTapCloseButton:function(){var subWindow=this.subWindow;subWindow.doChangeSubWindow({newWindow:{name:subWindow.navigateOnClose,params:{navigateOnClose:'mainSubWindow'}}});}},body:{kind:'OB.OBPOSPointOfSale.UI.customers.editcustomers_impl'}});enyo.kind({kind:'OB.UI.Button',name:'OB.OBPOSPointOfSale.UI.customers.assigncustomertoticket',style:'margin: 0px 0px 8px 5px;',classes:'btnlink btnlink-small',handlers:{onSetCustomer:'setCustomer'},events:{onChangeBusinessPartner:''},setCustomer:function(inSender,inEvent){this.customer=inEvent.customer;},tap:function(){var sw=this.subWindow;sw.doChangeSubWindow({newWindow:{name:'mainSubWindow'}});this.doChangeBusinessPartner({businessPartner:this.customer});},init:function(model){this.model=model;},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_LblAssignToTicket'));}});enyo.kind({kind:'OB.UI.Button',name:'OB.OBPOSPointOfSale.UI.customers.editnewaddress',style:'margin: 0px 0px 8px 5px;',classes:'btnlink btnlink-small',handlers:{onSetCustomer:'setCustomer'},events:{onHideThisPopup:''},setCustomer:function(inSender,inEvent){this.customer=inEvent.customer;},tap:function(){if(this.disabled){return true;}
this.doHideThisPopup();this.model.get('subWindowManager').set('currentWindow',{name:'customerAddressSearch',params:{caller:'mainSubWindow',bPartner:this.customer.get('id')}});},init:function(model){this.model=model;},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_TitleEditNewAddress'));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customers.EditCustomerWindowHeader',events:{onSearchAction:''},components:[{components:[{style:'display: table; margin: 0 auto;',components:[{components:[{kind:'OB.UI.Button',handlers:{onSetCustomer:'setCustomer'},style:'width: 100px; margin: 0px 5px 8px 19px;',classes:'btnlink-orange btnlink btnlink-small',setCustomer:function(inSender,inEvent){this.customer=inEvent.customer;if(!OB.MobileApp.model.hasPermission('OBPOS_retail.editCustomers')){this.disabled=true;this.setAttribute("disabled","disabled");}else{this.disabled=false;this.setAttribute("disabled",null);}},tap:function(){if(this.disabled===false){var sw=this.subWindow;this.model.get('subWindowManager').set('currentWindow',{name:'customerCreateAndEdit',params:{businessPartner:this.customer,navigateOnClose:sw.getName()}});}},init:function(model){this.model=model;},initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblEdit'));}}]},{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.assigncustomertoticket'}]},{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customers.editnewaddress'}]}]}]}],searchAction:function(){this.doSearchAction({bpName:this.$.filterText.getValue()});}});enyo.kind({kind:'OB.OBPOSPointOfSale.UI.customers.edit_createcustomers',name:'OB.OBPOSPointOfSale.UI.customers.editcustomers_impl',style:'padding: 9px 15px;',windowHeader:'OB.OBPOSPointOfSale.UI.customers.EditCustomerWindowHeader',newAttributes:[{kind:'OB.UI.CustomerTextProperty',name:'customerName',modelProperty:'firstName',i18nLabel:'OBPOS_LblName',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'lastName',modelProperty:'lastName',i18nLabel:'OBPOS_LblLastName',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'customerBpCat',modelProperty:'businessPartnerCategory_name',i18nLabel:'OBPOS_BPCategory',readOnly:true,displayLogic:function(){return OB.MobileApp.model.get('terminal').bp_showcategoryselector;}},{kind:'OB.UI.CustomerTextProperty',name:'customerTaxId',modelProperty:'taxID',i18nLabel:'OBPOS_LblTaxId',readOnly:true,displayLogic:function(){return OB.MobileApp.model.get('terminal').bp_showtaxid;}},{kind:'OB.UI.CustomerTextProperty',name:'customerLocName',modelProperty:'locName',i18nLabel:'OBPOS_LblAddress',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'customerPostalCode',modelProperty:'postalCode',i18nLabel:'OBPOS_LblPostalCode',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'customerCity',modelProperty:'cityName',i18nLabel:'OBPOS_LblCity',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'customerPhone',modelProperty:'phone',i18nLabel:'OBPOS_LblPhone',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'customerEmail',modelProperty:'email',i18nLabel:'OBPOS_LblEmail',readOnly:true},{kind:'OB.UI.CustomerTextProperty',name:'customerPriceList',modelProperty:'priceList',i18nLabel:'OBPOS_PriceList',readOnly:true,loadValue:function(inSender,inEvent){if(inEvent.customer!==undefined){if(inEvent.customer.get(this.modelProperty)!==undefined){var me=this;OB.UTIL.getPriceListName(inEvent.customer.get(this.modelProperty),function(name){me.setValue(name);});}}else{this.setValue('');}},displayLogic:function(){return OB.MobileApp.model.hasPermission('EnableMultiPriceList',true);}}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.ModalConfigurationRequiredForCreateCustomers',kind:'OB.UI.ModalInfo',i18nHeader:'OBPOS_configurationRequired',bodyContent:{i18nContent:'OBPOS_configurationNeededToCreateCustomers'}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.cancelEdit',kind:'OB.UI.Button',style:'width: 100px; margin: 0px 0px 8px 5px;',classes:'btnlink-gray btnlink btnlink-small',i18nContent:'OBMOBC_LblCancel'});enyo.kind({name:'OB.UI.CustomerPropertyLine',components:[{name:'labelLine',style:'font-size: 15px; color: black; text-align: right; border: 1px solid #FFFFFF; background-color: #E2E2E2; width: 20%; height: 28px; padding: 12px 5px 1px 0; float: left;'},{style:'border: 1px solid #FFFFFF; float: left; width: 75%;',name:'newAttribute'},{style:'clear: both'}],initComponents:function(){this.inherited(arguments);this.$.newAttribute.createComponent(this.newAttribute);this.$.labelLine.content=this.newAttribute.i18nLabel?OB.I18N.getLabel(this.newAttribute.i18nLabel):this.newAttribute.label;}});enyo.kind({name:'OB.UI.CustomerAddrTextProperty',kind:'enyo.Input',type:'text',classes:'input',style:'width: 100%; height: 30px; margin:0;',handlers:{onLoadValue:'loadValue',onSaveChange:'saveChange'},events:{onSaveProperty:''},loadValue:function(inSender,inEvent){if(inEvent.customerAddr!==undefined){if(inEvent.customerAddr.get(this.modelProperty)!==undefined){this.setValue(inEvent.customerAddr.get(this.modelProperty));}}else{this.setValue('');if(this.modelProperty==='countryName'){this.setValue(OB.MobileApp.model.get('terminal').defaultbp_bpcountry_name);}}
if(this.modelProperty==='customerName'&&inEvent.customer!==undefined&&inEvent.customer.get('name')!==undefined){this.setValue(inEvent.customer.get('name'));}},saveChange:function(inSender,inEvent){inEvent.customerAddr.set(this.modelProperty,this.getValue());},initComponents:function(){if(this.readOnly){this.setAttribute('readonly','readonly');}
if(this.maxlength){this.setAttribute('maxlength',this.maxlength);}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.edit_createcustomers',handlers:{onSetCustomerAddr:'setCustomerAddr',onSaveCustomerAddr:'saveCustomerAddr'},events:{onChangeBusinessPartner:''},components:[{name:'bodyheader'},{name:'customerAddrAttributes',style:'overflow-x:hidden; overflow-y:auto; max-height:622px;'}],setCustomerAddr:function(inSender,inEvent){this.customer=inEvent.customer;this.customerAddr=inEvent.customerAddr;this.waterfall('onLoadValue',{customer:this.customer,customerAddr:this.customerAddr});},saveCustomerAddr:function(inSender,inEvent){var me=this,sw=me.subWindow;function getCustomerAddrValues(params){me.waterfall('onSaveChange',{customer:params.customer,customerAddr:params.customerAddr});}
function goToViewWindow(sw,params){if(sw.caller==='mainSubWindow'){sw.doChangeSubWindow({newWindow:{name:'customerAddressView',params:{navigateOnClose:'mainSubWindow',businessPartner:params.customer,bPLocation:params.customerAddr}}});}else{sw.doChangeSubWindow({newWindow:{name:'customerAddressView',params:{navigateOnClose:'customerAddressSearch',businessPartner:params.customer,bPLocation:params.customerAddr}}});}}
if(this.customerAddr===undefined){this.model.get('customerAddr').newCustomerAddr();this.model.get('customerAddr').set('bpartner',this.customer.get('id'));this.waterfall('onSaveChange',{customerAddr:this.model.get('customerAddr')});if(this.model.get('customerAddr').get('name')===''){OB.UTIL.showWarning('Address is required for BPartner');return false;}else if(this.model.get('customerAddr').saveCustomerAddr()){goToViewWindow(sw,{customer:OB.UTIL.clone(this.customer),customerAddr:OB.UTIL.clone(this.model.get('customerAddr'))});}}else{this.model.get('customerAddr').loadById(this.customerAddr.get('id'),function(customerAddr){if(customerAddr.get('name')===""){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_BPartnerAddressRequired'));return false;}else{getCustomerAddrValues({customerAddr:customerAddr});if(customerAddr.saveCustomerAddr()){goToViewWindow(sw,{customer:me.customer,customerAddr:customerAddr});if(customerAddr.get('id')===me.customer.get("locId")){me.customer.set('locId',customerAddr.get('id'));me.customer.set('locName',customerAddr.get('name'));me.customer.set('locationModel',customerAddr);OB.Dal.save(me.customer,function success(tx){me.doChangeBusinessPartner({businessPartner:me.customer});},function error(tx){OB.error(tx);});}}}});}},initComponents:function(){this.inherited(arguments);this.$.bodyheader.createComponent({kind:this.windowHeader});this.attributeContainer=this.$.customerAddrAttributes;enyo.forEach(this.newAttributes,function(natt){var resultDisplay=true,undf;if(natt.displayLogic!==undf&&natt.displayLogic!==null){if(enyo.isFunction(natt.displayLogic)){resultDisplay=natt.displayLogic(this);}else{resultDisplay=natt.displayLogic;}}
if(resultDisplay){this.$.customerAddrAttributes.createComponent({kind:'OB.UI.CustomerPropertyLine',name:'line_'+natt.name,newAttribute:natt});}},this);},init:function(model){this.model=model;}});enyo.kind({kind:'OB.UI.Subwindow',name:'OB.OBPOSPointOfSale.UI.customeraddr.newcustomeraddr',events:{onShowPopup:''},beforeSetShowing:function(params){if(OB.MobileApp.model.get('terminal').defaultbp_paymentmethod!==null&&OB.MobileApp.model.get('terminal').defaultbp_bpcategory!==null&&OB.MobileApp.model.get('terminal').defaultbp_paymentterm!==null&&OB.MobileApp.model.get('terminal').defaultbp_invoiceterm!==null&&OB.MobileApp.model.get('terminal').defaultbp_bpcountry!==null&&OB.MobileApp.model.get('terminal').defaultbp_bporg!==null){this.waterfall('onSetCustomerAddr',{customer:params.businessPartner,customerAddr:params.bPLocation});return true;}else{this.doShowPopup({popup:'modalConfigurationRequiredForCreateNewCustomers'});return false;}},defaultNavigateOnClose:'customerAddressView',header:{kind:'OB.UI.SubwindowHeader',name:'OB.OBPOSPointOfSale.UI.customeraddr.newcustomerheader',handlers:{onSetCustomerAddr:'setCustomerAddr'},i18nHeaderMessage:'OBPOS_TitleEditNewCustomerAddress',setCustomerAddr:function(inSender,inEvent){this.customer=inEvent.customer;this.customerAddr=inEvent.customerAddr;},onTapCloseButton:function(){var subWindow=this.subWindow;var customer,customerAddr;if(this.headerContainer){customer=this.headerContainer.customer;customerAddr=this.headerContainer.customerAddr;}else{customer=this.customer;customerAddr=this.customerAddr;}
if(subWindow.caller==='mainSubWindow'){subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller}});}else{subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller,params:{navigateOnClose:'customerAddressSearch',businessPartner:customer,bPLocation:customerAddr}}});}}},body:{kind:'OB.OBPOSPointOfSale.UI.customeraddr.edit_createcustomers_impl'}});enyo.kind({kind:'OB.UI.Button',name:'OB.OBPOSPointOfSale.UI.customeraddr.newcustomeraddrsave',style:'width: 100px; margin: 0px 5px 8px 19px;',classes:'btnlink btnlink-small',i18nLabel:'OBPOS_LblSave',events:{onSaveCustomerAddr:''},tap:function(){this.doSaveCustomerAddr();}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.subwindowNewCustomer_bodyheader',components:[{components:[{style:'display: table; margin: 0 auto;',components:[{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customeraddr.newcustomeraddrsave'}]},{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customeraddr.cancelEdit',handlers:{onSetCustomerAddr:'setCustomerAddr'},setCustomerAddr:function(inSender,inEvent){this.customer=inEvent.customer;this.customerAddr=inEvent.customerAddr;},tap:function(){var subWindow=this.subWindow;if(subWindow.caller==='mainSubWindow'){subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller}});}else{subWindow.doChangeSubWindow({newWindow:{name:subWindow.caller,params:{navigateOnClose:'customerAddressSearch',businessPartner:this.customer,bPLocation:this.customerAddr}}});}}}]}]}]}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.edit_createcustomers_impl',kind:'OB.OBPOSPointOfSale.UI.customeraddr.edit_createcustomers',style:'padding: 9px 15px;',windowHeader:'OB.OBPOSPointOfSale.UI.customeraddr.subwindowNewCustomer_bodyheader',newAttributes:[{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrCustomerName',modelProperty:'customerName',i18nLabel:'OBPOS_LblCustomer',readOnly:true},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrName',modelProperty:'name',i18nLabel:'OBPOS_LblAddress',maxlength:60},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrPostalCode',modelProperty:'postalCode',i18nLabel:'OBPOS_LblPostalCode',maxlength:10},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrCity',modelProperty:'cityName',i18nLabel:'OBPOS_LblCity',maxlength:60},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrCountry',modelProperty:'countryName',i18nLabel:'OBPOS_LblCountry',readOnly:true}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.ModalCustomerAddrScrollableHeader',kind:'OB.UI.ScrollableTableHeader',style:'border-bottom: 10px solid #ff0000;',events:{onSearchAction:'',onClearAction:''},handlers:{onFiltered:'searchAction'},components:[{style:'padding: 10px; 10px; 0px; 10px;',components:[{style:'display: table;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'customerAddressSearchfilterText',style:'width: 100%',isFirstFocus:true}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 100px; margin: 0px 5px 8px 19px;',ontap:'clearAction'}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 100px; margin: 0px 0px 8px 5px;',name:'CustomerAddressSearchButton',ontap:'searchAction'}]}]}]}],clearAction:function(){this.$.customerAddressSearchfilterText.setValue('');this.doClearAction();},searchAction:function(){this.doSearchAction({locName:this.$.customerAddressSearchfilterText.getValue(),operator:OB.Dal.CONTAINS});return true;}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.ListCustomerAddrLine',kind:'OB.UI.SelectButton',classes:'btnselect-customer',components:[{name:'line',style:'line-height: 23px;',components:[{style:'float: left; font-weight: bold;',name:'identifier'},{style:'clear: both;'}]}],create:function(){this.inherited(arguments);if(_.isString(this.model.get('name'))&&this.model.get('name').length>0){this.$.identifier.setContent(this.model.get('name')+' - '+this.model.get('countryName'));}else{this.$.identifier.setContent(OB.I18N.getLabel('OBPOS_EmptyLocation')+' - '+this.model.get('countryName'));}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.SearchCustomerButton',kind:'OB.UI.Button',events:{onSearchAction:''},classes:'btnlink-left-toolbar',searchAction:function(params){this.doSearchAction({locName:params.initial,operator:params.operator});},initComponents:function(){this.inherited(arguments);this.setContent(this.i18nLabel?OB.I18N.getLabel(this.i18nLabel):this.label);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.CustomerAddrLeftBar',components:[{kind:'OB.OBPOSPointOfSale.UI.customeraddr.NewCustomerAddrButton',i18nLabel:'OBPOS_LblNew'}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.NewCustomerAddrButton',kind:'OB.UI.Button',events:{onChangeSubWindow:''},published:{businessPartner:null},disabled:false,classes:'btnlink-left-toolbar',tap:function(){if(this.disabled){return true;}
var sw=this.subWindow;this.doChangeSubWindow({newWindow:{name:'customerAddrCreateAndEdit',params:{navigateOnClose:'customerAddrCreateAndEdit',businessPartner:this.businessPartner}}});},putDisabled:function(status){if(status===false){this.disabled=false;this.setDisabled(false);this.removeClass('disabled');return;}else{this.disabled=true;this.setDisabled(true);this.addClass('disabled');}},initComponents:function(){this.inherited(arguments);this.putDisabled(!OB.MobileApp.model.hasPermission('OBPOS_retail.editCustomers'));this.setContent(this.i18nLabel?OB.I18N.getLabel(this.i18nLabel):this.label);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.ListCustomerAddress',handlers:{onSearchAction:'searchAction',onClearAction:'clearAction'},published:{bPartnerId:null,bPartnerModel:null},events:{onChangeBusinessPartner:'',onChangeSubWindow:''},components:[{style:'text-align: center; padding-top: 10px; float: left; width: 19%;',components:[{kind:'OB.OBPOSPointOfSale.UI.customeraddr.CustomerAddrLeftBar'}]},{style:'float: left; width: 80%;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'bpsloclistitemprinter',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'301px',renderHeader:'OB.OBPOSPointOfSale.UI.customeraddr.ModalCustomerAddrScrollableHeader',renderLine:'OB.OBPOSPointOfSale.UI.customeraddr.ListCustomerAddrLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}]},{style:'clear: both'}],clearAction:function(inSender,inEvent){this.bpsLocList.reset();return true;},searchAction:function(inSender,inEvent){var me=this,filter=inEvent.locName,criteria={};function errorCallback(tx,error){OB.UTIL.showError("OBDAL error: "+error);}
function successCallbackBPsLoc(dataBps,args){me.bpsLocList.reset();if(dataBps&&dataBps.length>0){me.bpsLocList.add(dataBps.models);}}
if(filter&&_.isString(filter)&&filter.length>0){criteria.name={operator:OB.Dal.CONTAINS,value:filter};}
criteria.bpartner=this.bPartnerId;if(OB.MobileApp.model.hasPermission('OBPOS_remote.customer',true)){var filterIdentifier={columns:['_filter'],operator:'startsWith',value:filter},bPartnerId={columns:['bpartner'],operator:'equals',value:this.bPartnerId,isId:true};var remoteCriteria=[filterIdentifier,bPartnerId];criteria.remoteFilters=remoteCriteria;}
OB.Dal.find(OB.Model.BPLocation,criteria,successCallbackBPsLoc,errorCallback);return true;},bpsLocList:null,init:function(){this.bpsLocList=new Backbone.Collection();this.$.bpsloclistitemprinter.setCollection(this.bpsLocList);this.bpsLocList.on('click',function(model){var sw=this.subWindow;this.doChangeSubWindow({newWindow:{name:'customerAddressView',params:{navigateOnClose:sw.getName(),businessPartner:this.bPartnerModel,bPLocation:model}}});},this);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.casbody',components:[{kind:'OB.OBPOSPointOfSale.UI.customeraddr.ListCustomerAddress',style:'padding: 15px; padding-top: 0px;'}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.cas',kind:'OB.UI.Subwindow',events:{onSearchAction:''},beforeSetShowing:function(params){if(params.bPartner){var listCustAddr=this.$.subWindowBody.$.casbody.$.listCustomerAddress;listCustAddr.setBPartnerId(params.bPartner);OB.Dal.get(OB.Model.BusinessPartner,params.bPartner,function successCallbackBPs(dataBps){listCustAddr.setBPartnerModel(dataBps);listCustAddr.$.customerAddrLeftBar.$.newCustomerAddrButton.setBusinessPartner(dataBps);},function errorCallback(tx,error){});}
if(this.caller==='mainSubWindow'){this.waterfall('onSearchAction',{cleanResults:true});}
this.$.subWindowBody.$.casbody.$.listCustomerAddress.$.bpsloclistitemprinter.$.theader.$.modalCustomerAddrScrollableHeader.searchAction();return true;},beforeClose:function(dest){if(dest==='mainSubWindow'){this.waterfall('onSearchAction',{cleanResults:true});}
return true;},defaultNavigateOnClose:'mainSubWindow',header:{kind:'OB.UI.SubwindowHeader',i18nHeaderMessage:'OBPOS_TitleCustomerAddressSearch',onTapCloseButton:function(){var subWindow=this.subWindow;subWindow.doChangeSubWindow({newWindow:{name:'mainSubWindow'}});}},body:{kind:'OB.OBPOSPointOfSale.UI.customeraddr.casbody'}});enyo.kind({kind:'OB.UI.Subwindow',name:'OB.OBPOSPointOfSale.UI.customeraddr.editcustomeraddr',events:{onShowPopup:''},beforeSetShowing:function(params){this.waterfall('onSetCustomerAddr',{customer:params.businessPartner,customerAddr:params.bPLocation});return true;},defaultNavigateOnClose:'customerAddressSearch',header:{kind:'OB.UI.SubwindowHeader',i18nHeaderMessage:'OBPOS_TitleViewCustomerAddress',onTapCloseButton:function(){var subWindow=this.subWindow;subWindow.doChangeSubWindow({newWindow:{name:subWindow.navigateOnClose,params:{navigateOnClose:'mainSubWindow'}}});}},body:{kind:'OB.OBPOSPointOfSale.UI.customeraddr.editcustomers_impl'}});enyo.kind({kind:'OB.UI.Button',name:'OB.OBPOSPointOfSale.UI.customeraddr.assigncustomeraddrtoticket',style:'margin: 0px 0px 8px 5px;',classes:'btnlink btnlink-small',handlers:{onSetCustomerAddr:'setCustomerAddr'},events:{onChangeBusinessPartner:''},setCustomerAddr:function(inSender,inEvent){this.customer=inEvent.customer;this.customerAddr=inEvent.customerAddr;},tap:function(){var me=this;me.customer.set('locId',me.customerAddr.get('id'));me.customer.set('locName',me.customerAddr.get('name'));me.customer.set('postalCode',me.customerAddr.get('postalCode'));me.customer.set('cityName',me.customerAddr.get('cityName'));me.customer.set('countryName',me.customerAddr.get('countryName'));me.customer.set('locationModel',me.customerAddr);me.doChangeBusinessPartner({businessPartner:me.customer});var sw=me.subWindow;sw.doChangeSubWindow({newWindow:{name:'mainSubWindow'}});},init:function(model){this.model=model;},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBPOS_LblAssignAddress'));}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.customeraddr.EditCustomerWindowHeader',events:{onSearchAction:''},components:[{components:[{style:'display: table; margin: 0 auto;',components:[{components:[{kind:'OB.UI.Button',handlers:{onSetCustomerAddr:'setCustomerAddr'},style:'width: 100px; margin: 0px 5px 8px 19px;',classes:'btnlink-orange btnlink btnlink-small',setCustomerAddr:function(inSender,inEvent){this.customer=inEvent.customer;this.customerAddr=inEvent.customerAddr;if(!OB.MobileApp.model.hasPermission('OBPOS_retail.editCustomers')){this.disabled=true;this.setAttribute("disabled","disabled");}else{this.disabled=false;this.setAttribute("disabled",null);}},tap:function(){if(this.disabled===false){var sw=this.subWindow;this.model.get('subWindowManager').set('currentWindow',{name:'customerAddrCreateAndEdit',params:{businessPartner:this.customer,bPLocation:this.customerAddr,navigateOnClose:sw.getName()}});}},init:function(model){this.model=model;},initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblEdit'));}}]},{style:'display: table-cell;',components:[{kind:'OB.OBPOSPointOfSale.UI.customeraddr.assigncustomeraddrtoticket'}]}]}]}],searchAction:function(){this.doSearchAction({bpName:this.$.filterText.getValue()});}});enyo.kind({kind:'OB.OBPOSPointOfSale.UI.customeraddr.edit_createcustomers',name:'OB.OBPOSPointOfSale.UI.customeraddr.editcustomers_impl',style:'padding: 9px 15px;',windowHeader:'OB.OBPOSPointOfSale.UI.customeraddr.EditCustomerWindowHeader',newAttributes:[{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrCustomerName',modelProperty:'customerName',i18nLabel:'OBPOS_LblCustomer',readOnly:true},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrName',modelProperty:'name',i18nLabel:'OBPOS_LblAddress',readOnly:true},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrPostalCode',modelProperty:'postalCode',i18nLabel:'OBPOS_LblPostalCode',readOnly:true},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrCity',modelProperty:'cityName',i18nLabel:'OBPOS_LblCity',readOnly:true},{kind:'OB.UI.CustomerAddrTextProperty',name:'customerAddrCountry',modelProperty:'countryName',i18nLabel:'OBPOS_LblCountry',readOnly:true}]});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore',myId:'ModalStockInStore',published:{stockInfo:null},kind:'OB.UI.Modal',header:'',body:{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.ListStockInStore',name:'stockDetailList'},executeOnHide:function(){this.stockInfo=null;},executeOnShow:function(){this.setStockInfo(this.args.stockInfo);},stockInfoChanged:function(oldValue){if(this.stockInfo){this.$.header.setContent(this.stockInfo.get('product').get('_identifier')+' ('+this.stockInfo.get('product').get('uOMsymbol')+')');this.$.body.$.stockDetailList.setStockValuesPerWarehouse(this.stockInfo.get('warehouses'));}else{this.$.body.$.stockDetailList.setStockValuesPerWarehouse(null);}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.ListStockInStore',classes:'row-fluid',published:{stockValuesPerWarehouse:null},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;'},{components:[{name:'scrollListStockDetails',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.StockInStoreLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}],stockValuesPerWarehouseChanged:function(oldValue){if(this.stockValuesPerWarehouse){this.$.scrollListStockDetails.setCollection(this.stockValuesPerWarehouse);}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.StockInStoreLine',classes:'btnselect',components:[{name:'line',style:'line-height: 23px;',components:[{style:'float: left; width: 60%; font-size: 20px;',name:'warehouse'},{style:'float: left; width: 25%; font-weight: bold; font-size: 20px;',name:'quantity'},{style:'clear: both'}]},{components:[{style:'padding: 5px; padding-left: 10px;',name:'detail',allowHtml:true}]}],create:function(){var str="";this.inherited(arguments);this.$.warehouse.setContent(this.model.get('warehousename'));this.$.quantity.setContent(this.model.get('warehouseqty'));this.model.get('bins').each(function(model){str+='<b>'+model.get('binqty')+'</b> - '+model.get('binname')+'<br/>';});this.$.detail.setContent(str);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStoreClickable',myId:'ModalStockInStoreClickable',kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore',body:{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.ListStockInStoreClickable',name:'stockDetailListClickable'},stockInfoChanged:function(oldValue){if(this.stockInfo){this.$.header.setContent(this.stockInfo.get('product').get('_identifier')+' ('+this.stockInfo.get('product').get('uOMsymbol')+')');this.$.body.$.stockDetailListClickable.setStockValuesPerWarehouse(this.stockInfo.get('warehouses'));}else{this.$.body.$.stockDetailListClickable.setStockValuesPerWarehouse(null);}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.ListStockInStoreClickable',kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.ListStockInStore',components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;'},{components:[{name:'scrollListStockDetailsClickable',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.StockInStoreLineClickable',renderEmpty:'OB.UI.RenderEmpty'}]}]}],stockValuesPerWarehouseChanged:function(oldValue){if(this.stockValuesPerWarehouse){this.$.scrollListStockDetailsClickable.setCollection(this.stockValuesPerWarehouse);}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.StockInStoreLineClickable',kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInStore.Components.StockInStoreLine',classes:'stockinstorelines',events:{onHideThisPopup:'',onWarehouseSelected:''},tap:function(){this.doHideThisPopup();this.doWarehouseSelected({warehouseid:this.model.get('warehouseid'),warehousename:this.model.get('warehousename'),warehouseqty:this.model.get('warehouseqty')});}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInOtherStores',myId:'ModalStockInOtherStores',published:{stockInfo:null},kind:'OB.UI.Modal',header:'',body:{kind:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInOtherStores.Components.ListStockInOtherStores',name:'stockDetailList'},executeOnHide:function(){this.stockInfo=null;},executeOnShow:function(){this.setStockInfo(this.args.stockInfo);},stockInfoChanged:function(oldValue){if(this.stockInfo){this.$.header.setContent(this.stockInfo.get('product').get('_identifier')+' ('+this.stockInfo.get('product').get('uOMsymbol')+')');this.$.body.$.stockDetailList.setStockValuesOtherStores(this.stockInfo.get('organizations'));}else{this.$.body.$.stockDetailList.setStockValuesOtherStores(null);}}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInOtherStores.Components.ListStockInOtherStores',classes:'row-fluid',published:{stockValuesOtherStores:null},components:[{classes:'span12',components:[{style:'border-bottom: 1px solid #cccccc;'},{components:[{name:'scrollListStockDetails',kind:'OB.UI.ScrollableTable',scrollAreaMaxHeight:'400px',renderLine:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInOtherStores.Components.StockInOtherStoresLine',renderEmpty:'OB.UI.RenderEmpty'}]}]}],stockValuesOtherStoresChanged:function(oldValue){this.$.scrollListStockDetails.setCollection(this.stockValuesOtherStores);}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalStockInOtherStores.Components.StockInOtherStoresLine',classes:'btnselect',components:[{name:'line',style:'line-height: 23px;',components:[{style:'float: left; width: 60%; font-size: 20px;',name:'organization'},{style:'float: left; width: 25%; font-weight: bold; font-size: 20px;',name:'quantity'},{style:'clear: both'}]},{components:[{style:'padding: 5px; padding-left: 10px;',name:'detail',allowHtml:true}]}],create:function(){var str="";this.inherited(arguments);this.$.organization.setContent(this.model.get('organizationname'));this.$.quantity.setContent(this.model.get('organizationqty'));this.model.get('warehouses').each(function(model){str+='<b>'+model.get('warehouseqty')+' </b> - '+model.get('warehousename')+'<br/>';});this.$.detail.setContent(str);}});enyo.kind({kind:'OB.UI.Modal',topPosition:'75px',name:'OB.OBPOSPointOfSale.UI.Modals.ModalPaymentsSelect',events:{onHideThisPopup:''},handlers:{onSearchAction:'searchAction',onFiltered:'searchAction'},body:{components:[{style:'padding: 10px 10px 5px 10px;',components:[{style:'display: table;  width: 100%;',components:[{style:'display: table-cell; width: 100%;',components:[{kind:'OB.UI.SearchInputAutoFilter',name:'paymentname',style:'width: 100%;',isFirstFocus:true}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-gray btn-icon-small btn-icon-clear',style:'width: 80px; margin: 0px 5px 8px 19px;',tap:function(){this.owner.$.paymentname.setValue('');this.bubble('onSearchAction');}}]},{style:'display: table-cell;',components:[{kind:'OB.UI.SmallButton',classes:'btnlink-yellow btn-icon-small btn-icon-search',style:'width: 80px; margin: 0px 0px 8px 5px;',tap:function(){this.bubble('onSearchAction');}}]}]},{style:'margin: 5px 0px 5px 0px; width: 100%; border-bottom: 1px solid #cccccc;'},{name:'paymentMethods',kind:'Scroller',horizontal:'hidden',maxHeight:'330px; padding-top: 10px;',setItems:function(items){var i=0,components=this.getComponents();while(i<components.length){if(components[i].name!=='strategy'){components[i++].destroy();}else{i++;}}
items.forEach(function(item){this.createComponent({classes:'paymentmethoditems',tag:'div',allowHtml:true,content:'<img class="paymentmethoditemsimage" src="'+(item.image?item.image:'img/PMImgNotAvailable.png')+'"/><div class="paymentmethoditemstext">'+item.name+'</div>',payment:item.payment,tap:function(){var dialog=this.owner.owner.owner;dialog.bubble('onStatusChanged',{payment:this.payment,status:this.payment.payment.searchKey,amount:dialog.args.amount});dialog.bubble('onPaymentChanged',{payment:this.payment,status:this.payment.payment.searchKey,amount:dialog.args.amount});dialog.doHideThisPopup();}});},this);if(items.length===0){this.createComponent({tag:'div',classes:'paymentmethodnotitems',content:OB.I18N.getLabel('OBPOS_PaymentsNoItems')});}
this.render();}}]}]},searchAction:function(){var items=[],payments=OB.POS.modelterminal.get('payments'),filterBy=this.$.body.$.paymentname.getValue().toUpperCase();enyo.forEach(payments,function(payment){if(payment.paymentMethod.paymentMethodCategory&&payment.paymentMethod.paymentMethodCategory===this.args.idCategory&&OB.MobileApp.model.hasPermission(payment.payment.searchKey)){if(filterBy===''||payment.paymentMethod._identifier.toUpperCase().indexOf(filterBy)>=0){items.push({name:payment.paymentMethod._identifier,image:payment.image,payment:payment});}}},this);this.$.body.$.paymentMethods.setItems(items);var me=this;setTimeout(function(){me.$.body.$.paymentMethods.render();},1);},executeOnShow:function(){this.setHeader(OB.I18N.getLabel('OBPOS_PaymentsSelectCaption'));this.searchAction();this.bubble('onClearPaymentSelect');}});enyo.kind({kind:'OB.UI.ModalInfo',name:'OB.OBPOSPointOfSale.UI.Modals.ModalProductCannotBeGroup',i18nHeader:'OBPOS_productCannotBeGroupHeader',bodyContent:{i18nContent:'OBPOS_productCannotBeGroupMessage'}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.ModalConfigurationRequiredForCrossStore',kind:'OB.UI.ModalInfo',i18nHeader:'OBPOS_configurationRequired',bodyContent:{i18nContent:'OBPOS_configurationNeededToCrossStore'},myId:'modalConfigurationRequiredForCrossStore'});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.OBPOSPointOfSale.UI.Modals.modalEnoughCredit',bodyContent:{name:'popupmessage',content:''},bodyButtons:{components:[{kind:'OB.OBPOSPointOfSale.UI.Modals.modalEnoughCredit.Components.apply_button'},{kind:'OB.OBPOSPointOfSale.UI.Modals.modalEnoughCredit.Components.cancel_button'}]},executeOnShow:function(){var pendingQty=this.args.order.getPending();var bpName=this.args.order.get('bp').get('_identifier');var selectedPaymentMethod=this.args.order.get('selectedPayment');var currSymbol;var rate=1,i;var paymentList=OB.MobileApp.model.get('payments');for(i=0;i<paymentList.length;i++){if(paymentList[i].payment.searchKey===selectedPaymentMethod){rate=paymentList[i].mulrate;currSymbol=paymentList[i].symbol;}}
this.setHeader(OB.I18N.getLabel('OBPOS_enoughCreditHeader'));if(this.args.message){this.$.bodyContent.$.popupmessage.setContent(OB.I18N.getLabel(this.args.message));}else if(this.args.order.get('orderType')===1){this.$.bodyContent.$.popupmessage.setContent(OB.I18N.getLabel('OBPOS_enoughCreditReturnBody',[OB.I18N.formatCurrency(pendingQty*rate)+" "+currSymbol,bpName]));}else{this.$.bodyContent.$.popupmessage.setContent(OB.I18N.getLabel('OBPOS_enoughCreditBody',[OB.I18N.formatCurrency(pendingQty*rate)+" "+currSymbol,bpName]));}}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.modalEnoughCredit.Components.apply_button',i18nContent:'OBPOS_LblUseCredit',isDefaultAction:true,init:function(model){this.model=model;},tap:function(){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("modalDialogButtonTap");function error(tx){OB.UTIL.showError("OBDAL error: "+tx);OB.UTIL.SynchronizationHelper.finished(synchId,"modalDialogButtonTap");}
this.doHideThisPopup();this.model.get('order').set('paidOnCredit',true);this.allowOpenDrawer=false;var payments=this.model.get('order').get('payments');var me=this;payments.each(function(payment){if(payment.get('allowOpenDrawer')||payment.get('isCash')){me.allowOpenDrawer=true;}});if(this.allowOpenDrawer){OB.POS.hwserver.openDrawer({openFirst:false,receipt:this.model.get('order')},OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerSales);}
var bp=this.model.get('order').get('bp');var bpCreditUsed=this.model.get('order').get('bp').get('creditUsed');var totalPending=this.model.get('order').getPending();if(this.parent.parent.parent.parent.args.order.get('gross')<0){bp.set('creditUsed',bpCreditUsed-totalPending);}else{bp.set('creditUsed',bpCreditUsed+totalPending);}
OB.Dal.save(bp,function(){me.model.get('order').trigger('paymentDone');OB.UTIL.SynchronizationHelper.finished(synchId,"modalDialogButtonTap");},error);}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSPointOfSale.UI.Modals.modalEnoughCredit.Components.cancel_button',i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalInfo',name:'OB.OBPOSPointOfSale.UI.Modals.modalNotEnoughCredit',style:'background-color: #EBA001;',i18nHeader:'OBPOS_notEnoughCreditHeader',isDefaultAction:true,executeOnShow:function(){if(this.args){this.$.bodyContent.$.popupmessage.setContent(OB.I18N.getLabel('OBPOS_notEnoughCreditBody',[this.args.bpName,OB.I18N.formatCurrency(this.args.actualCredit)]));}},bodyContent:{name:'popupmessage',content:''}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.modalDiscountNeedQty',kind:'OB.UI.ModalInfo',i18nHeader:'OBPOS_discountNeedsQty_header',bodyContent:{i18nContent:'OBPOS_discountNeedsQty_body'}});enyo.kind({name:'OB.OBPOSPointOfSale.UI.Modals.modalNotValidValueForDiscount',kind:'OB.UI.ModalInfo',i18nHeader:'OBPOS_modalNotValidValueForDiscount_header',bodyContent:{i18nContent:'OBPOS_modalNotValidValueForDiscount_body'}});(function(){enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.MessageDialog',header:'',bodyContent:{name:'bodymessage',content:''},bodyButtons:{components:[{kind:'OB.UI.MessageDialogOK'}]},executeOnShow:function(){this.$.header.setContent(this.args.header);this.$.bodyContent.$.bodymessage.setContent(this.args.message);}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.MessageDialogOK',i18nContent:'OBMOBC_LblOk',isDefaultAction:true,tap:function(){this.doHideThisPopup();}});OB.UI.WindowView.registerPopup('OB.OBPOSPointOfSale.UI.PointOfSale',{kind:'OB.UI.MessageDialog',name:'OB_UI_MessageDialog'});}());(function(){var PrintCashMgmt=function(){this.templatecashmgmt=new OB.DS.HWResource(OB.OBPOSCashMgmt.Print.CashMgmtTemplate);};PrintCashMgmt.prototype.print=function(depsdropstosave){OB.POS.hwserver.print(this.templatecashmgmt,{cashmgmt:depsdropstosave});};OB.OBPOSCashMgmt=OB.OBPOSCashMgmt||{};OB.OBPOSCashMgmt.Print=OB.OBPOSCashMgmt.Print||{};OB.OBPOSCashMgmt.Print.CashMgmt=PrintCashMgmt;OB.OBPOSCashMgmt.Print.CashMgmtTemplate='res/printcashmgmt.xml';}());OB.OBPOSCashMgmt=OB.OBPOSCashMgmt||{};OB.OBPOSCashMgmt.Model=OB.OBPOSCashMgmt.Model||{};OB.OBPOSCashMgmt.UI=OB.OBPOSCashMgmt.UI||{};OB.OBPOSCashMgmt.Model.CashManagement=OB.Model.WindowModel.extend({models:[OB.Model.CashManagement],payments:null,init:function(){OB.error("This init method should never be called for this model. Call initModels and loadModels instead");this.initModels(function(){});this.loadModels(function(){});},initModels:function(initModelsCallback){var me=this;this.depsdropstosave=new Backbone.Collection();this.depsdropstosave.on('paymentDone',function(model,p){OB.UTIL.Debug.execute(function(){if(!me.payments){OB.error("The 'payments' variable has not been initialized (value: "+me.payments+"'");}});var isError=false;me.payments.each(function(pay){if(p.id===pay.get('paymentmethod_id')){isError=(p.type==='drop'&&OB.DEC.sub(pay.get('total'),OB.DEC.mul(p.amount,p.rate))<0);}});if(isError){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_MsgMoreThanAvailable'));return;}
OB.Dal.find(OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){var now=new Date();var addedCashMgmt=new OB.Model.CashManagement({id:OB.UTIL.get_UUID(),description:p.identifier+' - '+model.get('name'),amount:p.amount,origAmount:OB.DEC.mul(p.amount,p.rate),type:p.type,reasonId:model.get('id'),paymentMethodId:p.id,user:OB.MobileApp.model.get('context').user._identifier,userId:OB.MobileApp.model.get('context').user.id,creationDate:OB.I18N.normalizeDate(now),timezoneOffset:now.getTimezoneOffset(),isocode:p.isocode,glItem:p.glItem,cashup_id:cashUp.at(0).get('id'),posTerminal:OB.MobileApp.model.get('terminal').id,isbeingprocessed:'N'});me.depsdropstosave.add(addedCashMgmt);var selectedPayment=me.payments.filter(function(payment){return payment.get('paymentmethod_id')===p.id;})[0];if(selectedPayment.get('listdepositsdrops')){selectedPayment.get('listdepositsdrops').push(addedCashMgmt);selectedPayment.trigger('change');}else{selectedPayment.set('listdepositsdrops',[addedCashMgmt]);}},null,this);},this);this.depsdropstosave.on('makeDeposits',function(){me=this;TestRegistry.CashMgmt=TestRegistry.CashMgmt||{};TestRegistry.CashMgmt.isCashDepositPrinted=false;OB.UTIL.showLoading(true);if(this.depsdropstosave.length===0){OB.POS.navigate('retail.pointofsale');return true;}
this.printCashMgmt=new OB.OBPOSCashMgmt.Print.CashMgmt();TestRegistry.CashMgmt.isCashDepositPrinted=true;function runSync(){if(OB.MobileApp.model.get('connectedToERP')){OB.MobileApp.model.runSyncProcess(function(){OB.UTIL.showLoading(false);me.set("finished",true);if(OB.MobileApp.model.hasPermission('OBPOS_print.cashmanagement')){me.printCashMgmt.print(me.depsdropstosave.toJSON());}});}else{OB.UTIL.showLoading(false);me.set("finished",true);if(OB.MobileApp.model.hasPermission('OBPOS_print.cashmanagement')){me.printCashMgmt.print(me.depsdropstosave.toJSON());}}}
var paymentList=new Backbone.Collection(),found=false,i;function addAttributes(depdrop){var payment=new OB.Model.PaymentMethodCashUp();if(depdrop.get('type')==='deposit'){payment.set('paymentMethodId',depdrop.get('paymentMethodId'));payment.set('cashup_id',depdrop.get('cashup_id'));payment.set('totalDeposits',depdrop.get('amount'));payment.set('totalDrops',0);}else{payment.set('paymentMethodId',depdrop.get('paymentMethodId'));payment.set('cashup_id',depdrop.get('cashup_id'));payment.set('totalDrops',depdrop.get('amount'));payment.set('totalDeposits',0);}
return payment;}
_.each(this.depsdropstosave.models,function(depdrop){if(paymentList.length>0){for(i=0;i<paymentList.length;i++){found=false;if(paymentList.models[i].get('paymentMethodId')===depdrop.get('paymentMethodId')){var paymentMethod=paymentList.models[i],totalDeposits=0,totalDrops=0,depos=paymentMethod.get('totalDeposits'),drop=paymentMethod.get('totalDrops');if(depdrop.get('type')==='deposit'){totalDeposits=OB.DEC.add(depos,depdrop.get('amount'));paymentMethod.set('totalDeposits',totalDeposits);}else{totalDrops=OB.DEC.add(drop,depdrop.get('amount'));paymentMethod.set('totalDrops',totalDrops);}
found=true;break;}}
if(!found){paymentList.add(addAttributes(depdrop));}}else{paymentList.add(addAttributes(depdrop));}},this);var runSyncProcessCM=_.after(this.depsdropstosave.models.length,runSync);_.each(this.depsdropstosave.models,function(depdrop,index){OB.Dal.save(depdrop,function(){OB.UTIL.sumCashManagementToCashup(paymentList.models[index]);OB.UTIL.calculateCurrentCash();runSyncProcessCM();},function(){OB.UTIL.showLoading(false);me.set("finishedWrongly",true);return;},true);},this);},this);this.set('payments',new Backbone.Collection());this.set('cashMgmtDropEvents',new Backbone.Collection(OB.MobileApp.model.get('cashMgmtDropEvents')));this.set('cashMgmtDepositEvents',new Backbone.Collection(OB.MobileApp.model.get('cashMgmtDepositEvents')));initModelsCallback();},loadModels:function(loadModelsCallback){var me=this;function updateCashMgmEvents(paymentMethodList){var i,paymentMethodId;for(i=0;i<me.get('cashMgmtDepositEvents').models.length;i++){paymentMethodId=me.get('cashMgmtDepositEvents').at(i).get('paymentmethod');if(paymentMethodList.indexOf(paymentMethodId)===-1){me.get('cashMgmtDepositEvents').remove(me.get('cashMgmtDepositEvents').at(i));}}
for(i=0;i<me.get('cashMgmtDropEvents').models.length;i++){paymentMethodId=me.get('cashMgmtDropEvents').at(i).get('paymentmethod');if(paymentMethodList.indexOf(paymentMethodId)===-1){me.get('cashMgmtDropEvents').remove(me.get('cashMgmtDropEvents').at(i));}}}
function loadCashup(callback,args){OB.UTIL.Debug.execute(function(){if(!args){OB.error("The 'args' variable must be provided. Use {} for nothing");}});var paymentMth;var criteria;var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("cashmanagement");enyo.$.scrim.show();function finishSynch(){OB.UTIL.SynchronizationHelper.finished(synchId,"cashmanagement");enyo.$.scrim.hide();}
var asyncToSyncWrapper=new Promise(function(resolve,reject){OB.Dal.find(OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){OB.Dal.find(OB.Model.PaymentMethodCashUp,{'cashup_id':cashUp.at(0).get('id'),_orderByClause:'searchKey desc'},function(pays){me.set('listpaymentmethodid',[]);me.payments=pays;function updatePaymentMethod(pay){return new Promise(function(resolve,reject){criteria={'paymentMethodId':pay.get('paymentmethod_id'),'cashup_id':cashUp.at(0).get('id')};paymentMth=OB.MobileApp.model.get('payments').filter(function(payment){return payment.payment.id===pay.get('paymentmethod_id');})[0].paymentMethod;if(OB.POS.modelterminal.get('terminal').isslave&&paymentMth.isshared){resolve();return;}
if(paymentMth.allowdeposits||paymentMth.allowdrops){if(me.get('listpaymentmethodid').indexOf(paymentMth.paymentMethod)===-1){me.get('listpaymentmethodid').push(paymentMth.paymentMethod);}
OB.Dal.find(OB.Model.CashManagement,criteria,function(cashmgmt,pay){if(cashmgmt.length>0){pay.set('listdepositsdrops',cashmgmt.models);}
if(args.slavePayments){_.each(args.slavePayments,function(slavePay){if(slavePay.searchKey===pay.get('searchKey')){pay.set('startingCash',OB.DEC.add(pay.get('startingCash'),slavePay.startingCash));pay.set('totalDeposits',OB.DEC.add(pay.get('totalDeposits'),slavePay.totalDeposits));pay.set('totalDrops',OB.DEC.add(pay.get('totalDrops'),slavePay.totalDrops));pay.set('totalReturns',OB.DEC.add(pay.get('totalReturns'),slavePay.totalReturns));pay.set('totalSales',OB.DEC.add(pay.get('totalSales'),slavePay.totalSales));}});}
me.get('payments').add(pay);resolve();},reject,pay);}else{resolve();}});}
var paymentsToLoad=[];pays.each(function(pay){paymentsToLoad.push(updatePaymentMethod(pay));});Promise.all(paymentsToLoad).then(function(){updateCashMgmEvents(me.get('listpaymentmethodid'));resolve();},function(){OB.error("Could not load the payment method's information");reject();});},reject);},reject,this);});asyncToSyncWrapper.then(function(){finishSynch();callback();},function(){OB.error("Could not load cashup related information");});}
function loadSlaveCashup(callback){new OB.DS.Process('org.openbravo.retail.posterminal.ProcessCashMgmtMaster').exec({cashUpId:OB.POS.modelterminal.get('terminal').cashUpId,terminalSlave:OB.POS.modelterminal.get('terminal').isslave},function(data){if(data&&data.exception){OB.log('error',data.exception.message);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashMgmtError'),OB.I18N.getLabel('OBPOS_ErrorServerGeneric')+data.exception.message,[{label:OB.I18N.getLabel('OBPOS_LblRetry'),action:function(){loadSlaveCashup(callback);}}],{autoDismiss:false,onHideFunction:function(){OB.POS.navigate('retail.pointofsale');}});}else{callback(data);}});}
if(OB.POS.modelterminal.get('terminal').ismaster){loadSlaveCashup(function(data){loadCashup(loadModelsCallback,{slavePayments:data});});}else{loadCashup(loadModelsCallback,{});}}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.CashMgmtKeyboard',kind:'OB.UI.Keyboard',events:{onShowPopup:''},getPayment:function(id,key,iscash,allowopendrawer,name,identifier,type,rate,isocode,glItem,paymentMethod){var me=this;var i;return{permission:key,action:function(keyboard,txt){txt=OB.I18N.parseNumber(txt);if(txt===0){OB.UTIL.showI18NWarning('OBPOS_NoCashMgmtZero','OBPOS_NoCashMgmtZero');return;}
keyboard.owner.owner.owner.currentPayment={id:id,amount:txt,identifier:identifier,destinationKey:key,type:type,rate:rate,isocode:isocode,iscash:iscash,allowopendrawer:allowopendrawer,glItem:glItem,paymentMethod:paymentMethod};me.owner.owner.owner.model.attributes.cashMgmtDropEvents.reset(OB.MobileApp.model.attributes.cashMgmtDropEvents);me.owner.owner.owner.model.attributes.cashMgmtDepositEvents.reset(OB.MobileApp.model.attributes.cashMgmtDepositEvents);var backupDropEvents=new Backbone.Collection();var backupDepositEvents=new Backbone.Collection();if(type==='drop'){me.owner.owner.owner.model.attributes.cashMgmtDropEvents.each(function(cmevent){backupDropEvents.add(cmevent);});backupDropEvents.each(function(cmevent){if(cmevent.attributes.paymentmethod!==paymentMethod||cmevent.get('isocode')!==isocode){me.owner.owner.owner.model.attributes.cashMgmtDropEvents.remove(cmevent);}});me.doShowPopup({popup:'modaldropevents'});}else{me.owner.owner.owner.model.attributes.cashMgmtDepositEvents.each(function(cmevent){backupDepositEvents.add(cmevent);});backupDepositEvents.each(function(cmevent){if(cmevent.attributes.paymentmethod!==paymentMethod||cmevent.get('isocode')!==isocode){me.owner.owner.owner.model.attributes.cashMgmtDepositEvents.remove(cmevent);}});me.doShowPopup({popup:'modaldepositevents'});}}};},init:function(){var buttons=[];this.inherited(arguments);buttons.push({command:'opendrawer',i18nLabel:'OBPOS_OpenDrawer',stateless:true,definition:{stateless:true,action:function(keyboard,amt){OB.POS.hwserver.openCheckDrawer(false,OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerCount);}}});_.bind(this.getPayment,this);_.each(OB.MobileApp.model.get('payments'),function(paymentMethod){if(OB.POS.modelterminal.get('terminal').isslave&&paymentMethod.paymentMethod.isshared){return true;}
var payment=paymentMethod.payment,i;if(paymentMethod.paymentMethod.allowdeposits){for(i=0;i<OB.MobileApp.model.get('cashMgmtDepositEvents').length;i++){if(OB.MobileApp.model.get('cashMgmtDepositEvents')[i].isocode===paymentMethod.isocode&&paymentMethod.paymentMethod.paymentMethod===OB.MobileApp.model.get('cashMgmtDepositEvents')[i].paymentmethod){buttons.push({idSufix:'Deposit.'+paymentMethod.isocode,command:payment.searchKey+'_'+OB.I18N.getLabel('OBPOS_LblDeposit'),definition:this.getPayment(payment.id,payment.searchKey,paymentMethod.paymentMethod.iscash,paymentMethod.paymentMethod.allowopendrawer,payment._identifier,payment._identifier,'deposit',paymentMethod.rate,paymentMethod.isocode,paymentMethod.paymentMethod.gLItemForDeposits,paymentMethod.paymentMethod.paymentMethod),label:payment._identifier+' '+OB.I18N.getLabel('OBPOS_LblDeposit')});break;}}}
if(paymentMethod.paymentMethod.allowdrops){for(i=0;i<OB.MobileApp.model.get('cashMgmtDropEvents').length;i++){if(OB.MobileApp.model.get('cashMgmtDropEvents')[i].isocode===paymentMethod.isocode&&paymentMethod.paymentMethod.paymentMethod===OB.MobileApp.model.get('cashMgmtDropEvents')[i].paymentmethod){buttons.push({idSufix:'Withdrawal.'+paymentMethod.isocode,command:payment.searchKey+'_'+OB.I18N.getLabel('OBPOS_LblWithdrawal'),definition:this.getPayment(payment.id,payment.searchKey,paymentMethod.paymentMethod.iscash,paymentMethod.paymentMethod.allowopendrawer,payment._identifier,payment._identifier,'drop',paymentMethod.rate,paymentMethod.isocode,paymentMethod.paymentMethod.gLItemForDrops,paymentMethod.paymentMethod.paymentMethod),label:payment._identifier+' '+OB.I18N.getLabel('OBPOS_LblWithdrawal')});break;}}}},this);this.addToolbar({name:'cashMgmtToolbar',buttons:buttons});this.showToolbar('cashMgmtToolbar');}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.ModalDepositEvents',kind:'OB.UI.Modal',topPosition:'125px',body:{kind:'OB.OBPOSCashMgmt.UI.ListEvents'}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.ListEvents',classes:'row-fluid',components:[{classes:'span12',components:[{}]}],init:function(model){this.createComponent({name:this.owner.owner.type,kind:'OB.UI.Table',style:'overflow: auto; max-height: 600px',renderLine:'OB.OBPOSCashMgmt.UI.ListEventLine',renderEmpty:'OB.UI.RenderEmpty'});this.model=model;this.$[this.owner.owner.type].setCollection(this.model.get(this.owner.owner.type));}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.ListEventLine',kind:'OB.UI.SelectButton',style:'height: 60px; background-color: #dddddd; border: 1px solid #ffffff;',events:{onHideThisPopup:''},components:[{name:'line',style:'padding: 1px 0px 1px 5px;'}],tap:function(){this.inherited(arguments);this.doHideThisPopup();},create:function(){this.inherited(arguments);this.$.line.setContent(this.model.get('name'));}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.CashMgmtInfo',components:[{style:'position: relative; background: #363636; color: white; height: 200px; margin: 5px; padding: 5px',components:[{kind:'OB.UI.Clock',classes:'pos-clock'},{style:'padding: 10px; float: left; width: 320px; line-height: 23px;',name:'infoLbl'}]}],initComponents:function(){this.inherited(arguments);this.$.infoLbl.setContent(OB.I18N.getLabel('OBPOS_LblDepositsWithdrawalsMsg'));}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.DoneButton',kind:'OB.UI.RegularButton',classes:'btnlink-white btnlink-fontgray',style:'min-width: 115px;',i18nContent:'OBPOS_LblDone',tap:function(){this.owner.owner.model.depsdropstosave.trigger('makeDeposits');}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.RenderDepositLine',components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{name:'description',style:'padding: 6px 20px 6px 10px;  float: left; width:30%'},{name:'user',style:'text-align:right; padding: 6px 20px 6px 10px; float: left;  width: 12%'},{name:'time',style:'text-align:right; padding: 6px 20px 6px 10px; float: left;  width: 8%'},{name:'foreignAmt',style:'text-align:right; padding: 6px 0px 6px 10px; float: left;  width: 15% ',content:''},{name:'amt',style:'text-align:right; padding: 6px 20px 6px 10px; float: right; width: 20%'}]}]}],create:function(){var amnt,foreignAmt,lbl;this.inherited(arguments);if(this.model.get('type')==='drop'){lbl=OB.I18N.getLabel('OBPOS_LblWithdrawal')+': ';if(this.model.get('origAmount')!==this.model.get('amount')){foreignAmt=OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('amount')));amnt=OB.I18N.formatCurrency(this.model.get('origAmount'));}else{amnt=OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('amount')));}}else{lbl=OB.I18N.getLabel('OBPOS_LblDeposit')+': ';if(this.model.get('origAmount')!==this.model.get('amount')){foreignAmt=OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('amount')));amnt=OB.I18N.formatCurrency(this.model.get('origAmount'));}else{amnt=OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('amount')));}}
var creationDate=new Date(this.model.get('creationDate'));this.$.description.setContent(lbl+this.model.get('description'));this.$.user.setContent(this.model.get('user'));this.$.time.setContent(OB.UTIL.padNumber(creationDate.getHours(),2)+':'+OB.UTIL.padNumber(creationDate.getMinutes(),2));if(foreignAmt&&((this.model.get('rate')&&this.model.get('rate')!=='1')||amnt!==foreignAmt)){this.$.foreignAmt.setContent('('+foreignAmt+' '+this.model.get('isocode')+')');}
this.$.amt.setContent(amnt);}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.RenderForeignTotal',tag:'span',published:{foreignTotal:null,textForeignTotal:''},create:function(){this.inherited(arguments);this.owner.model.on('change:total',function(model){this.setForeignTotal(model.get('total'));},this);},foreignTotalChanged:function(oldValue){this.setContent(this.textForeignTotal);if(OB.DEC.compare(this.foreignTotal)<0){this.applyStyle('color','red');}else{this.applyStyle('color','black');}}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.RenderTotal',tag:'span',published:{total:null},create:function(){this.inherited(arguments);this.owner.model.on('change:total',function(model){this.setTotal(model.get('total'));},this);},totalChanged:function(oldValue){this.setContent(OB.I18N.formatCurrency(this.total));if(OB.DEC.compare(this.total)<0){this.applyStyle('color','red');}else{this.applyStyle('color','black');}}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.RenderDepositsDrops',components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'padding: 10px 20px 10px 10px;  float: left;'},{style:'clear: both;'}]}]},{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{name:'startingCashPayName',style:'padding: 6px 20px 6px 10px;  float: left; width: 61%'},{name:'startingCashForeignAmnt',style:'text-align:right; padding: 6px 0px 6px 10px; float: left; width: 15%',content:''},{name:'startingCashAmnt',style:'text-align:right; padding: 6px 20px 6px 10px; float: right;'}]}]},{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{name:'tenderedLbl',style:'padding: 6px 20px 6px 10px;  float: left; width: 61%'},{name:'tenderedForeignAmnt',style:'text-align:right; padding: 6px 0px 6px 10px; float: left; width: 15%',content:''},{name:'tenderedAmnt',style:'text-align:right; padding: 6px 20px 6px 10px; float: right;'}]}]},{name:'theList',listStyle:'list',kind:'OB.UI.Table',renderLine:'OB.OBPOSCashMgmt.UI.RenderDepositLine',renderEmpty:'enyo.Control'},{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{name:'availableLbl',style:'padding: 10px 20px 10px 10px; float: left; width: 61%; font-weight:bold;'},{style:'text-align:right; padding:  6px 0px 6px 10px; float: left; width: 15%; font-weight:bold;',components:[{name:'foreignTotal',kind:'OB.OBPOSCashMgmt.UI.RenderForeignTotal',style:'float:right;'}]},{style:'padding: 10px 20px 10px 0px;  float: right;',components:[{name:'total',kind:'OB.OBPOSCashMgmt.UI.RenderTotal',style:'float:right; font-weight: bold;'}]}]}]}],create:function(){var transactionsArray=this.model.get('listdepositsdrops'),transactionsCollection=new Backbone.Collection(transactionsArray),total;var fromCurrencyId=OB.MobileApp.model.paymentnames[this.model.attributes.searchKey].paymentMethod.currency;this.inherited(arguments);total=OB.DEC.add(0,this.model.get('startingCash'));total=OB.DEC.add(total,this.model.get('totalSales'));total=OB.DEC.sub(total,OB.DEC.abs(this.model.get('totalReturns')));var totalDeposits=_.reduce(transactionsArray,function(accum,trx){if(trx.get('type')==='deposit'){return OB.DEC.add(accum,trx.get('amount'));}else{return OB.DEC.sub(accum,OB.DEC.abs(trx.get('amount')));}},0);total=OB.DEC.add(total,totalDeposits);this.$.availableLbl.setContent(OB.I18N.getLabel('OBPOS_LblNewAvailableIn')+' '+this.model.get('name'));if(OB.UTIL.currency.isDefaultCurrencyId(fromCurrencyId)){this.model.set('total',total,{silent:true});this.$.total.setTotal(total);}else{var foreignTotal=OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,total);this.model.set('total',foreignTotal,{silent:true});this.$.total.setTotal(foreignTotal);if(foreignTotal>0){this.$.foreignTotal.setTextForeignTotal('('+OB.I18N.formatCurrency(total)+' '+this.model.get('isocode')+')');this.$.foreignTotal.setForeignTotal(total);}}
this.$.theList.setCollection(transactionsCollection);this.$.startingCashPayName.setContent(OB.I18N.getLabel('OBPOS_LblStarting')+' '+this.model.get('name'));var startingCash=OB.DEC.add(0,this.model.get('startingCash'));this.$.startingCashAmnt.setContent(OB.I18N.formatCurrency(OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,startingCash)));if((OB.UTIL.currency.isDefaultCurrencyId(fromCurrencyId)===false)&&(startingCash>0)){this.$.startingCashForeignAmnt.setContent('('+OB.I18N.formatCurrency(startingCash)+' '+this.model.get('isocode')+')');}
this.$.tenderedLbl.setContent(OB.I18N.getLabel('OBPOS_LblTotalTendered')+' '+this.model.get('name'));var totalSalesReturns=OB.DEC.add(0,OB.DEC.sub(this.model.get('totalSales'),this.model.get('totalReturns')));if((OB.UTIL.currency.isDefaultCurrencyId(fromCurrencyId)===false)&&(totalSalesReturns>0)){this.$.tenderedForeignAmnt.setContent('('+OB.I18N.formatCurrency(totalSalesReturns)+' '+this.model.get('isocode')+')');}
this.$.tenderedAmnt.setContent(OB.I18N.formatCurrency(OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,totalSalesReturns)));}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.ListDepositsDrops',components:[{style:'overflow:auto; height: 400px; margin: 5px; background-color: white;',components:[{style:'background-color: #ffffff; color: black; padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'padding: 6px; border-bottom: 1px solid #cccccc;text-align:center; font-weight:bold;',name:'titleLbl'},{name:'userName',style:'padding: 6px; border-bottom: 1px solid #cccccc; text-align:center;'},{name:'time',style:'padding: 6px; border-bottom: 1px solid #cccccc; text-align:center;'},{name:'store',style:'padding: 6px; border-bottom: 1px solid #cccccc; text-align:center;'},{name:'terminal',style:'padding: 6px; border-bottom: 1px solid #cccccc; text-align:center;'},{name:'depositDropsList',kind:'OB.UI.Table',renderLine:'OB.OBPOSCashMgmt.UI.RenderDepositsDrops',renderEmpty:'enyo.Control',listStyle:'list'}]}]}]}]}],create:function(){var now=new Date();this.inherited(arguments);this.$.userName.setContent(OB.I18N.getLabel('OBPOS_LblUser')+': '+OB.MobileApp.model.get('context').user._identifier);this.$.time.setContent(OB.I18N.getLabel('OBPOS_LblTime')+': '+OB.I18N.formatDate(now)+' '+OB.I18N.formatHour(now,true));this.$.store.setContent(OB.I18N.getLabel('OBPOS_LblStore')+': '+OB.MobileApp.model.get('terminal').organization$_identifier);this.$.terminal.setContent(OB.I18N.getLabel('OBPOS_LblTerminal')+': '+OB.MobileApp.model.get('terminal')._identifier);},init:function(model){this.model=model;this.$.depositDropsList.setCollection(this.model.get('payments'));this.$.titleLbl.setContent(OB.I18N.getLabel('OBPOS_LblCashManagement'));}});enyo.kind({name:'OB.OBPOSCashMgmt.UI.LeftToolbarImpl',kind:'OB.UI.MultiColumn.Toolbar',synchId:null,buttons:[{kind:'OB.UI.ToolbarButton',name:'btnCancel',disabled:false,i18nLabel:'OBMOBC_LblCancel',stepCount:0,span:6,tap:function(){OB.POS.hwserver.checkDrawer(function(){OB.POS.navigate('retail.pointofsale');});}},{kind:'OB.UI.ToolbarButton',name:'btnDone',disabled:true,i18nLabel:'OBPOS_LblDone',stepCount:0,span:6,handlers:{synchronizing:'disableButton',synchronized:'enableButton'},disableButton:function(){this.setDisabled(true);},enableButton:function(){this.setDisabled(false);},init:function(model){this.model=model;},tap:function(){OB.POS.hwserver.checkDrawer(function(){this.model.depsdropstosave.trigger('makeDeposits');},this);}}]});enyo.kind({name:'OB.OBPOSCashMgmt.UI.RightToolbarImpl',kind:'OB.UI.MultiColumn.Toolbar',buttons:[{kind:'OB.UI.ToolbarButton',name:'btnCashMgmt',span:12,disabled:true,i18nLabel:'OBPOS_LblCashManagement'}]});enyo.kind({name:'OB.OBPOSCashMgmt.UI.CashManagement',kind:'OB.UI.WindowView',windowmodel:OB.OBPOSCashMgmt.Model.CashManagement,tag:'section',events:{onShowPopup:''},components:[{kind:'OB.UI.MultiColumn',name:'cashupMultiColumn',leftToolbar:{kind:'OB.OBPOSCashMgmt.UI.LeftToolbarImpl',name:'leftToolbar',showMenu:false,showWindowsMenu:false},rightToolbar:{kind:'OB.OBPOSCashMgmt.UI.RightToolbarImpl',name:'rightToolbar',showMenu:false,showWindowsMenu:false},leftPanel:{name:'cashmgmtLeftPanel',components:[{classes:'row',components:[{classes:'span12',components:[{kind:'OB.OBPOSCashMgmt.UI.ListDepositsDrops'}]}]}]},rightPanel:{name:'cashmgmtRightPanel',components:[{classes:'span12',components:[{kind:'OB.OBPOSCashMgmt.UI.CashMgmtInfo'},{kind:'OB.OBPOSCashMgmt.UI.CashMgmtKeyboard'}]}]}},{components:[{kind:'OB.OBPOSCashMgmt.UI.ModalDepositEvents',i18nHeader:'OBPOS_SelectDepositDestinations',name:'modaldepositevents',type:'cashMgmtDepositEvents'},{kind:'OB.OBPOSCashMgmt.UI.ModalDepositEvents',i18nHeader:'OBPOS_SelectDropDestinations',name:'modaldropevents',type:'cashMgmtDropEvents'}]}],init:function(){this.inherited(arguments);this.model.get('cashMgmtDepositEvents').on('click',function(model){this.model.depsdropstosave.trigger('paymentDone',model,this.currentPayment);delete this.currentPayment;},this);this.model.get('cashMgmtDropEvents').on('click',function(model){this.model.depsdropstosave.trigger('paymentDone',model,this.currentPayment);delete this.currentPayment;},this);this.model.on('change:finished',function(){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_LblDone'),OB.I18N.getLabel('OBPOS_FinishCashMgmtDialog'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.POS.navigate('retail.pointofsale');}}],{autoDismiss:false,onHideFunction:function(){OB.POS.navigate('retail.pointofsale');}});},this);this.model.on('change:finishedWrongly',function(){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashMgmtWronglyHeader'),OB.I18N.getLabel('OBPOS_CashMgmtWrongly'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.POS.navigate('retail.pointofsale');}}],{autoDismiss:false,onHideFunction:function(){OB.POS.navigate('retail.pointofsale');}});},this);}});OB.POS.registerWindow({windowClass:OB.OBPOSCashMgmt.UI.CashManagement,route:'retail.cashmanagement',menuPosition:10,menuI18NLabel:'OBPOS_LblCashManagement',permission:'OBPOS_retail.cashmanagement',approvalType:'OBPOS_approval.cashmgmt'});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.OBPOSCashMgmt.UI.modalFinished',i18nHeader:'OBPOS_LblDone',bodyContent:{i18nContent:'OBPOS_FinishCashMgmtDialog'},bodyButtons:{components:[{kind:'OB.OBPOSCashMgmt.UI.modalFinished_OkButton'}]},executeOnHide:function(){OB.POS.navigate('retail.pointofsale');}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSCashMgmt.UI.modalFinished_OkButton',i18nContent:'OBMOBC_LblOk',tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.OBPOSCashMgmt.UI.modalFinishedWrongly',i18nHeader:'OBPOS_CashMgmtWronglyHeader',bodyContent:{i18nContent:'OBPOS_CashMgmtWrongly'},bodyButtons:{components:[{kind:'OB.OBPOSCashMgmt.UI.modalFinishedWrongly_OkButton'}]},executeOnHide:function(){OB.POS.navigate('retail.pointofsale');}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSCashMgmt.UI.modalFinishedWrongly_OkButton',i18nContent:'OBMOBC_LblOk',tap:function(){this.doHideThisPopup();}});enyo.kind({name:'OB.CashUp.StepPendingOrders',kind:enyo.Object,getStepComponent:function(leftpanel$){return leftpanel$.listPendingReceipts;},getToolbarName:function(){return'toolbarempty';},nextFinishButton:function(){return false;},allowNext:function(){return this.model.get('orderlist').length===0&&!this.model.get('pendingOrdersToProcess');},getSubstepsLength:function(model){return 1;},isSubstepAvailable:function(model,substep){return true;}});enyo.kind({name:'OB.CashUp.Master',kind:enyo.Object,getStepComponent:function(leftpanel$){return leftpanel$.cashMaster;},getToolbarName:function(){return'toolbarempty';},nextFinishButton:function(){return false;},allowNext:function(){return this.model.get('slavesCashupCompleted');},getSubstepsLength:function(model){return 1;},isSubstepAvailable:function(model,substep){return true;}});enyo.kind({name:'OB.CashUp.CashPayments',kind:enyo.Object,getStepComponent:function(leftpanel$){return leftpanel$.cashPayments;},getToolbarName:function(){return'toolbarcashpayments';},nextFinishButton:function(){return false;},allowNext:function(){return true;},getSubstepsLength:function(model){return model.get('paymentList').length;},isSubstepAvailable:function(model,substep){var payment=model.get('paymentList').at(substep);var paymentMethod=payment.get('paymentMethod');return paymentMethod.iscash&&paymentMethod.countcash;}});enyo.kind({name:'OB.CashUp.PaymentMethods',kind:enyo.Object,getStepComponent:function(leftpanel$){return leftpanel$.listPaymentMethods;},getToolbarName:function(){return'toolbarcountcash';},nextFinishButton:function(){return false;},allowNext:function(){return _.reduce(this.model.get('paymentList').models,function(allCounted,model){return allCounted&&model.get('counted')!==null&&model.get('counted')!==undefined;},true);},getSubstepsLength:function(model){return this.model.get('paymentList').length>0?1:0;},isSubstepAvailable:function(model,substep){return true;}});enyo.kind({name:'OB.CashUp.CashToKeep',kind:enyo.Object,getStepComponent:function(leftpanel$){return leftpanel$.cashToKeep;},getToolbarName:function(){if(this.model.get('paymentList').at(this.model.get('substep')).get('paymentMethod').allowvariableamount){return'toolbarother';}else{return'toolbarempty';}},nextFinishButton:function(){return false;},allowNext:function(){var qtyToKeep=this.model.get('paymentList').at(this.model.get('substep')).get('qtyToKeep');var foreignCounted=this.model.get('paymentList').at(this.model.get('substep')).get('foreignCounted');return _.isNumber(qtyToKeep)&&foreignCounted>=qtyToKeep;},getSubstepsLength:function(model){return model.get('paymentList').length;},isSubstepAvailable:function(model,substep){var payment=model.get('paymentList').at(substep);var paymentMethod=payment.get('paymentMethod');var options=0;if(paymentMethod.automatemovementtoother){if(paymentMethod.allowmoveeverything){payment.set('qtyToKeep',0);options++;}
if(paymentMethod.allowdontmove){payment.set('qtyToKeep',payment.get('foreignCounted'));options++;}
if(paymentMethod.keepfixedamount){if(_.isNumber(payment.get('foreignCounted'))&&payment.get('foreignCounted')<paymentMethod.amount){payment.set('qtyToKeep',payment.get('foreignCounted'));}else{payment.set('qtyToKeep',paymentMethod.amount);}
options++;}
return(options>1||paymentMethod.allowvariableamount);}else{return false;}}});enyo.kind({name:'OB.CashUp.PostPrintAndClose',kind:enyo.Object,getStepComponent:function(leftpanel$){return leftpanel$.postPrintClose;},getToolbarName:function(){return'toolbarempty';},nextFinishButton:function(){return true;},allowNext:function(){return true;},getSubstepsLength:function(model){return 1;},isSubstepAvailable:function(model,substep){return true;}});(function(){var PrintCashUp=function(){var terminal=OB.MobileApp.model.get('terminal');this.templatecashup=new OB.DS.HWResource(terminal.printCashUpTemplate||OB.OBPOSPointOfSale.Print.CashUpTemplate);this.cancelOrDismiss=function(){OB.POS.navigate('retail.pointofsale');OB.MobileApp.view.$.confirmationContainer.setAttribute('openedPopup','');};};PrintCashUp.prototype.print=function(report,sumary,closed){var me=this;OB.POS.hwserver.print(this.templatecashup,{cashup:{closed:closed,report:report,summary:sumary}},function(result){if(result&&result.exception){OB.MobileApp.view.$.confirmationContainer.setAttribute('openedPopup',OB.I18N.getLabel('OBPOS_MsgPrintAgainCashUp'));OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_MsgHardwareServerNotAvailable'),OB.I18N.getLabel('OBPOS_MsgPrintAgainCashUp'),[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){var printCashUp=new OB.OBPOSCashUp.Print.CashUp();printCashUp.print(report,sumary,closed);return true;}},{label:OB.I18N.getLabel('OBMOBC_LblCancel'),action:function(){me.cancelOrDismiss();return true;}}],{autoDismiss:false,onHideFunction:function(dialog){me.cancelOrDismiss();}});}});};OB.OBPOSCashUp=OB.OBPOSCashUp||{};OB.OBPOSCashUp.Print=OB.OBPOSCashUp.Print||{};OB.OBPOSCashUp.Print.CashUp=PrintCashUp;}());OB.OBPOSCashUp=OB.OBPOSCashUp||{};OB.OBPOSCashUp.Model=OB.OBPOSCashUp.Model||{};OB.OBPOSCashUp.UI=OB.OBPOSCashUp.UI||{};OB.OBPOSCashUp.Model.CashUp=OB.Model.TerminalWindowModel.extend({initialStep:1,finishButtonLabel:'OBPOS_LblPostPrintClose',reportTitleLabel:'OBPOS_LblStep4of4',models:[OB.Model.Order],defaults:{step:OB.DEC.Zero,allowedStep:OB.DEC.Zero,totalExpected:OB.DEC.Zero,totalCounted:OB.DEC.Zero,totalDifference:OB.DEC.Zero,pendingOrdersToProcess:false,otherInput:OB.DEC.Zero},cashupStepsDefinition:[{name:'OB.CashUp.StepPendingOrders',loaded:false,active:true},{name:'OB.CashUp.Master',loaded:true,active:false},{name:'OB.CashUp.CashPayments',loaded:false,active:true},{name:'OB.CashUp.PaymentMethods',loaded:false,active:true},{name:'OB.CashUp.CashToKeep',loaded:true,active:true},{name:'OB.CashUp.PostPrintAndClose',loaded:true,active:true}],init:function(){OB.error("This init method should never be called for this model. Call initModels and loadModels instead");this.initModels(function(){});this.loadModels(function(){});},initModels:function(initModelsCallback){var synchId1=OB.UTIL.SynchronizationHelper.busyUntilFinishes('cashup-model.init1');var undf,me=this,terminalSlave=!OB.POS.modelterminal.get('terminal').ismaster&&OB.POS.modelterminal.get('terminal').isslave,newstep,expected=0,startings=[],cashUpReport,tempList=new Backbone.Collection(),activePaymentsList=[],finish,synch1=false,synch2=false,synch3=false;this.cashupStepsDefinition[this.stepIndex('OB.CashUp.Master')].active=OB.POS.modelterminal.get('terminal').ismaster;this.cashupStepsDefinition[this.stepIndex('OB.CashUp.StepPendingOrders')].loaded=false;this.cashupStepsDefinition[this.stepIndex('OB.CashUp.CashPayments')].loaded=false;this.cashupStepsDefinition[this.stepIndex('OB.CashUp.PaymentMethods')].loaded=false;this.set('loadFinished',false);this.set('step',this.initialStep);this.set('substep',0);this.cashupsteps=[];_.each(this.cashupStepsDefinition,function(s){newstep=enyo.createFromKind(s.name);newstep.model=this;this.cashupsteps.push(newstep);},this);this.set('orderlist',new OB.Collection.OrderList());this.set('paymentList',new Backbone.Collection());OB.Dal.find(OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){OB.Dal.find(OB.Model.PaymentMethodCashUp,{'cashup_id':cashUp.at(0).get('id'),'_orderByClause':'name asc'},function(payMthds){_.each(OB.MobileApp.model.get('payments'),function(payment){if(payment.payment.active===true){activePaymentsList.push(payment);}});_.each(activePaymentsList,function(payment,index){expected=0;var auxPay=payMthds.filter(function(payMthd){return payMthd.get('paymentmethod_id')===payment.payment.id;})[0];if(!auxPay){return;}
if(!terminalSlave||!OB.MobileApp.model.paymentnames[payment.payment.searchKey].paymentMethod.isshared){auxPay.set('_id',payment.payment.searchKey);auxPay.set('isocode',payment.isocode);auxPay.set('paymentMethod',payment.paymentMethod);auxPay.set('id',payment.payment.id);if(auxPay.get('totalDeposits')===null){auxPay.set('totalDeposits',0);}
if(auxPay.get('totalDrops')===null){auxPay.set('totalDrops',0);}
var cStartingCash=auxPay.get('startingCash');var cTotalReturns=auxPay.get('totalReturns');var cTotalSales=auxPay.get('totalSales');var cTotalDeposits=OB.DEC.sub(auxPay.get('totalDeposits'),OB.DEC.abs(auxPay.get('totalDrops')));expected=OB.DEC.add(OB.DEC.add(cStartingCash,OB.DEC.sub(cTotalSales,cTotalReturns)),cTotalDeposits);var fromCurrencyId=auxPay.get('paymentMethod').currency;auxPay.set('expected',OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,expected));auxPay.set('foreignExpected',expected);var paymentShared=(OB.POS.modelterminal.get('terminal').ismaster||OB.POS.modelterminal.get('terminal').isslave)&&OB.MobileApp.model.paymentnames[payment.payment.searchKey].paymentMethod.isshared;if(paymentShared){auxPay.set('name',auxPay.get('name')+(paymentShared?OB.I18N.getLabel('OBPOS_LblPaymentMethodShared'):""));}
tempList.add(auxPay);}
if(index===activePaymentsList.length-1){if(terminalSlave&&tempList.length===0){me.cashupStepsDefinition[me.stepIndex('OB.CashUp.PaymentMethods')].active=false;}
me.get('paymentList').reset(tempList.models);var i,cashPayments=false,cashToKeep=false,paymentsIndex=me.stepIndex('OB.CashUp.CashPayments'),toKeepIndex=me.stepIndex('OB.CashUp.CashToKeep');for(i=0;i<tempList.length;i++){if(me.cashupsteps[paymentsIndex].isSubstepAvailable(me,i)){cashPayments=true;}
if(me.cashupsteps[toKeepIndex].isSubstepAvailable(me,i)){cashToKeep=true;}}
me.cashupStepsDefinition[paymentsIndex].active=cashPayments;me.cashupStepsDefinition[toKeepIndex].active=cashToKeep;me.set('totalExpected',_.reduce(me.get('paymentList').models,function(total,model){return OB.DEC.add(total,model.get('expected'));},0));me.set('totalDifference',OB.DEC.sub(me.get('totalDifference'),me.get('totalExpected')));me.setIgnoreStep3();}},this);me.cashupStepsDefinition[me.stepIndex('OB.CashUp.CashPayments')].loaded=true;me.cashupStepsDefinition[me.stepIndex('OB.CashUp.PaymentMethods')].loaded=true;synch1=true;finish();OB.UTIL.SynchronizationHelper.finished(synchId1,'cashup-model.init1');},function(){OB.UTIL.SynchronizationHelper.finished(synchId1,'cashup-model.init1');});},this);var synchId2=OB.UTIL.SynchronizationHelper.busyUntilFinishes('cashup-model.init2');this.set('cashUpReport',new Backbone.Collection());OB.Dal.find(OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){cashUpReport=cashUp.at(0);initModelsCallback();cashUpReport.set('deposits',[]);cashUpReport.set('drops',[]);OB.Dal.find(OB.Model.CashManagement,{'cashup_id':cashUpReport.get('id'),'type':'deposit'},function(cashMgmts){_.forEach(cashMgmts.models,function(cashMgmt){cashMgmt.set('searchKey','cashMgmtDeposit'+(_.filter(OB.MobileApp.model.get('payments'),function(pay){return pay.payment.id===cashMgmt.get('paymentMethodId');}))[0].payment.searchKey.replace('_','')+cashMgmt.get('amount'));});cashUpReport.set('deposits',cashMgmts.models);cashUpReport.set('totalDeposits',_.reduce(cashMgmts.models,function(accum,trx){return OB.DEC.add(accum,trx.get('origAmount'));},0));},this);OB.Dal.find(OB.Model.CashManagement,{'cashup_id':cashUpReport.get('id'),'type':'drop'},function(cashMgmts){_.forEach(cashMgmts.models,function(cashMgmt){cashMgmt.set('searchKey','cashMgmtDrop'+(_.filter(OB.MobileApp.model.get('payments'),function(pay){return pay.payment.id===cashMgmt.get('paymentMethodId');}))[0].payment.searchKey.replace('_','')+cashMgmt.get('amount'));});cashUpReport.set('drops',cashMgmts.models);cashUpReport.set('totalDrops',_.reduce(cashMgmts.models,function(accum,trx){return OB.DEC.add(accum,trx.get('origAmount'));},0));},this);OB.Dal.find(OB.Model.TaxCashUp,{'cashup_id':cashUpReport.get('id'),'orderType':{operator:'!=',value:'1'},'_orderByClause':'name asc'},function(taxcashups){cashUpReport.set('salesTaxes',taxcashups.models);},this);OB.Dal.find(OB.Model.TaxCashUp,{'cashup_id':cashUpReport.get('id'),'orderType':'1','_orderByClause':'name asc'},function(taxcashups){cashUpReport.set('returnsTaxes',taxcashups.models);},this);OB.Dal.find(OB.Model.PaymentMethodCashUp,{'cashup_id':cashUpReport.get('id'),'_orderByClause':'name asc'},function(payMthds){cashUpReport.set('totalStartings',_.reduce(payMthds.models,function(accum,trx){if(OB.MobileApp.model.paymentnames[trx.get('searchKey')]){if(terminalSlave&&OB.MobileApp.model.paymentnames[trx.get('searchKey')].paymentMethod.isshared){return accum;}
var fromCurrencyId=OB.MobileApp.model.paymentnames[trx.get('searchKey')].paymentMethod.currency;var cStartingCash=OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,trx.get('startingCash'));return OB.DEC.add(accum,cStartingCash);}else{return 0;}},0));cashUpReport.set('totalDeposits',_.reduce(payMthds.models,function(accum,trx){if(OB.MobileApp.model.paymentnames[trx.get('searchKey')]){if(terminalSlave&&OB.MobileApp.model.paymentnames[trx.get('searchKey')].paymentMethod.isshared){return accum;}
var fromCurrencyId=OB.MobileApp.model.paymentnames[trx.get('searchKey')].paymentMethod.currency;var cTotalDeposits=OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,OB.DEC.add(trx.get('totalDeposits'),trx.get('totalSales')));return OB.DEC.add(accum,cTotalDeposits);}else{return 0;}},0));cashUpReport.set('totalDrops',_.reduce(payMthds.models,function(accum,trx){if(OB.MobileApp.model.paymentnames[trx.get('searchKey')]){if(terminalSlave&&OB.MobileApp.model.paymentnames[trx.get('searchKey')].paymentMethod.isshared){return accum;}
var fromCurrencyId=OB.MobileApp.model.paymentnames[trx.get('searchKey')].paymentMethod.currency;var cTotalDrops=OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,OB.DEC.add(trx.get('totalDrops'),trx.get('totalReturns')));return OB.DEC.add(accum,cTotalDrops);}else{return 0;}},0));_.each(payMthds.models,function(p){var auxPay=OB.MobileApp.model.get('payments').filter(function(pay){return pay.payment.id===p.get('paymentmethod_id');})[0];if(!auxPay){return;}
if(terminalSlave&&OB.MobileApp.model.paymentnames[auxPay.payment.searchKey].paymentMethod.isshared){return;}
var fromCurrencyId=auxPay.paymentMethod.currency,paymentShared=(OB.POS.modelterminal.get('terminal').ismaster||OB.POS.modelterminal.get('terminal').isslave)&&OB.MobileApp.model.paymentnames[auxPay.payment.searchKey].paymentMethod.isshared,paymentSharedStr=paymentShared?OB.I18N.getLabel('OBPOS_LblPaymentMethodShared'):"";cashUpReport.get('deposits').push(new Backbone.Model({searchKey:p.get('searchKey'),origAmount:OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,OB.DEC.add(p.get('totalDeposits'),p.get('totalSales'))),amount:OB.DEC.add(0,OB.DEC.add(p.get('totalDeposits'),p.get('totalSales'))),description:p.get('name')+paymentSharedStr,currency:fromCurrencyId,isocode:auxPay.isocode,rate:p.get('rate')}));cashUpReport.get('drops').push(new Backbone.Model({searchKey:p.get('searchKey'),origAmount:OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,OB.DEC.add(p.get('totalDrops'),p.get('totalReturns'))),amount:OB.DEC.add(0,OB.DEC.add(p.get('totalDrops'),p.get('totalReturns'))),description:p.get('name')+paymentSharedStr,currency:fromCurrencyId,isocode:auxPay.isocode,rate:p.get('rate')}));startings.push(new Backbone.Model({searchKey:p.get('searchKey'),origAmount:OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,p.get('startingCash')),amount:OB.DEC.add(0,p.get('startingCash')),description:OB.I18N.getLabel('OBPOS_LblStarting')+' '+p.get('name')+paymentSharedStr,currency:fromCurrencyId,isocode:auxPay.isocode,rate:p.get('rate'),paymentId:p.get('paymentmethod_id')}));},this);cashUpReport.set('startings',startings);OB.UTIL.HookManager.executeHooks('OBPOS_EditCashupReport',{cashUpReport:cashUpReport},function(args){me.get('cashUpReport').add(args.cashUpReport);synch2=true;finish();OB.UTIL.SynchronizationHelper.finished(synchId2,'cashup-model.init2');});},this);},this);this.get('paymentList').on('change:counted',function(mod){mod.set('difference',OB.DEC.sub(mod.get('counted'),OB.Utilities.Number.roundJSNumber(mod.get('expected'),2)));if(mod.get('foreignCounted')!==null&&mod.get('foreignCounted')!==undf&&mod.get('foreignExpected')!==null&&mod.get('foreignExpected')!==undf){mod.set('foreignDifference',OB.DEC.sub(mod.get('foreignCounted'),OB.Utilities.Number.roundJSNumber(mod.get('foreignExpected'),2)));}
this.set('totalCounted',_.reduce(this.get('paymentList').models,function(total,model){return model.get('counted')?OB.DEC.add(total,model.get('counted')):total;},0),0);if(mod.get('counted')===OB.DEC.Zero){this.trigger('change:totalCounted');}},this);OB.Dal.find(OB.Model.Order,{hasbeenpaid:'N','session':OB.MobileApp.model.get('session')},function(pendingOrderList,me){var emptyOrders;emptyOrders=_.filter(pendingOrderList.models,function(pendingorder){if(pendingorder&&pendingorder.get('lines')&&pendingorder.get('lines').length===0){return true;}
if(pendingorder&&pendingorder.get('isLayaway')===true){return true;}});_.each(emptyOrders,function(orderToRemove){pendingOrderList.remove(orderToRemove);});me.get('orderlist').reset(pendingOrderList.models);var indexStepPendingOrders=me.stepIndex('OB.CashUp.StepPendingOrders');me.cashupStepsDefinition[indexStepPendingOrders].active=pendingOrderList.length>0;me.cashupStepsDefinition[indexStepPendingOrders].loaded=true;synch3=true;finish();},function(tx,error){OB.UTIL.showError("OBDAL error: "+error);},this);this.printCashUp=new OB.OBPOSCashUp.Print.CashUp();finish=function(){if(synch1&&synch2&&synch3){me.finishLoad();}};},loadModels:function(loadModelsCallback){loadModelsCallback();},finishLoad:function(){var finish=true;_.each(this.cashupStepsDefinition,function(step){if(!step.loaded){finish=false;}});if(finish&&!this.get('loadFinished')){this.set('step',this.getFirstStep());this.set('substep',0);this.set('loadFinished',true);}},stepCount:function(){var count=0;_.each(this.cashupStepsDefinition,function(step){if(step.active){count++;}});return count;},stepIndex:function(defName){var index=-1;_.each(this.cashupStepsDefinition,function(step,indx){if(step.name===defName){index=indx;}});return index;},stepNumber:function(defName){var index=this.stepIndex(defName);var i,count=0;for(i=0;i<=index;i++){if(this.cashupStepsDefinition[i].active){count++;}}
return count;},getFirstStep:function(){var i;for(i=0;i<this.cashupStepsDefinition.length;i++){if(this.cashupStepsDefinition[i].active){return i+1;}}
return null;},getNextStep:function(){var i;for(i=this.get('step');i<this.cashupStepsDefinition.length;i++){if(this.cashupStepsDefinition[i].active){return i+1;}}
return null;},getPreviousStep:function(){var i;for(i=this.get('step')-2;i>=0;i--){if(this.cashupStepsDefinition[i].active){return i+1;}}
return 0;},allowNext:function(){return this.get('step')>0?this.cashupsteps[this.get('step')-1].allowNext():false;},allowPrevious:function(){return this.get('step')>this.getFirstStep();},setIgnoreStep3:function(){var result=null;_.each(this.get('paymentList').models,function(model){if(model.get('paymentMethod').automatemovementtoother===false){model.set('qtyToKeep',0);if(result!==false){result=true;}}else{result=false;return false;}},this);this.set('ignoreStep3',result);},showStep:function(leftpanel$){var currentstep=this.get('step')-1;var i;var stepcomponent;for(i=0;i<this.cashupsteps.length;i++){stepcomponent=this.cashupsteps[i].getStepComponent(leftpanel$);stepcomponent.setShowing(i===currentstep);if(i===currentstep){stepcomponent.displayStep(this);}}},getStepToolbar:function(){var currentstep=this.get('step')-1;return this.cashupsteps[currentstep].getToolbarName();},nextButtonI18NLabel:function(){var currentstep=this.get('step')-1;if(this.cashupsteps[currentstep].nextFinishButton()){return this.finishButtonLabel;}else{return'OBPOS_LblNextStep';}},isFinishedWizard:function(step){var postPrintAndClose=this.stepIndex('OB.CashUp.PostPrintAndClose');if(this.cashupStepsDefinition[postPrintAndClose].active){return step===(postPrintAndClose+2);}
return false;},getSubstepsLength:function(step){return this.cashupsteps[step-1].getSubstepsLength(this);},isSubstepAvailable:function(step,substep){return this.cashupsteps[step-1].isSubstepAvailable(this,substep);},verifyStep:function(leftpanel$,callback){var currentstep=this.get('step')-1;var stepcomponent=this.cashupsteps[currentstep].getStepComponent(leftpanel$);if(stepcomponent.verifyStep){return stepcomponent.verifyStep(this,callback);}else{callback();}},isPaymentMethodListVisible:function(){return(this.get('step')-1)===this.stepIndex('OB.CashUp.CashPayments');},countAll:function(){this.get('paymentList').each(function(model){model.set('foreignCounted',OB.DEC.add(0,model.get('foreignExpected')));model.set('counted',OB.DEC.add(0,model.get('expected')));});},validateCashKeep:function(qty){var unfd,result={result:false,message:''};if(qty!==unfd&&qty!==null&&$.isNumeric(qty)){if(this.get('paymentList').at(this.get('substep')).get('foreignCounted')>=qty){result.result=true;result.message='';}else{result.result=false;result.message=OB.I18N.getLabel('OBPOS_MsgMoreThanCounted');}}else{result.result=false;result.message='Not valid number to keep';}
if(!result.result){this.get('paymentList').at(this.get('substep')).set('qtyToKeep',null);}
return result;},getCountCashSummary:function(){var countCashSummary,counter,enumConcepts,enumSecondConcepts,enumSummarys,i,undf,model,value=OB.DEC.Zero,second=OB.DEC.Zero;countCashSummary={expectedSummary:[],countedSummary:[],differenceSummary:[],qtyToKeepSummary:[],qtyToDepoSummary:[],totalCounted:this.get('totalCounted'),totalExpected:this.get('totalExpected'),totalDifference:this.get('totalDifference'),totalQtyToKeep:_.reduce(this.get('paymentList').models,function(total,model){if(model.get('qtyToKeep')){var cQtyToKeep=OB.UTIL.currency.toDefaultCurrency(model.get('paymentMethod').currency,model.get('qtyToKeep'));return OB.DEC.add(total,cQtyToKeep);}else{return total;}},0),totalQtyToDepo:_.reduce(this.get('paymentList').models,function(total,model){if(model.get('qtyToKeep')!==null&&model.get('qtyToKeep')!==undf&&model.get('foreignCounted')!==null&&model.get('foreignCounted')!==undf){var qtyToDepo=OB.DEC.sub(model.get('foreignCounted'),model.get('qtyToKeep'));var cQtyToDepo=OB.UTIL.currency.toDefaultCurrency(model.get('paymentMethod').currency,qtyToDepo);return OB.DEC.add(total,cQtyToDepo);}else{return total;}},0)};_.each(this.get('paymentList').models,function(model){if(OB.UTIL.isNullOrUndefined(model.get('qtyToKeep'))){model.set('qtyToKeep',model.get('counted'));}});enumSummarys=['expectedSummary','countedSummary','differenceSummary','qtyToKeepSummary','qtyToDepoSummary'];enumConcepts=['expected','counted','difference','qtyToKeep','foreignCounted'];enumSecondConcepts=['foreignExpected','foreignCounted','foreignDifference','qtyToKeep','qtyToKeep'];var sortedPays=_.sortBy(this.get('paymentList').models,function(p){return p.get('name');});for(counter=0;counter<5;counter++){for(i=0;i<sortedPays.length;i++){model=sortedPays[i];if(!model.get(enumConcepts[counter])){countCashSummary[enumSummarys[counter]].push(new Backbone.Model({searchKey:model.get('searchKey'),name:model.get('name'),value:0,second:0,isocode:''}));}else{var fromCurrencyId=model.get('paymentMethod').currency;switch(enumSummarys[counter]){case'qtyToKeepSummary':if(model.get(enumSecondConcepts[counter])!==null&&model.get(enumSecondConcepts[counter])!==undf){value=OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,model.get(enumConcepts[counter]));second=model.get(enumSecondConcepts[counter]);}
break;case'qtyToDepoSummary':if(model.get(enumSecondConcepts[counter])!==null&&model.get(enumSecondConcepts[counter])!==undf&&model.get('rate')!=='1'){second=OB.DEC.sub(model.get(enumConcepts[counter]),model.get(enumSecondConcepts[counter]));}else{second=OB.DEC.Zero;}
if(model.get(enumSecondConcepts[counter])!==null&&model.get(enumSecondConcepts[counter])!==undf){var baseAmount=OB.DEC.sub(model.get(enumConcepts[counter]),model.get(enumSecondConcepts[counter]));value=OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,baseAmount);}else{value=OB.DEC.Zero;}
break;default:value=model.get(enumConcepts[counter]);second=model.get(enumSecondConcepts[counter]);}
countCashSummary[enumSummarys[counter]].push(new Backbone.Model({searchKey:model.get('searchKey'),name:model.get('name'),value:value,second:second,isocode:model.get('isocode')}));}}}
return countCashSummary;},additionalProperties:[],propertyFunctions:[],processAndFinishCashUp:function(){var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes('processAndFinishCashUp');OB.UTIL.showLoading(true);var currentMe=this;OB.Dal.find(OB.Model.CashUp,{'isprocessed':'N'},function(cashUp){OB.UTIL.composeCashupInfo(cashUp,currentMe,function(me){var i,paymentMethodInfo,objToSend=JSON.parse(cashUp.at(0).get('objToSend'));var now=new Date();objToSend.cashUpDate=OB.I18N.normalizeDate(now);objToSend.timezoneOffset=now.getTimezoneOffset();for(i=0;i<me.additionalProperties.length;i++){objToSend[me.additionalProperties[i]]=me.propertyFunctions[i](OB.POS.modelterminal.get('terminal').id,cashUp.at(0));}
var cashCloseArray=[];objToSend.cashCloseInfo=cashCloseArray;_.each(me.get('paymentList').models,function(curModel){var cashCloseInfo={expected:0,difference:0,paymentTypeId:0,paymentMethod:{}};cashCloseInfo.id=OB.UTIL.get_UUID();cashCloseInfo.paymentTypeId=curModel.get('id');cashCloseInfo.difference=curModel.get('difference');cashCloseInfo.foreignDifference=curModel.get('foreignDifference');cashCloseInfo.expected=curModel.get('expected');cashCloseInfo.foreignExpected=curModel.get('foreignExpected');paymentMethodInfo=curModel.get('paymentMethod');paymentMethodInfo.amountToKeep=curModel.get('qtyToKeep');cashCloseInfo.paymentMethod=paymentMethodInfo;objToSend.cashCloseInfo.push(cashCloseInfo);},me);objToSend.approvals=me.get('approvals');var cashMgmtIds=[];objToSend.cashMgmtIds=cashMgmtIds;OB.Dal.find(OB.Model.CashManagement,{'cashup_id':cashUp.at(0).get('id')},function(cashMgmts){_.each(cashMgmts.models,function(cashMgmt){objToSend.cashMgmtIds.push(cashMgmt.get('id'));});cashUp.at(0).set('userId',OB.MobileApp.model.get('context').user.id);objToSend.userId=OB.MobileApp.model.get('context').user.id;objToSend.isprocessed='Y';cashUp.at(0).set('objToSend',JSON.stringify(objToSend));cashUp.at(0).set('isprocessed','Y');OB.Dal.save(cashUp.at(0),function(){var callbackFinishedSuccess=function(){OB.UTIL.showLoading(true);me.set('finished',true);if(OB.MobileApp.model.hasPermission('OBPOS_print.cashup')){me.printCashUp.print(me.get('cashUpReport').at(0),me.getCountCashSummary(),true);}};var callbackFunc=function(){OB.UTIL.SynchronizationHelper.finished(synchId,'processAndFinishCashUp');OB.MobileApp.model.runSyncProcess(function(){callbackFinishedSuccess();},function(){callbackFinishedSuccess();});};callbackFunc();},null);},null,this);});});}});OB.OBPOSCashUp.Model.CashUpPartial=OB.OBPOSCashUp.Model.CashUp.extend({initialStep:6,finishButtonLabel:'OBPOS_LblPrintClose',reportTitleLabel:'OBPOS_LblPartialCashUpTitle',getCountCashSummary:function(){var countCashSummary,counter,enumConcepts,enumSecondConcepts,enumSummarys,i,undf,model,value=OB.DEC.Zero,second=OB.DEC.Zero;countCashSummary={expectedSummary:[],countedSummary:[],differenceSummary:[],qtyToKeepSummary:[],qtyToDepoSummary:[],totalCounted:this.get('totalCounted'),totalExpected:this.get('totalExpected'),totalDifference:this.get('totalDifference'),totalQtyToKeep:OB.DEC.Zero,totalQtyToDepo:OB.DEC.Zero,isPartialCashup:true};_.each(this.get('paymentList').models,function(model){if(OB.UTIL.isNullOrUndefined(model.get('qtyToKeep'))){model.set('qtyToKeep',model.get('counted'));}});enumSummarys=['expectedSummary','countedSummary','differenceSummary','qtyToKeepSummary','qtyToDepoSummary'];enumConcepts=['expected','counted','difference','qtyToKeep','foreignCounted'];enumSecondConcepts=['foreignExpected','foreignCounted','foreignDifference','qtyToKeep','qtyToKeep'];var sortedPays=_.sortBy(this.get('paymentList').models,function(p){return p.get('name');});for(counter=0;counter<5;counter++){for(i=0;i<sortedPays.length;i++){model=sortedPays[i];if(!model.get(enumConcepts[counter])){countCashSummary[enumSummarys[counter]].push(new Backbone.Model({searchKey:model.get('searchKey'),name:model.get('name'),value:0,second:0,isocode:''}));}else{switch(enumSummarys[counter]){case'qtyToKeepSummary':if(model.get(enumSecondConcepts[counter])!==null&&model.get(enumSecondConcepts[counter])!==undf){value=OB.DEC.Zero;second=OB.DEC.Zero;}
break;case'qtyToDepoSummary':if(model.get(enumSecondConcepts[counter])!==null&&model.get(enumSecondConcepts[counter])!==undf&&model.get('rate')!=='1'){second=OB.DEC.Zero;}
if(model.get(enumSecondConcepts[counter])!==null&&model.get(enumSecondConcepts[counter])!==undf){value=OB.DEC.Zero;}
break;default:value=model.get(enumConcepts[counter]);second=model.get(enumSecondConcepts[counter]);}
countCashSummary[enumSummarys[counter]].push(new Backbone.Model({searchKey:model.get('searchKey'),name:model.get('name'),value:value,second:second,isocode:model.get('isocode')}));}}}
return countCashSummary;},processAndFinishCashUp:function(){if(OB.MobileApp.model.hasPermission('OBPOS_print.cashup')){this.printCashUp.print(this.get('cashUpReport').at(0),this.getCountCashSummary(),false);}
this.set('finished',true);},allowPrevious:function(){return false;},finishLoad:function(){var finish=true;_.each(this.cashupStepsDefinition,function(step){if(!step.loaded){finish=false;}});if(finish&&!this.get('loadFinished')){this.set('loadFinished',true);}}});enyo.kind({name:'OB.OBPOSCashUp.UI.Button',kind:'OB.UI.ToolbarButton',disabled:true,events:{onChangeStep:''},init:function(model){this.model=model;},tap:function(){return OB.POS.hwserver.checkDrawer(function(){if(this.disabled){return true;}
this.doChangeStep();},this);},initialize:function(){if(this.i18nLabel){this.setContent(OB.I18N.getLabel(this.i18nLabel));}}});enyo.kind({name:'OB.OBPOSCashUp.UI.CancelButton',kind:'OB.UI.ToolbarButton',i18nLabel:'OBMOBC_LblCancel',disabled:true,events:{onCancelCashup:''},tap:function(){OB.POS.hwserver.checkDrawer(function(){this.doCancelCashup();},this);}});enyo.kind({name:'OB.OBPOSCashUp.UI.LeftToolbarImpl',kind:'OB.UI.MultiColumn.Toolbar',published:{model:null},buttons:[{kind:'OB.OBPOSCashUp.UI.Button',name:'btnPrevious',i18nLabel:'OBPOS_LblPrevStep',stepCount:-1,span:4,handlers:{onDisablePreviousButton:'disablePreviousButton'},disablePreviousButton:function(inSender,inEvent){this.setDisabled(inEvent.disable);if(this.hasClass('btn-over')){this.removeClass('btn-over');}}},{kind:'OB.OBPOSCashUp.UI.CancelButton',name:'btnCancel',disabled:false,span:4},{kind:'OB.OBPOSCashUp.UI.Button',name:'btnNext',i18nLabel:'OBPOS_LblNextStep',stepCount:1,span:4,isEnableButton:false,isEnableNextButton:false,handlers:{onDisableNextButton:'disableNextButton',onEnableNextButton:'enableNextButton',synchronizing:'disableButton',synchronized:'enableButton'},disableButton:function(){this.setDisabled(true);},enableButton:function(){this.isEnableButton=true;if(this.isEnableNextButton){this.setDisabled(false);if(this.hasClass('btn-over')){this.removeClass('btn-over');}}},enableNextButton:function(){this.isEnableNextButton=true;if(this.isEnableButton){this.setDisabled(false);if(this.hasClass('btn-over')){this.removeClass('btn-over');}}},disableNextButton:function(inSender,inEvent){this.isEnableNextButton=!inEvent.disable;if(this.isEnableButton){this.setDisabled(inEvent.disable);if(this.hasClass('btn-over')){this.removeClass('btn-over');}}}}]});enyo.kind({name:'OB.OBPOSCashUp.UI.CashUp',kind:'OB.UI.WindowView',synchId:null,statics:{TitleExtensions:[],getTitleExtensions:function(){return _.reduce(this.TitleExtensions,function(memo,item){return memo+' '+item();},'');}},windowmodel:OB.OBPOSCashUp.Model.CashUp,titleLabel:'OBPOS_LblCloseCash',finishCloseDialogLabel:'OBPOS_FinishCloseDialog',cashupSentHook:'OBPOS_AfterCashUpSent',handlers:{onButtonOk:'buttonOk',onTapRadio:'tapRadio',onChangeStep:'changeStep',onCancelCashup:'cancelCashup',onCountAllOK:'countAllOK',onLineEditCount:'lineEditCount',onPaymentMethodKept:'paymentMethodKept',onResetQtyToKeep:'resetQtyToKeep',onHoldActiveCmd:'holdActiveCmd',onChangeCashupReport:'changeCashupReport'},published:{model:null},events:{onShowPopup:'',onChangeOption:'',onDisablePreviousButton:'',onDisableNextButton:'',onEnableNextButton:''},components:[{kind:'OB.UI.MultiColumn',name:'cashupMultiColumn',leftToolbar:{kind:'OB.OBPOSCashUp.UI.LeftToolbarImpl',name:'leftToolbar',showMenu:false,showWindowsMenu:false},rightToolbar:{kind:'OB.UI.MultiColumn.Toolbar',name:'rightToolbar',showMenu:false,showWindowsMenu:false,buttons:[{kind:'OB.OBPOSCashUp.UI.Button',name:'btnCashUp',span:12}]},leftPanel:{name:'cashupLeftPanel',components:[{classes:'span12',kind:'OB.OBPOSCashUp.UI.ListPendingReceipts',name:'listPendingReceipts',showing:false},{classes:'span12',kind:'OB.OBPOSCashUp.UI.CashMaster',name:'cashMaster',showing:false},{classes:'span12',kind:'OB.OBPOSCashUp.UI.CashPayments',name:'cashPayments',showing:false},{classes:'span12',kind:'OB.OBPOSCashUp.UI.ListPaymentMethods',name:'listPaymentMethods',showing:false},{classes:'span12',kind:'OB.OBPOSCashUp.UI.CashToKeep',name:'cashToKeep',showing:false},{classes:'span12',kind:'OB.OBPOSCashUp.UI.PostPrintClose',name:'postPrintClose',showing:false}]},rightPanel:{classes:'span12',name:'cashupRightPanel',components:[{kind:'OB.OBPOSCashUp.UI.CashUpInfo',name:'cashUpInfo'},{kind:'OB.OBPOSCashUp.UI.CashUpKeyboard',name:'cashUpKeyboard'}]}},{kind:'OB.UI.ModalCancel',name:'modalCancel'},{kind:'OB.OBPOSCashUp.UI.modalPendingToProcess',name:'modalPendingToProcess'}],finalAction:function(){OB.POS.navigate('retail.pointofsale');},init:function(){this.synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("cashup");var me=this;this.inherited(arguments);this.$.cashupMultiColumn.$.rightToolbar.$.rightToolbar.$.toolbar.$.button.$.theButton.$.btnCashUp.setContent(OB.I18N.getLabel(this.titleLabel));this.$.cashupMultiColumn.$.rightPanel.$.cashUpInfo.setModel(this.model);this.$.cashupMultiColumn.$.leftToolbar.$.leftToolbar.setModel(this.model);this.model.on('change:pendingOrdersToProcess',function(model){this.doShowPopup({popup:'modalprocessreceipts'});},this);this.$.cashupMultiColumn.$.leftPanel.$.listPendingReceipts.setCollection(this.model.get('orderlist'));this.model.get('orderlist').on('all',function(){this.refreshButtons();},this);this.$.cashupMultiColumn.$.leftPanel.$.listPaymentMethods.setCollection(this.model.get('paymentList'));this.$.cashupMultiColumn.$.leftPanel.$.listPaymentMethods.$.total.printAmount(this.model.get('totalExpected'));this.$.cashupMultiColumn.$.leftPanel.$.listPaymentMethods.$.difference.printAmount(OB.DEC.sub(0,this.model.get('totalExpected')));this.model.on('change:totalExpected',function(){this.$.cashupMultiColumn.$.leftPanel.$.listPaymentMethods.$.total.printAmount(this.model.get('totalExpected'));},this);this.model.on('change:totalCounted',function(){this.model.set("totalDifference",OB.DEC.sub(this.model.get('totalCounted'),OB.Utilities.Number.roundJSNumber(this.model.get('totalExpected'),2)));this.$.cashupMultiColumn.$.leftPanel.$.listPaymentMethods.$.difference.printAmount(this.model.get("totalDifference"));this.waterfall('onAnyCounted');this.refreshButtons();},this);this.model.on('change:stepOfStep3',function(model){this.$.cashupMultiColumn.$.leftPanel.$.cashToKeep.disableSelection();this.$.cashupMultiColumn.$.leftPanel.$.cashToKeep.setPaymentToKeep(this.model.get('paymentList').at(this.model.get('stepOfStep3')));this.refresh();},this);this.model.get('paymentList').on('reset',function(){var paymentList=this.model.get('paymentList').at(this.model.get('substep'));if(paymentList){paymentList.on('change:foreignCounted',function(){this.$.cashupMultiColumn.$.leftPanel.$.cashToKeep.$.formkeep.renderBody(this.model.get('paymentList').at(this.model.get('substep')));},this);}},this);this.model.get('cashUpReport').on('reset',function(model){this.$.cashupMultiColumn.$.leftPanel.$.postPrintClose.setModel(this.model.get('cashUpReport').at(0));});this.$.cashupMultiColumn.$.leftPanel.$.postPrintClose.setSummary(this.model.getCountCashSummary());this.model.on('change:totalDifference',function(model){this.$.cashupMultiColumn.$.leftPanel.$.postPrintClose.setSummary(this.model.getCountCashSummary());},this);this.model.on('change:finished',function(){var content;var i;var messages=this.model.get('messages');var next=this.model.get('next'),me=this;if(messages&&messages.length){content=[{content:OB.I18N.getLabel(me.finishCloseDialogLabel)},{allowHtml:true,content:'&nbsp;'}];for(i=0;i<messages.length;i++){content.push({content:OB.UTIL.decodeXMLComponent(messages[i])});}}else{content=OB.I18N.getLabel(me.finishCloseDialogLabel);}
OB.UTIL.HookManager.executeHooks(me.cashupSentHook,{},function(){if(OB.MobileApp.view.$.confirmationContainer.getAttribute('openedPopup')!==OB.I18N.getLabel('OBPOS_MsgPrintAgainCashUp')){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_LblGoodjob'),content,[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){me.finalAction();return true;}}],{autoDismiss:false,onHideFunction:function(){me.finalAction();}});}});},this);this.model.on('change:finishedWrongly',function(model){var message="";if(model.get('errorMessage')){message=OB.I18N.getLabel(model.get('errorMessage'),[model.get('errorDetail')]);}else{message=OB.I18N.getLabel('OBPOS_CashUpWrongly');}
var errorNoNavigateToInitialScreen=model.get('errorNoNavigateToInitialScreen');if(errorNoNavigateToInitialScreen&&errorNoNavigateToInitialScreen==='true'){model.set('cashUpSent',false);model.set("finishedWrongly",false);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashUpWronglyHeader'),message,[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){me.waterfall('onEnableNextButton');return true;}}],{autoDismiss:false,onHideFunction:function(){me.waterfall('onEnableNextButton');}});}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashUpWronglyHeader'),message,[{label:OB.I18N.getLabel('OBMOBC_LblOk'),isConfirmButton:true,action:function(){OB.POS.navigate('retail.pointofsale');return true;}}],{autoDismiss:false,onHideFunction:function(){OB.POS.navigate('retail.pointofsale');}});}},this);this.refreshButtons();this.model.on('change:loadFinished',function(model){function processCashCloseSlave(callback){new OB.DS.Process('org.openbravo.retail.posterminal.ProcessCashCloseSlave').exec({cashUpId:OB.POS.modelterminal.get('terminal').cashUpId},function(data){if(data&&data.exception){OB.log('error',data.exception.message);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashMgmtError'),OB.I18N.getLabel('OBPOS_ErrorServerGeneric')+data.exception.message,[{label:OB.I18N.getLabel('OBPOS_LblRetry'),action:function(){processCashCloseSlave(callback);}}],{autoDismiss:false,onHideFunction:function(){OB.POS.navigate('retail.pointofsale');}});}else{callback(data);}});}
if(model.get("loadFinished")){if(OB.POS.modelterminal.get('terminal').isslave){processCashCloseSlave(function(data){if(data.hasMaster){me.moveStep(0);}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashUpWronglyHeader'),OB.I18N.getLabel('OBPOS_ErrCashupMasterNotOpen'));OB.POS.navigate('retail.pointofsale');}});}else{me.moveStep(0);}}});this.model.on('change:slavesCashupCompleted',function(model){me.refreshButtons();});},rendered:function(){OB.UTIL.SynchronizationHelper.finished(this.synchId,'cashup');},refreshButtons:function(){this.waterfall('onDisablePreviousButton',{disable:!this.model.allowPrevious()});this.waterfall('onDisableNextButton',{disable:!this.model.allowNext()});this.$.cashupMultiColumn.$.rightPanel.$.cashUpKeyboard.showToolbar(this.model.getStepToolbar());},refresh:function(){this.model.showStep(this.$.cashupMultiColumn.$.leftPanel.$);this.refreshButtons();var nextButtonI18NLabel=this.model.nextButtonI18NLabel();this.$.cashupMultiColumn.$.leftToolbar.$.leftToolbar.$.toolbar.getComponents()[2].$.theButton.$.btnNext.setContent(OB.I18N.getLabel(nextButtonI18NLabel));},changeStep:function(inSender,inEvent){var direction=inEvent.originator.stepCount;var me=this;if(direction>0){this.model.verifyStep(this.$.cashupMultiColumn.$.leftPanel.$,function(){me.moveStep(direction);OB.info("Cashup step: "+me.model.get('step'));});}else{this.moveStep(direction);OB.info("Cashup step: "+me.model.get('step'));}},cancelCashup:function(inSender,inEvent){OB.POS.navigate('retail.pointofsale');},moveStep:function(direction){var nextstep=this.model.get('step');var nextsubstep=this.model.get('substep')+direction;if(nextstep<=0){var step=this.model.getFirstStep();this.model.set('step',step);this.model.set('substep',-1);this.moveStep(step);}else if(this.model.isFinishedWizard(nextstep)){this.model.get('cashUpReport').at(0).set('time',new Date());if(this.model.get('cashUpSent')){return true;}
this.$.cashupMultiColumn.$.leftToolbar.$.leftToolbar.$.toolbar.getComponents()[2].$.theButton.$.btnNext.setDisabled(true);this.model.set('cashUpSent',true);this.model.processAndFinishCashUp();}else if(nextsubstep<0){var previous=this.model.getPreviousStep();this.model.set('step',previous);this.model.set('substep',this.model.getSubstepsLength(previous));this.moveStep(-1);}else if(nextsubstep>=this.model.getSubstepsLength(nextstep)){var next=this.model.getNextStep();this.model.set('step',next?next:nextstep+1);this.model.set('substep',-1);this.moveStep(1);}else if(this.model.isSubstepAvailable(nextstep,nextsubstep)){this.model.set('step',nextstep);this.model.set('substep',nextsubstep);this.refresh();}else{this.model.set('step',nextstep);this.model.set('substep',nextsubstep);this.moveStep(direction===0?1:direction);}},countAllOK:function(inSender,inEvent){this.model.countAll();this.refreshButtons();},lineEditCount:function(inSender,inEvent){this.waterfall('onShowColumn',{colNum:1});this.$.cashupMultiColumn.$.rightPanel.$.cashUpKeyboard.setStatus(inEvent.originator.model.get('_id'));},paymentMethodKept:function(inSender,inEvent){var validationResult=this.model.validateCashKeep(inEvent.qtyToKeep);if(validationResult.result){this.model.get('paymentList').at(this.model.get('substep')).set('qtyToKeep',inEvent.qtyToKeep);}else{OB.UTIL.showWarning(validationResult.message);}
this.refreshButtons();this.$.cashupMultiColumn.$.rightPanel.$.cashUpKeyboard.setStatus(inEvent.name);},resetQtyToKeep:function(inSender,inEvent){this.model.get('paymentList').at(this.model.get('substep')).set('qtyToKeep',null);this.refreshButtons();},holdActiveCmd:function(inSender,inEvent){this.waterfall('onChangeOption',{cmd:inEvent.cmd});},changeCashupReport:function(){this.$.cashupMultiColumn.$.leftPanel.$.postPrintClose.setModel(this.model.get('cashUpReport').at(0));}});OB.POS.registerWindow({windowClass:OB.OBPOSCashUp.UI.CashUp,route:'retail.cashup',online:false,menuPosition:20,menuI18NLabel:'OBPOS_LblCloseCash',permission:'OBPOS_retail.cashup',approvalType:'OBPOS_approval.cashup'});enyo.kind({name:'OB.OBPOSCashUp.UI.CashUpPartial',kind:'OB.OBPOSCashUp.UI.CashUp',windowmodel:OB.OBPOSCashUp.Model.CashUpPartial,titleLabel:'OBPOS_LblCloseCashPartial',finishCloseDialogLabel:'OBPOS_FinishPartialDialog',cashupSentHook:'OBPOS_AfterCashUpPartialSent',finalAction:function(){OB.POS.navigate('retail.pointofsale');}});OB.POS.registerWindow({windowClass:OB.OBPOSCashUp.UI.CashUpPartial,route:'retail.cashuppartial',online:false,menuPosition:21,menuI18NLabel:'OBPOS_LblCloseCashPartial',permission:'OBPOS_retail.cashuppartial',approvalType:'OBPOS_approval.cashuppartial'});enyo.kind({name:'OB.OBPOSCashUp.UI.CashUpKeyboard',published:{payments:null},kind:'OB.UI.Keyboard',sideBarEnabled:true,init:function(model){this.model=model;var me=this;this.inherited(arguments);this.showSidepad('sidecashup');this.addCommand('+',{stateless:true,action:function(keyboard,txt){var t=keyboard.$.editbox.getContent();keyboard.$.editbox.setContent(t+'+');}});this.addCommand('-',{stateless:true,action:function(keyboard,txt){var t=keyboard.$.editbox.getContent();keyboard.$.editbox.setContent(t+'-');}});this.addToolbar({name:'toolbarempty',buttons:[]});this.addToolbar({name:'toolbarother',buttons:[{command:'allowvariableamount',definition:{holdActive:true,action:function(keyboard,amt){me.model.set('otherInput',OB.I18N.parseNumber(amt));}},label:OB.I18N.getLabel('OBPOS_LblOther')}]});this.addToolbar({name:'toolbarcashpayments',buttons:[{command:'cashpayments',i18nLabel:'OBPOS_SetQuantity',stateless:true,definition:{stateless:true,action:function(keyboard,amt){keyboard.model.trigger('action:SelectCoin',{keyboard:keyboard,txt:amt});}}},{command:'resetallcoins',i18nLabel:'OBPOS_ResetAllCoins',stateless:true,definition:{stateless:true,action:function(keyboard,amt){keyboard.model.trigger('action:resetAllCoins');}}},{command:'opendrawer',i18nLabel:'OBPOS_OpenDrawer',stateless:true,definition:{stateless:true,action:function(keyboard,amt){OB.UTIL.Approval.requestApproval(me.model,'OBPOS_approval.opendrawer.cashup',function(approved,supervisor,approvalType){if(approved){OB.POS.hwserver.openCheckDrawer(false,OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerCount);}});}}}]});this.addCommand('coin',{action:function(keyboard,txt){keyboard.model.trigger('action:SelectCoin',{keyboard:keyboard,txt:txt});}});this.model.on('action:SetStatusCoin',function(){this.setStatus('coin');},this);this.model.on('action:ResetStatusCoin',function(){this.setStatus('');},this);this.showToolbar('toolbarempty');this.model.get('paymentList').on('reset',function(){var buttons=[];this.model.get('paymentList').each(function(payment){if(!payment.get('paymentMethod').iscash||!payment.get('paymentMethod').countcash){buttons.push({command:payment.get('_id'),definition:{action:function(keyboard,amt){var convAmt=OB.I18N.parseNumber(amt);if(_.isNaN(convAmt)){OB.UTIL.showWarning(OB.I18N.getLabel('OBPOS_NotValidNumber',[amt]));return;}
payment.set('foreignCounted',OB.DEC.add(0,convAmt));payment.set('counted',OB.DEC.mul(convAmt,payment.get('rate')));}},label:payment.get('name')});}},this);if(this.model.get('paymentList').length!==0){this.addToolbar({name:'toolbarcountcash',buttons:buttons});}},this);}});enyo.kind({name:'OB.OBPOSCashUp.UI.CashUpInfo',published:{model:null},components:[{style:'position: relative; background: #363636; color: white; height: 200px; margin: 5px; padding: 5px',components:[{kind:'OB.UI.Clock',classes:'pos-clock'},{style:'padding: 5px',initialize:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblCashUpProcess'));}},{style:'padding: 3px',initialize:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblStep1'));}},{style:'padding: 3px',initialize:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblStep2'));}},{style:'padding: 3px',initialize:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblStep3'));}},{style:'padding: 3px',initialize:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblStep4'));}}]}]});enyo.kind({name:'OB.OBPOSCashUp.UI.ButtonVoid',kind:'OB.UI.SmallButton',classes:'btn-icon-small btn-icon-clear',style:'background-color: #e2e2e2; margin: 5px 0px 5px 0px;',initComponents:function(){}});enyo.kind({name:'OB.OBPOSCashUp.UI.RenderPendingReceiptLine',events:{onVoidOrder:''},components:[{style:'display: table; height: 42px; width: 100%; border-bottom: 1px solid #cccccc;',components:[{name:'orderDate',style:'display: table-cell; vertical-align: middle; padding: 2px 5px 2px 5px; width: 10%;'},{name:'documentNo',style:'display: table-cell; vertical-align: middle; padding: 2px 5px 2px 5px; width: 20%;'},{name:'bp',style:'display: table-cell; vertical-align: middle; padding: 2px 5px 2px 5px; width: 40%;'},{name:'printGross',style:'display: table-cell; vertical-align: middle; padding: 2px 5px 2px 5px; width: 15%; font-weight: bold; text-align: right;'},{style:'display: table-cell; vertical-align: middle; padding: 2px 5px 2px 5px; width: 15%;',components:[{name:'buttonVoid',kind:'OB.OBPOSCashUp.UI.ButtonVoid',ontap:'voidOrder'}]},{style:'clear: both;'}]}],create:function(){this.inherited(arguments);this.$.orderDate.setContent(OB.I18N.formatHour(this.model.get('orderDate')));this.$.documentNo.setContent(this.model.get('documentNo'));this.$.bp.setContent(this.model.get('bp').get('_identifier'));this.$.printGross.setContent(this.model.printGross());},voidOrder:function(inSender,inEvent){var me=this;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_ConfirmDeletion'),OB.I18N.getLabel('OBPOS_MsgConfirmDelete'),[{label:OB.I18N.getLabel('OBPOS_LblYesDelete'),isConfirmButton:true,action:function(){me.doVoidOrder();}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}]);}});enyo.kind({name:'OB.OBPOSCashUp.UI.ListPendingReceipts',published:{collection:null},handlers:{onVoidOrder:'voidOrder'},components:[{classes:'tab-pane',components:[{style:'overflow:auto; height: 500px; margin: 5px',components:[{style:'background-color: #ffffff; color: black; padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'stepsheader',style:'padding: 10px; border-bottom: 1px solid #cccccc; text-align:center;',renderHeader:function(step,count){this.setContent(OB.I18N.getLabel('OBPOS_LblStepNumber',[step,count])+" "+OB.I18N.getLabel('OBPOS_LblStepPendingOrders')+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());}}]},{style:'clear: both;'}]},{name:'rowDeleteAll',classes:'row-fluid',components:[{style:'span12; padding: 2px 5px 2px 5px; border-bottom: 1px solid #cccccc;',components:[{name:'btnDeleteAll',kind:'OB.UI.SmallButton',classes:'btnlink-gray',style:'float: right; min-width: 70px; margin: 2px 5px 2px 5px;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_DeleteAll'));},ontap:'voidAllPendingReceipts'},{style:'clear: both;'}]}]},{classes:'row-fluid',components:[{style:'span12',components:[{classes:'row-fluid',components:[{name:'pendingReceiptList',kind:'OB.UI.Table',renderLine:'OB.OBPOSCashUp.UI.RenderPendingReceiptLine',renderEmpty:'OB.UI.RenderEmpty',listStyle:'list'}]}]}]}]}]}]}],init:function(model){this.model=model;},collectionChanged:function(oldCol){this.$.pendingReceiptList.setCollection(this.collection);if(oldCol){oldCol.off('remove add reset',this.receiptsChanged);}
this.collection.on('remove add reset',this.receiptsChanged,this);},receiptsChanged:function(){if(this.collection.length===0){this.$.rowDeleteAll.hide();}else{this.$.rowDeleteAll.show();}},voidOrder:function(inSender,inEvent){var me=this,model=inEvent.originator.model;OB.UTIL.Approval.requestApproval(this.model,'OBPOS_approval.cashupremovereceipts',function(approved,supervisor,approvalType){if(approved){if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){me.markOrderAsDeleted(model);}else{OB.Dal.remove(model,function(){me.collection.remove(model);},OB.UTIL.showError);}}});},markOrderAsDeleted:function(model){var i,me=this,creationDate=model.get('creationDate')||new Date();model.set('creationDate',creationDate);model.set('timezoneOffset',creationDate.getTimezoneOffset());model.set('created',creationDate.getTime());model.set('obposCreatedabsolute',OB.I18N.formatDateISO(creationDate));model.set('obposIsDeleted',true);for(i=0;i<model.get('lines').length;i++){model.get('lines').at(i).set('obposIsDeleted',true);}
model.set('hasbeenpaid','Y');model.save();OB.MobileApp.model.updateDocumentSequenceWhenOrderSaved(model.get('documentnoSuffix'),model.get('quotationnoSuffix'),function(){me.collection.remove(model);});},voidAllPendingReceipts:function(inSender,inEvent){var me=this;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_ConfirmDeletion'),OB.I18N.getLabel('OBPOS_cannotBeUndone'),[{label:OB.I18N.getLabel('OBPOS_LblYesDelete'),isConfirmButton:true,action:function(){me.voidAllOrders();}},{label:OB.I18N.getLabel('OBMOBC_LblCancel')}]);},voidAllOrders:function(inSender,inEvent){var me=this;function removeOneModel(collection,model){if(OB.MobileApp.model.hasPermission('OBPOS_remove_ticket',true)){me.markOrderAsDeleted(model);}else{OB.Dal.remove(model,function(){collection.remove(model);},OB.UTIL.showError);}}
OB.UTIL.Approval.requestApproval(this.model,'OBPOS_approval.cashupremovereceipts',function(approved,supervisor,approvalType){if(approved){var models=me.collection.toArray();var i;for(i=0;i<models.length;i++){removeOneModel(me.collection,models[i]);}}});},displayStep:function(model){this.$.stepsheader.renderHeader(model.stepNumber('OB.CashUp.StepPendingOrders'),model.stepCount());}});enyo.kind({name:'OB.OBPOSCashUp.UI.RenderCashMasterLine',components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'float: left; display:table; width: 100%; ',components:[{style:'padding: 10px 10px 10px 10px; display: table-cell; width: 70%;',name:'slaveTerminalName'},{style:'padding: 10px 10px 10px 0px; display: table-cell; width: 30%; ',name:'slaveCashUpIsClosed'}]}]}]}],create:function(){this.inherited(arguments);this.$.slaveTerminalName.setContent(this.model.get('name'));if(this.model.get('finish')){this.$.slaveCashUpIsClosed.setContent(OB.I18N.getLabel('OBMOBC_LblYes'));this.$.slaveCashUpIsClosed.addStyles("color: green");}else if((!this.model.get('finish'))&&(this.model.get('noOfTransactions')===0)){this.$.slaveCashUpIsClosed.setContent(OB.I18N.getLabel('OBPOS_LblNotNeeded'));this.$.slaveCashUpIsClosed.addStyles("color: green");}else{this.$.slaveCashUpIsClosed.setContent(OB.I18N.getLabel('OBMOBC_LblNo'));this.$.slaveCashUpIsClosed.addStyles("color: red");}}});enyo.kind({name:'OB.OBPOSCashUp.UI.CashMaster',published:{paymentToKeep:null},components:[{classes:'tab-pane',components:[{style:'overflow:auto; height: 400px; margin: 5px',components:[{style:'background-color: #ffffff; color: black; padding: 5px; height:90%',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'stepsheader',style:'padding: 10px; border-bottom: 1px solid #cccccc; text-align:center;',renderHeader:function(step,count){this.setContent(OB.I18N.getLabel('OBPOS_LblStepNumber',[step,count])+" "+OB.I18N.getLabel('OBPOS_LblStepMaster')+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());}}]}]},{style:'background-color: #ffffff; color: black;',components:[{components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'float: left; display:table; width: 100%; ',components:[{style:'padding: 10px 10px 10px 10px; display: table-cell; width: 70%;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblTerminal'));}},{style:'padding: 10px 10px 10px 0px; display: table-cell; width: 30%;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblCashupSlaveClosed'));}}]}]}]},{name:'slaveList',kind:'OB.UI.Table',renderLine:'OB.OBPOSCashUp.UI.RenderCashMasterLine',renderEmpty:'OB.UI.RenderEmpty',listStyle:'list'}]}]}]}]}]}],displayStep:function(model){function processCashCloseMaster(callback){new OB.DS.Process('org.openbravo.retail.posterminal.ProcessCashCloseMaster').exec({masterterminal:OB.POS.modelterminal.get('terminal').id,cashUpId:OB.POS.modelterminal.get('terminal').cashUpId},function(data){if(data&&data.exception){OB.log('error',data.exception.message);OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_CashMgmtError'),OB.I18N.getLabel('OBPOS_ErrorServerGeneric')+data.exception.message,[{label:OB.I18N.getLabel('OBPOS_LblRetry'),action:function(){processCashCloseMaster(callback);}}],{autoDismiss:false,onHideFunction:function(){OB.POS.navigate('retail.pointofsale');}});}else{callback(data);}});}
var me=this;this.$.stepsheader.renderHeader(model.stepNumber('OB.CashUp.Master'),model.stepCount());if(!model.get('slavesCashupCompleted')){processCashCloseMaster(function(data){var col=new Backbone.Collection();col.add(data.terminals);me.$.slaveList.setCollection(col);if(data.finishAll){me.updateCashUpModel(model,data.payments);}
model.set('slavesCashupCompleted',data.finishAll);});}},updateCashUpModel:function(model,payments,updateCallback){OB.UTIL.SynchronizationHelper.executeWhenSynchronized({makeSynchronous:true},function(args,callback){var cashUpReport=model.get('cashUpReport').at(0);_.each(payments,function(payment){_.each(model.get('paymentList').models,function(item){if(item.get('searchKey')===payment.searchKey){item.set('startingCash',OB.DEC.add(item.get('startingCash'),payment.startingCash));item.set('totalDeposits',OB.DEC.add(item.get('totalDeposits'),payment.totalDeposits));item.set('totalDrops',OB.DEC.add(item.get('totalDrops'),payment.totalDrops));item.set('totalReturns',OB.DEC.add(item.get('totalReturns'),payment.totalReturns));item.set('totalSales',OB.DEC.add(item.get('totalSales'),payment.totalSales));var cTotalDeposits=OB.DEC.sub(item.get('totalDeposits'),OB.DEC.abs(item.get('totalDrops'))),expected=OB.DEC.add(OB.DEC.add(item.get('startingCash'),OB.DEC.sub(item.get('totalSales'),OB.DEC.abs(item.get('totalReturns')))),cTotalDeposits);var fromCurrencyId=item.get('paymentMethod').currency;item.set('expected',OB.UTIL.currency.toDefaultCurrency(fromCurrencyId,expected));item.set('foreignExpected',expected);}});_.each(cashUpReport.get('deposits'),function(item){if(item.get('searchKey')===payment.searchKey){var sum=OB.DEC.add(OB.DEC.add(item.get('amount'),payment.totalDeposits),payment.totalSales);item.set('origAmount',OB.UTIL.currency.toDefaultCurrency(item.get('currency'),sum));item.set('amount',sum);}});_.each(cashUpReport.get('drops'),function(item){if(item.get('searchKey')===payment.searchKey){var sum=OB.DEC.add(OB.DEC.add(item.get('amount'),payment.totalDrops),payment.totalReturns);item.set('origAmount',OB.UTIL.currency.toDefaultCurrency(item.get('currency'),sum));item.set('amount',sum);}});_.each(cashUpReport.get('startings'),function(item){if(item.get('searchKey')===payment.searchKey){var sum=OB.DEC.add(item.get('amount'),payment.startingCash);item.set('origAmount',OB.UTIL.currency.toDefaultCurrency(item.get('currency'),sum));item.set('amount',sum);}});});cashUpReport.set('totalDeposits',_.reduce(cashUpReport.get('deposits'),function(accum,trx){return OB.DEC.add(accum,trx.get("origAmount"));},0));cashUpReport.set('totalDrops',_.reduce(cashUpReport.get('drops'),function(accum,trx){return OB.DEC.add(accum,trx.get("origAmount"));},0));cashUpReport.set('totalStartings',_.reduce(cashUpReport.get('startings'),function(accum,trx){return OB.DEC.add(accum,trx.get("origAmount"));},0));model.set('totalExpected',_.reduce(model.get('paymentList').models,function(total,model){return OB.DEC.add(total,model.get('expected'));},0));model.set('totalDifference',OB.DEC.sub(model.get('totalDifference'),model.get('totalExpected')));if(updateCallback!==undefined){updateCallback();}
callback();});}});enyo.kind({name:'OB.OBPOSCashUp.UI.RenderCashPaymentsLine',statics:{getLegacyCoins:function(){return new Backbone.Collection([{amount:0.01,backcolor:'#f3bc9e'},{amount:0.02,backcolor:'#f3bc9e'},{amount:0.05,backcolor:'#f3bc9e'},{amount:0.10,backcolor:'#f9e487'},{amount:0.20,backcolor:'#f9e487'},{amount:0.50,backcolor:'#f9e487'},{amount:1,backcolor:'#e4e0e3',bordercolor:'#f9e487'},{amount:2,backcolor:'#f9e487',bordercolor:'#e4e0e3'},{amount:5,backcolor:'#bccdc5'},{amount:10,backcolor:'#e9b7c3'},{amount:20,backcolor:'#bac3de'},{amount:50,backcolor:'#f9bb92'}]);}},events:{onLineEditCash:'',onAddUnit:'',onSubUnit:''},components:[{components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{name:'coin',kind:'OB.UI.MediumButton',classes:'btnlink-gray btnlink-cashup-edit',ontap:'addUnit'},{name:'qtyminus',kind:'OB.UI.SmallButton',style:'width: 8%;',classes:'btnlink-gray btnlink-cashup-edit',content:'-',ontap:'subUnit'},{name:'numberOfCoins',kind:'OB.UI.MediumButton',classes:'btnlink-gray btnlink-cashup-edit',style:'background-color: white; border: 1px solid lightgray; border-radius: 3px; width: 18%',ontap:'lineEdit'},{name:'qtyplus',kind:'OB.UI.SmallButton',style:'width: 8%',classes:'btnlink-gray btnlink-cashup-edit',content:'+',ontap:'addUnit'},{name:'total',style:'margin-left: 2%; display:inline-block;padding: 10px 0px 10px 0px; width: 26%; text-align: center;'}]}]}]}],create:function(){this.inherited(arguments);this.$.coin.setContent(OB.I18N.formatCurrency(this.model.get('coinValue')));var style='float: left; width: 27%; text-align: center;';if(this.model.get('bordercolor')){style+=' border:6px solid '+this.model.get('bordercolor')+';';}
style+=' background-color:'+this.model.get('backcolor')+';';this.$.coin.addStyles(style);this.$.numberOfCoins.setContent(this.model.get('numberOfCoins'));this.$.total.setContent(OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('totalAmount'))));},render:function(){var udfn,counted,foreignCounted;this.inherited(arguments);counted=this.model.get('numberOfCoins');if(counted!==null&&counted!==udfn){this.$.numberOfCoins.setContent(counted);this.$.total.setContent(OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('totalAmount'))));}
return this;},lineEdit:function(){this.doLineEditCash();},addUnit:function(){this.doAddUnit();},subUnit:function(){this.doSubUnit();}});enyo.kind({name:'OB.OBPOSCashUp.UI.RenderTotal',tag:'span',style:'font-weight: bold;',printAmount:function(value){this.setContent(OB.I18N.formatCurrency(value));this.applyStyle('color',OB.DEC.compare(value)<0?'red':'black');}});enyo.kind({name:'OB.OBPOSCashUp.UI.CashPayments',handlers:{onAddUnit:'addUnit',onSubUnit:'subUnit',onLineEditCash:'lineEditCash'},components:[{classes:'tab-pane',components:[{style:'margin: 5px',components:[{style:'background-color: #ffffff; color: black; padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{style:'padding: 10px; border-bottom: 1px solid #cccccc; text-align:center;',name:'title',renderHeader:function(value,step,count){this.setContent(OB.I18N.getLabel('OBPOS_LblStepNumber',[step,count])+" "+OB.I18N.getLabel('OBPOS_LblStepCashPayments',[value])+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());}}]}]},{style:'background-color: #ffffff; color: black; height: 100%; width:100%',components:[{components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'padding: 10px 20px 10px 10px; float: left; width: 30%',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_CoinType'));}},{style:'padding: 10px 20px 10px 0px; float: left; width: 30%',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_NumberOfItems'));}},{style:'padding: 10px 0px 10px 0px;  float: left; width: 25%',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_AmountOfCash'));}}]}]},{style:'background-color: #ffffff; height: 454px; clear:left; width:100%',components:[{name:'paymentsList',kind:'OB.UI.ScrollableTable',renderLine:'OB.OBPOSCashUp.UI.RenderCashPaymentsLine',renderEmpty:'OB.UI.RenderEmpty',scrollAreaMaxHeight:'454px',listStyle:'list'},{name:'renderLoading',style:'border-bottom: 1px solid #cccccc; padding: 20px; text-align: center; font-weight: bold; font-size: 30px; color: #cccccc',showing:false,initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblLoading'));}}]},{classes:'row-fluid',components:[{style:'border-bottom: 1px solid #cccccc; border-top: 1px solid #cccccc; height: 70px;',components:[{style:'float:left; display: table-row; width: 33%',components:[{name:'totalLbl',style:'padding: 10px 20px 10px 10px; display: table-cell;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_ReceiptTotal'));}},{style:'padding: 10px 20px 10px 0px; display: table-cell;',components:[{name:'total',kind:'OB.OBPOSCashUp.UI.RenderTotal'}]}]},{style:'float:left; display: table-row; width: 33%',components:[{name:'countedLbl',style:'padding: 10px 20px 10px 10px; display: table-cell;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_Counted'));}},{style:'padding: 10px 5px 10px 0px; display: table-cell;',components:[{name:'counted',kind:'OB.OBPOSCashUp.UI.RenderTotal'}]}]},{style:'float:left; display: table-row; width: 33%',components:[{name:'differenceLbl',style:'padding: 10px 20px 10px 10px; display: table-cell;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_Remaining'));}},{style:'padding: 10px 5px 10px 0px; display: table-cell;',components:[{name:'difference',kind:'OB.OBPOSCashUp.UI.RenderTotal'}]}]}]}]}]}]}]}]}]}],init:function(model){this.inherited(arguments);this.model=model;this.model.on('action:resetAllCoins',function(args){this.resetAllCoins();},this);this.model.on('action:SelectCoin',function(args){this.selectCoin(args);},this);},printTotals:function(){this.$.counted.printAmount(this.payment.get('foreignCounted'));this.$.difference.printAmount(this.payment.get('foreignDifference'));},lineEditCash:function(inSender,inEvent){this.setCoinsStatus(inEvent.originator);},setCoinsStatus:function(originator){if(this.originator&&this.originator.$.numberOfCoins){this.originator.$.numberOfCoins.applyStyle('background-color','white');}
if(originator&&originator!==this.originator){this.originator=originator;this.originator.$.numberOfCoins.applyStyle('background-color','#6CB33F');this.model.trigger('action:SetStatusCoin');}else{this.originator=null;this.model.trigger('action:ResetStatusCoin');}},selectCoin:function(args){if(this.originator){this.addUnitToCollection(this.originator.model.get('coinValue'),parseInt(args.txt,10));}},addUnit:function(inSender,inEvent){this.addUnitToCollection(inEvent.originator.model.get('coinValue'),'add');},subUnit:function(inSender,inEvent){this.addUnitToCollection(inEvent.originator.model.get('coinValue'),'sub');},addUnitToCollection:function(coinValue,amount){var collection=this.$.paymentsList.collection;var lAmount,resetAmt,newAmount;if(amount==='add'){lAmount=1;resetAmt=false;}else if(amount==='sub'){lAmount=-1;resetAmt=false;}else{lAmount=amount;resetAmt=true;}
var totalCounted=0;collection.each(function(coin){if(coin.get('coinValue')===coinValue){if(resetAmt){newAmount=lAmount;}else{newAmount=coin.get('numberOfCoins')+lAmount;}
if(newAmount>=0){coin.set('numberOfCoins',newAmount);}}
coin.set('totalAmount',OB.DEC.mul(coin.get('numberOfCoins'),coin.get('coinValue')));totalCounted+=coin.get('totalAmount');});this.payment.set('foreignCounted',totalCounted);var cTotalCounted=OB.UTIL.currency.toDefaultCurrency(this.payment.attributes.paymentMethod.currency,totalCounted);this.payment.set('counted',cTotalCounted);this.payment.set('foreignDifference',OB.DEC.sub(totalCounted,OB.Utilities.Number.roundJSNumber(this.payment.get('foreignExpected'),2)));this.printTotals();this.setCoinsStatus(null);},resetAllCoins:function(){var collection=this.$.paymentsList.collection;collection.each(function(coin){coin.set('numberOfCoins',0);coin.set('totalAmount',0);});this.payment.set('foreignCounted',0);this.payment.set('counted',0);this.payment.set('foreignDifference',OB.DEC.sub(0,this.payment.get('foreignExpected')));this.printTotals();this.setCoinsStatus(null);},initPaymentToCount:function(payment){this.payment=payment;this.$.title.renderHeader(payment.get('name'),this.model.stepNumber('OB.CashUp.CashPayments'),this.model.stepCount());this.$.total.printAmount(this.payment.get('foreignExpected'));if(!this.payment.get('coinsCollection')){this.$.paymentsList.hide();this.$.renderLoading.show();this.$.paymentsList.setCollection(new Backbone.Collection());this.payment.set('foreignCounted',0);this.payment.set('counted',0);this.payment.set('foreignDifference',OB.DEC.sub(0,this.payment.get('foreignExpected')));this.printTotals();this.setCoinsStatus(null);var currencyId=payment.get('paymentMethod').currency;var me=this;OB.Dal.find(OB.Model.CurrencyPanel,{currency:currencyId,_orderByClause:'line'},function(coins){var coinCol=new Backbone.Collection();if(coins.length===0&&payment.get('paymentMethod').currency==='102'){coins=OB.OBPOSCashUp.UI.RenderCashPaymentsLine.getLegacyCoins();}
coins.each(function(coin){var coinModel=new Backbone.Model();coinModel.set('numberOfCoins',0);coinModel.set('totalAmount',0);coinModel.set('coinValue',coin.get('amount'));coinModel.set('backcolor',coin.get('backcolor'));coinModel.set('bordercolor',coin.get('bordercolor'));coinCol.add(coinModel);});me.payment.set('coinsCollection',coinCol);me.$.paymentsList.setCollection(coinCol);me.payment.set('foreignCounted',0);me.payment.set('counted',0);me.payment.set('foreignDifference',OB.DEC.sub(0,me.payment.get('foreignExpected')));me.printTotals();me.setCoinsStatus(null);me.$.renderLoading.hide();me.$.paymentsList.show();});}else{this.$.paymentsList.setCollection(this.payment.get('coinsCollection'));this.printTotals();this.setCoinsStatus(null);}},displayStep:function(model){this.model=model;var payment=model.get('paymentList').at(model.get('substep'));this.initPaymentToCount(payment);if(payment.get('paymentMethod').allowopendrawer){OB.POS.hwserver.openDrawer(false,OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerCount);}}});enyo.kind({name:'OB.OBPOSCashUp.UI.RenderPaymentsLine',events:{onLineEditCount:''},components:[{components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'float:left; display: table; width: 50%',components:[{name:'name',style:'padding: 10px 20px 10px 10px; display: table-cell; width: 40%;'},{name:'foreignExpected',style:'padding: 10px 10px 10px 0px; text-align:right; display: table-cell; width: 35%;'},{name:'expected',style:'padding: 10px 10px 10px 0px; text-align:right; display: table-cell; width: 35%;'}]},{style:'float:left; display: table; width: 50%;',components:[{style:'display: table-cell; width: 15%;',components:[{name:'buttonEdit',kind:'OB.UI.SmallButton',classes:'btnlink-orange btnlink-cashup-edit btn-icon-small btn-icon-edit',ontap:'lineEdit'}]},{style:'display: table-cell; width: 15%;',components:[{name:'buttonOk',kind:'OB.UI.SmallButton',classes:'btnlink-green btnlink-cashup-ok btn-icon-small btn-icon-check',ontap:'lineOK'}]},{name:'foreignCounted',style:'display: table-cell; padding: 10px 10px 10px 0px; text-align:right; width: 35%;',content:''},{name:'counted',style:'display: table-cell; padding: 10px 10px 10px 0px; text-align:right; width: 35%;',showing:false}]}]}]}]}],create:function(){this.inherited(arguments);this.$.name.setContent(this.model.get('name'));if(this.model.get('rate')&&this.model.get('rate')!==1){this.$.foreignExpected.setContent('('+OB.I18N.formatCurrency(this.model.get('foreignExpected'))+' '+this.model.get('isocode')+')');this.$.foreignExpected.show();}
this.$.expected.setContent(OB.I18N.formatCurrency(OB.DEC.add(0,this.model.get('expected'))));},render:function(){var udfn,counted,foreignCounted;this.inherited(arguments);counted=this.model.get('counted');if(counted!==null&&counted!==udfn){this.$.counted.setContent(OB.I18N.formatCurrency(OB.DEC.add(0,counted)));this.$.counted.show();if(this.model.get('rate')&&this.model.get('rate')!==1){this.$.foreignCounted.setContent('('+OB.I18N.formatCurrency(this.model.get('foreignCounted'))+' '+this.model.get('isocode')+')');}
this.$.buttonOk.hide();}
this.$.buttonEdit.setDisabled(this.model.get('paymentMethod').iscash&&this.model.get('paymentMethod').countcash);},lineEdit:function(){this.doLineEditCount();},lineOK:function(inSender,inEvent){this.model.set('counted',this.model.get('expected'));this.model.set('foreignCounted',this.model.get('foreignExpected'));}});enyo.kind({name:'OB.OBPOSCashUp.UI.ListPaymentMethods',handlers:{onAnyCounted:'anyCounted'},events:{onCountAllOK:'',onShowPopup:''},components:[{classes:'tab-pane',components:[{style:'margin: 5px; background-color: #ffffff',components:[{style:'background-color: #ffffff; color: black; padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{style:'padding: 10px; border-bottom: 1px solid #cccccc; text-align:center;',name:'stepsheader',renderHeader:function(step,count){this.setContent(OB.I18N.getLabel('OBPOS_LblStepNumber',[step,count])+" "+OB.I18N.getLabel('OBPOS_LblStepPaymentMethods')+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());}}]}]},{style:'background-color: #ffffff; color: black;',components:[{components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'float: left; display:table; width: 50%; ',components:[{style:'padding: 10px 10px 10px 10px; display: table-cell; width: 60%;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblPaymentMethod'));}},{style:'padding: 10px 10px 10px 0px; display: table-cell; width: 40%; text-align:right;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblExpected'));}}]},{style:'float: right; display:table;',components:[{style:'padding: 10px 40px 10px 0px; display: table-cell; width: 100%; text-align: right;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_LblCounted'));}}]}]}]},{classes:'row-fluid',style:'background-color: #ffffff; max-height: 430px; overflow: auto; clear: both; width:100%; border-bottom: 1px solid #cccccc;',components:[{name:'paymentsList',kind:'OB.UI.Table',renderLine:'OB.OBPOSCashUp.UI.RenderPaymentsLine',renderEmpty:'OB.UI.RenderEmpty',listStyle:'list'}]},{components:[{classes:'row-fluid',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'float: left; display:table; width: 50%; ',components:[{style:'display:table-cell; width: 100%;',content:'&nbsp;',allowHtml:true}]},{style:'float: left; display:table; width: 50%; ',components:[{style:'display:table-cell; width: 50px; padding: 10px 10px 10px 0px;'},{style:'display:table-cell; width: 15%;',components:[{name:'buttonAllOk',kind:'OB.UI.SmallButton',classes:'btnlink-green btnlink-cashup-ok btn-icon-small btn-icon-check',ontap:'doCountAllOK'}]},{}]}]}]}]},{classes:'row-fluid',style:'background-color: #ffffff; height: 40px; width:100%; clear: both;',components:[{classes:'span12',style:'border-bottom: 1px solid #cccccc;',components:[{style:'float: left; display:table; width: 50%; ',components:[{name:'totalLbl',style:'padding: 10px 10px 10px 10px; display: table-cell; width: 60%;',initComponents:function(){this.setContent(OB.I18N.getLabel('OBPOS_ReceiptTotal'));}},{style:'padding: 10px 10px 10px 0px; display: table-cell; width: 40%; text-align:right;',components:[{name:'total',kind:'OB.OBPOSCashUp.UI.RenderTotal'}]}]},{components:[{style:'float: left; display:table; width: 50%; ',components:[{style:'padding: 10px 40px 10px 0px; display: table-cell; width: 100%; text-align: right;',name:'difference',kind:'OB.OBPOSCashUp.UI.RenderTotal'}]}]}]}]}]}]}]}]}]}],setCollection:function(col){this.$.paymentsList.setCollection(col);},anyCounted:function(){this.$.buttonAllOk.applyStyle('visibility','hidden');},displayStep:function(model){this.$.stepsheader.renderHeader(model.stepNumber('OB.CashUp.PaymentMethods'),model.stepCount());var opendrawer=model.get('paymentList').any(function(payment){var paymentmethod=payment.get('paymentMethod');return paymentmethod.iscash&&!paymentmethod.countcash&&paymentmethod.allowopendrawer;});if(opendrawer){OB.POS.hwserver.openDrawer(false,OB.MobileApp.model.get('permissions').OBPOS_timeAllowedDrawerCount);}},verifyStep:function(model,callback){this.model=model;var totalCashDiff=0,cashDiff=[],me=this;_.each(model.get('paymentList').models,function(payment){var paymentMethod=payment.get('paymentMethod'),difference=OB.DEC.abs(payment.get('difference'));if(difference!==0){totalCashDiff+=difference;var countDiffLimit=paymentMethod.countDiffLimit;if(!OB.UTIL.isNullOrUndefined(countDiffLimit)&&difference>=countDiffLimit){cashDiff.push({_identifier:paymentMethod._identifier,searchKey:paymentMethod.searchKey,difference:difference,countDiffLimit:countDiffLimit});}}});var serverMsg='',approvals=[];if(cashDiff.length>0){var message=[{message:OB.I18N.getLabel('OBPOS_approval.cashupdifferences')}];_.each(cashDiff,function(diff){var msg=OB.I18N.getLabel('OBPOS_approval.paymentmethod.countdifferences',[diff._identifier,OB.I18N.formatCurrency(diff.difference),OB.I18N.formatCurrency(diff.countDiffLimit)]);message.push({message:msg,padding:'1em',fontSize:'16px'});serverMsg+=msg+"\r\n";});approvals.push({approval:'OBPOS_approval.cashupdifferences',message:message});serverMsg=OB.I18N.getLabel('OBPOS_approval.cashupdifferences')+"\r\n"+serverMsg;}else{var organizationCountDiffLimit=OB.MobileApp.model.get('terminal').organizationCountDiffLimit;if(!OB.UTIL.isNullOrUndefined(organizationCountDiffLimit)&&totalCashDiff>=organizationCountDiffLimit){approvals.push({approval:'OBPOS_approval.cashupdifferences',message:'OBPOS_approval.global.countdifferences',params:[OB.I18N.formatCurrency(totalCashDiff),OB.I18N.formatCurrency(organizationCountDiffLimit)]});serverMsg=OB.I18N.getLabel('OBPOS_approval.global.countdifferences',[OB.I18N.formatCurrency(totalCashDiff),OB.I18N.formatCurrency(organizationCountDiffLimit)]);}}
if(approvals.length>0){OB.UTIL.Approval.requestApproval(model,approvals,function(approved,supervisor,approvalType){if(approved){if(OB.POS.modelterminal.get('approvalReason').length>0){me.doShowPopup({popup:'OBPOS_modalApprovalReason',args:{supervisor:supervisor.id,message:serverMsg,callback:callback}});}else{model.set('approvals',{supervisor:supervisor.id,message:serverMsg});callback();}}});}else{callback();}}});enyo.kind({name:'OB.OBPOSCashUp.UI.CashToKeepRadioButton',kind:'OB.UI.RadioButton',style:'padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 40px; margin-top: 10px; margin-right: 10px; margin-bottom: 10px; margin-left: 10px;',components:[{name:'lbl',style:'padding: 5px 0px 0px 0px;'}],events:{onPaymentMethodKept:''},tap:function(){this.inherited(arguments);this.doPaymentMethodKept({qtyToKeep:this.qtyToKeep,name:this.name});},render:function(content){this.$.lbl.setContent(content);},setQtyToKeep:function(qty){this.qtyToKeep=qty;},initComponents:function(){this.inherited(arguments);if(this.i18nLabel){this.$.lbl.setContent(OB.I18N.getLabel(this.i18nLabel));return;}
if(this.label){this.$.lbl.setContent(this.label);}}});enyo.kind({name:'OB.OBPOSCashUp.UI.KeepDetails',style:'background-color: #ffffff; color: black;',events:{onResetQtyToKeep:''},init:function(model){this.model=model;var me=this;this.model.on('change:otherInput',function(){me.$.variableInput.setContent(me.model.get('otherInput'));me.$.allowvariableamount.setQtyToKeep(me.model.get('otherInput'));me.$.allowvariableamount.tap();},this);},components:[{kind:"Group",name:'RadioGroup',classes:'btn-group',components:[{name:'keepfixedamount',showing:false,kind:'OB.OBPOSCashUp.UI.CashToKeepRadioButton'},{style:'clear: both;'},{name:'allowmoveeverything',kind:'OB.OBPOSCashUp.UI.CashToKeepRadioButton',qtyToKeep:0,i18nLabel:'OBPOS_LblNothing',showing:false},{style:'clear: both;'},{name:'allowdontmove',kind:'OB.OBPOSCashUp.UI.CashToKeepRadioButton',showing:false},{style:'clear: both;'},{name:'allowvariableamount',binded:false,kind:'OB.OBPOSCashUp.UI.CashToKeepRadioButton',showing:false,qtyToKeep:0,style:'padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 40px; margin-top: 10px; margin-right: 10px; margin-bottom: 10px; margin-left: 10px;',components:[{style:'display: table-row;',components:[{name:'variableamount',style:'vertical-align: middle; display: table-cell; ',setAmount:function(amount){this.setContent(enyo.format(OB.I18N.getLabel('OBPOS_LblOtherMaxAmount'),OB.I18N.formatCurrency(amount,2)));},initComponents:function(){this.setAmount(0);}},{name:'variableInput',style:'padding-left: 20px; display: table-cell;',content:OB.DEC.Zero}]}]}]}]});enyo.kind({name:'OB.OBPOSCashUp.UI.CashToKeep',published:{paymentToKeep:null},components:[{classes:'tab-pane',components:[{style:'overflow:auto; height: 500px; margin: 5px',components:[{style:'background-color: #ffffff; color: black; padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'cashtokeepheader',style:'padding: 10px; border-bottom: 1px solid #cccccc; text-align:center;',renderHeader:function(value,step,count){this.setContent(OB.I18N.getLabel('OBPOS_LblStepNumber',[step,count])+" "+OB.I18N.getLabel('OBPOS_LblStepCashToKeep',[value])+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());}}]}]},{kind:'OB.OBPOSCashUp.UI.KeepDetails',name:'formkeep',handlers:{onChangeOption:'changeOption'},changeOption:function(inSender,inEvent){this.$.allowvariableamount.tap();},disableControls:function(modelToDraw){this.$.keepfixedamount.disableRadio();this.$.allowmoveeverything.disableRadio();this.$.allowdontmove.disableRadio();this.$.allowvariableamount.disableRadio();this.$.variableInput.setContent('');if(modelToDraw){var paymentMethod=modelToDraw.get('paymentMethod');if(paymentMethod&&paymentMethod.allowvariableamount){this.doResetQtyToKeep({qtyToKeep:null});}}},renderFixedAmount:function(modelToDraw){var udfn,cnted;if(modelToDraw.get('foreignCounted')){cnted=modelToDraw.get('foreignCounted');}else{cnted=modelToDraw.get('counted');}
this.$.variableamount.setAmount(cnted);this.$.keepfixedamount.setShowing(modelToDraw.get('paymentMethod').keepfixedamount);if(modelToDraw.get('paymentMethod').keepfixedamount){if(modelToDraw.get('foreignCounted')!==null&&modelToDraw.get('foreignCounted')!==udfn){if(cnted<modelToDraw.get('paymentMethod').amount){this.$.keepfixedamount.render(OB.I18N.formatCurrency(cnted));this.$.keepfixedamount.setQtyToKeep(cnted);}else{this.$.keepfixedamount.render(OB.I18N.formatCurrency(modelToDraw.get('paymentMethod').amount));this.$.keepfixedamount.setQtyToKeep(modelToDraw.get('paymentMethod').amount);}}else{this.$.keepfixedamount.render(OB.I18N.formatCurrency(modelToDraw.get('paymentMethod').amount));this.$.keepfixedamount.setQtyToKeep(modelToDraw.get('paymentMethod').amount);}}else{this.$.keepfixedamount.render('');}},renderBody:function(modelToDraw){var paymentMethod=modelToDraw.get('paymentMethod');if(!paymentMethod.automatemovementtoother){return true;}
this.disableControls(modelToDraw);this.renderFixedAmount(modelToDraw);this.$.allowmoveeverything.setShowing(paymentMethod.allowmoveeverything);this.$.allowdontmove.setShowing(paymentMethod.allowdontmove);if(paymentMethod.allowdontmove){this.$.allowdontmove.setQtyToKeep(modelToDraw.get('foreignCounted'));this.$.allowdontmove.render(OB.I18N.getLabel('OBPOS_LblTotalAmount')+' '+OB.I18N.formatCurrency(modelToDraw.get('foreignCounted')));}else{this.$.allowdontmove.render('');}
this.$.allowvariableamount.setShowing(paymentMethod.allowvariableamount);}}]}]}]}],paymentToKeepChanged:function(model){this.$.cashtokeepheader.renderHeader(this.paymentToKeep.get('name'),this.model.stepNumber('OB.CashUp.CashToKeep'),this.model.stepCount());this.$.formkeep.renderBody(this.paymentToKeep);if(this.paymentToKeep.get('paymentMethod').keepfixedamount){this.paymentToKeep.on('change:counted',function(mod){this.$.formkeep.renderFixedAmount(this.paymentToKeep);},this);}},displayStep:function(model){this.model=model;this.$.formkeep.disableControls();this.setPaymentToKeep(model.get('paymentList').at(model.get('substep')));}});enyo.kind({name:'OB.OBPOSCashUp.UI.ppc_lineSeparator',classes:'row-fluid',components:[{classes:'span12',components:[{style:'width: 10%; float: left;',components:[{allowHtml:true,tag:'span',content:'&nbsp;'}]},{style:'padding: 5px 0px 0px 5px; float: left; width: 60%; font-weight:bold;',components:[{style:'clear:both;'}]}]},{}]});enyo.kind({name:'OB.OBPOSCashUp.UI.ppc_totalsLine',classes:'row-fluid',label:'',value:'',components:[{classes:'span12',components:[{style:'width: 10%; float: left;',components:[{allowHtml:true,tag:'span',content:'&nbsp;'}]},{name:'totalLbl',style:'padding: 5px 0px 0px 5px; border-bottom: 1px solid #cccccc; border-top: 1px solid #cccccc; border-right: 1px solid #cccccc; float: left; width: 55%; font-weight:bold;'},{name:'totalQty',style:'padding: 5px 0px 0px 5px; border-bottom: 1px solid #cccccc; border-top: 1px solid #cccccc; float: left; width: 20%; text-align:right; font-weight:bold;'},{style:'width: 10%; float: left;',components:[{allowHtml:true,tag:'span',content:'&nbsp;'}]}]},{}],setValue:function(value){this.value=value;this.render();},render:function(){if(this.label){this.$.totalLbl.setContent(this.label);}else{this.$.totalLbl.setContent(OB.I18N.getLabel(this.i18nLabel));}
this.$.totalQty.setContent(OB.I18N.formatCurrency(OB.DEC.add(0,this.value)));},initComponents:function(){this.inherited(arguments);if((this.label||this.i18nLabel)&&this.value){if(this.i18nLabel){this.$.totalLbl.setContent(OB.I18N.getLabel(this.i18nLabel));}else{this.$.totalLbl.setContent(this.label);}
this.$.totalQty.setContent(this.value);}}});enyo.kind({name:'OB.OBPOSCashUp.UI.ppc_itemLine',label:'',value:'',classes:'row-fluid',convertedValues:['expected','counted','difference','qtyToKeep','qtyToDepo'],valuestoConvert:['deposits','drops','startings'],components:[{classes:'span12',components:[{style:'width: 10%; float: left;',components:[{allowHtml:true,tag:'span',content:'&nbsp;'}]},{name:'itemLbl',allowHtml:true,style:'padding: 5px 0px 0px 5px;  border-top: 1px solid #cccccc; float: left; width: 35%'},{name:'foreignItemQty',style:'padding: 5px 0px 0px 0px;  border-top: 1px solid #cccccc; float: left; width: 20%; text-align:right;'},{name:'itemQty',style:'padding: 5px 0px 0px 5px;  border-top: 1px solid #cccccc; border-left: 1px solid #cccccc; float: left; width: 20%; text-align:right;'},{style:'width: 10%; float: left;',components:[{allowHtml:true,tag:'span',content:'&nbsp;'}]}]},{}],setValue:function(value){this.value=value;this.render();},render:function(){if(this.i18nLabel){this.$.itemLbl.setContent(OB.I18N.getLabel(this.i18nLabel));}else{this.$.itemLbl.setContent(this.label);}
this.$.itemQty.setContent(OB.I18N.formatCurrency(OB.DEC.add(0,this.value)));if(this.convertedValue&&this.convertedValue!==this.value&&this.convertedValues.indexOf(this.type)!==-1){this.$.foreignItemQty.setContent('('+OB.I18N.formatCurrency(this.convertedValue)+' '+this.isocode+')');}else if(this.valueToConvert&&this.value!==this.valueToConvert&&this.valuestoConvert.indexOf(this.type)!==-1){if(this.value){this.$.foreignItemQty.setContent('('+OB.I18N.formatCurrency(this.value)+' '+this.isocode+')');}
this.$.itemQty.setContent(OB.I18N.formatCurrency(this.valueToConvert));}else{this.$.foreignItemQty.setContent('');}},create:function(){if(this.model&&this.model.get('searchKey')){this.name=this.model.get('searchKey');}
this.inherited(arguments);if(this.model){this.label=this.model.get(this.lblProperty);this.value=this.model.get(this.qtyProperty);this.type=this.owner.typeProperty;this.valueToConvert=this.model.get('origAmount');this.convertedValue=this.model.get('second');this.rate=this.model.get('rate');this.isocode=this.model.get('isocode');if(this.convertedValue&&this.convertedValues.indexOf(this.type)===-1){OB.warn("DEVELOPER: the type '"+this.type+"' is being incorrectly implemented.");}
if(this.valueToConvert&&this.valuestoConvert.indexOf(this.type)===-1){OB.warn("DEVELOPER: the type '"+this.type+"' is being incorrectly implemented.");}}}});enyo.kind({name:'OB.OBPOSCashUp.UI.ppc_collectionLines',kind:'OB.UI.iterateArray',renderLine:'OB.OBPOSCashUp.UI.ppc_itemLine',renderEmpty:'OB.UI.RenderEmpty'});enyo.kind({name:'OB.OBPOSCashUp.UI.ppc_table',setValue:function(name,value){this.$[name].setValue(value);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_salesTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_itemLine',name:'netsales',i18nLabel:'OBPOS_LblNetSales'},{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'salestaxes',lblProperty:'name',qtyProperty:'amount'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalsales',i18nLabel:'OBPOS_LblGrossSales'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.salestaxes.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_returnsTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_itemLine',name:'netreturns',i18nLabel:'OBPOS_LblNetReturns'},{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'retunrnstaxes',lblProperty:'name',qtyProperty:'amount'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalreturns',i18nLabel:'OBPOS_LblGrossReturns'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.retunrnstaxes.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_totalTransactionsTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totaltransactionsline',i18nLabel:'OBPOS_LblTotalRetailTrans',init:function(){if(OB.POS.modelterminal.get('terminal').ismaster||OB.POS.modelterminal.get('terminal').isslave){this.label=OB.I18N.getLabel('OBPOS_LblTotalRetailTransLocal');}}},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}]});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashDropsTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'drops',lblProperty:'description',qtyProperty:'amount',typeProperty:'drops'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totaldrops',i18nLabel:'OBPOS_LblTotalWithdrawals'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.drops.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashDepositsTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'deposits',lblProperty:'description',qtyProperty:'amount',typeProperty:'deposits'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totaldeposits',i18nLabel:'OBPOS_LblTotalDeposits'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.deposits.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_startingsTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'startings',lblProperty:'description',qtyProperty:'amount',typeProperty:'startings'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalstartings',i18nLabel:'OBPOS_LblTotalStarting'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.startings.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashExpectedTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'expectedPerPayment',lblProperty:'name',qtyProperty:'value',typeProperty:'expected'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalexpected',i18nLabel:'OBPOS_LblTotalExpected'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.expectedPerPayment.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashDifferenceTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'differencePerPayment',lblProperty:'name',qtyProperty:'value',typeProperty:'difference'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totaldifference',i18nLabel:'OBPOS_LblTotalDifference'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.differencePerPayment.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashCountedTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'countedPerPayment',lblProperty:'name',qtyProperty:'value',typeProperty:'counted'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalcounted',i18nLabel:'OBPOS_LblTotalCounted'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.countedPerPayment.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashQtyToKeepTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'qtyToKeepPerPayment',lblProperty:'name',qtyProperty:'value',typeProperty:'qtyToKeep'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalqtyToKeep',i18nLabel:'OBPOS_LblTotalQtyToKeep'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.qtyToKeepPerPayment.setCollection(col);}});enyo.kind({kind:'OB.OBPOSCashUp.UI.ppc_table',name:'OB.OBPOSCashUp.UI.ppc_cashQtyToDepoTable',components:[{kind:'OB.OBPOSCashUp.UI.ppc_collectionLines',name:'qtyToDepoPerPayment',lblProperty:'name',qtyProperty:'value',typeProperty:'qtyToDepo'},{kind:'OB.OBPOSCashUp.UI.ppc_totalsLine',name:'totalqtyToDepo',i18nLabel:'OBPOS_LblTotalQtyToDepo'},{kind:'OB.OBPOSCashUp.UI.ppc_lineSeparator',name:'separator'}],setCollection:function(col){this.$.qtyToDepoPerPayment.setCollection(col);}});enyo.kind({name:'OB.OBPOSCashUp.UI.PostPrintClose',published:{model:null,summary:null},classes:'tab-pane',components:[{style:'overflow:auto; height: 612px; margin: 5px; background-color: #ffffff;',components:[{style:'background-color: #ffffff; color: black; padding: 5px;',components:[{classes:'row-fluid',components:[{classes:'span12',components:[{name:'reporttitle',style:'padding: 10px; border-bottom: 1px solid #cccccc; text-align:center;',renderHeader:function(step,count){this.setContent(OB.I18N.getLabel('OBPOS_LblStepNumber',[step,count])+" "+OB.I18N.getLabel('OBPOS_LblStepPostPrintAndClose')+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());}}]}]},{classes:'row-fluid',components:[{classes:'span12',components:[{style:'padding: 10px; text-align:center;',components:[{tag:'img',style:'padding: 20px;',initComponents:function(){if(OB.MobileApp.model.get('terminal').organizationImage){this.setAttribute('src','data:'+OB.MobileApp.model.get('terminal').organizationImageMime+';base64,'+OB.MobileApp.model.get('terminal').organizationImage);}}},{name:'store',style:'padding: 5px; text-align:center;'},{name:'terminal',style:'padding: 5px; text-align:center;'},{name:'user',style:'padding: 5px; text-align:center;'},{name:'time',style:'padding: 5px; text-align:center;'},{style:'padding: 0px 0px 10px 0px;'}]}]}]},{classes:'row-fluid',components:[{tag:'ul',classes:'unstyled',style:'display:block',components:[{tag:'li',classes:'selected',components:[{kind:'OB.OBPOSCashUp.UI.ppc_salesTable',name:'sales'},{kind:'OB.OBPOSCashUp.UI.ppc_returnsTable',name:'returns'},{kind:'OB.OBPOSCashUp.UI.ppc_totalTransactionsTable',name:'totaltransactions'}]}]},{style:'border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); padding-top: 15px; padding-right: 15px; padding-bottom: 15px; padding-left: 15px; font-weight: bold; color: rgb(204, 204, 204); display: none;'},{style:'display:none;'}]},{classes:'row-fluid',components:[{kind:'OB.OBPOSCashUp.UI.ppc_startingsTable',name:'startingsTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashDropsTable',name:'dropsTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashDepositsTable',name:'depositsTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashExpectedTable',name:'expectedTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashCountedTable',name:'countedTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashDifferenceTable',name:'differenceTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashQtyToKeepTable',name:'qtyToKeepTable'},{kind:'OB.OBPOSCashUp.UI.ppc_cashQtyToDepoTable',name:'qtyToDepoTable'}]},{classes:'row-fluid',components:[{classes:'span12',components:[{style:'width: 10%; float: left',components:[{tag:'span',allowHtml:true,content:'&nbsp;'}]},{style:'padding: 5px 0px 0px 5px; float: left; width: 60%; font-weight:bold;'},{style:'clear:both;'}]}]}]}]}],create:function(){this.inherited(arguments);this.$.store.setContent(OB.I18N.getLabel('OBPOS_LblStore')+': '+OB.MobileApp.model.get('terminal').organization$_identifier);this.$.terminal.setContent(OB.I18N.getLabel('OBPOS_LblTerminal')+': '+OB.MobileApp.model.get('terminal')._identifier);this.$.user.setContent(OB.I18N.getLabel('OBPOS_LblUser')+': '+OB.MobileApp.model.get('context').user._identifier);this.$.time.setContent(OB.I18N.getLabel('OBPOS_LblTime')+': '+OB.I18N.formatDate(new Date())+' - '+OB.I18N.formatHour(new Date()));},init:function(model){this.model=model;this.$.reporttitle.setContent(OB.I18N.getLabel(model.reportTitleLabel)+OB.OBPOSCashUp.UI.CashUp.getTitleExtensions());this.model.get('cashUpReport').on('add',function(cashUpReport){this.$.sales.setValue('netsales',cashUpReport.get('netSales'));this.$.sales.setCollection(cashUpReport.get('salesTaxes'));this.$.sales.setValue('totalsales',cashUpReport.get('grossSales'));this.$.returns.setValue('netreturns',cashUpReport.get('netReturns'));this.$.returns.setCollection(cashUpReport.get('returnsTaxes'));this.$.returns.setValue('totalreturns',cashUpReport.get('grossReturns'));this.$.totaltransactions.setValue('totaltransactionsline',cashUpReport.get('totalRetailTransactions'));if(!OB.POS.modelterminal.get('terminal').ismaster){this.cashUpReportChanged(cashUpReport);}},this);this.model.on('change:time',function(){this.$.time.setContent(OB.I18N.getLabel('OBPOS_LblTime')+': '+OB.I18N.formatDate(this.model.get('time'))+' - '+OB.I18N.formatHour(this.model.get('time')));},this);},cashUpReportChanged:function(cashUpReport){this.$.startingsTable.setCollection(cashUpReport.get('startings'));this.$.startingsTable.setValue('totalstartings',cashUpReport.get('totalStartings'));this.$.dropsTable.setCollection(cashUpReport.get('drops'));this.$.dropsTable.setValue('totaldrops',cashUpReport.get('totalDrops'));this.$.depositsTable.setCollection(cashUpReport.get('deposits'));this.$.depositsTable.setValue('totaldeposits',cashUpReport.get('totalDeposits'));},summaryChanged:function(){this.$.expectedTable.setCollection(this.summary.expectedSummary);this.$.expectedTable.setValue('totalexpected',this.summary.totalExpected);if(OB.MobileApp.view.currentWindow==='retail.cashuppartial'){this.$.countedTable.hide();this.$.differenceTable.hide();this.$.qtyToKeepTable.hide();this.$.qtyToDepoTable.hide();}else{this.$.countedTable.setCollection(this.summary.countedSummary);this.$.countedTable.setValue('totalcounted',this.summary.totalCounted);this.$.differenceTable.setCollection(this.summary.differenceSummary);this.$.differenceTable.setValue('totaldifference',this.summary.totalDifference);this.$.qtyToKeepTable.setCollection(this.summary.qtyToKeepSummary);this.$.qtyToKeepTable.setValue('totalqtyToKeep',this.summary.totalQtyToKeep);this.$.qtyToDepoTable.setCollection(this.summary.qtyToDepoSummary);this.$.qtyToDepoTable.setValue('totalqtyToDepo',this.summary.totalQtyToDepo);}},modelChanged:function(){this.$.sales.setValue('netsales',this.model.get('netSales'));this.$.sales.setCollection(this.model.get('salesTaxes'));this.$.sales.setValue('totalsales',this.model.get('grossSales'));this.$.returns.setValue('netreturns',this.model.get('netReturns'));this.$.returns.setCollection(this.model.get('returnsTaxes'));this.$.returns.setValue('totalreturns',this.model.get('grossReturns'));this.$.totaltransactions.setValue('totaltransactionsline',this.model.get('totalRetailTransactions'));this.$.startingsTable.setCollection(this.model.get('startings'));this.$.startingsTable.setValue('totalstartings',this.model.get('totalStartings'));this.$.dropsTable.setCollection(this.model.get('drops'));this.$.dropsTable.setValue('totaldrops',this.model.get('totalDrops'));this.$.depositsTable.setCollection(this.model.get('deposits'));this.$.depositsTable.setValue('totaldeposits',this.model.get('totalDeposits'));this.model.on('change:time',function(){this.$.time.setContent(OB.I18N.getLabel('OBPOS_LblTime')+': '+OB.I18N.formatDate(this.model.get('time'))+' - '+OB.I18N.formatHour(this.model.get('time')));},this);},displayStep:function(model){this.$.reporttitle.renderHeader(model.stepNumber('OB.CashUp.PostPrintAndClose'),model.stepCount());if(!model.cashupStepsDefinition[model.stepIndex('OB.CashUp.CashToKeep')].active){_.each(model.get('paymentList').models,function(model){if(OB.UTIL.isNullOrUndefined(model.get('qtyToKeep'))){model.set('qtyToKeep',0);}},this);}
if(OB.POS.modelterminal.get('terminal').ismaster){if(OB.MobileApp.view.currentWindow==='retail.cashuppartial'){var me=this;var synchId=OB.UTIL.SynchronizationHelper.busyUntilFinishes("tabpostprintclose");new OB.DS.Process('org.openbravo.retail.posterminal.ProcessCashMgmtMaster').exec({cashUpId:OB.POS.modelterminal.get('terminal').cashUpId,terminalSlave:OB.POS.modelterminal.get('terminal').isslave},function(data){if(data&&!data.exception){me.owner.$.cashMaster.updateCashUpModel(model,data,function(){me.cashUpReportChanged(model.get('cashUpReport').at(0));OB.UTIL.SynchronizationHelper.finished(synchId,"tabpostprintclose");});}});}else{this.cashUpReportChanged(model.get('cashUpReport').at(0));}}
this.setSummary(model.getCountCashSummary());this.$.time.setContent(OB.I18N.getLabel('OBPOS_LblTime')+': '+OB.I18N.formatDate(new Date())+' - '+OB.I18N.formatHour(new Date()));}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.OBPOSCashUp.UI.modalPendingToProcess',i18nHeader:'OBPOS_LblReceiptsToProcess',bodyContent:{i18nContent:'OBPOS_MsgReceiptsProcess'},bodyButtons:{components:[{kind:'OB.OBPOSCashUp.UI.modalPendingToProcess_OkButton'},{kind:'OB.OBPOSCashUp.UI.modalPendingToProcess_CancelButton'}]}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSCashUp.UI.modalPendingToProcess_OkButton',i18nContent:'OBMOBC_LblOk',isDefaultAction:true,tap:function(){this.doHideThisPopup();}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.OBPOSCashUp.UI.modalPendingToProcess_CancelButton',i18nContent:'OBMOBC_LblCancel',tap:function(){this.doHideThisPopup();OB.POS.navigate('retail.pointofsale');}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.Modals.btnModalApprovalReasonAccept',i18nContent:'OBMOBC_LblOk',tap:function(){this.model.set('approvals',{supervisor:this.owner.owner.args.supervisor,message:this.owner.owner.args.message,approvalReason:this.owner.owner.$.bodyContent.$.approvalReason.getValue()});this.owner.owner.args.callback();this.doHideThisPopup();},init:function(model){this.model=model;}});enyo.kind({kind:'OB.UI.List',name:'OB.UI.ModalApprovalReasonList',classes:'combo',style:'width: 80%',renderLine:enyo.kind({kind:'enyo.Option',initComponents:function(){this.inherited(arguments);this.setValue(this.model.get('id'));this.setContent(this.model.get('name'));}}),renderEmpty:'enyo.Control',initComponents:function(){this.setCollection(new Backbone.Collection());}});enyo.kind({kind:'OB.UI.ModalAction',name:'OB.UI.ModalApprovalReason',closeOnEscKey:false,autoDismiss:false,bodyContent:{components:[{name:'labelApprovalReason',style:'text-align: right; padding-right:10px; width: 50%; height: 40px; float: left;'},{style:'width: 45%; float: left;',kind:'OB.UI.ModalApprovalReasonList',name:'approvalReason'}]},i18nHeader:'OBPOS_ApprovalReason',bodyButtons:{components:[{kind:'OB.UI.Modals.btnModalApprovalReasonAccept'}]},events:{onApprovalReason:''},initComponents:function(){this.inherited(arguments);this.$.headerCloseButton.hide();this.$.bodyContent.$.labelApprovalReason.setContent(OB.I18N.getLabel('OBPOS_lblApprovalReason'));var me=this,approvalReasonCollection=[];_.each(OB.POS.modelterminal.get('approvalReason'),function(reason){approvalReasonCollection.push(new Backbone.Model({id:reason.id,name:reason.name}));});me.$.bodyContent.$.approvalReason.getCollection().reset(approvalReasonCollection);}});OB.UI.WindowView.registerPopup('OB.OBPOSCashUp.UI.CashUp',{kind:'OB.UI.ModalApprovalReason',name:'OBPOS_modalApprovalReason'});(function(){OB.Model=window.OB.Model||{};OB.Collection=window.OB.Collection||{};OB.Model.PaymentMethod=Backbone.Model.extend({defaults:{id:null,name:null,expected:OB.DEC.Zero,counted:OB.DEC.Zero}});OB.Collection.PaymentMethodList=Backbone.Collection.extend({model:OB.Model.PaymentMethod,serializeToJSON:function(){var jsonpayment=this.toJSON();delete jsonpayment.undo;_.forEach(jsonpayment,function(item){item.difference=item.counted-item.expected;item.paymentTypeId=item.id;delete item.id;delete item.name;delete item.counted;delete item._id;});return jsonpayment;}});OB.Model.DayCash=Backbone.Model.extend({defaults:{totalExpected:OB.DEC.Zero,totalCounted:OB.DEC.Zero,totalDifference:OB.DEC.Zero,step:0,allowedStep:0},initialize:function(){this.set('paymentmethods',new OB.Model.PaymentMethodList());}});}());OB=window.OB||{};OB.Utilities=window.OB.Utilities||{};OB.Utilities.Number={};OB.Utilities.Number.roundJSNumber=function(num,dec){var strNum;if(isNaN(num)){return NaN;}
strNum=((typeof num==='string')?num:String(num));return parseFloat(new BigDecimal(strNum).setScale(dec,BigDecimal.prototype.ROUND_HALF_UP));};OB.Utilities.Number.OBMaskedToOBPlain=function(number,decSeparator,groupSeparator){number=number.toString();var plainNumber=number,decimalNotation=(number.indexOf('E')===-1&&number.indexOf('e')===-1);if(groupSeparator){var groupRegExp=new RegExp('\\'+groupSeparator,'g');plainNumber=plainNumber.replace(groupRegExp,'');}
if(!decimalNotation){plainNumber=OB.Utilities.Number.ScientificToDecimal(number,decSeparator);}
var numberSign='';if(plainNumber.substring(0,1)==='+'){numberSign='';plainNumber=plainNumber.substring(1,plainNumber.length);}else if(plainNumber.substring(0,1)==='-'){numberSign='-';plainNumber=plainNumber.substring(1,plainNumber.length);}
if(plainNumber.indexOf(decSeparator)!==-1){while(plainNumber.substring(plainNumber.length-1,plainNumber.length)==='0'){plainNumber=plainNumber.substring(0,plainNumber.length-1);}}
while(plainNumber.substring(0,1)==='0'&&plainNumber.substring(1,2)!==decSeparator&&plainNumber.length>1){plainNumber=plainNumber.substring(1,plainNumber.length);}
if(plainNumber.substring(plainNumber.length-1,plainNumber.length)===decSeparator){plainNumber=plainNumber.substring(0,plainNumber.length-1);}
if(plainNumber!=='0'){plainNumber=numberSign+plainNumber;}
return plainNumber;};OB.Utilities.Number.OBPlainToOBMasked=function(number,maskNumeric,decSeparator,groupSeparator,groupInterval){if(number===''||number===null||number===undefined){return number;}
if(groupInterval===null||groupInterval===undefined){groupInterval=OB.Format.defaultGroupingSize;}
if(maskNumeric.indexOf('+')===0||maskNumeric.indexOf('-')===0){maskNumeric=maskNumeric.substring(1,maskNumeric.length);}
if(groupSeparator&&maskNumeric.indexOf(groupSeparator)!==-1&&maskNumeric.indexOf(decSeparator)!==-1&&maskNumeric.indexOf(groupSeparator)>maskNumeric.indexOf(decSeparator)){var fixRegExp=new RegExp('\\'+groupSeparator,'g');maskNumeric=maskNumeric.replace(fixRegExp,'');}
var maskLength=maskNumeric.length;var decMaskPosition=maskNumeric.indexOf(decSeparator);if(decMaskPosition===-1){decMaskPosition=maskLength;}
var intMask=maskNumeric.substring(0,decMaskPosition);var decMask=maskNumeric.substring(decMaskPosition+1,maskLength);if((groupSeparator&&decMask.indexOf(groupSeparator)!==-1)||decMask.indexOf(decSeparator)!==-1){if(groupSeparator){var fixRegExp_1=new RegExp('\\'+groupSeparator,'g');decMask=decMask.replace(fixRegExp_1,'');}
var fixRegExp_2=new RegExp('\\'+decSeparator,'g');decMask=decMask.replace(fixRegExp_2,'');}
number=number.toString();number=OB.Utilities.Number.OBMaskedToOBPlain(number,decSeparator,groupSeparator);var numberSign='';if(number.substring(0,1)==='+'){numberSign='';number=number.substring(1,number.length);}else if(number.substring(0,1)==='-'){numberSign='-';number=number.substring(1,number.length);}
var formattedNumber='';var numberLength=number.length;var decPosition=number.indexOf(decSeparator);if(decPosition===-1){decPosition=numberLength;}
var intNumber=number.substring(0,decPosition);var decNumber=number.substring(decPosition+1,numberLength);if(decNumber.length>decMask.length){decNumber='0.'+decNumber;decNumber=OB.Utilities.Number.roundJSNumber(decNumber,decMask.length);decNumber=decNumber.toString();if(decNumber.indexOf('e')!==-1||decNumber.indexOf('E')!==-1){decNumber=OB.Utilities.Number.ScientificToDecimal(decNumber,decSeparator);}
if(decNumber.substring(0,1)==='1'){intNumber=parseFloat(intNumber);intNumber=intNumber+1;intNumber=intNumber.toString();}
decNumber=decNumber.substring(2,decNumber.length);}
if(decNumber.length<decMask.length){var decNumber_temp='',decMaskLength=decMask.length,i;for(i=0;i<decMaskLength;i++){if(decMask.substring(i,i+1)==='#'){if(decNumber.substring(i,i+1)!==''){decNumber_temp=decNumber_temp+decNumber.substring(i,i+1);}}else if(decMask.substring(i,i+1)==='0'){if(decNumber.substring(i,i+1)!==''){decNumber_temp=decNumber_temp+decNumber.substring(i,i+1);}else{decNumber_temp=decNumber_temp+'0';}}}
decNumber=decNumber_temp;}
var isGroup=false;if(groupSeparator){if(intMask.indexOf(groupSeparator)!==-1){isGroup=true;}
var groupRegExp=new RegExp('\\'+groupSeparator,'g');intMask=intMask.replace(groupRegExp,'');}
var intNumber_temp;if(intNumber.length<intMask.length){intNumber_temp='';var diff=intMask.length-intNumber.length,j;for(j=intMask.length;j>0;j--){if(intMask.substring(j-1,j)==='#'){if(intNumber.substring(j-1-diff,j-diff)!==''){intNumber_temp=intNumber.substring(j-1-diff,j-diff)+intNumber_temp;}}else if(intMask.substring(j-1,j)==='0'){if(intNumber.substring(j-1-diff,j-diff)!==''){intNumber_temp=intNumber.substring(j-1-diff,j-diff)+intNumber_temp;}else{intNumber_temp='0'+intNumber_temp;}}}
intNumber=intNumber_temp;}
if(isGroup===true){intNumber_temp='';var groupCounter=0,k;for(k=intNumber.length;k>0;k--){intNumber_temp=intNumber.substring(k-1,k)+intNumber_temp;groupCounter++;if(groupCounter.toString()===groupInterval.toString()&&k!==1){groupCounter=0;intNumber_temp=groupSeparator+intNumber_temp;}}
intNumber=intNumber_temp;}
if(intNumber===''&&decNumber!==''){intNumber='0';}
formattedNumber=numberSign+intNumber;if(decNumber!==''){formattedNumber+=decSeparator+decNumber;}
return formattedNumber;};OB.Utilities.Number.OBMaskedToJS=function(numberStr,decSeparator,groupSeparator){if(!numberStr||numberStr.trim()===''){return null;}
var calcNumber=OB.Utilities.Number.OBMaskedToOBPlain(numberStr,decSeparator,groupSeparator);calcNumber=calcNumber.replace(decSeparator,'.');var numberResult=parseFloat(calcNumber);if(isNaN(numberResult)){return numberStr;}
return numberResult;};OB.Utilities.Number.JSToOBMasked=function(number,maskNumeric,decSeparator,groupSeparator,groupInterval){var isANumber=Object.prototype.toString.call(number)==='[object Number]';if(!isANumber){return number;}
var formattedNumber=number;formattedNumber=formattedNumber.toString();formattedNumber=formattedNumber.replace('.',decSeparator);formattedNumber=OB.Utilities.Number.OBPlainToOBMasked(formattedNumber,maskNumeric,decSeparator,groupSeparator,groupInterval);return formattedNumber;};OB.Utilities.Number.IsValidValueString=function(type,numberStr){var maskNumeric=type.maskNumeric;if(!numberStr){return true;}
var bolNegative=true;if(maskNumeric.indexOf('+')===0){bolNegative=false;maskNumeric=maskNumeric.substring(1,maskNumeric.length);}
var bolDecimal=true;if(maskNumeric.indexOf(type.decSeparator)===-1){bolDecimal=false;}
var checkPattern='';checkPattern+='^';if(bolNegative){checkPattern+='([+]|[-])?';}
checkPattern+='(\\d+)?((\\'+type.groupSeparator+'\\d{'+OB.Format.defaultGroupingSize+'})?)+';if(bolDecimal){checkPattern+='(\\'+type.decSeparator+'\\d+)?';}
checkPattern+='$';var checkRegExp=new RegExp(checkPattern);if(numberStr.match(checkRegExp)&&numberStr.substring(0,1)!==type.groupSeparator){return true;}
return false;};OB.Utilities.Number.Grouping={getGroupingModes:function(){return this.groupingModes;},groupingModes:{byDecimal10:OB.I18N.getLabel('OBUIAPP_GroupByDecimal10'),by1:OB.I18N.getLabel('OBUIAPP_GroupBy1'),by10:OB.I18N.getLabel('OBUIAPP_GroupBy10'),by100:OB.I18N.getLabel('OBUIAPP_GroupBy100'),by1000:OB.I18N.getLabel('OBUIAPP_GroupBy1000'),by10000:OB.I18N.getLabel('OBUIAPP_GroupBy10000'),by100000:OB.I18N.getLabel('OBUIAPP_GroupBy100000')},defaultGroupingMode:'by10',groupingMode:'by10',getGroupingMultiplier:function(groupingMode){switch(groupingMode){case'byDecimal10':return 0.1;case'by1':return 1;case'by10':return 10;case'by100':return 100;case'by1000':return 1000;case'by10000':return 10000;case'by100000':return 100000;}
return 10;},getGroupValue:function(value,record,field,fieldName,grid){var returnValue,groupingMode=(field.groupingMode||OB.Utilities.Number.Grouping.defaultGroupingMode),multiplier=this.getGroupingMultiplier(groupingMode);if(!isc.isA.Number(value)||!groupingMode){return value;}
returnValue=value/multiplier;returnValue=Math.round(returnValue-0.49);returnValue=returnValue*multiplier;return returnValue;},getGroupTitle:function(value,record,field,fieldName,grid){var groupValue=this.getGroupValue(value,record,field,fieldName,grid),groupingMode=(field.groupingMode||OB.Utilities.Number.Grouping.defaultGroupingMode),multiplier=this.getGroupingMultiplier(groupingMode);return groupValue+' - '+(groupValue+multiplier);}};OB.Utilities.Number.ScientificToDecimal=function(number,decSeparator){number=number.toString();number=number.replace(/^0+/,'');var coeficient,exponent,numberOfZeros,zeros='',i,split,index,sign;if(number.indexOf('e')!==-1){index=number.indexOf('e');}else if(number.indexOf('E')!==-1){index=number.indexOf('E');}else{return number;}
coeficient=number.substring(0,index);exponent=number.substring(index+1,number.length);if(coeficient.indexOf(decSeparator)!==-1){split=coeficient.split(decSeparator);coeficient=split[0]+split[1];}
if(exponent.indexOf('-')!==-1){numberOfZeros=exponent.substring(1,exponent.length);for(i=1;i<numberOfZeros;i++){zeros=zeros+'0';}
if(coeficient.substring(0,1)==='-'){sign='-';coeficient=coeficient.substring(1,coeficient.length);number=sign+'0.'+zeros+coeficient;}else{number='0.'+zeros+coeficient;}}else{numberOfZeros=exponent.indexOf('+')!==-1?exponent.substring(1,exponent.length):exponent;if(split){numberOfZeros=numberOfZeros-split[1].length;}
if(numberOfZeros>=0){for(i=0;i<numberOfZeros;i++){zeros=zeros+'0';}
number=coeficient+zeros;}else{number=coeficient.substr(0,coeficient.length+numberOfZeros)+'.'+coeficient.substr(coeficient.length+numberOfZeros);}}
return number;};OB=window.OB||{};OB.Utilities=window.OB.Utilities||{};OB.Utilities.Date={};OB.Utilities.Date.centuryReference=50;OB.Utilities.Date.normalizeDisplayFormat=function(displayFormat){var newFormat='';displayFormat=displayFormat.replace('mm','MM').replace('dd','DD').replace('yyyy','YYYY').replace('yy','YY');displayFormat=displayFormat.replace('%D','%d').replace('%M','%m');if(displayFormat!==null&&displayFormat!==''){newFormat=displayFormat;newFormat=newFormat.replace('YYYY','%Y');newFormat=newFormat.replace('YY','%y');newFormat=newFormat.replace('MM','%m');newFormat=newFormat.replace('DD','%d');newFormat=newFormat.substring(0,8);}
displayFormat=displayFormat.replace('hh','HH').replace('HH24','HH').replace('mi','MI').replace('ss','SS');displayFormat=displayFormat.replace('%H','HH').replace('HH:%m','HH:MI').replace('HH.%m','HH.MI').replace('%S','SS');displayFormat=displayFormat.replace('HH:mm','HH:MI').replace('HH.mm','HH.MI');displayFormat=displayFormat.replace('HH:MM','HH:MI').replace('HH.MM','HH.MI');if(displayFormat.indexOf(' HH:MI:SS')!==-1){newFormat+=' %H:%M:%S';}else if(displayFormat.indexOf(' HH:MI')!==-1){newFormat+=' %H:%M';}else if(displayFormat.indexOf(' HH.MI.SS')!==-1){newFormat+=' %H.%M.%S';}else if(displayFormat.indexOf(' HH.MI')!==-1){newFormat+=' %H.%M';}
if(displayFormat.indexOf(' a')!==-1){newFormat+=' A';}
return newFormat;};OB.Utilities.getTimeFormatDefinition=function(){var timeFormat,is24h=true;if(OB.Format.dateTime.indexOf(' ')===-1){return'to24HourTime';}
timeFormat=OB.Format.dateTime.substring(OB.Format.dateTime.indexOf(' ')+1);if(timeFormat&&timeFormat.toUpperCase().lastIndexOf(' A')!==-1&&timeFormat.toUpperCase().lastIndexOf(' A')===timeFormat.length-2){is24h=false;}
if(timeFormat.toLowerCase().contains('ss')){return{timeFormat:timeFormat,is24h:is24h,timeFormatter:is24h?'to24HourTime':'toTime'};}
return{timeFormat:timeFormat,is24h:is24h,timeFormatter:is24h?'toShort24HourTime':'toShortTime'};};OB.Utilities.Date.OBToJS=function(OBDate,dateFormat){if(!OBDate){return null;}
var isADate=Object.prototype.toString.call(OBDate)==='[object Date]',PMIndicator=' PM',AMIndicator=' AM',is24h=true,isPM=false;if(isADate){return OBDate;}
if(window.isc&&isc.Time&&isc.Time.PMIndicator){PMIndicator=isc.Time.PMIndicator;}
if(window.isc&&isc.Time&&isc.Time.AMIndicator){AMIndicator=isc.Time.AMIndicator;}
dateFormat=OB.Utilities.Date.normalizeDisplayFormat(dateFormat);dateFormat=dateFormat.replace(' A','');var dateSeparator=dateFormat.substring(2,3);var timeSeparator=dateFormat.substring(11,12);var isFullYear=(dateFormat.indexOf('%Y')!==-1);if(OBDate.indexOf(PMIndicator)!==-1||OBDate.indexOf(AMIndicator)!==-1){is24h=false;}
if(!is24h&&OBDate.indexOf(PMIndicator)!==-1){isPM=true;}
OBDate=OBDate.replace(AMIndicator,'').replace(PMIndicator,'');if((isFullYear?OBDate.length-2:OBDate.length)!==dateFormat.length){return null;}
if(isFullYear){dateFormat=dateFormat.replace('%Y','%YYY');}
if(dateFormat.indexOf('-')!==-1&&OBDate.indexOf('-')===-1){return null;}else if(dateFormat.indexOf('/')!==-1&&OBDate.indexOf('/')===-1){return null;}else if(dateFormat.indexOf(':')!==-1&&OBDate.indexOf(':')===-1){return null;}else if(dateFormat.indexOf('.')!==-1&&OBDate.indexOf('.')===-1){return null;}
var year=dateFormat.indexOf('%y')!==-1?OBDate.substring(dateFormat.indexOf('%y'),dateFormat.indexOf('%y')+2):0;var fullYear=dateFormat.indexOf('%Y')!==-1?OBDate.substring(dateFormat.indexOf('%Y'),dateFormat.indexOf('%Y')+4):0;var month=dateFormat.indexOf('%m')!==-1?OBDate.substring(dateFormat.indexOf('%m'),dateFormat.indexOf('%m')+2):0;var day=dateFormat.indexOf('%d')!==-1?OBDate.substring(dateFormat.indexOf('%d'),dateFormat.indexOf('%d')+2):0;var hours=dateFormat.indexOf('%H')!==-1?OBDate.substring(dateFormat.indexOf('%H'),dateFormat.indexOf('%H')+2):0;var minutes=dateFormat.indexOf('%M')!==-1?OBDate.substring(dateFormat.indexOf('%M'),dateFormat.indexOf('%M')+2):0;var seconds=dateFormat.indexOf('%S')!==-1?OBDate.substring(dateFormat.indexOf('%S'),dateFormat.indexOf('%S')+2):0;var digitRegExp=['^\\d+$','gm'];if((year&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(year)))||(fullYear&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(fullYear)))||(month&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(month)))||(day&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(day)))||(hours&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(hours)))||(minutes&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(minutes)))||(seconds&&!(new RegExp(digitRegExp[0],digitRegExp[1]).test(seconds)))){return null;}
month=parseInt(month,10);day=parseInt(day,10);hours=parseInt(hours,10);minutes=parseInt(minutes,10);seconds=parseInt(seconds,10);if(!is24h){if(!isPM&&hours===12){hours=0;}
if(isPM&&hours!==12){hours=hours+12;}}
if(day<1||day>31||month<1||month>12||year>99||fullYear>9999){return null;}
if(hours>23||minutes>59||seconds>59){return null;}
var JSDate=new Date();var centuryReference=OB.Utilities.Date.centuryReference;if(!isFullYear){if(parseInt(year,10)<centuryReference){fullYear='20'+year;}else{fullYear='19'+year;}}
fullYear=parseInt(fullYear,10);JSDate.setFullYear(fullYear,month-1,day);if(day!==JSDate.getDate()){return null;}
JSDate.setHours(hours);JSDate.setMinutes(minutes);JSDate.setSeconds(seconds);JSDate.setMilliseconds(0);if(JSDate.toString()==='Invalid Date'||JSDate.toString()==='NaN'){return null;}else{return JSDate;}};OB.Utilities.Date.JSToOB=function(JSDate,dateFormat){dateFormat=OB.Utilities.Date.normalizeDisplayFormat(dateFormat);var isADate=Object.prototype.toString.call(JSDate)==='[object Date]',PMIndicator=' PM',AMIndicator=' AM',is24h=true,isPM=false;if(!isADate){return null;}
if(window.isc&&isc.Time&&isc.Time.PMIndicator){PMIndicator=isc.Time.PMIndicator;}
if(window.isc&&isc.Time&&isc.Time.AMIndicator){AMIndicator=isc.Time.AMIndicator;}
if(dateFormat.toUpperCase().lastIndexOf(' A')!==-1&&dateFormat.toUpperCase().lastIndexOf(' A')===dateFormat.length-2){is24h=false;}
var year=JSDate.getYear().toString();var fullYear=JSDate.getFullYear().toString();var month=(JSDate.getMonth()+1).toString();var day=JSDate.getDate().toString();var hours=JSDate.getHours().toString();var minutes=JSDate.getMinutes().toString();var seconds=JSDate.getSeconds().toString();var centuryReference=OB.Utilities.Date.centuryReference;if(dateFormat.indexOf('%y')!==-1){if(parseInt(fullYear,10)>=1900+centuryReference&&parseInt(fullYear,10)<2100-centuryReference){if(parseInt(year,10)>=100){year=parseInt(year,10)-100;year=year.toString();}}else{return null;}}
if(!is24h){hours=parseInt(hours,10);if(hours>=12){isPM=true;}
if(hours>12){hours=hours-12;}
if(hours===0){hours=12;}
hours=hours.toString();}
while(year.length<2){year='0'+year;}
while(fullYear.length<4){fullYear='0'+fullYear;}
while(month.length<2){month='0'+month;}
while(day.length<2){day='0'+day;}
while(hours.length<2){hours='0'+hours;}
while(minutes.length<2){minutes='0'+minutes;}
while(seconds.length<2){seconds='0'+seconds;}
var OBDate=dateFormat;OBDate=OBDate.replace('%y',year);OBDate=OBDate.replace('%Y',fullYear);OBDate=OBDate.replace('%m',month);OBDate=OBDate.replace('%d',day);OBDate=OBDate.replace('%H',hours);OBDate=OBDate.replace('%M',minutes);OBDate=OBDate.replace('%S',seconds);if(!is24h){if(isPM){OBDate=OBDate.replace(' A',PMIndicator);}else{OBDate=OBDate.replace(' A',AMIndicator);}}
return OBDate;};OB.Utilities.Date.getTimeFields=function(allFields){var i,field,timeFields=[],length=allFields.length;for(i=0;i<length;i++){field=allFields[i];if(field.type==='_id_24'){timeFields.push(field);}}
return timeFields;};OB.Utilities.Date.convertUTCTimeToLocalTime=function(newData,allFields){var textField,fieldToDate,i,j,UTCOffsetInMiliseconds=OB.Utilities.Date.getUTCOffsetInMiliseconds(),timeFields=OB.Utilities.Date.getTimeFields(allFields),timeFieldsLength=timeFields.length,convertedData=isc.clone(newData),convertedDataLength=convertedData.length;for(i=0;i<timeFieldsLength;i++){for(j=0;j<convertedDataLength;j++){textField=convertedData[j][timeFields[i].name];if(!textField){continue;}
if(isc.isA.String(textField)){fieldToDate=isc.Time.parseInput(textField);}else if(isc.isA.Date(textField)){fieldToDate=textField;}
fieldToDate.setTime(fieldToDate.getTime()+UTCOffsetInMiliseconds);convertedData[j][timeFields[i].name]=fieldToDate.getHours()+':'+fieldToDate.getMinutes()+':'+fieldToDate.getSeconds();}}
return convertedData;};OB.Utilities.Date.addTimezoneOffset=function(date){var newDate,originalTimezoneOffset,newTimezoneOffset;if(Object.prototype.toString.call(date)!=='[object Date]'){return date;}
originalTimezoneOffset=date.getTimezoneOffset();newDate=new Date(date.getTime()+(originalTimezoneOffset*60000));newTimezoneOffset=newDate.getTimezoneOffset();if(originalTimezoneOffset!==newTimezoneOffset){newDate=new Date(newDate.getTime()+(newTimezoneOffset-originalTimezoneOffset)*60000);}
return newDate;};OB.Utilities.Date.substractTimezoneOffset=function(date){var newDate;if(Object.prototype.toString.call(date)!=='[object Date]'){return date;}
newDate=new Date(date.getTime()-(date.getTimezoneOffset()*60000));return newDate;};OB.Utilities.Date.getUTCOffsetInMiliseconds=function(){var UTCHourOffset=isc.Time.getUTCHoursDisplayOffset(new Date()),UTCMinuteOffset=isc.Time.getUTCMinutesDisplayOffset(new Date());return(UTCHourOffset*60*60*1000)+(UTCMinuteOffset*60*1000);};OB.Utilities.Date.roundToNextQuarter=function(date){var newDate=new Date(date),minutes=newDate.getMinutes(),timeBreak=15;if(newDate.getMilliseconds()===0&&newDate.getSeconds()===0&&minutes%timeBreak===0){return newDate;}
var roundedMinutes=(parseInt((minutes+timeBreak)/timeBreak,10)*timeBreak)%60;newDate.setMilliseconds(0);newDate.setSeconds(0);newDate.setMinutes(roundedMinutes);if(roundedMinutes===0){newDate.setHours(newDate.getHours()+1);}
return newDate;};OB.Utilities.Date.roundToNextHalfHour=function(date){var newDate=new Date(date),minutes=newDate.getMinutes(),timeBreak=30;if(newDate.getMilliseconds()===0&&newDate.getSeconds()===0&&minutes%timeBreak===0){return newDate;}
var roundedMinutes=(parseInt((minutes+timeBreak)/timeBreak,10)*timeBreak)%60;newDate.setMilliseconds(0);newDate.setSeconds(0);newDate.setMinutes(roundedMinutes);if(roundedMinutes===0){newDate.setHours(newDate.getHours()+1);}
return newDate;};OB.Utilities.Date.getDateSeparator=function(dateFormat){return dateFormat.toUpperCase().replace(/D/g,'').replace(/M/g,'').replace(/Y/g,'').substr(0,1);};enyo.kind({name:'OB.UI.MockPayment',components:[{components:[{classes:'row-fluid',components:[{style:'float:left; padding-left:30px',name:'lblType'},{name:'paymenttype',style:'float:right; font-weight: bold; padding-right:30px'}]},{style:'clear: both'},{classes:'row-fluid',components:[{style:'float:left; padding-left:30px',name:'lblAmount'},{name:'paymentamount',style:'float:right; font-weight: bold; padding-right:30px'}]}]},{style:'clear: both'},{kind:'OB.UI.MockPayment_OkButton'}],initComponents:function(){this.inherited(arguments);this.$.lblType.setContent(OB.I18N.getLabel('OBPOS_LblModalType'));this.$.lblAmount.setContent(OB.I18N.getLabel('OBPOS_LblModalAmount'));this.$.paymenttype.setContent(this.paymentType);this.$.paymentamount.setContent(OB.I18N.formatCurrency(this.paymentAmount));}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.MockPayment_OkButton',style:'float: right;',i18nContent:'OBMOBC_LblOk',isDefaultAction:true,tap:function(){this.owner.receipt.addPayment(new OB.Model.PaymentLine({'kind':this.owner.key,'name':this.owner.paymentType,'amount':this.owner.paymentAmount,'allowOpenDrawer':this.owner.allowOpenDrawer,'isCash':this.owner.isCash,'openDrawer':this.owner.openDrawer,'printtwice':this.owner.printtwice}));this.doHideThisPopup();}});(function(){var alreadyDefinedRules=(OB&&OB.Model&&OB.Model.Discounts&&OB.Model.Discounts.discountRules)||{},onLoadActions=(OB&&OB.Model&&OB.Model.Discounts&&OB.Model.Discounts.onLoadActions)||[],i;OB.Model.Discounts={discountRules:alreadyDefinedRules,executor:new OB.Model.DiscountsExecutor(),preventApplyPromotions:false,applyPromotionsTimeout:{},applyPromotions:function(receipt,line){var stack=OB.UTIL.getStackTrace('OB.Model.Discounts.applyPromotions',false);if(stack.indexOf('OB.Model.Discounts.applyPromotions')>-1&&stack.indexOf('Backbone.Model.extend.calculateReceipt')>-1){OB.error("It's forbidden to use applyPromotions from outside of calculateReceipt");}
if(!receipt.get('isBeingDiscounted')){receipt.set('isBeingDiscounted',true,{silent:true});this.executor.removeGroup('discounts');this.applyPromotionsLat(receipt,line);}else{receipt.set('reApplyDiscounts',true,{silent:true});}},finishPromotions:function(receipt,line){receipt.set('isBeingDiscounted',false,{silent:true});if(receipt.get('reApplyDiscounts')===true){receipt.set('reApplyDiscounts',false,{silent:true});OB.Model.Discounts.applyPromotions(receipt,line);}else{receipt.set('reApplyDiscounts',false,{silent:true});receipt.trigger('applyPromotionsFinished');}},applyPromotionsLat:function(receipt,line){var me=this;if(receipt.get('skipApplyPromotions')||receipt.get('cloningReceipt')||this.preventApplyPromotions){OB.Model.Discounts.finishPromotions(receipt,line);return;}
var auxReceipt=new OB.Model.Order(),auxLine,hasPromotions,oldLines,oldLines2,actualLines,auxReceipt2,isFirstExecution=true;OB.UTIL.clone(receipt,auxReceipt);auxReceipt.groupLinesByProduct();me.auxReceiptInExecution=auxReceipt;auxReceipt.on('discountsApplied',function(){if(me.auxReceiptInExecution!==auxReceipt){return;}
var continueApplyPromotions=true;auxReceipt.removePromotionsCascadeApplied();if(!OB.UTIL.isNullOrUndefined(oldLines)&&oldLines.size()>0){isFirstExecution=false;oldLines2=new Backbone.Collection();oldLines.forEach(function(ol){oldLines2.push(ol);});oldLines2.forEach(function(ol){for(i=0;i<auxReceipt.get('lines').size();i++){if(auxReceipt.isSimilarLine(ol,auxReceipt.get('lines').at(i))){oldLines.remove(ol);}}});if(oldLines.length===0){continueApplyPromotions=false;}}else if(!OB.UTIL.isNullOrUndefined(oldLines)&&oldLines.size()===0&&!isFirstExecution){continueApplyPromotions=false;}
if(continueApplyPromotions){receipt.fillPromotionsWith(auxReceipt,isFirstExecution);if(auxReceipt.hasPromotions()){auxReceipt.removeQtyOffer();if(auxReceipt.get('lines').length>0){oldLines=new Backbone.Collection();auxReceipt.get('lines').forEach(function(l){var clonedLine=l.clone();clonedLine.set('promotions',_.clone(clonedLine.get('promotions')));oldLines.push(clonedLine);});me.applyPromotionsImp(auxReceipt,undefined,true);}else{OB.Model.Discounts.finishPromotions(receipt,line);}}else{OB.Model.Discounts.finishPromotions(receipt,line);}}else{OB.Model.Discounts.finishPromotions(receipt,line);}});if(line){auxLine=_.filter(auxReceipt.get('lines').models,function(l){if(l!==line&&l.get('product').id===line.get('product').id&&l.get('price')===line.get('price')&&l.get('qty')===line.get('qty')){return l;}});}
if(!this.preventApplyPromotions){var manualPromotions;_.each(auxReceipt.get('lines').models,function(line){manualPromotions=_.filter(line.get('promotions'),function(p){return p.manual===true;})||[];line.set('promotions',[]);line.set('promotionCandidates',[]);_.forEach(manualPromotions,function(promo){var promotion={rule:new Backbone.Model(promo),definition:{userAmt:promo.userAmt,applyNext:promo.applyNext,lastApplied:promo.lastApplied},alreadyCalculated:true};OB.Model.Discounts.addManualPromotion(auxReceipt,[line],promotion);});});_.each(receipt.get('lines').models,function(line){if((line.get('gross')>0&&line.get('priceIncludesTax'))||(line.get('net')>0&&!line.get('priceIncludesTax'))){line.set('promotions',[]);line.set('promotionCandidates',[]);}});}
this.applyPromotionsImp(auxReceipt,null,true);},applyPromotionsImp:function(receipt,line,skipSave,avoidTrigger){var lines;if(this.preventApplyPromotions){return;}
if(receipt&&(!receipt.get('isEditable')||(!OB.UTIL.isNullOrUndefined(receipt.get('isNewReceipt'))&&receipt.get('isNewReceipt')))){receipt.trigger('discountsApplied');}
if(line){this.executor.addEvent(new Backbone.Model({id:line.cid,groupId:'discounts',receipt:receipt,line:line,skipSave:skipSave,avoidTrigger:avoidTrigger}),true);}else{lines=_.sortBy(receipt.get('lines').models,function(lo){return-lo.getQty();});if(lines.length===0){receipt.trigger('discountsApplied');}
lines.forEach(function(l){this.applyPromotionsImp(receipt,l,true,true);},this);this.executor.nextEvent();}},addManualPromotion:function(receipt,lines,promotion){var rule=OB.Model.Discounts.discountRules[promotion.rule.get?promotion.rule.get('discountType'):promotion.rule.discountType];if(!rule||!rule.addManual){OB.warn('No manual implemetation for rule '+promotion.discountType);return;}
lines.forEach(function(line){if(line.get('promotions')){line.get('promotions').forEach(function(promotion){promotion.lastApplied=undefined;});}
line.unset('noDiscountCandidates',{silent:true});rule.addManual(receipt,line,promotion);});if(!promotion.alreadyCalculated){receipt.calculateReceipt();}},getManualPromotions:function(asList){var p,promos=[],promosSql='';for(p in this.discountRules){if(this.discountRules.hasOwnProperty(p)){if(this.discountRules[p].addManual){promos.push(p);}}}
if(asList){return promos;}else{for(p=0;p<promos.length;p++){if(promosSql!==''){promosSql+=', ';}
promosSql+="'"+promos[p]+"'";}
return promosSql;}},registerRule:function(name,rule){this.discountRules[name]=rule;},standardFilter:"WHERE date(?) BETWEEN DATEFROM AND COALESCE(date(DATETO), date('9999-12-31'))"
+" AND((BPARTNER_SELECTION = 'Y'"
+" AND NOT EXISTS"
+" (SELECT 1"
+" FROM M_OFFER_BPARTNER"
+" WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND C_BPARTNER_ID = ?"
+" ))"
+" OR(BPARTNER_SELECTION = 'N'"
+" AND EXISTS"
+" (SELECT 1"
+" FROM M_OFFER_BPARTNER"
+" WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND C_BPARTNER_ID = ?"
+" )))"
+" AND((BP_GROUP_SELECTION = 'Y'"
+" AND NOT EXISTS"
+" (SELECT 1"
+" FROM C_BPARTNER B,"
+"   M_OFFER_BP_GROUP OB"
+" WHERE OB.M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND B.C_BPARTNER_ID = ?"
+"   AND OB.C_BP_GROUP_ID = B.C_BP_GROUP_ID"
+" ))"
+" OR(BP_GROUP_SELECTION = 'N'"
+" AND EXISTS"
+" (SELECT 1"
+" FROM C_BPARTNER B,"
+"   M_OFFER_BP_GROUP OB"
+" WHERE OB.M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND B.C_BPARTNER_ID = ?"
+"   AND OB.C_BP_GROUP_ID = B.C_BP_GROUP_ID"
+" )))"
+" AND((PRODUCT_SELECTION = 'Y'"
+" AND NOT EXISTS"
+" (SELECT 1"
+" FROM M_OFFER_PRODUCT"
+" WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND M_PRODUCT_ID = ?"
+" ))"
+" OR(PRODUCT_SELECTION = 'N'"
+" AND EXISTS"
+" (SELECT 1"
+" FROM M_OFFER_PRODUCT"
+" WHERE M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND M_PRODUCT_ID = ?"
+" )))"
+" AND((PROD_CAT_SELECTION = 'Y'"
+" AND NOT EXISTS"
+" (SELECT 1"
+" FROM M_PRODUCT P,"
+"   M_OFFER_PROD_CAT OP"
+" WHERE OP.M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND P.M_PRODUCT_ID = ?"
+"   AND OP.M_PRODUCT_CATEGORY_ID = P.M_PRODUCT_CATEGORY_ID"
+" ))"
+" OR(PROD_CAT_SELECTION = 'N'"
+" AND EXISTS"
+" (SELECT 1"
+" FROM M_PRODUCT P,"
+"   M_OFFER_PROD_CAT OP"
+" WHERE OP.M_OFFER_ID = M_OFFER.M_OFFER_ID"
+"   AND P.M_PRODUCT_ID = ?"
+"   AND OP.M_PRODUCT_CATEGORY_ID = P.M_PRODUCT_CATEGORY_ID"
+" ))) "
+" AND ((CHARACTERISTICS_SELECTION = 'Y'"+" AND NOT EXISTS"+" (SELECT 1"+"  FROM M_OFFER_CHARACTERISTIC C, M_PRODUCT_CH_VALUE V"+"  WHERE C.M_OFFER_ID = M_OFFER.M_OFFER_ID"+"    AND V.M_PRODUCT_ID = ?"+"    AND V.M_CH_VALUE_ID = C.M_CH_VALUE_ID"+" ))"+" OR(CHARACTERISTICS_SELECTION = 'N'"+" AND EXISTS"+" (SELECT 1"+"  FROM M_OFFER_CHARACTERISTIC C, M_PRODUCT_CH_VALUE V"+"  WHERE C.M_OFFER_ID = M_OFFER.M_OFFER_ID"+"    AND V.M_PRODUCT_ID = ?"+"    AND V.M_CH_VALUE_ID = C.M_CH_VALUE_ID"+" ))"+" )"+" AND ((pricelist_selection = 'Y' AND NOT EXISTS"
+"   (SELECT 1 FROM m_offer_pricelist opl WHERE m_offer.m_offer_id = opl.m_offer_id AND opl.m_pricelist_id = ? )) "
+" OR (pricelist_selection = 'N' AND EXISTS"
+"   (SELECT 1 FROM m_offer_pricelist opl WHERE m_offer.m_offer_id = opl.m_offer_id AND opl.m_pricelist_id = ? )))",additionalFilters:[],computeStandardFilter:function(receipt){var filter=OB.Model.Discounts.standardFilter;var i,additionalFilter;for(i=0;i<OB.Model.Discounts.additionalFilters.length;i++){additionalFilter=OB.Model.Discounts.additionalFilters[i];if(additionalFilter.generateFilter){filter+=additionalFilter.generateFilter(receipt);}}
return filter;}};OB.Model.Discounts.registerRule('5D4BAF6BB86D4D2C9ED3D5A6FC051579',{async:false,implementation:function(discountRule,receipt,line){var linePrice,discountedLinePrice,qty=line.get('qty'),minQty=discountRule.get('minQuantity'),maxQty=discountRule.get('maxQuantity');if((minQty&&qty<minQty)||(maxQty&&qty>maxQty)){return;}
linePrice=line.get('discountedLinePrice')||line.get('price');if(discountRule.get('fixedPrice')||discountRule.get('fixedPrice')===0){discountedLinePrice=discountRule.get('fixedPrice');}else{discountedLinePrice=(linePrice-discountRule.get('discountAmount'))*(1-discountRule.get('discount')/100);}
discountRule.set('qtyOffer',qty);receipt.addPromotion(line,discountRule,{amt:OB.DEC.toNumber((linePrice-(new BigDecimal(String(discountedLinePrice))))*qty)});line.set('discountedLinePrice',discountedLinePrice);}});if(OB&&OB.Model&&OB.Model.Discounts&&OB.Model.Discounts.extraModels){for(i=0;i<OB.Model.Discounts.extraModels.length;i++){OB.Data.Registry.registerModel(OB.Model.Discounts.extraModels[i]);}}
for(i=0;i<onLoadActions.length;i++){if(onLoadActions[i].execute){onLoadActions[i].execute();}}}());OB.UTIL.HookManager.registerHook('OBMOBC_PreWindowOpen',function(args,callbacks){var context=args.context,windows=args.windows,errorFunc=function(){OB.error(arguments);},window;window=_.filter(windows,function(wind){return wind.route===context.route;});OB.UTIL.Approval.requestApproval(context.model,window[0].approvalType,function(approved,supervisor,approvalType){if(approved){args.cancellation=false;}else{args.cancellation=true;}
OB.UTIL.HookManager.callbackExecutor(args,callbacks);});});OB.UTIL.HookManager.registerHook('OBPOS_PreDeleteLine',function(args,c){enyo.$.scrim.show();args.order.get('lines').forEach(function(line,idx){line.set('undoPosition',idx);});OB.UTIL.HookManager.callbackExecutor(args,c);});(function(){enyo.kind({name:'OBRETUR.UI.MenuReturn',kind:'OB.UI.MenuAction',permission:'OBRETUR_Return',i18nLabel:'OBRETUR_LblReturn',events:{onPaidReceipts:''},tap:function(){if(this.disabled){return true;}
if(this.model.get('order').get('isEditable')===false){this.setDisabled(true);return;}
this.inherited(arguments);if(!OB.MobileApp.model.get('connectedToERP')){OB.UTIL.showError(OB.I18N.getLabel('OBPOS_OfflineWindowRequiresOnline'));return;}
if(OB.MobileApp.model.hasPermission(this.permission)){this.doPaidReceipts({isQuotation:false,isReturn:true});}},updateVisibility:function(){var me=this;if(this.receipt.get('isEditable')===false){me.setDisabled(true);return;}else{me.setDisabled(false);return;}},init:function(model){var me=this;this.model=model;this.receipt=model.get('order');this.receipt.on('change:isEditable',function(){this.updateVisibility();},this);}});OB.OBPOSPointOfSale.UI.LeftToolbarImpl.prototype.menuEntries.push({kind:'OBRETUR.UI.MenuReturn'});}());(function(){enyo.kind({name:'OB.UI.CheckboxButtonAll',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check span1',style:'width: 8%',events:{onCheckedAll:''},handlers:{onAllSelected:'allSelected'},allSelected:function(inSender,inEvent){if(inEvent.allSelected){this.check();}else{this.unCheck();}
return true;},tap:function(){this.inherited(arguments);this.doCheckedAll({checked:this.checked});}});enyo.kind({name:'OB.UI.CheckboxButtonReturn',kind:'OB.UI.CheckboxButton',classes:'modal-dialog-btn-check span1',style:'width: 8%',handlers:{onCheckAll:'checkAll'},events:{onLineSelected:''},isGiftCard:false,checkAll:function(inSender,inEvent){if(this.isGiftCard){return;}
if(inEvent.checked&&this.parent.$.quantity.value>0&&!this.parent.newAttribute.notReturnable){this.check();}else{this.unCheck();}
if(this.parent.$.quantity.value!==0){this.parent.$.quantity.setDisabled(!inEvent.checked);this.parent.$.qtyplus.setDisabled(!inEvent.checked);this.parent.$.qtyminus.setDisabled(!inEvent.checked);}
if(this.parent.newAttribute.productType==='S'){this.parent.$.quantity.setDisabled(true);this.parent.$.qtyplus.setDisabled(true);this.parent.$.qtyminus.setDisabled(true);}},tap:function(){if(this.isGiftCard||this.parent.$.quantity.value===0){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_LineCanNotBeSelected'));return;}
this.inherited(arguments);this.parent.$.quantity.setDisabled(!this.checked);this.parent.$.qtyplus.setDisabled(!this.checked);this.parent.$.qtyminus.setDisabled(!this.checked);if(this.checked){this.parent.$.quantity.focus();}
this.doLineSelected({selected:this.checked});if(this.parent.newAttribute.productType==='S'){this.parent.$.quantity.setDisabled(true);this.parent.$.qtyplus.setDisabled(true);this.parent.$.qtyminus.setDisabled(true);}}});enyo.kind({name:'OB.UI.EditOrderLine',style:'border-bottom: 1px solid #cccccc; text-align: center; color: black; padding-top: 9px;',handlers:{onApplyChange:'applyChange'},events:{onCorrectQty:''},isGiftCard:false,applyChange:function(inSender,inEvent){var me=this;var model=inEvent.model;var index=inEvent.lines.indexOf(this.newAttribute);var line,promotionsfactor;if(index!==-1){if(this.$.checkboxButtonReturn.checked){var initialQty=inEvent.lines[index].quantity;var qty=this.$.quantity.getValue();var orderList=OB.MobileApp.model.orderList;enyo.forEach(orderList.models,function(order){enyo.forEach(order.get('lines').models,function(l){if(l.get('originalOrderLineId')){if(l.get('product').id===me.newAttribute.id&&l.get('originalOrderLineId')===me.newAttribute.lineId){qty=qty-l.get('qty');}}});});if(qty>inEvent.lines[index].remainingQuantity){OB.UTIL.showWarning(OB.I18N.getLabel('OBRETUR_ExceedsQuantity')+' '+me.newAttribute.name);inEvent.lines[index].exceedsQuantity=true;}
inEvent.lines[index].remainingQuantity=inEvent.lines[index].remainingQuantity-this.$.quantity.getValue();inEvent.lines[index].selectedQuantity=this.$.quantity.getValue();enyo.forEach(this.newAttribute.promotions,function(p){if(!OB.UTIL.isNullOrUndefined(p)){p.amt=OB.DEC.mul(p.amt,(me.$.quantity.getValue()/initialQty));p.actualAmt=OB.DEC.mul(p.actualAmt,(me.$.quantity.getValue()/initialQty));}});}else{inEvent.lines.splice(index,1);}}},components:[{kind:'OB.UI.CheckboxButtonReturn',name:'checkboxButtonReturn'},{name:'product',classes:'span4',style:'line-height: 40px; font-size: 17px; width: 180px;'},{name:'totalQuantity',classes:'span2',style:'line-height: 40px; font-size: 17px; width: 85px;'},{name:'remainingQuantity',classes:'span2',style:'line-height: 40px; font-size: 17px; width:85px;'},{name:'fullyReturned',classes:'btn-returned span2',showing:false},{name:'qtyminus',kind:'OB.UI.SmallButton',style:'width: 40px',classes:'btnlink-gray btnlink-cashup-edit span1',content:'-',ontap:'subUnit'},{kind:'enyo.Input',type:'text',classes:'input span1',style:'margin-right: 2px; text-align: center; width: 50px;',name:'quantity',isFirstFocus:true,selectOnFocus:true,autoKeyModifier:'num-lock',onchange:'validate'},{name:'qtyplus',kind:'OB.UI.SmallButton',style:'width: 40px',classes:'btnlink-gray btnlink-cashup-edit span1',content:'+',ontap:'addUnit'},{name:'price',classes:'span2',style:'line-height: 40px; font-size: 17px; width: 100px;'},{style:'clear: both;'}],addUnit:function(inSender,inEvent){var units=parseInt(this.$.quantity.getValue(),10);if(!isNaN(units)&&units<this.$.quantity.getAttribute('max')){this.$.quantity.setValue(units+1);this.validate();}},subUnit:function(inSender,inEvent){var units=parseInt(this.$.quantity.getValue(),10);if(!isNaN(units)&&units>this.$.quantity.getAttribute('min')){this.$.quantity.setValue(units-1);this.validate();}},validate:function(){var value,maxValue;value=this.$.quantity.getValue();try{value=parseFloat(this.$.quantity.getValue());}catch(e){this.addStyles('background-color: red');this.doCorrectQty({correctQty:false});return true;}
maxValue=OB.DEC.toNumber(OB.DEC.toBigDecimal(this.$.quantity.getAttribute('max')));if(!_.isNumber(value)||_.isNaN(value)){this.addStyles('background-color: red');this.doCorrectQty({correctQty:false});return true;}
value=OB.DEC.toNumber(OB.DEC.toBigDecimal(value));this.$.quantity.setValue(value);if(value>maxValue||value<=0){this.addStyles('background-color: red');this.doCorrectQty({correctQty:false});}else{this.addStyles('background-color: white');this.doCorrectQty({correctQty:true});return true;}},markAsGiftCard:function(){this.isGiftCard=true;this.$.checkboxButtonReturn.isGiftCard=this.isGiftCard;},tap:function(){if(this.isGiftCard===true){OB.UTIL.showWarning(OB.I18N.getLabel('OBMOBC_LineCanNotBeSelected'));}},initComponents:function(){this.inherited(arguments);if(!this.newAttribute.returnable&&this.newAttribute.productType==='S'){this.$.checkboxButtonReturn.setDisabled(true);this.$.checkboxButtonReturn.removeClass('btn-icon-check');this.$.checkboxButtonReturn.addClass('btn-icon-notreturnable');this.$.quantity.hide();this.$.qtyplus.hide();this.$.qtyminus.hide();this.$.fullyReturned.setContent(OB.I18N.getLabel('OBRETUR_notreturnable'));this.$.fullyReturned.addStyles('color: #C80000');this.$.fullyReturned.show();}else if(this.newAttribute.remainingQuantity<=0){this.$.checkboxButtonReturn.setDisabled(true);this.$.checkboxButtonReturn.removeClass('btn-icon-check');this.$.checkboxButtonReturn.addClass('btn-icon-returned');this.$.quantity.hide();this.$.qtyplus.hide();this.$.qtyminus.hide();this.$.fullyReturned.setContent(OB.I18N.getLabel('OBRETUR_FullyReturned'));this.$.fullyReturned.show();}
this.$.product.setContent(this.newAttribute.name);this.$.remainingQuantity.setContent(this.newAttribute.remainingQuantity);this.$.totalQuantity.setContent(this.newAttribute.quantity);this.$.quantity.setDisabled(true);this.$.qtyplus.setDisabled(true);this.$.qtyminus.setDisabled(true);this.$.quantity.setValue(this.newAttribute.remainingQuantity);this.$.quantity.setAttribute('max',this.newAttribute.remainingQuantity);this.$.quantity.setAttribute('min',OB.DEC.One);this.$.price.setContent(this.newAttribute.priceIncludesTax?this.newAttribute.unitPrice:this.newAttribute.baseNetUnitPrice);if(this.newAttribute.promotions.length>0){this.$.quantity.addStyles('margin-bottom:0px');enyo.forEach(this.newAttribute.promotions,function(d){if(d.hidden){return;}
this.createComponent({style:'display: block; color:gray; font-size:13px; line-height: 20px;  width: 150px;',components:[{content:'-- '+d.name,attributes:{style:'float: left; width: 60%;'}},{content:OB.I18N.formatCurrency(-d.amt),attributes:{style:'float: left; width: 31%; text-align: right;'}},{style:'clear: both;'}]});},this);}
if(!OB.UTIL.isNullOrUndefined(this.newAttribute.shiplineNo)){this.createComponent({style:'display: block; color:gray; font-size:13px; line-height: 20px;',components:[{content:this.newAttribute.shipment+' - '+this.newAttribute.shiplineNo,attributes:{style:'float: left; width: 60%;'}},{style:'clear: both;'}]});}}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ReturnReceiptDialogApply',events:{onApplyChanges:'',onCallbackExecutor:'',onCheckQty:''},tap:function(){if(this.doCheckQty()){return true;}
if(this.doApplyChanges()){OB.UTIL.showLoading(true);this.doCallbackExecutor();this.doHideThisPopup();}},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblApply'));}});enyo.kind({kind:'OB.UI.ModalDialogButton',name:'OB.UI.ReturnReceiptDialogCancel',tap:function(){this.doHideThisPopup();},initComponents:function(){this.inherited(arguments);this.setContent(OB.I18N.getLabel('OBMOBC_LblCancel'));}});enyo.kind({name:'OB.UI.ModalReturnReceipt',kind:'OB.UI.ModalAction',classes:'modal-dialog',style:'width: 700px;',correctQty:true,handlers:{onApplyChanges:'applyChanges',onCallbackExecutor:'callbackExecutor',onCheckedAll:'checkedAll',onCheckQty:'checkQty',onCorrectQty:'changeCorrectQty',onLineSelected:'lineSelected'},lineShouldBeIncludedFunctions:[],bodyContent:{kind:'Scroller',maxHeight:'225px',style:'background-color: #ffffff;',thumb:true,horizontal:'hidden',components:[{name:'attributes'}]},bodyButtons:{components:[{kind:'OB.UI.ReturnReceiptDialogApply'},{kind:'OB.UI.ReturnReceiptDialogCancel'}]},applyChanges:function(inSender,inEvent){this.waterfall('onApplyChange',{lines:this.args.args.order.receiptLines,model:this.args.args.context.model});return true;},callbackExecutor:function(inSender,inEvent){var me=this,i;var nameLocation="";var oldbp=me.args.args.context.model.get('order').get('bp');var bpLoc=me.args.args.order.bpLocId;var noFoundProduct=true,NoFoundCustomer=true,isLoadedPartiallyFromBackend=false;var findBusinessPartner=function(bp){if(OB.MobileApp.model.hasPermission('OBPOS_remote.discount.bp',true)){var oldbpfilter={columns:['businessPartner'],operator:'equals',value:oldbp.id};var oldRemoteCriteria=[oldbpfilter];var criteria={};criteria.remoteFilters=oldRemoteCriteria;OB.Dal.find(OB.Model.DiscountFilterBusinessPartner,criteria,function(discountsBP){_.each(discountsBP.models,function(dsc){OB.Dal.removeTemporally(dsc,function(){},function(){OB.error(arguments);},true);});},function(){OB.error(arguments);});var bpFilter={columns:['businessPartner'],operator:'equals',value:OB.MobileApp.model.get('businessPartner').id};var remoteCriteria=[bpFilter];var criteriaFilter={};criteriaFilter.remoteFilters=remoteCriteria;OB.Dal.find(OB.Model.DiscountFilterBusinessPartner,criteriaFilter,function(discountsBP){_.each(discountsBP.models,function(dsc){OB.Dal.saveTemporally(dsc,function(){},function(){OB.error(arguments);},true);});},function(){OB.error(arguments);});}
var locationForBpartner=function(bpLoc){var finishOrderCreation=function(){me.args.args.context.model.get('order').calculateReceipt(function(){me.args.args.context.model.get('order').save(function(){me.args.args.context.model.get('orderList').saveCurrent();OB.UTIL.showLoading(false);});});},finishOrder=_.after(me.args.args.order.receiptLines.length,finishOrderCreation),createOrderLines=function(){_.each(me.args.args.order.receiptLines,function(line){if(!line.exceedsQuantity){var createLineFunction=function(prod){var order=me.args.args.context.model.get('order');var qty=line.selectedQuantity;if(order.get('orderType')!==1){qty=qty?-qty:-1;}
prod.set('ignorePromotions',true);prod.set('standardPrice',line.priceIncludesTax?line.unitPrice:line.baseNetUnitPrice);order.addProductToOrder(prod,qty,null,{'originalOrderLineId':line.lineId,'originalDocumentNo':me.args.args.order.documentNo,'skipApplyPromotions':true,'promotions':line.promotions,'shipmentlineId':line.shipmentlineId,'relatedLines':line.relatedLines});me.args.args.cancelOperation=true;OB.UTIL.HookManager.callbackExecutor(me.args.args,me.args.callbacks);finishOrder();};_.each(line.promotions,function(promotion){promotion.amt=-promotion.amt;promotion.actualAmt=-promotion.actualAmt;});OB.Dal.get(OB.Model.Product,line.id,function(product){createLineFunction(product);},null,function(){new OB.DS.Request('org.openbravo.retail.posterminal.master.LoadedProduct').exec({productId:line.id},function(data){createLineFunction(OB.Dal.transform(OB.Model.Product,data[0]));},function(){if(noFoundProduct){noFoundProduct=false;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBRETUR_InformationTitle'),OB.I18N.getLabel('OBRETUR_NoReturnLoadedText'),[{label:OB.I18N.getLabel('OBPOS_LblOk'),isConfirmButton:true}]);}});});}else{me.args.args.cancelOperation=true;OB.UTIL.HookManager.callbackExecutor(me.args.args,me.args.callbacks);finishOrder();}});},approvalNeeded=false,currentDate=new Date(),servicesToApprove='',servicesToApproveArr=[];me.nameLocation=bpLoc.get('name');bp.set('locationModel',bpLoc);bp.set('locId',me.args.args.order.bpLocId);bp.set('locName',me.nameLocation);me.args.args.context.model.get('order').setBPandBPLoc(bp,false,true);if(!OB.MobileApp.model.hasPermission("OBPOS_SplitLinesInShipments",true)){me.args.args.order.receiptLines=me.autoSplitShipmentLines(me.args.args.order.receiptLines);}
currentDate.setHours(0);currentDate.setMinutes(0);currentDate.setSeconds(0);currentDate.setMilliseconds(0);for(i=0;i<me.args.args.order.receiptLines.length;i++){var line=me.args.args.order.receiptLines[i];if(!line.notReturnable){if(line.productType==='S'&&(line.overdueReturnDays<0||((currentDate.getTime()-line.overdueReturnDays*86400000)>(new Date(me.args.args.order.orderDate)).getTime()))){servicesToApprove+='<br>· '+line.name;servicesToApproveArr.push(' * '+line.name);if(!approvalNeeded){approvalNeeded=true;}}}else{OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_UnreturnableProduct'),OB.I18N.getLabel('OBPOS_UnreturnableProductMessage',[line.name]));return;}}
if(approvalNeeded){OB.UTIL.showLoading(false);OB.UTIL.Approval.requestApproval(OB.MobileApp.view.$.containerWindow.getRoot().model,[{approval:'OBPOS_approval.returnService',message:'OBRETUR_approval.returnService_OutOfDate',params:[servicesToApprove]}],function(approved,supervisor,approvalType){if(approved){if(supervisor.id===OB.POS.terminal.terminal.usermodel.id){OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBMOBC_LblWarning'),OB.I18N.getLabel('OBRETUR_returnService_OutOfDate_warning',[servicesToApproveArr]));}
OB.UTIL.showLoading(true);createOrderLines();}});}else{createOrderLines();}};if(isLoadedPartiallyFromBackend){locationForBpartner(bpLoc);}else{OB.Dal.get(OB.Model.BPLocation,me.args.args.order.bpLocId,function(bpLoc){locationForBpartner(bpLoc);},function(){});}};OB.Dal.get(OB.Model.BusinessPartner,this.args.args.order.bp,function(bp){findBusinessPartner(bp);},null,function(){new OB.DS.Request('org.openbravo.retail.posterminal.master.LoadedCustomer').exec({bpartnerId:me.args.args.order.bp,bpLocationId:me.args.args.order.bpLocId},function(data){isLoadedPartiallyFromBackend=true;bpLoc=OB.Dal.transform(OB.Model.BPLocation,data[1]);findBusinessPartner(OB.Dal.transform(OB.Model.BusinessPartner,data[0]));},function(){if(NoFoundCustomer){NoFoundCustomer=false;OB.UTIL.showConfirmation.display(OB.I18N.getLabel('OBPOS_InformationTitle'),OB.I18N.getLabel('OBPOS_NoReceiptLoadedText'),[{label:OB.I18N.getLabel('OBPOS_LblOk'),isConfirmButton:true}]);}});});},checkedAll:function(inSender,inEvent){if(inEvent.checked){this.selectedLines=this.numberOfLines;this.allSelected=true;}else{this.selectedLines=0;this.allSelected=false;}
this.waterfall('onCheckAll',{checked:inEvent.checked});return true;},checkQty:function(inSender,inEvent){if(!this.correctQty){return true;}},changeCorrectQty:function(inSender,inEvent){this.correctQty=inEvent.correctQty;},lineSelected:function(inSender,inEvent){if(inEvent.selected){this.selectedLines+=1;}else{this.selectedLines-=1;}
if(this.selectedLines===this.numberOfLines){this.allSelected=true;this.waterfall('onAllSelected',{allSelected:this.allSelected});return true;}else{if(this.allSelected){this.allSelected=false;this.waterfall('onAllSelected',{allSelected:this.allSelected});}}},splitShipmentLines:function(lines){var newlines=[];enyo.forEach(lines,function(line){if(line.shipmentlines&&line.shipmentlines.length>1){enyo.forEach(line.shipmentlines,function(sline){var attr,splitline={};for(attr in line){if(line.hasOwnProperty(attr)&&!OB.UTIL.isNullOrUndefined(line[attr])&&typeof line[attr]!=='object'){splitline[attr]=line[attr];}}
splitline.compname=line.lineId+sline.shipLineId;splitline.quantity=sline.qty;splitline.shiplineNo=sline.shipmentlineNo;splitline.shipment=sline.shipment;splitline.shipmentlineId=sline.shipLineId;splitline.remainingQuantity=sline.remainingQty;delete splitline.linegrossamount;delete splitline.warehouse;delete splitline.warehousename;splitline.promotions=[];if(line.promotions.length>0){enyo.forEach(line.promotions,function(p){if(!OB.UTIL.isNullOrUndefined(p)){var attr,splitpromo={};for(attr in p){if(p.hasOwnProperty(attr)&&!OB.UTIL.isNullOrUndefined(p[attr])&&typeof p[attr]!=='object'){splitpromo[attr]=p[attr];}}
splitpromo.amt=OB.DEC.mul(p.amt,(splitline.remainingQuantity/line.quantity));splitpromo.actualAmt=OB.DEC.mul(p.actualAmt,(splitline.remainingQuantity/line.quantity));splitline.promotions.push(splitpromo);}});}
newlines.push(splitline);},this);}else{line.compname=line.lineId;if(line.shipmentlines&&line.shipmentlines.length===1){line.shipmentlineId=line.shipmentlines[0].shipLineId;}
delete line.linegrossamount;delete line.warehouse;delete line.warehousename;newlines.push(line);}},this);return newlines;},autoSplitShipmentLines:function(lines){var newlines=[];enyo.forEach(lines,function(line){if(line.shipmentlines&&line.shipmentlines.length>1){enyo.forEach(line.shipmentlines,function(sline){var attr,splitline={};if(line.selectedQuantity>0&&sline.remainingQty>0){for(attr in line){if(line.hasOwnProperty(attr)&&!OB.UTIL.isNullOrUndefined(line[attr])&&typeof line[attr]!=='object'){splitline[attr]=line[attr];}}
splitline.compname=line.lineId+sline.shipLineId;splitline.quantity=sline.qty;splitline.shiplineNo=sline.shipmentlineNo;splitline.shipment=sline.shipment;splitline.shipmentlineId=sline.shipLineId;splitline.selectedQuantity=parseInt(splitline.selectedQuantity,10);if(sline.remainingQty<splitline.selectedQuantity){splitline.selectedQuantity=sline.remainingQty;}
line.selectedQuantity=OB.DEC.sub(line.selectedQuantity,splitline.selectedQuantity);delete splitline.linegrossamount;delete splitline.warehouse;delete splitline.warehousename;splitline.promotions=[];if(line.promotions.length>0){enyo.forEach(line.promotions,function(p){if(!OB.UTIL.isNullOrUndefined(p)){var attr,splitpromo={};for(attr in p){if(p.hasOwnProperty(attr)&&!OB.UTIL.isNullOrUndefined(p[attr])&&typeof p[attr]!=='object'){splitpromo[attr]=p[attr];}}
splitpromo.amt=OB.DEC.mul(p.amt,(splitline.selectedQuantity/line.quantity));splitpromo.actualAmt=OB.DEC.mul(p.actualAmt,(splitline.selectedQuantity/line.quantity));splitline.promotions.push(splitpromo);}});}
newlines.push(splitline);}},this);}else{line.compname=line.lineId;if(line.shipmentlines&&line.shipmentlines.length===1){line.shipmentlineId=line.shipmentlines[0].shipLineId;}
delete line.linegrossamount;delete line.warehouse;delete line.warehousename;newlines.push(line);}},this);return newlines;},executeOnShow:function(){var me=this,lineNum=0;OB.UTIL.showLoading(false);this.$.bodyContent.$.attributes.destroyComponents();this.$.header.destroyComponents();this.$.header.createComponent({name:'CheckAllHeaderDocNum',style:'text-align: center; color: white;',components:[{content:me.args.args.order.documentNo,name:'documentNo',classes:'span12',style:'line-height: 40px; font-size: 24px;'},{style:'clear: both;'}]});if(!this.$.header.$.checkboxButtonAll){this.$.header.addStyles('padding-bottom: 0px; margin: 0px; height: 103px;');this.$.header.createComponent({name:'CheckAllHeader',style:'padding-top: 5px; border-bottom: 3px solid #cccccc; text-align: center; color: black; margin-top: 10px; padding-bottom: 8px;  font-weight: bold; background-color: white',components:[{kind:'OB.UI.CheckboxButtonAll',name:'checkboxButtonAll'},{content:OB.I18N.getLabel('OBRETUR_LblProductName'),name:'productNameLbl',classes:'span4',style:'line-height: 40px; font-size: 17px;  width: 180px;'},{name:'totalQtyLbl',content:OB.I18N.getLabel('OBRETUR_LblTotalQty'),classes:'span2',style:'line-height: 40px; font-size: 17px; width: 85px;'},{name:'remainingQtyLbl',content:OB.I18N.getLabel('OBRETUR_LblRemainingQty'),classes:'span2',style:'line-height: 40px; font-size: 17px; width: 85px;'},{content:OB.I18N.getLabel('OBRETUR_LblQty'),name:'qtyLbl',classes:'span3',style:'line-height: 40px; font-size: 17px; width: 155px;'},{content:OB.I18N.getLabel('OBRETUR_LblPrice'),name:'priceLbl',classes:'span2',style:'line-height: 40px; font-size: 17px; width: 110px;'},{style:'clear: both;'}]});}else{this.$.header.$.checkboxButtonAll.unCheck();}
if(OB.MobileApp.model.hasPermission("OBPOS_SplitLinesInShipments",true)){this.args.args.order.receiptLines=this.splitShipmentLines(this.args.args.order.receiptLines);}
this.numberOfLines=0;this.selectedLines=0;this.allSelected=false;enyo.forEach(this.args.args.order.receiptLines,function(line){lineNum++;var isSelectableLine=true;_.each(this.lineShouldBeIncludedFunctions,function(f){isSelectableLine=isSelectableLine&&f.isSelectableLine(line);});var lineEnyoObject=this.$.bodyContent.$.attributes.createComponent({kind:'OB.UI.EditOrderLine',name:'line'+lineNum,newAttribute:line});if(!isSelectableLine){lineEnyoObject.markAsGiftCard();}
this.numberOfLines+=1;if(line.productType==='S'&&!line.returnable){line.notReturnable=true;}},this);this.$.bodyContent.$.attributes.render();this.$.header.render();this.waterfall('onCorrectQty',{correctQty:true});},initComponents:function(){this.inherited(arguments);this.attributeContainer=this.$.bodyContent.$.attributes;}});OB.UI.WindowView.registerPopup('OB.OBPOSPointOfSale.UI.PointOfSale',{kind:'OB.UI.ModalReturnReceipt',name:'modalReturnReceipt'});}());(function(){OB.UTIL.HookManager.registerHook('OBRETUR_ReturnFromOrig',function(args,callbacks){var order=args.order,params=args.params,context=args.context;if(params.isReturn){if(context.model&&context.model.get('order')&&context.model.get('order').get('isEditable')===false){context.doShowPopup({popup:'modalNotEditableOrder'});return;}
context.doShowPopup({popup:'modalReturnReceipt',args:{args:args,callbacks:callbacks}});}else{OB.UTIL.HookManager.callbackExecutor(args,callbacks);}
return;});}());(function(){OB.UTIL.HookManager.registerHook('OBPOS_PreAddProductToOrder',function(args,callbacks){var affectedLine=_.filter(args.receipt.get('lines').models,function(line){return line.get('product')===args.productToAdd;});if(affectedLine.length>0&&!_.isUndefined(affectedLine[0].get('originalOrderLineId'))){args.cancelOperation=true;OB.UTIL.showError(OB.I18N.getLabel('OBRETUR_CannotChangeQty'));}
OB.UTIL.HookManager.callbackExecutor(args,callbacks);return;});}());(function(){OB.UTIL.HookManager.registerHook('OBPOS_RenderOrderLine',function(args,callbacks){var orderline=args.orderline;if(orderline.model.get('originalDocumentNo')){orderline.createComponent({style:'display: block;',components:[{content:'** '+OB.I18N.getLabel('OBRETUR_LblLineFromOriginal')+orderline.model.get('originalDocumentNo')+' **',attributes:{style:'float: left; width: 80%;'}},{content:'',attributes:{style:'float: right; width: 20%; text-align: right;'}},{style:'clear: both;'}]});}
OB.UTIL.HookManager.callbackExecutor(args,callbacks);return;});}());(function(){OB.UTIL.HookManager.registerHook('OBPOS_GroupedProductPreCreateLine',function(args,callbacks){if(!OB.UTIL.isNullOrUndefined(args.line)&&!OB.UTIL.isNullOrUndefined(args.line.get('originalOrderLineId'))){args.cancelOperation=true;args.receipt.createLine(args.p,args.qty,args.options,args.attrs);args.receipt.save();}
OB.UTIL.HookManager.callbackExecutor(args,callbacks);return;});}());if(window.onerror&&window.onerror.name==='indexErrorHandler'){window.onerror=null;}if(typeof OBStartApplication!=='undefined'&&Object.prototype.toString.call(OBStartApplication)==='[object Function]'){OBStartApplication();}